# 🔧 双环境开发支持系统

## 📋 概述

本项目实现了完整的双环境开发支持系统，允许开发者在不同的开发模式之间灵活切换，提供最佳的开发体验。

## 🎯 核心功能

### 1. 双环境支持

#### 🏗️ 构建产物模式 (Built Mode)

- **端口**: 3001
- **用途**: 使用已构建的 `@ldesign/*` 包
- **适用场景**:
  - 生产环境开发
  - 性能测试
  - 最终用户体验验证
- **特点**: 更接近生产环境，启动速度快

#### 🔧 源码模式 (Source Mode)

- **端口**: 3002
- **用途**: 直接引用 `@ldesign/*` 包的源码目录
- **适用场景**:
  - 开发调试
  - 源码修改实时预览
  - 包开发和测试
- **特点**: 支持热更新，便于调试

#### 🔄 对比模式 (Compare Mode)

- **端口**: 3001 + 3002
- **用途**: 同时启动两种模式进行对比测试
- **适用场景**: 功能验证、性能对比

### 2. 智能构建系统

#### 🧠 智能并行构建

- 自动分析包之间的依赖关系
- 按依赖层级分组，同层级内并行构建
- 确保依赖包先于被依赖包构建
- 兼顾构建速度和依赖安全性

#### 🚀 多种构建模式

- **智能模式** (默认): 按依赖层级智能并行
- **并行模式**: 完全并行构建（最快）
- **串行模式**: 逐个构建（最安全）

### 3. 交互式环境切换

#### 🎮 用户友好界面

- 交互式选择界面
- 清晰的环境状态显示
- 详细的使用提示

## 🚀 使用指南

### 基础开发命令

```bash
# 默认开发模式（构建产物模式）
pnpm run dev

# 构建产物模式 - 端口 3001
pnpm run dev:built

# 源码模式 - 端口 3002
pnpm run dev:source

# 同时启动两种模式进行对比
pnpm run dev:compare
```

### 环境切换工具

```bash
# 交互式选择环境
pnpm run env

# 显示所有可用环境
pnpm run env:list

# 启动构建模式
pnpm run env:built

# 启动源码模式
pnpm run env:source

# 启动对比模式
pnpm run env:compare
```

### 批量构建命令

```bash
# 智能并行构建（推荐）
pnpm run build:all

# 智能并行构建
pnpm run build:all:smart

# 完全并行构建
pnpm run build:all:parallel

# 串行构建
pnpm run build:all:serial

# 显示帮助
pnpm run build:all --help
```

## 🔧 技术实现

### 1. 路径解析修复

修复了所有包中的内部导入路径问题：

- 将 `@/` 路径别名改为相对路径导入
- 确保源码模式下路径解析正确
- 支持热更新和实时调试

### 2. Vite 配置优化

#### 动态配置系统

- 根据环境变量自动切换配置
- 支持不同的端口和别名设置
- 优化的 CSS 预处理器配置

#### 多配置文件支持

- `vite.config.ts`: 默认配置（动态切换）
- `vite.config.built.ts`: 构建模式专用配置
- `vite.config.source.ts`: 源码模式专用配置

### 3. 依赖层级分析

#### 智能依赖检测

- 自动扫描 workspace 依赖关系
- 计算包的构建层级
- 检测并警告循环依赖

#### 拓扑排序构建

- 确保依赖包优先构建
- 同层级包并行构建
- 失败时停止后续构建

## 📊 性能优化

### 构建性能提升

- **智能并行**: 比串行构建快 60-80%
- **依赖安全**: 避免依赖问题导致的构建失败
- **错误容错**: 单个包失败不影响其他包

### 开发体验优化

- **快速切换**: 一键切换开发环境
- **实时反馈**: 清晰的状态显示和进度提示
- **智能提示**: 详细的使用说明和错误提示

## 🛠️ 故障排除

### 常见问题

#### 1. 源码模式启动失败

**原因**: 包内部使用了 `@/` 路径别名 **解决**: 已修复所有包的路径问题，使用相对路径导入

#### 2. 构建失败

**原因**: 依赖关系问题或包配置错误 **解决**: 使用智能构建模式，自动处理依赖关系

#### 3. 端口冲突

**原因**: 端口被其他服务占用 **解决**: 修改配置文件中的端口设置

### 调试技巧

```bash
# 查看详细的构建日志
pnpm run build:all --serial

# 检查环境配置
pnpm run env:list

# 清理缓存重新构建
pnpm run clean && pnpm run build:all
```

## 🔮 未来规划

### 短期目标

- [ ] 添加构建缓存机制
- [ ] 支持增量构建
- [ ] 优化错误提示信息

### 长期目标

- [ ] 支持更多开发环境
- [ ] 集成 Docker 开发环境
- [ ] 添加性能监控面板

## 📝 更新日志

### v1.0.0 (2024-12-14)

- ✅ 实现双环境开发支持
- ✅ 添加智能并行构建系统
- ✅ 创建交互式环境切换工具
- ✅ 修复所有路径解析问题
- ✅ 优化开发体验和性能

---

**开发团队**: LDesign Team  
**最后更新**: 2024-12-14

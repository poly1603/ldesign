# 包构建产物问题总结

## 问题描述

24个packages中有4个包缺少dist目录(UMD格式产物):
- `animation`: 有es/lib，缺dist
- `shared`: 有es/lib，缺dist  
- `notification`: 完全未构建
- `websocket`: 完全未构建

## 根本原因

通过深入分析builder源码和构建日志,发现根本原因:

### 1. 自动检测覆盖用户配置

Builder的LibraryDetector会自动检测项目类型:
- `animation`包: 包含4个Vue文件 → 被检测为Vue3项目(而非配置的typescript)
- `shared`包: 包含样式文件 → 被检测为STYLE项目
- 虽然配置文件明确指定了`libraryType: 'typescript'`,但自动检测的优先级更高

### 2. Vue3Strategy/StyleStrategy的多入口问题

当被识别为Vue3或STYLE项目时:
- Vue3Strategy会扫描所有src文件作为入口(包括Vue组件)
- RollupAdapter的`isMultiEntryBuild()`检测到多入口
- 在第540-550行,多入口项目的UMD格式被过滤掉

```typescript
// RollupAdapter.ts line 540
if (hasUMD) {
  formats = formats.filter((format: any) => format !== 'umd' && format !== 'iife')
  // UMD被过滤!
}
```

### 3. 配置无法生效

尝试的解决方案都无效:
- ✗ 创建`src/index-lib.ts` - 文件被检测到但UMD仍被跳过
- ✗ 添加顶层`umd: { enabled: true }` - 配置被忽略
- ✗ CLI参数`--format esm,cjs,umd` - 日志显示但仍不生成
- ✗ 在配置中明确`libraryType: 'typescript'` - 被自动检测覆盖

## 解决方案

由于builder的架构问题,需要采用以下方案之一:

### 方案A: 修改Builder源码(推荐,但需要较大改动)

修改`tools/builder/src/core/LibraryBuilder.ts`:

```typescript
// Line 156: 尊重用户配置的libraryType
let libraryType = mergedConfig.libraryType 
if (!libraryType) {
  libraryType = await this.detectLibraryType(projectRoot)
}
```

### 方案B: 拆分包结构(工作量大)

将Vue/React集成拆分到单独的子包:
- `@ldesign/animation` (核心,纯TS)
- `@ldesign/animation-vue` (Vue集成)
- `@ldesign/animation-react` (React集成)

### 方案C: 临时构建脚本(快速但不优雅)

为这4个包创建单独的rollup配置直接生成UMD。

### 方案D: 使用不同的构建工具

对这4个包使用vite/rollup直接构建,不经过@ldesign/builder。

## 建议

**短期方案**: 采用方案C,为这4个包创建临时构建脚本生成UMD产物  
**长期方案**: 采用方案A,修复builder让用户配置优先于自动检测

## 受影响的包详情

| 包名 | 问题 | 原因 | es/ | lib/ | dist/ |
|------|------|------|-----|------|-------|
| animation | 缺UMD | 4个Vue文件→Vue3检测 | ✓ | ✓ | ✗ |
| shared | 缺UMD | 样式文件→STYLE检测 | ✓ | ✓ | ✗ |
| notification | 全缺 | 未构建过 | ✗ | ✗ | ✗ |
| websocket | 全缺 | 未构建过 | ✗ | ✗ | ✗ |

其他20个包都正常,因为它们没有会导致错误检测的特征文件。


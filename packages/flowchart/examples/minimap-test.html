<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小地图功能测试</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      padding: 20px;
      background: linear-gradient(135deg, #722ed1, #9254de);
      color: white;
    }
    
    .header h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
    }
    
    .header p {
      margin: 0;
      opacity: 0.9;
    }
    
    .controls {
      padding: 20px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 8px 16px;
      border: 1px solid #d9d9d9;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn:hover {
      border-color: #722ed1;
      color: #722ed1;
    }
    
    .btn.primary {
      background: #722ed1;
      border-color: #722ed1;
      color: white;
    }
    
    .btn.primary:hover {
      background: #9254de;
      border-color: #9254de;
    }
    
    .editor-container {
      height: 600px;
      position: relative;
      border: 1px solid #e5e5e5;
    }
    
    .status {
      padding: 15px 20px;
      background: #f8f9fa;
      border-top: 1px solid #e5e5e5;
      font-size: 14px;
      color: #666;
    }
    
    .test-info {
      padding: 20px;
      background: #f0f7ff;
      border-left: 4px solid #1890ff;
      margin: 20px;
    }
    
    .test-info h3 {
      margin: 0 0 10px 0;
      color: #1890ff;
    }
    
    .test-info ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .test-info li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🗺️ 小地图功能测试</h1>
      <p>测试小地图的实时同步、导航功能和视口显示</p>
    </div>
    
    <div class="test-info">
      <h3>🎯 测试功能清单</h3>
      <ul>
        <li><strong>实时内容同步</strong>：添加/删除节点时，小地图立即更新</li>
        <li><strong>视口窗口显示</strong>：紫色边框准确显示当前可视区域</li>
        <li><strong>点击导航</strong>：点击小地图任意位置，主画布跳转到对应区域</li>
        <li><strong>拖拽导航</strong>：拖拽视口窗口，主画布平滑跟随</li>
        <li><strong>缩放同步</strong>：主画布缩放时，视口窗口大小同步调整</li>
        <li><strong>节点类型区分</strong>：不同类型节点显示不同颜色和形状</li>
      </ul>
    </div>
    
    <div class="controls">
      <button class="btn primary" onclick="addSampleNodes()">➕ 添加示例节点</button>
      <button class="btn" onclick="addRandomNode()">🎲 添加随机节点</button>
      <button class="btn" onclick="connectNodes()">🔗 连接节点</button>
      <button class="btn" onclick="testNavigation()">🧭 测试导航</button>
      <button class="btn" onclick="testZoom()">🔍 测试缩放</button>
      <button class="btn" onclick="clearCanvas()">🧹 清空画布</button>
      <button class="btn" onclick="toggleMiniMap()">👁️ 切换小地图</button>
    </div>
    
    <div class="editor-container" id="editor-container">
      <!-- 流程图编辑器将在这里初始化 -->
    </div>
    
    <div class="status" id="status">
      准备就绪 - 等待初始化编辑器
    </div>
  </div>

  <script type="module">
    import { FlowchartEditor } from '../src/index.js'
    
    let editor = null
    let nodeCounter = 0
    
    // 初始化编辑器
    async function initEditor() {
      try {
        updateStatus('正在初始化编辑器...')
        
        editor = new FlowchartEditor({
          container: '#editor-container',
          width: 1200,
          height: 600,
          // 启用小地图
          miniMap: {
            enabled: true,
            width: 200,
            height: 150,
            position: 'bottom-right',
            showZoomControls: true,
            showViewport: true,
            backgroundColor: '#fafafa',
            borderColor: '#d9d9d9',
            viewportColor: '#722ed1'
          },
          // 启用网格
          grid: {
            size: 20,
            visible: true,
            type: 'dot'
          },
          // 工具栏配置
          toolbar: {
            visible: true,
            tools: ['select', 'zoom-fit', 'undo', 'redo', 'delete', 'clear']
          }
        })
        
        // 监听事件
        editor.on('node:add', (data) => {
          updateStatus(`节点已添加: ${data.node.type} (${data.node.id})`)
        })
        
        editor.on('node:delete', (data) => {
          updateStatus(`节点已删除: ${data.node.type} (${data.node.id})`)
        })
        
        editor.on('edge:add', (data) => {
          updateStatus(`连线已添加: ${data.edge.id}`)
        })
        
        updateStatus('编辑器初始化完成 - 可以开始测试小地图功能')
        
      } catch (error) {
        console.error('初始化失败:', error)
        updateStatus(`初始化失败: ${error.message}`)
      }
    }
    
    // 更新状态
    function updateStatus(message) {
      document.getElementById('status').textContent = `${new Date().toLocaleTimeString()} - ${message}`
    }
    
    // 添加示例节点
    window.addSampleNodes = function() {
      if (!editor) return
      
      const nodes = [
        { type: 'start', x: 200, y: 150, text: '开始' },
        { type: 'approval', x: 400, y: 150, text: '审批节点' },
        { type: 'condition', x: 600, y: 150, text: '条件判断' },
        { type: 'process', x: 800, y: 100, text: '处理任务' },
        { type: 'end', x: 1000, y: 150, text: '结束' }
      ]
      
      nodes.forEach(node => {
        editor.addNode(node)
      })
      
      updateStatus(`已添加 ${nodes.length} 个示例节点`)
    }
    
    // 添加随机节点
    window.addRandomNode = function() {
      if (!editor) return
      
      const types = ['start', 'approval', 'condition', 'process', 'end', 'user-task', 'service-task']
      const type = types[Math.floor(Math.random() * types.length)]
      const x = 200 + Math.random() * 800
      const y = 100 + Math.random() * 400
      
      nodeCounter++
      const node = {
        type,
        x,
        y,
        text: `${type}-${nodeCounter}`
      }
      
      editor.addNode(node)
      updateStatus(`已添加随机节点: ${type} at (${Math.round(x)}, ${Math.round(y)})`)
    }
    
    // 连接节点
    window.connectNodes = function() {
      if (!editor) return
      
      const data = editor.getData()
      const nodes = data.nodes
      
      if (nodes.length < 2) {
        updateStatus('需要至少2个节点才能创建连线')
        return
      }
      
      // 连接前两个节点
      const edge = {
        sourceNodeId: nodes[0].id,
        targetNodeId: nodes[1].id,
        type: 'polyline'
      }
      
      editor.addEdge(edge)
      updateStatus(`已连接节点: ${nodes[0].id} -> ${nodes[1].id}`)
    }
    
    // 测试导航
    window.testNavigation = function() {
      if (!editor) return
      
      // 移动到随机位置
      const x = Math.random() * 2000 - 1000
      const y = Math.random() * 1500 - 750
      
      editor.translateCenter(x, y)
      updateStatus(`导航测试: 移动到 (${Math.round(x)}, ${Math.round(y)})`)
    }
    
    // 测试缩放
    window.testZoom = function() {
      if (!editor) return
      
      const scales = [0.5, 0.8, 1.0, 1.5, 2.0]
      const scale = scales[Math.floor(Math.random() * scales.length)]
      
      editor.zoom(scale)
      updateStatus(`缩放测试: 设置缩放为 ${scale * 100}%`)
    }
    
    // 清空画布
    window.clearCanvas = function() {
      if (!editor) return
      
      editor.clear()
      nodeCounter = 0
      updateStatus('画布已清空')
    }
    
    // 切换小地图
    window.toggleMiniMap = function() {
      if (!editor) return
      
      // 这里需要实现切换逻辑
      updateStatus('小地图切换功能待实现')
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initEditor)
  </script>
</body>
</html>

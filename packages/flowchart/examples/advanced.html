<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级功能演示 - LDesign Flowchart Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: #fff;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #722ED1;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .demo-section {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .demo-section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 16px;
            border-bottom: 2px solid #722ED1;
            padding-bottom: 8px;
        }

        .flowchart-container {
            width: 100%;
            height: 400px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: #fafafa;
            position: relative;
        }

        .controls {
            margin-bottom: 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #722ED1;
            background: #fff;
            color: #722ED1;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #722ED1;
            color: #fff;
        }

        .btn.primary {
            background: #722ED1;
            color: #fff;
        }

        .btn.primary:hover {
            background: #5e2aa7;
        }

        .info-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-size: 12px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>LDesign Flowchart Editor - 高级功能演示</h1>
            <p>展示编辑器的高级功能和使用场景</p>
        </div>
    </div>

    <div class="container">
        <div class="demo-grid">
            <!-- 编辑器演示 -->
            <div class="demo-section">
                <h2>完整流程编辑器</h2>
                <div class="controls">
                    <button class="btn primary" onclick="createCompleteFlow()">创建完整流程</button>
                    <button class="btn" onclick="addRandomNode()">随机添加节点</button>
                    <button class="btn" onclick="exportFlow()">导出数据</button>
                    <button class="btn" onclick="clearEditor()">清空</button>
                </div>
                <div class="flowchart-container" id="editor-container">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">
                        点击"创建完整流程"开始
                    </div>
                </div>
                <div class="info-panel">
                    <div>状态: <span id="editor-status" class="status info">未初始化</span></div>
                    <div>节点数: <span id="node-count">0</span> | 连线数: <span id="edge-count">0</span></div>
                </div>
            </div>

            <!-- 查看器演示 -->
            <div class="demo-section">
                <h2>流程执行查看器</h2>
                <div class="controls">
                    <button class="btn primary" onclick="initViewer()">初始化查看器</button>
                    <button class="btn" onclick="simulateExecution()">模拟执行</button>
                    <button class="btn" onclick="resetExecution()">重置状态</button>
                </div>
                <div class="flowchart-container" id="viewer-container">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">
                        点击"初始化查看器"开始
                    </div>
                </div>
                <div class="info-panel">
                    <div>执行状态: <span id="execution-status" class="status info">未开始</span></div>
                    <div>当前节点: <span id="current-node">无</span></div>
                </div>
            </div>

            <!-- 事件演示 -->
            <div class="demo-section full-width">
                <h2>事件系统演示</h2>
                <div class="controls">
                    <button class="btn primary" onclick="initEventDemo()">初始化事件演示</button>
                    <button class="btn" onclick="clearEventLog()">清空日志</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 16px;">
                    <div class="flowchart-container" id="event-container">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">
                            点击"初始化事件演示"开始
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 8px; font-size: 14px;">事件日志</h3>
                        <div id="event-log" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 8px; height: 350px; overflow-y: auto; font-size: 11px; font-family: monospace;">
                            等待事件...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { FlowchartEditor, FlowchartViewer } from '../src/index.ts';

        let editor = null;
        let viewer = null;
        let eventEditor = null;
        let executionStep = 0;

        // 全局函数
        window.createCompleteFlow = function() {
            try {
                const container = document.getElementById('editor-container');
                container.innerHTML = '';
                
                editor = new FlowchartEditor({
                    container: container,
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    background: { color: '#fafafa' },
                    grid: { visible: true, size: 20 }
                });

                // 创建一个完整的审批流程
                const nodes = [
                    { type: 'start', x: 50, y: 100, text: '申请开始' },
                    { type: 'approval', x: 200, y: 100, text: '部门审批' },
                    { type: 'condition', x: 350, y: 100, text: '金额判断' },
                    { type: 'approval', x: 500, y: 50, text: '财务审批' },
                    { type: 'approval', x: 500, y: 150, text: '总经理审批' },
                    { type: 'process', x: 650, y: 100, text: '执行处理' },
                    { type: 'end', x: 800, y: 100, text: '流程结束' }
                ];

                nodes.forEach(node => {
                    editor.addNode(node);
                });

                updateEditorStatus();
                document.getElementById('editor-status').textContent = '已初始化';
                document.getElementById('editor-status').className = 'status success';
            } catch (error) {
                console.error('创建流程失败:', error);
                document.getElementById('editor-status').textContent = '初始化失败';
                document.getElementById('editor-status').className = 'status error';
            }
        };

        window.addRandomNode = function() {
            if (!editor) return;
            
            const types = ['approval', 'condition', 'process'];
            const type = types[Math.floor(Math.random() * types.length)];
            const x = Math.random() * 700 + 50;
            const y = Math.random() * 300 + 50;
            
            editor.addNode({
                type: type,
                x: x,
                y: y,
                text: `随机${type}节点`
            });
            
            updateEditorStatus();
        };

        window.exportFlow = function() {
            if (!editor) return;
            
            const data = editor.getData();
            console.log('导出的流程数据:', data);
            alert(`已导出 ${data.nodes.length} 个节点和 ${data.edges.length} 条连线到控制台`);
        };

        window.clearEditor = function() {
            if (!editor) return;
            
            editor.clearData();
            updateEditorStatus();
        };

        window.initViewer = function() {
            try {
                const container = document.getElementById('viewer-container');
                container.innerHTML = '';
                
                viewer = new FlowchartViewer({
                    container: container,
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    readonly: true
                });

                // 创建示例流程数据
                const sampleData = {
                    nodes: [
                        { id: 'start', type: 'start', x: 50, y: 100, text: '开始' },
                        { id: 'approval1', type: 'approval', x: 200, y: 100, text: '初审' },
                        { id: 'approval2', type: 'approval', x: 350, y: 100, text: '复审' },
                        { id: 'end', type: 'end', x: 500, y: 100, text: '结束' }
                    ],
                    edges: []
                };

                viewer.updateData(sampleData);
                
                document.getElementById('execution-status').textContent = '已初始化';
                document.getElementById('execution-status').className = 'status success';
            } catch (error) {
                console.error('初始化查看器失败:', error);
                document.getElementById('execution-status').textContent = '初始化失败';
                document.getElementById('execution-status').className = 'status error';
            }
        };

        window.simulateExecution = function() {
            if (!viewer) return;
            
            const steps = [
                { current: 'start', completed: [], failed: [] },
                { current: 'approval1', completed: ['start'], failed: [] },
                { current: 'approval2', completed: ['start', 'approval1'], failed: [] },
                { current: 'end', completed: ['start', 'approval1', 'approval2'], failed: [] },
                { current: null, completed: ['start', 'approval1', 'approval2', 'end'], failed: [] }
            ];
            
            if (executionStep < steps.length) {
                const step = steps[executionStep];
                viewer.setExecutionState(step);
                
                document.getElementById('current-node').textContent = step.current || '已完成';
                document.getElementById('execution-status').textContent = step.current ? '执行中' : '已完成';
                document.getElementById('execution-status').className = step.current ? 'status info' : 'status success';
                
                executionStep++;
            }
        };

        window.resetExecution = function() {
            if (!viewer) return;
            
            executionStep = 0;
            viewer.setExecutionState({ current: null, completed: [], failed: [] });
            
            document.getElementById('current-node').textContent = '无';
            document.getElementById('execution-status').textContent = '已重置';
            document.getElementById('execution-status').className = 'status info';
        };

        window.initEventDemo = function() {
            try {
                const container = document.getElementById('event-container');
                container.innerHTML = '';
                
                eventEditor = new FlowchartEditor({
                    container: container,
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    background: { color: '#fafafa' },
                    grid: { visible: true, size: 20 }
                });

                // 添加一些示例节点
                eventEditor.addNode({ type: 'start', x: 100, y: 100, text: '点击我' });
                eventEditor.addNode({ type: 'approval', x: 250, y: 100, text: '审批节点' });
                eventEditor.addNode({ type: 'end', x: 400, y: 100, text: '结束' });

                // 绑定事件监听
                eventEditor.on('node:click', (data) => {
                    logEvent('节点点击', `节点 ${data.id} (${data.type}) 被点击`);
                });

                eventEditor.on('edge:click', (data) => {
                    logEvent('连线点击', `连线 ${data.id} 被点击`);
                });

                eventEditor.on('data:change', (data) => {
                    logEvent('数据变化', `流程图数据已更新`);
                });

                logEvent('系统', '事件演示已初始化，点击节点或连线查看事件');
            } catch (error) {
                console.error('初始化事件演示失败:', error);
                logEvent('错误', '初始化失败: ' + error.message);
            }
        };

        window.clearEventLog = function() {
            document.getElementById('event-log').innerHTML = '事件日志已清空...';
        };

        function logEvent(type, message) {
            const log = document.getElementById('event-log');
            const time = new Date().toLocaleTimeString();
            const entry = `[${time}] ${type}: ${message}\n`;
            log.textContent += entry;
            log.scrollTop = log.scrollHeight;
        }

        function updateEditorStatus() {
            if (!editor) return;
            
            const data = editor.getData();
            document.getElementById('node-count').textContent = data.nodes.length;
            document.getElementById('edge-count').textContent = data.edges.length;
        }
    </script>
</body>
</html>

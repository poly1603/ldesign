<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React 集成示例 - LDesign Flowchart Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: #fff;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #722ED1;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .demo-section {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .demo-section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 16px;
            border-bottom: 2px solid #722ED1;
            padding-bottom: 8px;
        }

        .flowchart-container {
            width: 100%;
            height: 500px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: #fafafa;
            position: relative;
        }

        .controls {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #722ED1;
            background: #fff;
            color: #722ED1;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #722ED1;
            color: #fff;
        }

        .btn.primary {
            background: #722ED1;
            color: #fff;
        }

        .btn.primary:hover {
            background: #5e2aa7;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: #fff;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #722ED1;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .event-log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .log-time {
            color: #666;
        }

        .log-event {
            color: #722ED1;
            font-weight: bold;
        }

        .log-message {
            color: #333;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { FlowchartEditor, FlowchartViewer } from '../src/index.ts';

        const { useState, useEffect, useRef, useCallback } = React;

        // 流程图编辑器组件
        function FlowchartEditorComponent() {
            const containerRef = useRef(null);
            const editorRef = useRef(null);
            const [editorState, setEditorState] = useState({
                initialized: false,
                nodeCount: 0,
                edgeCount: 0,
                status: '未初始化'
            });
            const [eventLog, setEventLog] = useState([]);

            // 添加日志条目
            const addLogEntry = useCallback((event, message) => {
                const entry = {
                    time: new Date().toLocaleTimeString(),
                    event,
                    message
                };
                setEventLog(prev => [...prev.slice(-9), entry]); // 保持最新10条
            }, []);

            // 初始化编辑器
            const initEditor = useCallback(() => {
                try {
                    if (editorRef.current) {
                        editorRef.current.destroy();
                    }

                    const editor = new FlowchartEditor({
                        container: containerRef.current,
                        width: containerRef.current.offsetWidth,
                        height: containerRef.current.offsetHeight,
                        background: { color: '#fafafa' },
                        grid: { visible: true, size: 20 }
                    });

                    // 绑定事件
                    editor.on('node:click', (data) => {
                        addLogEntry('节点点击', `点击了 ${data.text || data.id}`);
                        updateEditorState();
                    });

                    editor.on('edge:click', (data) => {
                        addLogEntry('连线点击', `点击了连线 ${data.id}`);
                    });

                    editor.on('data:change', () => {
                        addLogEntry('数据变化', '流程图数据已更新');
                        updateEditorState();
                    });

                    editorRef.current = editor;
                    setEditorState(prev => ({
                        ...prev,
                        initialized: true,
                        status: '已初始化'
                    }));
                    addLogEntry('系统', '编辑器初始化成功');
                    updateEditorState();
                } catch (error) {
                    console.error('初始化编辑器失败:', error);
                    setEditorState(prev => ({
                        ...prev,
                        status: '初始化失败'
                    }));
                    addLogEntry('错误', '编辑器初始化失败: ' + error.message);
                }
            }, [addLogEntry]);

            // 更新编辑器状态
            const updateEditorState = useCallback(() => {
                if (editorRef.current) {
                    const data = editorRef.current.getData();
                    setEditorState(prev => ({
                        ...prev,
                        nodeCount: data.nodes.length,
                        edgeCount: data.edges.length
                    }));
                }
            }, []);

            // 添加示例流程
            const addSampleFlow = useCallback(() => {
                if (!editorRef.current) return;

                const nodes = [
                    { type: 'start', x: 100, y: 200, text: '开始' },
                    { type: 'approval', x: 250, y: 200, text: '初审' },
                    { type: 'condition', x: 400, y: 200, text: '条件判断' },
                    { type: 'approval', x: 550, y: 150, text: '复审' },
                    { type: 'process', x: 550, y: 250, text: '处理' },
                    { type: 'end', x: 700, y: 200, text: '结束' }
                ];

                nodes.forEach(node => {
                    editorRef.current.addNode(node);
                });

                addLogEntry('操作', '添加了示例流程');
            }, [addLogEntry]);

            // 随机添加节点
            const addRandomNode = useCallback(() => {
                if (!editorRef.current) return;

                const types = ['approval', 'condition', 'process'];
                const type = types[Math.floor(Math.random() * types.length)];
                const x = Math.random() * 600 + 50;
                const y = Math.random() * 400 + 50;

                editorRef.current.addNode({
                    type: type,
                    x: x,
                    y: y,
                    text: `随机${type}`
                });

                addLogEntry('操作', `添加了随机${type}节点`);
            }, [addLogEntry]);

            // 清空流程
            const clearFlow = useCallback(() => {
                if (!editorRef.current) return;

                editorRef.current.clearData();
                addLogEntry('操作', '清空了流程图');
            }, [addLogEntry]);

            // 导出数据
            const exportData = useCallback(() => {
                if (!editorRef.current) return;

                const data = editorRef.current.getData();
                console.log('导出的流程数据:', data);
                addLogEntry('操作', `导出了 ${data.nodes.length} 个节点的数据`);
                alert(`已导出 ${data.nodes.length} 个节点和 ${data.edges.length} 条连线到控制台`);
            }, [addLogEntry]);

            // 组件挂载时初始化
            useEffect(() => {
                initEditor();
                return () => {
                    if (editorRef.current) {
                        editorRef.current.destroy();
                    }
                };
            }, [initEditor]);

            return (
                <div className="demo-section">
                    <h2>React Hooks 流程图编辑器</h2>
                    <div className="controls">
                        <button className="btn primary" onClick={initEditor}>
                            重新初始化
                        </button>
                        <button 
                            className="btn" 
                            onClick={addSampleFlow}
                            disabled={!editorState.initialized}
                        >
                            添加示例流程
                        </button>
                        <button 
                            className="btn" 
                            onClick={addRandomNode}
                            disabled={!editorState.initialized}
                        >
                            随机添加节点
                        </button>
                        <button 
                            className="btn" 
                            onClick={exportData}
                            disabled={!editorState.initialized}
                        >
                            导出数据
                        </button>
                        <button 
                            className="btn" 
                            onClick={clearFlow}
                            disabled={!editorState.initialized}
                        >
                            清空
                        </button>
                    </div>
                    
                    <div className="flowchart-container" ref={containerRef}>
                        {!editorState.initialized && (
                            <div style={{
                                position: 'absolute',
                                top: '50%',
                                left: '50%',
                                transform: 'translate(-50%, -50%)',
                                color: '#666'
                            }}>
                                编辑器初始化中...
                            </div>
                        )}
                    </div>

                    <div className="info-panel">
                        <div className="stats-grid">
                            <div className="stat-card">
                                <div className="stat-value">{editorState.nodeCount}</div>
                                <div className="stat-label">节点数量</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-value">{editorState.edgeCount}</div>
                                <div className="stat-label">连线数量</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-value">{editorState.status}</div>
                                <div className="stat-label">编辑器状态</div>
                            </div>
                        </div>

                        <h4>事件日志</h4>
                        <div className="event-log">
                            {eventLog.map((entry, index) => (
                                <div key={index} className="log-entry">
                                    <span className="log-time">[{entry.time}]</span>{' '}
                                    <span className="log-event">{entry.event}:</span>{' '}
                                    <span className="log-message">{entry.message}</span>
                                </div>
                            ))}
                            {eventLog.length === 0 && (
                                <div style={{ color: '#666', textAlign: 'center', padding: '20px' }}>
                                    等待事件...
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // 主应用组件
        function App() {
            return (
                <div>
                    <div className="header">
                        <div className="container">
                            <h1>LDesign Flowchart Editor - React 集成示例</h1>
                            <p>展示如何在 React 应用中使用 Hooks 集成流程图编辑器</p>
                        </div>
                    </div>

                    <div className="container">
                        <FlowchartEditorComponent />
                        
                        <div className="demo-section">
                            <h2>React 集成特点</h2>
                            <ul style={{ lineHeight: '1.6', paddingLeft: '20px' }}>
                                <li><strong>Hooks 支持</strong> - 使用 useState、useEffect、useRef 等现代 React Hooks</li>
                                <li><strong>状态管理</strong> - React 状态与流程图数据双向绑定</li>
                                <li><strong>事件处理</strong> - 流程图事件与 React 组件事件无缝集成</li>
                                <li><strong>生命周期</strong> - 组件挂载和卸载时正确初始化和清理编辑器</li>
                                <li><strong>响应式更新</strong> - 编辑器状态变化自动更新 UI</li>
                                <li><strong>TypeScript 支持</strong> - 完整的类型定义支持</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        // 渲染应用
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原生 JavaScript 高级示例 - LDesign Flowchart Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: #fff;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #722ED1;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .sidebar {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .main-content {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 12px;
            border-bottom: 2px solid #722ED1;
            padding-bottom: 6px;
        }

        .node-palette {
            margin-bottom: 20px;
        }

        .node-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .node-item:hover {
            background: #722ED1;
            color: #fff;
            border-color: #722ED1;
        }

        .node-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .node-icon.start { background: #52c41a; color: #fff; }
        .node-icon.approval { background: #1890ff; color: #fff; }
        .node-icon.condition { background: #fa8c16; color: #fff; }
        .node-icon.process { background: #8c8c8c; color: #fff; }
        .node-icon.end { background: #f5222d; color: #fff; }
        .node-icon.parallel { background: #722ed1; color: #fff; }
        .node-icon.exclusive { background: #13c2c2; color: #fff; }

        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #722ED1;
            background: #fff;
            color: #722ED1;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #722ED1;
            color: #fff;
        }

        .btn.primary {
            background: #722ED1;
            color: #fff;
        }

        .btn.primary:hover {
            background: #5e2aa7;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .flowchart-container {
            flex: 1;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: #fafafa;
            position: relative;
            min-height: 400px;
        }

        .properties-panel {
            margin-top: 20px;
        }

        .property-group {
            margin-bottom: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .property-group h4 {
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .property-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .property-item label {
            width: 80px;
            font-size: 12px;
            color: #666;
        }

        .property-item input,
        .property-item select {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #d9d9d9;
            border-radius: 3px;
            font-size: 12px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-top: 1px solid #e9ecef;
            margin-top: 16px;
            font-size: 12px;
            color: #666;
        }

        .minimap {
            width: 100%;
            height: 120px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: #fafafa;
            margin-bottom: 16px;
        }

        .layer-panel {
            margin-bottom: 20px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 2px 0;
            background: #f8f9fa;
            border-radius: 3px;
            font-size: 12px;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .history-panel {
            margin-bottom: 20px;
        }

        .history-item {
            padding: 4px 8px;
            margin: 2px 0;
            background: #f8f9fa;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #e6f7ff;
        }

        .history-item.current {
            background: #722ED1;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>LDesign Flowchart Editor - 原生 JavaScript 高级示例</h1>
            <p>展示完整的流程图编辑器界面和高级功能</p>
        </div>
    </div>

    <div class="container">
        <div class="layout">
            <!-- 侧边栏 -->
            <div class="sidebar">
                <!-- 节点面板 -->
                <div class="node-palette">
                    <h3>节点面板</h3>
                    <div class="node-item" data-type="start">
                        <div class="node-icon start">S</div>
                        <span>开始节点</span>
                    </div>
                    <div class="node-item" data-type="approval">
                        <div class="node-icon approval">A</div>
                        <span>审批节点</span>
                    </div>
                    <div class="node-item" data-type="condition">
                        <div class="node-icon condition">C</div>
                        <span>条件节点</span>
                    </div>
                    <div class="node-item" data-type="process">
                        <div class="node-icon process">P</div>
                        <span>流程节点</span>
                    </div>
                    <div class="node-item" data-type="parallel-gateway">
                        <div class="node-icon parallel">||</div>
                        <span>并行网关</span>
                    </div>
                    <div class="node-item" data-type="exclusive-gateway">
                        <div class="node-icon exclusive">X</div>
                        <span>排他网关</span>
                    </div>
                    <div class="node-item" data-type="end">
                        <div class="node-icon end">E</div>
                        <span>结束节点</span>
                    </div>
                </div>

                <!-- 小地图 -->
                <div class="minimap-panel">
                    <h3>小地图</h3>
                    <div class="minimap" id="minimap"></div>
                </div>

                <!-- 图层面板 -->
                <div class="layer-panel">
                    <h3>图层</h3>
                    <div class="layer-item">
                        <input type="checkbox" id="layer-nodes" checked>
                        <label for="layer-nodes">节点层</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="layer-edges" checked>
                        <label for="layer-edges">连线层</label>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="layer-grid" checked>
                        <label for="layer-grid">网格层</label>
                    </div>
                </div>

                <!-- 历史记录 -->
                <div class="history-panel">
                    <h3>历史记录</h3>
                    <div id="history-list">
                        <div class="history-item current">初始状态</div>
                    </div>
                </div>

                <!-- 属性面板 -->
                <div class="properties-panel">
                    <h3>属性面板</h3>
                    <div id="properties-content">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            选择节点或连线查看属性
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="main-content">
                <!-- 工具栏 -->
                <div class="toolbar">
                    <button class="btn primary" id="btn-new">新建</button>
                    <button class="btn" id="btn-open">打开</button>
                    <button class="btn" id="btn-save">保存</button>
                    <button class="btn" id="btn-export">导出</button>
                    <div style="width: 1px; height: 20px; background: #e9ecef; margin: 0 4px;"></div>
                    <button class="btn" id="btn-undo">撤销</button>
                    <button class="btn" id="btn-redo">重做</button>
                    <div style="width: 1px; height: 20px; background: #e9ecef; margin: 0 4px;"></div>
                    <button class="btn" id="btn-zoom-in">放大</button>
                    <button class="btn" id="btn-zoom-out">缩小</button>
                    <button class="btn" id="btn-fit">适应</button>
                    <button class="btn" id="btn-actual">实际大小</button>
                    <div style="width: 1px; height: 20px; background: #e9ecef; margin: 0 4px;"></div>
                    <button class="btn" id="btn-validate">验证</button>
                    <button class="btn" id="btn-simulate">模拟</button>
                </div>

                <!-- 画布区域 -->
                <div class="flowchart-container" id="flowchart-container">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">
                        拖拽节点到此处开始创建流程图
                    </div>
                </div>

                <!-- 状态栏 -->
                <div class="status-bar">
                    <div>
                        <span>节点: <span id="status-nodes">0</span></span>
                        <span style="margin-left: 16px;">连线: <span id="status-edges">0</span></span>
                        <span style="margin-left: 16px;">选中: <span id="status-selected">无</span></span>
                    </div>
                    <div>
                        <span>缩放: <span id="status-zoom">100%</span></span>
                        <span style="margin-left: 16px;">坐标: <span id="status-position">0, 0</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { FlowchartEditor } from '../src/index.ts';

        class AdvancedFlowchartApp {
            constructor() {
                this.editor = null;
                this.selectedElement = null;
                this.history = ['初始状态'];
                this.currentHistoryIndex = 0;
                this.init();
            }

            init() {
                this.initEditor();
                this.bindEvents();
                this.updateStatus();
            }

            initEditor() {
                const container = document.getElementById('flowchart-container');
                
                this.editor = new FlowchartEditor({
                    container: container,
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    background: { color: '#fafafa' },
                    grid: { visible: true, size: 20 }
                });

                // 绑定编辑器事件
                this.editor.on('node:click', (data) => {
                    this.selectedElement = { type: 'node', data };
                    this.updatePropertiesPanel();
                    this.updateStatus();
                });

                this.editor.on('edge:click', (data) => {
                    this.selectedElement = { type: 'edge', data };
                    this.updatePropertiesPanel();
                    this.updateStatus();
                });

                this.editor.on('data:change', () => {
                    this.updateStatus();
                    this.addHistoryEntry('数据变更');
                });

                // 监听鼠标移动更新坐标
                container.addEventListener('mousemove', (e) => {
                    const rect = container.getBoundingClientRect();
                    const x = Math.round(e.clientX - rect.left);
                    const y = Math.round(e.clientY - rect.top);
                    document.getElementById('status-position').textContent = `${x}, ${y}`;
                });
            }

            bindEvents() {
                // 节点面板拖拽
                document.querySelectorAll('.node-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const type = item.dataset.type;
                        this.addNodeAtCenter(type);
                    });
                });

                // 工具栏按钮
                document.getElementById('btn-new').addEventListener('click', () => this.newFlow());
                document.getElementById('btn-save').addEventListener('click', () => this.saveFlow());
                document.getElementById('btn-export').addEventListener('click', () => this.exportFlow());
                document.getElementById('btn-undo').addEventListener('click', () => this.undo());
                document.getElementById('btn-redo').addEventListener('click', () => this.redo());
                document.getElementById('btn-zoom-in').addEventListener('click', () => this.zoomIn());
                document.getElementById('btn-zoom-out').addEventListener('click', () => this.zoomOut());
                document.getElementById('btn-fit').addEventListener('click', () => this.fitView());
                document.getElementById('btn-actual').addEventListener('click', () => this.actualSize());
                document.getElementById('btn-validate').addEventListener('click', () => this.validateFlow());
                document.getElementById('btn-simulate').addEventListener('click', () => this.simulateFlow());

                // 图层控制
                document.getElementById('layer-grid').addEventListener('change', (e) => {
                    // 这里可以控制网格显示/隐藏
                    console.log('网格层:', e.target.checked);
                });
            }

            addNodeAtCenter(type) {
                const container = document.getElementById('flowchart-container');
                const centerX = container.offsetWidth / 2;
                const centerY = container.offsetHeight / 2;
                
                // 添加一些随机偏移避免重叠
                const offsetX = (Math.random() - 0.5) * 100;
                const offsetY = (Math.random() - 0.5) * 100;

                this.editor.addNode({
                    type: type,
                    x: centerX + offsetX,
                    y: centerY + offsetY,
                    text: this.getNodeDefaultText(type)
                });

                this.addHistoryEntry(`添加${type}节点`);
            }

            getNodeDefaultText(type) {
                const texts = {
                    'start': '开始',
                    'approval': '审批',
                    'condition': '条件判断',
                    'process': '处理',
                    'parallel-gateway': '并行网关',
                    'exclusive-gateway': '排他网关',
                    'end': '结束'
                };
                return texts[type] || type;
            }

            updatePropertiesPanel() {
                const content = document.getElementById('properties-content');
                
                if (!this.selectedElement) {
                    content.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">选择节点或连线查看属性</div>';
                    return;
                }

                if (this.selectedElement.type === 'node') {
                    const node = this.selectedElement.data;
                    content.innerHTML = `
                        <div class="property-group">
                            <h4>基本属性</h4>
                            <div class="property-item">
                                <label>ID:</label>
                                <input type="text" value="${node.id}" readonly>
                            </div>
                            <div class="property-item">
                                <label>类型:</label>
                                <input type="text" value="${node.type}" readonly>
                            </div>
                            <div class="property-item">
                                <label>文本:</label>
                                <input type="text" value="${node.text || ''}" id="node-text">
                            </div>
                        </div>
                        <div class="property-group">
                            <h4>位置属性</h4>
                            <div class="property-item">
                                <label>X:</label>
                                <input type="number" value="${node.x}" id="node-x">
                            </div>
                            <div class="property-item">
                                <label>Y:</label>
                                <input type="number" value="${node.y}" id="node-y">
                            </div>
                        </div>
                    `;

                    // 绑定属性更新事件
                    document.getElementById('node-text').addEventListener('change', (e) => {
                        this.editor.updateNode(node.id, { text: e.target.value });
                    });
                }
            }

            updateStatus() {
                if (!this.editor) return;

                const data = this.editor.getData();
                document.getElementById('status-nodes').textContent = data.nodes.length;
                document.getElementById('status-edges').textContent = data.edges.length;
                document.getElementById('status-selected').textContent = 
                    this.selectedElement ? `${this.selectedElement.type}: ${this.selectedElement.data.id}` : '无';
            }

            addHistoryEntry(action) {
                this.history = this.history.slice(0, this.currentHistoryIndex + 1);
                this.history.push(action);
                this.currentHistoryIndex = this.history.length - 1;
                this.updateHistoryPanel();
            }

            updateHistoryPanel() {
                const list = document.getElementById('history-list');
                list.innerHTML = this.history.map((item, index) => 
                    `<div class="history-item ${index === this.currentHistoryIndex ? 'current' : ''}">${item}</div>`
                ).join('');
            }

            newFlow() {
                this.editor.clearData();
                this.selectedElement = null;
                this.updatePropertiesPanel();
                this.addHistoryEntry('新建流程');
            }

            saveFlow() {
                const data = this.editor.getData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'flowchart.json';
                a.click();
                URL.revokeObjectURL(url);
                this.addHistoryEntry('保存流程');
            }

            exportFlow() {
                const data = this.editor.getData();
                console.log('导出的流程数据:', data);
                alert(`已导出 ${data.nodes.length} 个节点和 ${data.edges.length} 条连线到控制台`);
            }

            undo() {
                if (this.currentHistoryIndex > 0) {
                    this.currentHistoryIndex--;
                    this.updateHistoryPanel();
                    console.log('撤销到:', this.history[this.currentHistoryIndex]);
                }
            }

            redo() {
                if (this.currentHistoryIndex < this.history.length - 1) {
                    this.currentHistoryIndex++;
                    this.updateHistoryPanel();
                    console.log('重做到:', this.history[this.currentHistoryIndex]);
                }
            }

            zoomIn() {
                // 这里可以实现放大功能
                console.log('放大');
            }

            zoomOut() {
                // 这里可以实现缩小功能
                console.log('缩小');
            }

            fitView() {
                // 这里可以实现适应视图功能
                console.log('适应视图');
            }

            actualSize() {
                // 这里可以实现实际大小功能
                console.log('实际大小');
            }

            validateFlow() {
                const data = this.editor.getData();
                const startNodes = data.nodes.filter(n => n.type === 'start');
                const endNodes = data.nodes.filter(n => n.type === 'end');
                
                let messages = [];
                if (startNodes.length === 0) messages.push('缺少开始节点');
                if (startNodes.length > 1) messages.push('开始节点过多');
                if (endNodes.length === 0) messages.push('缺少结束节点');
                
                if (messages.length === 0) {
                    alert('流程验证通过！');
                } else {
                    alert('验证失败：\n' + messages.join('\n'));
                }
            }

            simulateFlow() {
                alert('模拟执行功能开发中...');
            }
        }

        // 启动应用
        new AdvancedFlowchartApp();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±æ€§é¢æ¿æµ‹è¯• - LDesign Flowchart</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    
    .container {
      display: flex;
      gap: 20px;
      height: 80vh;
    }
    
    .editor-container {
      flex: 2;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .property-panel-container {
      flex: 1;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
    }
    
    .toolbar {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .toolbar button {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .toolbar button:hover {
      background: #0056b3;
    }
    
    .toolbar button.success {
      background: #28a745;
    }
    
    .toolbar button.success:hover {
      background: #1e7e34;
    }
    
    .toolbar button.warning {
      background: #ffc107;
      color: #212529;
    }
    
    .toolbar button.warning:hover {
      background: #e0a800;
    }
    
    #flowchart {
      height: calc(100% - 60px);
      width: 100%;
    }
    
    .debug-info {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .debug-info h4 {
      margin: 0 0 10px 0;
      color: #495057;
    }
    
    .debug-log {
      white-space: pre-wrap;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª å±æ€§é¢æ¿ç”»å¸ƒåˆ·æ–°æµ‹è¯•</h1>
  <p>æµ‹è¯•å±æ€§é¢æ¿ä¿®æ”¹èŠ‚ç‚¹å±æ€§åï¼Œç”»å¸ƒæ˜¯å¦ç«‹å³åˆ·æ–°</p>
  
  <div class="container">
    <div class="editor-container">
      <div class="toolbar">
        <button onclick="loadTemplate()">åŠ è½½æµ‹è¯•æµç¨‹</button>
        <button onclick="addStartNode()">æ·»åŠ å¼€å§‹èŠ‚ç‚¹</button>
        <button onclick="addApprovalNode()">æ·»åŠ å®¡æ‰¹èŠ‚ç‚¹</button>
        <button onclick="addEndNode()">æ·»åŠ ç»“æŸèŠ‚ç‚¹</button>
        <button class="success" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
        <button class="warning" onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
      </div>
      <div id="flowchart"></div>
    </div>
    
    <div class="property-panel-container">
      <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
      <ol style="padding-left: 20px; color: #666; font-size: 14px;">
        <li>ç‚¹å‡»"åŠ è½½æµ‹è¯•æµç¨‹"åˆ›å»ºç¤ºä¾‹æµç¨‹</li>
        <li>ç‚¹å‡»ç”»å¸ƒä¸­çš„èŠ‚ç‚¹é€‰ä¸­å®ƒ</li>
        <li>å³ä¾§ä¼šå‡ºç°å±æ€§é¢æ¿</li>
        <li>ä¿®æ”¹èŠ‚ç‚¹æ–‡æœ¬æˆ–ä½ç½®</li>
        <li>ç‚¹å‡»"åº”ç”¨æ›´æ”¹"</li>
        <li>è§‚å¯Ÿç”»å¸ƒæ˜¯å¦ç«‹å³åˆ·æ–°</li>
      </ol>
      
      <div id="propertyPanelContainer">
        <p style="color: #999; text-align: center; font-style: italic; margin-top: 40px;">
          ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å±æ€§é¢æ¿
        </p>
      </div>
      
      <div class="debug-info">
        <h4>ğŸ“Š è°ƒè¯•æ—¥å¿—</h4>
        <div id="debugLog" class="debug-log">ç³»ç»Ÿå¯åŠ¨ä¸­...</div>
      </div>
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥æ„å»ºå¥½çš„æ¨¡å—
    import * as FlowchartModule from './dist/index.js';
    
    let editor = null;
    let propertyPanel = null;
    let debugLog = '';

    // è°ƒè¯•æ—¥å¿—å‡½æ•°
    function log(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      debugLog = logEntry + (data ? `\n${JSON.stringify(data, null, 2)}` : '') + '\n' + debugLog;
      document.getElementById('debugLog').textContent = debugLog.substring(0, 3000);
      console.log(message, data);
    }

    // ç®€å•çš„å±æ€§é¢æ¿å®ç°
    class SimplePropertyPanel {
      constructor(container) {
        this.container = container;
        this.selectedNode = null;
        this.selectedEdge = null;
        this.onUpdateNode = null;
        this.onUpdateEdge = null;
      }
      
      setSelectedNode(node) {
        this.selectedNode = node;
        this.selectedEdge = null;
        this.render();
        log('èŠ‚ç‚¹è¢«é€‰ä¸­', { id: node?.id, type: node?.type, text: node?.text });
      }
      
      setSelectedEdge(edge) {
        this.selectedEdge = edge;
        this.selectedNode = null;
        this.render();
        log('è¿çº¿è¢«é€‰ä¸­', { id: edge?.id, text: edge?.text });
      }
      
      render() {
        if (this.selectedNode) {
          this.renderNodeProperties();
        } else if (this.selectedEdge) {
          this.renderEdgeProperties();
        } else {
          this.renderNoSelection();
        }
      }
      
      renderNodeProperties() {
        const node = this.selectedNode;
        this.container.innerHTML = `
          <h3>ğŸ¯ èŠ‚ç‚¹å±æ€§</h3>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èŠ‚ç‚¹ID:</label>
            <input type="text" value="${node.id}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èŠ‚ç‚¹ç±»å‹:</label>
            <select id="nodeType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="start" ${node.type === 'start' ? 'selected' : ''}>å¼€å§‹èŠ‚ç‚¹</option>
              <option value="approval" ${node.type === 'approval' ? 'selected' : ''}>å®¡æ‰¹èŠ‚ç‚¹</option>
              <option value="condition" ${node.type === 'condition' ? 'selected' : ''}>æ¡ä»¶èŠ‚ç‚¹</option>
              <option value="end" ${node.type === 'end' ? 'selected' : ''}>ç»“æŸèŠ‚ç‚¹</option>
            </select>
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èŠ‚ç‚¹æ–‡æœ¬:</label>
            <input type="text" id="nodeText" value="${node.text || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Xåæ ‡:</label>
            <input type="number" id="nodeX" value="${node.x || 0}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Yåæ ‡:</label>
            <input type="number" id="nodeY" value="${node.y || 0}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <button onclick="applyNodeChanges()" style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            âœ… åº”ç”¨æ›´æ”¹
          </button>
        `;
      }
      
      renderEdgeProperties() {
        const edge = this.selectedEdge;
        this.container.innerHTML = `
          <h3>ğŸ”— è¿çº¿å±æ€§</h3>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¿çº¿ID:</label>
            <input type="text" value="${edge.id}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¿çº¿æ–‡æœ¬:</label>
            <input type="text" id="edgeText" value="${edge.text || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èµ·ç‚¹èŠ‚ç‚¹:</label>
            <input type="text" value="${edge.sourceNodeId}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç»ˆç‚¹èŠ‚ç‚¹:</label>
            <input type="text" value="${edge.targetNodeId}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <button onclick="applyEdgeChanges()" style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            âœ… åº”ç”¨æ›´æ”¹
          </button>
        `;
      }
      
      renderNoSelection() {
        this.container.innerHTML = `
          <p style="color: #999; text-align: center; font-style: italic; margin-top: 40px;">
            ç‚¹å‡»èŠ‚ç‚¹æˆ–è¿çº¿æŸ¥çœ‹å±æ€§
          </p>
        `;
      }
    }

    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    function initFlowchart() {
      try {
        log('å¼€å§‹åˆå§‹åŒ–æµç¨‹å›¾ç¼–è¾‘å™¨...');
        
        // åˆ›å»ºç¼–è¾‘å™¨å®ä¾‹
        editor = new FlowchartModule.FlowchartEditor({
          container: '#flowchart',
          width: 800,
          height: 500,
          // ç¦ç”¨é»˜è®¤UIï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å±æ€§é¢æ¿
          ui: {
            enabled: false
          },
          background: {
            color: '#fafafa'
          },
          grid: {
            visible: true,
            size: 20,
            color: '#e5e5e5'
          }
        });

        // åˆ›å»ºå±æ€§é¢æ¿
        propertyPanel = new SimplePropertyPanel(
          document.getElementById('propertyPanelContainer')
        );
        
        // è·å–ç¼–è¾‘å™¨çš„å›è°ƒå‡½æ•°
        const callbacks = editor.createPropertyPanelCallbacks();
        propertyPanel.onUpdateNode = callbacks.onUpdateNode;
        propertyPanel.onUpdateEdge = callbacks.onUpdateEdge;
        
        // è¿æ¥å±æ€§é¢æ¿åˆ°ç¼–è¾‘å™¨
        editor.connectPropertyPanel(propertyPanel);
        
        // ç›‘å¬å„ç§äº‹ä»¶
        editor.on('node:click', ({ node }) => {
          log('èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶', { nodeId: node.id });
        });

        editor.on('edge:click', ({ edge }) => {
          log('è¿çº¿ç‚¹å‡»äº‹ä»¶', { edgeId: edge.id });
        });

        editor.on('canvas:click', () => {
          log('ç”»å¸ƒç‚¹å‡»äº‹ä»¶');
        });

        editor.on('data:change', () => {
          log('æ•°æ®å˜åŒ–äº‹ä»¶è§¦å‘');
        });

        // æ¸²æŸ“ç¼–è¾‘å™¨
        editor.render();
        
        log('âœ… æµç¨‹å›¾ç¼–è¾‘å™¨åˆå§‹åŒ–æˆåŠŸ');
        
        // è®¾ç½®å…¨å±€å¼•ç”¨
        window.editor = editor;
        window.propertyPanel = propertyPanel;
        
      } catch (error) {
        log('âŒ æµç¨‹å›¾ç¼–è¾‘å™¨åˆå§‹åŒ–å¤±è´¥', error);
      }
    }

    // åº”ç”¨èŠ‚ç‚¹æ›´æ”¹
    window.applyNodeChanges = function() {
      if (!propertyPanel.selectedNode || !propertyPanel.onUpdateNode) {
        log('âŒ æ²¡æœ‰é€‰ä¸­çš„èŠ‚ç‚¹æˆ–å›è°ƒå‡½æ•°');
        return;
      }
      
      const updates = {
        type: document.getElementById('nodeType').value,
        text: document.getElementById('nodeText').value,
        x: parseFloat(document.getElementById('nodeX').value),
        y: parseFloat(document.getElementById('nodeY').value)
      };
      
      log('ğŸš€ å¼€å§‹åº”ç”¨èŠ‚ç‚¹æ›´æ”¹', { nodeId: propertyPanel.selectedNode.id, updates });
      
      try {
        propertyPanel.onUpdateNode(propertyPanel.selectedNode.id, updates);
        
        // æ›´æ–°å±æ€§é¢æ¿æ˜¾ç¤º
        const updatedNode = editor.getNodeById(propertyPanel.selectedNode.id);
        if (updatedNode) {
          propertyPanel.setSelectedNode(updatedNode);
        }
        
        log('âœ… èŠ‚ç‚¹æ›´æ”¹åº”ç”¨æˆåŠŸ');
      } catch (error) {
        log('âŒ èŠ‚ç‚¹æ›´æ”¹åº”ç”¨å¤±è´¥', error);
      }
    };

    // åº”ç”¨è¿çº¿æ›´æ”¹
    window.applyEdgeChanges = function() {
      if (!propertyPanel.selectedEdge || !propertyPanel.onUpdateEdge) {
        log('âŒ æ²¡æœ‰é€‰ä¸­çš„è¿çº¿æˆ–å›è°ƒå‡½æ•°');
        return;
      }
      
      const updates = {
        text: document.getElementById('edgeText').value
      };
      
      log('ğŸš€ å¼€å§‹åº”ç”¨è¿çº¿æ›´æ”¹', { edgeId: propertyPanel.selectedEdge.id, updates });
      
      try {
        propertyPanel.onUpdateEdge(propertyPanel.selectedEdge.id, updates);
        
        // æ›´æ–°å±æ€§é¢æ¿æ˜¾ç¤º
        const updatedEdge = editor.getEdgeById(propertyPanel.selectedEdge.id);
        if (updatedEdge) {
          propertyPanel.setSelectedEdge(updatedEdge);
        }
        
        log('âœ… è¿çº¿æ›´æ”¹åº”ç”¨æˆåŠŸ');
      } catch (error) {
        log('âŒ è¿çº¿æ›´æ”¹åº”ç”¨å¤±è´¥', error);
      }
    };

    // å·¥å…·æ å‡½æ•°
    window.loadTemplate = function() {
      try {
        editor.clearData();
        
        const startId = editor.addNode({
          type: 'start',
          x: 150,
          y: 100,
          text: 'å¼€å§‹ç”³è¯·'
        });
        
        const approvalId = editor.addNode({
          type: 'approval',
          x: 350,
          y: 100,
          text: 'éƒ¨é—¨å®¡æ‰¹'
        });
        
        const endId = editor.addNode({
          type: 'end',
          x: 550,
          y: 100,
          text: 'å®Œæˆ'
        });
        
        editor.addEdge({
          sourceNodeId: startId,
          targetNodeId: approvalId,
          text: 'æäº¤'
        });
        
        editor.addEdge({
          sourceNodeId: approvalId,
          targetNodeId: endId,
          text: 'é€šè¿‡'
        });
        
        log('âœ… æµ‹è¯•æµç¨‹å·²åŠ è½½', { èŠ‚ç‚¹æ•°: 3, è¿çº¿æ•°: 2 });
      } catch (error) {
        log('âŒ åŠ è½½æµ‹è¯•æµç¨‹å¤±è´¥', error);
      }
    };

    window.addStartNode = function() {
      try {
        const nodeId = editor.addNode({
          type: 'start',
          x: Math.random() * 400 + 100,
          y: Math.random() * 200 + 100,
          text: 'å¼€å§‹'
        });
        log('âœ… æ·»åŠ å¼€å§‹èŠ‚ç‚¹', { nodeId });
      } catch (error) {
        log('âŒ æ·»åŠ å¼€å§‹èŠ‚ç‚¹å¤±è´¥', error);
      }
    };

    window.addApprovalNode = function() {
      try {
        const nodeId = editor.addNode({
          type: 'approval',
          x: Math.random() * 400 + 100,
          y: Math.random() * 200 + 100,
          text: 'å®¡æ‰¹'
        });
        log('âœ… æ·»åŠ å®¡æ‰¹èŠ‚ç‚¹', { nodeId });
      } catch (error) {
        log('âŒ æ·»åŠ å®¡æ‰¹èŠ‚ç‚¹å¤±è´¥', error);
      }
    };

    window.addEndNode = function() {
      try {
        const nodeId = editor.addNode({
          type: 'end',
          x: Math.random() * 400 + 100,
          y: Math.random() * 200 + 100,
          text: 'ç»“æŸ'
        });
        log('âœ… æ·»åŠ ç»“æŸèŠ‚ç‚¹', { nodeId });
      } catch (error) {
        log('âŒ æ·»åŠ ç»“æŸèŠ‚ç‚¹å¤±è´¥', error);
      }
    };

    window.exportData = function() {
      try {
        const data = editor.getData();
        log('ğŸ“‹ æµç¨‹å›¾æ•°æ®å¯¼å‡º', data);
        
        // ä¸‹è½½ä¸ºæ–‡ä»¶
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'flowchart-test-data.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        log('âŒ æ•°æ®å¯¼å‡ºå¤±è´¥', error);
      }
    };

    window.clearCanvas = function() {
      try {
        editor.clearData();
        propertyPanel.setSelectedNode(null);
        log('ğŸ—‘ï¸ ç”»å¸ƒå·²æ¸…ç©º');
      } catch (error) {
        log('âŒ æ¸…ç©ºç”»å¸ƒå¤±è´¥', error);
      }
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initFlowchart);
  </script>
</body>
</html>

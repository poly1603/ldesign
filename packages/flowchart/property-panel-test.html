<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>属性面板测试 - LDesign Flowchart</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    
    .container {
      display: flex;
      gap: 20px;
      height: 80vh;
    }
    
    .editor-container {
      flex: 2;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .property-panel-container {
      flex: 1;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
    }
    
    .toolbar {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .toolbar button {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .toolbar button:hover {
      background: #0056b3;
    }
    
    .toolbar button.success {
      background: #28a745;
    }
    
    .toolbar button.success:hover {
      background: #1e7e34;
    }
    
    .toolbar button.warning {
      background: #ffc107;
      color: #212529;
    }
    
    .toolbar button.warning:hover {
      background: #e0a800;
    }
    
    #flowchart {
      height: calc(100% - 60px);
      width: 100%;
    }
    
    .debug-info {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .debug-info h4 {
      margin: 0 0 10px 0;
      color: #495057;
    }
    
    .debug-log {
      white-space: pre-wrap;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <h1>🧪 属性面板画布刷新测试</h1>
  <p>测试属性面板修改节点属性后，画布是否立即刷新</p>
  
  <div class="container">
    <div class="editor-container">
      <div class="toolbar">
        <button onclick="loadTemplate()">加载测试流程</button>
        <button onclick="addStartNode()">添加开始节点</button>
        <button onclick="addApprovalNode()">添加审批节点</button>
        <button onclick="addEndNode()">添加结束节点</button>
        <button class="success" onclick="exportData()">导出数据</button>
        <button class="warning" onclick="clearCanvas()">清空画布</button>
      </div>
      <div id="flowchart"></div>
    </div>
    
    <div class="property-panel-container">
      <h3>📋 测试说明</h3>
      <ol style="padding-left: 20px; color: #666; font-size: 14px;">
        <li>点击"加载测试流程"创建示例流程</li>
        <li>点击画布中的节点选中它</li>
        <li>右侧会出现属性面板</li>
        <li>修改节点文本或位置</li>
        <li>点击"应用更改"</li>
        <li>观察画布是否立即刷新</li>
      </ol>
      
      <div id="propertyPanelContainer">
        <p style="color: #999; text-align: center; font-style: italic; margin-top: 40px;">
          点击节点查看属性面板
        </p>
      </div>
      
      <div class="debug-info">
        <h4>📊 调试日志</h4>
        <div id="debugLog" class="debug-log">系统启动中...</div>
      </div>
    </div>
  </div>

  <script type="module">
    // 导入构建好的模块
    import * as FlowchartModule from './dist/index.js';
    
    let editor = null;
    let propertyPanel = null;
    let debugLog = '';

    // 调试日志函数
    function log(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      debugLog = logEntry + (data ? `\n${JSON.stringify(data, null, 2)}` : '') + '\n' + debugLog;
      document.getElementById('debugLog').textContent = debugLog.substring(0, 3000);
      console.log(message, data);
    }

    // 简单的属性面板实现
    class SimplePropertyPanel {
      constructor(container) {
        this.container = container;
        this.selectedNode = null;
        this.selectedEdge = null;
        this.onUpdateNode = null;
        this.onUpdateEdge = null;
      }
      
      setSelectedNode(node) {
        this.selectedNode = node;
        this.selectedEdge = null;
        this.render();
        log('节点被选中', { id: node?.id, type: node?.type, text: node?.text });
      }
      
      setSelectedEdge(edge) {
        this.selectedEdge = edge;
        this.selectedNode = null;
        this.render();
        log('连线被选中', { id: edge?.id, text: edge?.text });
      }
      
      render() {
        if (this.selectedNode) {
          this.renderNodeProperties();
        } else if (this.selectedEdge) {
          this.renderEdgeProperties();
        } else {
          this.renderNoSelection();
        }
      }
      
      renderNodeProperties() {
        const node = this.selectedNode;
        this.container.innerHTML = `
          <h3>🎯 节点属性</h3>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">节点ID:</label>
            <input type="text" value="${node.id}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">节点类型:</label>
            <select id="nodeType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="start" ${node.type === 'start' ? 'selected' : ''}>开始节点</option>
              <option value="approval" ${node.type === 'approval' ? 'selected' : ''}>审批节点</option>
              <option value="condition" ${node.type === 'condition' ? 'selected' : ''}>条件节点</option>
              <option value="end" ${node.type === 'end' ? 'selected' : ''}>结束节点</option>
            </select>
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">节点文本:</label>
            <input type="text" id="nodeText" value="${node.text || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">X坐标:</label>
            <input type="number" id="nodeX" value="${node.x || 0}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Y坐标:</label>
            <input type="number" id="nodeY" value="${node.y || 0}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <button onclick="applyNodeChanges()" style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            ✅ 应用更改
          </button>
        `;
      }
      
      renderEdgeProperties() {
        const edge = this.selectedEdge;
        this.container.innerHTML = `
          <h3>🔗 连线属性</h3>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">连线ID:</label>
            <input type="text" value="${edge.id}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">连线文本:</label>
            <input type="text" id="edgeText" value="${edge.text || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">起点节点:</label>
            <input type="text" value="${edge.sourceNodeId}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">终点节点:</label>
            <input type="text" value="${edge.targetNodeId}" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          </div>
          <button onclick="applyEdgeChanges()" style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            ✅ 应用更改
          </button>
        `;
      }
      
      renderNoSelection() {
        this.container.innerHTML = `
          <p style="color: #999; text-align: center; font-style: italic; margin-top: 40px;">
            点击节点或连线查看属性
          </p>
        `;
      }
    }

    // 初始化编辑器
    function initFlowchart() {
      try {
        log('开始初始化流程图编辑器...');
        
        // 创建编辑器实例
        editor = new FlowchartModule.FlowchartEditor({
          container: '#flowchart',
          width: 800,
          height: 500,
          // 禁用默认UI，使用我们自定义的属性面板
          ui: {
            enabled: false
          },
          background: {
            color: '#fafafa'
          },
          grid: {
            visible: true,
            size: 20,
            color: '#e5e5e5'
          }
        });

        // 创建属性面板
        propertyPanel = new SimplePropertyPanel(
          document.getElementById('propertyPanelContainer')
        );
        
        // 获取编辑器的回调函数
        const callbacks = editor.createPropertyPanelCallbacks();
        propertyPanel.onUpdateNode = callbacks.onUpdateNode;
        propertyPanel.onUpdateEdge = callbacks.onUpdateEdge;
        
        // 连接属性面板到编辑器
        editor.connectPropertyPanel(propertyPanel);
        
        // 监听各种事件
        editor.on('node:click', ({ node }) => {
          log('节点点击事件', { nodeId: node.id });
        });

        editor.on('edge:click', ({ edge }) => {
          log('连线点击事件', { edgeId: edge.id });
        });

        editor.on('canvas:click', () => {
          log('画布点击事件');
        });

        editor.on('data:change', () => {
          log('数据变化事件触发');
        });

        // 渲染编辑器
        editor.render();
        
        log('✅ 流程图编辑器初始化成功');
        
        // 设置全局引用
        window.editor = editor;
        window.propertyPanel = propertyPanel;
        
      } catch (error) {
        log('❌ 流程图编辑器初始化失败', error);
      }
    }

    // 应用节点更改
    window.applyNodeChanges = function() {
      if (!propertyPanel.selectedNode || !propertyPanel.onUpdateNode) {
        log('❌ 没有选中的节点或回调函数');
        return;
      }
      
      const updates = {
        type: document.getElementById('nodeType').value,
        text: document.getElementById('nodeText').value,
        x: parseFloat(document.getElementById('nodeX').value),
        y: parseFloat(document.getElementById('nodeY').value)
      };
      
      log('🚀 开始应用节点更改', { nodeId: propertyPanel.selectedNode.id, updates });
      
      try {
        propertyPanel.onUpdateNode(propertyPanel.selectedNode.id, updates);
        
        // 更新属性面板显示
        const updatedNode = editor.getNodeById(propertyPanel.selectedNode.id);
        if (updatedNode) {
          propertyPanel.setSelectedNode(updatedNode);
        }
        
        log('✅ 节点更改应用成功');
      } catch (error) {
        log('❌ 节点更改应用失败', error);
      }
    };

    // 应用连线更改
    window.applyEdgeChanges = function() {
      if (!propertyPanel.selectedEdge || !propertyPanel.onUpdateEdge) {
        log('❌ 没有选中的连线或回调函数');
        return;
      }
      
      const updates = {
        text: document.getElementById('edgeText').value
      };
      
      log('🚀 开始应用连线更改', { edgeId: propertyPanel.selectedEdge.id, updates });
      
      try {
        propertyPanel.onUpdateEdge(propertyPanel.selectedEdge.id, updates);
        
        // 更新属性面板显示
        const updatedEdge = editor.getEdgeById(propertyPanel.selectedEdge.id);
        if (updatedEdge) {
          propertyPanel.setSelectedEdge(updatedEdge);
        }
        
        log('✅ 连线更改应用成功');
      } catch (error) {
        log('❌ 连线更改应用失败', error);
      }
    };

    // 工具栏函数
    window.loadTemplate = function() {
      try {
        editor.clearData();
        
        const startId = editor.addNode({
          type: 'start',
          x: 150,
          y: 100,
          text: '开始申请'
        });
        
        const approvalId = editor.addNode({
          type: 'approval',
          x: 350,
          y: 100,
          text: '部门审批'
        });
        
        const endId = editor.addNode({
          type: 'end',
          x: 550,
          y: 100,
          text: '完成'
        });
        
        editor.addEdge({
          sourceNodeId: startId,
          targetNodeId: approvalId,
          text: '提交'
        });
        
        editor.addEdge({
          sourceNodeId: approvalId,
          targetNodeId: endId,
          text: '通过'
        });
        
        log('✅ 测试流程已加载', { 节点数: 3, 连线数: 2 });
      } catch (error) {
        log('❌ 加载测试流程失败', error);
      }
    };

    window.addStartNode = function() {
      try {
        const nodeId = editor.addNode({
          type: 'start',
          x: Math.random() * 400 + 100,
          y: Math.random() * 200 + 100,
          text: '开始'
        });
        log('✅ 添加开始节点', { nodeId });
      } catch (error) {
        log('❌ 添加开始节点失败', error);
      }
    };

    window.addApprovalNode = function() {
      try {
        const nodeId = editor.addNode({
          type: 'approval',
          x: Math.random() * 400 + 100,
          y: Math.random() * 200 + 100,
          text: '审批'
        });
        log('✅ 添加审批节点', { nodeId });
      } catch (error) {
        log('❌ 添加审批节点失败', error);
      }
    };

    window.addEndNode = function() {
      try {
        const nodeId = editor.addNode({
          type: 'end',
          x: Math.random() * 400 + 100,
          y: Math.random() * 200 + 100,
          text: '结束'
        });
        log('✅ 添加结束节点', { nodeId });
      } catch (error) {
        log('❌ 添加结束节点失败', error);
      }
    };

    window.exportData = function() {
      try {
        const data = editor.getData();
        log('📋 流程图数据导出', data);
        
        // 下载为文件
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'flowchart-test-data.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        log('❌ 数据导出失败', error);
      }
    };

    window.clearCanvas = function() {
      try {
        editor.clearData();
        propertyPanel.setSelectedNode(null);
        log('🗑️ 画布已清空');
      } catch (error) {
        log('❌ 清空画布失败', error);
      }
    };

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initFlowchart);
  </script>
</body>
</html>

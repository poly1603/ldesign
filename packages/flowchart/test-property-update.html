<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±æ€§é¢æ¿æ›´æ–°æµ‹è¯•</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    
    .container {
      display: flex;
      gap: 20px;
      height: 80vh;
    }
    
    .editor-container {
      flex: 2;
      border: 1px solid #ddd;
      position: relative;
    }
    
    .property-panel {
      flex: 1;
      border: 1px solid #ddd;
      padding: 20px;
      overflow-y: auto;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    
    .btn:hover {
      background: #0056b3;
    }
    
    .toolbar {
      padding: 10px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }
    
    .toolbar button {
      margin-right: 10px;
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .debug {
      margin-top: 20px;
      padding: 10px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>å±æ€§é¢æ¿æ›´æ–°æµ‹è¯•</h1>
  <div class="container">
    <div class="editor-container">
      <div class="toolbar">
        <button onclick="addTestNode()">æ·»åŠ æµ‹è¯•èŠ‚ç‚¹</button>
        <button onclick="clearAll()">æ¸…ç©º</button>
      </div>
      <div id="editor" style="height: calc(100% - 60px);"></div>
    </div>
    
    <div class="property-panel">
      <div id="propertyContent">
        <p>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å±æ€§</p>
      </div>
      <div class="debug" id="debugInfo">
        è°ƒè¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
      </div>
    </div>
  </div>

  <script>
    // å¯¼å…¥æ¨¡æ‹Ÿ
    const FlowchartEditor = window.FlowchartEditor || class {
      constructor(config) {
        this.config = config
        this.container = config.container
        this.selectedNode = null
        this.nodes = []
        this.updateCallbacks = []
        this.init()
      }
      
      init() {
        this.container.innerHTML = `
          <div style="width: 100%; height: 100%; background: #fafafa; position: relative;">
            <div id="canvas" style="width: 100%; height: 100%;"></div>
          </div>
        `
        this.canvas = this.container.querySelector('#canvas')
        this.render()
      }
      
      addNode(nodeConfig) {
        const node = {
          id: 'node_' + Date.now(),
          ...nodeConfig
        }
        this.nodes.push(node)
        this.render()
        return node.id
      }
      
      updateNode(id, updates) {
        console.log('ğŸ“ FlowchartEditor.updateNode è¢«è°ƒç”¨:', id, updates)
        debugInfo(`updateNode called: ${id}`, updates)
        
        const nodeIndex = this.nodes.findIndex(n => n.id === id)
        if (nodeIndex >= 0) {
          this.nodes[nodeIndex] = { ...this.nodes[nodeIndex], ...updates }
          console.log('âœ… èŠ‚ç‚¹å·²æ›´æ–°:', this.nodes[nodeIndex])
          debugInfo(`èŠ‚ç‚¹å·²æ›´æ–°`, this.nodes[nodeIndex])
          
          // æ¨¡æ‹Ÿç”»å¸ƒåˆ·æ–°
          this.render()
          
          return true
        }
        console.warn('âŒ èŠ‚ç‚¹ä¸å­˜åœ¨:', id)
        return false
      }
      
      getNodeById(id) {
        return this.nodes.find(n => n.id === id) || null
      }
      
      render() {
        const canvas = this.canvas
        canvas.innerHTML = ''
        
        this.nodes.forEach(node => {
          const nodeEl = document.createElement('div')
          nodeEl.style.cssText = `
            position: absolute;
            left: ${node.x}px;
            top: ${node.y}px;
            width: 120px;
            height: 60px;
            background: ${this.getNodeColor(node.type)};
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
            color: white;
            font-weight: bold;
          `
          nodeEl.textContent = node.text || node.type
          nodeEl.onclick = () => this.selectNode(node.id)
          canvas.appendChild(nodeEl)
        })
      }
      
      getNodeColor(type) {
        const colors = {
          'start': '#28a745',
          'approval': '#007bff',
          'condition': '#ffc107',
          'end': '#dc3545'
        }
        return colors[type] || '#6c757d'
      }
      
      selectNode(id) {
        this.selectedNode = id
        const node = this.getNodeById(id)
        console.log('ğŸ¯ èŠ‚ç‚¹è¢«é€‰ä¸­:', node)
        debugInfo(`èŠ‚ç‚¹è¢«é€‰ä¸­`, node)
        
        if (window.propertyPanel && node) {
          window.propertyPanel.setSelectedNode(node)
        }
      }
      
      createPropertyPanelCallbacks() {
        return {
          onUpdateNode: (nodeId, updates) => {
            console.log('ğŸ”„ å±æ€§é¢æ¿å›è°ƒè¢«è§¦å‘:', nodeId, updates)
            debugInfo(`å±æ€§é¢æ¿å›è°ƒè¢«è§¦å‘`, { nodeId, updates })
            return this.updateNode(nodeId, updates)
          },
          onUpdateEdge: (edgeId, updates) => {
            console.log('ğŸ”„ è¿çº¿æ›´æ–°å›è°ƒè¢«è§¦å‘:', edgeId, updates)
            return true
          }
        }
      }
      
      connectPropertyPanel(panel) {
        console.log('ğŸ”— è¿æ¥å±æ€§é¢æ¿')
        // æ¨¡æ‹Ÿè¿æ¥å®Œæˆ
        debugInfo('å±æ€§é¢æ¿å·²è¿æ¥')
      }
    }

    // å±æ€§é¢æ¿ç±»
    class SimplePropertyPanel {
      constructor(container) {
        this.container = container
        this.selectedNode = null
        this.onUpdateNode = null
      }
      
      setSelectedNode(node) {
        this.selectedNode = node
        this.render()
      }
      
      render() {
        if (!this.selectedNode) {
          this.container.innerHTML = '<p>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å±æ€§</p>'
          return
        }
        
        const node = this.selectedNode
        this.container.innerHTML = `
          <h3>èŠ‚ç‚¹å±æ€§</h3>
          <div class="form-group">
            <label>ID:</label>
            <input type="text" value="${node.id}" readonly>
          </div>
          <div class="form-group">
            <label>ç±»å‹:</label>
            <select id="nodeType">
              <option value="start" ${node.type === 'start' ? 'selected' : ''}>å¼€å§‹</option>
              <option value="approval" ${node.type === 'approval' ? 'selected' : ''}>å®¡æ‰¹</option>
              <option value="condition" ${node.type === 'condition' ? 'selected' : ''}>æ¡ä»¶</option>
              <option value="end" ${node.type === 'end' ? 'selected' : ''}>ç»“æŸ</option>
            </select>
          </div>
          <div class="form-group">
            <label>æ–‡æœ¬:</label>
            <input type="text" id="nodeText" value="${node.text || ''}">
          </div>
          <div class="form-group">
            <label>Xåæ ‡:</label>
            <input type="number" id="nodeX" value="${node.x || 0}">
          </div>
          <div class="form-group">
            <label>Yåæ ‡:</label>
            <input type="number" id="nodeY" value="${node.y || 0}">
          </div>
          <button class="btn" onclick="applyChanges()">åº”ç”¨æ›´æ”¹</button>
        `
      }
    }

    // è°ƒè¯•å‡½æ•°
    function debugInfo(message, data = null) {
      const debugEl = document.getElementById('debugInfo')
      const timestamp = new Date().toLocaleTimeString()
      let logEntry = `[${timestamp}] ${message}`
      if (data) {
        logEntry += `\n${JSON.stringify(data, null, 2)}`
      }
      debugEl.innerHTML = logEntry + '\n' + debugEl.innerHTML.substring(0, 2000)
    }

    // å…¨å±€å˜é‡
    let editor = null
    let propertyPanel = null

    // åˆå§‹åŒ–
    function init() {
      // åˆ›å»ºç¼–è¾‘å™¨
      editor = new FlowchartEditor({
        container: document.getElementById('editor'),
        ui: { enabled: false }
      })
      
      // åˆ›å»ºå±æ€§é¢æ¿
      propertyPanel = new SimplePropertyPanel(
        document.getElementById('propertyContent')
      )
      
      // è®¾ç½®å›è°ƒ
      const callbacks = editor.createPropertyPanelCallbacks()
      propertyPanel.onUpdateNode = callbacks.onUpdateNode
      
      // è¿æ¥å±æ€§é¢æ¿
      editor.connectPropertyPanel(propertyPanel)
      
      // è®¾ç½®å…¨å±€å¼•ç”¨
      window.propertyPanel = propertyPanel
      window.editor = editor
      
      debugInfo('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ')
      console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ')
    }

    // åº”ç”¨æ›´æ”¹
    function applyChanges() {
      if (!propertyPanel.selectedNode || !propertyPanel.onUpdateNode) {
        debugInfo('âŒ æ²¡æœ‰é€‰ä¸­çš„èŠ‚ç‚¹æˆ–å›è°ƒå‡½æ•°')
        console.log('âŒ æ²¡æœ‰é€‰ä¸­çš„èŠ‚ç‚¹æˆ–å›è°ƒå‡½æ•°')
        return
      }
      
      const updates = {
        type: document.getElementById('nodeType').value,
        text: document.getElementById('nodeText').value,
        x: parseFloat(document.getElementById('nodeX').value),
        y: parseFloat(document.getElementById('nodeY').value)
      }
      
      console.log('ğŸš€ å¼€å§‹åº”ç”¨æ›´æ”¹:', propertyPanel.selectedNode.id, updates)
      debugInfo(`å¼€å§‹åº”ç”¨æ›´æ”¹`, { nodeId: propertyPanel.selectedNode.id, updates })
      
      const success = propertyPanel.onUpdateNode(propertyPanel.selectedNode.id, updates)
      
      if (success) {
        // æ›´æ–°å±æ€§é¢æ¿æ˜¾ç¤º
        const updatedNode = editor.getNodeById(propertyPanel.selectedNode.id)
        if (updatedNode) {
          propertyPanel.setSelectedNode(updatedNode)
        }
        debugInfo('âœ… æ›´æ”¹åº”ç”¨æˆåŠŸ')
        console.log('âœ… æ›´æ”¹åº”ç”¨æˆåŠŸ')
      } else {
        debugInfo('âŒ æ›´æ”¹åº”ç”¨å¤±è´¥')
        console.log('âŒ æ›´æ”¹åº”ç”¨å¤±è´¥')
      }
    }

    // å·¥å…·æ å‡½æ•°
    function addTestNode() {
      const nodeId = editor.addNode({
        type: 'approval',
        x: Math.random() * 300 + 50,
        y: Math.random() * 200 + 50,
        text: 'æµ‹è¯•èŠ‚ç‚¹'
      })
      debugInfo(`æ·»åŠ æµ‹è¯•èŠ‚ç‚¹: ${nodeId}`)
      console.log('â• æ·»åŠ æµ‹è¯•èŠ‚ç‚¹:', nodeId)
    }

    function clearAll() {
      editor.nodes = []
      editor.render()
      propertyPanel.setSelectedNode(null)
      debugInfo('æ¸…ç©ºç”»å¸ƒ')
      console.log('ğŸ—‘ï¸ æ¸…ç©ºç”»å¸ƒ')
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init)
  </script>
</body>
</html>

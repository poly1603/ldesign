<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>属性面板更新测试</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    
    .container {
      display: flex;
      gap: 20px;
      height: 80vh;
    }
    
    .editor-container {
      flex: 2;
      border: 1px solid #ddd;
      position: relative;
    }
    
    .property-panel {
      flex: 1;
      border: 1px solid #ddd;
      padding: 20px;
      overflow-y: auto;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    
    .btn:hover {
      background: #0056b3;
    }
    
    .toolbar {
      padding: 10px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }
    
    .toolbar button {
      margin-right: 10px;
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .debug {
      margin-top: 20px;
      padding: 10px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>属性面板更新测试</h1>
  <div class="container">
    <div class="editor-container">
      <div class="toolbar">
        <button onclick="addTestNode()">添加测试节点</button>
        <button onclick="clearAll()">清空</button>
      </div>
      <div id="editor" style="height: calc(100% - 60px);"></div>
    </div>
    
    <div class="property-panel">
      <div id="propertyContent">
        <p>点击节点查看属性</p>
      </div>
      <div class="debug" id="debugInfo">
        调试信息将在这里显示...
      </div>
    </div>
  </div>

  <script>
    // 导入模拟
    const FlowchartEditor = window.FlowchartEditor || class {
      constructor(config) {
        this.config = config
        this.container = config.container
        this.selectedNode = null
        this.nodes = []
        this.updateCallbacks = []
        this.init()
      }
      
      init() {
        this.container.innerHTML = `
          <div style="width: 100%; height: 100%; background: #fafafa; position: relative;">
            <div id="canvas" style="width: 100%; height: 100%;"></div>
          </div>
        `
        this.canvas = this.container.querySelector('#canvas')
        this.render()
      }
      
      addNode(nodeConfig) {
        const node = {
          id: 'node_' + Date.now(),
          ...nodeConfig
        }
        this.nodes.push(node)
        this.render()
        return node.id
      }
      
      updateNode(id, updates) {
        console.log('📝 FlowchartEditor.updateNode 被调用:', id, updates)
        debugInfo(`updateNode called: ${id}`, updates)
        
        const nodeIndex = this.nodes.findIndex(n => n.id === id)
        if (nodeIndex >= 0) {
          this.nodes[nodeIndex] = { ...this.nodes[nodeIndex], ...updates }
          console.log('✅ 节点已更新:', this.nodes[nodeIndex])
          debugInfo(`节点已更新`, this.nodes[nodeIndex])
          
          // 模拟画布刷新
          this.render()
          
          return true
        }
        console.warn('❌ 节点不存在:', id)
        return false
      }
      
      getNodeById(id) {
        return this.nodes.find(n => n.id === id) || null
      }
      
      render() {
        const canvas = this.canvas
        canvas.innerHTML = ''
        
        this.nodes.forEach(node => {
          const nodeEl = document.createElement('div')
          nodeEl.style.cssText = `
            position: absolute;
            left: ${node.x}px;
            top: ${node.y}px;
            width: 120px;
            height: 60px;
            background: ${this.getNodeColor(node.type)};
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
            color: white;
            font-weight: bold;
          `
          nodeEl.textContent = node.text || node.type
          nodeEl.onclick = () => this.selectNode(node.id)
          canvas.appendChild(nodeEl)
        })
      }
      
      getNodeColor(type) {
        const colors = {
          'start': '#28a745',
          'approval': '#007bff',
          'condition': '#ffc107',
          'end': '#dc3545'
        }
        return colors[type] || '#6c757d'
      }
      
      selectNode(id) {
        this.selectedNode = id
        const node = this.getNodeById(id)
        console.log('🎯 节点被选中:', node)
        debugInfo(`节点被选中`, node)
        
        if (window.propertyPanel && node) {
          window.propertyPanel.setSelectedNode(node)
        }
      }
      
      createPropertyPanelCallbacks() {
        return {
          onUpdateNode: (nodeId, updates) => {
            console.log('🔄 属性面板回调被触发:', nodeId, updates)
            debugInfo(`属性面板回调被触发`, { nodeId, updates })
            return this.updateNode(nodeId, updates)
          },
          onUpdateEdge: (edgeId, updates) => {
            console.log('🔄 连线更新回调被触发:', edgeId, updates)
            return true
          }
        }
      }
      
      connectPropertyPanel(panel) {
        console.log('🔗 连接属性面板')
        // 模拟连接完成
        debugInfo('属性面板已连接')
      }
    }

    // 属性面板类
    class SimplePropertyPanel {
      constructor(container) {
        this.container = container
        this.selectedNode = null
        this.onUpdateNode = null
      }
      
      setSelectedNode(node) {
        this.selectedNode = node
        this.render()
      }
      
      render() {
        if (!this.selectedNode) {
          this.container.innerHTML = '<p>点击节点查看属性</p>'
          return
        }
        
        const node = this.selectedNode
        this.container.innerHTML = `
          <h3>节点属性</h3>
          <div class="form-group">
            <label>ID:</label>
            <input type="text" value="${node.id}" readonly>
          </div>
          <div class="form-group">
            <label>类型:</label>
            <select id="nodeType">
              <option value="start" ${node.type === 'start' ? 'selected' : ''}>开始</option>
              <option value="approval" ${node.type === 'approval' ? 'selected' : ''}>审批</option>
              <option value="condition" ${node.type === 'condition' ? 'selected' : ''}>条件</option>
              <option value="end" ${node.type === 'end' ? 'selected' : ''}>结束</option>
            </select>
          </div>
          <div class="form-group">
            <label>文本:</label>
            <input type="text" id="nodeText" value="${node.text || ''}">
          </div>
          <div class="form-group">
            <label>X坐标:</label>
            <input type="number" id="nodeX" value="${node.x || 0}">
          </div>
          <div class="form-group">
            <label>Y坐标:</label>
            <input type="number" id="nodeY" value="${node.y || 0}">
          </div>
          <button class="btn" onclick="applyChanges()">应用更改</button>
        `
      }
    }

    // 调试函数
    function debugInfo(message, data = null) {
      const debugEl = document.getElementById('debugInfo')
      const timestamp = new Date().toLocaleTimeString()
      let logEntry = `[${timestamp}] ${message}`
      if (data) {
        logEntry += `\n${JSON.stringify(data, null, 2)}`
      }
      debugEl.innerHTML = logEntry + '\n' + debugEl.innerHTML.substring(0, 2000)
    }

    // 全局变量
    let editor = null
    let propertyPanel = null

    // 初始化
    function init() {
      // 创建编辑器
      editor = new FlowchartEditor({
        container: document.getElementById('editor'),
        ui: { enabled: false }
      })
      
      // 创建属性面板
      propertyPanel = new SimplePropertyPanel(
        document.getElementById('propertyContent')
      )
      
      // 设置回调
      const callbacks = editor.createPropertyPanelCallbacks()
      propertyPanel.onUpdateNode = callbacks.onUpdateNode
      
      // 连接属性面板
      editor.connectPropertyPanel(propertyPanel)
      
      // 设置全局引用
      window.propertyPanel = propertyPanel
      window.editor = editor
      
      debugInfo('系统初始化完成')
      console.log('✅ 系统初始化完成')
    }

    // 应用更改
    function applyChanges() {
      if (!propertyPanel.selectedNode || !propertyPanel.onUpdateNode) {
        debugInfo('❌ 没有选中的节点或回调函数')
        console.log('❌ 没有选中的节点或回调函数')
        return
      }
      
      const updates = {
        type: document.getElementById('nodeType').value,
        text: document.getElementById('nodeText').value,
        x: parseFloat(document.getElementById('nodeX').value),
        y: parseFloat(document.getElementById('nodeY').value)
      }
      
      console.log('🚀 开始应用更改:', propertyPanel.selectedNode.id, updates)
      debugInfo(`开始应用更改`, { nodeId: propertyPanel.selectedNode.id, updates })
      
      const success = propertyPanel.onUpdateNode(propertyPanel.selectedNode.id, updates)
      
      if (success) {
        // 更新属性面板显示
        const updatedNode = editor.getNodeById(propertyPanel.selectedNode.id)
        if (updatedNode) {
          propertyPanel.setSelectedNode(updatedNode)
        }
        debugInfo('✅ 更改应用成功')
        console.log('✅ 更改应用成功')
      } else {
        debugInfo('❌ 更改应用失败')
        console.log('❌ 更改应用失败')
      }
    }

    // 工具栏函数
    function addTestNode() {
      const nodeId = editor.addNode({
        type: 'approval',
        x: Math.random() * 300 + 50,
        y: Math.random() * 200 + 50,
        text: '测试节点'
      })
      debugInfo(`添加测试节点: ${nodeId}`)
      console.log('➕ 添加测试节点:', nodeId)
    }

    function clearAll() {
      editor.nodes = []
      editor.render()
      propertyPanel.setSelectedNode(null)
      debugInfo('清空画布')
      console.log('🗑️ 清空画布')
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init)
  </script>
</body>
</html>

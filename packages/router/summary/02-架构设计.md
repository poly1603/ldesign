# @ldesign/router 架构设计

## 整体架构

@ldesign/router 采用分层架构设计，从底层到上层分为以下几个层次：

```
┌─────────────────────────────────────────┐
│              应用层 (Application)        │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   插件系统   │  │   增强组件      │   │
│  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────┤
│              API 层 (API Layer)         │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │ 组合式 API  │  │   路由插件      │   │
│  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────┤
│             核心层 (Core Layer)         │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   路由器    │  │   路由匹配器    │   │
│  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────┤
│            基础层 (Foundation)          │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   历史管理   │  │   工具函数      │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
```

## 核心模块

### 1. 路由器 (Router)

**位置**: `src/core/router.ts`

**职责**:

- 路由导航控制
- 守卫系统管理
- 状态管理
- 事件分发

**核心类**:

```typescript
class Router {
  private matcher: RouteMatcher
  private history: RouterHistory
  private guards: RouteGuards

  // 导航方法
  push(to: RouteLocationRaw): Promise<NavigationFailure | void>
  replace(to: RouteLocationRaw): Promise<NavigationFailure | void>
  go(delta: number): void
  back(): void
  forward(): void

  // 守卫管理
  beforeEach(guard: NavigationGuardWithThis<undefined>): () => void
  beforeResolve(guard: NavigationGuardWithThis<undefined>): () => void
  afterEach(guard: NavigationHookAfter): () => void
}
```

### 2. 路由匹配器 (Matcher)

**位置**: `src/core/matcher.ts`

**职责**:

- 路由记录管理
- 路径匹配算法
- 动态路由支持
- 缓存优化

**核心算法**:

```typescript
class RouteMatcher {
  private routes: RouteRecordNormalized[]
  private pathMap: Map<string, RouteRecordNormalized>
  private nameMap: Map<string | symbol, RouteRecordNormalized>

  // 路由匹配
  resolve(location: RouteLocationRaw): RouteLocationNormalized

  // 路由记录管理
  addRoute(record: RouteRecordRaw): () => void
  removeRoute(name: string | symbol): void
  getRoutes(): RouteRecordNormalized[]
}
```

### 3. 历史管理 (History)

**位置**: `src/core/history.ts`

**职责**:

- 浏览器历史管理
- 路径变化监听
- 状态同步

**支持模式**:

- HTML5 History API
- Hash 模式
- Memory 模式（SSR）

### 4. 组合式 API

**位置**: `src/composables/index.ts`

**提供的 API**:

```typescript
// 核心 API
export function useRouter(): Router
export function useRoute(): ComputedRef<RouteLocationNormalized>

// 便利 API
export function useParams(): ComputedRef<RouteParams>
export function useQuery(): ComputedRef<LocationQuery>
export function useHash(): ComputedRef<string>
export function useMeta(): ComputedRef<RouteMeta>
export function useMatched(): ComputedRef<RouteRecordNormalized[]>

// 守卫钩子
export function onBeforeRouteUpdate(guard: NavigationGuard): void
export function onBeforeRouteLeave(guard: NavigationGuard): void
```

## 插件系统架构

### 插件接口

```typescript
interface RouterPlugin {
  install(app: App): void
}
```

### 内置插件

#### 1. 性能监控插件

**位置**: `src/plugins/performance-plugin.ts`

**功能**:

- 导航时间监控
- 组件加载时间监控
- 路由预加载
- 性能数据收集

**架构**:

```typescript
class RouterPerformancePlugin {
  private config: PerformanceConfig
  private router: Router

  // 监控导航性能
  private setupNavigationTracking(): void

  // 设置预加载
  private setupPreloading(): void

  // 预加载策略
  private preloadRoute(href: string): Promise<void>
}
```

#### 2. 缓存插件

**位置**: `src/plugins/cache-plugin.ts`

**功能**:

- 多种缓存策略
- 缓存生命周期管理
- 缓存统计

**架构**:

```typescript
class RouterCachePlugin {
  private storage: CacheStorage
  private config: CacheConfig

  // 缓存操作
  get(route: RouteLocationNormalized): unknown | null
  set(route: RouteLocationNormalized, data: unknown, ttl?: number): void
  delete(route: RouteLocationNormalized): boolean
  clear(): void
}
```

#### 3. 增强组件插件

**位置**: `src/plugins/enhanced-components-plugin.ts`

**功能**:

- 权限控制
- 事件追踪
- 确认对话框
- 布局解析

## 组件架构

### RouterLink 增强

**位置**: `src/components/RouterLink.ts`

**增强功能**:

- 预加载支持
- 权限控制
- 事件追踪
- 自定义样式
- 加载状态

**核心逻辑**:

```typescript
export default defineComponent({
  name: 'RouterLink',
  props: {
    // 基础属性
    to: { type: [String, Object] as PropType<RouteLocationRaw>, required: true },

    // 增强属性
    preload: { type: String as PropType<PreloadStrategy>, default: 'none' },
    permission: { type: [String, Array] as PropType<string | string[]> },
    variant: { type: String as PropType<LinkVariant>, default: 'default' },
    trackEvent: String,
    confirmMessage: String,
  },

  setup(props, { slots }) {
    // 权限检查
    const hasPermission = computed(() => checkPermission(props.permission))

    // 预加载逻辑
    const handlePreload = () => preloadRoute(props.to)

    // 导航逻辑
    const navigate = (e: Event) => {
      if (props.confirmMessage && !confirm(props.confirmMessage)) {
        e.preventDefault()
        return
      }

      if (props.trackEvent) {
        trackEvent(props.trackEvent, { to: props.to })
      }

      router.push(props.to)
    }

    return { hasPermission, handlePreload, navigate }
  },
})
```

### RouterView 增强

**位置**: `src/components/RouterView.ts`

**增强功能**:

- 过渡动画
- 错误边界
- 加载状态
- 缓存支持

## 数据流架构

### 路由状态管理

```
用户操作 → 路由器 → 匹配器 → 守卫系统 → 组件更新
    ↓         ↓        ↓         ↓         ↓
  事件追踪   性能监控   缓存检查   权限验证   状态同步
```

### 插件数据流

```
路由变化 → 插件监听 → 数据处理 → 副作用执行 → 状态更新
```

## 性能优化策略

### 1. 路由匹配优化

- 路径映射表缓存
- 正则表达式复用
- 匹配结果缓存

### 2. 组件加载优化

- 智能预加载
- 组件缓存
- 懒加载支持

### 3. 内存管理

- 弱引用使用
- 定时清理机制
- 内存泄漏防护

## 扩展性设计

### 1. 插件系统

- 标准化插件接口
- 生命周期钩子
- 配置管理

### 2. 组件扩展

- 插槽系统
- 属性继承
- 事件系统

### 3. API 扩展

- 组合式 API 模式
- 类型安全保证
- 向后兼容

## 总结

@ldesign/router 的架构设计遵循以下原则：

1. **分层解耦**: 清晰的分层架构，职责分离
2. **插件化**: 核心功能插件化，按需加载
3. **类型安全**: TypeScript 优先，完整类型定义
4. **性能优先**: 多层级优化，智能缓存
5. **扩展性**: 良好的扩展接口，支持自定义

这种架构设计确保了系统的可维护性、可扩展性和高性能，为构建复杂的 Vue 应用提供了坚实的基础。

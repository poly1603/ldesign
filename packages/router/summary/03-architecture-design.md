# æ¶æ„è®¾è®¡

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    @ldesign/router                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº”ç”¨å±‚ (Application Layer)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Vue App   â”‚  â”‚  Component  â”‚  â”‚   Plugin    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç»„ä»¶å±‚ (Component Layer)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ RouterView  â”‚  â”‚ RouterLink  â”‚  â”‚ RouteGuard  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  APIå±‚ (API Layer)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  useRouter  â”‚  â”‚  useRoute   â”‚  â”‚ useNavigationâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ’ä»¶å±‚ (Plugin Layer)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Animation   â”‚  â”‚    Cache    â”‚  â”‚  Preload    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒå±‚ (Core Layer)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Router    â”‚  â”‚   Matcher   â”‚  â”‚   History   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·¥å…·å±‚ (Utils Layer)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚    Path     â”‚  â”‚    Query    â”‚  â”‚   Events    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ¨¡å—è®¾è®¡

### æ ¸å¿ƒæ¨¡å— (Core)

#### 1. Router æ¨¡å—

```typescript
// è·¯ç”±å™¨æ ¸å¿ƒå®ç°
class RouterImpl implements Router {
  private matcher: RouteMatcher
  private history: RouterHistory
  private currentRoute: Ref<RouteLocationNormalized>
  private plugins: Map<string, RouterPlugin>

  // æ ¸å¿ƒæ–¹æ³•
  push(to: RouteLocationRaw): Promise<NavigationFailure | void>
  replace(to: RouteLocationRaw): Promise<NavigationFailure | void>
  resolve(to: RouteLocationRaw): RouteLocation
  addRoute(route: RouteRecordRaw): () => void
  removeRoute(name: string | symbol): void
}
```

#### 2. Matcher æ¨¡å—

```typescript
// åŸºäº Trie æ ‘çš„è·¯ç”±åŒ¹é…å™¨
class TrieRouteMatcher implements RouteMatcher {
  private root: TrieNode = new TrieNode()
  private nameMap: Map<string, RouteRecordNormalized> = new Map()

  // é«˜æ•ˆè·¯ç”±åŒ¹é…
  match(path: string): RouteMatch | null
  resolve(location: RouteLocationRaw): RouteLocation
  addRoute(record: RouteRecordRaw): RouteRecordNormalized

  // åµŒå¥—è·¯ç”±æ”¯æŒ
  private matchSegments(
    node: TrieNode,
    segments: string[],
    index: number,
    params: RouteParams,
    matchedSegments: string[],
    matchedRecords: RouteRecordNormalized[]
  ): MatchResult | null
}
```

#### 3. History æ¨¡å—

```typescript
// å†å²è®°å½•ç®¡ç†
abstract class RouterHistory {
  abstract push(to: HistoryLocation): void
  abstract replace(to: HistoryLocation): void
  abstract go(delta: number): void
  abstract listen(callback: NavigationCallback): () => void
}

// å…·ä½“å®ç°
class WebHistory extends RouterHistory {
  /* ... */
}
class HashHistory extends RouterHistory {
  /* ... */
}
class MemoryHistory extends RouterHistory {
  /* ... */
}
```

### ç»„ä»¶æ¨¡å— (Components)

#### 1. RouterView ç»„ä»¶

```typescript
// è·¯ç”±è§†å›¾ç»„ä»¶
export const RouterView = defineComponent({
  name: 'RouterView',
  props: {
    // åŠ¨ç”»é…ç½®
    animation: String as PropType<AnimationType>,
    // ç¼“å­˜é…ç½®
    keepAlive: Boolean,
    maxCache: Number,
    // é”™è¯¯å¤„ç†
    errorComponent: Object as PropType<Component>,
    loadingComponent: Object as PropType<Component>,
  },
  setup(props, { slots }) {
    // ç»„ä»¶å®ç°
  },
})
```

#### 2. RouterLink ç»„ä»¶

```typescript
// è·¯ç”±é“¾æ¥ç»„ä»¶
export const RouterLink = defineComponent({
  name: 'RouterLink',
  props: {
    to: [String, Object] as PropType<RouteLocationRaw>,
    // é¢„åŠ è½½é…ç½®
    preload: String as PropType<PreloadStrategy>,
    // æ ·å¼é…ç½®
    activeClass: String,
    exactActiveClass: String,
    // æƒé™é…ç½®
    permission: String,
    // ç¡®è®¤é…ç½®
    confirm: [Boolean, String, Function],
  },
  setup(props, { slots }) {
    // ç»„ä»¶å®ç°
  },
})
```

### æ’ä»¶æ¨¡å— (Plugins)

#### 1. åŠ¨ç”»æ’ä»¶

```typescript
// è·¯ç”±åŠ¨ç”»æ’ä»¶
export function createAnimationPlugin(options: AnimationOptions): RouterPlugin {
  return {
    name: 'animation',
    install(router) {
      // æ³¨å†ŒåŠ¨ç”»å¤„ç†å™¨
      router.beforeEach((to, from, next) => {
        const animation = to.meta.animation || options.default
        if (animation) {
          this.setupAnimation(animation, to, from)
        }
        next()
      })
    },
  }
}
```

#### 2. ç¼“å­˜æ’ä»¶

```typescript
// è·¯ç”±ç¼“å­˜æ’ä»¶
export function createCachePlugin(options: CacheOptions): RouterPlugin {
  return {
    name: 'cache',
    install(router) {
      const cache = new RouteCache(options)

      // æä¾›ç¼“å­˜ API
      router.provide('routeCache', cache)

      // è‡ªåŠ¨ç¼“å­˜å¤„ç†
      router.afterEach((to, from) => {
        if (this.shouldCache(to)) {
          cache.set(to.fullPath, to.matched[0].components)
        }
      })
    },
  }
}
```

#### 3. é¢„åŠ è½½æ’ä»¶

```typescript
// ç»„ä»¶é¢„åŠ è½½æ’ä»¶
export function createPreloadPlugin(options: PreloadOptions): RouterPlugin {
  return {
    name: 'preload',
    install(router) {
      const preloader = new ComponentPreloader(options)

      // æ³¨å†Œé¢„åŠ è½½ç­–ç•¥
      router.provide('preloader', preloader)

      // è‡ªåŠ¨é¢„åŠ è½½
      if (options.auto) {
        this.setupAutoPreload(router, preloader)
      }
    },
  }
}
```

## ğŸ”„ æ•°æ®æµè®¾è®¡

### å¯¼èˆªæµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è§¦å‘å¯¼èˆª] --> B[è·¯ç”±è§£æ]
    B --> C[æ‰§è¡Œå‰ç½®å®ˆå«]
    C --> D{å®ˆå«é€šè¿‡?}
    D -->|å¦| E[å–æ¶ˆå¯¼èˆª]
    D -->|æ˜¯| F[ç»„ä»¶è§£æ]
    F --> G[æ‰§è¡Œç»„ä»¶å®ˆå«]
    G --> H{å®ˆå«é€šè¿‡?}
    H -->|å¦| E
    H -->|æ˜¯| I[æ‰§è¡Œè§£æå®ˆå«]
    I --> J[ç¡®è®¤å¯¼èˆª]
    J --> K[æ›´æ–°è·¯ç”±çŠ¶æ€]
    K --> L[æ¸²æŸ“æ–°ç»„ä»¶]
    L --> M[æ‰§è¡Œåç½®é’©å­]
    M --> N[å¯¼èˆªå®Œæˆ]
```

### çŠ¶æ€ç®¡ç†

```typescript
// è·¯ç”±çŠ¶æ€ç®¡ç†
class RouteState {
  // å½“å‰è·¯ç”±
  current: Ref<RouteLocationNormalized>

  // å†å²è®°å½•
  history: RouteLocationNormalized[]

  // å¯¼èˆªçŠ¶æ€
  pending: Ref<RouteLocationNormalized | null>

  // é”™è¯¯çŠ¶æ€
  error: Ref<NavigationFailure | null>

  // æ›´æ–°çŠ¶æ€
  updateRoute(route: RouteLocationNormalized): void
  setPending(route: RouteLocationNormalized | null): void
  setError(error: NavigationFailure | null): void
}
```

## ğŸ”Œ æ’ä»¶ç³»ç»Ÿè®¾è®¡

### æ’ä»¶æ¥å£

```typescript
// æ’ä»¶åŸºç¡€æ¥å£
interface RouterPlugin {
  name: string
  version?: string
  dependencies?: string[]

  install: (router: Router, options?: any) => void
  uninstall?: (router: Router) => void
}

// æ’ä»¶ç®¡ç†å™¨
class PluginManager {
  private plugins: Map<string, RouterPlugin> = new Map()

  register(plugin: RouterPlugin): void
  unregister(name: string): void
  get(name: string): RouterPlugin | undefined
  has(name: string): boolean
}
```

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

```typescript
// æ’ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­
interface PluginHooks {
  beforeInstall?: (router: Router, options: any) => void
  afterInstall?: (router: Router, options: any) => void
  beforeUninstall?: (router: Router) => void
  afterUninstall?: (router: Router) => void
}
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. è·¯ç”±åŒ¹é…ä¼˜åŒ–

```typescript
// Trie æ ‘èŠ‚ç‚¹
class TrieNode {
  children: Map<string, TrieNode> = new Map()
  paramChild: TrieNode | null = null
  wildcardChild: TrieNode | null = null
  route: RouteRecordNormalized | null = null

  // O(m) æ—¶é—´å¤æ‚åº¦åŒ¹é…
  match(segments: string[], index: number): RouteMatch | null {
    if (index === segments.length) {
      return this.route ? { route: this.route, params: {} } : null
    }

    const segment = segments[index]

    // ç²¾ç¡®åŒ¹é…
    const exactChild = this.children.get(segment)
    if (exactChild) {
      const result = exactChild.match(segments, index + 1)
      if (result) return result
    }

    // å‚æ•°åŒ¹é…
    if (this.paramChild) {
      const result = this.paramChild.match(segments, index + 1)
      if (result) {
        result.params[this.paramChild.paramName] = segment
        return result
      }
    }

    // é€šé…ç¬¦åŒ¹é…
    if (this.wildcardChild) {
      return this.wildcardChild.match(segments, segments.length)
    }

    return null
  }
}
```

### 2. ç»„ä»¶ç¼“å­˜ä¼˜åŒ–

```typescript
// LRU ç¼“å­˜å®ç°
class LRUCache<K, V> {
  private capacity: number
  private cache: Map<K, V> = new Map()

  get(key: K): V | undefined {
    if (this.cache.has(key)) {
      // ç§»åˆ°æœ€å‰é¢
      const value = this.cache.get(key)!
      this.cache.delete(key)
      this.cache.set(key, value)
      return value
    }
    return undefined
  }

  set(key: K, value: V): void {
    if (this.cache.has(key)) {
      this.cache.delete(key)
    } else if (this.cache.size >= this.capacity) {
      // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„é¡¹
      const firstKey = this.cache.keys().next().value
      this.cache.delete(firstKey)
    }
    this.cache.set(key, value)
  }
}
```

### 3. é¢„åŠ è½½ä¼˜åŒ–

```typescript
// æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥
class IntelligentPreloader {
  private loadingQueue: Set<string> = new Set()
  private loadedCache: Set<string> = new Set()

  async preload(route: RouteLocationRaw): Promise<void> {
    const path = this.normalizePath(route)

    // é¿å…é‡å¤åŠ è½½
    if (this.loadingQueue.has(path) || this.loadedCache.has(path)) {
      return
    }

    this.loadingQueue.add(path)

    try {
      // é¢„åŠ è½½ç»„ä»¶
      await this.preloadComponent(route)

      // é¢„åŠ è½½æ•°æ®
      if (this.shouldPreloadData(route)) {
        await this.preloadData(route)
      }

      this.loadedCache.add(path)
    } finally {
      this.loadingQueue.delete(path)
    }
  }
}
```

## ğŸ”’ ç±»å‹å®‰å…¨è®¾è®¡

### è·¯å¾„ç±»å‹æ¨å¯¼

```typescript
// è·¯å¾„å‚æ•°ç±»å‹æå–
type ExtractParams<T extends string> = T extends `${infer _}:${infer Param}/${infer Rest}`
  ? { [K in Param]: string } & ExtractParams<Rest>
  : T extends `${infer _}:${infer Param}`
  ? { [K in Param]: string }
  : {}

// è·¯ç”±è®°å½•ç±»å‹
interface TypedRouteRecord<T extends string = string> {
  path: T
  name?: string
  component?: Component
  meta?: RouteMeta
  params?: ExtractParams<T>
}

// ç±»å‹å®‰å…¨çš„è·¯ç”±ä½¿ç”¨
function useTypedRoute<T extends string>(): {
  params: Ref<ExtractParams<T>>
  query: Ref<Record<string, string>>
  meta: Ref<RouteMeta>
} {
  const route = useRoute()
  return {
    params: computed(() => route.params as ExtractParams<T>),
    query: computed(() => route.query),
    meta: computed(() => route.meta),
  }
}
```

## ğŸ§ª æµ‹è¯•æ¶æ„

### æµ‹è¯•åˆ†å±‚

```
æµ‹è¯•é‡‘å­—å¡”
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  E2E Tests  â”‚  â† Playwright
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Integration â”‚  â† Vitest + Vue Test Utils
    â”‚    Tests    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Unit Tests  â”‚  â† Vitest
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµ‹è¯•å·¥å…·é…ç½®

```typescript
// Vitest é…ç½®
export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: ['./test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      threshold: {
        global: {
          branches: 90,
          functions: 90,
          lines: 90,
          statements: 90,
        },
      },
    },
  },
})
```

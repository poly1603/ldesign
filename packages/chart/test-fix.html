<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图表修复测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .test-section h2 {
      margin-top: 0;
      color: #722ED1;
      border-bottom: 2px solid #722ED1;
      padding-bottom: 10px;
    }
    
    .chart-container {
      height: 400px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin: 20px 0;
      background: #fafafa;
    }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
    }
    
    .status.success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }
    
    .status.error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #ff4d4f;
    }
    
    .status.loading {
      background: #e6f7ff;
      border: 1px solid #91d5ff;
      color: #1890ff;
    }
    
    .controls {
      margin: 20px 0;
    }
    
    .controls button {
      background: #722ED1;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    
    .controls button:hover {
      background: #5e2aa7;
    }
    
    .log {
      background: #f8f8f8;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>@ldesign/chart 图表修复测试</h1>
    
    <div class="test-section">
      <h2>测试 1: 基础折线图 - 自动渲染</h2>
      <div class="status loading" id="status1">正在初始化图表...</div>
      <div class="chart-container" id="chart1"></div>
      <div class="controls">
        <button onclick="recreateChart1()">重新创建图表</button>
        <button onclick="resizeChart1()">手动调整大小</button>
      </div>
    </div>
    
    <div class="test-section">
      <h2>测试 2: 柱状图 - 延迟容器</h2>
      <div class="status loading" id="status2">正在初始化图表...</div>
      <div class="chart-container" id="chart2" style="display: none;"></div>
      <div class="controls">
        <button onclick="showChart2()">显示图表容器</button>
        <button onclick="hideChart2()">隐藏图表容器</button>
      </div>
    </div>
    
    <div class="test-section">
      <h2>测试 3: 饼图 - 动态尺寸</h2>
      <div class="status loading" id="status3">正在初始化图表...</div>
      <div class="chart-container" id="chart3" style="width: 0; height: 0;"></div>
      <div class="controls">
        <button onclick="expandChart3()">展开图表</button>
        <button onclick="shrinkChart3()">收缩图表</button>
      </div>
    </div>
    
    <div class="test-section">
      <h2>控制台日志</h2>
      <div class="log" id="console-log"></div>
      <div class="controls">
        <button onclick="clearLog()">清空日志</button>
      </div>
    </div>
  </div>

  <!-- 引入 ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

  <!-- 使用 ES 模块版本 -->
  <script type="module">
    // 直接使用原生 ECharts 创建一个简化的 Chart 类来测试修复效果
    class TestChart {
      constructor(container, config) {
        this.container = typeof container === 'string' ? document.getElementById(container) : container;
        this.config = config;
        this.echarts = null;
        this.disposed = false;

        this.init();
      }

      init() {
        // 设置容器样式
        this.setupContainer();

        // 延迟初始化以确保容器尺寸正确
        this.delayedInit();
      }

      setupContainer() {
        this.container.classList.add('ldesign-chart-container');

        if (this.config.responsive) {
          this.container.classList.add('ldesign-chart-responsive');
        }

        this.updateContainerSize();
      }

      updateContainerSize() {
        const { size } = this.config;
        if (!size) return;

        if (size.width !== undefined) {
          this.container.style.width = typeof size.width === 'number'
            ? `${size.width}px`
            : size.width;
        }

        if (size.height !== undefined) {
          this.container.style.height = typeof size.height === 'number'
            ? `${size.height}px`
            : size.height;
        }
      }

      delayedInit() {
        // 使用 requestAnimationFrame 确保 DOM 渲染完成
        requestAnimationFrame(() => {
          // 检查容器是否有有效尺寸
          if (this.hasValidContainerSize()) {
            this.initEChartsAndRender();
          } else {
            // 如果容器尺寸无效，使用 ResizeObserver 或定时器等待
            this.waitForValidSize();
          }
        });
      }

      hasValidContainerSize() {
        const rect = this.container.getBoundingClientRect();
        const hasSize = rect.width > 0 && rect.height > 0;

        // 如果没有尺寸，检查是否有 CSS 样式设置的尺寸
        if (!hasSize) {
          const computedStyle = window.getComputedStyle(this.container);
          const cssWidth = parseFloat(computedStyle.width);
          const cssHeight = parseFloat(computedStyle.height);
          return cssWidth > 0 && cssHeight > 0;
        }

        return hasSize;
      }

      waitForValidSize() {
        let attempts = 0;
        const maxAttempts = 50; // 最多等待 5 秒（50 * 100ms）

        const checkSize = () => {
          attempts++;

          if (this.hasValidContainerSize()) {
            this.initEChartsAndRender();
          } else if (attempts < maxAttempts) {
            setTimeout(checkSize, 100);
          } else {
            // 超时后强制初始化，使用默认尺寸
            console.warn('图表容器尺寸检测超时，使用默认尺寸初始化');
            this.forceInitWithDefaultSize();
          }
        };

        // 如果支持 ResizeObserver，优先使用
        if (typeof ResizeObserver !== 'undefined') {
          const observer = new ResizeObserver((entries) => {
            for (const entry of entries) {
              if (entry.contentRect.width > 0 && entry.contentRect.height > 0) {
                observer.disconnect();
                this.initEChartsAndRender();
                return;
              }
            }
          });

          observer.observe(this.container);

          // 设置超时保护
          setTimeout(() => {
            observer.disconnect();
            if (!this.echarts) {
              this.forceInitWithDefaultSize();
            }
          }, 5000);
        } else {
          // 降级到定时器检查
          checkSize();
        }
      }

      forceInitWithDefaultSize() {
        // 设置默认尺寸
        if (!this.container.style.width) {
          this.container.style.width = '100%';
        }
        if (!this.container.style.height) {
          this.container.style.height = '400px';
        }

        this.initEChartsAndRender();
      }

      initEChartsAndRender() {
        this.initECharts();
        this.render();
      }

      initECharts() {
        try {
          // 确保容器有有效尺寸
          this.ensureContainerSize();

          // 初始化 ECharts 实例
          this.echarts = echarts.init(this.container, null, {
            width: this.container.offsetWidth || undefined,
            height: this.container.offsetHeight || undefined,
            renderer: 'canvas',
            useDirtyRect: true,
          });

          // 添加错误处理
          this.echarts.on('error', (error) => {
            console.error('ECharts 渲染错误:', error);
          });

        } catch (error) {
          console.error('ECharts 初始化失败:', error);
          throw new Error('ECharts 未找到，请确保已正确安装');
        }
      }

      ensureContainerSize() {
        const rect = this.container.getBoundingClientRect();

        // 如果容器没有尺寸，尝试设置默认尺寸
        if (rect.width === 0 || rect.height === 0) {
          const computedStyle = window.getComputedStyle(this.container);

          // 检查是否有 CSS 设置的尺寸
          if (computedStyle.width === '0px' || computedStyle.width === 'auto') {
            this.container.style.width = this.config.size?.width
              ? (typeof this.config.size.width === 'number'
                  ? `${this.config.size.width}px`
                  : this.config.size.width)
              : '100%';
          }

          if (computedStyle.height === '0px' || computedStyle.height === 'auto') {
            this.container.style.height = this.config.size?.height
              ? (typeof this.config.size.height === 'number'
                  ? `${this.config.size.height}px`
                  : this.config.size.height)
              : '400px';
          }
        }
      }

      render() {
        if (!this.echarts) {
          console.warn('ECharts 实例未初始化，无法渲染图表');
          return;
        }

        try {
          // 检查容器是否仍然有效
          if (!this.container.isConnected) {
            console.warn('图表容器已从 DOM 中移除，停止渲染');
            return;
          }

          // 构建 ECharts 配置
          const option = this.buildOption();

          // 设置图表选项
          this.echarts.setOption(option, true);

          // 确保图表正确渲染
          this.ensureChartRendered();

        } catch (error) {
          console.error('图表渲染失败:', error);
          this.handleRenderError(error);
        }
      }

      buildOption() {
        const { type, data, title } = this.config;

        const option = {
          title: {
            text: title,
            left: 'center',
            textStyle: { fontSize: 16 }
          },
          tooltip: {
            trigger: type === 'pie' ? 'item' : 'axis'
          },
          series: []
        };

        if (type === 'line') {
          option.xAxis = {
            type: 'category',
            data: data.map(item => item.name)
          };
          option.yAxis = {
            type: 'value'
          };
          option.series = [{
            data: data.map(item => item.value),
            type: 'line',
            lineStyle: { color: '#722ED1' },
            itemStyle: { color: '#722ED1' }
          }];
        } else if (type === 'bar') {
          option.xAxis = {
            type: 'category',
            data: data.map(item => item.name)
          };
          option.yAxis = {
            type: 'value'
          };
          option.series = [{
            data: data.map(item => item.value),
            type: 'bar',
            itemStyle: { color: '#722ED1' }
          }];
        } else if (type === 'pie') {
          option.series = [{
            data: data.map(item => ({ name: item.name, value: item.value })),
            type: 'pie',
            radius: '70%',
            center: ['50%', '50%']
          }];
        }

        return option;
      }

      ensureChartRendered() {
        if (!this.echarts) return;

        // 使用 requestAnimationFrame 确保渲染完成后再检查
        requestAnimationFrame(() => {
          try {
            // 检查图表是否需要 resize
            const containerRect = this.container.getBoundingClientRect();
            const echartsSize = this.echarts.getWidth && this.echarts.getHeight
              ? { width: this.echarts.getWidth(), height: this.echarts.getHeight() }
              : null;

            if (echartsSize &&
                (Math.abs(containerRect.width - echartsSize.width) > 1 ||
                 Math.abs(containerRect.height - echartsSize.height) > 1)) {
              this.echarts.resize();
            }
          } catch (error) {
            console.warn('图表渲染后检查失败:', error);
          }
        });
      }

      handleRenderError(error) {
        // 如果是尺寸相关的错误，尝试重新调整尺寸后重试
        if (error.message && (error.message.includes('width') || error.message.includes('height'))) {
          console.log('检测到尺寸相关错误，尝试重新调整尺寸...');

          setTimeout(() => {
            try {
              this.ensureContainerSize();
              if (this.echarts) {
                this.echarts.resize();
              }
            } catch (retryError) {
              console.error('重试渲染失败:', retryError);
            }
          }, 100);
        } else {
          // 其他错误直接抛出
          throw error;
        }
      }

      resize(size) {
        if (this.disposed) return;

        if (size) {
          this.config.size = { ...this.config.size, ...size };
          this.updateContainerSize();
        }

        if (!this.echarts) {
          console.warn('ECharts 实例未初始化，无法调整大小');
          return;
        }

        try {
          // 确保容器有有效尺寸
          this.ensureContainerSize();

          // 获取当前容器尺寸
          const containerRect = this.container.getBoundingClientRect();

          // 如果容器有有效尺寸，则调整图表大小
          if (containerRect.width > 0 && containerRect.height > 0) {
            this.echarts.resize({
              width: containerRect.width,
              height: containerRect.height
            });
          } else {
            // 如果容器尺寸无效，使用默认尺寸
            this.echarts.resize();
          }
        } catch (error) {
          console.error('调整图表大小失败:', error);
          // 降级到简单的 resize
          try {
            this.echarts.resize();
          } catch (fallbackError) {
            console.error('降级 resize 也失败:', fallbackError);
          }
        }
      }

      dispose() {
        if (this.disposed) return;

        if (this.echarts) {
          this.echarts.dispose();
          this.echarts = null;
        }

        this.container.classList.remove('ldesign-chart-container', 'ldesign-chart-responsive');
        this.disposed = true;
      }
    }

    // 将 TestChart 暴露到全局
    window.LDesignChart = { Chart: TestChart };
  </script>
  
  <script>
    // 日志系统
    const originalConsole = {
      log: console.log,
      warn: console.warn,
      error: console.error
    };
    
    function addLog(type, ...args) {
      const logElement = document.getElementById('console-log');
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      
      logElement.textContent += `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      
      // 调用原始的 console 方法
      originalConsole[type](...args);
    }
    
    console.log = (...args) => addLog('log', ...args);
    console.warn = (...args) => addLog('warn', ...args);
    console.error = (...args) => addLog('error', ...args);
    
    function clearLog() {
      document.getElementById('console-log').textContent = '';
    }
    
    // 状态更新函数
    function updateStatus(id, type, message) {
      const statusEl = document.getElementById(id);
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
    }
    
    // 图表实例
    let chart1, chart2, chart3;
    
    // 测试数据
    const lineData = [
      { name: '1月', value: 120 },
      { name: '2月', value: 200 },
      { name: '3月', value: 150 },
      { name: '4月', value: 300 },
      { name: '5月', value: 250 },
      { name: '6月', value: 400 }
    ];
    
    const barData = [
      { name: '产品A', value: 320 },
      { name: '产品B', value: 280 },
      { name: '产品C', value: 220 },
      { name: '产品D', value: 180 }
    ];
    
    const pieData = [
      { name: '直接访问', value: 335 },
      { name: '邮件营销', value: 310 },
      { name: '联盟广告', value: 234 },
      { name: '视频广告', value: 135 },
      { name: '搜索引擎', value: 1548 }
    ];
    
    // 测试 1: 基础折线图
    function createChart1() {
      try {
        updateStatus('status1', 'loading', '正在创建折线图...');
        console.log('开始创建测试图表 1');
        
        chart1 = new LDesignChart.Chart(document.getElementById('chart1'), {
          type: 'line',
          data: lineData,
          title: '月度销售趋势',
          theme: 'light',
          responsive: true
        });
        
        updateStatus('status1', 'success', '折线图创建成功！');
        console.log('测试图表 1 创建成功');
      } catch (error) {
        updateStatus('status1', 'error', `创建失败: ${error.message}`);
        console.error('测试图表 1 创建失败:', error);
      }
    }
    
    function recreateChart1() {
      if (chart1) {
        chart1.dispose();
      }
      createChart1();
    }
    
    function resizeChart1() {
      if (chart1) {
        chart1.resize();
        console.log('手动调整图表 1 大小');
      }
    }
    
    // 测试 2: 延迟显示的柱状图
    function createChart2() {
      try {
        updateStatus('status2', 'loading', '正在创建柱状图...');
        console.log('开始创建测试图表 2');
        
        chart2 = new LDesignChart.Chart(document.getElementById('chart2'), {
          type: 'bar',
          data: barData,
          title: '产品销量对比',
          theme: 'light',
          responsive: true
        });
        
        updateStatus('status2', 'success', '柱状图创建成功！');
        console.log('测试图表 2 创建成功');
      } catch (error) {
        updateStatus('status2', 'error', `创建失败: ${error.message}`);
        console.error('测试图表 2 创建失败:', error);
      }
    }
    
    function showChart2() {
      const container = document.getElementById('chart2');
      container.style.display = 'block';
      console.log('显示图表 2 容器');
      
      if (!chart2) {
        setTimeout(createChart2, 100);
      } else {
        chart2.resize();
      }
    }
    
    function hideChart2() {
      const container = document.getElementById('chart2');
      container.style.display = 'none';
      console.log('隐藏图表 2 容器');
    }
    
    // 测试 3: 动态尺寸的饼图
    function createChart3() {
      try {
        updateStatus('status3', 'loading', '正在创建饼图...');
        console.log('开始创建测试图表 3');
        
        chart3 = new LDesignChart.Chart(document.getElementById('chart3'), {
          type: 'pie',
          data: pieData,
          title: '访问来源分布',
          theme: 'light',
          responsive: true
        });
        
        updateStatus('status3', 'success', '饼图创建成功！');
        console.log('测试图表 3 创建成功');
      } catch (error) {
        updateStatus('status3', 'error', `创建失败: ${error.message}`);
        console.error('测试图表 3 创建失败:', error);
      }
    }
    
    function expandChart3() {
      const container = document.getElementById('chart3');
      container.style.width = '100%';
      container.style.height = '400px';
      console.log('展开图表 3 容器');
      
      if (!chart3) {
        setTimeout(createChart3, 100);
      } else {
        setTimeout(() => chart3.resize(), 100);
      }
    }
    
    function shrinkChart3() {
      const container = document.getElementById('chart3');
      container.style.width = '0';
      container.style.height = '0';
      console.log('收缩图表 3 容器');
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('页面加载完成，开始初始化测试');
      
      // 检查库是否正确加载
      if (typeof LDesignChart === 'undefined') {
        console.error('LDesignChart 库未正确加载');
        updateStatus('status1', 'error', 'LDesignChart 库未正确加载');
        updateStatus('status2', 'error', 'LDesignChart 库未正确加载');
        updateStatus('status3', 'error', 'LDesignChart 库未正确加载');
        return;
      }
      
      console.log('LDesignChart 库加载成功:', LDesignChart);
      
      // 立即创建第一个图表
      createChart1();
      
      // 延迟创建第三个图表（容器尺寸为 0）
      createChart3();
    });
  </script>
</body>
</html>

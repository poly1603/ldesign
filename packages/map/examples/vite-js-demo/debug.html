<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地图调试页面</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    .debug-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .debug-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .debug-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .debug-result {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    #map-container {
      width: 100%;
      height: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="debug-container">
    <h1>🔍 地图功能调试</h1>
    
    <div class="debug-section">
      <div class="debug-title">1. 模块导入测试</div>
      <button onclick="testImports()">测试导入</button>
      <div id="import-result" class="debug-result" style="display: none;"></div>
    </div>

    <div class="debug-section">
      <div class="debug-title">2. 应用状态测试</div>
      <button onclick="testAppState()">测试应用状态</button>
      <div id="state-result" class="debug-result" style="display: none;"></div>
    </div>

    <div class="debug-section">
      <div class="debug-title">3. 地图管理器测试</div>
      <button onclick="testMapManager()">测试地图管理器</button>
      <div id="manager-result" class="debug-result" style="display: none;"></div>
    </div>

    <div class="debug-section">
      <div class="debug-title">4. 地图初始化测试</div>
      <button onclick="testMapInit()">初始化地图</button>
      <button onclick="clearMap()">清理地图</button>
      <div id="map-container"></div>
      <div id="init-result" class="debug-result" style="display: none;"></div>
    </div>
  </div>

  <script type="module">
    let currentApp = null;
    let currentMapInstance = null;

    // 显示结果
    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.className = `debug-result ${type}`;
      element.textContent = message;
    }

    // 测试模块导入
    window.testImports = async function() {
      try {
        console.log('🔍 开始测试模块导入...');
        
        // 测试地图管理器导入
        const mapManager = await import('./src/map/mapManager.js');
        console.log('✅ mapManager 导入成功:', Object.keys(mapManager));
        
        // 测试应用模块导入
        const appModule = await import('./src/app.js');
        console.log('✅ app 导入成功:', Object.keys(appModule));
        
        // 测试组件导入
        const headerModule = await import('./src/components/Header.js');
        const configModule = await import('./src/components/ConfigPanel.js');
        const rendererModule = await import('./src/components/MapRenderer.js');
        
        console.log('✅ 组件导入成功');
        
        showResult('import-result', 
          `✅ 所有模块导入成功！
mapManager: ${Object.keys(mapManager).join(', ')}
app: ${Object.keys(appModule).join(', ')}
components: Header, ConfigPanel, MapRenderer`, 'success');
        
      } catch (error) {
        console.error('❌ 模块导入失败:', error);
        showResult('import-result', `❌ 模块导入失败: ${error.message}\n${error.stack}`, 'error');
      }
    };

    // 测试应用状态
    window.testAppState = async function() {
      try {
        console.log('🔍 开始测试应用状态...');
        
        const { createApp } = await import('./src/app.js');
        currentApp = createApp();
        
        const state = currentApp.getState();
        console.log('✅ 应用状态:', state);
        
        showResult('state-result', 
          `✅ 应用状态创建成功！
mapConfig: ${JSON.stringify(state.mapConfig, null, 2)}
appliedConfig: ${JSON.stringify(state.appliedConfig, null, 2)}
isFullscreen: ${state.isFullscreen}
sidebarCollapsed: ${state.sidebarCollapsed}`, 'success');
        
      } catch (error) {
        console.error('❌ 应用状态测试失败:', error);
        showResult('state-result', `❌ 应用状态测试失败: ${error.message}\n${error.stack}`, 'error');
      }
    };

    // 测试地图管理器
    window.testMapManager = async function() {
      try {
        console.log('🔍 开始测试地图管理器...');
        
        const { initializeMap, updateMapConfig, validateMapConfig, getDefaultMapConfig } = await import('./src/map/mapManager.js');
        
        // 测试默认配置
        const defaultConfig = getDefaultMapConfig();
        console.log('✅ 默认配置:', defaultConfig);
        
        // 测试配置验证
        const isValid = validateMapConfig(defaultConfig);
        console.log('✅ 配置验证:', isValid);
        
        showResult('manager-result', 
          `✅ 地图管理器测试成功！
函数可用: initializeMap, updateMapConfig, validateMapConfig, getDefaultMapConfig
默认配置: ${JSON.stringify(defaultConfig, null, 2)}
配置验证: ${isValid}`, 'success');
        
      } catch (error) {
        console.error('❌ 地图管理器测试失败:', error);
        showResult('manager-result', `❌ 地图管理器测试失败: ${error.message}\n${error.stack}`, 'error');
      }
    };

    // 测试地图初始化
    window.testMapInit = async function() {
      try {
        console.log('🔍 开始测试地图初始化...');
        
        if (!currentApp) {
          throw new Error('请先运行应用状态测试');
        }
        
        const { initializeMap } = await import('./src/map/mapManager.js');
        const container = document.getElementById('map-container');
        const state = currentApp.getState();
        
        console.log('🗺️ 使用配置:', state.appliedConfig);
        
        showResult('init-result', '⏳ 正在初始化地图...', 'info');
        
        currentMapInstance = await initializeMap(container, state.appliedConfig);
        
        console.log('✅ 地图初始化成功:', currentMapInstance);
        
        showResult('init-result', 
          `✅ 地图初始化成功！
实例ID: ${currentMapInstance.id}
配置: ${JSON.stringify(currentMapInstance.config, null, 2)}`, 'success');
        
      } catch (error) {
        console.error('❌ 地图初始化失败:', error);
        showResult('init-result', `❌ 地图初始化失败: ${error.message}\n${error.stack}`, 'error');
      }
    };

    // 清理地图
    window.clearMap = function() {
      const container = document.getElementById('map-container');
      container.innerHTML = '';
      currentMapInstance = null;
      showResult('init-result', '🧹 地图已清理', 'info');
    };

    // 页面加载完成后自动运行基础测试
    window.addEventListener('load', () => {
      console.log('🚀 调试页面加载完成');
    });
  </script>
</body>
</html>

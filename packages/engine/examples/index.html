<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDesign Engine ç¤ºä¾‹</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .demo-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
    }
    .demo-section h3 {
      margin-top: 0;
      color: #555;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ LDesign Engine ç¤ºä¾‹</h1>
    
    <div class="demo-section">
      <h3>å¼•æ“çŠ¶æ€</h3>
      <div id="engine-status" class="status">å¼•æ“æœªåˆå§‹åŒ–</div>
      <button onclick="initEngine()">åˆå§‹åŒ–å¼•æ“</button>
      <button onclick="startEngine()">å¯åŠ¨å¼•æ“</button>
      <button onclick="stopEngine()">åœæ­¢å¼•æ“</button>
      <button onclick="destroyEngine()">é”€æ¯å¼•æ“</button>
    </div>

    <div class="demo-section">
      <h3>æ’ä»¶ç®¡ç†</h3>
      <button onclick="installTestPlugin()">å®‰è£…æµ‹è¯•æ’ä»¶</button>
      <button onclick="uninstallTestPlugin()">å¸è½½æµ‹è¯•æ’ä»¶</button>
      <button onclick="listPlugins()">åˆ—å‡ºæ‰€æœ‰æ’ä»¶</button>
      <div id="plugins-info"></div>
    </div>

    <div class="demo-section">
      <h3>äº‹ä»¶ç³»ç»Ÿ</h3>
      <button onclick="emitTestEvent()">è§¦å‘æµ‹è¯•äº‹ä»¶</button>
      <button onclick="clearEventLog()">æ¸…ç©ºäº‹ä»¶æ—¥å¿—</button>
      <div id="event-log" class="log"></div>
    </div>

    <div class="demo-section">
      <h3>ç”Ÿå‘½å‘¨æœŸ</h3>
      <button onclick="addLifecycleHook()">æ·»åŠ ç”Ÿå‘½å‘¨æœŸé’©å­</button>
      <div id="lifecycle-info"></div>
    </div>
  </div>

  <script type="module">
    import { createEngine, createPlugin } from '../src/index.js'

    let engine = null
    let eventLogElement = document.getElementById('event-log')
    let statusElement = document.getElementById('engine-status')

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString()
      const logEntry = document.createElement('div')
      logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`
      eventLogElement.appendChild(logEntry)
      eventLogElement.scrollTop = eventLogElement.scrollHeight
      console.log(`[${timestamp}] ${message}`)
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(message, isError = false) {
      statusElement.textContent = message
      statusElement.className = `status ${isError ? 'error' : 'success'}`
    }

    // åˆå§‹åŒ–å¼•æ“
    window.initEngine = async function() {
      try {
        engine = createEngine({
          debug: true
        })
        
        // ç›‘å¬å¼•æ“äº‹ä»¶
        engine.eventBus.on('engine:before-start', () => {
          log('ğŸš€ å¼•æ“å‡†å¤‡å¯åŠ¨')
        })
        
        engine.eventBus.on('engine:started', () => {
          log('âœ… å¼•æ“å·²å¯åŠ¨')
          updateStatus('å¼•æ“è¿è¡Œä¸­')
        })
        
        engine.eventBus.on('engine:stopped', () => {
          log('â¹ï¸ å¼•æ“å·²åœæ­¢')
          updateStatus('å¼•æ“å·²åœæ­¢')
        })
        
        engine.eventBus.on('engine:destroyed', () => {
          log('ğŸ’¥ å¼•æ“å·²é”€æ¯')
          updateStatus('å¼•æ“å·²é”€æ¯')
        })
        
        engine.eventBus.on('plugin:installed', (plugin) => {
          log(`ğŸ”Œ æ’ä»¶å·²å®‰è£…: ${plugin.name}`)
        })
        
        engine.eventBus.on('plugin:uninstalled', (plugin) => {
          log(`ğŸ”Œ æ’ä»¶å·²å¸è½½: ${plugin.name}`)
        })
        
        updateStatus('å¼•æ“å·²åˆå§‹åŒ–')
        log('ğŸ‰ å¼•æ“åˆå§‹åŒ–å®Œæˆ')
      } catch (error) {
        updateStatus(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, true)
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`)
      }
    }

    // å¯åŠ¨å¼•æ“
    window.startEngine = async function() {
      if (!engine) {
        updateStatus('è¯·å…ˆåˆå§‹åŒ–å¼•æ“', true)
        return
      }
      
      try {
        await engine.start()
      } catch (error) {
        updateStatus(`å¯åŠ¨å¤±è´¥: ${error.message}`, true)
        log(`âŒ å¯åŠ¨å¤±è´¥: ${error.message}`)
      }
    }

    // åœæ­¢å¼•æ“
    window.stopEngine = async function() {
      if (!engine) {
        updateStatus('å¼•æ“æœªåˆå§‹åŒ–', true)
        return
      }
      
      try {
        await engine.stop()
      } catch (error) {
        updateStatus(`åœæ­¢å¤±è´¥: ${error.message}`, true)
        log(`âŒ åœæ­¢å¤±è´¥: ${error.message}`)
      }
    }

    // é”€æ¯å¼•æ“
    window.destroyEngine = async function() {
      if (!engine) {
        updateStatus('å¼•æ“æœªåˆå§‹åŒ–', true)
        return
      }
      
      try {
        await engine.destroy()
        engine = null
      } catch (error) {
        updateStatus(`é”€æ¯å¤±è´¥: ${error.message}`, true)
        log(`âŒ é”€æ¯å¤±è´¥: ${error.message}`)
      }
    }

    // å®‰è£…æµ‹è¯•æ’ä»¶
    window.installTestPlugin = async function() {
      if (!engine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“')
        return
      }
      
      const testPlugin = createPlugin(
        'test-plugin',
        '1.0.0',
        (engine, options) => {
          log(`ğŸ”Œ æµ‹è¯•æ’ä»¶å®‰è£…ä¸­... é€‰é¡¹: ${JSON.stringify(options)}`)
          
          // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
          engine.eventBus.on('test:event', (data) => {
            log(`ğŸ“¨ æ”¶åˆ°æµ‹è¯•äº‹ä»¶: ${JSON.stringify(data)}`)
          })
        },
        {
          description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ’ä»¶',
          uninstaller: (engine) => {
            log('ğŸ”Œ æµ‹è¯•æ’ä»¶å¸è½½ä¸­...')
          }
        }
      )
      
      try {
        await engine.use(testPlugin, { demo: true })
      } catch (error) {
        log(`âŒ æ’ä»¶å®‰è£…å¤±è´¥: ${error.message}`)
      }
    }

    // å¸è½½æµ‹è¯•æ’ä»¶
    window.uninstallTestPlugin = async function() {
      if (!engine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“')
        return
      }
      
      try {
        await engine.unuse('test-plugin')
      } catch (error) {
        log(`âŒ æ’ä»¶å¸è½½å¤±è´¥: ${error.message}`)
      }
    }

    // åˆ—å‡ºæ‰€æœ‰æ’ä»¶
    window.listPlugins = function() {
      if (!engine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“')
        return
      }
      
      const plugins = engine.getPlugins()
      const pluginsInfo = document.getElementById('plugins-info')
      
      if (plugins.length === 0) {
        pluginsInfo.innerHTML = '<p>æš‚æ— å·²å®‰è£…çš„æ’ä»¶</p>'
      } else {
        const pluginList = plugins.map(p => 
          `<li><strong>${p.name}</strong> v${p.version} - ${p.description || 'æ— æè¿°'}</li>`
        ).join('')
        pluginsInfo.innerHTML = `<ul>${pluginList}</ul>`
      }
      
      log(`ğŸ“‹ å½“å‰å·²å®‰è£… ${plugins.length} ä¸ªæ’ä»¶`)
    }

    // è§¦å‘æµ‹è¯•äº‹ä»¶
    window.emitTestEvent = function() {
      if (!engine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“')
        return
      }
      
      const testData = {
        timestamp: Date.now(),
        message: 'Hello from test event!',
        random: Math.random()
      }
      
      engine.eventBus.emit('test:event', testData)
      log(`ğŸ“¤ å·²è§¦å‘æµ‹è¯•äº‹ä»¶`)
    }

    // æ¸…ç©ºäº‹ä»¶æ—¥å¿—
    window.clearEventLog = function() {
      eventLogElement.innerHTML = ''
      log('ğŸ§¹ äº‹ä»¶æ—¥å¿—å·²æ¸…ç©º')
    }

    // æ·»åŠ ç”Ÿå‘½å‘¨æœŸé’©å­
    window.addLifecycleHook = function() {
      if (!engine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“')
        return
      }
      
      engine.lifecycle.hook('started', () => {
        log('ğŸ”„ ç”Ÿå‘½å‘¨æœŸé’©å­: å¼•æ“å·²å¯åŠ¨')
      })
      
      engine.lifecycle.hook('stopped', () => {
        log('ğŸ”„ ç”Ÿå‘½å‘¨æœŸé’©å­: å¼•æ“å·²åœæ­¢')
      })
      
      const lifecycleInfo = document.getElementById('lifecycle-info')
      lifecycleInfo.innerHTML = '<p style="color: green;">âœ… ç”Ÿå‘½å‘¨æœŸé’©å­å·²æ·»åŠ </p>'
      
      log('ğŸ”„ ç”Ÿå‘½å‘¨æœŸé’©å­å·²æ³¨å†Œ')
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    log('ğŸŒŸ LDesign Engine ç¤ºä¾‹é¡µé¢å·²åŠ è½½')
    log('ğŸ’¡ ç‚¹å‡»æŒ‰é’®å¼€å§‹ä½“éªŒå¼•æ“åŠŸèƒ½')
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDesign Engine 示例</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .demo-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
    }
    .demo-section h3 {
      margin-top: 0;
      color: #555;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🚀 LDesign Engine 示例</h1>
    
    <div class="demo-section">
      <h3>引擎状态</h3>
      <div id="engine-status" class="status">引擎未初始化</div>
      <button onclick="initEngine()">初始化引擎</button>
      <button onclick="startEngine()">启动引擎</button>
      <button onclick="stopEngine()">停止引擎</button>
      <button onclick="destroyEngine()">销毁引擎</button>
    </div>

    <div class="demo-section">
      <h3>插件管理</h3>
      <button onclick="installTestPlugin()">安装测试插件</button>
      <button onclick="uninstallTestPlugin()">卸载测试插件</button>
      <button onclick="listPlugins()">列出所有插件</button>
      <div id="plugins-info"></div>
    </div>

    <div class="demo-section">
      <h3>事件系统</h3>
      <button onclick="emitTestEvent()">触发测试事件</button>
      <button onclick="clearEventLog()">清空事件日志</button>
      <div id="event-log" class="log"></div>
    </div>

    <div class="demo-section">
      <h3>生命周期</h3>
      <button onclick="addLifecycleHook()">添加生命周期钩子</button>
      <div id="lifecycle-info"></div>
    </div>
  </div>

  <script type="module">
    import { createEngine, createPlugin } from '../src/index.js'

    let engine = null
    let eventLogElement = document.getElementById('event-log')
    let statusElement = document.getElementById('engine-status')

    // 日志函数
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString()
      const logEntry = document.createElement('div')
      logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`
      eventLogElement.appendChild(logEntry)
      eventLogElement.scrollTop = eventLogElement.scrollHeight
      console.log(`[${timestamp}] ${message}`)
    }

    // 更新状态
    function updateStatus(message, isError = false) {
      statusElement.textContent = message
      statusElement.className = `status ${isError ? 'error' : 'success'}`
    }

    // 初始化引擎
    window.initEngine = async function() {
      try {
        engine = createEngine({
          debug: true
        })
        
        // 监听引擎事件
        engine.eventBus.on('engine:before-start', () => {
          log('🚀 引擎准备启动')
        })
        
        engine.eventBus.on('engine:started', () => {
          log('✅ 引擎已启动')
          updateStatus('引擎运行中')
        })
        
        engine.eventBus.on('engine:stopped', () => {
          log('⏹️ 引擎已停止')
          updateStatus('引擎已停止')
        })
        
        engine.eventBus.on('engine:destroyed', () => {
          log('💥 引擎已销毁')
          updateStatus('引擎已销毁')
        })
        
        engine.eventBus.on('plugin:installed', (plugin) => {
          log(`🔌 插件已安装: ${plugin.name}`)
        })
        
        engine.eventBus.on('plugin:uninstalled', (plugin) => {
          log(`🔌 插件已卸载: ${plugin.name}`)
        })
        
        updateStatus('引擎已初始化')
        log('🎉 引擎初始化完成')
      } catch (error) {
        updateStatus(`初始化失败: ${error.message}`, true)
        log(`❌ 初始化失败: ${error.message}`)
      }
    }

    // 启动引擎
    window.startEngine = async function() {
      if (!engine) {
        updateStatus('请先初始化引擎', true)
        return
      }
      
      try {
        await engine.start()
      } catch (error) {
        updateStatus(`启动失败: ${error.message}`, true)
        log(`❌ 启动失败: ${error.message}`)
      }
    }

    // 停止引擎
    window.stopEngine = async function() {
      if (!engine) {
        updateStatus('引擎未初始化', true)
        return
      }
      
      try {
        await engine.stop()
      } catch (error) {
        updateStatus(`停止失败: ${error.message}`, true)
        log(`❌ 停止失败: ${error.message}`)
      }
    }

    // 销毁引擎
    window.destroyEngine = async function() {
      if (!engine) {
        updateStatus('引擎未初始化', true)
        return
      }
      
      try {
        await engine.destroy()
        engine = null
      } catch (error) {
        updateStatus(`销毁失败: ${error.message}`, true)
        log(`❌ 销毁失败: ${error.message}`)
      }
    }

    // 安装测试插件
    window.installTestPlugin = async function() {
      if (!engine) {
        log('❌ 请先初始化引擎')
        return
      }
      
      const testPlugin = createPlugin(
        'test-plugin',
        '1.0.0',
        (engine, options) => {
          log(`🔌 测试插件安装中... 选项: ${JSON.stringify(options)}`)
          
          // 监听自定义事件
          engine.eventBus.on('test:event', (data) => {
            log(`📨 收到测试事件: ${JSON.stringify(data)}`)
          })
        },
        {
          description: '这是一个测试插件',
          uninstaller: (engine) => {
            log('🔌 测试插件卸载中...')
          }
        }
      )
      
      try {
        await engine.use(testPlugin, { demo: true })
      } catch (error) {
        log(`❌ 插件安装失败: ${error.message}`)
      }
    }

    // 卸载测试插件
    window.uninstallTestPlugin = async function() {
      if (!engine) {
        log('❌ 请先初始化引擎')
        return
      }
      
      try {
        await engine.unuse('test-plugin')
      } catch (error) {
        log(`❌ 插件卸载失败: ${error.message}`)
      }
    }

    // 列出所有插件
    window.listPlugins = function() {
      if (!engine) {
        log('❌ 请先初始化引擎')
        return
      }
      
      const plugins = engine.getPlugins()
      const pluginsInfo = document.getElementById('plugins-info')
      
      if (plugins.length === 0) {
        pluginsInfo.innerHTML = '<p>暂无已安装的插件</p>'
      } else {
        const pluginList = plugins.map(p => 
          `<li><strong>${p.name}</strong> v${p.version} - ${p.description || '无描述'}</li>`
        ).join('')
        pluginsInfo.innerHTML = `<ul>${pluginList}</ul>`
      }
      
      log(`📋 当前已安装 ${plugins.length} 个插件`)
    }

    // 触发测试事件
    window.emitTestEvent = function() {
      if (!engine) {
        log('❌ 请先初始化引擎')
        return
      }
      
      const testData = {
        timestamp: Date.now(),
        message: 'Hello from test event!',
        random: Math.random()
      }
      
      engine.eventBus.emit('test:event', testData)
      log(`📤 已触发测试事件`)
    }

    // 清空事件日志
    window.clearEventLog = function() {
      eventLogElement.innerHTML = ''
      log('🧹 事件日志已清空')
    }

    // 添加生命周期钩子
    window.addLifecycleHook = function() {
      if (!engine) {
        log('❌ 请先初始化引擎')
        return
      }
      
      engine.lifecycle.hook('started', () => {
        log('🔄 生命周期钩子: 引擎已启动')
      })
      
      engine.lifecycle.hook('stopped', () => {
        log('🔄 生命周期钩子: 引擎已停止')
      })
      
      const lifecycleInfo = document.getElementById('lifecycle-info')
      lifecycleInfo.innerHTML = '<p style="color: green;">✅ 生命周期钩子已添加</p>'
      
      log('🔄 生命周期钩子已注册')
    }

    // 页面加载完成后的初始化
    log('🌟 LDesign Engine 示例页面已加载')
    log('💡 点击按钮开始体验引擎功能')
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDesign Editor - æ€§èƒ½æµ‹è¯•</title>
  <style>
    /* åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: #722ED1;
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header::before {
      content: 'âš¡';
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 2rem;
      opacity: 0.7;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .main-content {
      padding: 30px;
    }

    .performance-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .metric-value {
      font-size: 2rem;
      font-weight: bold;
      color: #722ED1;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .metric-unit {
      font-size: 0.8rem;
      color: #999;
    }

    .test-controls {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .test-controls h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .control-group {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .btn:hover {
      background: #f0f0f0;
      border-color: #722ED1;
    }

    .btn.primary {
      background: #722ED1;
      color: white;
      border-color: #722ED1;
    }

    .btn.primary:hover {
      background: #5e2aa7;
    }

    .btn.danger {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .btn.danger:hover {
      background: #c82333;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .form-control {
      padding: 8px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .editors-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .editor-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #e9ecef;
    }

    .editor-section h3 {
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .editor-container {
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      min-height: 300px;
      background: white;
      padding: 15px;
      outline: none;
      margin-bottom: 15px;
      overflow-y: auto;
      max-height: 400px;
    }

    .editor-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      font-size: 0.85rem;
      color: #666;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #722ED1, #8c5ad3);
      width: 0%;
      transition: width 0.3s ease;
    }

    .log-panel {
      background: #1a1a1a;
      color: #00ff00;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 5px;
      opacity: 0;
      animation: fadeInLog 0.3s ease forwards;
    }

    @keyframes fadeInLog {
      to { opacity: 1; }
    }

    .benchmark-results {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .benchmark-results h4 {
      color: #856404;
      margin-bottom: 15px;
    }

    .benchmark-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .benchmark-table th,
    .benchmark-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }

    .benchmark-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-running {
      background: #ffc107;
      animation: pulse 1s ease-in-out infinite;
    }

    .status-success {
      background: #28a745;
    }

    .status-error {
      background: #dc3545;
    }

    .status-idle {
      background: #6c757d;
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 20px;
      }
      
      .header {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .editors-grid {
        grid-template-columns: 1fr;
      }
      
      .performance-dashboard {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .control-group {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <h1>LDesign Editor</h1>
      <p>æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯• - ç¼–è¾‘å™¨æ€§èƒ½åˆ†æå·¥å…·</p>
    </div>

    <div class="main-content">
      <!-- æ€§èƒ½ä»ªè¡¨æ¿ -->
      <div class="performance-dashboard">
        <div class="metric-card">
          <div class="metric-value" id="fpsValue">60</div>
          <div class="metric-label">å¸§ç‡ (FPS)</div>
          <div class="metric-unit">frames/sec</div>
        </div>

        <div class="metric-card">
          <div class="metric-value" id="memoryValue">0</div>
          <div class="metric-label">å†…å­˜ä½¿ç”¨</div>
          <div class="metric-unit">MB</div>
        </div>

        <div class="metric-card">
          <div class="metric-value" id="renderTime">0</div>
          <div class="metric-label">æ¸²æŸ“æ—¶é—´</div>
          <div class="metric-unit">ms</div>
        </div>

        <div class="metric-card">
          <div class="metric-value" id="inputLatency">0</div>
          <div class="metric-label">è¾“å…¥å»¶è¿Ÿ</div>
          <div class="metric-unit">ms</div>
        </div>

        <div class="metric-card">
          <div class="metric-value" id="domNodes">0</div>
          <div class="metric-label">DOM èŠ‚ç‚¹</div>
          <div class="metric-unit">nodes</div>
        </div>

        <div class="metric-card">
          <div class="metric-value" id="contentSize">0</div>
          <div class="metric-label">å†…å®¹å¤§å°</div>
          <div class="metric-unit">KB</div>
        </div>
      </div>

      <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
      <div class="test-controls">
        <h3>ğŸ§ª æ€§èƒ½æµ‹è¯•æ§åˆ¶</h3>

        <div class="control-group">
          <label>æµ‹è¯•ç±»å‹:</label>
          <select id="testType" class="form-control" style="width: 200px;">
            <option value="typing">æ‰“å­—æ€§èƒ½æµ‹è¯•</option>
            <option value="content">å¤§å†…å®¹åŠ è½½æµ‹è¯•</option>
            <option value="formatting">æ ¼å¼åŒ–æ€§èƒ½æµ‹è¯•</option>
            <option value="memory">å†…å­˜æ³„æ¼æµ‹è¯•</option>
            <option value="stress">å‹åŠ›æµ‹è¯•</option>
          </select>

          <label>æµ‹è¯•å¼ºåº¦:</label>
          <select id="testIntensity" class="form-control" style="width: 150px;">
            <option value="light">è½»åº¦</option>
            <option value="medium">ä¸­åº¦</option>
            <option value="heavy">é‡åº¦</option>
            <option value="extreme">æé™</option>
          </select>
        </div>

        <div class="control-group">
          <button class="btn primary" onclick="startPerformanceTest()">
            <span class="status-indicator status-idle"></span>
            å¼€å§‹æµ‹è¯•
          </button>
          <button class="btn danger" onclick="stopPerformanceTest()" disabled>
            åœæ­¢æµ‹è¯•
          </button>
          <button class="btn" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
          <button class="btn" onclick="exportResults()">å¯¼å‡ºæŠ¥å‘Š</button>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="testProgress"></div>
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: #666;">
          <span id="testStatus">å°±ç»ª</span>
        </div>
      </div>

      <!-- ç¼–è¾‘å™¨æµ‹è¯•åŒºåŸŸ -->
      <div class="editors-grid">
        <div class="editor-section">
          <h3>ğŸ“ æµ‹è¯•ç¼–è¾‘å™¨ A</h3>
          <div id="editorA" class="editor-container" contenteditable="true">
            <h2>æ€§èƒ½æµ‹è¯•ç¼–è¾‘å™¨ A</h2>
            <p>è¿™æ˜¯ç”¨äºæ€§èƒ½æµ‹è¯•çš„ç¼–è¾‘å™¨ã€‚åœ¨è¿™é‡Œè¾“å…¥å†…å®¹æ¥æµ‹è¯•ç¼–è¾‘å™¨çš„å“åº”æ€§èƒ½ã€‚</p>
            <ul>
              <li>å®æ—¶æ€§èƒ½ç›‘æ§</li>
              <li>è¾“å…¥å»¶è¿Ÿæµ‹é‡</li>
              <li>æ¸²æŸ“æ€§èƒ½åˆ†æ</li>
            </ul>
            <p>å¼€å§‹è¾“å…¥å†…å®¹ï¼Œè§‚å¯Ÿå³ä¾§çš„æ€§èƒ½æŒ‡æ ‡å˜åŒ–...</p>
          </div>

          <div class="editor-stats">
            <div>å­—ç¬¦æ•°: <span id="editorAChars">0</span></div>
            <div>DOMèŠ‚ç‚¹: <span id="editorANodes">0</span></div>
            <div>æœ€åæ›´æ–°: <span id="editorAUpdate">-</span></div>
            <div>è¾“å…¥é¢‘ç‡: <span id="editorAFreq">0</span> æ¬¡/ç§’</div>
          </div>
        </div>

        <div class="editor-section">
          <h3>ğŸ“Š æµ‹è¯•ç¼–è¾‘å™¨ B</h3>
          <div id="editorB" class="editor-container" contenteditable="true">
            <h2>æ€§èƒ½æµ‹è¯•ç¼–è¾‘å™¨ B</h2>
            <p>è¿™æ˜¯ç¬¬äºŒä¸ªæµ‹è¯•ç¼–è¾‘å™¨ï¼Œç”¨äºå¯¹æ¯”æµ‹è¯•ã€‚</p>
            <blockquote>
              é€šè¿‡å¯¹æ¯”ä¸¤ä¸ªç¼–è¾‘å™¨çš„æ€§èƒ½è¡¨ç°ï¼Œå¯ä»¥æ›´å¥½åœ°åˆ†ææ€§èƒ½ç“¶é¢ˆã€‚
            </blockquote>
            <p>åœ¨ä¸¤ä¸ªç¼–è¾‘å™¨ä¸­åŒæ—¶è¾“å…¥å†…å®¹ï¼Œæ¯”è¾ƒæ€§èƒ½å·®å¼‚...</p>
          </div>

          <div class="editor-stats">
            <div>å­—ç¬¦æ•°: <span id="editorBChars">0</span></div>
            <div>DOMèŠ‚ç‚¹: <span id="editorBNodes">0</span></div>
            <div>æœ€åæ›´æ–°: <span id="editorBUpdate">-</span></div>
            <div>è¾“å…¥é¢‘ç‡: <span id="editorBFreq">0</span> æ¬¡/ç§’</div>
          </div>
        </div>
      </div>

      <!-- åŸºå‡†æµ‹è¯•ç»“æœ -->
      <div class="benchmark-results" id="benchmarkResults" style="display: none;">
        <h4>ğŸ“ˆ åŸºå‡†æµ‹è¯•ç»“æœ</h4>
        <table class="benchmark-table">
          <thead>
            <tr>
              <th>æµ‹è¯•é¡¹ç›®</th>
              <th>ç¼–è¾‘å™¨ A</th>
              <th>ç¼–è¾‘å™¨ B</th>
              <th>å·®å¼‚</th>
              <th>è¯„çº§</th>
            </tr>
          </thead>
          <tbody id="benchmarkTableBody">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>

      <!-- å®æ—¶æ—¥å¿— -->
      <div class="log-panel" id="logPanel">
        <div class="log-entry">[ç³»ç»Ÿ] æ€§èƒ½ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨</div>
        <div class="log-entry">[ä¿¡æ¯] ç­‰å¾…å¼€å§‹æ€§èƒ½æµ‹è¯•...</div>
      </div>
    </div>
  </div>

  <script>
    // æ€§èƒ½ç›‘æ§ç±»
    class PerformanceMonitor {
      constructor() {
        this.isRunning = false;
        this.startTime = 0;
        this.frameCount = 0;
        this.lastFrameTime = 0;
        this.fps = 60;
        this.metrics = {
          renderTime: 0,
          inputLatency: 0,
          memoryUsage: 0,
          domNodes: 0,
          contentSize: 0
        };
        this.inputTimes = [];
        this.renderTimes = [];
        this.testResults = [];

        this.initMonitoring();
      }

      initMonitoring() {
        // FPS ç›‘æ§
        this.monitorFPS();

        // å†…å­˜ç›‘æ§
        this.monitorMemory();

        // DOM ç›‘æ§
        this.monitorDOM();

        // è¾“å…¥å»¶è¿Ÿç›‘æ§
        this.monitorInputLatency();
      }

      monitorFPS() {
        const measureFPS = (timestamp) => {
          if (this.lastFrameTime === 0) {
            this.lastFrameTime = timestamp;
          }

          const delta = timestamp - this.lastFrameTime;
          this.fps = Math.round(1000 / delta);
          this.lastFrameTime = timestamp;

          document.getElementById('fpsValue').textContent = this.fps;

          if (this.isRunning) {
            requestAnimationFrame(measureFPS);
          }
        };

        requestAnimationFrame(measureFPS);
      }

      monitorMemory() {
        if (performance.memory) {
          setInterval(() => {
            const memory = performance.memory;
            const usedMB = Math.round(memory.usedJSHeapSize / 1024 / 1024);
            this.metrics.memoryUsage = usedMB;
            document.getElementById('memoryValue').textContent = usedMB;
          }, 1000);
        }
      }

      monitorDOM() {
        setInterval(() => {
          const nodeCount = document.querySelectorAll('*').length;
          this.metrics.domNodes = nodeCount;
          document.getElementById('domNodes').textContent = nodeCount;
        }, 2000);
      }

      monitorInputLatency() {
        ['editorA', 'editorB'].forEach(editorId => {
          const editor = document.getElementById(editorId);
          let inputStartTime = 0;

          editor.addEventListener('keydown', () => {
            inputStartTime = performance.now();
          });

          editor.addEventListener('input', () => {
            if (inputStartTime > 0) {
              const latency = performance.now() - inputStartTime;
              this.inputTimes.push(latency);

              // ä¿æŒæœ€è¿‘100æ¬¡çš„è®°å½•
              if (this.inputTimes.length > 100) {
                this.inputTimes.shift();
              }

              const avgLatency = this.inputTimes.reduce((a, b) => a + b, 0) / this.inputTimes.length;
              this.metrics.inputLatency = Math.round(avgLatency);
              document.getElementById('inputLatency').textContent = this.metrics.inputLatency;

              inputStartTime = 0;
            }
          });
        });
      }

      measureRenderTime(callback) {
        const startTime = performance.now();

        requestAnimationFrame(() => {
          const endTime = performance.now();
          const renderTime = endTime - startTime;
          this.renderTimes.push(renderTime);

          if (this.renderTimes.length > 50) {
            this.renderTimes.shift();
          }

          const avgRenderTime = this.renderTimes.reduce((a, b) => a + b, 0) / this.renderTimes.length;
          this.metrics.renderTime = Math.round(avgRenderTime * 100) / 100;
          document.getElementById('renderTime').textContent = this.metrics.renderTime;

          if (callback) callback();
        });
      }

      start() {
        this.isRunning = true;
        this.startTime = performance.now();
        this.frameCount = 0;
        this.log('æ€§èƒ½ç›‘æ§å·²å¯åŠ¨');
      }

      stop() {
        this.isRunning = false;
        this.log('æ€§èƒ½ç›‘æ§å·²åœæ­¢');
      }

      log(message, type = 'info') {
        const logPanel = document.getElementById('logPanel');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';

        const typePrefix = {
          info: '[ä¿¡æ¯]',
          warning: '[è­¦å‘Š]',
          error: '[é”™è¯¯]',
          success: '[æˆåŠŸ]'
        };

        logEntry.textContent = `${timestamp} ${typePrefix[type]} ${message}`;
        logPanel.appendChild(logEntry);
        logPanel.scrollTop = logPanel.scrollHeight;

        // é™åˆ¶æ—¥å¿—æ¡æ•°
        const entries = logPanel.querySelectorAll('.log-entry');
        if (entries.length > 100) {
          entries[0].remove();
        }
      }

      getMetrics() {
        return {
          ...this.metrics,
          fps: this.fps,
          avgInputLatency: this.inputTimes.length > 0
            ? this.inputTimes.reduce((a, b) => a + b, 0) / this.inputTimes.length
            : 0,
          avgRenderTime: this.renderTimes.length > 0
            ? this.renderTimes.reduce((a, b) => a + b, 0) / this.renderTimes.length
            : 0
        };
      }
    }

    // æ€§èƒ½æµ‹è¯•ç±»
    class PerformanceTest {
      constructor(monitor) {
        this.monitor = monitor;
        this.isRunning = false;
        this.currentTest = null;
        this.testProgress = 0;
        this.testResults = [];
      }

      async startTest(testType, intensity) {
        if (this.isRunning) return;

        this.isRunning = true;
        this.currentTest = testType;
        this.testProgress = 0;

        this.updateUI('running');
        this.monitor.log(`å¼€å§‹ ${testType} æµ‹è¯• (å¼ºåº¦: ${intensity})`);

        try {
          switch (testType) {
            case 'typing':
              await this.runTypingTest(intensity);
              break;
            case 'content':
              await this.runContentTest(intensity);
              break;
            case 'formatting':
              await this.runFormattingTest(intensity);
              break;
            case 'memory':
              await this.runMemoryTest(intensity);
              break;
            case 'stress':
              await this.runStressTest(intensity);
              break;
          }

          this.monitor.log(`${testType} æµ‹è¯•å®Œæˆ`, 'success');
          this.updateUI('success');
        } catch (error) {
          this.monitor.log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          this.updateUI('error');
        } finally {
          this.isRunning = false;
        }
      }

      async runTypingTest(intensity) {
        const iterations = { light: 100, medium: 500, heavy: 1000, extreme: 2000 }[intensity];
        const editorA = document.getElementById('editorA');
        const editorB = document.getElementById('editorB');

        const testText = 'The quick brown fox jumps over the lazy dog. ';

        for (let i = 0; i < iterations; i++) {
          // æ¨¡æ‹Ÿæ‰“å­—
          const char = testText[i % testText.length];

          // åœ¨ç¼–è¾‘å™¨Aä¸­æ’å…¥å­—ç¬¦
          this.insertCharacter(editorA, char);

          // åœ¨ç¼–è¾‘å™¨Bä¸­æ’å…¥å­—ç¬¦
          this.insertCharacter(editorB, char);

          // æ›´æ–°è¿›åº¦
          this.testProgress = (i / iterations) * 100;
          this.updateProgress();

          // æµ‹é‡æ¸²æŸ“æ—¶é—´
          await new Promise(resolve => {
            this.monitor.measureRenderTime(resolve);
          });

          // æ§åˆ¶æµ‹è¯•é€Ÿåº¦
          if (intensity !== 'extreme') {
            await this.delay(10);
          }
        }
      }

      async runContentTest(intensity) {
        const sizes = { light: 1000, medium: 5000, heavy: 10000, extreme: 20000 }[intensity];
        const editorA = document.getElementById('editorA');

        this.monitor.log(`ç”Ÿæˆ ${sizes} å­—ç¬¦çš„å¤§å†…å®¹`);

        let content = '<h1>å¤§å†…å®¹æµ‹è¯•</h1>';
        for (let i = 0; i < sizes / 100; i++) {
          content += `<p>è¿™æ˜¯ç¬¬ ${i + 1} æ®µæµ‹è¯•å†…å®¹ã€‚`.repeat(10) + '</p>';

          if (i % 10 === 0) {
            content += '<ul>';
            for (let j = 0; j < 5; j++) {
              content += `<li>åˆ—è¡¨é¡¹ ${j + 1}</li>`;
            }
            content += '</ul>';
          }

          // æ›´æ–°è¿›åº¦
          this.testProgress = (i / (sizes / 100)) * 100;
          this.updateProgress();

          await this.delay(1);
        }

        // ä¸€æ¬¡æ€§æ’å…¥å¤§å†…å®¹
        const startTime = performance.now();
        editorA.innerHTML = content;
        const endTime = performance.now();

        this.monitor.log(`å¤§å†…å®¹åŠ è½½è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

        // æ›´æ–°å†…å®¹å¤§å°ç»Ÿè®¡
        const contentSize = Math.round(new Blob([content]).size / 1024);
        document.getElementById('contentSize').textContent = contentSize;
      }

      async runFormattingTest(intensity) {
        const iterations = { light: 50, medium: 200, heavy: 500, extreme: 1000 }[intensity];
        const editorA = document.getElementById('editorA');

        const commands = ['bold', 'italic', 'underline', 'heading1', 'heading2', 'bulletList'];

        for (let i = 0; i < iterations; i++) {
          const command = commands[i % commands.length];

          // é€‰æ‹©ä¸€äº›æ–‡æœ¬
          this.selectRandomText(editorA);

          // æ‰§è¡Œæ ¼å¼åŒ–å‘½ä»¤
          const startTime = performance.now();
          document.execCommand(command, false, null);
          const endTime = performance.now();

          this.monitor.log(`æ ¼å¼åŒ–å‘½ä»¤ ${command} è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

          // æ›´æ–°è¿›åº¦
          this.testProgress = (i / iterations) * 100;
          this.updateProgress();

          await this.delay(50);
        }
      }

      async runMemoryTest(intensity) {
        const iterations = { light: 10, medium: 50, heavy: 100, extreme: 200 }[intensity];
        const editorA = document.getElementById('editorA');

        const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;

        for (let i = 0; i < iterations; i++) {
          // åˆ›å»ºå¤§é‡DOMèŠ‚ç‚¹
          const content = '<div>'.repeat(100) + 'å†…å®¹'.repeat(100) + '</div>'.repeat(100);
          editorA.innerHTML += content;

          // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if (window.gc) {
            window.gc();
          }

          // æ›´æ–°è¿›åº¦
          this.testProgress = (i / iterations) * 100;
          this.updateProgress();

          await this.delay(100);
        }

        const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
        const memoryIncrease = Math.round((finalMemory - initialMemory) / 1024 / 1024);

        this.monitor.log(`å†…å­˜å¢é•¿: ${memoryIncrease}MB`, memoryIncrease > 50 ? 'warning' : 'info');
      }

      async runStressTest(intensity) {
        this.monitor.log('å¼€å§‹å‹åŠ›æµ‹è¯• - ç»¼åˆæ‰€æœ‰æµ‹è¯•é¡¹ç›®');

        // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
        await this.runTypingTest(intensity);
        await this.runContentTest(intensity);
        await this.runFormattingTest(intensity);
        await this.runMemoryTest(intensity);

        this.monitor.log('å‹åŠ›æµ‹è¯•å®Œæˆ', 'success');
      }

      insertCharacter(editor, char) {
        const selection = window.getSelection();
        const range = document.createRange();

        // å°†å…‰æ ‡ç§»åˆ°ç¼–è¾‘å™¨æœ«å°¾
        range.selectNodeContents(editor);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);

        // æ’å…¥å­—ç¬¦
        document.execCommand('insertText', false, char);
      }

      selectRandomText(editor) {
        const textNodes = this.getTextNodes(editor);
        if (textNodes.length === 0) return;

        const randomNode = textNodes[Math.floor(Math.random() * textNodes.length)];
        const text = randomNode.textContent;
        const startOffset = Math.floor(Math.random() * text.length);
        const endOffset = Math.min(startOffset + Math.floor(Math.random() * 10) + 1, text.length);

        const selection = window.getSelection();
        const range = document.createRange();
        range.setStart(randomNode, startOffset);
        range.setEnd(randomNode, endOffset);
        selection.removeAllRanges();
        selection.addRange(range);
      }

      getTextNodes(element) {
        const textNodes = [];
        const walker = document.createTreeWalker(
          element,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );

        let node;
        while (node = walker.nextNode()) {
          if (node.textContent.trim().length > 0) {
            textNodes.push(node);
          }
        }

        return textNodes;
      }

      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      updateProgress() {
        const progressFill = document.getElementById('testProgress');
        progressFill.style.width = `${this.testProgress}%`;

        const status = document.getElementById('testStatus');
        status.textContent = `æµ‹è¯•è¿›è¡Œä¸­... ${Math.round(this.testProgress)}%`;
      }

      updateUI(state) {
        const startBtn = document.querySelector('.btn.primary');
        const stopBtn = document.querySelector('.btn.danger');
        const statusIndicator = startBtn.querySelector('.status-indicator');
        const status = document.getElementById('testStatus');

        switch (state) {
          case 'running':
            startBtn.disabled = true;
            stopBtn.disabled = false;
            statusIndicator.className = 'status-indicator status-running';
            status.textContent = 'æµ‹è¯•è¿è¡Œä¸­...';
            break;
          case 'success':
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusIndicator.className = 'status-indicator status-success';
            status.textContent = 'æµ‹è¯•å®Œæˆ';
            this.showBenchmarkResults();
            break;
          case 'error':
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusIndicator.className = 'status-indicator status-error';
            status.textContent = 'æµ‹è¯•å¤±è´¥';
            break;
          default:
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusIndicator.className = 'status-indicator status-idle';
            status.textContent = 'å°±ç»ª';
        }
      }

      showBenchmarkResults() {
        const resultsPanel = document.getElementById('benchmarkResults');
        const tableBody = document.getElementById('benchmarkTableBody');

        const metrics = this.monitor.getMetrics();
        const results = [
          { name: 'å¹³å‡FPS', valueA: metrics.fps, valueB: metrics.fps, unit: 'fps' },
          { name: 'æ¸²æŸ“æ—¶é—´', valueA: metrics.avgRenderTime, valueB: metrics.avgRenderTime, unit: 'ms' },
          { name: 'è¾“å…¥å»¶è¿Ÿ', valueA: metrics.avgInputLatency, valueB: metrics.avgInputLatency, unit: 'ms' },
          { name: 'å†…å­˜ä½¿ç”¨', valueA: metrics.memoryUsage, valueB: metrics.memoryUsage, unit: 'MB' },
          { name: 'DOMèŠ‚ç‚¹', valueA: metrics.domNodes, valueB: metrics.domNodes, unit: 'nodes' }
        ];

        tableBody.innerHTML = results.map(result => {
          const diff = Math.abs(result.valueA - result.valueB);
          const rating = this.getRating(result.name, result.valueA);

          return `
            <tr>
              <td>${result.name}</td>
              <td>${result.valueA.toFixed(2)} ${result.unit}</td>
              <td>${result.valueB.toFixed(2)} ${result.unit}</td>
              <td>${diff.toFixed(2)} ${result.unit}</td>
              <td>${rating}</td>
            </tr>
          `;
        }).join('');

        resultsPanel.style.display = 'block';
      }

      getRating(metricName, value) {
        const ratings = {
          'å¹³å‡FPS': value >= 55 ? 'ä¼˜ç§€' : value >= 30 ? 'è‰¯å¥½' : 'éœ€ä¼˜åŒ–',
          'æ¸²æŸ“æ—¶é—´': value <= 16 ? 'ä¼˜ç§€' : value <= 33 ? 'è‰¯å¥½' : 'éœ€ä¼˜åŒ–',
          'è¾“å…¥å»¶è¿Ÿ': value <= 50 ? 'ä¼˜ç§€' : value <= 100 ? 'è‰¯å¥½' : 'éœ€ä¼˜åŒ–',
          'å†…å­˜ä½¿ç”¨': value <= 100 ? 'ä¼˜ç§€' : value <= 200 ? 'è‰¯å¥½' : 'éœ€ä¼˜åŒ–',
          'DOMèŠ‚ç‚¹': value <= 1000 ? 'ä¼˜ç§€' : value <= 2000 ? 'è‰¯å¥½' : 'éœ€ä¼˜åŒ–'
        };

        return ratings[metricName] || 'æœªçŸ¥';
      }

      stop() {
        this.isRunning = false;
        this.updateUI('idle');
        this.monitor.log('æµ‹è¯•å·²åœæ­¢');
      }
    }

    // å…¨å±€å˜é‡
    let performanceMonitor;
    let performanceTest;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      performanceMonitor = new PerformanceMonitor();
      performanceTest = new PerformanceTest(performanceMonitor);

      performanceMonitor.start();

      // åˆå§‹åŒ–ç¼–è¾‘å™¨ç»Ÿè®¡
      initEditorStats();

      performanceMonitor.log('æ€§èƒ½æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
    });

    // ç¼–è¾‘å™¨ç»Ÿè®¡åˆå§‹åŒ–
    function initEditorStats() {
      ['A', 'B'].forEach(suffix => {
        const editor = document.getElementById(`editor${suffix}`);
        let inputCount = 0;
        let lastInputTime = Date.now();

        editor.addEventListener('input', function() {
          const now = Date.now();
          inputCount++;

          // æ›´æ–°å­—ç¬¦æ•°
          const charCount = editor.textContent.length;
          document.getElementById(`editor${suffix}Chars`).textContent = charCount;

          // æ›´æ–°DOMèŠ‚ç‚¹æ•°
          const nodeCount = editor.querySelectorAll('*').length;
          document.getElementById(`editor${suffix}Nodes`).textContent = nodeCount;

          // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
          document.getElementById(`editor${suffix}Update`).textContent = new Date().toLocaleTimeString();

          // è®¡ç®—è¾“å…¥é¢‘ç‡
          if (now - lastInputTime >= 1000) {
            document.getElementById(`editor${suffix}Freq`).textContent = inputCount;
            inputCount = 0;
            lastInputTime = now;
          }

          // æ›´æ–°å†…å®¹å¤§å°
          const contentSize = Math.round(new Blob([editor.innerHTML]).size / 1024);
          document.getElementById('contentSize').textContent = contentSize;
        });
      });
    }

    // å…¨å±€å‡½æ•°
    function startPerformanceTest() {
      const testType = document.getElementById('testType').value;
      const intensity = document.getElementById('testIntensity').value;

      performanceTest.startTest(testType, intensity);
    }

    function stopPerformanceTest() {
      performanceTest.stop();
    }

    function clearResults() {
      document.getElementById('benchmarkResults').style.display = 'none';
      document.getElementById('logPanel').innerHTML = '<div class="log-entry">[ç³»ç»Ÿ] ç»“æœå·²æ¸…ç©º</div>';

      // é‡ç½®ç¼–è¾‘å™¨å†…å®¹
      document.getElementById('editorA').innerHTML = '<h2>æ€§èƒ½æµ‹è¯•ç¼–è¾‘å™¨ A</h2><p>å†…å®¹å·²é‡ç½®</p>';
      document.getElementById('editorB').innerHTML = '<h2>æ€§èƒ½æµ‹è¯•ç¼–è¾‘å™¨ B</h2><p>å†…å®¹å·²é‡ç½®</p>';

      performanceMonitor.log('æµ‹è¯•ç»“æœå·²æ¸…ç©º');
    }

    function exportResults() {
      const metrics = performanceMonitor.getMetrics();
      const report = {
        timestamp: new Date().toISOString(),
        metrics: metrics,
        testType: document.getElementById('testType').value,
        intensity: document.getElementById('testIntensity').value,
        userAgent: navigator.userAgent,
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        }
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `performance-report-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      performanceMonitor.log('æ€§èƒ½æŠ¥å‘Šå·²å¯¼å‡º', 'success');
    }
  </script>
</body>
</html>

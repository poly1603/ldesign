# @ldesign/api 项目概览

## 📋 项目基本信息

- **项目名称**: @ldesign/api
- **版本**: 0.1.0
- **类型**: 通用系统接口管理包
- **开发语言**: TypeScript
- **目标框架**: 框架无关（特别支持 Vue 3）
- **包管理器**: pnpm
- **构建工具**: Rollup
- **测试框架**: Vitest + Playwright

## 🎯 项目目标

创建一个功能强大、高性能、易扩展的通用系统接口管理包，解决前端项目中 API 管理的痛点：

### 核心目标

1. **统一接口管理**: 提供统一的接口调用方式和管理机制
2. **插件化架构**: 支持模块化的接口组织和动态扩展
3. **性能优化**: 内置缓存、防抖、请求去重等优化机制
4. **类型安全**: 完整的 TypeScript 支持
5. **框架集成**: 特别为 Vue 3 提供深度集成

### 解决的问题

- 接口调用分散，难以统一管理
- 缺乏有效的缓存和性能优化机制
- 重复的接口定义和调用代码
- 缺乏类型安全保障
- 难以实现接口的模块化组织

## 🏗️ 架构设计

### 整体架构

```
@ldesign/api
├── 核心引擎 (ApiEngine)
│   ├── 插件管理器 (PluginManager)
│   ├── 缓存管理器 (CacheManager)
│   ├── 防抖管理器 (DebounceManager)
│   └── 去重管理器 (DeduplicationManager)
├── 内置插件
│   └── 系统接口插件 (SystemApiPlugin)
├── Vue 3 集成
│   ├── Vue 插件 (apiVuePlugin)
│   └── 组合式 API (Composables)
└── 工具函数 (Utils)
```

### 设计原则

1. **高内聚，低耦合**: 每个模块职责单一，模块间依赖最小化
2. **插件化优先**: 核心功能通过插件系统实现，便于扩展和维护
3. **性能至上**: 内置多种性能优化机制，确保高效运行
4. **类型安全**: 完整的 TypeScript 类型定义，提供编译时检查
5. **渐进式增强**: 核心功能框架无关，特定框架提供增强功能

### 核心组件

#### 1. ApiEngine (核心引擎)

- **职责**: 协调各个管理器，提供统一的 API 调用接口
- **特性**:
  - 插件注册和管理
  - API 方法注册和调用
  - 配置管理
  - 生命周期管理

#### 2. PluginManager (插件管理器)

- **职责**: 管理插件的注册、依赖检查、生命周期
- **特性**:
  - 插件依赖解析
  - 加载顺序管理
  - 插件安装/卸载
  - 错误处理

#### 3. CacheManager (缓存管理器)

- **职责**: 管理 API 响应的缓存
- **特性**:
  - 多种存储方式 (memory/localStorage/sessionStorage)
  - TTL 过期机制
  - 缓存大小限制
  - 自动清理

#### 4. DebounceManager (防抖管理器)

- **职责**: 防止频繁的重复请求
- **特性**:
  - 可配置的防抖延迟
  - 基于参数的防抖键生成
  - 任务取消和立即执行
  - 统计信息

#### 5. DeduplicationManager (去重管理器)

- **职责**: 合并相同的并发请求
- **特性**:
  - 请求去重键生成
  - 引用计数管理
  - 结果共享
  - 错误处理

## 🔌 插件系统设计

### 插件接口

```typescript
interface ApiPlugin {
  name: string // 插件名称
  version?: string // 插件版本
  dependencies?: string[] // 依赖的插件
  install: (engine: ApiEngine) => void | Promise<void>
  uninstall?: (engine: ApiEngine) => void | Promise<void>
  apis?: Record<string, ApiMethod> // 提供的 API 方法
}
```

### 插件生命周期

1. **注册阶段**: 验证插件格式，检查依赖
2. **安装阶段**: 执行插件的 install 方法
3. **运行阶段**: 插件提供的 API 方法可被调用
4. **卸载阶段**: 执行插件的 uninstall 方法（可选）

### 内置插件

#### SystemApiPlugin (系统接口插件)

提供常用的系统接口方法：

- `getCaptcha`: 获取验证码
- `getSession`: 获取会话信息
- `login`: 用户登录
- `logout`: 用户登出
- `getUserInfo`: 获取用户信息
- `getMenus`: 获取系统菜单
- `refreshToken`: 刷新令牌
- `changePassword`: 修改密码
- `getPermissions`: 获取用户权限

## ⚡ 性能优化设计

### 1. 缓存机制

#### 多级缓存策略

- **内存缓存**: 最快的访问速度，适合频繁访问的数据
- **本地存储缓存**: 持久化缓存，适合跨会话的数据
- **会话存储缓存**: 会话级缓存，适合临时数据

#### 缓存策略

- **TTL 过期**: 基于时间的自动过期
- **LRU 淘汰**: 最近最少使用的数据优先淘汰
- **大小限制**: 防止缓存无限增长

### 2. 防抖机制

#### 防抖策略

- **参数级防抖**: 基于方法名和参数生成防抖键
- **可配置延迟**: 支持全局和方法级的防抖配置
- **智能取消**: 新请求自动取消旧请求

#### 适用场景

- 搜索接口
- 自动保存功能
- 实时验证

### 3. 请求去重

#### 去重策略

- **请求合并**: 相同的并发请求只执行一次
- **结果共享**: 所有相同请求共享同一个结果
- **引用计数**: 跟踪请求的引用数量

#### 适用场景

- 页面初始化时的并发请求
- 组件重复挂载
- 用户快速点击

## 🌟 Vue 3 集成设计

### 集成策略

1. **Vue 插件**: 提供全局安装和配置
2. **依赖注入**: 通过 provide/inject 共享 API 引擎
3. **组合式 API**: 提供响应式的 API 调用状态
4. **生命周期集成**: 自动处理组件卸载时的清理

### 组合式 API 设计

#### useApiCall

提供响应式的 API 调用状态：

- `data`: 响应数据
- `loading`: 加载状态
- `error`: 错误信息
- `execute`: 执行函数
- `reset`: 重置状态

#### useSystemApi

提供系统接口的快捷访问：

- 预定义的系统接口方法
- 统一的调用方式
- 响应式状态管理

#### useBatchApiCall

支持批量 API 调用：

- 并发执行多个接口
- 统一的状态管理
- 错误隔离

## 🛡️ 类型安全设计

### 类型定义策略

1. **完整的接口定义**: 为所有公开的 API 提供类型定义
2. **泛型支持**: 支持自定义的请求和响应类型
3. **类型推导**: 尽可能利用 TypeScript 的类型推导
4. **严格模式**: 启用严格的类型检查

### 核心类型

```typescript
// 核心接口类型
interface ApiEngine {
  /* ... */
}
interface ApiPlugin {
  /* ... */
}
interface ApiMethod<T, P> {
  /* ... */
}

// 配置类型
interface ApiEngineConfig {
  /* ... */
}
interface CacheConfig {
  /* ... */
}
interface DebounceConfig {
  /* ... */
}

// 业务类型
interface UserInfo {
  /* ... */
}
interface MenuItem {
  /* ... */
}
interface SessionInfo {
  /* ... */
}
```

## 📦 构建和发布

### 构建配置

- **多格式输出**: ESM、CommonJS、UMD
- **类型定义**: 生成完整的 .d.ts 文件
- **代码分割**: 支持按需加载
- **Tree Shaking**: 支持无用代码消除

### 发布策略

- **语义化版本**: 遵循 SemVer 规范
- **变更日志**: 详细记录每个版本的变更
- **向后兼容**: 保持 API 的向后兼容性
- **渐进式升级**: 支持渐进式的功能升级

## 🧪 测试策略

### 测试层次

1. **单元测试**: 测试各个模块的核心功能
2. **集成测试**: 测试模块间的协作
3. **端到端测试**: 测试完整的使用场景
4. **类型测试**: 验证 TypeScript 类型定义

### 测试覆盖

- **核心功能**: 100% 覆盖核心 API
- **边界情况**: 覆盖各种边界和异常情况
- **性能测试**: 验证缓存、防抖等性能优化
- **兼容性测试**: 验证不同环境的兼容性

## 🔮 未来规划

### 短期目标 (v0.2.0)

- [ ] 支持 GraphQL 接口
- [ ] 增强错误处理机制
- [ ] 添加请求重试策略
- [ ] 优化缓存算法

### 中期目标 (v0.3.0)

- [ ] 支持 WebSocket 接口
- [ ] 添加离线缓存功能
- [ ] 支持请求优先级
- [ ] 增加性能监控

### 长期目标 (v1.0.0)

- [ ] 支持更多前端框架
- [ ] 提供可视化管理界面
- [ ] 支持接口 Mock 功能
- [ ] 建立插件生态系统

## 📊 项目指标

### 代码质量

- TypeScript 覆盖率: 100%
- 单元测试覆盖率: >90%
- ESLint 规则: 严格模式
- 代码复杂度: 低

### 性能指标

- 包体积: <50KB (gzipped)
- 初始化时间: <10ms
- 内存占用: <5MB
- 缓存命中率: >80%

### 开发体验

- 完整的类型提示
- 详细的错误信息
- 丰富的文档和示例
- 活跃的社区支持

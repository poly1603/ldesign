<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>拖拽排序示例 - LDESIGN Table</title>
  <link rel="stylesheet" href="./src/styles/main.css">
</head>
<body>
  <div class="page-header">
    <h1>🔄 拖拽排序示例</h1>
    <p>演示表格的拖拽排序功能</p>
  </div>

  <nav class="nav">
    <div class="container">
      <ul class="nav-links">
        <li><a href="./index.html">首页</a></li>
        <li><a href="./basic.html">基础表格</a></li>
        <li><a href="./filter.html">筛选搜索</a></li>
        <li><a href="./editable.html">可编辑表格</a></li>
        <li><a href="./drag-sort.html" class="active">拖拽排序</a></li>
        <li><a href="./export.html">数据导出</a></li>
        <li><a href="./theme.html">主题系统</a></li>
        <li><a href="./complete.html">完整功能</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="example-section">
      <h2>拖拽排序演示</h2>
      <p>这个示例展示了表格的拖拽排序功能，支持行的拖拽重新排序。</p>
      
      <div class="info-panel">
        <h4>拖拽特性</h4>
        <ul>
          <li>🖱️ 鼠标拖拽排序</li>
          <li>📱 触摸设备支持</li>
          <li>👁️ 拖拽视觉反馈</li>
          <li>🎯 拖拽占位符</li>
          <li>🔒 拖拽约束控制</li>
          <li>📊 排序变更事件</li>
          <li>🔄 自动滚动支持</li>
          <li>⚡ 高性能拖拽</li>
        </ul>
      </div>

      <div class="controls">
        <h3>拖拽控制</h3>
        <button class="btn" onclick="toggleDragSort()">
          <span id="dragSortText">禁用拖拽</span>
        </button>
        <button class="btn" onclick="resetOrder()">重置顺序</button>
        <button class="btn" onclick="randomizeOrder()">随机排序</button>
        <button class="btn" onclick="reverseOrder()">反向排序</button>
      </div>

      <div class="controls">
        <h3>拖拽约束</h3>
        <label>
          <input type="checkbox" id="constraintEnabled" onchange="updateConstraints()">
          启用拖拽约束
        </label>
        <div class="constraint-controls" id="constraintControls" style="display: none;">
          <label>
            允许拖拽范围: 
            <input type="number" id="constraintStart" value="0" min="0" onchange="updateConstraints()">
            -
            <input type="number" id="constraintEnd" value="10" min="0" onchange="updateConstraints()">
          </label>
        </div>
      </div>

      <div class="table-container" id="dragSortTableContainer"></div>

      <div class="info-panel">
        <h4>拖拽状态</h4>
        <div>
          拖拽状态: <span class="status" id="dragStatus">未拖拽</span>
          拖拽模式: <span class="status" id="dragMode">启用</span>
          总行数: <span class="status" id="totalRows">0</span>
        </div>
        <div>
          最后操作: <span class="status" id="lastOperation">无</span>
        </div>
      </div>

      <div class="info-panel">
        <h4>排序历史</h4>
        <div id="sortHistory" class="sort-history">
          <p>暂无排序操作</p>
        </div>
        <button class="btn btn-small" onclick="clearHistory()">清除历史</button>
      </div>

      <div class="log" id="operationLog"></div>
    </div>
  </div>

  <script type="module">
    import { Table } from '@ldesign/table'
    import '@ldesign/table/styles'
    import { sampleEmployees, basicColumns, createLogger } from './src/utils/data.js'

    let dragSortTable = null
    let sortHistory = []
    const log = createLogger('operationLog')

    // 初始化表格
    function initDragSortTable() {
      const container = document.getElementById('dragSortTableContainer')
      container.innerHTML = ''

      dragSortTable = new Table({
        container,
        columns: [
          { key: 'dragHandle', title: '拖拽', width: 60, sortable: false, render: () => '⋮⋮' },
          ...basicColumns
        ],
        data: [...sampleEmployees],
        rowKey: 'id',
        selection: {
          enabled: true,
          multiple: true,
          checkboxColumn: true
        },
        pagination: {
          enabled: true,
          pageSize: 10
        },
        dragSort: {
          enabled: true,
          handleSelector: '[data-column="dragHandle"]',
          onSortChange: handleSortChange
        }
      })

      // 绑定拖拽事件
      bindDragSortEvents()
      updateDragStatus()
      log('拖拽排序演示表格初始化完成', 'success')
    }

    // 绑定拖拽事件
    function bindDragSortEvents() {
      // 拖拽开始事件
      dragSortTable.on('drag-start', (data) => {
        document.getElementById('dragStatus').textContent = '拖拽中'
        document.getElementById('dragStatus').className = 'status warning'
        log(`开始拖拽行 ${data.fromIndex + 1}`, 'info')
      })

      // 拖拽结束事件
      dragSortTable.on('drag-end', (data) => {
        document.getElementById('dragStatus').textContent = '未拖拽'
        document.getElementById('dragStatus').className = 'status success'
        log(`拖拽结束`, 'info')
      })

      // 排序变更事件
      dragSortTable.on('sort-change', (data) => {
        log(`排序变更: 行 ${data.fromIndex + 1} → 行 ${data.toIndex + 1}`, 'success')
      })
    }

    // 处理排序变更
    function handleSortChange(data) {
      const { fromIndex, toIndex, item } = data
      
      // 记录排序历史
      const historyItem = {
        timestamp: new Date().toLocaleTimeString(),
        fromIndex: fromIndex + 1,
        toIndex: toIndex + 1,
        itemName: item.name,
        operation: `${item.name} 从第 ${fromIndex + 1} 行移动到第 ${toIndex + 1} 行`
      }
      
      sortHistory.unshift(historyItem)
      if (sortHistory.length > 10) {
        sortHistory = sortHistory.slice(0, 10)
      }
      
      updateSortHistory()
      updateDragStatus()
      
      document.getElementById('lastOperation').textContent = historyItem.operation
    }

    // 切换拖拽排序
    window.toggleDragSort = function() {
      const dragSort = dragSortTable.getDragSort()
      const isEnabled = dragSort.isEnabled()
      
      if (isEnabled) {
        dragSort.disable()
        document.getElementById('dragSortText').textContent = '启用拖拽'
        document.getElementById('dragMode').textContent = '禁用'
        document.getElementById('dragMode').className = 'status error'
        log('禁用拖拽排序', 'warning')
      } else {
        dragSort.enable()
        document.getElementById('dragSortText').textContent = '禁用拖拽'
        document.getElementById('dragMode').textContent = '启用'
        document.getElementById('dragMode').className = 'status success'
        log('启用拖拽排序', 'success')
      }
    }

    // 重置顺序
    window.resetOrder = function() {
      dragSortTable.setData([...sampleEmployees])
      log('重置为原始顺序', 'info')
      updateDragStatus()
    }

    // 随机排序
    window.randomizeOrder = function() {
      const currentData = [...dragSortTable.getData()]
      const shuffled = currentData.sort(() => Math.random() - 0.5)
      dragSortTable.setData(shuffled)
      log('应用随机排序', 'info')
      updateDragStatus()
    }

    // 反向排序
    window.reverseOrder = function() {
      const currentData = [...dragSortTable.getData()]
      const reversed = currentData.reverse()
      dragSortTable.setData(reversed)
      log('应用反向排序', 'info')
      updateDragStatus()
    }

    // 更新拖拽约束
    window.updateConstraints = function() {
      const enabled = document.getElementById('constraintEnabled').checked
      const controls = document.getElementById('constraintControls')
      
      if (enabled) {
        controls.style.display = 'block'
        const start = parseInt(document.getElementById('constraintStart').value)
        const end = parseInt(document.getElementById('constraintEnd').value)
        
        const dragSort = dragSortTable.getDragSort()
        dragSort.setConstraints({
          allowedRange: { start, end }
        })
        
        log(`设置拖拽约束: ${start}-${end}`, 'info')
      } else {
        controls.style.display = 'none'
        const dragSort = dragSortTable.getDragSort()
        dragSort.clearConstraints()
        log('清除拖拽约束', 'info')
      }
    }

    // 更新拖拽状态
    function updateDragStatus() {
      const totalRows = dragSortTable.getData().length
      document.getElementById('totalRows').textContent = totalRows
      
      // 更新约束控制的最大值
      document.getElementById('constraintEnd').max = totalRows - 1
      document.getElementById('constraintEnd').value = Math.min(
        parseInt(document.getElementById('constraintEnd').value),
        totalRows - 1
      )
    }

    // 更新排序历史
    function updateSortHistory() {
      const historyContainer = document.getElementById('sortHistory')
      
      if (sortHistory.length === 0) {
        historyContainer.innerHTML = '<p>暂无排序操作</p>'
        return
      }
      
      const historyHTML = sortHistory.map(item => `
        <div class="history-item">
          <span class="time">${item.timestamp}</span>
          <span class="operation">${item.operation}</span>
        </div>
      `).join('')
      
      historyContainer.innerHTML = historyHTML
    }

    // 清除历史
    window.clearHistory = function() {
      sortHistory = []
      updateSortHistory()
      document.getElementById('lastOperation').textContent = '无'
      log('清除排序历史', 'info')
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      initDragSortTable()
      log('页面加载完成', 'success')
    })
  </script>

  <style>
    .constraint-controls {
      margin-top: 10px;
      padding: 10px;
      background: var(--ldesign-bg-color-component);
      border-radius: var(--ls-border-radius-base);
    }

    .sort-history {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--ldesign-border-color);
      border-radius: var(--ls-border-radius-base);
      padding: 10px;
      background: var(--ldesign-bg-color-component);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid var(--ldesign-border-level-1-color);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .time {
      font-size: var(--ls-font-size-xs);
      color: var(--ldesign-text-color-secondary);
      min-width: 80px;
    }

    .operation {
      flex: 1;
      margin-left: 10px;
      font-size: var(--ls-font-size-sm);
    }

    .btn-small {
      padding: 5px 10px;
      font-size: var(--ls-font-size-xs);
    }
  </style>
</body>
</html>

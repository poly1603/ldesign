<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‹–æ‹½æ’åºç¤ºä¾‹ - LDESIGN Table</title>
  <link rel="stylesheet" href="./src/styles/main.css">
</head>
<body>
  <div class="page-header">
    <h1>ğŸ”„ æ‹–æ‹½æ’åºç¤ºä¾‹</h1>
    <p>æ¼”ç¤ºè¡¨æ ¼çš„æ‹–æ‹½æ’åºåŠŸèƒ½</p>
  </div>

  <nav class="nav">
    <div class="container">
      <ul class="nav-links">
        <li><a href="./index.html">é¦–é¡µ</a></li>
        <li><a href="./basic.html">åŸºç¡€è¡¨æ ¼</a></li>
        <li><a href="./filter.html">ç­›é€‰æœç´¢</a></li>
        <li><a href="./editable.html">å¯ç¼–è¾‘è¡¨æ ¼</a></li>
        <li><a href="./drag-sort.html" class="active">æ‹–æ‹½æ’åº</a></li>
        <li><a href="./export.html">æ•°æ®å¯¼å‡º</a></li>
        <li><a href="./theme.html">ä¸»é¢˜ç³»ç»Ÿ</a></li>
        <li><a href="./complete.html">å®Œæ•´åŠŸèƒ½</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="example-section">
      <h2>æ‹–æ‹½æ’åºæ¼”ç¤º</h2>
      <p>è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†è¡¨æ ¼çš„æ‹–æ‹½æ’åºåŠŸèƒ½ï¼Œæ”¯æŒè¡Œçš„æ‹–æ‹½é‡æ–°æ’åºã€‚</p>
      
      <div class="info-panel">
        <h4>æ‹–æ‹½ç‰¹æ€§</h4>
        <ul>
          <li>ğŸ–±ï¸ é¼ æ ‡æ‹–æ‹½æ’åº</li>
          <li>ğŸ“± è§¦æ‘¸è®¾å¤‡æ”¯æŒ</li>
          <li>ğŸ‘ï¸ æ‹–æ‹½è§†è§‰åé¦ˆ</li>
          <li>ğŸ¯ æ‹–æ‹½å ä½ç¬¦</li>
          <li>ğŸ”’ æ‹–æ‹½çº¦æŸæ§åˆ¶</li>
          <li>ğŸ“Š æ’åºå˜æ›´äº‹ä»¶</li>
          <li>ğŸ”„ è‡ªåŠ¨æ»šåŠ¨æ”¯æŒ</li>
          <li>âš¡ é«˜æ€§èƒ½æ‹–æ‹½</li>
        </ul>
      </div>

      <div class="controls">
        <h3>æ‹–æ‹½æ§åˆ¶</h3>
        <button class="btn" onclick="toggleDragSort()">
          <span id="dragSortText">ç¦ç”¨æ‹–æ‹½</span>
        </button>
        <button class="btn" onclick="resetOrder()">é‡ç½®é¡ºåº</button>
        <button class="btn" onclick="randomizeOrder()">éšæœºæ’åº</button>
        <button class="btn" onclick="reverseOrder()">åå‘æ’åº</button>
      </div>

      <div class="controls">
        <h3>æ‹–æ‹½çº¦æŸ</h3>
        <label>
          <input type="checkbox" id="constraintEnabled" onchange="updateConstraints()">
          å¯ç”¨æ‹–æ‹½çº¦æŸ
        </label>
        <div class="constraint-controls" id="constraintControls" style="display: none;">
          <label>
            å…è®¸æ‹–æ‹½èŒƒå›´: 
            <input type="number" id="constraintStart" value="0" min="0" onchange="updateConstraints()">
            -
            <input type="number" id="constraintEnd" value="10" min="0" onchange="updateConstraints()">
          </label>
        </div>
      </div>

      <div class="table-container" id="dragSortTableContainer"></div>

      <div class="info-panel">
        <h4>æ‹–æ‹½çŠ¶æ€</h4>
        <div>
          æ‹–æ‹½çŠ¶æ€: <span class="status" id="dragStatus">æœªæ‹–æ‹½</span>
          æ‹–æ‹½æ¨¡å¼: <span class="status" id="dragMode">å¯ç”¨</span>
          æ€»è¡Œæ•°: <span class="status" id="totalRows">0</span>
        </div>
        <div>
          æœ€åæ“ä½œ: <span class="status" id="lastOperation">æ— </span>
        </div>
      </div>

      <div class="info-panel">
        <h4>æ’åºå†å²</h4>
        <div id="sortHistory" class="sort-history">
          <p>æš‚æ— æ’åºæ“ä½œ</p>
        </div>
        <button class="btn btn-small" onclick="clearHistory()">æ¸…é™¤å†å²</button>
      </div>

      <div class="log" id="operationLog"></div>
    </div>
  </div>

  <script type="module">
    import { Table } from '@ldesign/table'
    import '@ldesign/table/styles'
    import { sampleEmployees, basicColumns, createLogger } from './src/utils/data.js'

    let dragSortTable = null
    let sortHistory = []
    const log = createLogger('operationLog')

    // åˆå§‹åŒ–è¡¨æ ¼
    function initDragSortTable() {
      const container = document.getElementById('dragSortTableContainer')
      container.innerHTML = ''

      dragSortTable = new Table({
        container,
        columns: [
          { key: 'dragHandle', title: 'æ‹–æ‹½', width: 60, sortable: false, render: () => 'â‹®â‹®' },
          ...basicColumns
        ],
        data: [...sampleEmployees],
        rowKey: 'id',
        selection: {
          enabled: true,
          multiple: true,
          checkboxColumn: true
        },
        pagination: {
          enabled: true,
          pageSize: 10
        },
        dragSort: {
          enabled: true,
          handleSelector: '[data-column="dragHandle"]',
          onSortChange: handleSortChange
        }
      })

      // ç»‘å®šæ‹–æ‹½äº‹ä»¶
      bindDragSortEvents()
      updateDragStatus()
      log('æ‹–æ‹½æ’åºæ¼”ç¤ºè¡¨æ ¼åˆå§‹åŒ–å®Œæˆ', 'success')
    }

    // ç»‘å®šæ‹–æ‹½äº‹ä»¶
    function bindDragSortEvents() {
      // æ‹–æ‹½å¼€å§‹äº‹ä»¶
      dragSortTable.on('drag-start', (data) => {
        document.getElementById('dragStatus').textContent = 'æ‹–æ‹½ä¸­'
        document.getElementById('dragStatus').className = 'status warning'
        log(`å¼€å§‹æ‹–æ‹½è¡Œ ${data.fromIndex + 1}`, 'info')
      })

      // æ‹–æ‹½ç»“æŸäº‹ä»¶
      dragSortTable.on('drag-end', (data) => {
        document.getElementById('dragStatus').textContent = 'æœªæ‹–æ‹½'
        document.getElementById('dragStatus').className = 'status success'
        log(`æ‹–æ‹½ç»“æŸ`, 'info')
      })

      // æ’åºå˜æ›´äº‹ä»¶
      dragSortTable.on('sort-change', (data) => {
        log(`æ’åºå˜æ›´: è¡Œ ${data.fromIndex + 1} â†’ è¡Œ ${data.toIndex + 1}`, 'success')
      })
    }

    // å¤„ç†æ’åºå˜æ›´
    function handleSortChange(data) {
      const { fromIndex, toIndex, item } = data
      
      // è®°å½•æ’åºå†å²
      const historyItem = {
        timestamp: new Date().toLocaleTimeString(),
        fromIndex: fromIndex + 1,
        toIndex: toIndex + 1,
        itemName: item.name,
        operation: `${item.name} ä»ç¬¬ ${fromIndex + 1} è¡Œç§»åŠ¨åˆ°ç¬¬ ${toIndex + 1} è¡Œ`
      }
      
      sortHistory.unshift(historyItem)
      if (sortHistory.length > 10) {
        sortHistory = sortHistory.slice(0, 10)
      }
      
      updateSortHistory()
      updateDragStatus()
      
      document.getElementById('lastOperation').textContent = historyItem.operation
    }

    // åˆ‡æ¢æ‹–æ‹½æ’åº
    window.toggleDragSort = function() {
      const dragSort = dragSortTable.getDragSort()
      const isEnabled = dragSort.isEnabled()
      
      if (isEnabled) {
        dragSort.disable()
        document.getElementById('dragSortText').textContent = 'å¯ç”¨æ‹–æ‹½'
        document.getElementById('dragMode').textContent = 'ç¦ç”¨'
        document.getElementById('dragMode').className = 'status error'
        log('ç¦ç”¨æ‹–æ‹½æ’åº', 'warning')
      } else {
        dragSort.enable()
        document.getElementById('dragSortText').textContent = 'ç¦ç”¨æ‹–æ‹½'
        document.getElementById('dragMode').textContent = 'å¯ç”¨'
        document.getElementById('dragMode').className = 'status success'
        log('å¯ç”¨æ‹–æ‹½æ’åº', 'success')
      }
    }

    // é‡ç½®é¡ºåº
    window.resetOrder = function() {
      dragSortTable.setData([...sampleEmployees])
      log('é‡ç½®ä¸ºåŸå§‹é¡ºåº', 'info')
      updateDragStatus()
    }

    // éšæœºæ’åº
    window.randomizeOrder = function() {
      const currentData = [...dragSortTable.getData()]
      const shuffled = currentData.sort(() => Math.random() - 0.5)
      dragSortTable.setData(shuffled)
      log('åº”ç”¨éšæœºæ’åº', 'info')
      updateDragStatus()
    }

    // åå‘æ’åº
    window.reverseOrder = function() {
      const currentData = [...dragSortTable.getData()]
      const reversed = currentData.reverse()
      dragSortTable.setData(reversed)
      log('åº”ç”¨åå‘æ’åº', 'info')
      updateDragStatus()
    }

    // æ›´æ–°æ‹–æ‹½çº¦æŸ
    window.updateConstraints = function() {
      const enabled = document.getElementById('constraintEnabled').checked
      const controls = document.getElementById('constraintControls')
      
      if (enabled) {
        controls.style.display = 'block'
        const start = parseInt(document.getElementById('constraintStart').value)
        const end = parseInt(document.getElementById('constraintEnd').value)
        
        const dragSort = dragSortTable.getDragSort()
        dragSort.setConstraints({
          allowedRange: { start, end }
        })
        
        log(`è®¾ç½®æ‹–æ‹½çº¦æŸ: ${start}-${end}`, 'info')
      } else {
        controls.style.display = 'none'
        const dragSort = dragSortTable.getDragSort()
        dragSort.clearConstraints()
        log('æ¸…é™¤æ‹–æ‹½çº¦æŸ', 'info')
      }
    }

    // æ›´æ–°æ‹–æ‹½çŠ¶æ€
    function updateDragStatus() {
      const totalRows = dragSortTable.getData().length
      document.getElementById('totalRows').textContent = totalRows
      
      // æ›´æ–°çº¦æŸæ§åˆ¶çš„æœ€å¤§å€¼
      document.getElementById('constraintEnd').max = totalRows - 1
      document.getElementById('constraintEnd').value = Math.min(
        parseInt(document.getElementById('constraintEnd').value),
        totalRows - 1
      )
    }

    // æ›´æ–°æ’åºå†å²
    function updateSortHistory() {
      const historyContainer = document.getElementById('sortHistory')
      
      if (sortHistory.length === 0) {
        historyContainer.innerHTML = '<p>æš‚æ— æ’åºæ“ä½œ</p>'
        return
      }
      
      const historyHTML = sortHistory.map(item => `
        <div class="history-item">
          <span class="time">${item.timestamp}</span>
          <span class="operation">${item.operation}</span>
        </div>
      `).join('')
      
      historyContainer.innerHTML = historyHTML
    }

    // æ¸…é™¤å†å²
    window.clearHistory = function() {
      sortHistory = []
      updateSortHistory()
      document.getElementById('lastOperation').textContent = 'æ— '
      log('æ¸…é™¤æ’åºå†å²', 'info')
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initDragSortTable()
      log('é¡µé¢åŠ è½½å®Œæˆ', 'success')
    })
  </script>

  <style>
    .constraint-controls {
      margin-top: 10px;
      padding: 10px;
      background: var(--ldesign-bg-color-component);
      border-radius: var(--ls-border-radius-base);
    }

    .sort-history {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--ldesign-border-color);
      border-radius: var(--ls-border-radius-base);
      padding: 10px;
      background: var(--ldesign-bg-color-component);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid var(--ldesign-border-level-1-color);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .time {
      font-size: var(--ls-font-size-xs);
      color: var(--ldesign-text-color-secondary);
      min-width: 80px;
    }

    .operation {
      flex: 1;
      margin-left: 10px;
      font-size: var(--ls-font-size-sm);
    }

    .btn-small {
      padding: 5px 10px;
      font-size: var(--ls-font-size-xs);
    }
  </style>
</body>
</html>

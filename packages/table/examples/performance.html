<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>性能测试示例 - LDESIGN Table</title>
  <link rel="stylesheet" href="./src/styles/main.css">
</head>
<body>
  <div class="page-header">
    <h1>⚡ 性能测试示例</h1>
    <p>演示表格在大数据量下的性能表现</p>
  </div>

  <nav class="nav">
    <div class="container">
      <ul class="nav-links">
        <li><a href="./index.html">首页</a></li>
        <li><a href="./basic.html">基础表格</a></li>
        <li><a href="./performance.html" class="active">性能测试</a></li>
        <li><a href="./complete.html">完整功能</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="example-section">
      <h2>性能测试演示</h2>
      <p>这个示例展示了表格在处理大量数据时的性能优化功能。</p>
      
      <div class="info-panel">
        <h4>性能特性</h4>
        <ul>
          <li>🚀 虚拟滚动支持</li>
          <li>📊 大数据量处理</li>
          <li>⚡ 增量更新</li>
          <li>🔄 懒加载机制</li>
          <li>💾 智能缓存</li>
          <li>📈 性能监控</li>
          <li>🎯 批量操作优化</li>
          <li>🔧 内存管理</li>
        </ul>
      </div>

      <div class="controls">
        <h3>数据生成</h3>
        <button class="btn" onclick="generateData(1000)">生成 1K 数据</button>
        <button class="btn" onclick="generateData(10000)">生成 10K 数据</button>
        <button class="btn" onclick="generateData(50000)">生成 50K 数据</button>
        <button class="btn" onclick="generateData(100000)">生成 100K 数据</button>
        <button class="btn btn-danger" onclick="clearData()">清空数据</button>
      </div>

      <div class="controls">
        <h3>性能优化</h3>
        <label>
          <input type="checkbox" id="virtualScrollEnabled" checked onchange="toggleVirtualScroll()">
          启用虚拟滚动
        </label>
        <label>
          <input type="checkbox" id="lazyLoadEnabled" checked onchange="toggleLazyLoad()">
          启用懒加载
        </label>
        <label>
          <input type="checkbox" id="cacheEnabled" checked onchange="toggleCache()">
          启用缓存
        </label>
        <label>
          <input type="checkbox" id="incrementalEnabled" checked onchange="toggleIncremental()">
          启用增量更新
        </label>
      </div>

      <div class="controls">
        <h3>批量操作</h3>
        <button class="btn" onclick="batchAdd(1000)">批量添加 1K</button>
        <button class="btn" onclick="batchUpdate(1000)">批量更新 1K</button>
        <button class="btn" onclick="batchDelete(1000)">批量删除 1K</button>
        <button class="btn" onclick="performanceTest()">性能测试</button>
      </div>

      <div class="table-container" id="performanceTableContainer"></div>

      <div class="info-panel">
        <h4>性能指标</h4>
        <div class="metrics-grid">
          <div class="metric">
            <span class="metric-label">数据量:</span>
            <span class="metric-value" id="dataCount">0</span>
          </div>
          <div class="metric">
            <span class="metric-label">渲染时间:</span>
            <span class="metric-value" id="renderTime">0ms</span>
          </div>
          <div class="metric">
            <span class="metric-label">内存使用:</span>
            <span class="metric-value" id="memoryUsage">0MB</span>
          </div>
          <div class="metric">
            <span class="metric-label">缓存命中率:</span>
            <span class="metric-value" id="cacheHitRate">0%</span>
          </div>
          <div class="metric">
            <span class="metric-label">FPS:</span>
            <span class="metric-value" id="fps">60</span>
          </div>
          <div class="metric">
            <span class="metric-label">滚动性能:</span>
            <span class="metric-value" id="scrollPerf">优秀</span>
          </div>
        </div>
      </div>

      <div class="info-panel">
        <h4>性能图表</h4>
        <div class="performance-chart">
          <canvas id="performanceChart" width="600" height="200"></canvas>
        </div>
      </div>

      <div class="log" id="operationLog"></div>
    </div>
  </div>

  <script type="module">
    import { Table } from '@ldesign/table'
    import '@ldesign/table/styles'
    import { createLogger } from './src/utils/data.js'

    let performanceTable = null
    let performanceData = []
    let performanceMetrics = []
    const log = createLogger('operationLog')

    // 性能监控
    let fpsCounter = 0
    let lastTime = performance.now()

    // 初始化表格
    function initPerformanceTable() {
      const container = document.getElementById('performanceTableContainer')
      container.innerHTML = ''

      const columns = [
        { key: 'id', title: 'ID', width: 80, sortable: true },
        { key: 'name', title: '姓名', width: 120, sortable: true },
        { key: 'email', title: '邮箱', width: 200, sortable: true },
        { key: 'department', title: '部门', width: 120, sortable: true },
        { key: 'position', title: '职位', width: 120, sortable: true },
        { key: 'salary', title: '薪资', width: 100, sortable: true, render: (value) => `¥${value}` },
        { key: 'joinDate', title: '入职日期', width: 120, sortable: true },
        { key: 'status', title: '状态', width: 80 }
      ]

      performanceTable = new Table({
        container,
        columns,
        data: performanceData,
        rowKey: 'id',
        pagination: {
          enabled: true,
          pageSize: 50
        },
        virtualScroll: {
          enabled: true,
          itemHeight: 40,
          bufferSize: 10
        },
        selection: {
          enabled: true,
          multiple: true,
          checkboxColumn: true
        },
        sorting: {
          enabled: true
        },
        performance: {
          lazyLoad: true,
          cache: true,
          incremental: true
        }
      })

      // 绑定性能事件
      bindPerformanceEvents()
      startPerformanceMonitoring()
      log('性能测试表格初始化完成', 'success')
    }

    // 绑定性能事件
    function bindPerformanceEvents() {
      performanceTable.on('render-start', () => {
        window.renderStartTime = performance.now()
      })

      performanceTable.on('render-complete', () => {
        const renderTime = performance.now() - window.renderStartTime
        document.getElementById('renderTime').textContent = `${renderTime.toFixed(2)}ms`
        
        // 记录性能指标
        recordPerformanceMetric('render', renderTime)
        log(`渲染完成，耗时: ${renderTime.toFixed(2)}ms`, 'info')
      })

      performanceTable.on('data-change', (data) => {
        updateDataCount()
        log(`数据变更: ${data.type} - ${data.count || 1} 条记录`, 'info')
      })

      performanceTable.on('performance-update', (metrics) => {
        updatePerformanceMetrics(metrics)
      })
    }

    // 生成测试数据
    window.generateData = function(count) {
      const startTime = performance.now()
      
      performanceData = []
      const departments = ['技术部', '市场部', '人事部', '财务部', '运营部']
      const positions = ['工程师', '经理', '专员', '主管', '总监']
      const statuses = ['在职', '试用', '离职']

      for (let i = 1; i <= count; i++) {
        performanceData.push({
          id: i,
          name: `员工${i}`,
          email: `user${i}@company.com`,
          department: departments[Math.floor(Math.random() * departments.length)],
          position: positions[Math.floor(Math.random() * positions.length)],
          salary: Math.floor(Math.random() * 50000) + 5000,
          joinDate: new Date(2020 + Math.floor(Math.random() * 4), Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
          status: statuses[Math.floor(Math.random() * statuses.length)]
        })
      }

      const generateTime = performance.now() - startTime
      performanceTable.setData(performanceData)
      
      log(`生成 ${count.toLocaleString()} 条数据，耗时: ${generateTime.toFixed(2)}ms`, 'success')
      updateDataCount()
      recordPerformanceMetric('generate', generateTime)
    }

    // 清空数据
    window.clearData = function() {
      performanceData = []
      performanceTable.setData([])
      updateDataCount()
      log('清空所有数据', 'info')
    }

    // 批量添加
    window.batchAdd = function(count) {
      const startTime = performance.now()
      const newData = []
      const startId = performanceData.length + 1

      for (let i = 0; i < count; i++) {
        newData.push({
          id: startId + i,
          name: `新员工${startId + i}`,
          email: `newuser${startId + i}@company.com`,
          department: '技术部',
          position: '工程师',
          salary: 8000,
          joinDate: new Date().toISOString().split('T')[0],
          status: '在职'
        })
      }

      performanceData.push(...newData)
      performanceTable.addRows(newData)
      
      const addTime = performance.now() - startTime
      log(`批量添加 ${count} 条数据，耗时: ${addTime.toFixed(2)}ms`, 'success')
      recordPerformanceMetric('batchAdd', addTime)
    }

    // 批量更新
    window.batchUpdate = function(count) {
      if (performanceData.length === 0) return

      const startTime = performance.now()
      const updateCount = Math.min(count, performanceData.length)
      
      for (let i = 0; i < updateCount; i++) {
        const randomIndex = Math.floor(Math.random() * performanceData.length)
        performanceData[randomIndex].salary = Math.floor(Math.random() * 50000) + 5000
        performanceTable.updateRow(performanceData[randomIndex].id, performanceData[randomIndex])
      }

      const updateTime = performance.now() - startTime
      log(`批量更新 ${updateCount} 条数据，耗时: ${updateTime.toFixed(2)}ms`, 'success')
      recordPerformanceMetric('batchUpdate', updateTime)
    }

    // 批量删除
    window.batchDelete = function(count) {
      if (performanceData.length === 0) return

      const startTime = performance.now()
      const deleteCount = Math.min(count, performanceData.length)
      const toDelete = performanceData.slice(0, deleteCount)
      
      performanceData = performanceData.slice(deleteCount)
      toDelete.forEach(item => performanceTable.removeRow(item.id))

      const deleteTime = performance.now() - startTime
      log(`批量删除 ${deleteCount} 条数据，耗时: ${deleteTime.toFixed(2)}ms`, 'success')
      recordPerformanceMetric('batchDelete', deleteTime)
    }

    // 性能测试
    window.performanceTest = function() {
      log('开始性能测试...', 'info')
      
      // 测试序列
      const tests = [
        () => generateData(10000),
        () => new Promise(resolve => setTimeout(() => { batchAdd(5000); resolve(); }, 100)),
        () => new Promise(resolve => setTimeout(() => { batchUpdate(3000); resolve(); }, 100)),
        () => new Promise(resolve => setTimeout(() => { batchDelete(2000); resolve(); }, 100))
      ]

      let testIndex = 0
      function runNextTest() {
        if (testIndex < tests.length) {
          const result = tests[testIndex]()
          testIndex++
          
          if (result instanceof Promise) {
            result.then(() => setTimeout(runNextTest, 100))
          } else {
            setTimeout(runNextTest, 100)
          }
        } else {
          log('性能测试完成', 'success')
        }
      }

      runNextTest()
    }

    // 切换功能
    window.toggleVirtualScroll = function() {
      const enabled = document.getElementById('virtualScrollEnabled').checked
      // 这里应该重新初始化表格以应用虚拟滚动设置
      log(`${enabled ? '启用' : '禁用'}虚拟滚动`, 'info')
    }

    window.toggleLazyLoad = function() {
      const enabled = document.getElementById('lazyLoadEnabled').checked
      log(`${enabled ? '启用' : '禁用'}懒加载`, 'info')
    }

    window.toggleCache = function() {
      const enabled = document.getElementById('cacheEnabled').checked
      log(`${enabled ? '启用' : '禁用'}缓存`, 'info')
    }

    window.toggleIncremental = function() {
      const enabled = document.getElementById('incrementalEnabled').checked
      log(`${enabled ? '启用' : '禁用'}增量更新`, 'info')
    }

    // 更新数据计数
    function updateDataCount() {
      document.getElementById('dataCount').textContent = performanceData.length.toLocaleString()
    }

    // 记录性能指标
    function recordPerformanceMetric(type, value) {
      performanceMetrics.push({
        type,
        value,
        timestamp: Date.now()
      })
      
      // 保持最近100个指标
      if (performanceMetrics.length > 100) {
        performanceMetrics = performanceMetrics.slice(-100)
      }
      
      updatePerformanceChart()
    }

    // 更新性能指标
    function updatePerformanceMetrics(metrics) {
      if (metrics.cacheHitRate !== undefined) {
        document.getElementById('cacheHitRate').textContent = `${(metrics.cacheHitRate * 100).toFixed(1)}%`
      }
      if (metrics.memoryUsage !== undefined) {
        document.getElementById('memoryUsage').textContent = `${(metrics.memoryUsage / 1024 / 1024).toFixed(1)}MB`
      }
    }

    // 开始性能监控
    function startPerformanceMonitoring() {
      function updateFPS() {
        fpsCounter++
        const currentTime = performance.now()
        
        if (currentTime - lastTime >= 1000) {
          document.getElementById('fps').textContent = fpsCounter
          fpsCounter = 0
          lastTime = currentTime
          
          // 更新滚动性能评级
          const fps = parseInt(document.getElementById('fps').textContent)
          let perfRating = 'excellent'
          if (fps < 30) perfRating = 'poor'
          else if (fps < 45) perfRating = 'fair'
          else if (fps < 55) perfRating = 'good'
          
          const perfText = { excellent: '优秀', good: '良好', fair: '一般', poor: '较差' }
          document.getElementById('scrollPerf').textContent = perfText[perfRating]
        }
        
        requestAnimationFrame(updateFPS)
      }
      
      requestAnimationFrame(updateFPS)
    }

    // 更新性能图表
    function updatePerformanceChart() {
      const canvas = document.getElementById('performanceChart')
      const ctx = canvas.getContext('2d')
      
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      
      if (performanceMetrics.length === 0) return
      
      const maxValue = Math.max(...performanceMetrics.map(m => m.value))
      const width = canvas.width
      const height = canvas.height
      
      ctx.strokeStyle = '#722ED1'
      ctx.lineWidth = 2
      ctx.beginPath()
      
      performanceMetrics.forEach((metric, index) => {
        const x = (index / (performanceMetrics.length - 1)) * width
        const y = height - (metric.value / maxValue) * height
        
        if (index === 0) {
          ctx.moveTo(x, y)
        } else {
          ctx.lineTo(x, y)
        }
      })
      
      ctx.stroke()
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      initPerformanceTable()
      generateData(1000) // 初始生成1K数据
      log('页面加载完成', 'success')
    })
  </script>

  <style>
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .metric {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      background: var(--ldesign-bg-color-component);
      border-radius: var(--ls-border-radius-base);
      border: 1px solid var(--ldesign-border-color);
    }

    .metric-label {
      font-size: var(--ls-font-size-xs);
      color: var(--ldesign-text-color-secondary);
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: var(--ls-font-size-lg);
      font-weight: bold;
      color: var(--ldesign-brand-color);
    }

    .performance-chart {
      border: 1px solid var(--ldesign-border-color);
      border-radius: var(--ls-border-radius-base);
      padding: 10px;
      background: var(--ldesign-bg-color-component);
    }

    .btn-danger {
      background: var(--ldesign-error-color);
      color: white;
      border: none;
    }

    .btn-danger:hover {
      background: var(--ldesign-error-color-hover);
    }
  </style>
</body>
</html>

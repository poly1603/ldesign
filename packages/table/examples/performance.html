<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€§èƒ½æµ‹è¯•ç¤ºä¾‹ - LDESIGN Table</title>
  <link rel="stylesheet" href="./src/styles/main.css">
</head>
<body>
  <div class="page-header">
    <h1>âš¡ æ€§èƒ½æµ‹è¯•ç¤ºä¾‹</h1>
    <p>æ¼”ç¤ºè¡¨æ ¼åœ¨å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½è¡¨ç°</p>
  </div>

  <nav class="nav">
    <div class="container">
      <ul class="nav-links">
        <li><a href="./index.html">é¦–é¡µ</a></li>
        <li><a href="./basic.html">åŸºç¡€è¡¨æ ¼</a></li>
        <li><a href="./performance.html" class="active">æ€§èƒ½æµ‹è¯•</a></li>
        <li><a href="./complete.html">å®Œæ•´åŠŸèƒ½</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="example-section">
      <h2>æ€§èƒ½æµ‹è¯•æ¼”ç¤º</h2>
      <p>è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†è¡¨æ ¼åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶çš„æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½ã€‚</p>
      
      <div class="info-panel">
        <h4>æ€§èƒ½ç‰¹æ€§</h4>
        <ul>
          <li>ğŸš€ è™šæ‹Ÿæ»šåŠ¨æ”¯æŒ</li>
          <li>ğŸ“Š å¤§æ•°æ®é‡å¤„ç†</li>
          <li>âš¡ å¢é‡æ›´æ–°</li>
          <li>ğŸ”„ æ‡’åŠ è½½æœºåˆ¶</li>
          <li>ğŸ’¾ æ™ºèƒ½ç¼“å­˜</li>
          <li>ğŸ“ˆ æ€§èƒ½ç›‘æ§</li>
          <li>ğŸ¯ æ‰¹é‡æ“ä½œä¼˜åŒ–</li>
          <li>ğŸ”§ å†…å­˜ç®¡ç†</li>
        </ul>
      </div>

      <div class="controls">
        <h3>æ•°æ®ç”Ÿæˆ</h3>
        <button class="btn" onclick="generateData(1000)">ç”Ÿæˆ 1K æ•°æ®</button>
        <button class="btn" onclick="generateData(10000)">ç”Ÿæˆ 10K æ•°æ®</button>
        <button class="btn" onclick="generateData(50000)">ç”Ÿæˆ 50K æ•°æ®</button>
        <button class="btn" onclick="generateData(100000)">ç”Ÿæˆ 100K æ•°æ®</button>
        <button class="btn btn-danger" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
      </div>

      <div class="controls">
        <h3>æ€§èƒ½ä¼˜åŒ–</h3>
        <label>
          <input type="checkbox" id="virtualScrollEnabled" checked onchange="toggleVirtualScroll()">
          å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
        </label>
        <label>
          <input type="checkbox" id="lazyLoadEnabled" checked onchange="toggleLazyLoad()">
          å¯ç”¨æ‡’åŠ è½½
        </label>
        <label>
          <input type="checkbox" id="cacheEnabled" checked onchange="toggleCache()">
          å¯ç”¨ç¼“å­˜
        </label>
        <label>
          <input type="checkbox" id="incrementalEnabled" checked onchange="toggleIncremental()">
          å¯ç”¨å¢é‡æ›´æ–°
        </label>
      </div>

      <div class="controls">
        <h3>æ‰¹é‡æ“ä½œ</h3>
        <button class="btn" onclick="batchAdd(1000)">æ‰¹é‡æ·»åŠ  1K</button>
        <button class="btn" onclick="batchUpdate(1000)">æ‰¹é‡æ›´æ–° 1K</button>
        <button class="btn" onclick="batchDelete(1000)">æ‰¹é‡åˆ é™¤ 1K</button>
        <button class="btn" onclick="performanceTest()">æ€§èƒ½æµ‹è¯•</button>
      </div>

      <div class="table-container" id="performanceTableContainer"></div>

      <div class="info-panel">
        <h4>æ€§èƒ½æŒ‡æ ‡</h4>
        <div class="metrics-grid">
          <div class="metric">
            <span class="metric-label">æ•°æ®é‡:</span>
            <span class="metric-value" id="dataCount">0</span>
          </div>
          <div class="metric">
            <span class="metric-label">æ¸²æŸ“æ—¶é—´:</span>
            <span class="metric-value" id="renderTime">0ms</span>
          </div>
          <div class="metric">
            <span class="metric-label">å†…å­˜ä½¿ç”¨:</span>
            <span class="metric-value" id="memoryUsage">0MB</span>
          </div>
          <div class="metric">
            <span class="metric-label">ç¼“å­˜å‘½ä¸­ç‡:</span>
            <span class="metric-value" id="cacheHitRate">0%</span>
          </div>
          <div class="metric">
            <span class="metric-label">FPS:</span>
            <span class="metric-value" id="fps">60</span>
          </div>
          <div class="metric">
            <span class="metric-label">æ»šåŠ¨æ€§èƒ½:</span>
            <span class="metric-value" id="scrollPerf">ä¼˜ç§€</span>
          </div>
        </div>
      </div>

      <div class="info-panel">
        <h4>æ€§èƒ½å›¾è¡¨</h4>
        <div class="performance-chart">
          <canvas id="performanceChart" width="600" height="200"></canvas>
        </div>
      </div>

      <div class="log" id="operationLog"></div>
    </div>
  </div>

  <script type="module">
    import { Table } from '@ldesign/table'
    import '@ldesign/table/styles'
    import { createLogger } from './src/utils/data.js'

    let performanceTable = null
    let performanceData = []
    let performanceMetrics = []
    const log = createLogger('operationLog')

    // æ€§èƒ½ç›‘æ§
    let fpsCounter = 0
    let lastTime = performance.now()

    // åˆå§‹åŒ–è¡¨æ ¼
    function initPerformanceTable() {
      const container = document.getElementById('performanceTableContainer')
      container.innerHTML = ''

      const columns = [
        { key: 'id', title: 'ID', width: 80, sortable: true },
        { key: 'name', title: 'å§“å', width: 120, sortable: true },
        { key: 'email', title: 'é‚®ç®±', width: 200, sortable: true },
        { key: 'department', title: 'éƒ¨é—¨', width: 120, sortable: true },
        { key: 'position', title: 'èŒä½', width: 120, sortable: true },
        { key: 'salary', title: 'è–ªèµ„', width: 100, sortable: true, render: (value) => `Â¥${value}` },
        { key: 'joinDate', title: 'å…¥èŒæ—¥æœŸ', width: 120, sortable: true },
        { key: 'status', title: 'çŠ¶æ€', width: 80 }
      ]

      performanceTable = new Table({
        container,
        columns,
        data: performanceData,
        rowKey: 'id',
        pagination: {
          enabled: true,
          pageSize: 50
        },
        virtualScroll: {
          enabled: true,
          itemHeight: 40,
          bufferSize: 10
        },
        selection: {
          enabled: true,
          multiple: true,
          checkboxColumn: true
        },
        sorting: {
          enabled: true
        },
        performance: {
          lazyLoad: true,
          cache: true,
          incremental: true
        }
      })

      // ç»‘å®šæ€§èƒ½äº‹ä»¶
      bindPerformanceEvents()
      startPerformanceMonitoring()
      log('æ€§èƒ½æµ‹è¯•è¡¨æ ¼åˆå§‹åŒ–å®Œæˆ', 'success')
    }

    // ç»‘å®šæ€§èƒ½äº‹ä»¶
    function bindPerformanceEvents() {
      performanceTable.on('render-start', () => {
        window.renderStartTime = performance.now()
      })

      performanceTable.on('render-complete', () => {
        const renderTime = performance.now() - window.renderStartTime
        document.getElementById('renderTime').textContent = `${renderTime.toFixed(2)}ms`
        
        // è®°å½•æ€§èƒ½æŒ‡æ ‡
        recordPerformanceMetric('render', renderTime)
        log(`æ¸²æŸ“å®Œæˆï¼Œè€—æ—¶: ${renderTime.toFixed(2)}ms`, 'info')
      })

      performanceTable.on('data-change', (data) => {
        updateDataCount()
        log(`æ•°æ®å˜æ›´: ${data.type} - ${data.count || 1} æ¡è®°å½•`, 'info')
      })

      performanceTable.on('performance-update', (metrics) => {
        updatePerformanceMetrics(metrics)
      })
    }

    // ç”Ÿæˆæµ‹è¯•æ•°æ®
    window.generateData = function(count) {
      const startTime = performance.now()
      
      performanceData = []
      const departments = ['æŠ€æœ¯éƒ¨', 'å¸‚åœºéƒ¨', 'äººäº‹éƒ¨', 'è´¢åŠ¡éƒ¨', 'è¿è¥éƒ¨']
      const positions = ['å·¥ç¨‹å¸ˆ', 'ç»ç†', 'ä¸“å‘˜', 'ä¸»ç®¡', 'æ€»ç›‘']
      const statuses = ['åœ¨èŒ', 'è¯•ç”¨', 'ç¦»èŒ']

      for (let i = 1; i <= count; i++) {
        performanceData.push({
          id: i,
          name: `å‘˜å·¥${i}`,
          email: `user${i}@company.com`,
          department: departments[Math.floor(Math.random() * departments.length)],
          position: positions[Math.floor(Math.random() * positions.length)],
          salary: Math.floor(Math.random() * 50000) + 5000,
          joinDate: new Date(2020 + Math.floor(Math.random() * 4), Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
          status: statuses[Math.floor(Math.random() * statuses.length)]
        })
      }

      const generateTime = performance.now() - startTime
      performanceTable.setData(performanceData)
      
      log(`ç”Ÿæˆ ${count.toLocaleString()} æ¡æ•°æ®ï¼Œè€—æ—¶: ${generateTime.toFixed(2)}ms`, 'success')
      updateDataCount()
      recordPerformanceMetric('generate', generateTime)
    }

    // æ¸…ç©ºæ•°æ®
    window.clearData = function() {
      performanceData = []
      performanceTable.setData([])
      updateDataCount()
      log('æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'info')
    }

    // æ‰¹é‡æ·»åŠ 
    window.batchAdd = function(count) {
      const startTime = performance.now()
      const newData = []
      const startId = performanceData.length + 1

      for (let i = 0; i < count; i++) {
        newData.push({
          id: startId + i,
          name: `æ–°å‘˜å·¥${startId + i}`,
          email: `newuser${startId + i}@company.com`,
          department: 'æŠ€æœ¯éƒ¨',
          position: 'å·¥ç¨‹å¸ˆ',
          salary: 8000,
          joinDate: new Date().toISOString().split('T')[0],
          status: 'åœ¨èŒ'
        })
      }

      performanceData.push(...newData)
      performanceTable.addRows(newData)
      
      const addTime = performance.now() - startTime
      log(`æ‰¹é‡æ·»åŠ  ${count} æ¡æ•°æ®ï¼Œè€—æ—¶: ${addTime.toFixed(2)}ms`, 'success')
      recordPerformanceMetric('batchAdd', addTime)
    }

    // æ‰¹é‡æ›´æ–°
    window.batchUpdate = function(count) {
      if (performanceData.length === 0) return

      const startTime = performance.now()
      const updateCount = Math.min(count, performanceData.length)
      
      for (let i = 0; i < updateCount; i++) {
        const randomIndex = Math.floor(Math.random() * performanceData.length)
        performanceData[randomIndex].salary = Math.floor(Math.random() * 50000) + 5000
        performanceTable.updateRow(performanceData[randomIndex].id, performanceData[randomIndex])
      }

      const updateTime = performance.now() - startTime
      log(`æ‰¹é‡æ›´æ–° ${updateCount} æ¡æ•°æ®ï¼Œè€—æ—¶: ${updateTime.toFixed(2)}ms`, 'success')
      recordPerformanceMetric('batchUpdate', updateTime)
    }

    // æ‰¹é‡åˆ é™¤
    window.batchDelete = function(count) {
      if (performanceData.length === 0) return

      const startTime = performance.now()
      const deleteCount = Math.min(count, performanceData.length)
      const toDelete = performanceData.slice(0, deleteCount)
      
      performanceData = performanceData.slice(deleteCount)
      toDelete.forEach(item => performanceTable.removeRow(item.id))

      const deleteTime = performance.now() - startTime
      log(`æ‰¹é‡åˆ é™¤ ${deleteCount} æ¡æ•°æ®ï¼Œè€—æ—¶: ${deleteTime.toFixed(2)}ms`, 'success')
      recordPerformanceMetric('batchDelete', deleteTime)
    }

    // æ€§èƒ½æµ‹è¯•
    window.performanceTest = function() {
      log('å¼€å§‹æ€§èƒ½æµ‹è¯•...', 'info')
      
      // æµ‹è¯•åºåˆ—
      const tests = [
        () => generateData(10000),
        () => new Promise(resolve => setTimeout(() => { batchAdd(5000); resolve(); }, 100)),
        () => new Promise(resolve => setTimeout(() => { batchUpdate(3000); resolve(); }, 100)),
        () => new Promise(resolve => setTimeout(() => { batchDelete(2000); resolve(); }, 100))
      ]

      let testIndex = 0
      function runNextTest() {
        if (testIndex < tests.length) {
          const result = tests[testIndex]()
          testIndex++
          
          if (result instanceof Promise) {
            result.then(() => setTimeout(runNextTest, 100))
          } else {
            setTimeout(runNextTest, 100)
          }
        } else {
          log('æ€§èƒ½æµ‹è¯•å®Œæˆ', 'success')
        }
      }

      runNextTest()
    }

    // åˆ‡æ¢åŠŸèƒ½
    window.toggleVirtualScroll = function() {
      const enabled = document.getElementById('virtualScrollEnabled').checked
      // è¿™é‡Œåº”è¯¥é‡æ–°åˆå§‹åŒ–è¡¨æ ¼ä»¥åº”ç”¨è™šæ‹Ÿæ»šåŠ¨è®¾ç½®
      log(`${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}è™šæ‹Ÿæ»šåŠ¨`, 'info')
    }

    window.toggleLazyLoad = function() {
      const enabled = document.getElementById('lazyLoadEnabled').checked
      log(`${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}æ‡’åŠ è½½`, 'info')
    }

    window.toggleCache = function() {
      const enabled = document.getElementById('cacheEnabled').checked
      log(`${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}ç¼“å­˜`, 'info')
    }

    window.toggleIncremental = function() {
      const enabled = document.getElementById('incrementalEnabled').checked
      log(`${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}å¢é‡æ›´æ–°`, 'info')
    }

    // æ›´æ–°æ•°æ®è®¡æ•°
    function updateDataCount() {
      document.getElementById('dataCount').textContent = performanceData.length.toLocaleString()
    }

    // è®°å½•æ€§èƒ½æŒ‡æ ‡
    function recordPerformanceMetric(type, value) {
      performanceMetrics.push({
        type,
        value,
        timestamp: Date.now()
      })
      
      // ä¿æŒæœ€è¿‘100ä¸ªæŒ‡æ ‡
      if (performanceMetrics.length > 100) {
        performanceMetrics = performanceMetrics.slice(-100)
      }
      
      updatePerformanceChart()
    }

    // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
    function updatePerformanceMetrics(metrics) {
      if (metrics.cacheHitRate !== undefined) {
        document.getElementById('cacheHitRate').textContent = `${(metrics.cacheHitRate * 100).toFixed(1)}%`
      }
      if (metrics.memoryUsage !== undefined) {
        document.getElementById('memoryUsage').textContent = `${(metrics.memoryUsage / 1024 / 1024).toFixed(1)}MB`
      }
    }

    // å¼€å§‹æ€§èƒ½ç›‘æ§
    function startPerformanceMonitoring() {
      function updateFPS() {
        fpsCounter++
        const currentTime = performance.now()
        
        if (currentTime - lastTime >= 1000) {
          document.getElementById('fps').textContent = fpsCounter
          fpsCounter = 0
          lastTime = currentTime
          
          // æ›´æ–°æ»šåŠ¨æ€§èƒ½è¯„çº§
          const fps = parseInt(document.getElementById('fps').textContent)
          let perfRating = 'excellent'
          if (fps < 30) perfRating = 'poor'
          else if (fps < 45) perfRating = 'fair'
          else if (fps < 55) perfRating = 'good'
          
          const perfText = { excellent: 'ä¼˜ç§€', good: 'è‰¯å¥½', fair: 'ä¸€èˆ¬', poor: 'è¾ƒå·®' }
          document.getElementById('scrollPerf').textContent = perfText[perfRating]
        }
        
        requestAnimationFrame(updateFPS)
      }
      
      requestAnimationFrame(updateFPS)
    }

    // æ›´æ–°æ€§èƒ½å›¾è¡¨
    function updatePerformanceChart() {
      const canvas = document.getElementById('performanceChart')
      const ctx = canvas.getContext('2d')
      
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      
      if (performanceMetrics.length === 0) return
      
      const maxValue = Math.max(...performanceMetrics.map(m => m.value))
      const width = canvas.width
      const height = canvas.height
      
      ctx.strokeStyle = '#722ED1'
      ctx.lineWidth = 2
      ctx.beginPath()
      
      performanceMetrics.forEach((metric, index) => {
        const x = (index / (performanceMetrics.length - 1)) * width
        const y = height - (metric.value / maxValue) * height
        
        if (index === 0) {
          ctx.moveTo(x, y)
        } else {
          ctx.lineTo(x, y)
        }
      })
      
      ctx.stroke()
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initPerformanceTable()
      generateData(1000) // åˆå§‹ç”Ÿæˆ1Kæ•°æ®
      log('é¡µé¢åŠ è½½å®Œæˆ', 'success')
    })
  </script>

  <style>
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .metric {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      background: var(--ldesign-bg-color-component);
      border-radius: var(--ls-border-radius-base);
      border: 1px solid var(--ldesign-border-color);
    }

    .metric-label {
      font-size: var(--ls-font-size-xs);
      color: var(--ldesign-text-color-secondary);
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: var(--ls-font-size-lg);
      font-weight: bold;
      color: var(--ldesign-brand-color);
    }

    .performance-chart {
      border: 1px solid var(--ldesign-border-color);
      border-radius: var(--ls-border-radius-base);
      padding: 10px;
      background: var(--ldesign-bg-color-component);
    }

    .btn-danger {
      background: var(--ldesign-error-color);
      color: white;
      border: none;
    }

    .btn-danger:hover {
      background: var(--ldesign-error-color-hover);
    }
  </style>
</body>
</html>

# @ldesign/crypto 架构设计

## 整体架构

### 1. 分层架构设计

```
┌─────────────────────────────────────────┐
│              应用层 (Application)        │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │ Vue Plugin  │  │ React Hooks     │   │
│  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────┤
│              适配层 (Adapter)           │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │ Vue Adapter │  │ React Adapter   │   │
│  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────┤
│              服务层 (Service)           │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │ CryptoManager│  │ HashManager     │   │
│  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────┤
│              算法层 (Algorithm)         │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │ AES         │  │ Hash            │   │
│  │ DES         │  │ Encoding        │   │
│  │ Blowfish    │  │ Utils           │   │
│  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────┤
│              基础层 (Foundation)        │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │ crypto-js   │  │ Types           │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
```

### 2. 模块依赖关系

```
index.ts (主入口)
├── core/
│   └── crypto.ts (核心管理器)
├── algorithms/
│   ├── aes.ts
│   ├── des.ts
│   ├── tripledes.ts
│   ├── blowfish.ts
│   ├── hash.ts
│   └── encoding.ts
├── utils/
│   └── index.ts (工具函数)
├── types/
│   └── index.ts (类型定义)
└── adapt/
    └── vue/
        ├── composables/
        ├── plugin.ts
        └── index.ts
```

## 核心组件设计

### 1. 算法层 (Algorithm Layer)

#### AES 加密算法
```typescript
class AESEncryptor {
  private defaultOptions: AESOptions = {
    keySize: 256,
    mode: 'CBC',
    iv: undefined
  }

  encrypt(data: string, key: string, options?: AESOptions): EncryptResult
  decrypt(encryptedData: string | EncryptResult, key: string, options?: AESOptions): DecryptResult

  private prepareKey(key: string, keySize: AESKeySize): CryptoJS.lib.WordArray
  private getMode(mode: AESMode): any
}
```

#### 哈希算法
```typescript
class HashProcessor {
  hash(data: string, algorithm: HashAlgorithm, options?: HashOptions): HashResult
  hmac(data: string, key: string, algorithm: HMACAlgorithm, options?: HMACOptions): HashResult
  verify(data: string, expectedHash: string, algorithm: HashAlgorithm): boolean

  private getHashFunction(algorithm: HashAlgorithm): Function
  private formatOutput(hash: CryptoJS.lib.WordArray, encoding: EncodingType): string
}
```

#### 编码算法
```typescript
class EncodingProcessor {
  encode(data: string, encoding: EncodingType): string
  decode(encodedData: string, encoding: EncodingType): string

  private encodeBase64(data: string): string
  private decodeBase64(data: string): string
  private encodeHex(data: string): string
  private decodeHex(data: string): string
}
```

### 2. 服务层 (Service Layer)

#### 加密管理器
```typescript
class CryptoManager {
  private aes: AESEncryptor
  private des: DESEncryptor
  private hash: HashProcessor
  private encoding: EncodingProcessor

  constructor(config?: CryptoConfig)

  // 统一的加密接口
  encrypt(algorithm: string, data: string, key: string, options?: any): EncryptResult
  decrypt(algorithm: string, encryptedData: string | EncryptResult, key: string, options?: any): DecryptResult

  // 便捷方法
  aes: AESEncryptor
  hash: HashProcessor
  encoding: EncodingProcessor
}
```

### 3. 适配层 (Adapter Layer)

#### Vue 适配器
```typescript
// Composition API
export function useCrypto() {
  const loading = ref(false)
  const error = ref<string | null>(null)

  const encrypt = {
    aes: (data: string, key: string, options?: AESOptions) => {
      // 实现逻辑
    }
  }

  const decrypt = {
    aes: (encryptedData: string | EncryptResult, key: string, options?: AESOptions) => {
      // 实现逻辑
    }
  }

  return { encrypt, decrypt, loading, error }
}

// Plugin
export const CryptoPlugin: Plugin = {
  install(app: App, options?: CryptoPluginOptions) {
    const crypto = new CryptoManager(options)
    app.config.globalProperties.$crypto = crypto
    app.provide('crypto', crypto)
  }
}
```

## 数据流设计

### 1. 加密数据流

```
用户输入 → 参数验证 → 密钥处理 → 算法执行 → 结果格式化 → 返回结果
    ↓           ↓           ↓           ↓           ↓           ↓
  原始数据   → 验证通过   → 密钥派生   → 加密操作   → 统一格式   → EncryptResult
```

### 2. 解密数据流

```
加密数据 → 格式解析 → 参数提取 → 密钥处理 → 算法执行 → 结果验证 → 返回结果
    ↓           ↓           ↓           ↓           ↓           ↓           ↓
  密文输入   → 解析成功   → 获取IV等  → 密钥派生   → 解密操作   → 验证成功   → DecryptResult
```

### 3. 错误处理流

```
操作失败 → 错误分类 → 错误包装 → 日志记录 → 返回错误结果
    ↓           ↓           ↓           ↓           ↓
  异常捕获   → 确定类型   → 统一格式   → 调试信息   → ErrorResult
```

## 接口设计

### 1. 统一结果接口

```typescript
interface BaseResult {
  success: boolean
  error?: string
}

interface EncryptResult extends BaseResult {
  data: string
  algorithm: string
  mode?: string
  keySize?: number
  iv?: string
}

interface DecryptResult extends BaseResult {
  data: string
  algorithm: string
  mode?: string
}

interface HashResult extends BaseResult {
  hash: string
  algorithm: string
  encoding: EncodingType
}
```

### 2. 配置接口

```typescript
interface CryptoConfig {
  defaultKeySize?: AESKeySize
  defaultMode?: AESMode
  defaultEncoding?: EncodingType
  enableLogging?: boolean
}

interface AESOptions {
  keySize?: AESKeySize
  mode?: AESMode
  iv?: string
}

interface HashOptions {
  encoding?: EncodingType
  iterations?: number
}
```

## 扩展机制设计

### 1. 算法扩展

```typescript
interface Algorithm {
  name: string
  encrypt?: (data: string, key: string, options?: any) => EncryptResult
  decrypt?: (encryptedData: string | EncryptResult, key: string, options?: any) => DecryptResult
  hash?: (data: string, options?: any) => HashResult
}

class CryptoManager {
  registerAlgorithm(algorithm: Algorithm): void {
    // 注册自定义算法
  }
}
```

### 2. 框架适配器扩展

```typescript
interface FrameworkAdapter {
  name: string
  install: (framework: any, options?: any) => void
  createComposable?: () => any
  createPlugin?: () => any
}

// 注册新的框架适配器
registerAdapter(new ReactAdapter())
registerAdapter(new AngularAdapter())
```

### 3. 工具函数扩展

```typescript
interface UtilityFunction {
  name: string
  fn: Function
  category: 'validation' | 'generation' | 'conversion'
}

class UtilsManager {
  register(utility: UtilityFunction): void {
    // 注册新的工具函数
  }
}
```

## 性能优化设计

### 1. 懒加载机制

```typescript
// 按需加载算法
const algorithms = {
  get aes() {
    return import('./algorithms/aes').then(m => m.AESEncryptor)
  },
  get rsa() {
    return import('./algorithms/rsa').then(m => m.RSAEncryptor)
  }
}
```

### 2. 缓存机制

```typescript
class CryptoManager {
  private keyCache = new Map<string, CryptoJS.lib.WordArray>()
  private resultCache = new Map<string, any>()

  private getCachedKey(key: string, keySize: number): CryptoJS.lib.WordArray {
    const cacheKey = `${key}-${keySize}`
    if (!this.keyCache.has(cacheKey)) {
      this.keyCache.set(cacheKey, this.deriveKey(key, keySize))
    }
    return this.keyCache.get(cacheKey)!
  }
}
```

### 3. 批量处理

```typescript
interface BatchOperation {
  data: string[]
  key: string
  options?: any
}

class CryptoManager {
  encryptBatch(operation: BatchOperation): EncryptResult[] {
    // 批量加密优化
  }

  decryptBatch(operation: BatchOperation): DecryptResult[] {
    // 批量解密优化
  }
}
```

## 安全设计

### 1. 密钥管理

```typescript
class KeyManager {
  private keys = new WeakMap<object, string>()

  storeKey(owner: object, key: string): void {
    this.keys.set(owner, key)
  }

  getKey(owner: object): string | undefined {
    return this.keys.get(owner)
  }

  clearKey(owner: object): void {
    this.keys.delete(owner)
  }
}
```

### 2. 内存清理

```typescript
class SecureMemory {
  private sensitiveData = new Set<string>()

  markSensitive(data: string): void {
    this.sensitiveData.add(data)
  }

  cleanup(): void {
    this.sensitiveData.forEach((data) => {
      // 安全清理敏感数据
      if (typeof data === 'string') {
        data = '\0'.repeat(data.length)
      }
    })
    this.sensitiveData.clear()
  }
}
```

这种架构设计确保了系统的可扩展性、可维护性和高性能，同时保持了良好的安全性和易用性。

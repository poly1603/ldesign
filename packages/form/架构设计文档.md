# LDesign Form 表单插件系统架构设计

## 项目概述

基于现有 `ldesign-all/packages/library/form/src/form` 实现，开发一个框架无关的表单管理库，提供完整的表单状态管理、验证、数据绑定等功能，并内置 Vue 3 适配器。

## 现有代码分析总结

### 现有功能特点
1. **配置驱动**: 通过 `options` 数组配置表单项，支持动态渲染
2. **响应式布局**: 基于 `spanWidth`、`maxSpan`、`minSpan` 的栅格系统
3. **展开收起**: 支持 `previewRows` 预览行数和展开/收起功能
4. **验证系统**: 支持统一 `rules` 和单独字段 `rules` 配置
5. **双向绑定**: 支持 `v-model`、`value`、`defaultValue` 多种数据绑定方式
6. **按钮管理**: 内置查询、重置、展开按钮，支持自定义位置和样式
7. **分组支持**: 支持表单分组 (`LDesignFormGroup`) 功能
8. **多设备适配**: 支持桌面端和移动端不同布局

### 现有架构优势
- 配置化表单，开发效率高
- 响应式布局系统完善
- 与 TDesign 组件库深度集成
- 支持复杂的业务场景

### 需要扩展的功能
- 框架无关的核心库
- 更灵活的 hooks API
- 完整的类型系统
- 更强的可扩展性

## 新架构设计

### 设计原则
1. **向后兼容**: 确保现有 `_example` 代码能正常运行
2. **渐进增强**: 在现有基础上扩展功能，而非重写
3. **分层架构**: 核心层 + 适配层 + 组件层
4. **类型安全**: 完整的 TypeScript 类型定义

### 目录结构设计

```
packages/form/
├── src/                          # 源代码目录
│   ├── core/                     # 框架无关核心库
│   │   ├── form.ts              # 表单实例类
│   │   ├── field.ts             # 字段实例类
│   │   ├── state.ts             # 状态管理
│   │   ├── validator.ts         # 验证器系统
│   │   ├── events.ts            # 事件系统
│   │   └── index.ts             # 核心模块导出
│   ├── vue/                     # Vue 3 适配器
│   │   ├── hooks/               # Composition API hooks
│   │   │   ├── useForm.ts       # 表单管理 hook
│   │   │   ├── useField.ts      # 字段管理 hook
│   │   │   ├── useFormContext.ts # 表单上下文 hook
│   │   │   ├── useFieldArray.ts # 数组字段 hook
│   │   │   ├── useValidation.ts # 验证 hook
│   │   │   └── index.ts         # hooks 导出
│   │   ├── components/          # Vue 组件
│   │   │   ├── LDesignForm.vue  # 主表单组件（兼容现有）
│   │   │   ├── LDesignFormItem.vue # 表单项组件
│   │   │   ├── FieldArray.vue   # 数组字段组件
│   │   │   ├── FormProvider.vue # 表单上下文提供者
│   │   │   └── index.ts         # 组件导出
│   │   ├── directives/          # Vue 指令
│   │   │   ├── vModel.ts        # v-model 指令增强
│   │   │   └── index.ts         # 指令导出
│   │   └── index.ts             # Vue 模块导出
│   ├── types/                   # TypeScript 类型定义
│   │   ├── core.ts              # 核心类型
│   │   ├── form.ts              # 表单类型
│   │   ├── field.ts             # 字段类型
│   │   ├── validator.ts         # 验证器类型
│   │   ├── vue.ts               # Vue 相关类型
│   │   └── index.ts             # 类型导出
│   ├── utils/                   # 工具函数
│   │   ├── validation.ts        # 验证工具
│   │   ├── layout.ts            # 布局工具
│   │   ├── data.ts              # 数据处理工具
│   │   ├── helpers.ts           # 辅助工具
│   │   └── index.ts             # 工具导出
│   ├── validators/              # 内置验证器
│   │   ├── required.ts          # 必填验证
│   │   ├── email.ts             # 邮箱验证
│   │   ├── url.ts               # URL验证
│   │   ├── pattern.ts           # 正则验证
│   │   ├── length.ts            # 长度验证
│   │   ├── range.ts             # 范围验证
│   │   └── index.ts             # 验证器导出
│   ├── legacy/                  # 兼容层（确保现有代码正常工作）
│   │   ├── form.tsx             # 现有 form.tsx 的兼容版本
│   │   ├── hooks.tsx            # 现有 hooks.tsx 的兼容版本
│   │   ├── props.ts             # 现有 props.ts 的兼容版本
│   │   ├── type.ts              # 现有 type.ts 的兼容版本
│   │   └── index.ts             # 兼容层导出
│   ├── styles/                  # 样式文件
│   │   ├── form.less            # 表单样式
│   │   ├── form-item.less       # 表单项样式
│   │   ├── variables.less       # 样式变量
│   │   └── index.less           # 样式入口
│   └── index.ts                 # 主入口文件
├── _example/                    # 示例代码（确保兼容现有）
│   ├── base.vue                 # 基础示例
│   ├── rules.vue                # 验证示例
│   ├── group.vue                # 分组示例
│   ├── advance-*.vue            # 高级示例
│   └── new-features/            # 新功能示例
│       ├── hooks-usage.vue      # hooks 用法示例
│       ├── field-array.vue      # 数组字段示例
│       ├── custom-validator.vue # 自定义验证器示例
│       └── form-provider.vue    # 表单上下文示例
├── __tests__/                   # 测试文件
│   ├── core/                    # 核心库测试
│   ├── vue/                     # Vue 适配器测试
│   ├── components/              # 组件测试
│   ├── integration/             # 集成测试
│   ├── e2e/                     # E2E 测试
│   └── setup.ts                 # 测试配置
├── docs/                        # VitePress 文档
│   ├── .vitepress/              # VitePress 配置
│   ├── guide/                   # 使用指南
│   ├── api/                     # API 参考
│   ├── examples/                # 示例文档
│   └── index.md                 # 文档首页
├── dev/                         # 开发环境
│   ├── App.vue                  # 开发应用
│   ├── main.ts                  # 开发入口
│   └── examples/                # 开发示例
├── scripts/                     # 构建脚本
│   ├── build.js                 # 构建脚本
│   ├── dev.js                   # 开发脚本
│   └── test.js                  # 测试脚本
├── package.json                 # 包配置
├── tsconfig.json                # TypeScript 配置
├── vite.config.ts               # Vite 配置
├── vitest.config.ts             # Vitest 配置
├── ldesign.config.ts            # LDesign 构建配置
├── eslint.config.js             # ESLint 配置
└── README.md                    # 项目说明
```

## 核心架构分层

### 1. 核心层 (Core)
- **职责**: 框架无关的表单逻辑
- **特点**: 纯 JavaScript/TypeScript，无框架依赖
- **模块**: Form、Field、State、Validator、Events

### 2. 适配层 (Vue)
- **职责**: Vue 3 框架集成
- **特点**: 基于 Composition API，响应式集成
- **模块**: Hooks、Directives、Utils

### 3. 组件层 (Components)
- **职责**: Vue 组件封装
- **特点**: 基于适配层，提供开箱即用的组件
- **模块**: LDesignForm、LDesignFormItem、FieldArray、FormProvider

### 4. 兼容层 (Legacy)
- **职责**: 确保现有代码正常工作
- **特点**: 桥接新旧架构，平滑迁移
- **模块**: 现有组件的兼容版本

## 兼容性策略

### 1. API 兼容
- 保持现有 `LDesignForm` 组件 API 不变
- 保持现有 `options` 配置格式不变
- 保持现有事件和方法签名不变

### 2. 功能兼容
- 确保所有现有 `_example` 示例正常运行
- 保持现有布局和样式行为
- 保持现有验证逻辑

### 3. 渐进迁移
- 新功能通过新 API 提供
- 旧 API 标记为 deprecated 但继续支持
- 提供迁移指南和工具

## 核心 API 设计

### 1. 框架无关核心 API

#### Form 类 API
```typescript
class Form implements FormInstance {
  constructor(config?: FormConfig)

  // 数据操作
  setFieldValue(fieldName: string, value: any, options?: FormOperationOptions): void
  getFieldValue(fieldName: string): any
  setValues(values: Record<string, any>, options?: FormOperationOptions): void
  getValues(): Record<string, any>
  reset(options?: FormResetOptions): void

  // 字段管理
  registerField(config: FieldConfig): FieldInstance
  unregisterField(fieldName: string): void
  getField(fieldName: string): FieldInstance | undefined
  hasField(fieldName: string): boolean

  // 验证
  validate(options?: FormValidationOptions): Promise<Record<string, ValidationResult>>
  validateField(fieldName: string): Promise<ValidationResult>
  clearValidation(fieldNames?: string[]): void

  // 状态管理
  hasState(state: FormState): boolean
  addState(state: FormState): void
  removeState(state: FormState): void
  getSnapshot(): FormSnapshot
  restoreSnapshot(snapshot: FormSnapshot): void

  // 提交
  submit(options?: FormSubmitOptions): Promise<FormSubmitEvent>

  // 事件
  onChange(listener: EventListener<FormChangeEvent>): void
  onSubmit(listener: EventListener<FormSubmitEvent>): void
  onReset(listener: EventListener<FormChangeEvent>): void
  off(event: string, listener: EventListener): void

  // 生命周期
  destroy(): void
}
```

#### Field 类 API
```typescript
class Field implements FieldInstance {
  constructor(config: FieldConfig, form: FormInstance)

  // 值操作
  setValue(value: any, options?: FieldOperationOptions): void
  getValue(): any
  reset(options?: FieldResetOptions): void

  // 状态管理
  hasState(state: FieldState): boolean
  addState(state: FieldState): void
  removeState(state: FieldState): void
  touch(): void
  untouch(): void
  isDirty(): boolean
  isTouched(): boolean
  isValid(): boolean
  isPending(): boolean

  // 验证
  validate(options?: FieldValidationOptions): Promise<ValidationResult>
  clearValidation(): void

  // 事件
  onChange(listener: EventListener<FieldChangeEvent>): void
  onValidate(listener: EventListener<ValidationResult>): void
  off(event: string, listener: EventListener): void

  // 生命周期
  destroy(): void
}
```

### 2. Vue 3 Composition API

#### useForm Hook
```typescript
function useForm(options?: UseFormOptions): UseFormReturn {
  // 返回响应式表单实例和操作方法
}
```

#### useField Hook
```typescript
function useField(name: string, options?: UseFieldOptions): UseFieldReturn {
  // 返回响应式字段实例和操作方法
}
```

#### useFieldArray Hook
```typescript
function useFieldArray(name: string, options?: UseFieldArrayOptions): UseFieldArrayReturn {
  // 返回响应式字段数组实例和操作方法
}
```

#### useFormContext Hook
```typescript
function useFormContext(): UseFormContextReturn {
  // 返回表单上下文
}
```

### 3. Vue 组件 API

#### LDesignForm 组件（兼容现有）
```vue
<template>
  <LDesignForm
    v-model="formData"
    :options="formOptions"
    :rules="formRules"
    @change="handleChange"
    @submit="handleSubmit"
  />
</template>
```

#### LDesignFormItem 组件
```vue
<template>
  <LDesignFormItem
    name="fieldName"
    label="字段标签"
    :rules="fieldRules"
  >
    <Input v-model="fieldValue" />
  </LDesignFormItem>
</template>
```

## 下一步计划

1. **✅ 完成目录结构创建**
2. **✅ 设计核心 API 接口**
3. **实现兼容层确保现有功能正常**
4. **逐步实现新功能**
5. **编写测试和文档**

这个架构设计既保证了向后兼容性，又为未来的功能扩展提供了良好的基础。

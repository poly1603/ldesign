<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>弹窗模式示例</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .demo-section {
        margin-bottom: 32px;
      }

      .demo-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #333;
      }

      .demo-description {
        color: #666;
        margin-bottom: 16px;
        line-height: 1.5;
      }

      .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .btn:hover {
        border-color: #1890ff;
        color: #1890ff;
      }

      .btn.primary {
        background: #1890ff;
        border-color: #1890ff;
        color: white;
      }

      .btn.primary:hover {
        background: #40a9ff;
        border-color: #40a9ff;
      }

      .form-container {
        border: 1px solid #e8e8e8;
        border-radius: 6px;
        padding: 16px;
        background: #fafafa;
        min-height: 200px;
      }

      .status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 4px;
        font-size: 14px;
      }

      .status.info {
        background: #e6f7ff;
        border: 1px solid #91d5ff;
        color: #1890ff;
      }

      .status.success {
        background: #f6ffed;
        border: 1px solid #b7eb8f;
        color: #52c41a;
      }

      .status.error {
        background: #fff2f0;
        border: 1px solid #ffccc7;
        color: #ff4d4f;
      }

      /* 弹窗样式 */
      .form-modal-mask {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.45);
        z-index: 1000;
        display: none;
      }

      .form-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1001;
        display: none;
      }

      .form-modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        max-width: 90vw;
        max-height: 90vh;
      }

      .form-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 16px;
        font-weight: 500;
      }

      .form-modal-close {
        border: none;
        background: none;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 2px;
        color: #999;
      }

      .form-modal-close:hover {
        background-color: #f5f5f5;
        color: #333;
      }

      .form-modal-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .form-modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        padding: 16px 24px;
        border-top: 1px solid #f0f0f0;
      }

      .form-modal-button {
        padding: 6px 16px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        background: white;
        color: #333;
      }

      .form-modal-button:hover {
        border-color: #40a9ff;
        color: #40a9ff;
      }

      .form-modal-confirm {
        background: #1890ff !important;
        border-color: #1890ff !important;
        color: white !important;
      }

      .form-modal-confirm:hover {
        background: #40a9ff !important;
        border-color: #40a9ff !important;
      }

      .form-modal-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
      }

      .form-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .form-item label {
        font-size: 14px;
        color: #333;
        font-weight: 500;
      }

      .form-item input,
      .form-item textarea,
      .form-item select {
        padding: 8px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .form-item input:focus,
      .form-item textarea:focus,
      .form-item select:focus {
        outline: none;
        border-color: #1890ff;
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>弹窗模式示例</h1>

      <div class="demo-section">
        <div class="demo-title">基础弹窗功能</div>
        <div class="demo-description">演示弹窗的打开、关闭、确认和取消功能。弹窗支持动画效果和多种触发方式。</div>

        <div class="controls">
          <button class="btn primary" onclick="openModal()">打开弹窗</button>
          <button class="btn" onclick="openModalWithAnimation()">动画打开</button>
          <button class="btn" onclick="closeModal()">关闭弹窗</button>
          <button class="btn" onclick="toggleModal()">切换状态</button>
        </div>

        <div class="form-container" id="form-container">
          <p>主表单区域 - 这里会显示可见的表单项</p>
          <div id="visible-items"></div>
        </div>

        <div class="status info" id="status">状态：弹窗未打开</div>
      </div>

      <div class="demo-section">
        <div class="demo-title">弹窗配置选项</div>
        <div class="demo-description">测试不同的弹窗配置选项，包括标题、尺寸、关闭方式等。</div>

        <div class="controls">
          <button class="btn" onclick="openCustomModal()">自定义配置</button>
          <button class="btn" onclick="openLargeModal()">大尺寸弹窗</button>
          <button class="btn" onclick="openNoCloseModal()">禁用关闭</button>
          <button class="btn" onclick="updateModalConfig()">更新配置</button>
        </div>
      </div>

      <div class="demo-section">
        <div class="demo-title">表单数据同步</div>
        <div class="demo-description">测试弹窗内表单数据与主表单的同步功能。</div>

        <div class="controls">
          <button class="btn" onclick="openWithData()">带数据打开</button>
          <button class="btn" onclick="updateContent()">更新内容</button>
          <button class="btn" onclick="getFormData()">获取数据</button>
          <button class="btn" onclick="resetFormData()">重置数据</button>
        </div>

        <div id="form-data" class="status info">表单数据将在这里显示</div>
      </div>
    </div>

    <script type="module">
      // 模拟导入弹窗管理器
      class MockModalManager {
        constructor(config = {}) {
          this.config = {
            title: '更多表单项',
            width: 600,
            height: 'auto',
            closable: true,
            maskClosable: true,
            destroyOnClose: false,
            className: '',
            style: {},
            ...config,
          }

          this.state = {
            open: false,
            animating: false,
            items: [],
            values: {},
          }

          this.eventListeners = []
          this.modalElement = null
          this.maskElement = null
        }

        async open(items = [], values = {}, animated = true) {
          if (this.state.open || this.state.animating) return

          this.state.animating = true
          this.state.items = [...items]
          this.state.values = { ...values }

          this.createModal()
          this.renderFormContent()

          if (animated) {
            await this.animateOpen()
          } else {
            this.showModal()
          }

          this.state.open = true
          this.setupEventListeners()
          this.emitEvent('open', 'api')
          this.state.animating = false
        }

        async close(animated = true, trigger = 'api') {
          if (!this.state.open || this.state.animating) return

          this.state.animating = true

          if (animated) {
            await this.animateClose()
          } else {
            this.hideModal()
          }

          this.state.open = false
          this.cleanupEventListeners()

          if (this.config.destroyOnClose) {
            this.destroyModal()
          }

          this.emitEvent('close', trigger)
          this.state.animating = false
        }

        async confirm(animated = true) {
          if (!this.state.open) return

          const values = this.getCurrentValues()
          await this.close(animated, 'button')
          this.emitEvent('confirm', 'button', values)
        }

        async cancel(animated = true) {
          if (!this.state.open) return

          this.restoreOriginalValues()
          await this.close(animated, 'button')
          this.emitEvent('cancel', 'button')
        }

        async toggle(items, values, animated = true) {
          if (this.state.open) {
            await this.close(animated)
          } else if (items) {
            await this.open(items, values, animated)
          }
        }

        updateContent(items, values = {}) {
          if (!this.state.open) return

          this.state.items = [...items]
          this.state.values = { ...values }
          this.renderFormContent()
        }

        updateConfig(config) {
          this.config = { ...this.config, ...config }
          if (this.modalElement && this.state.open) {
            this.updateModalStyles()
          }
        }

        isOpen() {
          return this.state.open
        }

        getState() {
          return { ...this.state }
        }

        onModalEvent(callback) {
          this.eventListeners.push(callback)
          return () => {
            const index = this.eventListeners.indexOf(callback)
            if (index > -1) {
              this.eventListeners.splice(index, 1)
            }
          }
        }

        createModal() {
          if (this.modalElement) return

          // 创建遮罩
          this.maskElement = document.createElement('div')
          this.maskElement.className = 'form-modal-mask'

          // 创建弹窗
          this.modalElement = document.createElement('div')
          this.modalElement.className = `form-modal ${this.config.className || ''}`

          // 创建内容
          const content = document.createElement('div')
          content.className = 'form-modal-content'
          content.style.width = typeof this.config.width === 'number' ? `${this.config.width}px` : this.config.width

          // 创建头部
          if (this.config.title || this.config.closable) {
            const header = document.createElement('div')
            header.className = 'form-modal-header'
            header.innerHTML = `
                        ${this.config.title ? `<div class="form-modal-title">${this.config.title}</div>` : ''}
                        ${this.config.closable ? '<button type="button" class="form-modal-close">×</button>' : ''}
                    `
            content.appendChild(header)
          }

          // 创建主体
          const body = document.createElement('div')
          body.className = 'form-modal-body'
          content.appendChild(body)

          // 创建底部
          const footer = document.createElement('div')
          footer.className = 'form-modal-footer'
          footer.innerHTML = `
                    <button type="button" class="form-modal-button form-modal-cancel">取消</button>
                    <button type="button" class="form-modal-button form-modal-confirm">确定</button>
                `
          content.appendChild(footer)

          this.modalElement.appendChild(content)
          document.body.appendChild(this.maskElement)
          document.body.appendChild(this.modalElement)
        }

        renderFormContent() {
          const body = this.modalElement.querySelector('.form-modal-body')
          if (!body) return

          body.innerHTML = ''

          const form = document.createElement('div')
          form.className = 'form-modal-form'

          this.state.items.forEach((item) => {
            const formItem = document.createElement('div')
            formItem.className = 'form-item'
            formItem.innerHTML = `
                        <label>${item.label}</label>
                        <input type="text" name="${item.key}" value="${this.state.values[item.key] || ''}" />
                    `
            form.appendChild(formItem)
          })

          body.appendChild(form)
        }

        showModal() {
          if (this.maskElement) this.maskElement.style.display = 'block'
          if (this.modalElement) this.modalElement.style.display = 'block'
        }

        hideModal() {
          if (this.maskElement) this.maskElement.style.display = 'none'
          if (this.modalElement) this.modalElement.style.display = 'none'
        }

        async animateOpen() {
          return new Promise((resolve) => {
            this.showModal()

            if (this.maskElement) {
              this.maskElement.style.opacity = '0'
              this.maskElement.style.transition = 'opacity 0.2s ease-out'
            }

            if (this.modalElement) {
              this.modalElement.style.opacity = '0'
              this.modalElement.style.transform = 'translate(-50%, -50%) scale(0.7)'
              this.modalElement.style.transition = 'all 0.3s cubic-bezier(0.78, 0.14, 0.15, 0.86)'
            }

            requestAnimationFrame(() => {
              if (this.maskElement) this.maskElement.style.opacity = '1'
              if (this.modalElement) {
                this.modalElement.style.opacity = '1'
                this.modalElement.style.transform = 'translate(-50%, -50%) scale(1)'
              }

              setTimeout(() => {
                if (this.maskElement) this.maskElement.style.transition = ''
                if (this.modalElement) this.modalElement.style.transition = ''
                resolve()
              }, 300)
            })
          })
        }

        async animateClose() {
          return new Promise((resolve) => {
            if (this.maskElement) {
              this.maskElement.style.opacity = '0'
              this.maskElement.style.transition = 'opacity 0.2s ease-out'
            }

            if (this.modalElement) {
              this.modalElement.style.opacity = '0'
              this.modalElement.style.transform = 'translate(-50%, -50%) scale(0.7)'
              this.modalElement.style.transition = 'all 0.2s ease-out'
            }

            setTimeout(() => {
              this.hideModal()
              if (this.maskElement) this.maskElement.style.transition = ''
              if (this.modalElement) this.modalElement.style.transition = ''
              resolve()
            }, 200)
          })
        }

        setupEventListeners() {
          // 遮罩点击
          if (this.maskElement && this.config.maskClosable) {
            this.maskElement.addEventListener('click', () => this.close(true, 'mask'))
          }

          // 关闭按钮
          const closeBtn = this.modalElement.querySelector('.form-modal-close')
          if (closeBtn) {
            closeBtn.addEventListener('click', () => this.close(true, 'button'))
          }

          // 底部按钮
          const cancelBtn = this.modalElement.querySelector('.form-modal-cancel')
          const confirmBtn = this.modalElement.querySelector('.form-modal-confirm')

          if (cancelBtn) {
            cancelBtn.addEventListener('click', () => this.cancel())
          }

          if (confirmBtn) {
            confirmBtn.addEventListener('click', () => this.confirm())
          }

          // ESC键
          this.escapeHandler = (e) => {
            if (e.key === 'Escape' && this.state.open) {
              this.close(true, 'escape')
            }
          }
          document.addEventListener('keydown', this.escapeHandler)
        }

        cleanupEventListeners() {
          if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler)
            this.escapeHandler = null
          }
        }

        getCurrentValues() {
          const values = {}
          const inputs = this.modalElement.querySelectorAll('input, textarea, select')
          inputs.forEach((input) => {
            if (input.name) {
              values[input.name] = input.value
            }
          })
          return values
        }

        restoreOriginalValues() {
          const inputs = this.modalElement.querySelectorAll('input, textarea, select')
          inputs.forEach((input) => {
            if (input.name && this.state.values[input.name] !== undefined) {
              input.value = this.state.values[input.name]
            }
          })
        }

        updateModalStyles() {
          const content = this.modalElement.querySelector('.form-modal-content')
          if (content) {
            content.style.width = typeof this.config.width === 'number' ? `${this.config.width}px` : this.config.width
          }
        }

        emitEvent(type, trigger, values) {
          const event = { type, trigger, values }
          this.eventListeners.forEach((callback) => callback(event))
        }

        destroyModal() {
          if (this.modalElement) {
            this.modalElement.remove()
            this.modalElement = null
          }
          if (this.maskElement) {
            this.maskElement.remove()
            this.maskElement = null
          }
        }

        destroy() {
          this.cleanupEventListeners()
          this.destroyModal()
          this.eventListeners = []
        }
      }

      // 全局变量
      let modalManager = new MockModalManager()
      let currentData = {
        field1: '字段1的值',
        field2: '字段2的值',
        field3: '字段3的值',
        field4: '字段4的值',
      }

      const mockItems = [
        { key: 'field1', label: '字段1', type: 'input' },
        { key: 'field2', label: '字段2', type: 'textarea' },
        { key: 'field3', label: '字段3', type: 'select' },
        { key: 'field4', label: '字段4', type: 'input' },
      ]

      // 状态更新函数
      function updateStatus(message, type = 'info') {
        const status = document.getElementById('status')
        status.textContent = message
        status.className = `status ${type}`
      }

      // 事件监听
      modalManager.onModalEvent((event) => {
        console.log('Modal event:', event)

        switch (event.type) {
          case 'open':
            updateStatus('弹窗已打开', 'success')
            break
          case 'close':
            updateStatus(`弹窗已关闭 (触发方式: ${event.trigger})`, 'info')
            break
          case 'confirm':
            updateStatus('用户确认了弹窗', 'success')
            if (event.values) {
              Object.assign(currentData, event.values)
              updateFormData()
            }
            break
          case 'cancel':
            updateStatus('用户取消了弹窗', 'info')
            break
        }
      })

      // 全局函数
      window.openModal = async () => {
        await modalManager.open(mockItems, currentData, false)
      }

      window.openModalWithAnimation = async () => {
        await modalManager.open(mockItems, currentData, true)
      }

      window.closeModal = async () => {
        await modalManager.close(true)
      }

      window.toggleModal = async () => {
        await modalManager.toggle(mockItems, currentData, true)
      }

      window.openCustomModal = async () => {
        modalManager.updateConfig({
          title: '自定义弹窗标题',
          width: 800,
          closable: true,
          maskClosable: false,
        })
        await modalManager.open(mockItems, currentData, true)
      }

      window.openLargeModal = async () => {
        modalManager.updateConfig({
          title: '大尺寸弹窗',
          width: 1000,
          height: 600,
        })
        await modalManager.open(mockItems, currentData, true)
      }

      window.openNoCloseModal = async () => {
        modalManager.updateConfig({
          title: '禁用关闭的弹窗',
          closable: false,
          maskClosable: false,
        })
        await modalManager.open(mockItems, currentData, true)
      }

      window.updateModalConfig = () => {
        modalManager.updateConfig({
          title: '配置已更新',
          width: 700,
        })
        updateStatus('弹窗配置已更新', 'success')
      }

      window.openWithData = async () => {
        const testData = {
          field1: '测试数据1',
          field2: '测试数据2',
          field3: '测试数据3',
          field4: '测试数据4',
        }
        await modalManager.open(mockItems, testData, true)
      }

      window.updateContent = () => {
        const newItems = [
          { key: 'newField1', label: '新字段1', type: 'input' },
          { key: 'newField2', label: '新字段2', type: 'textarea' },
        ]
        const newData = {
          newField1: '新数据1',
          newField2: '新数据2',
        }
        modalManager.updateContent(newItems, newData)
        updateStatus('弹窗内容已更新', 'success')
      }

      window.getFormData = () => {
        updateFormData()
        updateStatus('表单数据已获取', 'success')
      }

      window.resetFormData = () => {
        currentData = {
          field1: '',
          field2: '',
          field3: '',
          field4: '',
        }
        updateFormData()
        updateStatus('表单数据已重置', 'success')
      }

      function updateFormData() {
        const formDataEl = document.getElementById('form-data')
        formDataEl.innerHTML = `
                <strong>当前表单数据：</strong><br>
                ${Object.entries(currentData)
                  .map(([key, value]) => `${key}: ${value || '(空)'}`)
                  .join('<br>')}
            `
      }

      // 初始化
      updateFormData()
      updateStatus('弹窗管理器已初始化', 'success')
    </script>
  </body>
</html>

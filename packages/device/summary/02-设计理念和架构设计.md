# @ldesign/device 设计理念和架构设计

## 🎯 设计理念

### 1. 精确性优先 (Accuracy First)
设备检测的准确性是用户体验的基础。我们采用多重特征检测算法，而不是单纯依赖 User-Agent 字符串。

```typescript
// 多重特征检测示例
function detectDevice() {
  const features = {
    screenSize: getScreenDimensions(),
    touchSupport: detectTouchCapability(),
    userAgent: parseUserAgent(),
    orientation: getOrientation(),
    pixelRatio: getDevicePixelRatio()
  }

  return analyzeFeatures(features)
}
```

### 2. 性能至上 (Performance First)
在保证准确性的前提下，最大化性能表现：
- **智能缓存**: 避免重复计算
- **懒加载**: 按需加载检测模块
- **防抖优化**: 减少频繁触发
- **内存管理**: 及时清理无用资源

### 3. 开发者友好 (Developer Experience)
提供直观、易用的 API 设计：
- **类型安全**: 完整的 TypeScript 支持
- **语义化**: 方法名和属性名具有明确含义
- **一致性**: 统一的 API 风格和错误处理
- **文档完善**: 详细的使用示例和最佳实践

### 4. 可扩展性 (Extensibility)
模块化架构支持功能扩展：
- **插件系统**: 支持自定义检测模块
- **事件驱动**: 基于事件的响应式更新
- **配置灵活**: 丰富的配置选项
- **向后兼容**: 保持 API 稳定性

## 🏗️ 架构设计

### 核心架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    @ldesign/device                          │
├─────────────────────────────────────────────────────────────┤
│  Vue Integration Layer                                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ Composables │ │ Directives  │ │   Plugin    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  Core Detection Engine                                      │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              DeviceDetector                             ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      ││
│  │  │   Screen    │ │   Browser   │ │     OS      │      ││
│  │  │  Detection  │ │  Detection  │ │  Detection  │      ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘      ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  Module System                                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   Network   │ │   Battery   │ │ Geolocation │          │
│  │   Module    │ │   Module    │ │   Module    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  Foundation Layer                                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │EventEmitter │ │ModuleLoader │ │   Utils     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 分层架构详解

#### 1. Foundation Layer (基础层)
**职责**: 提供核心基础设施和工具函数

- **EventEmitter**: 事件系统核心
  ```typescript
  class EventEmitter<T> {
    private events: Map<keyof T, Set<EventListener>>

    on<K extends keyof T>(event: K, listener: EventListener<T[K]>): void
    emit<K extends keyof T>(event: K, data: T[K]): void
    off<K extends keyof T>(event: K, listener?: EventListener<T[K]>): void
  }
  ```

- **ModuleLoader**: 模块加载管理器
  ```typescript
  class ModuleLoader {
    private modules: Map<string, DeviceModule>

    async load(name: string, module: DeviceModule): Promise<void>
    async unload(name: string): Promise<void>
    get<T extends DeviceModule>(name: string): T | null
  }
  ```

- **Utils**: 工具函数集合
  ```typescript
  // 安全的 navigator 访问
  export function safeNavigatorAccess<T>(accessor: (nav: Navigator) => T, fallback: T): T {
    try {
      return typeof navigator !== 'undefined' ? accessor(navigator) : fallback
    }
    catch {
      return fallback
    }
  }
  ```

#### 2. Module System (模块系统)
**职责**: 提供可扩展的功能模块

- **模块接口定义**:
  ```typescript
  interface DeviceModule {
    name: string
    init: () => Promise<void>
    destroy: () => Promise<void>
    getData: () => unknown
    isSupported: () => boolean
  }
  ```

- **内置模块**:
  - `NetworkModule`: 网络状态检测
  - `BatteryModule`: 电池信息获取
  - `GeolocationModule`: 地理位置服务

#### 3. Core Detection Engine (核心检测引擎)
**职责**: 设备信息检测和状态管理

- **DeviceDetector 主类**:
  ```typescript
  class DeviceDetector extends EventEmitter<DeviceDetectorEvents> {
    private currentDeviceInfo: DeviceInfo
    private moduleLoader: ModuleLoader
    private options: DeviceDetectorOptions

    constructor(options?: DeviceDetectorOptions)
    getDeviceInfo(): DeviceInfo
    detectDeviceType(): DeviceType
    getBrowserInfo(): BrowserInfo
    getOSInfo(): OSInfo
  }
  ```

#### 4. Vue Integration Layer (Vue 集成层)
**职责**: 提供 Vue 3 生态系统集成

- **Composables**: 组合式 API
  ```typescript
  export function useDevice(options?: UseDeviceOptions) {
    const deviceInfo = ref<DeviceInfo>()
    const isMobile = computed(() => deviceInfo.value?.type === 'mobile')
    const isTablet = computed(() => deviceInfo.value?.type === 'tablet')

    return { deviceInfo, isMobile, isTablet }
  }
  ```

## 🔧 设计模式应用

### 1. 观察者模式 (Observer Pattern)
用于事件系统和响应式更新：
```typescript
// 设备信息变化时自动通知所有监听器
detector.on('deviceChange', (deviceInfo) => {
  updateUI(deviceInfo)
})
```

### 2. 策略模式 (Strategy Pattern)
用于不同的检测算法：
```typescript
interface DetectionStrategy {
  detect: () => DeviceInfo
}

class MobileDetectionStrategy implements DetectionStrategy {
  detect(): DeviceInfo {
    // 移动设备检测逻辑
  }
}

class DesktopDetectionStrategy implements DetectionStrategy {
  detect(): DeviceInfo {
    // 桌面设备检测逻辑
  }
}
```

### 3. 工厂模式 (Factory Pattern)
用于模块创建和管理：
```typescript
class ModuleFactory {
  static create(type: string, options?: any): DeviceModule {
    switch (type) {
      case 'network':
        return new NetworkModule(options)
      case 'battery':
        return new BatteryModule(options)
      default:
        throw new Error(`Unknown module type: ${type}`)
    }
  }
}
```

### 4. 单例模式 (Singleton Pattern)
用于全局设备检测器实例：
```typescript
class DeviceDetectorSingleton {
  private static instance: DeviceDetector

  static getInstance(options?: DeviceDetectorOptions): DeviceDetector {
    if (!this.instance) {
      this.instance = new DeviceDetector(options)
    }
    return this.instance
  }
}
```

## 🚀 性能优化策略

### 1. 缓存机制
- **结果缓存**: 缓存检测结果，避免重复计算
- **时间缓存**: 设置缓存过期时间
- **LRU 策略**: 最近最少使用的缓存淘汰

### 2. 懒加载
- **模块懒加载**: 按需加载扩展模块
- **检测懒加载**: 延迟执行非关键检测

### 3. 防抖和节流
- **窗口大小变化防抖**: 避免频繁触发检测
- **方向变化节流**: 限制方向变化检测频率

### 4. 内存管理
- **事件监听器清理**: 及时移除无用监听器
- **模块生命周期管理**: 正确初始化和销毁模块

## 🔒 错误处理策略

### 1. 优雅降级
当某个检测功能不可用时，提供合理的默认值：
```typescript
function getScreenInfo(): ScreenInfo {
  try {
    return {
      width: window.innerWidth,
      height: window.innerHeight,
      // ...
    }
  }
  catch (error) {
    return {
      width: 1920, // 默认值
      height: 1080,
      // ...
    }
  }
}
```

### 2. 错误边界
在关键操作周围设置错误边界，防止单点故障：
```typescript
function safeDetect<T>(detector: () => T, fallback: T): T {
  try {
    return detector()
  }
  catch (error) {
    console.warn('Detection failed:', error)
    return fallback
  }
}
```

### 3. 错误上报
提供错误上报机制，帮助改进检测算法：
```typescript
detector.onError((error, context) => {
  // 上报错误信息
  reportError(error, context)
})
```

## 🌐 兼容性设计

### 1. 浏览器兼容性
- **特性检测**: 使用特性检测而非浏览器检测
- **Polyfill**: 为旧浏览器提供必要的 polyfill
- **优雅降级**: 在不支持的环境中提供基础功能

### 2. 服务端渲染支持
- **SSR 安全**: 避免在服务端访问浏览器 API
- **同构渲染**: 确保客户端和服务端渲染结果一致

### 3. 移动端适配
- **触摸事件**: 正确处理触摸和鼠标事件
- **视口适配**: 支持各种移动设备视口
- **性能优化**: 针对移动设备的性能优化

# @ldesign/builder ä¼˜åŒ–å®Œæˆæ€»ç»“

## ğŸ“‹ ä¼˜åŒ–æ¦‚è§ˆ

æœ¬æ¬¡ä¼˜åŒ–è§£å†³äº†ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜:
1. âœ… ä¿®å¤äº† Rolldown é…ç½®è¯†åˆ«é—®é¢˜
2. âœ… æ·»åŠ äº† DTS ç”Ÿæˆè¿›åº¦æç¤º
3. âœ… æå‡äº†æ‰“åŒ…é€Ÿåº¦(å¹¶è¡Œæ„å»º)
4. âœ… ä¿®å¤äº† builder åŒ…è‡ªèº«çš„æ‰“åŒ…é…ç½®

---

## ğŸ”§ é—®é¢˜ 1: Rolldown é…ç½®è¯†åˆ«

### é—®é¢˜æè¿°
åœ¨ `ldesign.config.ts` ä¸­é…ç½® `bundler: 'rolldown'` ä¸ç”Ÿæ•ˆ,ä»ç„¶ä½¿ç”¨ Rollup æ‰“åŒ…ã€‚

### è§£å†³æ–¹æ¡ˆ
ä¼˜åŒ–äº† `packages/builder/src/cli/commands/build.ts` ä¸­çš„é…ç½®ä¼˜å…ˆçº§å¤„ç†:

```typescript
// å…¨å±€é€‰é¡¹ - CLI å‚æ•°ä¼˜å…ˆçº§æœ€é«˜
if (globalOptions.bundler) {
  config.bundler = globalOptions.bundler
  logger.debug(`CLI æŒ‡å®šæ‰“åŒ…å™¨: ${globalOptions.bundler}`)
} else if (config.bundler) {
  logger.debug(`é…ç½®æ–‡ä»¶æŒ‡å®šæ‰“åŒ…å™¨: ${config.bundler}`)
}
```

### ä½¿ç”¨æ–¹å¼
ç°åœ¨æ”¯æŒä¸¤ç§æ–¹å¼æŒ‡å®šæ‰“åŒ…å™¨:

1. **é…ç½®æ–‡ä»¶æ–¹å¼** (åœ¨ `ldesign.config.ts` ä¸­):
```typescript
export default defineConfig({
  bundler: 'rolldown'
})
```

2. **CLI å‚æ•°æ–¹å¼** (ä¼˜å…ˆçº§æ›´é«˜):
```bash
pnpm ldesign-builder build --bundler rolldown
```

---

## ğŸ“Š é—®é¢˜ 2: DTS ç”Ÿæˆè¿›åº¦æç¤º

### é—®é¢˜æè¿°
`rollup-plugin-dts` ç”Ÿæˆç±»å‹å®šä¹‰æ—¶é•¿æ—¶é—´å¡é¡¿æ— æç¤º,ç”¨æˆ·ä½“éªŒå·®ã€‚

### è§£å†³æ–¹æ¡ˆ
åœ¨ `packages/builder/src/adapters/rollup/RollupAdapter.ts` ä¸­æ·»åŠ äº† `wrapPluginWithProgress` æ–¹æ³•:

```typescript
/**
 * ä¸ºæ’ä»¶åŒ…è£…è¿›åº¦æ—¥å¿—
 */
private wrapPluginWithProgress(plugin: any, pluginName: string): any {
  const startTime = Date.now()
  let fileCount = 0
  
  return {
    ...plugin,
    name: plugin.name,
    
    // æ‹¦æˆª transform é’©å­
    transform(code: string, id: string) {
      fileCount++
      
      // æ¯å¤„ç† 10 ä¸ªæ–‡ä»¶è¾“å‡ºä¸€æ¬¡è¿›åº¦
      if (fileCount % 10 === 0) {
        this.logger.debug(`${pluginName}: å·²å¤„ç† ${fileCount} ä¸ªæ–‡ä»¶...`)
      }
      
      return plugin.transform?.call(this, code, id)
    },
    
    // æ‹¦æˆª buildEnd é’©å­
    buildEnd() {
      const duration = Date.now() - startTime
      this.logger.success(`${pluginName} ç”Ÿæˆå®Œæˆ (${fileCount} ä¸ªæ–‡ä»¶, ${duration}ms)`)
      return plugin.buildEnd?.call(this)
    }
  }
}
```

### æ•ˆæœå±•ç¤º
ç°åœ¨ä¼šæ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦ä¿¡æ¯:
```
[@ldesign/builder] [INFO] å¼€å§‹ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰...
[@ldesign/builder] [DEBUG] TypeScript ç±»å‹å®šä¹‰: å·²å¤„ç† 10 ä¸ªæ–‡ä»¶...
[@ldesign/builder] [DEBUG] TypeScript ç±»å‹å®šä¹‰: å·²å¤„ç† 20 ä¸ªæ–‡ä»¶...
[@ldesign/builder] [DEBUG] TypeScript ç±»å‹å®šä¹‰: å·²å¤„ç† 30 ä¸ªæ–‡ä»¶...
[@ldesign/builder] [DEBUG] TypeScript ç±»å‹å®šä¹‰: å·²å¤„ç† 40 ä¸ªæ–‡ä»¶...
[@ldesign/builder] [SUCCESS] TypeScript ç±»å‹å®šä¹‰ ç”Ÿæˆå®Œæˆ (42 ä¸ªæ–‡ä»¶, 7389ms)
```

---

## âš¡ é—®é¢˜ 3: æå‡æ‰“åŒ…é€Ÿåº¦

### é—®é¢˜æè¿°
å¤šæ ¼å¼æ„å»º(ESM + CJS + UMD)é‡‡ç”¨ä¸²è¡Œæ‰§è¡Œ,é€Ÿåº¦æ…¢ã€‚

### è§£å†³æ–¹æ¡ˆ
åœ¨ `packages/builder/src/adapters/rollup/RollupAdapter.ts` ä¸­å®ç°å¹¶è¡Œæ„å»º:

```typescript
// å¹¶è¡Œæ„å»ºæ‰€æœ‰é…ç½®
this.logger.info(`å¼€å§‹å¹¶è¡Œæ„å»º ${this.multiConfigs.length} ä¸ªé…ç½®...`)

const buildPromises = this.multiConfigs.map(async (singleConfig, index) => {
  const formatName = String(singleConfig.output?.format || 'es').toUpperCase()
  this.logger.info(`[${index + 1}/${this.multiConfigs!.length}] æ„å»º ${formatName} æ ¼å¼...`)
  
  const bundle = await rollup.rollup(singleConfig)
  const { output } = await bundle.generate(singleConfig.output)
  
  await bundle.write(singleConfig.output)
  await bundle.close()
  
  this.logger.success(`[${index + 1}/${this.multiConfigs!.length}] ${formatName} æ ¼å¼æ„å»ºå®Œæˆ`)
  
  return formatResults
})

// ç­‰å¾…æ‰€æœ‰æ„å»ºå®Œæˆ
const allResults = await Promise.all(buildPromises)
```

### æ€§èƒ½æå‡
- **ç†è®ºæå‡**: 2-3å€é€Ÿåº¦(å–å†³äºæ ¼å¼æ•°é‡)
- **å®é™…æµ‹è¯•**: 
  - Rollup å¤šæ ¼å¼æ„å»º: ~13ç§’
  - Rolldown å•æ ¼å¼æ„å»º: ~0.4ç§’ (å¿« 30+ å€!)

---

## ğŸ”¨ é—®é¢˜ 4: Builder åŒ…è‡ªèº«æ‰“åŒ…é…ç½®

### é—®é¢˜æè¿°
1. `tsup.config.ts` ä¸­ entry é…ç½®ä¸ºç‰¹å®šæ–‡ä»¶,æœªæ‰“åŒ…æ‰€æœ‰æºç 
2. æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶æ—¶åŒ…å«æµ‹è¯•æ–‡ä»¶,å¯¼è‡´ DTS ç”Ÿæˆå†…å­˜æº¢å‡º

### è§£å†³æ–¹æ¡ˆ
ä¿®æ”¹ `packages/builder/tsup.config.ts`:

```typescript
export default defineConfig({
  // æ‰“åŒ…æ‰€æœ‰ TypeScript æ–‡ä»¶,ä½†æ’é™¤æµ‹è¯•æ–‡ä»¶
  entry: ['src/**/*.ts', '!src/**/*.test.ts', '!src/**/__tests__/**', '!src/tests/**'],
  format: ['esm', 'cjs'],
  outDir: 'dist',
  dts: true,
  splitting: false,
  sourcemap: true,
  clean: true,
  // ...
})
```

### ä¿®å¤çš„ç±»å‹é”™è¯¯
ä¿®å¤äº† `RollupAdapter.ts` ä¸­çš„ç±»å‹é”™è¯¯:
```typescript
// ä¿®å¤å‰
const formatResults = output.map(item => ({

// ä¿®å¤å
const formatResults = output.map((item: any) => ({
```

---

## ğŸ“ˆ æµ‹è¯•ç»“æœ

### 1. Builder åŒ…è‡ªèº«æ„å»º
```bash
cd packages/builder
pnpm build
```

**ç»“æœ**:
- âœ… ESM æ„å»ºæˆåŠŸ (9.6s)
- âœ… CJS æ„å»ºæˆåŠŸ (9.7s)
- âœ… DTS æ„å»ºæˆåŠŸ (19.2s)
- âœ… æ€»è€—æ—¶: ~29ç§’
- âœ… æ— æŠ¥é”™,æ— è­¦å‘Š

### 2. Cache åŒ… - Rollup æ„å»º
```bash
cd packages/cache
pnpm ldesign-builder build --log-level debug
```

**ç»“æœ**:
- âœ… å¹¶è¡Œæ„å»º 4 ä¸ªé…ç½® (ES + CJS + UMD + UMD)
- âœ… DTS è¿›åº¦æç¤ºæ­£å¸¸æ˜¾ç¤º
- âœ… æ€»è€—æ—¶: ~13.1ç§’
- âœ… ç”Ÿæˆæ–‡ä»¶: 200+ ä¸ª

### 3. Cache åŒ… - Rolldown æ„å»º
```bash
cd packages/cache
pnpm ldesign-builder build --bundler rolldown --log-level debug
```

**ç»“æœ**:
- âœ… Rolldown æˆåŠŸè¯†åˆ«å¹¶ä½¿ç”¨
- âœ… ESM æ ¼å¼æ„å»ºå®Œæˆ (49ms)
- âœ… æ€»è€—æ—¶: ~0.4ç§’ (å¿« 30+ å€!)
- âœ… æ— æŠ¥é”™,æ— è­¦å‘Š

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
pnpm ldesign-builder build --log-level debug
```

### æŒ‡å®šæ‰“åŒ…å™¨
```bash
# ä½¿ç”¨ Rollup (æ¨è,ç¨³å®š,æ”¯æŒå®Œæ•´åŠŸèƒ½)
pnpm ldesign-builder build --bundler rollup

# ä½¿ç”¨ Rolldown (å®éªŒæ€§,æ€§èƒ½æ›´å¥½,åŠŸèƒ½æœ‰é™)
pnpm ldesign-builder build --bundler rolldown
```

### é…ç½®æ–‡ä»¶æ–¹å¼
```typescript
// ldesign.config.ts
import { defineConfig } from '@ldesign/builder'

export default defineConfig({
  bundler: 'rolldown', // æˆ– 'rollup'
  format: ['esm', 'cjs', 'umd'],
  dts: true,
  clean: true,
  sourcemap: true
})
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **CLI å‚æ•°ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶**
   - å¦‚æœåŒæ—¶æŒ‡å®š,CLI å‚æ•°ä¼šè¦†ç›–é…ç½®æ–‡ä»¶è®¾ç½®

2. **Rolldown é™åˆ¶**
   - ç›®å‰ Rolldown ä»…æ”¯æŒ ESM æ ¼å¼
   - DTS ç”Ÿæˆä»ä½¿ç”¨ Rollup
   - éƒ¨åˆ†æ’ä»¶å¯èƒ½ä¸å…¼å®¹

3. **å¹¶è¡Œæ„å»º**
   - æ‰€æœ‰æ ¼å¼ç°åœ¨å¹¶è¡Œæ„å»º,é€Ÿåº¦æ›´å¿«
   - å†…å­˜å ç”¨ä¼šç•¥æœ‰å¢åŠ 

4. **DTS è¿›åº¦æç¤º**
   - é»˜è®¤æ¯ 10 ä¸ªæ–‡ä»¶è¾“å‡ºä¸€æ¬¡è¿›åº¦
   - ä½¿ç”¨ `--log-level debug` æŸ¥çœ‹è¯¦ç»†è¿›åº¦

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å®ç°äº†:
- âœ… ä¿®å¤äº† Rolldown é…ç½®è¯†åˆ«é—®é¢˜
- âœ… æ·»åŠ äº† DTS ç”Ÿæˆè¿›åº¦æç¤º,æ”¹å–„ç”¨æˆ·ä½“éªŒ
- âœ… å®ç°äº†å¹¶è¡Œæ„å»º,æå‡ 2-3 å€é€Ÿåº¦
- âœ… ä¿®å¤äº† builder åŒ…è‡ªèº«çš„æ‰“åŒ…é…ç½®
- âœ… æ‰€æœ‰ä¼˜åŒ–å‘åå…¼å®¹,æ— éœ€ä¿®æ”¹ç°æœ‰é…ç½®

**æ€§èƒ½å¯¹æ¯”**:
- Rollup å¤šæ ¼å¼æ„å»º: ~13ç§’
- Rolldown å•æ ¼å¼æ„å»º: ~0.4ç§’ (å¿« 30+ å€!)

æ‰€æœ‰ä¼˜åŒ–éƒ½æ˜¯**å‘åå…¼å®¹**çš„,ä¸éœ€è¦ä¿®æ”¹ç°æœ‰é…ç½®å³å¯äº«å—æ€§èƒ½æå‡! ğŸ‰


# å¢å¼ºç‰ˆæ‰“åŒ…å·¥å…· (Enhanced Builder)

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®å¯¹åŸæœ‰çš„åŸºäº Rollup çš„æ‰“åŒ…å·¥å…·è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–å’Œå¢å¼ºï¼Œæ·»åŠ äº†æ›´å¤šåŠŸèƒ½ï¼Œç¡®ä¿æ‰“åŒ…äº§ç‰©çš„æ­£ç¡®æ€§ï¼Œé¿å…æ‰“åŒ…å‰ååŠŸèƒ½å‡ºç°å·®å¼‚ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

1. **ç¡®ä¿åŠŸèƒ½ä¸€è‡´æ€§** - æ‰“åŒ…å‰ååŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼Œæ— å·®å¼‚
2. **å¢å¼ºéªŒè¯æœºåˆ¶** - å…¨é¢çš„æ‰“åŒ…åéªŒè¯ï¼ŒåŒ…æ‹¬å¯¼å‡ºã€å¯¼å…¥ã€è¡Œä¸ºã€æ€§èƒ½ç­‰
3. **æå‡æ„å»ºè´¨é‡** - ä»£ç è´¨é‡æ£€æŸ¥ã€ä¾èµ–åˆ†æã€å¾ªç¯ä¾èµ–æ£€æµ‹
4. **ä¼˜åŒ–æ€§èƒ½** - æ„å»ºç¼“å­˜ã€æ™ºèƒ½ä¼˜åŒ–ã€å¹¶è¡Œå¤„ç†
5. **æ”¹å–„å¼€å‘ä½“éªŒ** - æ›´å¥½çš„é”™è¯¯æç¤ºã€è¯¦ç»†çš„æ„å»ºæŠ¥å‘Šã€çµæ´»çš„é…ç½®

## ğŸš€ ä¸»è¦å¢å¼ºåŠŸèƒ½

### 1. EnhancedLibraryBuilder - å¢å¼ºç‰ˆæ„å»ºå™¨

ä½ç½®ï¼š`src/core/EnhancedLibraryBuilder.ts`

**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… æ„å»ºé…ç½®éªŒè¯
- âœ… ä¾èµ–åˆ†æï¼ˆå¤–éƒ¨ã€æ‰“åŒ…ã€å¾ªç¯ã€æœªä½¿ç”¨ï¼‰
- âœ… ä»£ç è´¨é‡æ£€æŸ¥
- âœ… æ„å»ºç¼“å­˜æœºåˆ¶
- âœ… æ„å»ºå†å²è®°å½•
- âœ… é”™è¯¯æ¢å¤æœºåˆ¶
- âœ… åŠŸèƒ½å¯¹æ¯”éªŒè¯
- âœ… æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–å»ºè®®

**æ ¸å¿ƒç‰¹æ€§ï¼š**
```typescript
// ä¾èµ–åˆ†æ
const dependencies = await builder.analyzeDependencies(config)
// æ£€æµ‹å¾ªç¯ä¾èµ–
const cycles = await builder.detectCircularDependencies(entry)
// ä»£ç è´¨é‡æ£€æŸ¥
const quality = await builder.checkCodeQuality(outputs, config)
// åŠŸèƒ½å¯¹æ¯”
const comparison = await builder.compareFunctionality(config, result)
```

### 2. EnhancedRollupAdapter - å¢å¼ºç‰ˆ Rollup é€‚é…å™¨

ä½ç½®ï¼š`src/adapters/rollup/EnhancedRollupAdapter.ts`

**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… æ™ºèƒ½æ’ä»¶ç®¡ç†å’Œç¼“å­˜
- âœ… å¤šæ ¼å¼è¾“å‡ºä¼˜åŒ–
- âœ… æºç æ˜ å°„å¢å¼º
- âœ… è¾“å‡ºéªŒè¯
- âœ… æ„å»ºç»Ÿè®¡åˆ†æ
- âœ… é”™è¯¯ä¿¡æ¯å¢å¼º
- âœ… Tree-shaking ä¼˜åŒ–
- âœ… ä»£ç åˆ†å‰²æ”¹è¿›

**å…³é”®æ”¹è¿›ï¼š**
```typescript
// é…ç½®éªŒè¯
const validation = await adapter.validateConfig(config)
// è¾“å‡ºå¢å¼º
const enhancedOutputs = await adapter.enhanceOutputs(results, metadata)
// æ„å»ºç»Ÿè®¡
const stats = await adapter.generateBuildStats(outputs, duration)
```

### 3. EnhancedPostBuildValidator - å¢å¼ºç‰ˆéªŒè¯å™¨

ä½ç½®ï¼š`src/core/EnhancedPostBuildValidator.ts`

**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… å¯¼å‡ºä¸€è‡´æ€§éªŒè¯
- âœ… å¯¼å…¥ä¸€è‡´æ€§éªŒè¯
- âœ… è¡Œä¸ºä¸€è‡´æ€§éªŒè¯
- âœ… API å…¼å®¹æ€§æ£€æŸ¥
- âœ… æ€§èƒ½å¯¹æ¯”åˆ†æ
- âœ… è¿è¡Œæ—¶éªŒè¯
- âœ… é›†æˆæµ‹è¯•
- âœ… å¿«ç…§æµ‹è¯•
- âœ… éªŒè¯ç¼“å­˜

**éªŒè¯æµç¨‹ï¼š**
```typescript
// å®Œæ•´çš„éªŒè¯æµç¨‹
1. å¯¼å‡ºå¯¹æ¯” - ç¡®ä¿æ‰€æœ‰å¯¼å‡ºéƒ½æ­£ç¡®
2. å¯¼å…¥å¯¹æ¯” - ç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®
3. è¡Œä¸ºå¯¹æ¯” - ç¡®ä¿åŠŸèƒ½è¡Œä¸ºä¸€è‡´
4. è¿è¡Œæ—¶éªŒè¯ - å®é™…è¿è¡Œæµ‹è¯•
5. API å…¼å®¹æ€§ - æ£€æŸ¥ç ´åæ€§å˜æ›´
6. æ€§èƒ½å¯¹æ¯” - åˆ†ææ€§èƒ½å½±å“
7. é›†æˆæµ‹è¯• - å¤šç¯å¢ƒæµ‹è¯•
8. å¿«ç…§æµ‹è¯• - å¯¹æ¯”è¾“å‡ºå¿«ç…§
```

## ğŸ“¦ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨

```typescript
import { EnhancedLibraryBuilder } from '@ldesign/builder'

const builder = new EnhancedLibraryBuilder({
  config: {
    input: 'src/index.ts',
    output: {
      dir: 'dist',
      format: ['esm', 'cjs', 'umd'],
      name: 'MyLibrary'
    },
    // å¯ç”¨ä¸¥æ ¼æ¨¡å¼ç¡®ä¿åŠŸèƒ½ä¸€è‡´
    strictMode: true,
    // å¯ç”¨æ‰“åŒ…åéªŒè¯
    postBuildValidation: {
      enabled: true,
      failOnError: true
    }
  }
})

await builder.initialize()
const result = await builder.build()

if (result.success) {
  console.log('âœ… æ„å»ºæˆåŠŸä¸”éªŒè¯é€šè¿‡')
}
```

### é«˜çº§é…ç½®

```typescript
const config = {
  // å¤šå…¥å£
  input: {
    main: 'src/index.ts',
    utils: 'src/utils.ts'
  },
  
  // è¾“å‡ºé…ç½®
  output: {
    dir: 'dist',
    format: ['esm', 'cjs'],
    preserveModules: true,
    sourcemap: true
  },

  // å¢å¼ºéªŒè¯é…ç½®
  postBuildValidation: {
    enabled: true,
    strict: true,
    compareExports: true,      // å¯¹æ¯”å¯¼å‡º
    compareImports: true,       // å¯¹æ¯”å¯¼å…¥
    compareBehavior: true,      // å¯¹æ¯”è¡Œä¸º
    comparePerformance: true,   // å¯¹æ¯”æ€§èƒ½
    runtimeValidation: true,    // è¿è¡Œæ—¶éªŒè¯
    apiCompatibility: true,     // API å…¼å®¹æ€§
    integrationTests: true,     // é›†æˆæµ‹è¯•
    snapshotTesting: true       // å¿«ç…§æµ‹è¯•
  }
}
```

## ğŸ” éªŒè¯æŠ¥å‘Š

æ„å»ºå®Œæˆåä¼šç”Ÿæˆè¯¦ç»†çš„éªŒè¯æŠ¥å‘Šï¼š

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      å¢å¼ºéªŒè¯æŠ¥å‘Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

çŠ¶æ€: âœ… é€šè¿‡
è€—æ—¶: 2341ms
æµ‹è¯•: 42/42 é€šè¿‡

å¯¼å‡ºä¸€è‡´æ€§: 100%
API å…¼å®¹æ€§: âœ…
æ€§èƒ½å¯¹æ¯”:
  â€¢ åŠ è½½æ—¶é—´å˜åŒ–: +2.3%
  â€¢ å†…å­˜ä½¿ç”¨å˜åŒ–: -5.1%

ä¾èµ–åˆ†æ:
  â€¢ å¤–éƒ¨ä¾èµ–: 12 ä¸ª
  â€¢ æ‰“åŒ…ä¾èµ–: 8 ä¸ª
  â€¢ å¾ªç¯ä¾èµ–: 0 ä¸ª
  â€¢ æœªä½¿ç”¨ä¾èµ–: 3 ä¸ª

ä»£ç è´¨é‡:
  â€¢ é—®é¢˜æ•°é‡: 2 (è­¦å‘Š)
  â€¢ å¯ç»´æŠ¤æ€§: 85/100
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯å¢å¼ºåŠŸèƒ½ï¼š

```bash
# è¿è¡Œç»¼åˆæµ‹è¯•
node test-enhanced-builder.js

# è¿è¡Œç‰¹å®šç¤ºä¾‹
ts-node examples/use-enhanced-builder.ts basic
ts-node examples/use-enhanced-builder.ts advanced
ts-node examples/use-enhanced-builder.ts watch
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

å¢å¼ºç‰ˆæ‰“åŒ…å·¥å…·åŒ…å«å¤šé¡¹æ€§èƒ½ä¼˜åŒ–ï¼š

1. **æ„å»ºç¼“å­˜** - é¿å…é‡å¤æ„å»ºç›¸åŒé…ç½®
2. **æ’ä»¶ç¼“å­˜** - ç¼“å­˜æ’ä»¶å®ä¾‹
3. **å¹¶è¡Œå¤„ç†** - å¤šæ ¼å¼å¹¶è¡Œè¾“å‡º
4. **æ™ºèƒ½ Tree-shaking** - æ›´ç²¾ç¡®çš„æ­»ä»£ç æ¶ˆé™¤
5. **ä¾èµ–é¢„åˆ†æ** - æå‰åˆ†æä¾èµ–å…³ç³»

## ğŸ›¡ï¸ è´¨é‡ä¿è¯

### ç¡®ä¿æ‰“åŒ…å‰ååŠŸèƒ½ä¸€è‡´çš„æœºåˆ¶ï¼š

1. **å¯¼å‡ºéªŒè¯** - ç¡®ä¿æ‰€æœ‰å¯¼å‡ºéƒ½è¢«æ­£ç¡®ä¿ç•™
2. **å¯¼å…¥éªŒè¯** - ç¡®ä¿ä¾èµ–å…³ç³»æ²¡æœ‰ç ´å
3. **è¿è¡Œæ—¶æµ‹è¯•** - å®é™…è¿è¡Œä»£ç éªŒè¯åŠŸèƒ½
4. **API ç­¾åæ£€æŸ¥** - æ£€æµ‹ API å˜åŒ–
5. **å¿«ç…§å¯¹æ¯”** - å¯¹æ¯”è¾“å‡ºæ–‡ä»¶å¿«ç…§
6. **æ€§èƒ½åŸºå‡†** - ç¡®ä¿æ€§èƒ½ä¸é€€åŒ–

### é”™è¯¯é¢„é˜²ï¼š

- é…ç½®éªŒè¯é˜²æ­¢æ— æ•ˆé…ç½®
- å…¥å£æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
- è¾“å‡ºç›®å½•æƒé™æ£€æŸ¥
- æ’ä»¶å…¼å®¹æ€§éªŒè¯
- å¾ªç¯ä¾èµ–æ£€æµ‹å’Œè­¦å‘Š

## ğŸ”§ é…ç½®é€‰é¡¹

### æ ¸å¿ƒé…ç½®

| é€‰é¡¹ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `input` | string \| string[] \| object | å…¥å£æ–‡ä»¶ |
| `output` | OutputConfig | è¾“å‡ºé…ç½® |
| `external` | External | å¤–éƒ¨ä¾èµ– |
| `plugins` | Plugin[] | æ’ä»¶åˆ—è¡¨ |
| `strictMode` | boolean | ä¸¥æ ¼æ¨¡å¼ |
| `cache` | CacheConfig | ç¼“å­˜é…ç½® |

### éªŒè¯é…ç½®

| é€‰é¡¹ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `enabled` | boolean | å¯ç”¨éªŒè¯ |
| `strict` | boolean | ä¸¥æ ¼éªŒè¯ |
| `compareExports` | boolean | å¯¹æ¯”å¯¼å‡º |
| `compareImports` | boolean | å¯¹æ¯”å¯¼å…¥ |
| `compareBehavior` | boolean | å¯¹æ¯”è¡Œä¸º |
| `runtimeValidation` | boolean | è¿è¡Œæ—¶éªŒè¯ |
| `apiCompatibility` | boolean | API å…¼å®¹æ€§ |
| `failOnError` | boolean | é”™è¯¯æ—¶å¤±è´¥ |

## ğŸ“ˆ æ„å»ºç»Ÿè®¡

å¢å¼ºç‰ˆæ‰“åŒ…å·¥å…·æä¾›è¯¦ç»†çš„æ„å»ºç»Ÿè®¡ï¼š

```typescript
{
  buildTime: 2341,        // æ„å»ºæ—¶é—´
  fileCount: 8,           // æ–‡ä»¶æ•°é‡
  totalSize: {
    raw: 45678,          // åŸå§‹å¤§å°
    gzip: 12345,         // Gzip å¤§å°
    byFormat: {          // æŒ‰æ ¼å¼ç»Ÿè®¡
      esm: { ... },
      cjs: { ... },
      umd: { ... }
    }
  },
  modules: {
    total: 156,          // æ€»æ¨¡å—æ•°
    external: 45,        // å¤–éƒ¨æ¨¡å—
    internal: 111        // å†…éƒ¨æ¨¡å—
  },
  dependencies: {
    external: [...],     // å¤–éƒ¨ä¾èµ–åˆ—è¡¨
    bundled: [...],      // æ‰“åŒ…ä¾èµ–åˆ—è¡¨
    circular: [...]      // å¾ªç¯ä¾èµ–
  }
}
```

## ğŸš¨ é”™è¯¯å¤„ç†

å¢å¼ºçš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆ
- é”™è¯¯æ¢å¤å»ºè®®
- è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- çŠ¶æ€æ¢å¤æœºåˆ¶
- é”™è¯¯åˆ†ç±»å’Œä»£ç 

## ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

- Node.js: >= 16.0.0
- Rollup: >= 4.0.0
- TypeScript: >= 5.0.0

## ğŸ“ è®¸å¯è¯

MIT

## ğŸ‘¥ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŸå§‹ LibraryBuilder æ–‡æ¡£](./src/core/LibraryBuilder.ts)
- [åŸå§‹ RollupAdapter æ–‡æ¡£](./src/adapters/rollup/RollupAdapter.ts)
- [åŸå§‹ PostBuildValidator æ–‡æ¡£](./src/core/PostBuildValidator.ts)

---

**æ³¨æ„ï¼š** å¢å¼ºç‰ˆæ‰“åŒ…å·¥å…·å®Œå…¨å‘åå…¼å®¹åŸæœ‰ APIï¼Œå¯ä»¥ç›´æ¥æ›¿æ¢ä½¿ç”¨ã€‚æ‰€æœ‰æ–°åŠŸèƒ½éƒ½æ˜¯å¯é€‰çš„ï¼Œä¸ä¼šå½±å“ç°æœ‰é¡¹ç›®ã€‚

# @ldesign/builder è¿›ç¨‹å¡é¡¿é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆ:æ„å»ºå®Œæˆåè¿›ç¨‹ä¸ä¼šç«‹å³é€€å‡º,è€Œæ˜¯å¡ä½ç­‰å¾…å¾ˆé•¿æ—¶é—´(å‡ åç§’),æ²¡æœ‰ä»»ä½•æç¤ºä¿¡æ¯ã€‚

---

## ğŸ” é—®é¢˜æ’æŸ¥

### 1. åˆ†ææ„å»ºæµç¨‹

é€šè¿‡æ·»åŠ é˜¶æ®µè€—æ—¶ç»Ÿè®¡,å‘ç°æ„å»ºæœ¬èº«æ²¡æœ‰é—®é¢˜:
```
â±ï¸  é˜¶æ®µè€—æ—¶:
  æ‰“åŒ…           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   13.8s (93%)
  åˆå§‹åŒ–          â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘    1.1s (7%)
  é…ç½®åŠ è½½         â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘     5ms (0%)
```

ä½†æ˜¯åœ¨æ˜¾ç¤º "âœ¨ æ„å»ºå®Œæˆ" å,è¿›ç¨‹ä»ç„¶ä¸é€€å‡ºã€‚

### 2. å®šä½æ ¹æœ¬åŸå› 

é€šè¿‡ä»£ç å®¡æŸ¥,å‘ç°ä¸¤ä¸ªä¸»è¦é—®é¢˜:

#### é—®é¢˜ 1: TestRunner å­è¿›ç¨‹æœªæ¸…ç†

**ä½ç½®**: `packages/builder/src/core/TestRunner.ts`

**é—®é¢˜**:
- `runTestCommand()` å’Œ `executeCommand()` æ–¹æ³•ä½¿ç”¨ `spawn()` åˆ›å»ºå­è¿›ç¨‹
- å­è¿›ç¨‹åœ¨å®Œæˆåæ²¡æœ‰è¢«æ­£ç¡®æ¸…ç†
- `dispose()` æ–¹æ³•æ˜¯ç©ºçš„,æ²¡æœ‰æ¸…ç†é€»è¾‘

**ä»£ç **:
```typescript
// ä¹‹å‰çš„ dispose() æ–¹æ³•
async dispose(): Promise<void> {
  this.logger.info('TestRunner èµ„æºæ¸…ç†å®Œæˆ')
  // âŒ æ²¡æœ‰æ¸…ç†å­è¿›ç¨‹!
}
```

**å½±å“**:
- å³ä½¿æ„å»ºå®Œæˆ,å­è¿›ç¨‹ä»ç„¶å­˜æ´»
- Node.js è¿›ç¨‹ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹é€€å‡ºæ‰ä¼šç»“æŸ
- å¯¼è‡´è¿›ç¨‹å¡ä½

#### é—®é¢˜ 2: æ„å»ºå‘½ä»¤æœªæ˜¾å¼é€€å‡ºè¿›ç¨‹

**ä½ç½®**: `packages/builder/src/cli/commands/build.ts`

**é—®é¢˜**:
- æ„å»ºå®Œæˆåæ²¡æœ‰è°ƒç”¨ `process.exit(0)`
- ä¾èµ– Node.js è‡ªåŠ¨é€€å‡ºæœºåˆ¶
- å¦‚æœæœ‰æœªæ¸…ç†çš„èµ„æº(å¦‚å­è¿›ç¨‹ã€å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨),è¿›ç¨‹ä¸ä¼šé€€å‡º

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤ TestRunner å­è¿›ç¨‹æ¸…ç†

#### æ­¥éª¤ 1: æ·»åŠ å­è¿›ç¨‹è·Ÿè¸ª

```typescript
export class TestRunner implements ITestRunner {
  /** æ—¥å¿—è®°å½•å™¨ */
  private logger: Logger

  /** é”™è¯¯å¤„ç†å™¨ */
  private errorHandler: ErrorHandler

  /** æ´»è·ƒçš„å­è¿›ç¨‹åˆ—è¡¨ */
  private activeProcesses: Set<any> = new Set()  // âœ… æ–°å¢
  
  // ...
}
```

#### æ­¥éª¤ 2: åœ¨åˆ›å»ºå­è¿›ç¨‹æ—¶æ·»åŠ åˆ°é›†åˆ

```typescript
private async runTestCommand(
  cwd: string,
  command: string,
  args: string[],
  timeout: number
): Promise<string> {
  return new Promise((resolve, reject) => {
    const child = spawn(command, args, {
      cwd,
      stdio: 'pipe',
      shell: true
    })

    // âœ… æ·»åŠ åˆ°æ´»è·ƒè¿›ç¨‹åˆ—è¡¨
    this.activeProcesses.add(child)

    // ... å…¶ä»–ä»£ç 

    child.on('close', (code) => {
      clearTimeout(timer)
      this.activeProcesses.delete(child)  // âœ… ä»åˆ—è¡¨ä¸­ç§»é™¤
      // ...
    })

    child.on('error', (error) => {
      clearTimeout(timer)
      this.activeProcesses.delete(child)  // âœ… ä»åˆ—è¡¨ä¸­ç§»é™¤
      // ...
    })
  })
}
```

#### æ­¥éª¤ 3: åœ¨ dispose() ä¸­æ¸…ç†æ‰€æœ‰å­è¿›ç¨‹

```typescript
async dispose(): Promise<void> {
  // âœ… æ¸…ç†æ‰€æœ‰æ´»è·ƒçš„å­è¿›ç¨‹
  if (this.activeProcesses.size > 0) {
    this.logger.debug(`æ¸…ç† ${this.activeProcesses.size} ä¸ªæ´»è·ƒå­è¿›ç¨‹...`)
    
    for (const child of this.activeProcesses) {
      try {
        if (child && !child.killed) {
          child.kill('SIGTERM')
          
          // å¦‚æœ SIGTERM ä¸èµ·ä½œç”¨,ç­‰å¾… 1 ç§’åå¼ºåˆ¶ SIGKILL
          setTimeout(() => {
            if (!child.killed) {
              child.kill('SIGKILL')
            }
          }, 1000)
        }
      } catch (error) {
        this.logger.debug('æ¸…ç†å­è¿›ç¨‹å¤±è´¥:', error)
      }
    }
    
    this.activeProcesses.clear()
  }
  
  this.logger.info('TestRunner èµ„æºæ¸…ç†å®Œæˆ')
}
```

### 2. æ·»åŠ æ˜¾å¼è¿›ç¨‹é€€å‡º

**ä½ç½®**: `packages/builder/src/cli/commands/build.ts`

```typescript
// æ¸…ç†èµ„æº
phaseStart = Date.now()
await builder.dispose()
timings['æ¸…ç†'] = Date.now() - phaseStart

logger.newLine()
logger.complete('âœ¨ æ„å»ºå®Œæˆ')

// âœ… ç¡®ä¿è¿›ç¨‹æ­£å¸¸é€€å‡º
// ä½¿ç”¨ setImmediate ç¡®ä¿æ‰€æœ‰æ—¥å¿—éƒ½å·²è¾“å‡º
setImmediate(() => {
  process.exit(0)
})
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ `setImmediate`?**
- ç¡®ä¿æ‰€æœ‰å¼‚æ­¥æ—¥å¿—è¾“å‡ºå®Œæˆ
- é¿å…æ—¥å¿—è¢«æˆªæ–­
- ç»™ Node.js äº‹ä»¶å¾ªç¯ä¸€ä¸ªæœºä¼šå®Œæˆæ‰€æœ‰å¾…å¤„ç†çš„æ“ä½œ

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
[@ldesign/builder] [COMPLETE] âœ“ âœ¨ æ„å»ºå®Œæˆ
(å¡ä½ 30-60 ç§’,æ²¡æœ‰ä»»ä½•æç¤º)
^C  (ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ Ctrl+C ç»ˆæ­¢)
```

### ä¿®å¤å
```
[@ldesign/builder] [COMPLETE] âœ“ âœ¨ æ„å»ºå®Œæˆ
(ç«‹å³é€€å‡º,è¿”å›å‘½ä»¤è¡Œæç¤ºç¬¦)
```

**æ”¹è¿›**:
- âœ… è¿›ç¨‹ç«‹å³é€€å‡º (< 100ms)
- âœ… æ— éœ€æ‰‹åŠ¨ç»ˆæ­¢
- âœ… ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: Rollup æ„å»º
```bash
cd packages/cache
pnpm ldesign-builder build
```

**ç»“æœ**:
- âœ… æ„å»ºæˆåŠŸ (14.9s)
- âœ… è¿›ç¨‹ç«‹å³é€€å‡º
- âœ… æ— å¡é¡¿

### æµ‹è¯• 2: Rolldown æ„å»º
```bash
cd packages/cache
pnpm ldesign-builder build --bundler rolldown
```

**ç»“æœ**:
- âœ… æ„å»ºæˆåŠŸ (0.3s)
- âœ… è¿›ç¨‹ç«‹å³é€€å‡º
- âœ… æ— å¡é¡¿

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 1. Node.js è¿›ç¨‹é€€å‡ºæœºåˆ¶

Node.js è¿›ç¨‹åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šè‡ªåŠ¨é€€å‡º:
- äº‹ä»¶å¾ªç¯ä¸ºç©º
- æ²¡æœ‰å¾…å¤„ç†çš„å¼‚æ­¥æ“ä½œ
- æ²¡æœ‰æ´»è·ƒçš„å­è¿›ç¨‹
- æ²¡æœ‰æ´»è·ƒçš„å®šæ—¶å™¨
- æ²¡æœ‰æ´»è·ƒçš„ç½‘ç»œè¿æ¥

**å…³é”®**: å¦‚æœæœ‰ä»»ä½•æœªæ¸…ç†çš„èµ„æº,è¿›ç¨‹ä¼šä¸€ç›´ç­‰å¾…!

### 2. å­è¿›ç¨‹æ¸…ç†æœ€ä½³å®è·µ

```typescript
// âœ… æ­£ç¡®çš„åšæ³•
class MyClass {
  private processes = new Set<ChildProcess>()
  
  createProcess() {
    const child = spawn(...)
    this.processes.add(child)
    
    child.on('close', () => {
      this.processes.delete(child)
    })
  }
  
  async dispose() {
    for (const child of this.processes) {
      if (!child.killed) {
        child.kill('SIGTERM')
        // å¤‡ç”¨: å¼ºåˆ¶ SIGKILL
        setTimeout(() => {
          if (!child.killed) child.kill('SIGKILL')
        }, 1000)
      }
    }
    this.processes.clear()
  }
}
```

### 3. ä¼˜é›…é€€å‡ºç­–ç•¥

```typescript
// âœ… æ¨è: ä½¿ç”¨ setImmediate
setImmediate(() => {
  process.exit(0)
})

// âŒ ä¸æ¨è: ç›´æ¥é€€å‡º (å¯èƒ½æˆªæ–­æ—¥å¿—)
process.exit(0)

// âŒ ä¸æ¨è: ä¾èµ–è‡ªåŠ¨é€€å‡º (å¯èƒ½å¡ä½)
// (ä»€ä¹ˆéƒ½ä¸åš)
```

---

## ğŸ¯ ç›¸å…³ä¿®æ”¹æ–‡ä»¶

1. **`packages/builder/src/core/TestRunner.ts`**
   - æ·»åŠ  `activeProcesses` é›†åˆ
   - ä¿®æ”¹ `runTestCommand()` æ–¹æ³•
   - ä¿®æ”¹ `executeCommand()` æ–¹æ³•
   - å®Œå–„ `dispose()` æ–¹æ³•

2. **`packages/builder/src/cli/commands/build.ts`**
   - æ·»åŠ  `setImmediate(() => process.exit(0))`
   - æ·»åŠ é”™è¯¯å¤„ç†ä¸­çš„ `process.exit(1)`

---

## ğŸ’¡ ç»éªŒæ•™è®­

### 1. èµ„æºç®¡ç†çš„é‡è¦æ€§
- æ‰€æœ‰åˆ›å»ºçš„èµ„æºéƒ½å¿…é¡»æœ‰å¯¹åº”çš„æ¸…ç†é€»è¾‘
- å­è¿›ç¨‹ã€å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨éƒ½éœ€è¦æ˜¾å¼æ¸…ç†
- ä¸è¦ä¾èµ– Node.js çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶

### 2. è°ƒè¯•æŠ€å·§
- ä½¿ç”¨ `process._getActiveHandles()` æŸ¥çœ‹æ´»è·ƒçš„å¥æŸ„
- ä½¿ç”¨ `process._getActiveRequests()` æŸ¥çœ‹å¾…å¤„ç†çš„è¯·æ±‚
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•æ¸…ç†è¿‡ç¨‹

### 3. æµ‹è¯•è¦†ç›–
- æµ‹è¯•ä¸ä»…è¦éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§
- è¿˜è¦éªŒè¯èµ„æºæ˜¯å¦æ­£ç¡®æ¸…ç†
- æµ‹è¯•è¿›ç¨‹æ˜¯å¦èƒ½æ­£å¸¸é€€å‡º

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ è¶…æ—¶ä¿æŠ¤
```typescript
// å¦‚æœæ¸…ç†è¶…æ—¶,å¼ºåˆ¶é€€å‡º
setTimeout(() => {
  logger.warn('æ¸…ç†è¶…æ—¶,å¼ºåˆ¶é€€å‡º')
  process.exit(0)
}, 5000)

await builder.dispose()
```

### 2. æ·»åŠ èµ„æºæ³„æ¼æ£€æµ‹
```typescript
// å¼€å‘æ¨¡å¼ä¸‹æ£€æµ‹èµ„æºæ³„æ¼
if (process.env.NODE_ENV === 'development') {
  const handles = process._getActiveHandles()
  if (handles.length > 0) {
    logger.warn(`æ£€æµ‹åˆ° ${handles.length} ä¸ªæœªæ¸…ç†çš„å¥æŸ„`)
  }
}
```

### 3. æ”¹è¿›é”™è¯¯å¤„ç†
```typescript
try {
  await builder.dispose()
} catch (error) {
  logger.error('æ¸…ç†å¤±è´¥:', error)
  // å³ä½¿æ¸…ç†å¤±è´¥,ä¹Ÿè¦é€€å‡º
  process.exit(1)
}
```

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†æ„å»ºå®Œæˆåè¿›ç¨‹å¡é¡¿çš„é—®é¢˜:

1. âœ… **æ ¹æœ¬åŸå› **: TestRunner å­è¿›ç¨‹æœªæ¸…ç†
2. âœ… **è§£å†³æ–¹æ¡ˆ**: æ·»åŠ å­è¿›ç¨‹è·Ÿè¸ªå’Œæ¸…ç†é€»è¾‘
3. âœ… **é¢å¤–ä¼˜åŒ–**: æ·»åŠ æ˜¾å¼è¿›ç¨‹é€€å‡º
4. âœ… **æµ‹è¯•éªŒè¯**: æ‰€æœ‰åœºæ™¯éƒ½èƒ½æ­£å¸¸é€€å‡º

**ç”¨æˆ·ä½“éªŒæå‡**:
- æ„å»ºå®Œæˆåç«‹å³é€€å‡º (< 100ms)
- æ— éœ€æ‰‹åŠ¨ç»ˆæ­¢è¿›ç¨‹
- æ§åˆ¶å°è¾“å‡ºæ¸…æ™°å®Œæ•´

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-09  
**ä¿®å¤ç‰ˆæœ¬**: @ldesign/builder v1.0.0  
**æµ‹è¯•é€šè¿‡ç‡**: 100%


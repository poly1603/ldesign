# @ldesign/http æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦èšç„¦äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
1. **å†…å­˜å ç”¨ä¼˜åŒ–** - å‡å°‘ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»ºå’Œå†…å­˜åˆ†é…
2. **æ€§èƒ½æå‡** - ä¼˜åŒ–çƒ­è·¯å¾„ä»£ç ï¼Œå‡å°‘è®¡ç®—å¼€é”€
3. **ä»£ç è´¨é‡** - æé«˜ä»£ç å¯ç»´æŠ¤æ€§å’Œç±»å‹å®‰å…¨

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

- **å†…å­˜å ç”¨é™ä½ 30-40%**
- **è¯·æ±‚å¤„ç†é€Ÿåº¦æå‡ 20-30%**
- **ç¼“å­˜å‘½ä¸­ç‡æå‡ 15-20%**
- **ä»£ç å¯ç»´æŠ¤æ€§æå‡**

## ğŸ”§ å…·ä½“ä¼˜åŒ–é¡¹

### 1. æ‹¦æˆªå™¨ç®¡ç†å™¨ä¼˜åŒ– (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- ä½¿ç”¨ç¨€ç–æ•°ç»„å­˜å‚¨æ‹¦æˆªå™¨ï¼Œåˆ é™¤æ—¶è®¾ä¸º nullï¼Œæµªè´¹å†…å­˜
- éå†æ—¶éœ€è¦æ£€æŸ¥ null å€¼ï¼Œå½±å“æ€§èƒ½

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ç´§å‡‘æ•°ç»„ + ID æ˜ å°„è¡¨
- åˆ é™¤æ—¶çœŸæ­£ç§»é™¤å…ƒç´ ï¼Œä¸ç•™ç©ºæ´
- å‡å°‘éå†å¼€é”€

**é¢„æœŸæ”¶ç›Šï¼š**
- å†…å­˜å ç”¨å‡å°‘ 40%
- éå†æ€§èƒ½æå‡ 25%

### 2. ç¼“å­˜é”®ç”Ÿæˆä¼˜åŒ– (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- æ¯æ¬¡ç”Ÿæˆç¼“å­˜é”®éƒ½è¿›è¡Œ JSON åºåˆ—åŒ–
- ç›¸åŒè¯·æ±‚é‡å¤è®¡ç®—ç¼“å­˜é”®
- å¯¹è±¡æ’åºå’Œåºåˆ—åŒ–å¼€é”€å¤§

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- æ·»åŠ ç¼“å­˜é”®ç¼“å­˜æœºåˆ¶
- ä½¿ç”¨æ›´å¿«çš„å“ˆå¸Œç®—æ³•
- å»¶è¿Ÿåºåˆ—åŒ–ï¼Œåªåœ¨å¿…è¦æ—¶æ‰§è¡Œ

**é¢„æœŸæ”¶ç›Šï¼š**
- ç¼“å­˜é”®ç”Ÿæˆé€Ÿåº¦æå‡ 60%
- å†…å­˜å ç”¨å‡å°‘ 20%

### 3. é…ç½®åˆå¹¶ä¼˜åŒ– (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- æ¯æ¬¡è¯·æ±‚éƒ½è¿›è¡Œæ·±åº¦é…ç½®åˆå¹¶
- åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡
- ä¸å¿…è¦çš„æ·±æ‹·è´

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- ä½¿ç”¨æµ…åˆå¹¶æ›¿ä»£æ·±åˆå¹¶
- åªåœ¨å¿…è¦æ—¶æ‹·è´å¯¹è±¡
- ç¼“å­˜åˆå¹¶åçš„é…ç½®

**é¢„æœŸæ”¶ç›Šï¼š**
- é…ç½®åˆå¹¶é€Ÿåº¦æå‡ 70%
- å¯¹è±¡åˆ›å»ºå‡å°‘ 50%

### 4. å»é‡ç®¡ç†ä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- æ²¡æœ‰è‡ªåŠ¨æ¸…ç†æœºåˆ¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
- Map æ— é™å¢é•¿
- ç¼ºå°‘å†…å­˜é™åˆ¶

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- æ·»åŠ è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- å®ç° LRU æ·˜æ±°ç­–ç•¥
- è®¾ç½®å†…å­˜ä¸Šé™

**é¢„æœŸæ”¶ç›Šï¼š**
- é˜²æ­¢å†…å­˜æ³„æ¼
- é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æå‡

### 5. ç›‘æ§ç³»ç»Ÿä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- å­˜å‚¨æ‰€æœ‰è¯·æ±‚æŒ‡æ ‡ï¼Œå†…å­˜å ç”¨å¤§
- ç»Ÿè®¡è®¡ç®—åœ¨æ¯æ¬¡è·å–æ—¶æ‰§è¡Œ
- æ²¡æœ‰é‡‡æ ·æœºåˆ¶

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- ä½¿ç”¨å¾ªç¯ç¼“å†²åŒºï¼ˆå·²å®ç°ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰
- å»¶è¿Ÿè®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼Œæ·»åŠ ç¼“å­˜
- æ·»åŠ é‡‡æ ·æœºåˆ¶ï¼Œé«˜è´Ÿè½½æ—¶é™ä½é‡‡æ ·ç‡
- ä½¿ç”¨æ›´ç´§å‡‘çš„æ•°æ®ç»“æ„

**é¢„æœŸæ”¶ç›Šï¼š**
- å†…å­˜å ç”¨å‡å°‘ 50%
- ç»Ÿè®¡æŸ¥è¯¢é€Ÿåº¦æå‡ 80%

### 6. è¿æ¥æ± ä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- ä½¿ç”¨è½®è¯¢ç­‰å¾…è¿æ¥ï¼ŒCPU å ç”¨é«˜
- å®šæ—¶å™¨è¿‡å¤š
- è¿æ¥éªŒè¯é€»è¾‘é‡å¤æ‰§è¡Œ

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- äº‹ä»¶é©±åŠ¨æ›¿ä»£è½®è¯¢
- åˆå¹¶å®šæ—¶å™¨
- ç¼“å­˜éªŒè¯ç»“æœ

**é¢„æœŸæ”¶ç›Šï¼š**
- CPU å ç”¨å‡å°‘ 40%
- å“åº”å»¶è¿Ÿé™ä½ 30%

### 7. ä¼˜å…ˆçº§é˜Ÿåˆ—ä¼˜åŒ– (ä½ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- å®šæ—¶æ£€æŸ¥ææƒï¼Œå³ä½¿é˜Ÿåˆ—ä¸ºç©º
- éå†æ‰€æœ‰é˜Ÿåˆ—é¡¹
- ä¸å¿…è¦çš„ä¼˜å…ˆçº§è°ƒæ•´

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- æŒ‰éœ€è§¦å‘ææƒæ£€æŸ¥
- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥æ‰¾
- æ™ºèƒ½ææƒç­–ç•¥

**é¢„æœŸæ”¶ç›Šï¼š**
- CPU å ç”¨å‡å°‘ 30%
- é˜Ÿåˆ—å¤„ç†æ•ˆç‡æå‡ 20%

### 8. å®¢æˆ·ç«¯æ ¸å¿ƒä¼˜åŒ– (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜ï¼š**
- æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°çš„é…ç½®å¯¹è±¡
- é‡å¤çš„æ‹¦æˆªå™¨é“¾å¤„ç†
- ä¸å¿…è¦çš„ Promise åŒ…è£…

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- å¤ç”¨é…ç½®å¯¹è±¡
- ä¼˜åŒ–æ‹¦æˆªå™¨é“¾æ‰§è¡Œ
- å‡å°‘ Promise åµŒå¥—

**é¢„æœŸæ”¶ç›Šï¼š**
- è¯·æ±‚å¤„ç†é€Ÿåº¦æå‡ 25%
- å†…å­˜åˆ†é…å‡å°‘ 35%

## ğŸ“ˆ ä¼˜åŒ–å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šæ ¸å¿ƒä¼˜åŒ–ï¼ˆç¬¬ 1 å‘¨ï¼‰
- [x] æ‹¦æˆªå™¨ç®¡ç†å™¨ä¼˜åŒ–
- [x] ç¼“å­˜é”®ç”Ÿæˆä¼˜åŒ–
- [x] é…ç½®åˆå¹¶ä¼˜åŒ–

### é˜¶æ®µ 2ï¼šç®¡ç†å™¨ä¼˜åŒ–ï¼ˆç¬¬ 2 å‘¨ï¼‰
- [x] å»é‡ç®¡ç†ä¼˜åŒ–
- [x] ç›‘æ§ç³»ç»Ÿä¼˜åŒ–
- [x] è¿æ¥æ± ä¼˜åŒ–

### é˜¶æ®µ 3ï¼šé«˜çº§ä¼˜åŒ–ï¼ˆç¬¬ 3 å‘¨ï¼‰
- [x] ä¼˜å…ˆçº§é˜Ÿåˆ—ä¼˜åŒ–
- [x] å®¢æˆ·ç«¯æ ¸å¿ƒä¼˜åŒ–
- [x] é€šç”¨æ€§èƒ½ä¼˜åŒ–

### é˜¶æ®µ 4ï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆç¬¬ 4 å‘¨ï¼‰
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹
- [ ] å‹åŠ›æµ‹è¯•
- [ ] å…¼å®¹æ€§æµ‹è¯•

## ğŸ§ª æ€§èƒ½æµ‹è¯•

### æµ‹è¯•åœºæ™¯

1. **é«˜å¹¶å‘åœºæ™¯**
   - 1000 ä¸ªå¹¶å‘è¯·æ±‚
   - æµ‹è¯•å»é‡å’Œå¹¶å‘æ§åˆ¶

2. **ç¼“å­˜å¯†é›†åœºæ™¯**
   - é‡å¤è¯·æ±‚æµ‹è¯•
   - ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•

3. **é•¿æ—¶é—´è¿è¡Œåœºæ™¯**
   - 24 å°æ—¶æŒç»­è¯·æ±‚
   - å†…å­˜æ³„æ¼æ£€æµ‹

4. **å¤§æ•°æ®ä¼ è¾“åœºæ™¯**
   - å¤§æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½
   - å†…å­˜å ç”¨æµ‹è¯•

### æ€§èƒ½æŒ‡æ ‡

- **å“åº”æ—¶é—´**: P50, P95, P99
- **ååé‡**: QPS
- **å†…å­˜å ç”¨**: å³°å€¼ã€å¹³å‡å€¼
- **CPU å ç”¨**: å¹³å‡å€¼ã€å³°å€¼
- **ç¼“å­˜å‘½ä¸­ç‡**: ç™¾åˆ†æ¯”

## ğŸ“ ä¼˜åŒ–ç»†èŠ‚

### å†…å­˜ä¼˜åŒ–æŠ€å·§

1. **å¯¹è±¡æ± åŒ–**
   ```typescript
   // å¤ç”¨é…ç½®å¯¹è±¡
   const configPool = new ObjectPool(() => ({}))
   ```

2. **å»¶è¿Ÿåˆå§‹åŒ–**
   ```typescript
   // åªåœ¨éœ€è¦æ—¶åˆ›å»º
   private _cache?: CacheManager
   get cache() {
     return this._cache ??= new CacheManager()
   }
   ```

3. **WeakMap ä½¿ç”¨**
   ```typescript
   // è‡ªåŠ¨åƒåœ¾å›æ”¶
   private cache = new WeakMap<object, CachedData>()
   ```

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

1. **æ‰¹é‡å¤„ç†**
   ```typescript
   // æ‰¹é‡å¤„ç†è¯·æ±‚ï¼Œå‡å°‘å¼€é”€
   processBatch(requests)
   ```

2. **ç¼“å­˜è®¡ç®—ç»“æœ**
   ```typescript
   // ç¼“å­˜æ˜‚è´µçš„è®¡ç®—
   private statsCache?: Stats
   getStats() {
     return this.statsCache ??= this.calculateStats()
   }
   ```

3. **é¿å…ä¸å¿…è¦çš„æ‹·è´**
   ```typescript
   // ä½¿ç”¨æµ…æ‹·è´
   const config = { ...baseConfig, ...userConfig }
   ```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ€§èƒ½ç›‘æ§

```typescript
// å¯ç”¨æ€§èƒ½ç›‘æ§
const client = createHttpClient({
  monitor: {
    enabled: true,
    slowRequestThreshold: 1000,
    onSlowRequest: (metrics) => {
      console.warn('æ…¢è¯·æ±‚:', metrics)
    }
  }
})

// è·å–æ€§èƒ½ç»Ÿè®¡
const stats = client.getPerformanceStats()
console.log('å¹³å‡å“åº”æ—¶é—´:', stats.averageDuration)
console.log('å†…å­˜å ç”¨:', process.memoryUsage())
```

### å†…å­˜åˆ†æ

```typescript
// å®šæœŸæ£€æŸ¥å†…å­˜
setInterval(() => {
  const usage = process.memoryUsage()
  console.log('å †å†…å­˜:', usage.heapUsed / 1024 / 1024, 'MB')
}, 60000)
```

## ğŸ“Š ä¼˜åŒ–æˆæœ

### é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å¹³å‡å“åº”æ—¶é—´ | 150ms | 105ms | 30% â†“ |
| P95 å“åº”æ—¶é—´ | 500ms | 350ms | 30% â†“ |
| å†…å­˜å ç”¨ | 120MB | 75MB | 37.5% â†“ |
| QPS | 1000 | 1300 | 30% â†‘ |
| ç¼“å­˜å‘½ä¸­ç‡ | 60% | 75% | 25% â†‘ |

### å®é™…æµ‹è¯•ç»“æœ

å¾…æµ‹è¯•å®Œæˆåæ›´æ–°...

## ğŸ“ æœ€ä½³å®è·µ

1. **åˆç†é…ç½®ç¼“å­˜**
   - æ ¹æ®ä¸šåŠ¡è®¾ç½®åˆé€‚çš„ TTL
   - ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

2. **æ§åˆ¶å¹¶å‘æ•°**
   - æ ¹æ®æœåŠ¡å™¨èƒ½åŠ›è®¾ç½® maxConcurrent
   - é¿å…è¿‡åº¦å¹¶å‘

3. **ä½¿ç”¨è¿æ¥æ± **
   - å¯ç”¨ keepAlive
   - åˆç†è®¾ç½®è¿æ¥æ•°

4. **ç›‘æ§æ€§èƒ½**
   - å®šæœŸæŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
   - åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜

5. **å†…å­˜ç®¡ç†**
   - å®šæœŸæ¸…ç†ç¼“å­˜
   - é¿å…å†…å­˜æ³„æ¼

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](./docs/guide/performance.md)
- [å†…å­˜ç®¡ç†æœ€ä½³å®è·µ](./docs/guide/memory.md)
- [ç›‘æ§å’Œè°ƒè¯•](./docs/guide/monitoring.md)

---

**æ›´æ–°æ—¶é—´**: 2025-01-09
**ç‰ˆæœ¬**: v0.2.0


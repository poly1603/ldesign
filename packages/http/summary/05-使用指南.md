# @ldesign/http 使用指南

## 快速开始

### 安装

```bash
# 使用 pnpm（推荐）
pnpm add @ldesign/http

# 使用 npm
npm install @ldesign/http

# 使用 yarn
yarn add @ldesign/http
```

### 基础使用

```typescript
import { createHttpClient } from '@ldesign/http'

// 创建客户端
const client = createHttpClient({
  baseURL: 'https://api.example.com',
  timeout: 10000
})

// 发起请求
const response = await client.get('/users')
console.log(response.data)
```

## 配置指南

### 基础配置

```typescript
const client = createHttpClient({
  // 基础 URL
  baseURL: 'https://api.example.com',
  
  // 请求超时时间（毫秒）
  timeout: 10000,
  
  // 默认请求头
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer your-token'
  },
  
  // 适配器选择
  adapter: 'fetch' // 'fetch' | 'axios' | 'alova'
})
```

### 高级配置

```typescript
const client = createHttpClient({
  baseURL: 'https://api.example.com',
  
  // 缓存配置
  cache: {
    enabled: true,
    ttl: 5 * 60 * 1000, // 5分钟
    storage: 'memory', // 'memory' | 'localStorage'
    strategy: 'lru', // 'lru' | 'lfu' | 'fifo' | 'ttl'
    maxSize: 50 * 1024 * 1024, // 50MB
    compression: true
  },
  
  // 重试配置
  retry: {
    enabled: true,
    maxAttempts: 3,
    delay: 1000,
    backoff: 'exponential', // 'fixed' | 'linear' | 'exponential'
    condition: (error) => error.isNetworkError || error.response?.status >= 500
  },
  
  // 并发控制
  concurrency: {
    maxConcurrent: 10,
    maxQueueSize: 100,
    deduplication: true
  }
})
```

## HTTP 方法使用

### GET 请求

```typescript
// 基础 GET 请求
const users = await client.get('/users')

// 带参数的 GET 请求
const users = await client.get('/users', {
  params: {
    page: 1,
    size: 10,
    status: 'active'
  }
})

// 类型安全的 GET 请求
interface User {
  id: number
  name: string
  email: string
}

const users = await client.get<User[]>('/users')
// users.data 的类型为 User[]
```

### POST 请求

```typescript
// 基础 POST 请求
const newUser = await client.post('/users', {
  name: 'John Doe',
  email: 'john@example.com'
})

// 类型安全的 POST 请求
interface CreateUserRequest {
  name: string
  email: string
}

interface User {
  id: number
  name: string
  email: string
}

const newUser = await client.post<User, CreateUserRequest>('/users', {
  name: 'John Doe',
  email: 'john@example.com'
})
```

### 其他 HTTP 方法

```typescript
// PUT 请求
await client.put('/users/1', { name: 'Jane Doe' })

// PATCH 请求
await client.patch('/users/1', { email: 'jane@example.com' })

// DELETE 请求
await client.delete('/users/1')

// HEAD 请求
await client.head('/users/1')

// OPTIONS 请求
await client.options('/users')
```

## 拦截器使用

### 内置拦截器

```typescript
import { 
  authInterceptor, 
  loggingInterceptor, 
  errorHandlingInterceptor 
} from '@ldesign/http'

// 认证拦截器
client.addRequestInterceptor(authInterceptor({
  tokenKey: 'accessToken',
  headerName: 'Authorization',
  tokenPrefix: 'Bearer'
}))

// 日志拦截器
client.addRequestInterceptor(loggingInterceptor({
  level: 'info',
  includeHeaders: true
}))

// 错误处理拦截器
client.addResponseInterceptor(errorHandlingInterceptor({
  showUserFriendlyMessage: true
}))
```

### 自定义拦截器

```typescript
// 请求拦截器
client.addRequestInterceptor((config) => {
  // 添加时间戳
  config.headers['X-Timestamp'] = Date.now().toString()
  
  // 添加请求 ID
  config.headers['X-Request-ID'] = crypto.randomUUID()
  
  return config
})

// 响应拦截器
client.addResponseInterceptor(
  (response) => {
    // 成功响应处理
    console.log(`请求 ${response.config.url} 成功`)
    return response
  },
  (error) => {
    // 错误响应处理
    if (error.response?.status === 401) {
      // 跳转到登录页
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)
```

## 缓存使用

### 基础缓存

```typescript
// 启用缓存
const client = createHttpClient({
  cache: {
    enabled: true,
    ttl: 5 * 60 * 1000 // 5分钟
  }
})

// 第一次请求（从网络获取）
const users1 = await client.get('/users')

// 第二次请求（从缓存返回）
const users2 = await client.get('/users')
```

### 高级缓存

```typescript
import { createAdvancedCacheManager } from '@ldesign/http'

const cacheManager = createAdvancedCacheManager({
  strategy: 'lru',
  maxSize: 50 * 1024 * 1024,
  compression: true,
  invalidation: {
    tags: true,
    dependencies: true
  }
})

const client = createHttpClient({
  cache: {
    enabled: true,
    manager: cacheManager
  }
})

// 带标签的缓存
await client.get('/users', {
  cache: {
    tags: ['users', 'user-list'],
    ttl: 10 * 60 * 1000
  }
})

// 按标签失效缓存
await cacheManager.invalidateByTag('users')
```

## 错误处理

### 基础错误处理

```typescript
import { isHttpError, isNetworkError, isTimeoutError } from '@ldesign/http'

try {
  const response = await client.get('/users')
  console.log(response.data)
} catch (error) {
  if (isHttpError(error)) {
    console.log('HTTP错误:', error.response?.status)
  } else if (isNetworkError(error)) {
    console.log('网络错误')
  } else if (isTimeoutError(error)) {
    console.log('请求超时')
  } else {
    console.log('未知错误:', error.message)
  }
}
```

### 错误恢复

```typescript
import { ErrorHandler, builtinRecoveryStrategies } from '@ldesign/http'

// 添加内置恢复策略
ErrorHandler.addRecoveryStrategy(builtinRecoveryStrategies.networkReconnect)
ErrorHandler.addRecoveryStrategy(builtinRecoveryStrategies.authRefresh)

try {
  const response = await client.get('/users')
} catch (error) {
  // 尝试错误恢复
  const recovered = await ErrorHandler.tryRecover(error)
  
  if (!recovered) {
    // 获取用户友好的错误消息
    const userMessage = ErrorHandler.getUserFriendlyMessage(error)
    alert(userMessage)
  }
}
```

## 文件操作

### 文件上传

```typescript
// 单文件上传
const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement
const file = fileInput.files[0]

const formData = new FormData()
formData.append('file', file)
formData.append('name', 'avatar')

const response = await client.upload('/upload', formData, {
  onUploadProgress: (progress) => {
    console.log(`上传进度: ${progress.percentage}%`)
  }
})

// 多文件上传
const files = Array.from(fileInput.files)
const formData = new FormData()

files.forEach((file, index) => {
  formData.append(`file${index}`, file)
})

await client.upload('/upload-multiple', formData)
```

### 文件下载

```typescript
// 下载文件
const response = await client.download('/files/document.pdf', {
  onDownloadProgress: (progress) => {
    console.log(`下载进度: ${progress.percentage}%`)
  }
})

console.log('文件名:', response.filename)
console.log('文件大小:', response.size)
console.log('文件类型:', response.type)

// 保存文件
const url = URL.createObjectURL(response.data)
const a = document.createElement('a')
a.href = url
a.download = response.filename
document.body.appendChild(a)
a.click()
document.body.removeChild(a)
URL.revokeObjectURL(url)
```

## Vue 3 集成

### 插件安装

```typescript
// main.ts
import { createApp } from 'vue'
import { createHttpPlugin } from '@ldesign/http'
import App from './App.vue'

const app = createApp(App)

app.use(createHttpPlugin({
  baseURL: 'https://api.example.com',
  cache: { enabled: true },
  retry: { enabled: true }
}))

app.mount('#app')
```

### 组件中使用

```vue
<template>
  <div>
    <button @click="fetchUsers">获取用户</button>
    <div v-if="loading">加载中...</div>
    <div v-else-if="error">错误: {{ error.message }}</div>
    <ul v-else>
      <li v-for="user in users" :key="user.id">
        {{ user.name }}
      </li>
    </ul>
  </div>
</template>

<script setup lang="ts">
import { ref, inject } from 'vue'

interface User {
  id: number
  name: string
  email: string
}

const $http = inject('http')
const users = ref<User[]>([])
const loading = ref(false)
const error = ref<Error | null>(null)

const fetchUsers = async () => {
  loading.value = true
  error.value = null
  
  try {
    const response = await $http.get<User[]>('/users')
    users.value = response.data
  } catch (err) {
    error.value = err as Error
  } finally {
    loading.value = false
  }
}
</script>
```

## 性能优化

### 请求去重

```typescript
// 启用请求去重
const client = createHttpClient({
  concurrency: {
    deduplication: true
  }
})

// 同时发起多个相同请求，只会执行一次
const promises = [
  client.get('/users'),
  client.get('/users'), // 自动去重
  client.get('/users')  // 自动去重
]

const results = await Promise.all(promises)
// 所有结果相同，但只发起了一次网络请求
```

### 并发控制

```typescript
// 控制并发数量
const client = createHttpClient({
  concurrency: {
    maxConcurrent: 5,
    maxQueueSize: 100
  }
})

// 发起大量请求，自动排队处理
const promises = Array.from({ length: 50 }, (_, i) => 
  client.get(`/data/${i}`)
)

const results = await Promise.all(promises)
```

### 缓存优化

```typescript
// 预加载关键数据
const client = createHttpClient({
  cache: {
    enabled: true,
    preload: {
      enabled: true,
      urls: ['/api/config', '/api/user-info']
    }
  }
})

// 使用缓存标签管理
await client.get('/users', {
  cache: { tags: ['users'] }
})

await client.get('/user/1', {
  cache: { tags: ['users', 'user:1'] }
})

// 批量失效相关缓存
await cacheManager.invalidateByTag('users')
```

## 调试和监控

### 性能监控

```typescript
// 获取客户端统计
const stats = client.getStats()
console.log('请求总数:', stats.totalRequests)
console.log('成功率:', stats.successRate)
console.log('平均响应时间:', stats.averageResponseTime)

// 获取缓存统计
const cacheStats = cacheManager.getStats()
console.log('缓存命中率:', cacheStats.hitRate)
console.log('缓存大小:', cacheStats.size)

// 获取错误统计
const errorStats = ErrorHandler.getStats()
console.log('错误总数:', errorStats.total)
console.log('错误率:', errorStats.errorRate)
```

### 调试模式

```typescript
// 启用详细日志
const client = createHttpClient({
  debug: true
})

// 或使用日志拦截器
client.addRequestInterceptor(loggingInterceptor({
  level: 'debug',
  includeHeaders: true,
  includeBody: true
}))
```

这个使用指南涵盖了 @ldesign/http 的主要功能和使用场景，帮助开发者快速上手并充分利用库的各种特性。

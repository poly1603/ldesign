# LDesign 组件库 - 扩展性设计

## 扩展性架构

### 1. 插件系统设计

#### 插件接口定义
```typescript
// types/plugin.ts
export interface LDesignPlugin {
  name: string;
  version: string;
  install: (app: LDesignApp) => void;
  uninstall?: (app: LDesignApp) => void;
}

export interface LDesignApp {
  use: (plugin: LDesignPlugin) => void;
  config: {
    theme: ThemeConfig;
    locale: LocaleConfig;
    [key: string]: any;
  };
  provide: (key: string, value: any) => void;
  inject: (key: string) => any;
}
```

#### 插件管理器
```typescript
// core/plugin-manager.ts
export class PluginManager {
  private plugins: Map<string, LDesignPlugin> = new Map();
  private app: LDesignApp;
  
  constructor(app: LDesignApp) {
    this.app = app;
  }
  
  // 注册插件
  register(plugin: LDesignPlugin): void {
    if (this.plugins.has(plugin.name)) {
      console.warn(`Plugin ${plugin.name} is already registered`);
      return;
    }
    
    try {
      plugin.install(this.app);
      this.plugins.set(plugin.name, plugin);
      console.log(`Plugin ${plugin.name} registered successfully`);
    } catch (error) {
      console.error(`Failed to register plugin ${plugin.name}:`, error);
    }
  }
  
  // 卸载插件
  unregister(pluginName: string): void {
    const plugin = this.plugins.get(pluginName);
    if (!plugin) {
      console.warn(`Plugin ${pluginName} is not registered`);
      return;
    }
    
    try {
      if (plugin.uninstall) {
        plugin.uninstall(this.app);
      }
      this.plugins.delete(pluginName);
      console.log(`Plugin ${pluginName} unregistered successfully`);
    } catch (error) {
      console.error(`Failed to unregister plugin ${pluginName}:`, error);
    }
  }
  
  // 获取已注册的插件
  getPlugins(): LDesignPlugin[] {
    return Array.from(this.plugins.values());
  }
  
  // 检查插件是否已注册
  hasPlugin(pluginName: string): boolean {
    return this.plugins.has(pluginName);
  }
}
```

### 2. 主题扩展系统

#### 主题插件接口
```typescript
// types/theme.ts
export interface ThemePlugin extends LDesignPlugin {
  theme: {
    name: string;
    colors: ColorPalette;
    typography: Typography;
    spacing: Spacing;
    shadows: Shadows;
    borderRadius: BorderRadius;
  };
}

export interface ColorPalette {
  primary: ColorScale;
  success: ColorScale;
  warning: ColorScale;
  error: ColorScale;
  neutral: ColorScale;
}

export interface ColorScale {
  50: string;
  100: string;
  200: string;
  300: string;
  400: string;
  500: string;
  600: string;
  700: string;
  800: string;
  900: string;
}
```

#### 主题管理器
```typescript
// core/theme-manager.ts
export class ThemeManager {
  private themes: Map<string, ThemePlugin> = new Map();
  private currentTheme: string = 'default';
  private customVariables: Map<string, string> = new Map();
  
  // 注册主题
  registerTheme(theme: ThemePlugin): void {
    this.themes.set(theme.theme.name, theme);
    this.generateCSSVariables(theme);
  }
  
  // 切换主题
  switchTheme(themeName: string): void {
    const theme = this.themes.get(themeName);
    if (!theme) {
      console.warn(`Theme ${themeName} not found`);
      return;
    }
    
    this.currentTheme = themeName;
    this.applyCSSVariables(theme);
    this.notifyThemeChange(themeName);
  }
  
  // 自定义变量
  setCustomVariable(key: string, value: string): void {
    this.customVariables.set(key, value);
    document.documentElement.style.setProperty(`--ld-${key}`, value);
  }
  
  // 生成 CSS 变量
  private generateCSSVariables(theme: ThemePlugin): void {
    const variables: Record<string, string> = {};
    
    // 颜色变量
    Object.entries(theme.theme.colors).forEach(([colorName, colorScale]) => {
      Object.entries(colorScale).forEach(([scale, value]) => {
        variables[`color-${colorName}-${scale}`] = value;
      });
    });
    
    // 字体变量
    Object.entries(theme.theme.typography).forEach(([key, value]) => {
      variables[`typography-${key}`] = value;
    });
    
    // 间距变量
    Object.entries(theme.theme.spacing).forEach(([key, value]) => {
      variables[`spacing-${key}`] = value;
    });
    
    theme.cssVariables = variables;
  }
  
  // 应用 CSS 变量
  private applyCSSVariables(theme: ThemePlugin): void {
    const root = document.documentElement;
    
    Object.entries(theme.cssVariables || {}).forEach(([key, value]) => {
      root.style.setProperty(`--ld-${key}`, value);
    });
  }
  
  // 通知主题变化
  private notifyThemeChange(themeName: string): void {
    window.dispatchEvent(new CustomEvent('ld-theme-change', {
      detail: { theme: themeName }
    }));
  }
}
```

### 3. 国际化扩展

#### 语言包接口
```typescript
// types/locale.ts
export interface LocalePlugin extends LDesignPlugin {
  locale: {
    name: string;
    code: string;
    messages: LocaleMessages;
    dateFormat: DateFormatConfig;
    numberFormat: NumberFormatConfig;
  };
}

export interface LocaleMessages {
  common: {
    ok: string;
    cancel: string;
    confirm: string;
    loading: string;
    error: string;
    success: string;
    warning: string;
  };
  components: {
    button: ButtonMessages;
    input: InputMessages;
    table: TableMessages;
    form: FormMessages;
    modal: ModalMessages;
    [key: string]: any;
  };
}
```

#### 国际化管理器
```typescript
// core/i18n-manager.ts
export class I18nManager {
  private locales: Map<string, LocalePlugin> = new Map();
  private currentLocale: string = 'zh-CN';
  private fallbackLocale: string = 'en-US';
  
  // 注册语言包
  registerLocale(locale: LocalePlugin): void {
    this.locales.set(locale.locale.code, locale);
  }
  
  // 切换语言
  switchLocale(localeCode: string): void {
    if (!this.locales.has(localeCode)) {
      console.warn(`Locale ${localeCode} not found`);
      return;
    }
    
    this.currentLocale = localeCode;
    this.notifyLocaleChange(localeCode);
  }
  
  // 获取翻译文本
  t(key: string, params?: Record<string, any>): string {
    const locale = this.locales.get(this.currentLocale);
    let message = this.getNestedValue(locale?.locale.messages, key);
    
    // 回退到默认语言
    if (!message && this.currentLocale !== this.fallbackLocale) {
      const fallbackLocale = this.locales.get(this.fallbackLocale);
      message = this.getNestedValue(fallbackLocale?.locale.messages, key);
    }
    
    // 参数替换
    if (message && params) {
      Object.entries(params).forEach(([param, value]) => {
        message = message.replace(new RegExp(`\\{${param}\\}`, 'g'), String(value));
      });
    }
    
    return message || key;
  }
  
  // 获取嵌套对象值
  private getNestedValue(obj: any, path: string): string {
    return path.split('.').reduce((current, key) => current?.[key], obj);
  }
  
  // 通知语言变化
  private notifyLocaleChange(localeCode: string): void {
    window.dispatchEvent(new CustomEvent('ld-locale-change', {
      detail: { locale: localeCode }
    }));
  }
}
```

### 4. 组件扩展机制

#### 组件扩展接口
```typescript
// types/component-extension.ts
export interface ComponentExtension {
  name: string;
  targetComponent: string;
  extend: (component: any) => void;
}

export interface ExtensionPoint {
  name: string;
  description: string;
  params: ExtensionParam[];
}

export interface ExtensionParam {
  name: string;
  type: string;
  required: boolean;
  description: string;
}
```

#### 组件扩展管理器
```typescript
// core/extension-manager.ts
export class ExtensionManager {
  private extensions: Map<string, ComponentExtension[]> = new Map();
  private extensionPoints: Map<string, ExtensionPoint> = new Map();
  
  // 注册扩展点
  registerExtensionPoint(point: ExtensionPoint): void {
    this.extensionPoints.set(point.name, point);
  }
  
  // 注册组件扩展
  registerExtension(extension: ComponentExtension): void {
    const extensions = this.extensions.get(extension.targetComponent) || [];
    extensions.push(extension);
    this.extensions.set(extension.targetComponent, extensions);
  }
  
  // 应用扩展
  applyExtensions(componentName: string, component: any): void {
    const extensions = this.extensions.get(componentName);
    if (!extensions) return;
    
    extensions.forEach(extension => {
      try {
        extension.extend(component);
      } catch (error) {
        console.error(`Failed to apply extension ${extension.name}:`, error);
      }
    });
  }
  
  // 获取扩展点
  getExtensionPoints(): ExtensionPoint[] {
    return Array.from(this.extensionPoints.values());
  }
}
```

### 5. 自定义组件开发

#### 组件基类
```typescript
// core/base-component.ts
import { Component, Element, Prop, State, Event, EventEmitter } from '@stencil/core';

export abstract class BaseComponent {
  @Element() el!: HTMLElement;
  
  // 通用属性
  @Prop() customClass?: string;
  @Prop() disabled: boolean = false;
  @Prop() size: 'small' | 'medium' | 'large' = 'medium';
  
  // 通用状态
  @State() isReady: boolean = false;
  
  // 通用事件
  @Event() ldReady!: EventEmitter<void>;
  @Event() ldError!: EventEmitter<Error>;
  
  // 生命周期钩子
  componentWillLoad() {
    this.onBeforeMount();
  }
  
  componentDidLoad() {
    this.isReady = true;
    this.ldReady.emit();
    this.onMounted();
  }
  
  disconnectedCallback() {
    this.onUnmounted();
  }
  
  // 抽象方法
  protected abstract onBeforeMount(): void;
  protected abstract onMounted(): void;
  protected abstract onUnmounted(): void;
  
  // 工具方法
  protected addClass(className: string): void {
    this.el.classList.add(className);
  }
  
  protected removeClass(className: string): void {
    this.el.classList.remove(className);
  }
  
  protected hasClass(className: string): boolean {
    return this.el.classList.contains(className);
  }
  
  protected emit(eventName: string, detail?: any): void {
    this.el.dispatchEvent(new CustomEvent(eventName, {
      detail,
      bubbles: true,
      cancelable: true
    }));
  }
}
```

#### 自定义组件示例
```typescript
// components/custom-component/custom-component.tsx
import { Component, Prop, h } from '@stencil/core';
import { BaseComponent } from '../../core/base-component';

@Component({
  tag: 'ld-custom-component',
  styleUrl: 'custom-component.less',
  shadow: true,
})
export class CustomComponent extends BaseComponent {
  @Prop() value: string = '';
  @Prop() placeholder: string = '';
  
  protected onBeforeMount(): void {
    // 组件挂载前的逻辑
  }
  
  protected onMounted(): void {
    // 组件挂载后的逻辑
  }
  
  protected onUnmounted(): void {
    // 组件卸载时的清理逻辑
  }
  
  private handleChange = (event: Event) => {
    const target = event.target as HTMLInputElement;
    this.emit('ldChange', target.value);
  };
  
  render() {
    const componentClass = {
      'ld-custom-component': true,
      [`ld-custom-component--${this.size}`]: true,
      'ld-custom-component--disabled': this.disabled,
      [this.customClass]: !!this.customClass,
    };
    
    return (
      <div class={componentClass}>
        <input
          type="text"
          value={this.value}
          placeholder={this.placeholder}
          disabled={this.disabled}
          onInput={this.handleChange}
        />
      </div>
    );
  }
}
```

### 6. 第三方集成

#### 第三方库集成接口
```typescript
// types/integration.ts
export interface ThirdPartyIntegration {
  name: string;
  version: string;
  dependencies: string[];
  setup: (config?: any) => Promise<void>;
  teardown: () => Promise<void>;
}

export interface IntegrationConfig {
  [key: string]: any;
}
```

#### 集成管理器
```typescript
// core/integration-manager.ts
export class IntegrationManager {
  private integrations: Map<string, ThirdPartyIntegration> = new Map();
  private configs: Map<string, IntegrationConfig> = new Map();
  
  // 注册集成
  async registerIntegration(
    integration: ThirdPartyIntegration, 
    config?: IntegrationConfig
  ): Promise<void> {
    try {
      await integration.setup(config);
      this.integrations.set(integration.name, integration);
      if (config) {
        this.configs.set(integration.name, config);
      }
      console.log(`Integration ${integration.name} registered successfully`);
    } catch (error) {
      console.error(`Failed to register integration ${integration.name}:`, error);
      throw error;
    }
  }
  
  // 卸载集成
  async unregisterIntegration(name: string): Promise<void> {
    const integration = this.integrations.get(name);
    if (!integration) {
      console.warn(`Integration ${name} not found`);
      return;
    }
    
    try {
      await integration.teardown();
      this.integrations.delete(name);
      this.configs.delete(name);
      console.log(`Integration ${name} unregistered successfully`);
    } catch (error) {
      console.error(`Failed to unregister integration ${name}:`, error);
      throw error;
    }
  }
  
  // 获取集成配置
  getConfig(name: string): IntegrationConfig | undefined {
    return this.configs.get(name);
  }
  
  // 更新集成配置
  updateConfig(name: string, config: IntegrationConfig): void {
    this.configs.set(name, config);
  }
}
```

### 7. 扩展示例

#### 主题扩展示例
```typescript
// plugins/material-theme.ts
import { ThemePlugin } from '../types/theme';

export const MaterialTheme: ThemePlugin = {
  name: 'material-theme',
  version: '1.0.0',
  install: (app) => {
    app.config.theme = this.theme;
  },
  theme: {
    name: 'material',
    colors: {
      primary: {
        50: '#e3f2fd',
        100: '#bbdefb',
        200: '#90caf9',
        300: '#64b5f6',
        400: '#42a5f5',
        500: '#2196f3',
        600: '#1e88e5',
        700: '#1976d2',
        800: '#1565c0',
        900: '#0d47a1',
      },
      // ... 其他颜色
    },
    typography: {
      fontFamily: 'Roboto, sans-serif',
      fontSize: '14px',
      lineHeight: '1.5',
    },
    spacing: {
      xs: '4px',
      sm: '8px',
      md: '16px',
      lg: '24px',
      xl: '32px',
    },
    shadows: {
      sm: '0 1px 3px rgba(0,0,0,0.12)',
      md: '0 4px 6px rgba(0,0,0,0.1)',
      lg: '0 10px 25px rgba(0,0,0,0.1)',
    },
    borderRadius: {
      sm: '4px',
      md: '8px',
      lg: '12px',
    },
  },
};
```

#### 功能扩展示例
```typescript
// plugins/validation-plugin.ts
import { LDesignPlugin } from '../types/plugin';

export const ValidationPlugin: LDesignPlugin = {
  name: 'validation-plugin',
  version: '1.0.0',
  install: (app) => {
    // 注册全局验证器
    app.provide('validators', {
      required: (value: any) => !!value || '此字段为必填项',
      email: (value: string) => 
        /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) || '请输入有效的邮箱地址',
      minLength: (min: number) => (value: string) => 
        value.length >= min || `最少需要 ${min} 个字符`,
      maxLength: (max: number) => (value: string) => 
        value.length <= max || `最多允许 ${max} 个字符`,
    });
    
    // 扩展表单组件
    app.provide('formValidation', {
      validateField: (value: any, rules: any[]) => {
        for (const rule of rules) {
          const result = rule(value);
          if (result !== true) {
            return result;
          }
        }
        return true;
      },
    });
  },
};
```

### 8. 扩展开发指南

#### 插件开发最佳实践
1. **命名规范**: 使用 kebab-case 命名插件
2. **版本管理**: 遵循语义化版本控制
3. **依赖管理**: 明确声明插件依赖
4. **错误处理**: 提供完善的错误处理机制
5. **文档完善**: 提供详细的使用文档和示例
6. **测试覆盖**: 确保插件有完整的测试覆盖
7. **向后兼容**: 保持 API 的向后兼容性
8. **性能考虑**: 避免插件影响核心性能

#### 扩展发布流程
1. **开发阶段**: 本地开发和测试
2. **测试阶段**: 单元测试和集成测试
3. **文档阶段**: 编写使用文档和示例
4. **发布阶段**: 发布到 npm 或其他包管理器
5. **维护阶段**: 持续维护和更新

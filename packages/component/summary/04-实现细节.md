# LDesign 组件库 - 实现细节

## 核心技术实现

### 1. Stencil 组件开发

#### 组件基础结构
```typescript
import { Component, Prop, State, Element, Event, EventEmitter, Watch, Method, h, Host } from '@stencil/core';

@Component({
  tag: 'ld-component',
  styleUrl: 'component.less',
  shadow: true,
})
export class Component {
  @Element() el!: HTMLElement;
  
  // 属性定义
  @Prop() value: string = '';
  @Prop({ mutable: true, reflect: true }) visible: boolean = false;
  
  // 内部状态
  @State() internalState: any = {};
  
  // 事件定义
  @Event() ldChange!: EventEmitter<string>;
  
  // 属性监听
  @Watch('value')
  onValueChange(newValue: string, oldValue: string) {
    // 处理属性变化
  }
  
  // 公共方法
  @Method()
  async focus(): Promise<void> {
    // 实现焦点方法
  }
  
  // 生命周期
  componentDidLoad() {
    // 组件加载完成
  }
  
  disconnectedCallback() {
    // 组件卸载清理
  }
  
  // 渲染方法
  render() {
    return (
      <Host>
        <div class="ld-component">
          <slot />
        </div>
      </Host>
    );
  }
}
```

#### 关键实现要点
- **Shadow DOM**: 使用 Shadow DOM 实现样式隔离
- **属性反射**: 重要属性使用 `reflect: true` 反射到 DOM
- **可变属性**: 内部可修改的属性使用 `mutable: true`
- **事件命名**: 统一使用 `ld` 前缀的事件命名
- **生命周期管理**: 合理使用生命周期方法管理资源

### 2. 样式系统实现

#### CSS 变量系统
```less
// 全局变量定义
:root {
  // 颜色系统
  --ld-color-primary: #1976d2;
  --ld-color-primary-hover: #1565c0;
  --ld-color-primary-active: #0d47a1;
  --ld-color-primary-lighter: rgba(25, 118, 210, 0.1);
  
  // 字体系统
  --ld-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --ld-font-size-xs: 12px;
  --ld-font-size-sm: 13px;
  --ld-font-size-base: 14px;
  --ld-font-size-lg: 16px;
  --ld-font-size-xl: 18px;
  
  // 间距系统
  --ld-spacing-xs: 4px;
  --ld-spacing-sm: 8px;
  --ld-spacing-base: 16px;
  --ld-spacing-lg: 24px;
  --ld-spacing-xl: 32px;
  
  // 圆角系统
  --ld-border-radius-sm: 4px;
  --ld-border-radius-base: 6px;
  --ld-border-radius-lg: 8px;
  
  // 阴影系统
  --ld-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --ld-shadow-base: 0 2px 8px rgba(0, 0, 0, 0.15);
  --ld-shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
}
```

#### 组件样式结构
```less
:host {
  display: inline-block;
  
  // 主题适配
  &([data-theme="dark"]) {
    --ld-component-bg: #1f1f1f;
    --ld-component-color: rgba(255, 255, 255, 0.85);
  }
}

.ld-component {
  // 基础样式
  font-family: var(--ld-font-family);
  font-size: var(--ld-font-size-base);
  color: var(--ld-component-color, rgba(0, 0, 0, 0.85));
  
  // 元素样式
  &__element {
    padding: var(--ld-spacing-sm);
  }
  
  // 修饰符样式
  &--primary {
    background-color: var(--ld-color-primary);
    color: #fff;
  }
  
  // 状态样式
  &:hover {
    background-color: var(--ld-color-primary-hover);
  }
  
  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
}

// 响应式设计
@media (max-width: 768px) {
  .ld-component {
    font-size: var(--ld-font-size-sm);
  }
}

// 无障碍支持
@media (prefers-reduced-motion: reduce) {
  .ld-component {
    transition: none;
  }
}

@media (prefers-contrast: high) {
  .ld-component {
    border: 2px solid;
  }
}
```

### 3. 事件处理实现

#### 事件系统设计
```typescript
export class Component {
  // 事件定义
  @Event() ldClick!: EventEmitter<MouseEvent>;
  @Event() ldChange!: EventEmitter<{ value: any; oldValue: any }>;
  @Event() ldFocus!: EventEmitter<FocusEvent>;
  @Event() ldBlur!: EventEmitter<FocusEvent>;
  
  // 内部事件处理
  private handleClick = (event: MouseEvent) => {
    if (this.disabled) return;
    
    // 阻止事件冒泡（如果需要）
    event.stopPropagation();
    
    // 触发自定义事件
    this.ldClick.emit(event);
  };
  
  private handleChange = (newValue: any) => {
    const oldValue = this.value;
    this.value = newValue;
    
    // 触发变化事件
    this.ldChange.emit({ value: newValue, oldValue });
  };
  
  // 键盘事件处理
  private handleKeyDown = (event: KeyboardEvent) => {
    switch (event.key) {
      case 'Enter':
      case ' ':
        this.handleClick(event as any);
        break;
      case 'Escape':
        this.handleEscape();
        break;
    }
  };
}
```

#### 事件委托优化
```typescript
export class Component {
  private eventDelegator?: HTMLElement;
  
  componentDidLoad() {
    // 设置事件委托
    this.setupEventDelegation();
  }
  
  disconnectedCallback() {
    // 清理事件监听器
    this.cleanupEventListeners();
  }
  
  private setupEventDelegation() {
    this.eventDelegator = this.el.shadowRoot?.querySelector('.ld-component');
    if (this.eventDelegator) {
      this.eventDelegator.addEventListener('click', this.handleDelegatedClick);
    }
  }
  
  private handleDelegatedClick = (event: Event) => {
    const target = event.target as HTMLElement;
    
    // 根据目标元素处理不同的点击事件
    if (target.matches('.ld-component__button')) {
      this.handleButtonClick(event);
    } else if (target.matches('.ld-component__close')) {
      this.handleCloseClick(event);
    }
  };
  
  private cleanupEventListeners() {
    if (this.eventDelegator) {
      this.eventDelegator.removeEventListener('click', this.handleDelegatedClick);
    }
  }
}
```

### 4. 状态管理实现

#### 响应式状态
```typescript
export class Component {
  // 内部状态
  @State() internalState: ComponentState = {
    loading: false,
    error: null,
    data: null,
  };
  
  // 计算属性
  private get isReady(): boolean {
    return !this.internalState.loading && !this.internalState.error;
  }
  
  // 状态更新方法
  private updateState(updates: Partial<ComponentState>) {
    this.internalState = {
      ...this.internalState,
      ...updates,
    };
  }
  
  // 异步状态处理
  private async loadData() {
    this.updateState({ loading: true, error: null });
    
    try {
      const data = await this.fetchData();
      this.updateState({ loading: false, data });
    } catch (error) {
      this.updateState({ loading: false, error: error.message });
    }
  }
}
```

#### 属性验证
```typescript
export class Component {
  @Prop() size: 'small' | 'medium' | 'large' = 'medium';
  @Prop() type: 'default' | 'primary' | 'danger' = 'default';
  
  @Watch('size')
  validateSize(newSize: string) {
    const validSizes = ['small', 'medium', 'large'];
    if (!validSizes.includes(newSize)) {
      console.warn(`Invalid size: ${newSize}. Valid sizes are: ${validSizes.join(', ')}`);
      this.size = 'medium';
    }
  }
  
  @Watch('type')
  validateType(newType: string) {
    const validTypes = ['default', 'primary', 'danger'];
    if (!validTypes.includes(newType)) {
      console.warn(`Invalid type: ${newType}. Valid types are: ${validTypes.join(', ')}`);
      this.type = 'default';
    }
  }
}
```

### 5. 工具函数实现

#### ID 生成器
```typescript
// utils/id-generator.ts
let idCounter = 0;

export function generateId(prefix: string = 'ld'): string {
  return `${prefix}-${++idCounter}`;
}

export function generateUniqueId(prefix: string = 'ld'): string {
  return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
}
```

#### 类名工具
```typescript
// utils/class-names.ts
export function classNames(...classes: (string | object | undefined)[]): string {
  const result: string[] = [];
  
  classes.forEach(cls => {
    if (!cls) return;
    
    if (typeof cls === 'string') {
      result.push(cls);
    } else if (typeof cls === 'object') {
      Object.keys(cls).forEach(key => {
        if (cls[key]) {
          result.push(key);
        }
      });
    }
  });
  
  return result.join(' ');
}
```

#### 防抖和节流
```typescript
// utils/debounce-throttle.ts
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: number;
  
  return function executedFunction(...args: Parameters<T>) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    
    clearTimeout(timeout);
    timeout = window.setTimeout(later, wait);
  };
}

export function throttle<T extends (...args: any[]) => any>(
  func: T,
  limit: number
): (...args: Parameters<T>) => void {
  let inThrottle: boolean;
  
  return function executedFunction(...args: Parameters<T>) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}
```

### 6. 类型系统实现

#### 基础类型定义
```typescript
// types/common.ts
export type Size = 'small' | 'medium' | 'large';
export type Status = 'default' | 'success' | 'warning' | 'error';
export type Placement = 'top' | 'bottom' | 'left' | 'right';

export interface BaseComponentProps {
  customClass?: string;
  disabled?: boolean;
  size?: Size;
}

export interface EventDetail<T = any> {
  value: T;
  event?: Event;
}
```

#### 组件特定类型
```typescript
// types/button.ts
export interface ButtonProps extends BaseComponentProps {
  type?: 'default' | 'primary' | 'dashed' | 'text' | 'link';
  htmlType?: 'button' | 'submit' | 'reset';
  loading?: boolean;
  danger?: boolean;
  block?: boolean;
  icon?: string;
  href?: string;
  target?: string;
}

export interface ButtonEvents {
  ldClick: (event: MouseEvent) => void;
  ldFocus: (event: FocusEvent) => void;
  ldBlur: (event: FocusEvent) => void;
}
```

### 7. 测试实现

#### 单元测试
```typescript
// button.spec.ts
import { newSpecPage } from '@stencil/core/testing';
import { Button } from './button';

describe('ld-button', () => {
  it('renders with default props', async () => {
    const page = await newSpecPage({
      components: [Button],
      html: `<ld-button>Click me</ld-button>`,
    });
    
    expect(page.root).toEqualHtml(`
      <ld-button>
        <mock:shadow-root>
          <button class="ld-button ld-button--default ld-button--medium" type="button">
            <span class="ld-button__content">
              <slot></slot>
            </span>
          </button>
        </mock:shadow-root>
        Click me
      </ld-button>
    `);
  });
  
  it('emits click event', async () => {
    const page = await newSpecPage({
      components: [Button],
      html: `<ld-button>Click me</ld-button>`,
    });
    
    const button = page.root as HTMLLdButtonElement;
    const clickSpy = jest.fn();
    
    button.addEventListener('ldClick', clickSpy);
    
    const buttonElement = button.shadowRoot?.querySelector('button');
    buttonElement?.click();
    
    expect(clickSpy).toHaveBeenCalled();
  });
});
```

#### E2E 测试
```typescript
// button.e2e.ts
import { newE2EPage } from '@stencil/core/testing';

describe('ld-button e2e', () => {
  it('renders and responds to click', async () => {
    const page = await newE2EPage();
    await page.setContent('<ld-button>Click me</ld-button>');
    
    const button = await page.find('ld-button');
    expect(button).toHaveClass('hydrated');
    
    const clickEvent = await page.spyOnEvent('ldClick');
    await button.click();
    
    expect(clickEvent).toHaveReceivedEvent();
  });
  
  it('supports keyboard navigation', async () => {
    const page = await newE2EPage();
    await page.setContent('<ld-button>Click me</ld-button>');
    
    const button = await page.find('ld-button');
    await button.focus();
    
    const clickEvent = await page.spyOnEvent('ldClick');
    await page.keyboard.press('Enter');
    
    expect(clickEvent).toHaveReceivedEvent();
  });
});
```

### 8. 构建优化实现

#### Stencil 配置
```typescript
// stencil.config.ts
import { Config } from '@stencil/core';
import { less } from '@stencil/less';

export const config: Config = {
  namespace: 'ldesign',
  outputTargets: [
    {
      type: 'dist',
      esmLoaderPath: '../loader',
    },
    {
      type: 'dist-custom-elements',
    },
    {
      type: 'docs-readme',
    },
    {
      type: 'www',
      serviceWorker: null,
    },
  ],
  plugins: [
    less({
      injectGlobalPaths: [
        'src/global/variables.less',
        'src/global/mixins.less',
      ],
    }),
  ],
  testing: {
    browserHeadless: "new",
    collectCoverageFrom: [
      'src/**/*.{ts,tsx}',
      '!src/**/*.d.ts',
      '!src/**/*.spec.ts',
      '!src/**/*.e2e.ts',
    ],
    coverageThreshold: {
      global: {
        branches: 80,
        functions: 80,
        lines: 80,
        statements: 80,
      },
    },
  },
};
```

#### 性能监控
```typescript
// utils/performance.ts
export class PerformanceMonitor {
  private static instance: PerformanceMonitor;
  private metrics: Map<string, number> = new Map();
  
  static getInstance(): PerformanceMonitor {
    if (!PerformanceMonitor.instance) {
      PerformanceMonitor.instance = new PerformanceMonitor();
    }
    return PerformanceMonitor.instance;
  }
  
  startTiming(name: string): void {
    this.metrics.set(name, performance.now());
  }
  
  endTiming(name: string): number {
    const startTime = this.metrics.get(name);
    if (startTime) {
      const duration = performance.now() - startTime;
      console.log(`${name}: ${duration.toFixed(2)}ms`);
      this.metrics.delete(name);
      return duration;
    }
    return 0;
  }
  
  measureComponent(componentName: string, fn: () => void): void {
    this.startTiming(`${componentName}-render`);
    fn();
    this.endTiming(`${componentName}-render`);
  }
}
```

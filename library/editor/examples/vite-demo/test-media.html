<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>媒体插入测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 0 20px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    #editor {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      min-height: 400px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .test-buttons {
      margin: 20px 0;
      display: flex;
      gap: 10px;
    }
    
    .test-button {
      padding: 10px 20px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .test-button:hover {
      background: #4338ca;
    }
    
    .status {
      margin: 20px 0;
      padding: 15px;
      background: #f3f4f6;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .log-entry {
      margin: 2px 0;
      padding: 2px;
    }
    
    .log-error {
      color: red;
    }
    
    .log-success {
      color: green;
    }
    
    .log-info {
      color: blue;
    }
  </style>
</head>
<body>
  <h1>🎯 媒体插入功能测试</h1>
  
  <div class="test-buttons">
    <button class="test-button" onclick="testImageDirect()">直接插入图片</button>
    <button class="test-button" onclick="testVideoDirect()">直接插入视频</button>
    <button class="test-button" onclick="testAudioDirect()">直接插入音频</button>
    <button class="test-button" onclick="testImageCommand()">通过命令插入图片</button>
    <button class="test-button" onclick="testVideoCommand()">通过命令插入视频</button>
    <button class="test-button" onclick="testAudioCommand()">通过命令插入音频</button>
    <button class="test-button" onclick="clearLogs()">清空日志</button>
  </div>
  
  <div id="status" class="status">
    <div class="log-entry log-info">等待初始化...</div>
  </div>
  
  <!-- 编辑器容器 -->
  <div id="editor"></div>
  
  <script type="module">
    const statusEl = document.getElementById('status');
    
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      statusEl.appendChild(entry);
      statusEl.scrollTop = statusEl.scrollHeight;
      console.log(`[${type}] ${message}`);
    }
    
    window.clearLogs = () => {
      statusEl.innerHTML = '';
      log('日志已清空', 'info');
    };
    
    // 导入样式
    const styles = [
      '/src/styles/editor.css',
      '/src/styles/reset.css',
      '/src/styles/table.css'
    ];
    
    for (const href of styles) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = href;
      document.head.appendChild(link);
    }
    
    try {
      log('开始导入编辑器模块...', 'info');
      
      // 导入编辑器
      const { Editor } = await import('/src/core/Editor.ts');
      log('Editor 类导入成功', 'success');
      
      // 创建编辑器实例
      log('创建编辑器实例...', 'info');
      const editor = new Editor({
        element: '#editor'
      });
      
      log('编辑器创建成功', 'success');
      
      // 设置初始内容
      editor.setHTML(`
        <h2>媒体插入测试</h2>
        <p>点击上方按钮测试各种媒体插入功能。</p>
        <p>下面会显示插入的媒体内容：</p>
      `);
      
      // 暴露到全局
      window.editor = editor;
      
      // 检查命令是否注册
      log('检查已注册的命令...', 'info');
      if (editor.commands) {
        log(`Commands 对象存在: ${typeof editor.commands}`, 'info');
        
        // 检查特定命令
        const commandsToCheck = ['insertImage', 'insertVideo', 'insertAudio'];
        for (const cmd of commandsToCheck) {
          const hasCommand = editor.commands.get ? editor.commands.get(cmd) : false;
          log(`命令 '${cmd}': ${hasCommand ? '已注册' : '未注册'}`, hasCommand ? 'success' : 'error');
        }
      } else {
        log('Commands 对象不存在！', 'error');
      }
      
      // 测试函数：直接插入HTML
      window.testImageDirect = () => {
        log('直接插入图片 HTML...', 'info');
        const html = `<img src="https://via.placeholder.com/300x200" alt="测试图片" style="max-width: 100%; height: auto; display: block; margin: 10px auto;">`;
        
        try {
          if (editor.insertHTML) {
            editor.insertHTML(html);
            log('使用 editor.insertHTML() 成功', 'success');
          } else {
            // 回退到 execCommand
            editor.contentElement.focus();
            const success = document.execCommand('insertHTML', false, html);
            log(`使用 document.execCommand(): ${success}`, success ? 'success' : 'error');
          }
        } catch (e) {
          log(`插入失败: ${e.message}`, 'error');
        }
      };
      
      window.testVideoDirect = () => {
        log('直接插入视频 HTML...', 'info');
        const html = `<video controls style="max-width: 100%; height: auto; display: block; margin: 10px auto;">
          <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
          您的浏览器不支持视频标签。
        </video>`;
        
        try {
          if (editor.insertHTML) {
            editor.insertHTML(html);
            log('使用 editor.insertHTML() 成功', 'success');
          } else {
            editor.contentElement.focus();
            const success = document.execCommand('insertHTML', false, html);
            log(`使用 document.execCommand(): ${success}`, success ? 'success' : 'error');
          }
        } catch (e) {
          log(`插入失败: ${e.message}`, 'error');
        }
      };
      
      window.testAudioDirect = () => {
        log('直接插入音频 HTML...', 'info');
        const html = `<audio controls style="width: 100%; max-width: 400px; display: block; margin: 10px auto;">
          <source src="https://www.w3schools.com/html/horse.mp3" type="audio/mpeg">
          您的浏览器不支持音频标签。
        </audio>`;
        
        try {
          if (editor.insertHTML) {
            editor.insertHTML(html);
            log('使用 editor.insertHTML() 成功', 'success');
          } else {
            editor.contentElement.focus();
            const success = document.execCommand('insertHTML', false, html);
            log(`使用 document.execCommand(): ${success}`, success ? 'success' : 'error');
          }
        } catch (e) {
          log(`插入失败: ${e.message}`, 'error');
        }
      };
      
      // 测试函数：通过命令插入
      window.testImageCommand = () => {
        log('通过命令插入图片...', 'info');
        try {
          if (editor.commands && editor.commands.execute) {
            editor.commands.execute('insertImage');
            log('命令执行成功', 'success');
          } else {
            log('Commands.execute 不存在', 'error');
          }
        } catch (e) {
          log(`命令执行失败: ${e.message}`, 'error');
        }
      };
      
      window.testVideoCommand = () => {
        log('通过命令插入视频...', 'info');
        try {
          if (editor.commands && editor.commands.execute) {
            editor.commands.execute('insertVideo');
            log('命令执行成功', 'success');
          } else {
            log('Commands.execute 不存在', 'error');
          }
        } catch (e) {
          log(`命令执行失败: ${e.message}`, 'error');
        }
      };
      
      window.testAudioCommand = () => {
        log('通过命令插入音频...', 'info');
        try {
          if (editor.commands && editor.commands.execute) {
            editor.commands.execute('insertAudio');
            log('命令执行成功', 'success');
          } else {
            log('Commands.execute 不存在', 'error');
          }
        } catch (e) {
          log(`命令执行失败: ${e.message}`, 'error');
        }
      };
      
      log('所有测试函数已准备就绪', 'success');
      
    } catch (error) {
      log(`初始化失败: ${error.message}`, 'error');
      console.error(error);
    }
  </script>
</body>
</html>
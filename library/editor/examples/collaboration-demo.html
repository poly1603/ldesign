<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborative Editing Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: #2563eb;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
    }

    .status-indicator.connected {
      background: #10b981;
    }

    .status-indicator.connecting {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .main-content {
      display: flex;
      height: 600px;
    }

    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      padding: 12px 20px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .toolbar button {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toolbar button:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .toolbar button.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .editor {
      flex: 1;
      padding: 20px;
      border: none;
      outline: none;
      font-size: 16px;
      line-height: 1.6;
      resize: none;
      font-family: inherit;
    }

    .sidebar {
      width: 300px;
      background: #f8fafc;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
    }

    .sidebar-section {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
    }

    .sidebar-section h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #374151;
    }

    .client-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .client-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: white;
      border-radius: 4px;
      font-size: 14px;
    }

    .client-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stat-item {
      background: white;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #2563eb;
    }

    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .controls button {
      flex: 1;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .controls button:hover {
      background: #1d4ed8;
    }

    .controls button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .log {
      flex: 1;
      background: #1f2937;
      color: #f3f4f6;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Collaborative Editing Demo</h1>
      <div class="connection-status">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">Disconnected</span>
      </div>
    </div>

    <div class="main-content">
      <div class="editor-container">
        <div class="toolbar">
          <button onclick="formatText('bold')">Bold</button>
          <button onclick="formatText('italic')">Italic</button>
          <button onclick="formatText('underline')">Underline</button>
          <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 8px;"></div>
          <button onclick="insertText('Hello from ' + clientName + '!')">Insert Greeting</button>
          <button onclick="clearEditor()">Clear</button>
        </div>
        <textarea 
          class="editor" 
          id="editor" 
          placeholder="Start typing to collaborate in real-time..."
          oninput="handleInput()"
          onselect="handleSelection()"
        ></textarea>
      </div>

      <div class="sidebar">
        <div class="sidebar-section">
          <h3>Connected Users</h3>
          <div class="client-list" id="clientList">
            <div class="client-item">
              <div class="client-avatar" style="background: #6b7280;">?</div>
              <span>No users connected</span>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Statistics</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="clientCount">0</div>
              <div class="stat-label">Users</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="operationCount">0</div>
              <div class="stat-label">Operations</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="revision">0</div>
              <div class="stat-label">Revision</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="latency">-</div>
              <div class="stat-label">Latency</div>
            </div>
          </div>

          <div class="controls">
            <button onclick="connect()" id="connectBtn">Connect</button>
            <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
          </div>
        </div>

        <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column;">
          <h3>Activity Log</h3>
          <div class="log" id="activityLog">Waiting for connection...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Simple collaborative editing demo
    let ws = null;
    let clientId = 'client-' + Math.random().toString(36).substr(2, 9);
    let clientName = 'User ' + Math.floor(Math.random() * 1000);
    let clientColor = generateRandomColor();
    let isConnected = false;
    let operationCount = 0;
    let revision = 0;
    let lastPingTime = 0;

    const editor = document.getElementById('editor');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const clientList = document.getElementById('clientList');
    const activityLog = document.getElementById('activityLog');

    function connect() {
      if (ws) return;

      updateStatus('connecting', 'Connecting...');
      log('Connecting to collaboration server...');

      ws = new WebSocket('ws://localhost:8080');

      ws.onopen = () => {
        isConnected = true;
        updateStatus('connected', 'Connected');
        log('Connected to collaboration server');
        
        // Send client info
        sendMessage({
          type: 'client-update',
          client: {
            id: clientId,
            name: clientName,
            color: clientColor,
            lastSeen: Date.now(),
            isOnline: true
          }
        });

        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;
      };

      ws.onclose = () => {
        isConnected = false;
        updateStatus('disconnected', 'Disconnected');
        log('Disconnected from collaboration server');
        ws = null;

        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
      };

      ws.onerror = (error) => {
        log('WebSocket error: ' + error);
        updateStatus('error', 'Connection Error');
      };

      ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          handleMessage(message);
        } catch (error) {
          log('Failed to parse message: ' + error);
        }
      };
    }

    function disconnect() {
      if (ws) {
        ws.close();
      }
    }

    function sendMessage(message) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        lastPingTime = Date.now();
        ws.send(JSON.stringify(message));
      }
    }

    function handleMessage(message) {
      const latency = Date.now() - lastPingTime;
      document.getElementById('latency').textContent = latency + 'ms';

      switch (message.type) {
        case 'sync-state':
          revision = message.revision;
          operationCount = message.operations.length;
          updateStats();
          log('State synced - Revision: ' + revision);
          break;

        case 'operation':
          operationCount++;
          revision++;
          updateStats();
          log('Operation received from ' + message.operation.clientId);
          break;

        case 'client-join':
          log('User joined: ' + message.client.name);
          updateClientList();
          break;

        case 'client-leave':
          log('User left: ' + message.clientId);
          updateClientList();
          break;

        case 'client-update':
          updateClientList();
          break;

        case 'operation-ack':
          log('Operation acknowledged: ' + message.operationId);
          break;
      }
    }

    function handleInput() {
      if (!isConnected) return;

      const content = editor.value;
      const operation = {
        id: generateOperationId(),
        clientId: clientId,
        operation: { insert: content },
        timestamp: Date.now(),
        revision: revision
      };

      sendMessage({
        type: 'operation',
        operation: operation
      });
    }

    function handleSelection() {
      if (!isConnected) return;

      const start = editor.selectionStart;
      const end = editor.selectionEnd;

      sendMessage({
        type: 'client-update',
        client: {
          id: clientId,
          cursor: {
            index: start,
            length: end - start
          },
          lastSeen: Date.now()
        }
      });
    }

    function formatText(format) {
      log('Format applied: ' + format);
    }

    function insertText(text) {
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      const before = editor.value.substring(0, start);
      const after = editor.value.substring(end);
      
      editor.value = before + text + after;
      editor.selectionStart = editor.selectionEnd = start + text.length;
      
      handleInput();
    }

    function clearEditor() {
      editor.value = '';
      handleInput();
    }

    function updateStatus(status, text) {
      statusIndicator.className = 'status-indicator ' + status;
      statusText.textContent = text;
    }

    function updateStats() {
      document.getElementById('operationCount').textContent = operationCount;
      document.getElementById('revision').textContent = revision;
    }

    function updateClientList() {
      // Simplified - in real implementation, track actual clients
      const count = Math.floor(Math.random() * 5) + 1;
      document.getElementById('clientCount').textContent = count;
      
      clientList.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const item = document.createElement('div');
        item.className = 'client-item';
        item.innerHTML = `
          <div class="client-avatar" style="background: ${generateRandomColor()};">
            ${String.fromCharCode(65 + i)}
          </div>
          <span>User ${i + 1}</span>
        `;
        clientList.appendChild(item);
      }
    }

    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      activityLog.textContent += `[${timestamp}] ${message}\n`;
      activityLog.scrollTop = activityLog.scrollHeight;
    }

    function generateOperationId() {
      return clientId + '-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    function generateRandomColor() {
      const colors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Auto-connect on page load
    setTimeout(connect, 1000);
  </script>
</body>
</html>

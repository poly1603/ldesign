<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•æŸ¥æ‰¾æ›¿æ¢å¯¹è¯æ¡†</title>
  <style>
    body {
      padding: 20px;
      font-family: sans-serif;
    }
    #editor {
      border: 1px solid #ddd;
      min-height: 300px;
      padding: 20px;
      margin: 20px 0;
      background: #f9f9f9;
    }
    button {
      padding: 10px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <h1>æµ‹è¯•æŸ¥æ‰¾æ›¿æ¢å¯¹è¯æ¡†</h1>
  
  <div id="editor" contenteditable="true">
    <p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬ã€‚</p>
    <p>ç¼–è¾‘å™¨ä¸­æœ‰å¤šä¸ª"ç¼–è¾‘å™¨"è¿™ä¸ªè¯ã€‚</p>
    <p>ç¼–è¾‘å™¨åŠŸèƒ½å¼ºå¤§ï¼Œç¼–è¾‘å™¨ä½¿ç”¨æ–¹ä¾¿ã€‚</p>
    <p>ä½ å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­æŸ¥æ‰¾å’Œæ›¿æ¢æ–‡æœ¬ã€‚</p>
    <p>æµ‹è¯•æ–‡æœ¬123ï¼Œæµ‹è¯•æ•°å­—456ã€‚</p>
  </div>
  
  <button onclick="openFindDialog()">æ‰“å¼€æŸ¥æ‰¾æ›¿æ¢å¯¹è¯æ¡†</button>
  
  <script>
    // åˆ›å»ºå¢å¼ºç‰ˆæŸ¥æ‰¾æ›¿æ¢å¯¹è¯æ¡†
    function createFindReplaceDialog(options) {
      const { onFind, onReplace, onReplaceAll, onClose, initialText } = options;
      
      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
      `;
      
      // åˆ›å»ºå¯¹è¯æ¡†
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        min-width: 500px;
        max-width: 600px;
        animation: slideIn 0.3s ease-out;
      `;
      
      dialog.innerHTML = `
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2 style="margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
              ğŸ” æŸ¥æ‰¾å’Œæ›¿æ¢
            </h2>
            <button onclick="this.closest('[style*=\\"z-index: 10000\\"]').remove()" style="
              border: none;
              background: transparent;
              cursor: pointer;
              padding: 4px;
              font-size: 20px;
            ">âœ•</button>
          </div>
        </div>
        
        <div style="padding: 24px;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">æŸ¥æ‰¾</label>
            <input type="text" id="find-input" value="${initialText || ''}" placeholder="è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬" style="
              width: 100%;
              padding: 10px 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              box-sizing: border-box;
            ">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">æ›¿æ¢ä¸º</label>
            <input type="text" id="replace-input" placeholder="è¾“å…¥æ›¿æ¢æ–‡æœ¬" style="
              width: 100%;
              padding: 10px 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              box-sizing: border-box;
            ">
          </div>
          
          <div style="margin-bottom: 20px; display: flex; gap: 16px; padding: 16px; background: #f9fafb; border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="case-sensitive">
              <span>åŒºåˆ†å¤§å°å†™</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="whole-word">
              <span>å…¨å­—åŒ¹é…</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="use-regex">
              <span>æ­£åˆ™è¡¨è¾¾å¼</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="fuzzy-search">
              <span>æ¨¡ç³Šæœç´¢</span>
            </label>
          </div>
          
          <div id="result-message" style="
            display: none;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 14px;
          "></div>
        </div>
        
        <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
          <button onclick="handleFind()" style="
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
          ">æŸ¥æ‰¾å…¨éƒ¨</button>
          <button onclick="handleReplace()" style="
            padding: 10px 20px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
          ">æ›¿æ¢</button>
          <button onclick="handleReplaceAll()" style="
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
          ">å…¨éƒ¨æ›¿æ¢</button>
          <button onclick="this.closest('[style*=\\"z-index: 10000\\"]').remove()" style="
            padding: 10px 20px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
          ">å–æ¶ˆ</button>
        </div>
      `;
      
      // æ·»åŠ åŠ¨ç”»æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(-20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .highlight {
          background: #fef08a !important;
          padding: 2px;
          border-radius: 2px;
        }
        .highlight-active {
          background: #facc15 !important;
          font-weight: bold;
        }
      `;
      document.head.appendChild(style);
      
      overlay.appendChild(dialog);
      
      // ä¿å­˜å›è°ƒå‡½æ•°åˆ°å…¨å±€
      window.findReplaceCallbacks = { onFind, onReplace, onReplaceAll, onClose };
      
      return overlay;
    }
    
    // è·å–æœç´¢é€‰é¡¹
    function getSearchOptions() {
      return {
        caseSensitive: document.getElementById('case-sensitive')?.checked || false,
        wholeWord: document.getElementById('whole-word')?.checked || false,
        useRegex: document.getElementById('use-regex')?.checked || false,
        fuzzySearch: document.getElementById('fuzzy-search')?.checked || false
      };
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(msg, type = 'info') {
      const resultDiv = document.getElementById('result-message');
      if (resultDiv) {
        resultDiv.textContent = msg;
        resultDiv.style.display = 'block';
        resultDiv.style.background = type === 'success' ? '#f0fdf4' : 
                                     type === 'error' ? '#fee2e2' : '#eff6ff';
        resultDiv.style.color = type === 'success' ? '#16a34a' : 
                                type === 'error' ? '#dc2626' : '#2563eb';
        setTimeout(() => {
          resultDiv.style.display = 'none';
        }, 3000);
      }
    }
    
    // å¤„ç†æŸ¥æ‰¾
    window.handleFind = function() {
      const searchText = document.getElementById('find-input').value;
      const options = getSearchOptions();
      
      if (!searchText) {
        showMessage('è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬', 'error');
        return;
      }
      
      // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
      document.querySelectorAll('.highlight').forEach(el => {
        el.outerHTML = el.textContent;
      });
      
      const editor = document.getElementById('editor');
      const content = editor.innerHTML;
      let pattern;
      
      try {
        if (options.fuzzySearch) {
          // æ¨¡ç³Šæœç´¢
          const fuzzyPattern = searchText.split('').map(c => 
            c.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          ).join('.*?');
          pattern = new RegExp(fuzzyPattern, options.caseSensitive ? 'g' : 'gi');
        } else if (options.useRegex) {
          pattern = new RegExp(searchText, options.caseSensitive ? 'g' : 'gi');
        } else {
          const escaped = searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const wordBoundary = options.wholeWord ? '\\b' : '';
          pattern = new RegExp(
            `${wordBoundary}${escaped}${wordBoundary}`,
            options.caseSensitive ? 'g' : 'gi'
          );
        }
        
        const matches = content.match(pattern);
        const count = matches ? matches.length : 0;
        
        if (count > 0) {
          // é«˜äº®åŒ¹é…é¡¹
          editor.innerHTML = content.replace(pattern, '<span class="highlight">$&</span>');
          showMessage(`æ‰¾åˆ° ${count} ä¸ªåŒ¹é…é¡¹`, 'success');
        } else {
          showMessage('æœªæ‰¾åˆ°åŒ¹é…é¡¹', 'error');
        }
      } catch (e) {
        showMessage('æœç´¢æ¨¡å¼é”™è¯¯: ' + e.message, 'error');
      }
      
      if (window.findReplaceCallbacks?.onFind) {
        window.findReplaceCallbacks.onFind(searchText, options);
      }
    };
    
    // å¤„ç†æ›¿æ¢
    window.handleReplace = function() {
      const searchText = document.getElementById('find-input').value;
      const replaceText = document.getElementById('replace-input').value;
      const options = getSearchOptions();
      
      if (!searchText) {
        showMessage('è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬', 'error');
        return;
      }
      
      if (window.findReplaceCallbacks?.onReplace) {
        window.findReplaceCallbacks.onReplace(searchText, replaceText, options);
      }
      
      showMessage('æ›¿æ¢æˆåŠŸ', 'success');
    };
    
    // å¤„ç†å…¨éƒ¨æ›¿æ¢
    window.handleReplaceAll = function() {
      const searchText = document.getElementById('find-input').value;
      const replaceText = document.getElementById('replace-input').value;
      const options = getSearchOptions();
      
      if (!searchText) {
        showMessage('è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬', 'error');
        return;
      }
      
      if (confirm(`ç¡®å®šè¦å°†æ‰€æœ‰ "${searchText}" æ›¿æ¢ä¸º "${replaceText || '(ç©º)'}" å—ï¼Ÿ`)) {
        const editor = document.getElementById('editor');
        const content = editor.textContent;
        let pattern;
        
        try {
          if (options.useRegex) {
            pattern = new RegExp(searchText, options.caseSensitive ? 'g' : 'gi');
          } else {
            const escaped = searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const wordBoundary = options.wholeWord ? '\\b' : '';
            pattern = new RegExp(
              `${wordBoundary}${escaped}${wordBoundary}`,
              options.caseSensitive ? 'g' : 'gi'
            );
          }
          
          const matches = content.match(pattern);
          const count = matches ? matches.length : 0;
          
          if (count > 0) {
            editor.textContent = content.replace(pattern, replaceText);
            showMessage(`æˆåŠŸæ›¿æ¢ ${count} å¤„`, 'success');
          } else {
            showMessage('æœªæ‰¾åˆ°åŒ¹é…é¡¹', 'error');
          }
        } catch (e) {
          showMessage('æ›¿æ¢å¤±è´¥: ' + e.message, 'error');
        }
        
        if (window.findReplaceCallbacks?.onReplaceAll) {
          window.findReplaceCallbacks.onReplaceAll(searchText, replaceText, options);
        }
      }
    };
    
    // æ‰“å¼€æŸ¥æ‰¾å¯¹è¯æ¡†
    function openFindDialog() {
      // è·å–é€‰ä¸­çš„æ–‡æœ¬
      const selection = window.getSelection();
      const initialText = selection.toString();
      
      const dialog = createFindReplaceDialog({
        initialText,
        onFind: (text, options) => {
          console.log('æŸ¥æ‰¾:', text, options);
        },
        onReplace: (find, replace, options) => {
          console.log('æ›¿æ¢:', find, '->', replace, options);
        },
        onReplaceAll: (find, replace, options) => {
          console.log('å…¨éƒ¨æ›¿æ¢:', find, '->', replace, options);
        },
        onClose: () => {
          console.log('å¯¹è¯æ¡†å…³é—­');
        }
      });
      
      document.body.appendChild(dialog);
      
      // èšç„¦åˆ°æŸ¥æ‰¾è¾“å…¥æ¡†
      setTimeout(() => {
        document.getElementById('find-input')?.focus();
      }, 100);
    }
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        openFindDialog();
      }
    });
  </script>
</body>
</html>
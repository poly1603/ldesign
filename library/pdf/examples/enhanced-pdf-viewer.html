<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强型PDF查看器 - 完整注释功能演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }

        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* 头部控制面板 */
        .control-panel {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
        }

        .file-input-label:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }

        select, input[type="number"], input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus, input[type="number"]:focus, input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        input[type="number"] {
            width: 80px;
        }

        button {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .theme-selector button {
            background: #6c757d;
            padding: 6px 12px;
            font-size: 13px;
        }

        .theme-selector button.active {
            background: #007bff;
        }

        .theme-selector button:hover {
            background: #5a6268;
        }

        .theme-selector button.active:hover {
            background: #0056b3;
        }

        /* 查看器容器 */
        #viewer-container {
            flex: 1;
            position: relative;
            background: white;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        /* 状态显示 */
        .status-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .status-bar.show {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, 10px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* 功能提示 */
        .feature-tips {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .feature-tips h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .feature-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feature-tips li {
            padding: 5px 0;
            color: #666;
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .feature-tips li::before {
            content: '✓';
            color: #28a745;
            margin-right: 8px;
            font-weight: bold;
        }

        .close-tips {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-tips:hover {
            color: #333;
            background: #f0f0f0;
            border-radius: 4px;
        }

        /* 加载动画 */
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .loading-spinner.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .controls-container {
                flex-wrap: wrap;
            }

            .control-group {
                flex: 1 1 auto;
                min-width: 200px;
            }

            .feature-tips {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="controls-container">
                <div class="control-group">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".pdf">
                        <label for="fileInput" class="file-input-label">选择PDF文件</label>
                    </div>
                    <span id="fileName" style="color: #666; font-size: 14px;"></span>
                </div>

                <div class="control-group">
                    <label>页码:</label>
                    <input type="number" id="pageInput" min="1" value="1">
                    <span id="pageInfo" style="color: #666; font-size: 14px;">/ 0</span>
                    <button id="gotoPage">跳转</button>
                </div>

                <div class="control-group">
                    <label>缩放:</label>
                    <select id="zoomSelect">
                        <option value="0.5">50%</option>
                        <option value="0.75">75%</option>
                        <option value="1" selected>100%</option>
                        <option value="1.25">125%</option>
                        <option value="1.5">150%</option>
                        <option value="2">200%</option>
                        <option value="page-width">适应宽度</option>
                        <option value="page-height">适应高度</option>
                    </select>
                </div>

                <div class="control-group theme-selector">
                    <label>主题:</label>
                    <button class="active" data-theme="light">明亮</button>
                    <button data-theme="modern">现代</button>
                    <button data-theme="dark">深色</button>
                </div>

                <div class="control-group">
                    <button id="testAnnotations" style="background: #ff6b6b;">测试注释功能</button>
                </div>
            </div>
        </div>

        <!-- 查看器容器 -->
        <div id="viewer-container">
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar" id="statusBar"></div>

        <!-- 功能提示 -->
        <div class="feature-tips" id="featureTips">
            <button class="close-tips" onclick="document.getElementById('featureTips').style.display='none'">×</button>
            <h3>🚀 增强功能</h3>
            <ul>
                <li>矩形、箭头、自由绘制注释</li>
                <li>文本注释和批注</li>
                <li>撤销/重做操作</li>
                <li>多种颜色和线宽选择</li>
                <li>橡皮擦和清除功能</li>
                <li>书签管理和页面跳转</li>
                <li>全文搜索和高亮</li>
                <li>侧边栏缩略图导航</li>
                <li>打印和导出功能</li>
                <li>三种主题切换</li>
            </ul>
        </div>
    </div>

    <!-- 引入PDF.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- 引入插件 -->
    <link rel="stylesheet" href="../dist/styles/light.css" id="theme-style">
    <script src="../dist/pdf-viewer.js"></script>

    <script>
        let viewer = null;
        let currentPDF = null;

        // 显示状态消息
        function showStatus(message, duration = 3000) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.classList.add('show');
            setTimeout(() => {
                statusBar.classList.remove('show');
            }, duration);
        }

        // 显示加载动画
        function showLoading(show = true) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.toggle('show', show);
        }

        // 初始化查看器
        async function initViewer(pdfUrl) {
            showLoading(true);
            
            try {
                const container = document.getElementById('viewer-container');
                
                // 清理旧的查看器
                if (viewer) {
                    viewer.destroy();
                    container.innerHTML = '<div class="loading-spinner" id="loadingSpinner"><div class="spinner"></div></div>';
                }

                // 创建新的查看器
                viewer = new PDFViewer.PDFViewer(container, {
                    theme: 'light',
                    enableToolbar: true,
                    enableSidebar: true,
                    enableSearch: true,
                    enableAnnotations: true,
                    enableBookmarks: true,
                    enablePrint: true,
                    sidebarWidth: 250,
                    defaultZoom: 'page-width'
                });

                // 加载PDF
                await viewer.loadPDF(pdfUrl);
                currentPDF = pdfUrl;

                // 更新页面信息
                updatePageInfo();
                
                showStatus('PDF加载成功！所有增强功能已启用。');
                showLoading(false);
                
                // 设置事件监听
                setupEventListeners();
                
            } catch (error) {
                console.error('加载PDF失败:', error);
                showStatus('加载PDF失败: ' + error.message);
                showLoading(false);
            }
        }

        // 更新页面信息
        function updatePageInfo() {
            if (viewer) {
                const pageInfo = document.getElementById('pageInfo');
                const pageInput = document.getElementById('pageInput');
                pageInfo.textContent = `/ ${viewer.getTotalPages()}`;
                pageInput.max = viewer.getTotalPages();
                pageInput.value = viewer.getCurrentPage();
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 文件选择
            document.getElementById('fileInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    const fileUrl = URL.createObjectURL(file);
                    document.getElementById('fileName').textContent = file.name;
                    await initViewer(fileUrl);
                } else {
                    showStatus('请选择有效的PDF文件');
                }
            });

            // 页面跳转
            document.getElementById('gotoPage').addEventListener('click', () => {
                const pageInput = document.getElementById('pageInput');
                const page = parseInt(pageInput.value);
                if (viewer && page > 0 && page <= viewer.getTotalPages()) {
                    viewer.goToPage(page);
                    updatePageInfo();
                    showStatus(`已跳转到第 ${page} 页`);
                }
            });

            // 缩放控制
            document.getElementById('zoomSelect').addEventListener('change', (e) => {
                if (viewer) {
                    const value = e.target.value;
                    if (value === 'page-width' || value === 'page-height') {
                        viewer.setZoom(value);
                    } else {
                        viewer.setZoom(parseFloat(value));
                    }
                    showStatus(`缩放设置为 ${value === 'page-width' ? '适应宽度' : value === 'page-height' ? '适应高度' : (value * 100) + '%'}`);
                }
            });

            // 主题切换
            document.querySelectorAll('.theme-selector button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const theme = e.target.dataset.theme;
                    
                    // 更新按钮状态
                    document.querySelectorAll('.theme-selector button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // 切换主题样式
                    const themeStyle = document.getElementById('theme-style');
                    themeStyle.href = `../dist/styles/${theme}.css`;
                    
                    // 更新查看器主题
                    if (viewer) {
                        viewer.setTheme(theme);
                    }
                    
                    showStatus(`已切换到${theme === 'light' ? '明亮' : theme === 'modern' ? '现代' : '深色'}主题`);
                });
            });

            // 测试注释功能
            document.getElementById('testAnnotations').addEventListener('click', () => {
                if (viewer) {
                    testAnnotationFeatures();
                } else {
                    showStatus('请先加载PDF文件');
                }
            });

            // 监听查看器事件
            if (viewer) {
                viewer.on('pagechange', () => {
                    updatePageInfo();
                });

                viewer.on('annotationAdded', (annotation) => {
                    showStatus(`已添加${annotation.type}注释`);
                });

                viewer.on('bookmarkAdded', (bookmark) => {
                    showStatus(`已添加书签：第${bookmark.page}页`);
                });

                viewer.on('searchComplete', (results) => {
                    showStatus(`找到 ${results.length} 个匹配项`);
                });
            }
        }

        // 测试注释功能
        function testAnnotationFeatures() {
            if (!viewer) return;

            showStatus('正在演示注释功能...');

            // 设置注释工具
            setTimeout(() => {
                viewer.setAnnotationTool('rectangle');
                viewer.setAnnotationColor('#FF0000');
                viewer.setAnnotationLineWidth(2);
                showStatus('已切换到矩形工具 - 红色');
            }, 1000);

            setTimeout(() => {
                viewer.setAnnotationTool('arrow');
                viewer.setAnnotationColor('#00FF00');
                showStatus('已切换到箭头工具 - 绿色');
            }, 3000);

            setTimeout(() => {
                viewer.setAnnotationTool('pen');
                viewer.setAnnotationColor('#0000FF');
                viewer.setAnnotationLineWidth(3);
                showStatus('已切换到自由绘制工具 - 蓝色');
            }, 5000);

            setTimeout(() => {
                viewer.setAnnotationTool('text');
                showStatus('已切换到文本注释工具');
            }, 7000);

            setTimeout(() => {
                viewer.addBookmark();
                showStatus('已添加当前页书签');
            }, 9000);

            setTimeout(() => {
                // 演示撤销
                viewer.undo();
                showStatus('执行撤销操作');
            }, 11000);

            setTimeout(() => {
                // 演示重做
                viewer.redo();
                showStatus('执行重做操作');
            }, 13000);

            setTimeout(() => {
                showStatus('注释功能演示完成！现在您可以手动尝试各种工具。');
            }, 15000);
        }

        // 加载示例PDF
        async function loadSamplePDF() {
            const sampleUrl = '../assets/sample.pdf';
            
            // 检查示例文件是否存在
            try {
                const response = await fetch(sampleUrl);
                if (response.ok) {
                    await initViewer(sampleUrl);
                    document.getElementById('fileName').textContent = 'sample.pdf';
                }
            } catch (error) {
                console.log('示例PDF不存在，等待用户选择文件');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 尝试加载示例PDF
            loadSamplePDF();
            
            // 3秒后自动隐藏功能提示
            setTimeout(() => {
                const tips = document.getElementById('featureTips');
                if (tips) {
                    tips.style.transition = 'opacity 0.5s';
                    tips.style.opacity = '0';
                    setTimeout(() => {
                        tips.style.display = 'none';
                    }, 500);
                }
            }, 10000);
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (!viewer) return;

            // Ctrl/Cmd + Z: 撤销
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                viewer.undo();
                showStatus('撤销');
            }
            
            // Ctrl/Cmd + Shift + Z 或 Ctrl/Cmd + Y: 重做
            if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') || 
                ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
                e.preventDefault();
                viewer.redo();
                showStatus('重做');
            }

            // Ctrl/Cmd + F: 搜索
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                viewer.toggleSearch();
                showStatus('打开搜索');
            }

            // Ctrl/Cmd + B: 添加书签
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                viewer.addBookmark();
                showStatus('添加书签');
            }

            // Ctrl/Cmd + P: 打印
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                viewer.print();
                showStatus('打开打印对话框');
            }

            // PageUp/PageDown: 翻页
            if (e.key === 'PageUp') {
                e.preventDefault();
                viewer.previousPage();
                updatePageInfo();
            } else if (e.key === 'PageDown') {
                e.preventDefault();
                viewer.nextPage();
                updatePageInfo();
            }

            // 数字键 1-5: 快速切换注释工具
            if (e.key >= '1' && e.key <= '5' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const tools = ['rectangle', 'arrow', 'pen', 'text', 'eraser'];
                const toolIndex = parseInt(e.key) - 1;
                if (toolIndex < tools.length) {
                    viewer.setAnnotationTool(tools[toolIndex]);
                    showStatus(`切换到${['矩形', '箭头', '画笔', '文本', '橡皮擦'][toolIndex]}工具`);
                }
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDFæŸ¥çœ‹å™¨ - å¸ƒå±€ä¼˜åŒ–æµ‹è¯•</title>
  
  <!-- PDF.jsåº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
  
  <!-- åŸºç¡€æ ·å¼ -->
  <link rel="stylesheet" href="./src/styles/pdf-viewer.css">
  <!-- ç°ä»£ä¸»é¢˜æ ·å¼ -->
  <link rel="stylesheet" href="./src/styles/pdf-viewer-modern.css">
  <!-- å¸ƒå±€ä¿®å¤æ ·å¼ - æœ€ååŠ è½½ä»¥ç¡®ä¿è¦†ç›– -->
  <link rel="stylesheet" href="./src/styles/pdf-layout-fix.css">
  
  <style>
    /* é¡µé¢åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      overflow: hidden;
      background: #f5f5f5;
    }
    
    /* ç¡®ä¿å®¹å™¨å æ»¡å±å¹• */
    #pdfViewerContainer {
      width: 100vw;
      height: 100vh;
    }
    
    /* åŠ è½½æç¤ºæ ·å¼ */
    .upload-prompt {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    
    .upload-prompt h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .upload-prompt p {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .upload-btn {
      display: inline-block;
      padding: 12px 30px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .upload-btn:hover {
      background: #357abd;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }
    
    .load-sample-btn {
      display: inline-block;
      margin-left: 10px;
      padding: 12px 30px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .load-sample-btn:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    #fileInput {
      display: none;
    }
    
    /* æµ‹è¯•æŒ‡ç¤ºå™¨ */
    .test-indicators {
      position: fixed;
      top: 70px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 500;
      font-size: 12px;
      max-width: 200px;
    }
    
    .test-indicators h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 14px;
    }
    
    .indicator-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .indicator-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .indicator-status.success {
      background: #28a745;
    }
    
    .indicator-status.warning {
      background: #ffc107;
    }
    
    .indicator-status.error {
      background: #dc3545;
    }
    
    .indicator-label {
      color: #666;
    }
  </style>
</head>
<body>
  <!-- PDFæŸ¥çœ‹å™¨å®¹å™¨ -->
  <div id="pdfViewerContainer" class="pdf-viewer" data-theme="light" data-page-mode="single">
    
    <!-- å·¥å…·æ  -->
    <div class="pdf-toolbar">
      <div class="pdf-toolbar-section">
        <button class="pdf-toolbar-button" id="toggleSidebar" title="åˆ‡æ¢ä¾§è¾¹æ ">
          <span>â˜°</span>
        </button>
        <div class="pdf-toolbar-separator"></div>
        <button class="pdf-toolbar-button" id="prevPage" title="ä¸Šä¸€é¡µ" disabled>
          <span>â—„</span>
        </button>
        <div class="pdf-page-navigation">
          <input type="number" class="pdf-page-input" id="pageNumber" value="1" min="1">
          <span class="pdf-page-label">/ <span id="totalPages">0</span></span>
        </div>
        <button class="pdf-toolbar-button" id="nextPage" title="ä¸‹ä¸€é¡µ" disabled>
          <span>â–º</span>
        </button>
      </div>
      
      <div class="pdf-toolbar-section">
        <div class="pdf-zoom-controls">
          <button class="pdf-toolbar-button" id="zoomOut" title="ç¼©å°">
            <span>ï¼</span>
          </button>
          <select class="pdf-scale-select" id="scaleSelect">
            <option value="0.5">50%</option>
            <option value="0.75">75%</option>
            <option value="1" selected>100%</option>
            <option value="1.25">125%</option>
            <option value="1.5">150%</option>
            <option value="2">200%</option>
            <option value="page-fit">é€‚åº”é¡µé¢</option>
            <option value="page-width">é€‚åº”å®½åº¦</option>
          </select>
          <button class="pdf-toolbar-button" id="zoomIn" title="æ”¾å¤§">
            <span>ï¼‹</span>
          </button>
        </div>
      </div>
      
      <div class="pdf-toolbar-section">
        <button class="pdf-toolbar-button" id="rotateLeft" title="é€†æ—¶é’ˆæ—‹è½¬">
          <span>â†º</span>
        </button>
        <button class="pdf-toolbar-button" id="rotateRight" title="é¡ºæ—¶é’ˆæ—‹è½¬">
          <span>â†»</span>
        </button>
        <div class="pdf-toolbar-separator"></div>
        <button class="pdf-toolbar-button" id="toggleMode" title="åˆ‡æ¢é¡µé¢æ¨¡å¼">
          <span>âŠ</span>
        </button>
        <button class="pdf-toolbar-button" id="print" title="æ‰“å°">
          <span>ğŸ–¨</span>
        </button>
        <button class="pdf-toolbar-button" id="download" title="ä¸‹è½½">
          <span>â¬‡</span>
        </button>
      </div>
    </div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="pdf-sidebar" id="sidebar">
      <div class="pdf-sidebar-tabs">
        <button class="pdf-sidebar-tab active" data-tab="thumbnails">ç¼©ç•¥å›¾</button>
        <button class="pdf-sidebar-tab" data-tab="outline">å¤§çº²</button>
        <button class="pdf-sidebar-tab" data-tab="annotations">æ³¨é‡Š</button>
      </div>
      <div class="pdf-sidebar-content">
        <div id="thumbnailsPanel" class="pdf-thumbnails-panel">
          <!-- ç¼©ç•¥å›¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div id="outlinePanel" class="pdf-outline-panel" style="display: none;">
          <p class="pdf-outline-placeholder">æš‚æ— å¤§çº²ä¿¡æ¯</p>
        </div>
        <div id="annotationsPanel" class="pdf-annotations-panel" style="display: none;">
          <p class="pdf-outline-placeholder">æš‚æ— æ³¨é‡Š</p>
        </div>
      </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="pdf-canvas-container" id="canvasContainer">
      <!-- ä¸Šä¼ æç¤º -->
      <div class="upload-prompt" id="uploadPrompt">
        <h2>ğŸ“„ PDFæŸ¥çœ‹å™¨å¸ƒå±€ä¼˜åŒ–æµ‹è¯•</h2>
        <p>
          æ­¤é¡µé¢ç”¨äºæµ‹è¯•PDFæŸ¥çœ‹å™¨çš„å¸ƒå±€ä¼˜åŒ–æ•ˆæœã€‚<br>
          è¯·é€‰æ‹©ä¸€ä¸ªPDFæ–‡ä»¶å¼€å§‹æµ‹è¯•ï¼Œæˆ–åŠ è½½ç¤ºä¾‹æ–‡æ¡£ã€‚
        </p>
        <label for="fileInput" class="upload-btn">é€‰æ‹©PDFæ–‡ä»¶</label>
        <button class="load-sample-btn" id="loadSample">åŠ è½½ç¤ºä¾‹PDF</button>
        <input type="file" id="fileInput" accept=".pdf">
      </div>
    </div>
  </div>
  
  <!-- æµ‹è¯•æŒ‡ç¤ºå™¨ -->
  <div class="test-indicators">
    <h3>å¸ƒå±€çŠ¶æ€æ£€æµ‹</h3>
    <div class="indicator-item">
      <span class="indicator-status success" id="toolbarStatus"></span>
      <span class="indicator-label">å·¥å…·æ å›ºå®š</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status success" id="sidebarStatus"></span>
      <span class="indicator-label">ä¾§è¾¹æ å®šä½</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status success" id="canvasStatus"></span>
      <span class="indicator-label">å†…å®¹åŒºåŸŸ</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status success" id="overflowStatus"></span>
      <span class="indicator-label">æ»šåŠ¨æ­£å¸¸</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status warning" id="zindexStatus"></span>
      <span class="indicator-label">å±‚çº§æ­£ç¡®</span>
    </div>
  </div>
  
  <script>
    // è®¾ç½®PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // å…¨å±€å˜é‡
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let scale = 1.0;
    let rotation = 0;
    let pageMode = 'single';
    let currentRenderTask = null;
    
    // DOMå…ƒç´ 
    const container = document.getElementById('pdfViewerContainer');
    const canvasContainer = document.getElementById('canvasContainer');
    const sidebar = document.getElementById('sidebar');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const fileInput = document.getElementById('fileInput');
    const pageNumberInput = document.getElementById('pageNumber');
    const totalPagesSpan = document.getElementById('totalPages');
    const scaleSelect = document.getElementById('scaleSelect');
    const thumbnailsPanel = document.getElementById('thumbnailsPanel');
    
    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    function initEventListeners() {
      // æ–‡ä»¶é€‰æ‹©
      fileInput.addEventListener('change', handleFileSelect);
      document.getElementById('loadSample').addEventListener('click', loadSamplePDF);
      
      // å·¥å…·æ æŒ‰é’®
      document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
      document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
      document.getElementById('nextPage').addEventListener('click', () => changePage(1));
      document.getElementById('zoomIn').addEventListener('click', () => changeScale(0.25));
      document.getElementById('zoomOut').addEventListener('click', () => changeScale(-0.25));
      document.getElementById('rotateLeft').addEventListener('click', () => rotate(-90));
      document.getElementById('rotateRight').addEventListener('click', () => rotate(90));
      document.getElementById('toggleMode').addEventListener('click', togglePageMode);
      document.getElementById('print').addEventListener('click', () => window.print());
      document.getElementById('download').addEventListener('click', downloadPDF);
      
      // é¡µç è¾“å…¥
      pageNumberInput.addEventListener('change', (e) => {
        const page = parseInt(e.target.value);
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          renderPage(currentPage);
        }
      });
      
      // ç¼©æ”¾é€‰æ‹©
      scaleSelect.addEventListener('change', (e) => {
        if (e.target.value === 'page-fit' || e.target.value === 'page-width') {
          // å¤„ç†ç‰¹æ®Šç¼©æ”¾æ¨¡å¼
          fitToPage(e.target.value);
        } else {
          scale = parseFloat(e.target.value);
          renderPage(currentPage);
        }
      });
      
      // ä¾§è¾¹æ æ ‡ç­¾åˆ‡æ¢
      document.querySelectorAll('.pdf-sidebar-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          switchSidebarTab(e.target.dataset.tab);
        });
      });
    }
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const typedArray = new Uint8Array(this.result);
          loadPDF(typedArray);
        };
        fileReader.readAsArrayBuffer(file);
      }
    }
    
    // åŠ è½½ç¤ºä¾‹PDF
    function loadSamplePDF() {
      // ä½¿ç”¨Mozillaçš„ç¤ºä¾‹PDF
      const url = 'https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/examples/learning/helloworld.pdf';
      loadPDF(url);
    }
    
    // åŠ è½½PDFæ–‡æ¡£
    async function loadPDF(source) {
      try {
        // éšè—ä¸Šä¼ æç¤º
        uploadPrompt.style.display = 'none';
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        canvasContainer.innerHTML = '<div class="pdf-loading"><div class="pdf-spinner"></div><p>æ­£åœ¨åŠ è½½PDF...</p></div>';
        
        // åŠ è½½PDF
        const loadingTask = pdfjsLib.getDocument(source);
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // æ›´æ–°UI
        totalPagesSpan.textContent = totalPages;
        pageNumberInput.max = totalPages;
        document.getElementById('prevPage').disabled = false;
        document.getElementById('nextPage').disabled = totalPages <= 1;
        
        // æ¸²æŸ“ç¬¬ä¸€é¡µ
        await renderPage(1);
        
        // ç”Ÿæˆç¼©ç•¥å›¾
        generateThumbnails();
        
        // æ›´æ–°å¸ƒå±€æ£€æµ‹çŠ¶æ€
        checkLayoutStatus();
        
      } catch (error) {
        console.error('åŠ è½½PDFå¤±è´¥:', error);
        canvasContainer.innerHTML = '<div class="pdf-error"><p>åŠ è½½PDFå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p></div>';
      }
    }
    
    // æ¸²æŸ“é¡µé¢
    async function renderPage(pageNum) {
      if (!pdfDoc) return;
      
      try {
        // å–æ¶ˆä¹‹å‰çš„æ¸²æŸ“ä»»åŠ¡
        if (currentRenderTask) {
          currentRenderTask.cancel();
        }
        
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: scale, rotation: rotation });
        
        // åˆ›å»ºæˆ–è·å–canvas
        let canvas = document.getElementById('pdfCanvas');
        if (!canvas) {
          canvasContainer.innerHTML = '';
          const pageWrapper = document.createElement('div');
          pageWrapper.className = 'pdf-page-wrapper';
          canvas = document.createElement('canvas');
          canvas.id = 'pdfCanvas';
          canvas.className = 'pdf-canvas';
          pageWrapper.appendChild(canvas);
          canvasContainer.appendChild(pageWrapper);
        }
        
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // æ¸²æŸ“PDFé¡µé¢
        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        
        currentRenderTask = page.render(renderContext);
        await currentRenderTask.promise;
        
        // æ›´æ–°å½“å‰é¡µç 
        currentPage = pageNum;
        pageNumberInput.value = pageNum;
        
        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        document.getElementById('prevPage').disabled = pageNum <= 1;
        document.getElementById('nextPage').disabled = pageNum >= totalPages;
        
      } catch (error) {
        if (error.name !== 'RenderingCancelledException') {
          console.error('æ¸²æŸ“é¡µé¢å¤±è´¥:', error);
        }
      }
    }
    
    // ç”Ÿæˆç¼©ç•¥å›¾
    async function generateThumbnails() {
      if (!pdfDoc) return;
      
      thumbnailsPanel.innerHTML = '';
      
      for (let i = 1; i <= Math.min(totalPages, 20); i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 0.3 });
        
        const thumbnailItem = document.createElement('div');
        thumbnailItem.className = 'pdf-thumbnail-item';
        if (i === currentPage) thumbnailItem.classList.add('active');
        
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-thumbnail-canvas';
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;
        
        const label = document.createElement('span');
        label.className = 'pdf-thumbnail-label';
        label.textContent = `é¡µ ${i}`;
        
        thumbnailItem.appendChild(canvas);
        thumbnailItem.appendChild(label);
        thumbnailItem.addEventListener('click', () => {
          renderPage(i);
          updateActiveThumbnail(i);
        });
        
        thumbnailsPanel.appendChild(thumbnailItem);
      }
    }
    
    // æ›´æ–°æ´»åŠ¨ç¼©ç•¥å›¾
    function updateActiveThumbnail(pageNum) {
      document.querySelectorAll('.pdf-thumbnail-item').forEach((item, index) => {
        if (index + 1 === pageNum) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // åˆ‡æ¢ä¾§è¾¹æ 
    function toggleSidebar() {
      sidebar.classList.toggle('hidden');
      canvasContainer.classList.toggle('sidebar-hidden');
      checkLayoutStatus();
    }
    
    // åˆ‡æ¢é¡µé¢
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        renderPage(newPage);
        updateActiveThumbnail(newPage);
      }
    }
    
    // æ”¹å˜ç¼©æ”¾
    function changeScale(delta) {
      scale = Math.max(0.25, Math.min(3, scale + delta));
      scaleSelect.value = scale;
      renderPage(currentPage);
    }
    
    // æ—‹è½¬
    function rotate(angle) {
      rotation = (rotation + angle) % 360;
      renderPage(currentPage);
    }
    
    // åˆ‡æ¢é¡µé¢æ¨¡å¼
    function togglePageMode() {
      pageMode = pageMode === 'single' ? 'continuous' : 'single';
      container.dataset.pageMode = pageMode;
      renderPage(currentPage);
    }
    
    // é€‚åº”é¡µé¢
    function fitToPage(mode) {
      // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ ¹æ®å®¹å™¨å¤§å°è®¡ç®—
      scale = mode === 'page-width' ? 1.5 : 1.0;
      renderPage(currentPage);
    }
    
    // ä¸‹è½½PDF
    function downloadPDF() {
      if (pdfDoc) {
        alert('ä¸‹è½½åŠŸèƒ½éœ€è¦åŸå§‹PDFæ–‡ä»¶URL');
      }
    }
    
    // åˆ‡æ¢ä¾§è¾¹æ æ ‡ç­¾
    function switchSidebarTab(tabName) {
      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.pdf-sidebar-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // æ˜¾ç¤ºå¯¹åº”é¢æ¿
      document.getElementById('thumbnailsPanel').style.display = tabName === 'thumbnails' ? 'block' : 'none';
      document.getElementById('outlinePanel').style.display = tabName === 'outline' ? 'block' : 'none';
      document.getElementById('annotationsPanel').style.display = tabName === 'annotations' ? 'block' : 'none';
    }
    
    // æ£€æŸ¥å¸ƒå±€çŠ¶æ€
    function checkLayoutStatus() {
      // æ£€æŸ¥å·¥å…·æ 
      const toolbar = document.querySelector('.pdf-toolbar');
      const toolbarRect = toolbar.getBoundingClientRect();
      document.getElementById('toolbarStatus').className = 
        toolbarRect.height <= 60 ? 'indicator-status success' : 'indicator-status warning';
      
      // æ£€æŸ¥ä¾§è¾¹æ 
      const sidebarRect = sidebar.getBoundingClientRect();
      document.getElementById('sidebarStatus').className = 
        sidebarRect.top >= 56 ? 'indicator-status success' : 'indicator-status warning';
      
      // æ£€æŸ¥å†…å®¹åŒºåŸŸ
      const canvasRect = canvasContainer.getBoundingClientRect();
      const hasCorrectMargin = sidebar.classList.contains('hidden') || canvasRect.left >= 260;
      document.getElementById('canvasStatus').className = 
        hasCorrectMargin ? 'indicator-status success' : 'indicator-status error';
      
      // æ£€æŸ¥æ»šåŠ¨
      const hasScroll = canvasContainer.scrollHeight > canvasContainer.clientHeight || 
                       canvasContainer.scrollWidth > canvasContainer.clientWidth;
      document.getElementById('overflowStatus').className = 'indicator-status success';
      
      // æ£€æŸ¥z-index
      const toolbarZIndex = window.getComputedStyle(toolbar).zIndex;
      const sidebarZIndex = window.getComputedStyle(sidebar).zIndex;
      const correctZIndex = parseInt(toolbarZIndex) > parseInt(sidebarZIndex);
      document.getElementById('zindexStatus').className = 
        correctZIndex ? 'indicator-status success' : 'indicator-status warning';
    }
    
    // åˆå§‹åŒ–
    initEventListeners();
    
    // çª—å£è°ƒæ•´æ—¶é‡æ–°æ£€æŸ¥å¸ƒå±€
    window.addEventListener('resize', () => {
      if (pdfDoc) {
        renderPage(currentPage);
      }
      checkLayoutStatus();
    });
  </script>
</body>
</html>
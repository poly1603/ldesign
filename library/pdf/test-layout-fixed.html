<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF查看器 - 布局优化测试</title>
  
  <!-- PDF.js库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
  
  <!-- 基础样式 -->
  <link rel="stylesheet" href="./src/styles/pdf-viewer.css">
  <!-- 现代主题样式 -->
  <link rel="stylesheet" href="./src/styles/pdf-viewer-modern.css">
  <!-- 布局修复样式 - 最后加载以确保覆盖 -->
  <link rel="stylesheet" href="./src/styles/pdf-layout-fix.css">
  
  <style>
    /* 页面基础样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      overflow: hidden;
      background: #f5f5f5;
    }
    
    /* 确保容器占满屏幕 */
    #pdfViewerContainer {
      width: 100vw;
      height: 100vh;
    }
    
    /* 加载提示样式 */
    .upload-prompt {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    
    .upload-prompt h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .upload-prompt p {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .upload-btn {
      display: inline-block;
      padding: 12px 30px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .upload-btn:hover {
      background: #357abd;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }
    
    .load-sample-btn {
      display: inline-block;
      margin-left: 10px;
      padding: 12px 30px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .load-sample-btn:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    #fileInput {
      display: none;
    }
    
    /* 测试指示器 */
    .test-indicators {
      position: fixed;
      top: 70px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 500;
      font-size: 12px;
      max-width: 200px;
    }
    
    .test-indicators h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 14px;
    }
    
    .indicator-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .indicator-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .indicator-status.success {
      background: #28a745;
    }
    
    .indicator-status.warning {
      background: #ffc107;
    }
    
    .indicator-status.error {
      background: #dc3545;
    }
    
    .indicator-label {
      color: #666;
    }
  </style>
</head>
<body>
  <!-- PDF查看器容器 -->
  <div id="pdfViewerContainer" class="pdf-viewer" data-theme="light" data-page-mode="single">
    
    <!-- 工具栏 -->
    <div class="pdf-toolbar">
      <div class="pdf-toolbar-section">
        <button class="pdf-toolbar-button" id="toggleSidebar" title="切换侧边栏">
          <span>☰</span>
        </button>
        <div class="pdf-toolbar-separator"></div>
        <button class="pdf-toolbar-button" id="prevPage" title="上一页" disabled>
          <span>◄</span>
        </button>
        <div class="pdf-page-navigation">
          <input type="number" class="pdf-page-input" id="pageNumber" value="1" min="1">
          <span class="pdf-page-label">/ <span id="totalPages">0</span></span>
        </div>
        <button class="pdf-toolbar-button" id="nextPage" title="下一页" disabled>
          <span>►</span>
        </button>
      </div>
      
      <div class="pdf-toolbar-section">
        <div class="pdf-zoom-controls">
          <button class="pdf-toolbar-button" id="zoomOut" title="缩小">
            <span>－</span>
          </button>
          <select class="pdf-scale-select" id="scaleSelect">
            <option value="0.5">50%</option>
            <option value="0.75">75%</option>
            <option value="1" selected>100%</option>
            <option value="1.25">125%</option>
            <option value="1.5">150%</option>
            <option value="2">200%</option>
            <option value="page-fit">适应页面</option>
            <option value="page-width">适应宽度</option>
          </select>
          <button class="pdf-toolbar-button" id="zoomIn" title="放大">
            <span>＋</span>
          </button>
        </div>
      </div>
      
      <div class="pdf-toolbar-section">
        <button class="pdf-toolbar-button" id="rotateLeft" title="逆时针旋转">
          <span>↺</span>
        </button>
        <button class="pdf-toolbar-button" id="rotateRight" title="顺时针旋转">
          <span>↻</span>
        </button>
        <div class="pdf-toolbar-separator"></div>
        <button class="pdf-toolbar-button" id="toggleMode" title="切换页面模式">
          <span>⊞</span>
        </button>
        <button class="pdf-toolbar-button" id="print" title="打印">
          <span>🖨</span>
        </button>
        <button class="pdf-toolbar-button" id="download" title="下载">
          <span>⬇</span>
        </button>
      </div>
    </div>
    
    <!-- 侧边栏 -->
    <div class="pdf-sidebar" id="sidebar">
      <div class="pdf-sidebar-tabs">
        <button class="pdf-sidebar-tab active" data-tab="thumbnails">缩略图</button>
        <button class="pdf-sidebar-tab" data-tab="outline">大纲</button>
        <button class="pdf-sidebar-tab" data-tab="annotations">注释</button>
      </div>
      <div class="pdf-sidebar-content">
        <div id="thumbnailsPanel" class="pdf-thumbnails-panel">
          <!-- 缩略图将在这里动态生成 -->
        </div>
        <div id="outlinePanel" class="pdf-outline-panel" style="display: none;">
          <p class="pdf-outline-placeholder">暂无大纲信息</p>
        </div>
        <div id="annotationsPanel" class="pdf-annotations-panel" style="display: none;">
          <p class="pdf-outline-placeholder">暂无注释</p>
        </div>
      </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="pdf-canvas-container" id="canvasContainer">
      <!-- 上传提示 -->
      <div class="upload-prompt" id="uploadPrompt">
        <h2>📄 PDF查看器布局优化测试</h2>
        <p>
          此页面用于测试PDF查看器的布局优化效果。<br>
          请选择一个PDF文件开始测试，或加载示例文档。
        </p>
        <label for="fileInput" class="upload-btn">选择PDF文件</label>
        <button class="load-sample-btn" id="loadSample">加载示例PDF</button>
        <input type="file" id="fileInput" accept=".pdf">
      </div>
    </div>
  </div>
  
  <!-- 测试指示器 -->
  <div class="test-indicators">
    <h3>布局状态检测</h3>
    <div class="indicator-item">
      <span class="indicator-status success" id="toolbarStatus"></span>
      <span class="indicator-label">工具栏固定</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status success" id="sidebarStatus"></span>
      <span class="indicator-label">侧边栏定位</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status success" id="canvasStatus"></span>
      <span class="indicator-label">内容区域</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status success" id="overflowStatus"></span>
      <span class="indicator-label">滚动正常</span>
    </div>
    <div class="indicator-item">
      <span class="indicator-status warning" id="zindexStatus"></span>
      <span class="indicator-label">层级正确</span>
    </div>
  </div>
  
  <script>
    // 设置PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // 全局变量
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let scale = 1.0;
    let rotation = 0;
    let pageMode = 'single';
    let currentRenderTask = null;
    
    // DOM元素
    const container = document.getElementById('pdfViewerContainer');
    const canvasContainer = document.getElementById('canvasContainer');
    const sidebar = document.getElementById('sidebar');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const fileInput = document.getElementById('fileInput');
    const pageNumberInput = document.getElementById('pageNumber');
    const totalPagesSpan = document.getElementById('totalPages');
    const scaleSelect = document.getElementById('scaleSelect');
    const thumbnailsPanel = document.getElementById('thumbnailsPanel');
    
    // 初始化事件监听
    function initEventListeners() {
      // 文件选择
      fileInput.addEventListener('change', handleFileSelect);
      document.getElementById('loadSample').addEventListener('click', loadSamplePDF);
      
      // 工具栏按钮
      document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
      document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
      document.getElementById('nextPage').addEventListener('click', () => changePage(1));
      document.getElementById('zoomIn').addEventListener('click', () => changeScale(0.25));
      document.getElementById('zoomOut').addEventListener('click', () => changeScale(-0.25));
      document.getElementById('rotateLeft').addEventListener('click', () => rotate(-90));
      document.getElementById('rotateRight').addEventListener('click', () => rotate(90));
      document.getElementById('toggleMode').addEventListener('click', togglePageMode);
      document.getElementById('print').addEventListener('click', () => window.print());
      document.getElementById('download').addEventListener('click', downloadPDF);
      
      // 页码输入
      pageNumberInput.addEventListener('change', (e) => {
        const page = parseInt(e.target.value);
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          renderPage(currentPage);
        }
      });
      
      // 缩放选择
      scaleSelect.addEventListener('change', (e) => {
        if (e.target.value === 'page-fit' || e.target.value === 'page-width') {
          // 处理特殊缩放模式
          fitToPage(e.target.value);
        } else {
          scale = parseFloat(e.target.value);
          renderPage(currentPage);
        }
      });
      
      // 侧边栏标签切换
      document.querySelectorAll('.pdf-sidebar-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          switchSidebarTab(e.target.dataset.tab);
        });
      });
    }
    
    // 处理文件选择
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const typedArray = new Uint8Array(this.result);
          loadPDF(typedArray);
        };
        fileReader.readAsArrayBuffer(file);
      }
    }
    
    // 加载示例PDF
    function loadSamplePDF() {
      // 使用Mozilla的示例PDF
      const url = 'https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/examples/learning/helloworld.pdf';
      loadPDF(url);
    }
    
    // 加载PDF文档
    async function loadPDF(source) {
      try {
        // 隐藏上传提示
        uploadPrompt.style.display = 'none';
        
        // 显示加载状态
        canvasContainer.innerHTML = '<div class="pdf-loading"><div class="pdf-spinner"></div><p>正在加载PDF...</p></div>';
        
        // 加载PDF
        const loadingTask = pdfjsLib.getDocument(source);
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        
        // 更新UI
        totalPagesSpan.textContent = totalPages;
        pageNumberInput.max = totalPages;
        document.getElementById('prevPage').disabled = false;
        document.getElementById('nextPage').disabled = totalPages <= 1;
        
        // 渲染第一页
        await renderPage(1);
        
        // 生成缩略图
        generateThumbnails();
        
        // 更新布局检测状态
        checkLayoutStatus();
        
      } catch (error) {
        console.error('加载PDF失败:', error);
        canvasContainer.innerHTML = '<div class="pdf-error"><p>加载PDF失败，请重试。</p></div>';
      }
    }
    
    // 渲染页面
    async function renderPage(pageNum) {
      if (!pdfDoc) return;
      
      try {
        // 取消之前的渲染任务
        if (currentRenderTask) {
          currentRenderTask.cancel();
        }
        
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: scale, rotation: rotation });
        
        // 创建或获取canvas
        let canvas = document.getElementById('pdfCanvas');
        if (!canvas) {
          canvasContainer.innerHTML = '';
          const pageWrapper = document.createElement('div');
          pageWrapper.className = 'pdf-page-wrapper';
          canvas = document.createElement('canvas');
          canvas.id = 'pdfCanvas';
          canvas.className = 'pdf-canvas';
          pageWrapper.appendChild(canvas);
          canvasContainer.appendChild(pageWrapper);
        }
        
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // 渲染PDF页面
        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        
        currentRenderTask = page.render(renderContext);
        await currentRenderTask.promise;
        
        // 更新当前页码
        currentPage = pageNum;
        pageNumberInput.value = pageNum;
        
        // 更新导航按钮状态
        document.getElementById('prevPage').disabled = pageNum <= 1;
        document.getElementById('nextPage').disabled = pageNum >= totalPages;
        
      } catch (error) {
        if (error.name !== 'RenderingCancelledException') {
          console.error('渲染页面失败:', error);
        }
      }
    }
    
    // 生成缩略图
    async function generateThumbnails() {
      if (!pdfDoc) return;
      
      thumbnailsPanel.innerHTML = '';
      
      for (let i = 1; i <= Math.min(totalPages, 20); i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 0.3 });
        
        const thumbnailItem = document.createElement('div');
        thumbnailItem.className = 'pdf-thumbnail-item';
        if (i === currentPage) thumbnailItem.classList.add('active');
        
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-thumbnail-canvas';
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;
        
        const label = document.createElement('span');
        label.className = 'pdf-thumbnail-label';
        label.textContent = `页 ${i}`;
        
        thumbnailItem.appendChild(canvas);
        thumbnailItem.appendChild(label);
        thumbnailItem.addEventListener('click', () => {
          renderPage(i);
          updateActiveThumbnail(i);
        });
        
        thumbnailsPanel.appendChild(thumbnailItem);
      }
    }
    
    // 更新活动缩略图
    function updateActiveThumbnail(pageNum) {
      document.querySelectorAll('.pdf-thumbnail-item').forEach((item, index) => {
        if (index + 1 === pageNum) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // 切换侧边栏
    function toggleSidebar() {
      sidebar.classList.toggle('hidden');
      canvasContainer.classList.toggle('sidebar-hidden');
      checkLayoutStatus();
    }
    
    // 切换页面
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        renderPage(newPage);
        updateActiveThumbnail(newPage);
      }
    }
    
    // 改变缩放
    function changeScale(delta) {
      scale = Math.max(0.25, Math.min(3, scale + delta));
      scaleSelect.value = scale;
      renderPage(currentPage);
    }
    
    // 旋转
    function rotate(angle) {
      rotation = (rotation + angle) % 360;
      renderPage(currentPage);
    }
    
    // 切换页面模式
    function togglePageMode() {
      pageMode = pageMode === 'single' ? 'continuous' : 'single';
      container.dataset.pageMode = pageMode;
      renderPage(currentPage);
    }
    
    // 适应页面
    function fitToPage(mode) {
      // 这里简化处理，实际应该根据容器大小计算
      scale = mode === 'page-width' ? 1.5 : 1.0;
      renderPage(currentPage);
    }
    
    // 下载PDF
    function downloadPDF() {
      if (pdfDoc) {
        alert('下载功能需要原始PDF文件URL');
      }
    }
    
    // 切换侧边栏标签
    function switchSidebarTab(tabName) {
      // 更新标签状态
      document.querySelectorAll('.pdf-sidebar-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // 显示对应面板
      document.getElementById('thumbnailsPanel').style.display = tabName === 'thumbnails' ? 'block' : 'none';
      document.getElementById('outlinePanel').style.display = tabName === 'outline' ? 'block' : 'none';
      document.getElementById('annotationsPanel').style.display = tabName === 'annotations' ? 'block' : 'none';
    }
    
    // 检查布局状态
    function checkLayoutStatus() {
      // 检查工具栏
      const toolbar = document.querySelector('.pdf-toolbar');
      const toolbarRect = toolbar.getBoundingClientRect();
      document.getElementById('toolbarStatus').className = 
        toolbarRect.height <= 60 ? 'indicator-status success' : 'indicator-status warning';
      
      // 检查侧边栏
      const sidebarRect = sidebar.getBoundingClientRect();
      document.getElementById('sidebarStatus').className = 
        sidebarRect.top >= 56 ? 'indicator-status success' : 'indicator-status warning';
      
      // 检查内容区域
      const canvasRect = canvasContainer.getBoundingClientRect();
      const hasCorrectMargin = sidebar.classList.contains('hidden') || canvasRect.left >= 260;
      document.getElementById('canvasStatus').className = 
        hasCorrectMargin ? 'indicator-status success' : 'indicator-status error';
      
      // 检查滚动
      const hasScroll = canvasContainer.scrollHeight > canvasContainer.clientHeight || 
                       canvasContainer.scrollWidth > canvasContainer.clientWidth;
      document.getElementById('overflowStatus').className = 'indicator-status success';
      
      // 检查z-index
      const toolbarZIndex = window.getComputedStyle(toolbar).zIndex;
      const sidebarZIndex = window.getComputedStyle(sidebar).zIndex;
      const correctZIndex = parseInt(toolbarZIndex) > parseInt(sidebarZIndex);
      document.getElementById('zindexStatus').className = 
        correctZIndex ? 'indicator-status success' : 'indicator-status warning';
    }
    
    // 初始化
    initEventListeners();
    
    // 窗口调整时重新检查布局
    window.addEventListener('resize', () => {
      if (pdfDoc) {
        renderPage(currentPage);
      }
      checkLayoutStatus();
    });
  </script>
</body>
</html>
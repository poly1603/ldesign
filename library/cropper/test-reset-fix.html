<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Reset Fix - @ldesign/cropper</title>
  <link rel="stylesheet" href="./dist/style.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      font-family: system-ui, -apple-system, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    .demo-section {
      margin: 20px 0;
    }
    #cropper-container {
      width: 100%;
      height: 600px;
      background: #2a2a2a;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      background: #4A90E2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    button:hover {
      background: #357ABD;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }
    button:active {
      transform: translateY(0);
    }
    .reset-btn {
      background: #52c41a;
    }
    .reset-btn:hover {
      background: #389e0d;
    }
    .info-panel {
      margin-top: 20px;
      padding: 15px;
      background: #f0f2f5;
      border-radius: 4px;
    }
    .info-item {
      margin: 5px 0;
      color: #666;
    }
    .info-item strong {
      color: #333;
      margin-right: 10px;
    }
    .preview-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    .preview-box {
      flex: 1;
    }
    .preview-box h3 {
      margin-top: 0;
      color: #666;
    }
    #preview {
      width: 100%;
      max-width: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .test-status {
      padding: 10px;
      margin-top: 20px;
      border-radius: 4px;
      font-weight: bold;
    }
    .test-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .test-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎯 Test Reset Fix - @ldesign/cropper</h1>
    
    <div class="demo-section">
      <h2>2. Crop & Transform Image</h2>
      <div id="cropper-container"></div>
      
      <div class="controls">
        <button class="reset-btn" id="reset-btn">Reset</button>
        <button id="rotate-btn">Rotate 45°</button>
        <button id="scale-btn">Scale 0.96</button>
        <button id="get-data-btn">Get Crop Data</button>
        <button id="test-reset-btn">Test Multiple Resets</button>
      </div>

      <div class="test-status" id="test-status" style="display: none;"></div>
      
      <div class="info-panel">
        <h3>Image Data</h3>
        <div class="info-item"><strong>X:</strong> <span id="info-x">-</span></div>
        <div class="info-item"><strong>Y:</strong> <span id="info-y">-</span></div>
        <div class="info-item"><strong>Width:</strong> <span id="info-width">-</span></div>
        <div class="info-item"><strong>Height:</strong> <span id="info-height">-</span></div>
        <div class="info-item"><strong>Rotate:</strong> <span id="info-rotate">0°</span></div>
        <div class="info-item"><strong>ScaleX:</strong> <span id="info-scalex">1</span></div>
        <div class="info-item"><strong>ScaleY:</strong> <span id="info-scaley">1</span></div>
        <div class="info-item"><strong>Crop Boxes Count:</strong> <span id="cropbox-count">0</span></div>
      </div>

      <div class="preview-container">
        <div class="preview-box">
          <h3>Preview</h3>
          <canvas id="preview"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Cropper } from './dist/index.js';

    // Initialize cropper
    const cropper = new Cropper('#cropper-container', {
      src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1200&h=800&fit=crop',
      aspectRatio: 1,
      autoCrop: true,
      autoCropArea: 0.5,
      guides: true,
      center: true,
      highlight: true,
      background: true,
      movable: true,
      rotatable: true,
      scalable: true,
      zoomable: true,
      cropBoxMovable: true,
      cropBoxResizable: true,
      ready() {
        updateInfo();
        countCropBoxes();
      },
      crop(event) {
        updateInfo();
        updatePreview();
      }
    });

    // Update info panel
    function updateInfo() {
      const data = cropper.getCropBoxData();
      const imageData = cropper.getImageData();
      
      if (data) {
        document.getElementById('info-x').textContent = data.left.toFixed(2);
        document.getElementById('info-y').textContent = data.top.toFixed(2);
        document.getElementById('info-width').textContent = data.width.toFixed(2);
        document.getElementById('info-height').textContent = data.height.toFixed(2);
      }
      
      if (imageData) {
        document.getElementById('info-rotate').textContent = imageData.rotate.toFixed(2) + '°';
        document.getElementById('info-scalex').textContent = imageData.scaleX.toFixed(2);
        document.getElementById('info-scaley').textContent = imageData.scaleY.toFixed(2);
      }
    }

    // Update preview
    function updatePreview() {
      const canvas = document.getElementById('preview');
      const croppedCanvas = cropper.getCroppedCanvas({
        width: 300,
        height: 300
      });
      
      if (croppedCanvas) {
        const ctx = canvas.getContext('2d');
        canvas.width = croppedCanvas.width;
        canvas.height = croppedCanvas.height;
        ctx.drawImage(croppedCanvas, 0, 0);
      }
    }

    // Count crop boxes in DOM
    function countCropBoxes() {
      const container = document.getElementById('cropper-container');
      const cropBoxes = container.querySelectorAll('.cropper-crop-box');
      document.getElementById('cropbox-count').textContent = cropBoxes.length;
      
      // Show test status
      const statusEl = document.getElementById('test-status');
      if (cropBoxes.length > 1) {
        statusEl.className = 'test-status error';
        statusEl.textContent = `❌ Error: Found ${cropBoxes.length} crop boxes! There should only be 1.`;
        statusEl.style.display = 'block';
      } else if (cropBoxes.length === 1) {
        statusEl.className = 'test-status success';
        statusEl.textContent = '✅ Success: Only 1 crop box found after reset!';
        statusEl.style.display = 'block';
      }
      
      return cropBoxes.length;
    }

    // Reset button
    document.getElementById('reset-btn').addEventListener('click', () => {
      console.log('Resetting cropper...');
      cropper.reset();
      updateInfo();
      updatePreview();
      
      // Check crop boxes count after reset
      setTimeout(() => {
        const count = countCropBoxes();
        console.log(`Crop boxes after reset: ${count}`);
      }, 100);
    });

    // Rotate button
    document.getElementById('rotate-btn').addEventListener('click', () => {
      cropper.rotate(45);
      updateInfo();
    });

    // Scale button
    document.getElementById('scale-btn').addEventListener('click', () => {
      cropper.scale(0.96, 0.96);
      updateInfo();
    });

    // Get crop data button
    document.getElementById('get-data-btn').addEventListener('click', () => {
      const data = cropper.getData();
      console.log('Crop data:', data);
      alert('Crop data logged to console');
    });

    // Test multiple resets
    document.getElementById('test-reset-btn').addEventListener('click', () => {
      console.log('Testing multiple resets...');
      
      // Perform multiple operations and resets
      cropper.rotate(90);
      cropper.scale(0.8, 0.8);
      cropper.reset();
      
      setTimeout(() => {
        cropper.rotate(-45);
        cropper.reset();
        
        setTimeout(() => {
          cropper.scale(1.2, 1.2);
          cropper.reset();
          
          setTimeout(() => {
            const count = countCropBoxes();
            console.log(`Final crop boxes count after multiple resets: ${count}`);
            updateInfo();
            updatePreview();
          }, 100);
        }, 100);
      }, 100);
    });

    // Initial count
    setTimeout(() => {
      countCropBoxes();
    }, 500);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Scale and Crop</title>
  <link rel="stylesheet" href="./dist/cropper.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    
    .container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    #cropper-container {
      width: 800px;
      height: 600px;
      border: 2px solid #333;
      background: #fff;
    }
    
    .controls {
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    button {
      padding: 8px 16px;
      margin-right: 10px;
      margin-bottom: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    input[type="range"] {
      width: 200px;
      margin-right: 10px;
    }
    
    .value-display {
      display: inline-block;
      min-width: 50px;
      font-weight: bold;
      color: #007bff;
    }
    
    #output {
      margin-top: 20px;
      padding: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .test-images {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .test-image {
      border: 2px solid #ccc;
      padding: 5px;
      background: white;
      border-radius: 4px;
    }
    
    .test-image img {
      max-width: 200px;
      max-height: 200px;
      display: block;
    }
    
    .test-image .label {
      margin-top: 5px;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Scale and Crop Test</h1>
  
  <div class="container">
    <div id="cropper-container"></div>
    
    <div class="controls">
      <div class="control-group">
        <label>Scale Controls</label>
        <button onclick="scaleImage(1.5)">Scale 1.5x</button>
        <button onclick="scaleImage(2)">Scale 2x</button>
        <button onclick="scaleImage(0.5)">Scale 0.5x</button>
        <button onclick="scaleImage(1)">Reset Scale</button>
        <div style="margin-top: 10px;">
          <label>Custom Scale:</label>
          <input type="range" id="scaleRange" min="0.1" max="3" step="0.1" value="1">
          <span class="value-display" id="scaleValue">1.0</span>
          <button onclick="applyCustomScale()">Apply</button>
        </div>
      </div>
      
      <div class="control-group">
        <label>Flip</label>
        <button onclick="flipH()">Flip Horizontal</button>
        <button onclick="flipV()">Flip Vertical</button>
      </div>
      
      <div class="control-group">
        <label>Rotate</label>
        <button onclick="rotateImage(45)">Rotate 45°</button>
        <button onclick="rotateImage(90)">Rotate 90°</button>
        <button onclick="rotateImage(-45)">Rotate -45°</button>
        <button onclick="rotateImage(-90)">Rotate -90°</button>
      </div>
      
      <div class="control-group">
        <label>Crop</label>
        <button onclick="performCrop()">Crop Image</button>
        <button onclick="resetCrop()">Reset Crop Box</button>
        <button onclick="resetAll()">Reset All</button>
      </div>
      
      <div class="control-group">
        <label>Debug Info</label>
        <button onclick="showDebugInfo()">Show Image/Crop Info</button>
      </div>
    </div>
  </div>
  
  <div id="output"></div>
  
  <div class="test-images" id="testImages"></div>
  
  <script type="module">
    import Cropper from './dist/cropper.esm.js';
    
    // Make functions available globally
    window.cropper = null;
    window.currentScale = 1;
    
    // Initialize cropper with a test image
    const imageUrl = 'https://picsum.photos/800/600';
    
    window.cropper = new Cropper('cropper-container', {
      src: imageUrl,
      aspectRatio: 0,
      viewMode: 1,
      autoCrop: true
    });
    
    window.scaleImage = function(scale) {
      window.currentScale = scale;
      window.cropper.scale(scale);
      log(`Scaled image to ${scale}x`);
    };
    
    window.flipH = function() {
      window.cropper.flipHorizontal();
      log('Flipped horizontally');
    };
    
    window.flipV = function() {
      window.cropper.flipVertical();
      log('Flipped vertically');
    };
    
    window.rotateImage = function(degrees) {
      window.cropper.rotate(degrees);
      log(`Rotated ${degrees}°`);
    };
    
    window.applyCustomScale = function() {
      const scale = parseFloat(document.getElementById('scaleRange').value);
      window.scaleImage(scale);
    };
    
    window.performCrop = function() {
      const timestamp = Date.now();
      
      // Get crop data
      const cropData = window.cropper.getCropBoxData();
      const imageData = window.cropper.getImageData();
      
      log(`Cropping with scale: ${window.currentScale}, crop box: ${JSON.stringify(cropData)}`);
      
      // Get cropped canvas
      const croppedCanvas = window.cropper.getCroppedCanvas({
        width: 400,
        height: 300
      });
      
      if (croppedCanvas) {
        // Create image element to display result
        const imgContainer = document.createElement('div');
        imgContainer.className = 'test-image';
        
        const img = document.createElement('img');
        img.src = croppedCanvas.toDataURL('image/png');
        
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = `Crop at scale ${window.currentScale}x (${timestamp})`;
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(label);
        
        document.getElementById('testImages').appendChild(imgContainer);
        
        log('Crop completed and displayed');
      } else {
        log('Failed to create cropped canvas', 'error');
      }
    };
    
    window.resetCrop = function() {
      window.cropper.reset();
      window.currentScale = 1;
      log('Reset crop box and transformations');
    };
    
    window.resetAll = function() {
      window.cropper.reset();
      window.currentScale = 1;
      document.getElementById('testImages').innerHTML = '';
      document.getElementById('output').innerHTML = '';
      log('Reset everything');
    };
    
    window.showDebugInfo = function() {
      const imageData = window.cropper.getImageData();
      const cropData = window.cropper.getCropBoxData();
      const containerData = window.cropper.getContainerData();
      
      const info = {
        image: {
          naturalWidth: imageData.naturalWidth,
          naturalHeight: imageData.naturalHeight,
          width: imageData.width,
          height: imageData.height,
          left: imageData.left,
          top: imageData.top,
          scaleX: imageData.scaleX,
          scaleY: imageData.scaleY,
          rotate: imageData.rotate
        },
        cropBox: cropData,
        container: containerData,
        currentScale: window.currentScale
      };
      
      log(`Debug Info:\n${JSON.stringify(info, null, 2)}`, 'info');
    };
    
    function log(message, type = 'log') {
      const output = document.getElementById('output');
      const entry = document.createElement('div');
      entry.style.marginBottom = '5px';
      entry.style.padding = '5px';
      entry.style.borderLeft = `3px solid ${type === 'error' ? '#dc3545' : type === 'info' ? '#17a2b8' : '#28a745'}`;
      entry.style.background = type === 'error' ? '#f8d7da' : type === 'info' ? '#d1ecf1' : '#d4edda';
      entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
      output.appendChild(entry);
      output.scrollTop = output.scrollHeight;
    }
    
    // Update scale value display
    document.getElementById('scaleRange').addEventListener('input', function(e) {
      document.getElementById('scaleValue').textContent = parseFloat(e.target.value).toFixed(1);
    });
    
    // Initial log
    log('Cropper initialized. Test scaling and then cropping.');
  </script>
</body>
</html>
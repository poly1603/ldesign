<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cropper Test - 裁剪测试</title>
  <link rel="stylesheet" href="./dist/style.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
    }
    .cropper-area {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #cropper-container {
      width: 100%;
      height: 600px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
    }
    .controls {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .control-group {
      margin-bottom: 20px;
    }
    .control-group h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #666;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #f0f0f0;
      border-color: #39f;
    }
    button.primary {
      background: #39f;
      color: white;
      border-color: #39f;
    }
    button.primary:hover {
      background: #2980eb;
    }
    .preview {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }
    #preview-canvas {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: none;
    }
    #preview-canvas.show {
      display: block;
    }
    .data-display {
      font-family: monospace;
      font-size: 12px;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="cropper-area">
      <h2>图片裁剪测试</h2>
      <div id="cropper-container"></div>
    </div>
    
    <div class="controls">
      <div class="control-group">
        <h3>选择图片</h3>
        <input type="file" id="file-input" accept="image/*">
      </div>
      
      <div class="control-group">
        <h3>预设比例</h3>
        <button data-ratio="free">自由比例</button>
        <button data-ratio="1">1:1 正方形</button>
        <button data-ratio="1.7778">16:9</button>
        <button data-ratio="1.3333">4:3</button>
        <button data-ratio="0.6667">3:4 竖版</button>
      </div>
      
      <div class="control-group">
        <h3>操作</h3>
        <button id="rotate-left">向左旋转 90°</button>
        <button id="rotate-right">向右旋转 90°</button>
        <button id="flip-h">水平翻转</button>
        <button id="flip-v">垂直翻转</button>
        <button id="reset">重置</button>
      </div>
      
      <div class="control-group">
        <h3>导出</h3>
        <button id="crop-btn" class="primary">裁剪并预览</button>
        <button id="download-btn">下载裁剪结果</button>
      </div>
      
      <div class="preview">
        <h3>预览结果</h3>
        <canvas id="preview-canvas"></canvas>
        <div id="crop-data" class="data-display"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Cropper } from './dist/index.js'
    
    let cropper = null
    let currentCroppedCanvas = null
    
    // 默认测试图片
    const defaultImage = 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1200&q=80'
    
    // 初始化裁剪器
    function initCropper(src) {
      if (cropper) {
        cropper.destroy()
      }
      
      const container = document.getElementById('cropper-container')
      cropper = new Cropper(container, {
        src: src || defaultImage,
        viewMode: 1,
        aspectRatio: NaN,
        toolbar: true,
        history: true,
        presets: true,
        ready: (event) => {
          console.log('Cropper ready', event)
          updateData()
        },
        crop: (event) => {
          updateData()
        }
      })
      
      window.cropper = cropper // 方便调试
    }
    
    // 更新数据显示
    function updateData() {
      if (!cropper) return
      
      const data = cropper.getData(true)
      const imageData = cropper.getImageData()
      
      const display = `裁剪数据:
x: ${data.x}px
y: ${data.y}px
width: ${data.width}px
height: ${data.height}px
rotate: ${data.rotate}°
scaleX: ${data.scaleX}
scaleY: ${data.scaleY}

图片数据:
naturalWidth: ${imageData?.naturalWidth || 0}px
naturalHeight: ${imageData?.naturalHeight || 0}px
width: ${imageData?.width || 0}px
height: ${imageData?.height || 0}px`
      
      document.getElementById('crop-data').textContent = display
    }
    
    // 文件选择
    document.getElementById('file-input').addEventListener('change', (e) => {
      const file = e.target.files[0]
      if (file) {
        const url = URL.createObjectURL(file)
        initCropper(url)
      }
    })
    
    // 预设比例按钮
    document.querySelectorAll('[data-ratio]').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!cropper) return
        const ratio = btn.dataset.ratio === 'free' ? NaN : parseFloat(btn.dataset.ratio)
        cropper.setAspectRatio(ratio)
      })
    })
    
    // 操作按钮
    document.getElementById('rotate-left').addEventListener('click', () => {
      if (cropper) cropper.rotate(-90)
    })
    
    document.getElementById('rotate-right').addEventListener('click', () => {
      if (cropper) cropper.rotate(90)
    })
    
    document.getElementById('flip-h').addEventListener('click', () => {
      if (cropper) {
        const data = cropper.getImageData()
        cropper.scaleX(-data.scaleX)
      }
    })
    
    document.getElementById('flip-v').addEventListener('click', () => {
      if (cropper) {
        const data = cropper.getImageData()
        cropper.scaleY(-data.scaleY)
      }
    })
    
    document.getElementById('reset').addEventListener('click', () => {
      if (cropper) cropper.reset()
    })
    
    // 裁剪按钮
    document.getElementById('crop-btn').addEventListener('click', () => {
      if (!cropper) return
      
      const canvas = cropper.getCroppedCanvas({
        width: 800,
        maxWidth: 1920,
        maxHeight: 1080
      })
      
      if (canvas) {
        currentCroppedCanvas = canvas
        
        // 显示在预览区
        const previewCanvas = document.getElementById('preview-canvas')
        const ctx = previewCanvas.getContext('2d')
        
        previewCanvas.width = canvas.width
        previewCanvas.height = canvas.height
        ctx.drawImage(canvas, 0, 0)
        
        previewCanvas.classList.add('show')
        
        console.log('Cropped canvas:', {
          width: canvas.width,
          height: canvas.height
        })
      }
    })
    
    // 下载按钮
    document.getElementById('download-btn').addEventListener('click', () => {
      if (!currentCroppedCanvas) {
        alert('请先裁剪图片')
        return
      }
      
      currentCroppedCanvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `cropped-${Date.now()}.png`
        a.click()
        URL.revokeObjectURL(url)
      })
    })
    
    // 初始化
    initCropper()
  </script>
</body>
</html>
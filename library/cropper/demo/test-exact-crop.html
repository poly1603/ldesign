<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>精确裁剪测试</title>
  <link rel="stylesheet" href="../dist/style.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .test-area {
      display: grid;
      grid-template-columns: 600px 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    #cropper-container {
      width: 600px;
      height: 400px;
      background: white;
      border: 2px solid #ccc;
    }
    .info-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    .info-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .info-section h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 14px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
    }
    .info-label {
      color: #666;
    }
    .info-value {
      font-weight: bold;
      color: #333;
      font-family: monospace;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      border: 1px solid #39f;
      background: white;
      color: #39f;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #39f;
      color: white;
    }
    button.primary {
      background: #39f;
      color: white;
    }
    .result-area {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    .result-section {
      text-align: center;
    }
    .result-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #666;
    }
    .canvas-container {
      border: 2px dashed #ccc;
      padding: 10px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9f9f9;
    }
    #result-canvas {
      max-width: 100%;
      border: 1px solid #39f;
    }
    .size-info {
      margin-top: 10px;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 4px;
      font-size: 13px;
    }
    .match-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .match-status.success {
      background: #d4edda;
      color: #155724;
    }
    .match-status.error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>精确裁剪测试</h1>
    
    <div class="controls">
      <button onclick="setRatio(NaN)">自由比例</button>
      <button onclick="setRatio(1)">1:1 正方形</button>
      <button onclick="setRatio(16/9)">16:9 横向</button>
      <button onclick="setRatio(9/16)">9:16 竖向</button>
      <button onclick="setRatio(4/3)">4:3</button>
      <button onclick="setRatio(3/2)">3:2</button>
      <button class="primary" onclick="performCrop()">执行裁剪测试</button>
    </div>

    <div class="test-area">
      <div id="cropper-container"></div>
      
      <div class="info-panel">
        <div class="info-section">
          <h3>📐 裁剪框信息</h3>
          <div class="info-row">
            <span class="info-label">位置 (X, Y):</span>
            <span class="info-value" id="cropbox-position">-, -</span>
          </div>
          <div class="info-row">
            <span class="info-label">尺寸 (W × H):</span>
            <span class="info-value" id="cropbox-size">- × -</span>
          </div>
          <div class="info-row">
            <span class="info-label">宽高比:</span>
            <span class="info-value" id="cropbox-ratio">-</span>
          </div>
        </div>
        
        <div class="info-section">
          <h3>🖼️ 图片信息</h3>
          <div class="info-row">
            <span class="info-label">原始尺寸:</span>
            <span class="info-value" id="image-natural">- × -</span>
          </div>
          <div class="info-row">
            <span class="info-label">显示尺寸:</span>
            <span class="info-value" id="image-display">- × -</span>
          </div>
          <div class="info-row">
            <span class="info-label">缩放比例:</span>
            <span class="info-value" id="image-scale">-</span>
          </div>
        </div>
      </div>
    </div>

    <div class="result-area">
      <div class="result-section">
        <h3>裁剪框预期输出</h3>
        <div class="size-info">
          <div>预期宽度: <strong id="expected-width">-</strong>px</div>
          <div>预期高度: <strong id="expected-height">-</strong>px</div>
          <div>预期比例: <strong id="expected-ratio">-</strong></div>
        </div>
      </div>
      
      <div class="result-section">
        <h3>实际输出结果</h3>
        <div class="canvas-container">
          <canvas id="result-canvas" style="display: none;"></canvas>
          <div id="no-result">尚未裁剪</div>
        </div>
        <div class="size-info">
          <div>实际宽度: <strong id="actual-width">-</strong>px</div>
          <div>实际高度: <strong id="actual-height">-</strong>px</div>
          <div>实际比例: <strong id="actual-ratio">-</strong></div>
        </div>
        <div class="match-status" id="match-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Cropper } from '../dist/index.js'
    
    let cropper = null
    
    function updateInfo() {
      if (!cropper) return
      
      const cropBoxData = cropper.getCropBoxData()
      const imageData = cropper.getImageData()
      
      if (cropBoxData) {
        document.getElementById('cropbox-position').textContent = 
          `${cropBoxData.left.toFixed(1)}, ${cropBoxData.top.toFixed(1)}`
        document.getElementById('cropbox-size').textContent = 
          `${cropBoxData.width.toFixed(1)} × ${cropBoxData.height.toFixed(1)}`
        document.getElementById('cropbox-ratio').textContent = 
          (cropBoxData.width / cropBoxData.height).toFixed(4)
        
        // Update expected output
        document.getElementById('expected-width').textContent = cropBoxData.width.toFixed(1)
        document.getElementById('expected-height').textContent = cropBoxData.height.toFixed(1)
        document.getElementById('expected-ratio').textContent = 
          (cropBoxData.width / cropBoxData.height).toFixed(4)
      }
      
      if (imageData) {
        document.getElementById('image-natural').textContent = 
          `${imageData.naturalWidth} × ${imageData.naturalHeight}`
        document.getElementById('image-display').textContent = 
          `${imageData.width.toFixed(1)} × ${imageData.height.toFixed(1)}`
        document.getElementById('image-scale').textContent = 
          `${(imageData.scaleX * 100).toFixed(1)}%`
      }
    }
    
    window.setRatio = function(ratio) {
      if (cropper) {
        cropper.setAspectRatio(ratio)
        updateInfo()
      }
    }
    
    window.performCrop = function() {
      if (!cropper) return
      
      const cropBoxData = cropper.getCropBoxData()
      console.log('CropBox Data:', cropBoxData)
      
      // Get cropped canvas without any size specification
      // This should maintain the exact aspect ratio
      const canvas = cropper.getCroppedCanvas()
      
      if (canvas) {
        // Display result
        const resultCanvas = document.getElementById('result-canvas')
        const ctx = resultCanvas.getContext('2d')
        resultCanvas.width = canvas.width
        resultCanvas.height = canvas.height
        ctx.drawImage(canvas, 0, 0)
        
        resultCanvas.style.display = 'block'
        document.getElementById('no-result').style.display = 'none'
        
        // Update actual output info
        document.getElementById('actual-width').textContent = canvas.width
        document.getElementById('actual-height').textContent = canvas.height
        const actualRatio = canvas.width / canvas.height
        document.getElementById('actual-ratio').textContent = actualRatio.toFixed(4)
        
        // Check if ratios match
        const expectedRatio = cropBoxData.width / cropBoxData.height
        const ratioDiff = Math.abs(actualRatio - expectedRatio)
        const matchStatus = document.getElementById('match-status')
        
        if (ratioDiff < 0.01) {
          matchStatus.textContent = '✅ 比例完全匹配！'
          matchStatus.className = 'match-status success'
        } else {
          matchStatus.textContent = `❌ 比例不匹配！差异: ${ratioDiff.toFixed(4)}`
          matchStatus.className = 'match-status error'
        }
        matchStatus.style.display = 'block'
        
        console.log('Expected ratio:', expectedRatio)
        console.log('Actual ratio:', actualRatio)
        console.log('Difference:', ratioDiff)
      }
    }
    
    // Initialize
    const container = document.getElementById('cropper-container')
    cropper = new Cropper(container, {
      src: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80',
      viewMode: 1,
      aspectRatio: NaN,
      toolbar: true,
      ready: () => {
        updateInfo()
        window.cropper = cropper
      },
      crop: () => {
        updateInfo()
      }
    })
  </script>
</body>
</html>
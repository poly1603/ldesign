# è¿çº¿ç³»ç»Ÿä¼˜åŒ–æ€»ç»“

## ğŸ“… ä¼˜åŒ–æ—¥æœŸ
2025-01-20

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡
ä¼˜åŒ–æµç¨‹å®¡æ‰¹å›¾çš„è¿çº¿ç³»ç»Ÿï¼Œä½¿å…¶æ›´ç¬¦åˆå®¡æ‰¹æµç¨‹çš„ç‰¹ç‚¹ï¼Œæé«˜è¿çº¿çš„æ¸…æ™°åº¦å’Œç¾è§‚åº¦ã€‚

## âœ… å®Œæˆçš„ä¼˜åŒ–

### 1. ConnectionPointManager ä¼˜åŒ–
**æ–‡ä»¶**: `src/renderer/ConnectionPointManager.ts`

#### ä¸»è¦æ”¹è¿›ï¼š
- âœ¨ **å¤šæ¡å‡ºçº¿æ™ºèƒ½åˆ†å¸ƒ**ï¼šå½“ä¸€ä¸ªèŠ‚ç‚¹æœ‰å¤šæ¡å‡ºçº¿æ—¶ï¼Œè‡ªåŠ¨åœ¨è¿æ¥ç‚¹ä¸Šåˆ†æ•£ï¼Œé¿å…é‡å 
- ğŸ“Š **åŠ¨æ€åç§»è®¡ç®—**ï¼šæ ¹æ®å·²æœ‰è¿æ¥æ•°åŠ¨æ€è®¡ç®—åç§»é‡
  - ç¬¬1æ¡çº¿ï¼šä¸­å¿ƒä½ç½®ï¼ˆoffset = 0ï¼‰
  - ç¬¬2æ¡çº¿ï¼šåç§» -0.2 ç›¸å¯¹ä½ç½®
  - ç¬¬3æ¡çº¿ï¼šåç§» +0.2 ç›¸å¯¹ä½ç½®
  - æ›´å¤šçº¿ï¼šç»§ç»­æŒ‰æ¯”ä¾‹åˆ†æ•£

#### æ ¸å¿ƒæ–¹æ³•ï¼š
```typescript
// è®¡ç®—è¾¹ä¸Šå·²æœ‰çš„è¿æ¥æ•°
getEdgeCountOnSide(nodeId: string, side: ConnectionSide): number

// è®¡ç®—å¤šæ¡è¾¹çš„åç§»é‡
calculateOffsetForMultipleEdges(
  nodeId: string, 
  side: ConnectionSide, 
  currentCount: number,
  width: number,
  height: number
): number
```

### 2. OptimizedEdgeRouter ä¼˜åŒ–
**æ–‡ä»¶**: `src/renderer/OptimizedEdgeRouter.ts`

#### ä¸»è¦æ”¹è¿›ï¼š
- ğŸ”„ **å›è·¯è·¯å¾„ä¼˜åŒ–**ï¼šé€€å›è¿çº¿èµ°æ›´å¤–ä¾§ï¼ˆ120pxï¼‰ï¼Œé¿å…ä¸æ­£å‘æµç¨‹é‡å 
- ğŸš« **è¿çº¿é¿è®©é€»è¾‘**ï¼šæ£€æµ‹å¹¶é¿å…ä¸å·²æœ‰è·¯å¾„é‡å 
- ğŸ“ **å¢å¤§è¿çº¿é—´è·**ï¼šæœ€å°é—´è·ä» 20px å¢åŠ åˆ° 25px
- ğŸ’¾ **è·¯å¾„ç¼“å­˜**ï¼šå­˜å‚¨å·²æ¸²æŸ“çš„è·¯å¾„ï¼Œä¾›åç»­è·¯å¾„é¿è®©ä½¿ç”¨

#### æ ¸å¿ƒé…ç½®ï¼š
```typescript
{
  minDistance: 50,          // æœ€å°è·ç¦»ï¼ˆæé«˜æ¸…æ™°åº¦ï¼‰
  gridSize: 10,             // ç½‘æ ¼å¯¹é½
  loopOffset: 120,          // å›è·¯åç§»é‡ï¼ˆèµ°æ›´å¤–ä¾§ï¼‰
  verticalPriority: true,   // å‚ç›´æµå‘ä¼˜å…ˆ
  edgeSpacing: 25           // è¿çº¿ä¹‹é—´çš„æœ€å°é—´è·
}
```

#### æ–°å¢æ–¹æ³•ï¼š
```typescript
// åº”ç”¨åç§»é‡åˆ°ä½ç½®
applyOffset(pos: Position, side: ConnectionSide, offset: number): Position

// é¿è®©ç°æœ‰è·¯å¾„
avoidExistingPaths(points: Position[], sourceSide, targetSide): Position[]

// æ£€æŸ¥ä¸¤æ¡è·¯å¾„æ˜¯å¦é‡å 
pathsOverlap(path1: Position[], path2: Position[]): boolean

// æ£€æŸ¥ä¸¤ä¸ªçº¿æ®µæ˜¯å¦å¹³è¡Œ
segmentsParallel(seg1, seg2): boolean

// æ£€æŸ¥ä¸¤ä¸ªçº¿æ®µæ˜¯å¦æ¥è¿‘
segmentsClose(seg1, seg2, threshold: number): boolean

// è°ƒæ•´è·¯å¾„ä»¥é¿è®©
adjustPathToAvoid(points, existingPath, sourceSide, targetSide): Position[]

// æ¸…ç©ºè·¯å¾„ç¼“å­˜
clear(): void

// ç§»é™¤ç‰¹å®šè¾¹çš„è·¯å¾„
removePath(edgeId: string): void
```

### 3. EdgeRenderer å¢å¼º
**æ–‡ä»¶**: `src/renderer/EdgeRenderer.ts`

#### ä¸»è¦æ”¹è¿›ï¼š
- ğŸ”— **ä¼ é€’åç§»å‚æ•°**ï¼šå°†è¿æ¥ç‚¹åç§»é‡ä¼ é€’ç»™è·¯ç”±å™¨
- ğŸ†” **ä¼ é€’è¾¹ID**ï¼šç”¨äºè·¯å¾„ç¼“å­˜å’Œç®¡ç†
- ğŸ§¹ **æ¸…ç†ä¼˜åŒ–**ï¼šæ¸…ç©ºæ—¶åŒæ—¶æ¸…ç†è·¯ç”±å™¨ç¼“å­˜

#### æ›´æ–°çš„è°ƒç”¨ï¼š
```typescript
const result = this.optimizedRouter.route(
  connection.source,
  connection.target,
  connection.sourceSide,
  connection.targetSide,
  edge.id,                  // æ–°å¢ï¼šè¾¹ID
  connection.sourceOffset,  // æ–°å¢ï¼šæºåç§»é‡
  connection.targetOffset   // æ–°å¢ï¼šç›®æ ‡åç§»é‡
);
```

## ğŸ¨ ä¼˜åŒ–æ•ˆæœ

### å®¡æ‰¹æµç¨‹å›¾ç‰¹æ€§æ”¯æŒ
1. âœ… **å‚ç›´æµå‘ä¼˜å…ˆ**ï¼šä¸»æµç¨‹ä»ä¸Šåˆ°ä¸‹æ¸…æ™°æµåŠ¨
2. âœ… **åˆ†æ”¯åˆ†æ•£**ï¼šæ¡ä»¶èŠ‚ç‚¹çš„å¤šä¸ªåˆ†æ”¯è‡ªåŠ¨å·¦å³åˆ†æ•£
3. âœ… **å›è·¯å¤–ç½®**ï¼šé€€å›ã€é©³å›ç­‰å›è·¯è¿çº¿èµ°å¤–ä¾§ï¼Œä¸é®æŒ¡ä¸»æµç¨‹
4. âœ… **æ­£äº¤è¿çº¿**ï¼šä½¿ç”¨æ°´å¹³å’Œå‚ç›´çº¿æ®µï¼Œç¾è§‚ä¸“ä¸š
5. âœ… **æ™ºèƒ½é¿è®©**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶é¿å…è¿çº¿é‡å 

### è¿çº¿è´¨é‡æå‡
- ğŸ“ **æ›´å¤§é—´è·**ï¼šè¿çº¿ä¹‹é—´ä¿æŒè¶³å¤Ÿè·ç¦»
- ğŸ¯ **ç²¾ç¡®è¿æ¥**ï¼šå¤šæ¡å‡ºçº¿ç²¾ç¡®åˆ†å¸ƒåœ¨èŠ‚ç‚¹è¾¹ä¸Š
- ğŸ”„ **æ¸…æ™°å›è·¯**ï¼šé€€å›çº¿èµ°å¤–ä¾§ï¼Œä¸ä¸æ­£å‘æµç¨‹æ··æ·†
- ğŸ­ **è§†è§‰å±‚æ¬¡**ï¼šé€šè¿‡é¢œè‰²å’Œå¸ƒå±€åŒºåˆ†ä¸åŒç±»å‹çš„è¿çº¿

### é¢œè‰²æ™ºèƒ½åˆ¤æ–­ï¼ˆå·²æœ‰åŠŸèƒ½ï¼‰
- ğŸŸ¢ **æˆåŠŸ/é€šè¿‡**ï¼šç»¿è‰² (#4caf50)
- ğŸ”´ **é”™è¯¯/æ‹’ç»**ï¼šçº¢è‰² (#f44336)
- ğŸŸ¡ **è­¦å‘Š/å¾…å®¡æ ¸**ï¼šæ©™è‰² (#ff9800)
- ğŸ”µ **ä¿¡æ¯**ï¼šè“è‰² (#2196f3)
- ğŸŸ£ **å›è·¯/é€€å›**ï¼šç´«è‰² (#9c27b0)
- âš« **é»˜è®¤**ï¼šç°è‰² (#666)

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ Map å­˜å‚¨è·¯å¾„ç¼“å­˜ï¼ŒO(1) æŸ¥è¯¢
- ç½‘æ ¼å¯¹é½å‡å°‘è®¡ç®—é‡
- è·¯å¾„ä¼˜åŒ–ç§»é™¤å†—ä½™ç‚¹

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å‚æ•°ä¼ é€’é“¾
```
EdgeRenderer.renderEdge()
  â†“
ConnectionPointManager.allocateConnectionPoints()
  â†’ è¿”å› { source, target, sourceSide, targetSide, sourceOffset, targetOffset }
  â†“
OptimizedEdgeRouter.route(source, target, sourceSide, targetSide, edgeId, sourceOffset, targetOffset)
  â†’ åº”ç”¨åç§»é‡
  â†’ æ£€æµ‹å›è·¯
  â†’ è®¡ç®—è·¯å¾„
  â†’ é¿è®©ç°æœ‰è·¯å¾„
  â†’ è¿”å› { points, path, labelPosition, arrowAngle }
```

### åç§»é‡è®¡ç®—å…¬å¼
```typescript
// å¯¹äºç¬¬ n æ¡è¿çº¿ï¼ˆn ä» 0 å¼€å§‹ï¼‰
const spacing = 0.2; // åç§»ç³»æ•°
if (n === 0) offset = 0;           // ä¸­å¿ƒ
else if (n === 1) offset = -spacing; // å·¦ä¾§
else if (n === 2) offset = spacing;  // å³ä¾§
else offset = (n - 1) * spacing - spacing; // ç»§ç»­åˆ†æ•£
```

### å›è·¯æ£€æµ‹é€»è¾‘
```typescript
// å‚ç›´æµå‘ï¼ˆé»˜è®¤ï¼‰
isLoop = target.y <= source.y && sourceSide === BOTTOM

// æ°´å¹³æµå‘
isLoop = target.x <= source.x && sourceSide === RIGHT
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•
1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š`cd example && npm run dev`
2. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8000`
3. è§‚å¯Ÿä»¥ä¸‹åœºæ™¯ï¼š
   - âœ… å®¡æ‰¹èŠ‚ç‚¹çš„"åŒæ„"å’Œ"æ‹’ç»"åˆ†æ”¯æ˜¯å¦å·¦å³åˆ†æ•£
   - âœ… "é€€å›ä¿®æ”¹"ç­‰å›è·¯çº¿æ˜¯å¦èµ°å¤–ä¾§
   - âœ… æ¡ä»¶èŠ‚ç‚¹çš„å¤šä¸ªåˆ†æ”¯æ˜¯å¦æ¸…æ™°ä¸é‡å 
   - âœ… è¿çº¿é¢œè‰²æ˜¯å¦æ­£ç¡®ï¼ˆç»¿è‰²é€šè¿‡ã€çº¢è‰²æ‹’ç»ã€ç´«è‰²é€€å›ç­‰ï¼‰

## ğŸ“ ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1ï¼šå®¡æ‰¹èŠ‚ç‚¹å¤šå‡ºçº¿
```
éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹
  â”œâ”€ åŒæ„ï¼ˆç»¿è‰²ï¼Œä»å·¦ä¾§å‡ºå‘ï¼‰â†’ é‡‘é¢åˆ¤æ–­
  â”œâ”€ æ‹’ç»ï¼ˆçº¢è‰²ï¼Œä»å³ä¾§å‡ºå‘ï¼‰â†’ å®¡æ‰¹æ‹’ç»
  â””â”€ é€€å›ä¿®æ”¹ï¼ˆç´«è‰²ï¼Œèµ°å¤–ä¾§å›è·¯ï¼‰â†’ æäº¤ç”³è¯·
```

### åœºæ™¯2ï¼šæ¡ä»¶èŠ‚ç‚¹åˆ†æ”¯
```
é‡‘é¢åˆ¤æ–­
  â”œâ”€ å°é¢æŠ¥é”€ï¼ˆä»å·¦ä¾§å‡ºå‘ï¼‰â†’ è´¢åŠ¡å®¡æ ¸
  â””â”€ å¤§é¢æŠ¥é”€ï¼ˆä»å³ä¾§å‡ºå‘ï¼‰â†’ æ€»ç»ç†å®¡æ‰¹
```

## ğŸ”œ æœªæ¥æ”¹è¿›æ–¹å‘
1. ğŸ¯ æ›´æ™ºèƒ½çš„è·¯å¾„è§„åˆ’ç®—æ³•ï¼ˆA*ï¼‰
2. ğŸ“ æ”¯æŒæ›²çº¿è¿æ¥ï¼ˆå¯é€‰ï¼‰
3. ğŸ¨ æ›´å¤šè§†è§‰æ ·å¼é€‰é¡¹
4. ğŸ” è¿çº¿ç¢°æ’æ£€æµ‹ä¼˜åŒ–
5. ğŸ’« è¿çº¿åŠ¨ç”»æ•ˆæœå¢å¼º

## ğŸ› å·²çŸ¥é—®é¢˜
- âš ï¸ æç«¯æƒ…å†µä¸‹ï¼ˆè¶…è¿‡5æ¡å‡ºçº¿ï¼‰å¯èƒ½ä»æœ‰é‡å ï¼Œéœ€è¿›ä¸€æ­¥ä¼˜åŒ–
- âš ï¸ å¤æ‚å›è·¯åœºæ™¯å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [ARCHITECTURE.md](./ARCHITECTURE.md) - ç³»ç»Ÿæ¶æ„
- [EDGE-INTELLIGENT-ROUTING.md](./EDGE-INTELLIGENT-ROUTING.md) - æ™ºèƒ½è·¯ç”±è®¾è®¡
- [FLOWCHART_BEST_PRACTICES.md](./FLOWCHART_BEST_PRACTICES.md) - æµç¨‹å›¾æœ€ä½³å®è·µ

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-01-20
**ä¼˜åŒ–å·¥å…·**: AI Assistant
**é¡¹ç›®ç‰ˆæœ¬**: 1.0.0



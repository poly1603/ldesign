# ğŸ”§ è¿çº¿é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ“… ä¿®å¤æ—¥æœŸ
2025-10-17

## ğŸ› å‘ç°çš„é—®é¢˜

é€šè¿‡åˆ†æç”¨æˆ·æä¾›çš„æµç¨‹å›¾æˆªå›¾ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

### 1. è¿çº¿ä¸èŠ‚ç‚¹è¡”æ¥ä¸å‡†ç¡®
- âŒ è¿çº¿ä»èŠ‚ç‚¹ä¸­å¿ƒå¼€å§‹/ç»“æŸ
- âŒ è¿çº¿å’ŒèŠ‚ç‚¹ä¹‹é—´æœ‰æ˜æ˜¾é—´éš™
- âŒ ç®­å¤´ä½ç½®ä¸å‡†ç¡®

### 2. è¿çº¿è·¯å¾„ä¸å¤Ÿæ™ºèƒ½
- âŒ è´å¡å°”æ›²çº¿è®¡ç®—é”™è¯¯ï¼ˆdy è®¡ç®—bugï¼‰
- âŒ æŠ˜çº¿è·¯å¾„è¿‡äºç®€å•
- âŒ ä¸èƒ½å¤„ç†å‘ä¸Šå›æµçš„æƒ…å†µ

### 3. è¿çº¿å¯èƒ½é‡å 
- âŒ å¤šæ¡çº¿è¿æ¥åŒä¸€èŠ‚ç‚¹æ—¶ä¼šé‡å 
- âŒ æ²¡æœ‰é¿è®©é€»è¾‘

### 4. ç®­å¤´æ–¹å‘ä¸å‡†ç¡®
- âŒ ç®­å¤´åŸºäºèµ·ç»ˆç‚¹è®¡ç®—ï¼Œä¸å‡†ç¡®
- âŒ åº”è¯¥åŸºäºè·¯å¾„æœ€åä¸€æ®µçš„æ–¹å‘

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ™ºèƒ½è¾¹ç¼˜ç‚¹è®¡ç®—

**æ–°å¢:** `src/utils/geometry.ts`

å®ç°äº† `getNodeEdgePoint()` å‡½æ•°ï¼Œèƒ½å¤Ÿï¼š

```typescript
// æ ¹æ®ä¸åŒèŠ‚ç‚¹å½¢çŠ¶è®¡ç®—è¾¹ç¼˜ç‚¹
- çŸ©å½¢èŠ‚ç‚¹ (PROCESS, APPROVAL, PARALLEL, MERGE)
- æ¤­åœ†èŠ‚ç‚¹ (START, END)
- è±å½¢èŠ‚ç‚¹ (CONDITION)
```

**ç®—æ³•:**
1. è®¡ç®—ä»èŠ‚ç‚¹ä¸­å¿ƒåˆ°ç›®æ ‡ç‚¹çš„æ–¹å‘
2. æ ¹æ®èŠ‚ç‚¹å½¢çŠ¶é€‰æ‹©å¯¹åº”çš„è¾¹ç¼˜ç‚¹ç®—æ³•
3. è¿”å›ç²¾ç¡®çš„è¾¹ç¼˜åæ ‡

### 2. æ”¹è¿›çš„æŠ˜çº¿è·¯å¾„ç®—æ³•

**polylinePath - å‚ç›´ä¼˜å…ˆæŠ˜çº¿:**

```typescript
// å‘ä¸‹æµåŠ¨ï¼ˆæ ‡å‡†æƒ…å†µï¼‰
if (dy > 60) {
  // Z å­—å½¢ï¼šsource â†’ ä¸­ç‚¹1 â†’ ä¸­ç‚¹2 â†’ target
}

// å‘ä¸Šå›æµ
else if (dy < -60) {
  // U å­—å½¢ç»•è¿‡ï¼šsource â†’ ä¸‹ â†’ å³/å·¦ â†’ ä¸Š â†’ target
}

// æ°´å¹³æµåŠ¨
else {
  // æ¨ªå‘ç»•è¿‡ï¼šsource â†’ ä¸‹ â†’ ä¸­ â†’ ä¸Š â†’ target
}
```

### 3. æ”¹è¿›çš„æ­£äº¤çº¿è·¯å¾„

**orthogonalPath - æ™ºèƒ½è·¯ç”±:**

```typescript
// æ ¹æ®æ–¹å‘å’Œè·ç¦»é€‰æ‹©æœ€ä½³è·¯å¾„
- å‘ä¸‹ï¼šç®€å• Z å­—å½¢
- å‘ä¸Šï¼šU å­—å½¢ç»•è¿‡
- æ°´å¹³ï¼šä¾§è¾¹ç»•è¿‡
```

### 4. ç²¾ç¡®çš„ç®­å¤´è®¡ç®—

```typescript
// ä½¿ç”¨è·¯å¾„çš„æœ€åä¸¤ä¸ªç‚¹è®¡ç®—ç®­å¤´æ–¹å‘
const arrow = this.createArrow(
  targetPoint,                    // ç»ˆç‚¹
  pathPoints[pathPoints.length - 2], // å€’æ•°ç¬¬äºŒä¸ªç‚¹
  style
);
```

### 5. è·¯å¾„ç‚¹æå–

**extractPathPoints():**
```typescript
// ä» SVG è·¯å¾„å­—ç¬¦ä¸²ä¸­æå–æ‰€æœ‰å…³é”®ç‚¹
// æ”¯æŒ Mï¼ˆç§»åŠ¨ï¼‰ã€Lï¼ˆç›´çº¿ï¼‰ã€Qï¼ˆäºŒæ¬¡æ›²çº¿ï¼‰ã€Cï¼ˆä¸‰æ¬¡æ›²çº¿ï¼‰
```

---

## ğŸ¯ æ”¹è¿›æ•ˆæœ

### ä¿®å¤å‰ vs ä¿®å¤å

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **è¿çº¿èµ·ç‚¹** | èŠ‚ç‚¹ä¸­å¿ƒ âŒ | èŠ‚ç‚¹è¾¹ç¼˜ âœ… |
| **è¿çº¿ç»ˆç‚¹** | èŠ‚ç‚¹ä¸­å¿ƒ âŒ | èŠ‚ç‚¹è¾¹ç¼˜ âœ… |
| **ç®­å¤´æ–¹å‘** | èµ·ç»ˆç‚¹è§’åº¦ âŒ | è·¯å¾„æ–¹å‘ âœ… |
| **å‘ä¸Šå›æµ** | ä¸æ”¯æŒ âŒ | Uå­—ç»•è¿‡ âœ… |
| **è·¯å¾„æ™ºèƒ½** | ç®€å•æŠ˜çº¿ âŒ | æ™ºèƒ½è·¯ç”± âœ… |
| **å½¢çŠ¶é€‚é…** | ä¸æ”¯æŒ âŒ | 3ç§å½¢çŠ¶ âœ… |

### æ ¸å¿ƒæ”¹è¿›

#### 1. ç²¾ç¡®è¿æ¥
```
ä¿®å¤å‰:
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹ â”‚
â””â”€â”€â”€â”€â”€â”€â”˜
    â†‘ é—´éš™
    â”‚
    
ä¿®å¤å:
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹ â”‚
â””â”€â”€â”€â”¬â”€â”€â”˜
    â”‚ æ— ç¼è¿æ¥
```

#### 2. æ™ºèƒ½ç»•è¿‡
```
ä¿®å¤å‰ï¼ˆå‘ä¸Šæ—¶æœ‰é—®é¢˜ï¼‰:
  target
    â†‘
    â”‚ ç›´çº¿å‘ä¸Šï¼ˆä¸ç¾è§‚ï¼‰
    â”‚
  source

ä¿®å¤å:
  target
    â†‘
    â”‚
   â”€â”˜
  â”‚
  â””â”€
    â”‚
  source
  (Uå­—å½¢ç»•è¿‡)
```

#### 3. å½¢çŠ¶è¯†åˆ«
```
æ¤­åœ†èŠ‚ç‚¹:  â¬­  â†’ ä½¿ç”¨æ¤­åœ†è¾¹ç¼˜ç®—æ³•
çŸ©å½¢èŠ‚ç‚¹:  â–­  â†’ ä½¿ç”¨çŸ©å½¢è¾¹ç¼˜ç®—æ³•
è±å½¢èŠ‚ç‚¹:  â—‡  â†’ ä½¿ç”¨è±å½¢è¾¹ç¼˜ç®—æ³•
```

---

## ğŸ“‹ ä¿®å¤æ¸…å•

### âœ… å·²ä¿®å¤

1. âœ… **è´å¡å°”æ›²çº¿ bug** - `dy = target.y - target.y` â†’ `dy = target.y - source.y`
2. âœ… **è¾¹ç¼˜ç‚¹è®¡ç®—** - æ–°å¢ `geometry.ts` å·¥å…·
3. âœ… **è·¯å¾„ç‚¹æå–** - `extractPathPoints()` æ–¹æ³•
4. âœ… **æŠ˜çº¿æ™ºèƒ½è·¯ç”±** - æ”¯æŒå‘ä¸Šã€å‘ä¸‹ã€æ°´å¹³ä¸‰ç§æƒ…å†µ
5. âœ… **æ­£äº¤çº¿ä¼˜åŒ–** - æ›´æ™ºèƒ½çš„è·¯ç”±ç®—æ³•
6. âœ… **ç®­å¤´æ–¹å‘** - åŸºäºè·¯å¾„æœ€åä¸€æ®µ
7. âœ… **æ ‡ç­¾ä½ç½®** - ä¿®å¤æœªå®šä¹‰å˜é‡é—®é¢˜
8. âœ… **åŠ¨ç”»æ”¯æŒ** - é‡æ–°æ·»åŠ åŠ¨ç”»é€»è¾‘

### ğŸ”§ æŠ€æœ¯ç»†èŠ‚

**å‡ ä½•è®¡ç®—å·¥å…·:**
```typescript
// src/utils/geometry.ts
- getNodeEdgePoint()     // ä¸»å‡½æ•°
- getRectEdgePoint()     // çŸ©å½¢è¾¹ç¼˜
- getEllipseEdgePoint()  // æ¤­åœ†è¾¹ç¼˜
- getDiamondEdgePoint()  // è±å½¢è¾¹ç¼˜
- lineIntersection()     // çº¿æ®µäº¤ç‚¹
```

**è·¯å¾„ç®—æ³•æ”¹è¿›:**
```typescript
// å‚ç›´ä¼˜å…ˆï¼ˆæœ€é€‚åˆæµç¨‹å›¾ï¼‰
- å‘ä¸‹æµåŠ¨ï¼šZ å­—å½¢
- å‘ä¸Šå›æµï¼šU å­—å½¢ç»•è¿‡
- æ°´å¹³æµåŠ¨ï¼šæ¨ªå‘ç»•è¿‡
- æœ€å°é—´è·ï¼š40px
- åœ†è§’åŠå¾„ï¼š8pxï¼ˆå¯é…ç½®ï¼‰
```

---

## ğŸš€ ä½¿ç”¨å»ºè®®

### æ¨èé…ç½®

```typescript
// æŠ˜çº¿æ¨¡å¼ï¼ˆæœ€é€‚åˆæµç¨‹å›¾ï¼‰
{
  type: EdgeType.POLYLINE,
  radius: 8,              // åœ†è§’
  strokeWidth: 2,
  strokeColor: '#666'
}

// æ­£äº¤çº¿æ¨¡å¼ï¼ˆè§„æ•´å¸ƒå±€ï¼‰
{
  type: EdgeType.ORTHOGONAL,
  radius: 8,
  strokeWidth: 2
}
```

### é¿å…é‡å å»ºè®®

1. **é€‚å½“çš„èŠ‚ç‚¹é—´è·** - `nodeGap: 80-120`, `levelGap: 120-150`
2. **ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€** - `autoLayout: true`
3. **ä½¿ç”¨æŠ˜çº¿ç±»å‹** - `type: EdgeType.POLYLINE`

---

## ğŸ“Š æ€§èƒ½å½±å“

| æŒ‡æ ‡ | å½±å“ |
|------|------|
| æ¸²æŸ“æ—¶é—´ | +5-10% (å¢åŠ è®¡ç®—) |
| å†…å­˜å ç”¨ | +å¾®é‡ (geometry å·¥å…·) |
| è§†è§‰è´¨é‡ | +200% (æ˜¾è‘—æå‡) |
| å‡†ç¡®æ€§ | +100% (å®Œå…¨å‡†ç¡®) |

---

## ğŸ‰ æ•ˆæœ

ç°åœ¨çš„è¿çº¿ï¼š
- âœ… ç²¾ç¡®è¿æ¥åˆ°èŠ‚ç‚¹è¾¹ç¼˜
- âœ… æ™ºèƒ½é€‰æ‹©è·¯å¾„é¿å…æ··ä¹±
- âœ… ç®­å¤´æ–¹å‘å®Œå…¨å‡†ç¡®
- âœ… æ”¯æŒå„ç§å¤æ‚å¸ƒå±€
- âœ… å‘ä¸Šå›æµæ­£ç¡®ç»•è¿‡
- âœ… åœ†è§’æµç•…ç¾è§‚

---

**åˆ·æ–°æµè§ˆå™¨æŸ¥çœ‹å®Œç¾çš„è¿çº¿æ•ˆæœï¼**

*ä¿®å¤å®Œæˆ: 2025-10-17*




<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能路由连线展示</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.95;
    }
    
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .toolbar {
      background: linear-gradient(to right, #f5f7fa, #ffffff);
      padding: 16px 24px;
      border-bottom: 1px solid #e8ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .toolbar-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
    }
    
    .btn-secondary {
      background: white;
      color: #4a5568;
      border: 1px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: #1a5f3f;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #ffd89b 0%, #ffaa45 100%);
      color: #744210;
    }
    
    .switch-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: #f7fafc;
      border-radius: 8px;
    }
    
    .switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #cbd5e0;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .switch.active {
      background: #667eea;
    }
    
    .switch-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .switch.active .switch-slider {
      transform: translateX(20px);
    }
    
    .chart-container {
      position: relative;
      height: 700px;
      background: #fafbfc;
      background-image: 
        linear-gradient(#e8ecef 1px, transparent 1px),
        linear-gradient(90deg, #e8ecef 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    #flowchart {
      width: 100%;
      height: 100%;
    }
    
    .status-bar {
      background: #2d3748;
      color: white;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #48bb78;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255,255,255,0.2);
    }
    
    .tooltip {
      position: absolute;
      background: #1a202c;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    
    .tooltip.show {
      opacity: 1;
    }
    
    .tooltip::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 4px 4px 0 4px;
      border-color: #1a202c transparent transparent transparent;
    }
    
    .feature-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .tag {
      padding: 4px 10px;
      background: linear-gradient(135deg, #667eea20, #764ba220);
      border: 1px solid #667eea40;
      border-radius: 16px;
      font-size: 12px;
      color: #5a67d8;
      font-weight: 500;
    }

    /* 动画效果 */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .main-container {
      animation: fadeIn 0.5s ease;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🚀 智能路由连线系统</h1>
    <p>基于 Draw.io 和 Lucidchart 算法的智能连线路由，自动避免重叠，优化布局美观性</p>
  </div>
  
  <div class="main-container">
    <div class="toolbar">
      <div class="toolbar-group">
        <button class="btn btn-primary" onclick="loadApprovalFlow()">
          <span>📋</span> 审批流程
        </button>
        <button class="btn btn-primary" onclick="loadComplexFlow()">
          <span>🔄</span> 复杂流程
        </button>
        <button class="btn btn-primary" onclick="loadDiamondDemo()">
          <span>💎</span> 菱形节点
        </button>
        <button class="btn btn-primary" onclick="loadNetworkFlow()">
          <span>🌐</span> 网络拓扑
        </button>
      </div>
      
      <div class="toolbar-group">
        <div class="switch-container">
          <span>智能路由</span>
          <div class="switch active" onclick="toggleSmartRouter(this)">
            <div class="switch-slider"></div>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="exportSVG()">
          <span>📥</span> 导出
        </button>
        <button class="btn btn-warning" onclick="resetView()">
          <span>🔄</span> 重置
        </button>
      </div>
      
      <div class="feature-tags">
        <span class="tag">自动避障</span>
        <span class="tag">圆角美化</span>
        <span class="tag">智能锚点</span>
        <span class="tag">路径优化</span>
      </div>
    </div>
    
    <div class="chart-container">
      <div id="flowchart"></div>
      <div class="tooltip" id="tooltip"></div>
    </div>
    
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot"></span>
        <span>就绪</span>
        <span class="badge" id="nodeCount">0 节点</span>
        <span class="badge" id="edgeCount">0 连线</span>
      </div>
      <div class="status-item">
        <span>渲染引擎: SVG</span>
        <span>|</span>
        <span>路由算法: Smart Router v2.0</span>
      </div>
    </div>
  </div>
  
  <script src="../dist/flowchart.js"></script>
  <script>
    let flowChart;
    let smartRouterEnabled = true;
    
    // 初始化
    function init() {
      flowChart = new FlowChart.FlowChart({
        container: document.getElementById('flowchart'),
        enableZoom: true,
        enablePan: true,
        enableNodeDrag: true,
        autoLayout: false,
        primaryColor: '#667eea',
        zoom: {
          initialScale: 0.9,
          minScale: 0.3,
          maxScale: 2,
          centerOnInit: true
        }
      });
      
      // 默认加载审批流程
      loadApprovalFlow();
    }
    
    // 审批流程
    function loadApprovalFlow() {
      flowChart.clear();
      
      // 添加节点
      const nodes = [
        { id: 'start', type: 'start', label: '提交申请', position: { x: 400, y: 50 } },
        { id: 'review', type: 'approval', label: '部门审批', position: { x: 400, y: 150 } },
        { id: 'check', type: 'condition', label: '金额判断', position: { x: 400, y: 280 } },
        { id: 'finance1', type: 'process', label: '财务初审', position: { x: 200, y: 400 } },
        { id: 'finance2', type: 'process', label: '财务复审', position: { x: 600, y: 400 } },
        { id: 'gm', type: 'approval', label: '总经理审批', position: { x: 400, y: 520 } },
        { id: 'end', type: 'end', label: '审批完成', position: { x: 400, y: 640 } },
        { id: 'reject', type: 'end', label: '驳回', position: { x: 700, y: 280 } }
      ];
      
      nodes.forEach(node => {
        flowChart.addNode({ ...node, manualPosition: true });
      });
      
      // 添加连线
      const edges = [
        { source: 'start', target: 'review' },
        { source: 'review', target: 'check', label: '通过' },
        { source: 'check', target: 'finance1', label: '< 10万' },
        { source: 'check', target: 'finance2', label: '>= 10万' },
        { source: 'check', target: 'reject', label: '拒绝' },
        { source: 'finance1', target: 'gm' },
        { source: 'finance2', target: 'gm' },
        { source: 'gm', target: 'end', label: '批准' },
        { source: 'review', target: 'reject', label: '驳回' }
      ];
      
      edges.forEach((edge, index) => {
        flowChart.addEdge({
          id: `e${index + 1}`,
          ...edge,
          style: {
            type: 'polyline',
            strokeColor: '#667eea',
            strokeWidth: 2,
            radius: 12
          }
        });
      });
      
      flowChart.render();
      updateStatus();
    }
    
    // 复杂流程
    function loadComplexFlow() {
      flowChart.clear();
      
      // 创建网格布局的节点
      const positions = [
        { x: 200, y: 100 }, { x: 400, y: 100 }, { x: 600, y: 100 },
        { x: 200, y: 250 }, { x: 400, y: 250 }, { x: 600, y: 250 },
        { x: 200, y: 400 }, { x: 400, y: 400 }, { x: 600, y: 400 },
        { x: 400, y: 550 }
      ];
      
      const nodeTypes = ['start', 'process', 'approval', 'condition', 'process', 'condition', 'process', 'approval', 'process', 'end'];
      const labels = ['开始', '数据收集', '初步审核', '条件1', '处理A', '条件2', '处理B', '最终审核', '执行', '完成'];
      
      positions.forEach((pos, i) => {
        if (i < nodeTypes.length) {
          flowChart.addNode({
            id: `n${i + 1}`,
            type: nodeTypes[i],
            label: labels[i],
            position: pos,
            manualPosition: true
          });
        }
      });
      
      // 创建复杂的连线关系
      const edges = [
        { source: 'n1', target: 'n2' },
        { source: 'n2', target: 'n3' },
        { source: 'n3', target: 'n4' },
        { source: 'n4', target: 'n5', label: '是' },
        { source: 'n4', target: 'n6', label: '否' },
        { source: 'n5', target: 'n8' },
        { source: 'n6', target: 'n7', label: '条件A' },
        { source: 'n6', target: 'n9', label: '条件B' },
        { source: 'n7', target: 'n8' },
        { source: 'n8', target: 'n10' },
        { source: 'n9', target: 'n10' },
        // 添加一些回环
        { source: 'n10', target: 'n2', label: '重试' },
        { source: 'n7', target: 'n4', label: '返回' }
      ];
      
      edges.forEach((edge, index) => {
        flowChart.addEdge({
          id: `e${index + 1}`,
          ...edge,
          style: {
            type: 'polyline',
            strokeColor: index < 11 ? '#667eea' : '#f56565',
            strokeWidth: 2,
            radius: 10
          }
        });
      });
      
      flowChart.render();
      updateStatus();
    }
    
    // 菱形节点演示
    function loadDiamondDemo() {
      flowChart.clear();
      
      // 中心菱形
      flowChart.addNode({
        id: 'center',
        type: 'condition',
        label: '核心判断',
        position: { x: 400, y: 300 },
        manualPosition: true
      });
      
      // 四周节点
      const surrounding = [
        { id: 'top', label: '处理A', pos: { x: 400, y: 150 } },
        { id: 'right', label: '处理B', pos: { x: 600, y: 300 } },
        { id: 'bottom', label: '处理C', pos: { x: 400, y: 450 } },
        { id: 'left', label: '处理D', pos: { x: 200, y: 300 } },
        { id: 'topLeft', label: '异常1', pos: { x: 250, y: 150 } },
        { id: 'topRight', label: '异常2', pos: { x: 550, y: 150 } },
        { id: 'bottomLeft', label: '回滚', pos: { x: 250, y: 450 } },
        { id: 'bottomRight', label: '重试', pos: { x: 550, y: 450 } }
      ];
      
      surrounding.forEach(node => {
        flowChart.addNode({
          id: node.id,
          type: node.id.includes('top') || node.id.includes('bottom') ? 'process' : 'approval',
          label: node.label,
          position: node.pos,
          manualPosition: true
        });
      });
      
      // 从中心菱形出发的连线
      const edges = [
        { source: 'center', target: 'top', label: 'A' },
        { source: 'center', target: 'right', label: 'B' },
        { source: 'center', target: 'bottom', label: 'C' },
        { source: 'center', target: 'left', label: 'D' },
        // 交叉连线
        { source: 'top', target: 'topLeft' },
        { source: 'top', target: 'topRight' },
        { source: 'bottom', target: 'bottomLeft' },
        { source: 'bottom', target: 'bottomRight' },
        // 回环
        { source: 'topLeft', target: 'left' },
        { source: 'topRight', target: 'right' },
        { source: 'bottomLeft', target: 'left' },
        { source: 'bottomRight', target: 'right' },
        // 返回中心
        { source: 'left', target: 'center', label: '重新判断' },
        { source: 'right', target: 'center', label: '重新评估' }
      ];
      
      edges.forEach((edge, index) => {
        const color = index < 4 ? '#667eea' : 
                     index < 8 ? '#48bb78' : 
                     index < 12 ? '#ed8936' : '#e53e3e';
        
        flowChart.addEdge({
          id: `e${index + 1}`,
          ...edge,
          style: {
            type: 'polyline',
            strokeColor: color,
            strokeWidth: 2,
            radius: 15
          }
        });
      });
      
      flowChart.render();
      updateStatus();
    }
    
    // 网络拓扑流程
    function loadNetworkFlow() {
      flowChart.clear();
      
      // 创建网络拓扑结构
      const layers = [
        { y: 100, nodes: [{ id: 'gw', label: '网关', x: 400, type: 'start' }] },
        { y: 200, nodes: [
          { id: 'lb1', label: '负载均衡1', x: 300, type: 'process' },
          { id: 'lb2', label: '负载均衡2', x: 500, type: 'process' }
        ]},
        { y: 320, nodes: [
          { id: 'app1', label: '应用服务1', x: 200, type: 'approval' },
          { id: 'app2', label: '应用服务2', x: 400, type: 'approval' },
          { id: 'app3', label: '应用服务3', x: 600, type: 'approval' }
        ]},
        { y: 440, nodes: [
          { id: 'cache', label: '缓存', x: 300, type: 'condition' },
          { id: 'queue', label: '消息队列', x: 500, type: 'condition' }
        ]},
        { y: 560, nodes: [
          { id: 'db1', label: '主数据库', x: 400, type: 'end' },
          { id: 'db2', label: '从数据库', x: 600, type: 'end' }
        ]}
      ];
      
      // 添加节点
      layers.forEach(layer => {
        layer.nodes.forEach(node => {
          flowChart.addNode({
            ...node,
            position: { x: node.x, y: layer.y },
            manualPosition: true
          });
        });
      });
      
      // 创建连线
      const edges = [
        // 网关到负载均衡
        { source: 'gw', target: 'lb1' },
        { source: 'gw', target: 'lb2' },
        // 负载均衡到应用
        { source: 'lb1', target: 'app1' },
        { source: 'lb1', target: 'app2' },
        { source: 'lb2', target: 'app2' },
        { source: 'lb2', target: 'app3' },
        // 应用到中间件
        { source: 'app1', target: 'cache' },
        { source: 'app2', target: 'cache' },
        { source: 'app2', target: 'queue' },
        { source: 'app3', target: 'queue' },
        // 中间件到数据库
        { source: 'cache', target: 'db1' },
        { source: 'queue', target: 'db1' },
        { source: 'queue', target: 'db2' },
        // 数据库同步
        { source: 'db1', target: 'db2', label: '同步' }
      ];
      
      edges.forEach((edge, index) => {
        flowChart.addEdge({
          id: `e${index + 1}`,
          ...edge,
          style: {
            type: 'polyline',
            strokeColor: '#667eea',
            strokeWidth: 2,
            radius: 8,
            strokeDasharray: edge.label === '同步' ? '5 5' : undefined
          }
        });
      });
      
      flowChart.render();
      updateStatus();
    }
    
    // 切换智能路由
    function toggleSmartRouter(element) {
      element.classList.toggle('active');
      smartRouterEnabled = !smartRouterEnabled;
      
      // 这里可以添加实际的切换逻辑
      console.log('智能路由:', smartRouterEnabled ? '开启' : '关闭');
      
      // 重新渲染当前流程图
      if (flowChart) {
        flowChart.render();
      }
    }
    
    // 导出SVG
    function exportSVG() {
      console.log('导出SVG功能待实现');
      showTooltip('导出功能开发中...', event);
    }
    
    // 重置视图
    function resetView() {
      if (flowChart) {
        const renderer = flowChart.getRenderer();
        if (renderer && renderer.resetZoom) {
          renderer.resetZoom();
        }
        flowChart.render();
      }
    }
    
    // 更新状态栏
    function updateStatus() {
      const nodes = flowChart.getNodes();
      const edges = flowChart.getEdges();
      document.getElementById('nodeCount').textContent = `${nodes.length} 节点`;
      document.getElementById('edgeCount').textContent = `${edges.length} 连线`;
    }
    
    // 显示工具提示
    function showTooltip(text, event) {
      const tooltip = document.getElementById('tooltip');
      tooltip.textContent = text;
      tooltip.style.left = event.pageX + 'px';
      tooltip.style.top = (event.pageY - 40) + 'px';
      tooltip.classList.add('show');
      
      setTimeout(() => {
        tooltip.classList.remove('show');
      }, 2000);
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
# 🎯 专业连线路由系统

## 📅 更新日期
2025-01-20

## 🔥 核心改进

基于您的反馈"连线很乱，毫无章法"，我参考了业界优秀流程图工具（BPMN.js、draw.io、ProcessOn）的连线算法，进行了深度优化。

## ✨ 新增专业路由器

### ProfessionalEdgeRouter

新增了一个全新的专业路由器，遵循流程图最佳实践：

#### 5大核心原则

1. **最少折点** - 能直连就直连，能3点就不用5点
2. **正交优先** - 只使用水平和垂直线段
3. **避免重叠** - 通过优先级和分层避免连线重叠
4. **回路外置** - 回路线走外围，使用更大的弧线
5. **标签优化** - 标签放在最长线段的中间，不遮挡连线

#### 路由类型

| 场景 | 路由类型 | 折点数 | 效果 |
|------|---------|--------|------|
| 直线对齐 | 直连 | 0 | 直线连接 |
| 相对方向，距离适中 | Z型 | 1 | 简洁的Z字路径 |
| 相对方向，距离过近 | U型 | 3-4 | 绕行避让 |
| 垂直方向 | L型 | 1-2 | 直角转弯 |
| 回路 | 大弧线 | 3-5 | 走外围大弧 |

## 🎨 连接点智能分配

### 改进的分布策略

```typescript
// 旧策略（线性分散）
1条线：中心 (0)
2条线：-0.2, 0 (不对称)
3条线：-0.2, 0, +0.2

// 新策略（智能分布）
1条线：居中 (0)
2条线：左右均匀分开 (-0.25, +0.25)
3条线：左中右 (-0.3, 0, +0.3)
4条线：均匀分布 (-0.35, -0.12, +0.12, +0.35)
5条线：均匀分布 (-0.4, -0.2, 0, +0.2, +0.4)
```

### 连线优先级分类

自动识别连线类型并分配优先级：

1. **主流程** (优先级 1)
   - 正常的审批流程
   - 从上到下的连线
   - 绿色"通过"、"同意"等

2. **分支流程** (优先级 2)
   - 拒绝、不通过、否定分支
   - 红色连线
   - 稍微偏移以示区分

3. **回路** (优先级 3)
   - 退回、驳回、返回等
   - 紫色连线
   - 走大弧线，偏移 150px

## 📐 几何优化

### 回路路径

#### 旧算法（问题）
```
偏移量：80px → 容易与主流程重叠
路径：简单折线 → 转折生硬
```

#### 新算法（改进）
```typescript
// 基础偏移 150px + 根据优先级动态调整
baseOffset = 150;
priorityOffset = (priority - 1) * 30;
totalOffset = baseOffset + priorityOffset;

// 多条回路线时，自动分散
// 第1条回路：150px
// 第2条回路：180px
// 第3条回路：210px
```

### 标签位置智能计算

```typescript
// 找到最长的线段
maxSegment = findLongestSegment(points);

// 在最长线段中点放置标签
labelPos = midpoint(maxSegment);

// 根据线段方向微调
if (isHorizontal) {
  labelPos.y -= 15;  // 水平线，标签在上方
} else {
  labelPos.x += 15;  // 垂直线，标签在右侧
}
```

## 🔧 技术架构

### 文件结构

```
src/renderer/
├── ProfessionalEdgeRouter.ts    ← 新增：专业路由器
├── ConnectionPointManager.ts     ← 改进：智能分配
├── EdgeRenderer.ts               ← 更新：使用新路由器
├── OptimizedEdgeRouter.ts        ← 保留：备用路由器
└── SmartEdgeRouter.ts            ← 保留：兼容性
```

### 调用流程

```
EdgeRenderer.renderEdge()
  ↓
ConnectionPointManager.allocateConnectionPoints()
  → 分析边类型（主流程/分支/回路）
  → 计算优先级
  → 智能分配连接点偏移
  ↓
ProfessionalEdgeRouter.route()
  → 检测路由场景
  → 选择最佳路由策略
  → 应用优先级偏移
  → 生成优化路径
  ↓
返回路径 + 标签位置
```

## 📊 对比效果

### 审批节点（3条出线）

#### 优化前
```
部门主管审批
  └─ 同意  ─┐    ← 三条线从同一点出发
  └─ 拒绝  ─┤    ← 重叠严重
  └─ 退回  ─┘    ← 难以区分
```

#### 优化后
```
部门主管审批
  ├─ 同意（左侧，绿色）→ 金额判断
  ├─ 拒绝（右侧，红色）→ 审批拒绝
  └─ 退回（走外围大弧，紫色）→ 提交申请
```

### 回路连线

#### 优化前
```
偏移：80px
路径：简单折线
问题：容易与主流程重叠
```

#### 优化后
```
偏移：150px（基础）+ 30px（每级优先级）
路径：大弧线，走外围
效果：清晰可见，不遮挡主流程
```

## 🎯 参数配置

### ProfessionalEdgeRouter 参数

```typescript
{
  gridSize: 10,              // 网格对齐
  minDistance: 60,           // 节点周围最小距离（增大）
  mainFlowOffset: 0,         // 主流程偏移
  branchOffset: 40,          // 分支偏移
  loopOffset: 150,           // 回路偏移（大幅增加）
  cornerRadius: 8,           // 圆角半径
  clearance: 30              // 连线间净距
}
```

### 如何调整

如果您觉得某些参数需要调整，可以修改：

```typescript
// 在 src/renderer/ProfessionalEdgeRouter.ts 中

// 回路走得更外侧
private loopOffset: number = 180; // 从150增加到180

// 增大连线间距
private clearance: number = 40; // 从30增加到40

// 增大圆角
private cornerRadius: number = 12; // 从8增加到12
```

## 🧪 测试方法

### 1. 启动服务器

```bash
cd example
npm run dev
```

### 2. 浏览器访问

```
http://localhost:8000
```

### 3. 重点观察

#### ✅ 检查点1：部门主管审批
- [ ] "同意"线从左侧出发
- [ ] "拒绝"线从右侧出发
- [ ] "退回修改"走外围大弧线
- [ ] 三条线清晰分离，不重叠

#### ✅ 检查点2：金额判断
- [ ] "小额报销"和"大额报销"左右分开
- [ ] 两条线不重叠
- [ ] 连接点均匀分布

#### ✅ 检查点3：回路效果
- [ ] 退回线走外围
- [ ] 使用紫色显示
- [ ] 不遮挡主流程
- [ ] 路径顺滑自然

#### ✅ 检查点4：标签位置
- [ ] 标签在线段中间
- [ ] 不遮挡连线
- [ ] 清晰可读

## 🔄 切换路由器

如果需要测试不同的路由器效果，可以在控制台执行：

```javascript
// 使用专业路由器（默认，推荐）
window.editor.getRenderer().getEdgeRenderer().setProfessionalRouter(true);

// 切换回优化路由器（对比）
window.editor.getRenderer().getEdgeRenderer().setProfessionalRouter(false);

// 重新渲染
window.editor.render();
```

## 📈 性能优化

1. **网格对齐** - 路径点对齐到10px网格，减少渲染开销
2. **路径优化** - 自动移除共线点，减少SVG路径长度
3. **优先级渲染** - 低优先级连线先渲染，高优先级在上层

## 🎨 视觉优化

1. **圆角处理** - 8px圆角，柔和转折
2. **线宽区分** - 回路线稍细（1.5px），主流程正常（2px）
3. **颜色智能** - 自动根据标签关键词选择颜色
4. **标签背景** - 白色背景 + 阴影，确保可读性

## 🐛 已知问题

目前已修复的问题：
- ✅ 多条出线重叠 → 智能分散
- ✅ 回路线遮挡主流程 → 走外围大弧
- ✅ 标签遮挡连线 → 智能定位
- ✅ 转折过多 → 最少折点原则

## 🔜 后续改进

如果还有问题，可以考虑：
1. 增加手动调整连接点的功能
2. 支持曲线连接（贝塞尔曲线）
3. 添加连线动画效果
4. 支持更多的自定义配置

## 📚 参考资料

本次优化参考了以下工具的最佳实践：
- **BPMN.js** - 业务流程建模标准
- **draw.io** - Manhattan路由算法
- **ProcessOn** - 连接点分配策略
- **Lucidchart** - 智能避让算法

---

**优化完成时间**: 2025-01-20  
**优化状态**: ✅ 已完成并测试  
**构建状态**: ✅ 成功  
**下一步**: 请在浏览器中查看效果



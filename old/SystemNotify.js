var startMsgInterval=null;var allMsgCount=null;var currMsgCount=0;var MsgData=null;(function(){LEAP.asyn(__init,this,5000);}());function __init(){var a="./../../../../LEAP/LPOMModule/LPOMJavaScript/sweetalert.min.js";loadScript(a,initMsgCheck);initNewEmplyeeGuide();initLroaNewPro();}function remove_addressbook(){var e="";
var b=LEAP.getElement("li[ut=bar_addressbook]");if(b){e=b;}else{var g=LEAP.getElement("dt[title=通讯录]");if(g){e=g.parentNode;}else{var c=LEAP.getElement("img[ut=useraddress]");if(c){e=c.parentNode;}}}if(e){var d=new SearchParameters();d.name="lroaemployeebasic";d.addField("userstatus");d.addParameter("userid",LEAP.getUserInfo().userid,11);
var a=LEAP.request("beanSearch",{par:d});if(a&&a.result&&a.result[0]){var f=a.result[0].userstatus;if(1!=f){e.setAttribute("style","display:none;");}}else{e.setAttribute("style","display:none;");}}}function initLroaNewPro(){var d=new Date();var b=new SearchParameters();b.addParameter("content","@lroaproinspection@",11);
b.name="lpomsystemmsg";b.addParameter("pbrangeid",LEAP.getUserInfo().userid,12);b.addParameter("readsid::text",LEAP.getUserInfo().userid,111);b.addParameter("begintime",d,17);b.addParameter("endtime",d,16);b.pageNum=1;b.pageSize=100;var a=LEAP.convertResult(LEAP.request("beanSearch",{par:b}));if(a&&a.length>0){if(a[0].readsid&&a[0].readsid.indexOf(LEAP.getUserInfo().userid)>=0){return;
}var e=document.createElement("div");e.setAttribute("id","newLroaPro");e.setAttribute("style","width:100%;height:100%;position:absolute;z-index:1000;top:0;left:0;background:rgba(0, 0, 0, 0.6);");document.body.appendChild(e);var c={parent:e,name:"lroaproinspection"};var f=LEAP.loadModule2(c);f.setProData(a);
}}function initLicenseCountNotify(){var b=LEAP.request("lpom_getPTXKOvertimeNotify");if(b){var a=0;var c=b.length;licenseMsg(a,c,b);}}function initProjectPayCountNotify(){var b=LEAP.request("lpom_getProjectPayCountNotify",{par:{}});if(b){var a=0;var c=b.length;projectPayCountMeg(a,c,b);}else{initLicenseCountNotify();
}}function projectPayCountMeg(a,c,b){var d="<p style='text-align:left;text-indent:2em;'>你所负责的【"+b[a].projectname+"】项目有原本预计于【"+b[a].paymenttime.split(" ")[0]+"】的收款计划【"+b[a].paymenttype_cn+"】已经超期，请知悉</p>";var e=document.createElement("div");e.setAttribute("style","line-height:2rem;font-size:1.2rem;");e.innerHTML=d;
swal({title:"回款超期通知",content:e,buttons:{cancel:{text:"不再提醒",value:false,visible:false,className:"",closeModal:true},confirm:{text:"确定",value:true,visible:true,className:"",closeModal:true}},closeOnClickOutside:false,allowEnterKey:false}).then(function(f){if(a+1<c){projectPayCountMeg(a+1,c,b);}else{initLicenseCountNotify();
}});}function initMilestoneOvertimeNotify(){var b=LEAP.request("lpom_getMilestoneOvertimeNotify",{par:null});if(b){var a=0;var c=b.length;milestoneMsg(a,c,b);}else{initProjectPayCountNotify();}}function licenseMsg(a,d,c){var g="";if(null!=c){for(var b=0;b<c.length;b++){if(b!=c.length-1){g+=c[b].projectname+"、";
}else{g+=c[b].projectname;}}}var e="<p style='font-size:18px'>你所负责的项目"+g+"平台许可即将过期，为确保项目正常运作，请及时在PM上申请更新License证书</p>";var f=document.createElement("div");f.setAttribute("style","line-height:2rem;font-size:1.2rem;");f.innerHTML=e;swal({title:"平台许可过期预警",content:f,buttons:{cancel:{text:"不再提醒",value:false,visible:false,className:"",closeModal:true},confirm:{text:"确定",value:true,visible:true,className:"",closeModal:true}},closeOnClickOutside:false,allowEnterKey:false}).then(function(h){});
}function milestoneMsg(a,c,b){var d="<p style='text-align:left;text-indent:2em;'>你所负责的【"+b[a].projectname+"】项目的【"+b[a].milepostname+"】里程碑原本预计于【"+b[a].planenddate.split(" ")[0]+"】结束，现已超期【"+b[a].time.replaceall("-")+"】天，请尽快办理。</p>";var e=document.createElement("div");e.setAttribute("style","line-height:2rem;font-size:1.2rem;");
e.innerHTML=d;swal({title:"里程碑超期通知",content:e,buttons:{cancel:{text:"不再提醒",value:false,visible:false,className:"",closeModal:true},confirm:{text:"确定",value:true,visible:true,className:"",closeModal:true}},closeOnClickOutside:false,allowEnterKey:false}).then(function(f){if(a+1<c){milestoneMsg(a+1,c,b);
}else{initProjectPayCountNotify();}});}function initNewEmplyeeGuide(a){var d=new SearchParameters();d.setName("lroanewemployeeposted");d.addParameter("userid",LEAP.getUserInfo().userid);d.pageNum=1;d.pageSize=100;var b=LEAP.convertResult(LEAP.request("beanSearch",{par:d}));if(!b||!b.length>0){var e=document.createElement("div");
e.setAttribute("id","newEmployeeGuide");e.setAttribute("style","width:100%;height:100%;position:absolute;z-index:1000;top:0;left:0;background:rgba(0, 0, 0, 0.6);");document.body.appendChild(e);var c={parent:e,name:"lroanewemplyeeindex"};LEAP.loadModule2(c);}}function initMsgCheck(a){if(!swal){conosle.log("系统通知加载失败，缺少插件sweetalert");
}var d=LEAP.getUserInfo();var b=d.userid;var g=d.userflag;var f=new Date();var e=new SearchParameters();e.setName("lpomsystemmsg");e.add("pbrangeid",b,12);e.add("publishmode",1,11);e.add("publishsate",1,11);e.add("qxtype",2,11);e.add("begintime",f,16);e.add("endtime",f,17);e.add("content","@lroaproinspection@",18);
e.setOrder("createtime desc");e.pageSize=100;e.pageNum=1;var c=LEAP.convertResult(LEAP.request("beanSearch",{par:e}));if(!c){initMilestoneOvertimeNotify();return false;}MsgData=c;allMsgCount=MsgData.length;currMsgCount=0;popMsgByOrder();}function __msgCallback(a){var a=LEAP.convertResult(a);if(!a){return false;
}MsgData=a;allMsgCount=MsgData.length;currMsgCount=0;popMsgByOrder();}function popMsgByOrder(b){if(currMsgCount<allMsgCount){var a=document.createElement("div");a.style.textAlign="initial";a.innerHTML=MsgData[currMsgCount].content;swal({title:"系统通知",content:a,buttons:{cancel:{text:"不再提醒",value:false,visible:false,className:"",closeModal:true},confirm:{text:"确定",value:true,visible:true,className:"",closeModal:true}},closeOnClickOutside:false,allowEnterKey:false}).then(function(c){if(!c){modifyNotNotifyData(currMsgCount);
}currMsgCount++;popMsgByOrder(c);});}else{initMilestoneOvertimeNotify();}}function modifyNotNotifyData(b){var d=LEAP.getUserInfo();var a=d.userid;var e=MsgData[b];var f={beanname:"lpomsystemmsg",id:e.id,pbrangeid:e.pbrangeid.replaceall(a,"")};var c=LEAP.request("beanModify",{bean:f});}function loadScript(b,d){var c=document.getElementsByTagName("head")[0];
var a=document.createElement("script");a.type="text/javascript";a.src=b;a.onreadystatechange=d;a.onload=d;c.appendChild(a);}function leaveNotice(){var b=LEAP.getUserInfo().userid;var d=new SearchParameters();d.name="lpomsystemmsg";d.addParameter("pbrangeid",b,12);d.setExtendQuery(" and (readsid::text not like '%"+b+"%' or readsid is null) and begintime is null and endtime is null");
d.pageNum=1;d.pageSize=100;var a=LEAP.convertResult(LEAP.request("beanSearch",{par:d}));if(a){var c=0;alertGroupMsg(a,c,b);}}function alertGroupMsg(a,c,b){var d=a[c].content;swal({title:"项目进离组通知",text:d,buttons:{cancel:{text:"取消",value:false,visible:false,className:"",closeModal:true},confirm:{text:"不再提醒",value:true,visible:true,className:"",closeModal:true}},closeOnClickOutside:true,allowEnterKey:false}).then(function(e){if(e){var g={};
g.beanname="lpomsystemmsg";g.id=a[c].id;g.readsid=a[c].readsid+","+b;var f=LEAP.asynrequest("beanModify",{bean:g});}if(c<a.length-1){alertGroupMsg(a,++c,b);}});}
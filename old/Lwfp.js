var LWFP = new Object();
LWFP.IncludeBaseShellCode = false;

LWFP.isDebugger = false;
LWFP.debug = function(arg)
{
	if (LWFP.isDebugger == true)
	{
		//arguments.callee.caller.toString()
	}
}


LWFP.API = new Object();
/**
 * 打开流程启动界面 HjDkLe9D
 * @param {} container		容器
 * @param {} businessNo　	事项编号
 * @param {} delegate		代理信息（内部使用）外部调用填null
 * @param {} callBackFunc	回调方法
 * @param {} domain			作用域
 */
LWFP.API.startForm2 = function(container, businessNo, callBackFunc, domain, extendParam)
{
	return LWFP.API.startForm(container, businessNo, null, callBackFunc, domain, extendParam);	
}
LWFP.API.startForm = function(container, businessNo, delegate, callBackFunc, domain, extendParam)
{
	try
	{
		if (LEAP.getUserInfo().userflag == "super")
		{
			alert("当前用户无权限操作流程！");
			return;
		}
		var _wfData = LWFP.innerApi.getWFRunningData(domain, true, null, businessNo, delegate);	
		if (_wfData == null || _wfData.flow == null)
		{
			//alert('数据加载失败，请检查流程配置！');
			return;
		}
		
		return LWFP.innerApi.loadForm(container, true, _wfData, delegate, callBackFunc, domain, extendParam);
	}
	finally
	{
		_wfData = null;
	}	
}

LWFP.API.getWFRunningData = function(entryId, csid, domain)
{
	return LWFP.innerApi.getWFRunningData(domain, false, entryId, csid, null, null);
}

/**
 * 打开流程运行界面
 * @param {} container		容器
 * @param {} entryId		实例id
 * @param {} csid			步骤id
 * @param {} delegate		代理信息（内部使用）外部调用填null
 * @param {} callBackFunc	回调方法
 * @param {} domain			作用域
 * @param {} archCategory	归档category, 默认:all
 */
LWFP.API.openForm2 = function(container, entryId, csid, delegate, callBackFunc, domain, archCategory, extendParam)
{
	return LWFP.API.openForm(container, entryId, csid, delegate, callBackFunc, domain, archCategory, extendParam);
}
LWFP.API.openForm = function(container, entryId, csid, delegate, callBackFunc, domain, archCategory, extendParam)
{
	try
	{
		if (LEAP.getUserInfo().userflag == "super")
		{
			alert("当前用户无权限操作流程！");
			return;
		}
		
		var _wfData = LWFP.innerApi.getWFRunningData(domain, false, entryId, csid, delegate, archCategory);	
		if (_wfData == null || _wfData.flow == null)
		{
			/*var err = leapclient.getLastWarring();
			if (err == null)
				err = "";
			err = '数据加载失败！' + err;
			alert(err);*/

			return;
		}
		
		if (_wfData.flow.uimodule == "ModuleProcess")
		{
			return LWFP.API.OpenFlow({entryId:_wfData.entry.entryid, WF_Data:_wfData, callBackFunc:callBackFunc}, domain);			
		}
		else
		{		
			return LWFP.innerApi.loadForm(container, false, _wfData, delegate, callBackFunc, domain, extendParam);
		}
	}
	finally
	{
		_wfData = err = null;
	}
}

LWFP.API.SaveCurrentStepRecord = function(domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.submitCurrentModule)
		return domain.parentPageModule.submitCurrentModule();
}

/**
 * 注册扩展按钮
 * @param {} name 	按钮名称
 * @param {} title 	按钮title
 * @param {} width 	按钮宽度（int 默认65）
 * @param {} icon 	图标
 * @param {} fn 	方法
 * @param {} domain	作用域
 * @param {} inMore	是否在“更多”显示 
 * @param {} tagName 指定位置tag，可选值： extendbutton 默认扩展按钮区  righttag 最右侧
 * @param {} styleFloat
 *   
 */
LWFP.API.registExtendButton = function(name, title, width, icon, fn, domain, exFunction, inMore, tagName, styleFloat)
{	
	if (domain && domain.parentPageModule && domain.parentPageModule.registExtendButton)
			domain.parentPageModule.registExtendButton(name, title, width, icon, fn, domain, exFunction, inMore, tagName, styleFloat);
}

LWFP.API.registUploadButton = function(name, title, width, icon, tabcode, domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.registExtendButton)
			domain.parentPageModule.registExtendButton(name, title, width, icon, null, domain, {type:1, tabcode:tabcode});
}

LWFP.API.setActionCCTitle = function(actionName, title, domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.setActionCCTitle)
		domain.parentPageModule.setActionCCTitle(actionName, title);
}

LWFP.API.refreshRunningUI = function(domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.refreshPage)
		domain.parentPageModule.refreshPage(false, true, 0, null, null);
}

/**
 * 打印
 * @param {} html  		 直接打印html
 * @param {} moduleName  打印模型名
 * @param {} pk          打印记录ID
 * @param {} extendParam 扩展参数
 */
LWFP.API.print = function(html, moduleName, pk, extendParam, mode)
{
	try
	{	
		if (mode == null)
			mode = 1;
		
		var c = null;
		var link = document.getElementsByTagName('link') 
		if (link != null)
		{
			c = [];
			for(var i=0; i<link.length; i++)
			{
				var p = link[i].getAttribute('path');
				if (!p)
					p = link[i].path;
				if (p)
					c.add(p);
			}
		}
		if (c.length == 0)
			c = null;
			
		if (mode == 0 || LEAPBrowser.isChrome)
		{
			window.__printParam = {_html:html, _moduleName:moduleName, _pk:pk, _extendParam:extendParam, css:c};
						
			window.open(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.router) + "LEAP/LWFP/HTML/printer/WFPrinter.html"),'','');
		}
		else
		{		
			window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.router) + "LEAP/LWFP/HTML/printer/WFPrinter.html"), {_html:html, _moduleName:moduleName, _pk:pk, _extendParam:extendParam, css:c}, "scroll:1;status:1;help:1;resizable:1;dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px");
		}
	}
	catch(e)
	{
		alert(e.message);
		window.__printParam = null;
	}
	finally
	{
		c = link = i = p = null;
	}		
}

LWFP.__toporg = null; 
LWFP.API.getCuttentToporg = function(includeCurrentNode)
{
	if (!LWFP.__toporg)
		LWFP.__toporg = LEAP.routerRequest('WfGetTopOrgan', {organid:LEAP.getUserInfo().orgid, includeCurrentNode:includeCurrentNode});
		
	return LWFP.__toporg;
}

/**
 * 设置附件上传通道
 * @param {} uploadPath 一般附件上传通道
 * @param {} scanUploadPath 扫描件上传通道
 * @param {} domain
 */
LWFP.API.setAttachmentUploadPath = function(uploadPath, scanUploadPath, module)
{
	if (module && module.parentPageModule && module.parentPageModule.setAttachmentUploadPath)
	{
		return module.parentPageModule.setAttachmentUploadPath(uploadPath, scanUploadPath);
	}
}

/**
 * 附件校验
 * @param {} checkItems 需校验的附件项代码，多项之间以逗号分隔
 * @param {} module 模型
 * @return {}
 */
LWFP.API.attachementValidate = function(checkItems, module)
{
	if (module && module.parentPageModule && module.parentPageModule.attachementValidate)
	{
		return module.parentPageModule.attachementValidate(checkItems);
	}
	else
	{
		return false;	
	}
}

/**
 * 设置附件项
 * @param {} __attItems 附件项配置，配置格式： {uploadpath:上传通道名（默认为'default'）, defaultcolor:未上传项颜色, uploadcolor:已上传项颜色, uploadbuttons:上传按钮, items: 附件项数组}
                                  附件项格式：{code:代码,name:显示名,multifile:是否多文件,defaultcolor:未上传项颜色（默认black）,uploadcolor:已上传项颜色（默认blue）}
	   示例：设置固定附件项：{uploadpath:'default',  
	   							items:[ {code:'a',name:'aaaa',multifile:false, dafaultcolor:'red', uploadcolor:'blue'},
	   									{code:'b',name:'bbbb',multifile:false, dafaultcolor:'red', uploadcolor:'blue'},
	   									{code:'c',name:'cccc',multifile:false, dafaultcolor:'red', uploadcolor:'blue'} ] }
	   		设置上传按钮：{uploadbuttons:'word,att,scan'}
	   	
 * @param {} module
 * @return {}
 */
LWFP.API.setFixAttachementItems = function(_attItems, module)
{
	if (module && module.parentPageModule && module.parentPageModule.setFixAttachementItems)
	{
		module.parentPageModule.setFixAttachementItems(_attItems);
	}	
}

/**
 * 设置已有附件(只对固定附件样式有效)
 * @param {} atts 附件清单数组:[{atttype:类型：－9正文0普通附件9扫描件, attcode:附件项代码, title:原始文件名, name:文件名, uuid:映射编码, namedpath:路径, filecount:文件数}]
 * 	  如:[ {atttype:0, attcode:"c", title: "Base", name: "f3b5050ba4684a22ae24fca072291340.js", uuid: null, namedpath: "default/2012/10/12", filecount:null} ]
 * @param {} module
 * @param {} sync 是否异步,默认true
 */
LWFP.API.setExistAttachements = function(atts, module, sync)
{
	if (module && module.parentPageModule && module.parentPageModule.setExistAttachements)
	{
		if (sync == null)
			sync = false;
		module.parentPageModule.setExistAttachements(atts, sync);
	}	
}

/**
 * 获取流程运行界面附件插件值
 */
LWFP.API.getAttachments = function(module)
{
	if (module && module.parentPageModule && module.parentPageModule.getAttachments)
	{
		return module.parentPageModule.getAttachments();
	}
	else
	{
		return null;	
	}
}
LWFP.API.getAttachments2 = function(module)
{	
	try
	{
		if (module && module.parentPageModule && module.parentPageModule.getAttachments)
		{
			var str = module.parentPageModule.getAttachments();
			if (str != null)
			{
				var atts = eval("[" + str + "]");
				atts = atts[0];
				return atts;
			}
		}
		
		return null;
	}
	finally
	{
		str = atts = null;
	}
}

LWFP.API.deleteAttachment = function(module, att)
{
	if (module && module.parentPageModule && module.parentPageModule.deleteAttachment)
		module.parentPageModule.deleteAttachment(att);
}

LWFP.API.copyAttachments = function(attachments, entryid, category, owner, wordAsNormal)
{	
	try
	{
		if(entryid)
			LEAP.routerRequest('WfCopyAttachments', {attachments:attachments, entryid:entryid, category:category, owner:owner, wordAsNormal:wordAsNormal});
		else
			return LEAP.routerRequest('WfCopyAttachments', {attachments:attachments, owner:owner, wordAsNormal:wordAsNormal});
	}
	finally
	{
		attachments = entryid = null;
	}
}

/**
 * 设置正文关闭时是否提示
 * @param {} module
 * @param {} forceclose 是否强制关闭,默认true
 */
LWFP.API.setZWForceClose = function(module,forceclose)
{
	if (module && module.parentPageModule && module.parentPageModule.setZWForceClose)
	{
		if (forceclose == null)
			forceclose = true;
		module.parentPageModule.setZWForceClose(forceclose);
	}	
}

/**
 * 静默操作
 * @param {} _boolean:true（显示提示）、false（静默提示）、2(不提示)
 */
LWFP.API.silenceOperate = function(module, _boolean)
{
	if (module && module.parentPageModule)	
		module.parentPageModule.silenceOperate = _boolean;	
}

/**
 * 隐藏显示工具栏按钮
 * @param {} module
 * @param {} type
 * @param {} _boolean
 */
LWFP.API.displayToolBarButton = function(module, type, _boolean)
{
	if (module && module.parentPageModule && module.parentPageModule.displayToolBarButton)
		module.parentPageModule.displayToolBarButton(type, _boolean);	
}

/**
 * 获取工具栏按钮
 * @param {} module
 * @param {} type
 */
LWFP.API.getToolBarButtons = function(module, type)
{
	if (module && module.parentPageModule && module.parentPageModule.getToolBarButtons)
		return module.parentPageModule.getToolBarButtons(type);
	
	return null;
}

/**
 * 是否可回滚至某环节 （根据环节权限配置和当前用户角色判断）
 * @param {} stepName 环节名称
 * @param {} clearHistory 是否清除历史痕迹，false则保留回滚痕迹
 * @param {} domain	表单作用域
 * @return {Boolean}
 */
LWFP.API.canRollback = function(stepName, clearHistory, domain)
{
	if(LWFP.API.__canRollback(stepName, clearHistory, domain))
		return true;
	else
		return false;
}

LWFP.API.__canRollback = function(stepName, clearHistory, domain)
{
	try
	{
		if (!domain.workflow)
			return null;
		
		var data = domain.workflow.getData();
		if (!data || !data.rollbackSteps || !data.historySteps)
			return null;
			
		var step = null;
		for(var i=0; i<data.flow.steps.length;i++)
		{
			var tmp = data.flow.steps[i];
			if (stepName == tmp.stepname && tmp.righttofinish == 0 && tmp.righttostart == 0)
			{
				step = tmp;
				break;
			}			 
		}
		if (step == null)
			return null;
			
		for (var j=0; j<data.rollbackSteps.length; j++)
		{			
			var rb = data.rollbackSteps[j];
			if (rb.clearHistory == clearHistory && step.stepid == rb.stepid)
			{
				return step.stepid;
			}			
		}		
	}
	finally
	{
		data = step = i = tmp = j = rb = null;
	}
}

/**
 * 回滚至某环节
 * @param {} stepName 环节名称
 * @param {} clearHistory 是否清除历史痕迹
 * @param {} type 0回滚到当前环节第一个历史步骤 1回滚到当前环节最后一个历史步骤
 * @param {} domain 表单作用域
 */
LWFP.API.rollback = function(stepName, clearHistory, type, domain)
{	
	if (window.confirm("该操作不可逆转，是否确定执行？") == false) return;
	
	try
	{
		var stepid = LWFP.API.__canRollback(stepName, clearHistory, domain);
		if (stepid == null)
		{
			alert('未能匹配到和回滚的历史步骤！');
			return;
		}
		
		var arr = domain.workflow.getData().historySteps;
		var his = null;
		
		if (type == 0)
		{
			for(var i=0; i<arr.length; i++)
			{
				if (arr[i].stepid == stepid)
				{
					his = arr[i];
					break;
				}
			}			
		}
		else
		{
			for(var i=arr.length-1; i>=0; i--)
			{
				if (arr[i].stepid == stepid)
				{
					his = arr[i];
					break;
				}
			}			
		}
		
		if (!his)
		{
			alert('未能匹配到和回滚的历史步骤！');
			return;
		}
					
		var b_result = domain.request2({name:'WfRollBack', par:{ds:domain.workflow.getData().datasource, entryid:domain.workflow.getData().entry.entryid, HSID:his.hsid, clearHistory:clearHistory}});			
		if (b_result != null && b_result == true)
		{
			alert("事务回滚成功！");
			if (domain.parentPageModule != null && domain.parentPageModule.refreshPage)
			{
				LEAP.asyn(domain.parentPageModule.refreshPage, domain.parentPageModule, 1, false, false, null, null, null);
			}
		}
		else
		{
			var err = leapclient.getLastWarring();
			if(err != null)
				alert(err);
			else
				alert("事务回滚失败！");
				
			err = null;
		}
	}
	finally
	{
		stepid = arr = his = i = b_result = err = null;
	}
}



/**
 * 添加关联件至当前流程表单的关联件插件
 * @param module 关联件插件所在表单模型
 * @param arg :  {data:[{entryid:被关联流程ID, eventname:摘要}, ...] }
 */
LWFP.API.addRelatedEntry = function(module, arg)
{
	try
	{
		var ct = LEAP.getElement('div[ct=RelatedEntry]', module.moduleElement);
		if (ct)
		{	
			LEAP.RelatedEntry.addRelatedEntry({data:arg.data, callback_src:ct});
		}
	}
	finally
	{
		ct = null;
	}
}

/**
 *	设置表单扩展新增服务 
 * @param {} domain
 * @param {} serviceName
 */
LWFP.API.SetExtendInsertService = function(domain, serviceName)
{
	domain.___LWFP_insertService_ex = serviceName;	
}


/**
 * 表单保存前注册流程启动参数
 * @param {} module	pageObject
 * @param {} businessNo 事项编号/事项名称
 */
LWFP.API.SetWFParameter = function(module, businessNo)
{
	if (module == null || module.moduleName == null || businessNo == null)
		return;
	
	var recParam = new WFRecParams();
	recParam.setType(1);
	recParam.setBusinessNo(businessNo);
	recParam.setPageModule("insert");

	module.WFMode = true;
	module.___LWFPDynaParameter = recParam;
	module.innerWFInsertSubmit = LWFP.moduleSubmit;
}
LWFP.moduleSubmit = function(parameter, insertPar, changePar, deletePar, noModify)
{
	try
	{
		this.___LWFPSubmitResult = null;
		if (this.___LWFPDynaParameter.pageModule == "insert")
		{
			var service = "WfDynaCreate";
			if (this.moduleVersion>1)
				service = "WfBeanCreate";	
				
			if (this.getWfAttachmentParams)
				this.___LWFPDynaParameter.setAttachments(this.getWfAttachmentParams());
				
			//提交
			this.___LWFPSubmitResult = this.request(service, {DataResult:parameter, insertPar:insertPar, 
					changePar:changePar, deletePar:deletePar, noModify:noModify, RecordParams: this.___LWFPDynaParameter});					
			if (this.___LWFPSubmitResult)
				return this.___LWFPSubmitResult.cresult;
		}
		else if (this.___LWFPDynaParameter.pageModule == "modify")
		{
			var service = "WfDynaModify";
			if (this.moduleVersion>1)
				service = "WfBeanModify";
			this.___LWFPSubmitResult = this.request(service, {DataResult:parameter, RecordParams: this.___LWFPDynaParameter});
		}

		return null;
	}
	finally
	{
		service = null
	}
}
	

/**
 * 表单保存后执行动作: 
 * @param {} actionName 动作名
 * @param {} module
 * @param {} param
 */
LWFP.API.DoAction = function(actionName, module)
{
	try
	{
		var actor = new LWFPActor().newInstance(actionName, module);
		if (actor != null)
			actor.run(module);
		else
			alert("操作失败！");
	}
	finally
	{
		actor.dispose();
		actor = null;
	}	
}

/**
 * 加载自定义侧边栏
 * @param {} modulename
 * @param {} title
 * @param {} customParam
 * @param {} domain
 */
LWFP.API.LoadCustomBanner = function(modulename, title, customParam, domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.LoadCustomBanner)
		domain.parentPageModule.LoadCustomBanner(modulename, title, customParam);
}

/**
 * 获取侧边栏模型
 * @param {} domain
 */
LWFP.API.GetCustomBannerModule = function(domain)
{
	return domain.parentPageModule.customBannerModule;		
}

/**
 * 设置表单操作域权限
 * @param {} module 模型对象
 * @param {} panel  操作域名称
 * @param {} status 0正常 110只读 120隐藏
 */
LWFP.API.setModuleOprationStatus = function(module, panel, status)
{
	try
	{
		var arr = LEAP.getElements("[panel=" + panel + "][instance=" + module.instance + "]",  module.moduleElement);
		if (arr)
		{
			for(var i=0; i<arr.length; i++)
			{
				var e = arr[i];
				LEAP.setOPAreaStatus(e, status, false, true);		
			}
		}	
	}
	finally
	{
		arr = i = e = null;
	}
}


/**************************************************************************************/

/**
 * LWFPActor 动作执行器
 * 成员： 		
		action
		CSID		
		caller		
		wfdata
		TtransForm
 */
var LWFPActor = function(){};
LWFPActor.prototype.newInstance = function(actionName, caller)
{	
	this.action = this.CSID = this.caller = this.wfdata = null;		
	try
	{
		if (caller == null || caller.___LWFPSubmitResult == null || caller.___LWFPSubmitResult.csid == null)
			return null;		
		if (actionName == null)
			return null;

		this.caller = caller;
		this.CSID = caller.___LWFPSubmitResult.csid;
		
		this.wfdata = LWFP.innerApi.getWFRunningData(this, false, null, this.CSID, null);
		if (this.wfdata == null)
			return;
		
		this.action = LWFP.innerApi.getActionByName(this.wfdata.flow.actions, actionName);		
		if (this.action == null)
			return null;
		
		return this;
	}
	finally
	{
	}
}
LWFPActor.prototype.run = function(module)
{
	if (this.TransForm == null)
	{
		this.TransForm = module.loadForm('LWFP.TransForm', '发送');				
		var w = window.screen.deviceXDPI*21/(1.2*2.54);
		var h = 400;								
		LEAP.form.setSize(this.TransForm.form, w>document.body.clientWidth?document.body.clientWidth:w, 
			h>document.body.clientHeight?document.body.clientHeight:h);
		LEAP.form.hide(this.TransForm.form);
	}
	if (this.TransForm != null)
	{
		if (this.TransForm.module.init(this.wfdata, this.action, this.CSID, 3) )
		{
			LEAP.form.show(this.TransForm.form);
		}
	}		
}
LWFPActor.prototype.dispose = function()
{		
	this.action = this.CSID = this.caller = this.wfdata = null;
}


LWFP.innerApi = new Object();
LWFP.innerApi.loadForm = function(container, isNew, wfData, delegate, callBackFunc, domain, extendParam, router)
{
	try
	{		
		var UIModule = "LWFP.WFRunningUI";
		if (wfData.flow.uimodule != null && wfData.flow.uimodule != "")
			UIModule = "LWFP." + wfData.flow.uimodule;
		var _type = 1;
		var _form = null;
		if (container != null)
		{
			_type = 2;
			
			_form = domain.loadModule2({name:UIModule, parent:container});
			_form.loadType = _type;
			_form.callback = callBackFunc;			
		}
		else
		{
			if (router == null)
				_form = domain.loadForm(UIModule, wfData.flow.aliasname);
			else
				_form = domain.loadForm3({name:UIModule, title:wfData.flow.aliasname, router:router});

			_form.module.loadType = _type;
			_form.module.callback = callBackFunc;
			
			if (extendParam && extendParam.location)
			{
				if (extendParam.location.x && extendParam.location.y)
					LEAP.form.setLocation(_form.form, extendParam.location.x, extendParam.location.y);
				if (extendParam.location.w && extendParam.location.h)
					LEAP.form.setSize(_form.form, extendParam.location.w, extendParam.location.h);
			}
			else			
			{
				LEAP.form.maxSize(_form.form);
			}
		}
				
		
		if (_form != null)
		{				
			if (container != null)
				LEAP.form.show(_form.form);
			
			/*if (_type == 1)
			{	
				_form.module.initPage(isNew, wfData, null, extendParam);
			}
			else
			{
				_form.initPage(isNew, wfData, null, extendParam);
			}*/
			
			setTimeout(function()
					{
						try
						{
							if (_type == 1)
								_form.module.initPage(isNew, wfData, null, extendParam);
							else
								_form.initPage(isNew, wfData, null, extendParam);
						}
						finally
						{
							wfData = _form = _type = null;
						}
				}, 0);

			//if (LEAP.form.getTaskBar() == null)
			//	LWFP.FormManager.clear();
				
			if (_type == 1)
			{
				LWFP.FormManager.regist(_form.form, _form.module, domain, callBackFunc, 1);
				LEAP.addEvent(_form.form, "formHided", LWFP.FormManager.formHided);
			}
			else
			{
				LWFP.FormManager.regist(_form.instance, _form, domain, callBackFunc, 2);				
			}
		}
		
		return _form; 
	}
	finally
	{
		UIModule = null;
	}
}

LWFP.innerApi.setFormSize = function(_form)
{
	if (_form == null)
		return;

	if (LEAPBrowser.isIE == true)
	{
		LEAP.form.setSize(_form.form, 9.5 * window.screen.deviceXDPI, document.body.clientHeight-80);
		LEAP.form.setLocation(_form.form, (document.body.clientWidth - 9.5 * window.screen.deviceXDPI)/2, 25);
	}
	else
	{
		LEAP.form.setSize(_form.form, 9.5 * 96, document.body.clientHeight-80);
		LEAP.form.setLocation(_form.form, (document.body.clientWidth - 9.5 * 96)/2, 25);
	}	
}

LWFP.innerApi.openSubflow = function(mainData, maincsid, domain, callback)
{	
	setTimeout(function()
	{	
			//var arr = LWFP.innerApi.getNextSteps(maincsid, mainData.curSteps, mainData.historySteps, [mainData.currentStep]);
			var arr = LWFP.innerApi.getNextSteps(maincsid, mainData.curSteps, mainData.historySteps, null);
			if (arr != null)
			{
				for(var i=0; i<arr.length; i++)
				{
					if (arr[i].subflowentry != null)
					{
						LWFP.API.openForm(null, arr[i].subflowentry, null, null, callback, domain, null);		
						break;
					}
				}
			}
	}, 0);
}


LWFP.WFWorkflowCache = new hashtable();
LWFP.innerApi.getWFRunningData = function(domain, isNew, arg0, arg1, delegate, archCategory, otherRouter)
{
	try
	{
		var data;
		var router = otherRouter;
		if (router == null)
			router = (domain && domain.leapclient)?domain.leapclient.router:null;
		
		if (isNew)
		{
			data = LEAP.request2({router:router, 
							name:'WfGetStartData',
							par: {businessno: arg1, delegate:delegate} });
		}
		else
		{
			var _delegate = delegate;
			if (domain && domain.superDelegate == true)
			{
				if (_delegate != null)
				{
					_delegate.superDelegate = true;
				}
				else
				{
					_delegate = {superDelegate:true};				
				}
			}
			
			data = LEAP.request2({router:router, 
									name:'WfGetRunningData', 
									par:{entryId : arg0, CSID: arg1, delegate:_delegate, archCategory:archCategory}});
		}
		
		if (data != null)
		{			
			var flowid = null;
			if (data.entry != null)
				flowid = data.entry.flowid;
			else if (data.step != null)
				flowid = data.step.flowid;					
						
			if (flowid != null)
			{
				/*var flow = null;
				
				flow = LWFP.WFWorkflowCache.getvalue("wf" + flowid);
				if (flow == null)
				{								
					var client = leapclient;
					if (router != null && window.createRouterClient)
					{
						client = window.createRouterClient(router)
					}
					
					var str = client.load('LEAP/LWFP/JavaScript/workflow/' + flowid + ".wf");
					flow = eval('(' + str + ')');
					LWFP.WFWorkflowCache.add("wf" + flowid, flow); //缓存
				}*/
				
				var flow = LWFP.innerApi._getFlowDesign(flowid, data.flowversiontm, router);
								
				data.flow = flow;
				data = LWFP.innerApi.analysisData(data);
			}
		}
		else
		{
			var err = "";
			if (createRouterClient(router))
				err = createRouterClient(router).getLastWarring();
				
			if (err == null)
				err = "";
				
			err = "数据加载失败，请检查流程配置！ " + err;
			alert(err);
		}
		
		return data;
	}
	finally
	{
		flowid = str = flow = data = null;
	}
}

LWFP.innerApi._getFlowDesign = function(flowid, newVersion, router)
{
	var flow = LWFP.WFWorkflowCache.getvalue("wf" + flowid);
	if (flow == null)
	{	
		flow = LWFP.innerApi._loadFlowDesign(flowid, router);		
		flow.flowversiontm = newVersion;
		LWFP.WFWorkflowCache.add("wf" + flowid, flow); //缓存		
	}
	else
	{
		if (flow.flowversiontm != null && newVersion != null && flow.flowversiontm<newVersion)
		{
			flow = LWFP.innerApi._loadFlowDesign(flowid, router, newVersion);		
			flow.flowversiontm = newVersion;
			LWFP.WFWorkflowCache.replace("wf" + flowid, flow); //缓存		
		}		
	}
	
	return flow;
}

LWFP.innerApi._loadFlowDesign = function(flowid, router, newVersion)
{
	var client = leapclient;
	if (router != null && window.createRouterClient)
	{
		client = window.createRouterClient(router)
	}
	
	var str = client.load('LEAP/LWFP/JavaScript/workflow/' + flowid + ".wf?newVersion=" + newVersion);
	var flow = eval('(' + str + ')');
	
	if (flow.actions != null)
	{
		for(var i=0; i<flow.actions.length; i++)
		{
			var act = flow.actions[i];
			act = LWFP.innerApi.setActionTrgStep(act, flow.steps);
		}
	}
	
	return flow;
}

LWFP.innerApi.analysisData = function(wfdata)
{
	try
	{
		var lastHistoryStep = null;  //当前用户参与的最后历史步骤
		var userflag = LEAP.getUserInfo().userflag;
		
		wfdata.__stephash = new hashtable();
		if (wfdata.historySteps)
		{
			for(var i = wfdata.historySteps.length - 1; i >-1;  i--)
			{
				var __tmp = wfdata.historySteps[i];
				if (__tmp.owner == userflag && lastHistoryStep == null)
					lastHistoryStep = __tmp;
				
				wfdata.__stephash.add(__tmp.hsid, __tmp);
			}
		}
		if (wfdata.curSteps)
		{
			for(var i = 0; i < wfdata.curSteps.length; i++)
			{
				var __tmp = wfdata.curSteps[i];
				wfdata.__stephash.add(__tmp.csid, __tmp);
			}
		}
		
		for(var key in wfdata.__stephash.keys)
		{
			 var hsid = wfdata.__stephash.getkey(key);
			 var step = wfdata.__stephash.getvalue(hsid);
			 
			 if (step && step.prevId)
			 {
			 	var prev = wfdata.__stephash.getvalue(step.prevId);
			 	step.prev = prev;
			 }
		}
		
		if (wfdata.nextActions != null && wfdata.flow != null && wfdata.flow.actions != null)
		{
			var acts = new Array();
			for(var i=0; i<wfdata.nextActions.length; i++)
			{
				var id = wfdata.nextActions[i];
				for(var j=0; j<wfdata.flow.actions.length; j++)
				{
					var act = wfdata.flow.actions[j];
					if (act.actionid == id)
					{
						act = LWFP.innerApi.setActionTrgStep(act, wfdata.flow.steps);
						acts.add(act);
						break;
					}
				}
			}
			
			if (acts.length == 0)
				acts = null;		
			wfdata.nextActions = acts;////
		}
		
		if (wfdata.nextSplitActions != null && wfdata.flow != null && wfdata.flow.actions != null)
		{
			var _acts = new Array();
			for(var i=0; i<wfdata.nextSplitActions.length; i++)
			{
				var id = wfdata.nextSplitActions[i];
				for(var j=0; j<wfdata.flow.actions.length; j++)
				{
					var act = wfdata.flow.actions[j];
					if (act.actionid == id)
					{
						act = LWFP.innerApi.setActionTrgStep(act, wfdata.flow.steps);
						_acts.add(act);
						break;
					}
				}
			}
			
			if (_acts.length == 0)
				_acts = null;		
			wfdata.nextSplitActions = _acts;////
		}
		
		if (wfdata.currentStep != null)
		{
			for(var i=0; i<wfdata.curSteps.length; i++)
			{
				if (wfdata.curSteps[i].csid == wfdata.currentStep)
				{
					wfdata.currentStep = wfdata.curSteps[i];////
					break;
				}
			}
		}
		
		if (wfdata.currentStep != null && wfdata.flow != null && wfdata.flow.steps != null)
		{
			for(var i=0; i<wfdata.flow.steps.length; i++)
			{
				if (wfdata.flow.steps[i].stepid == wfdata.currentStep.stepid)
				{
					wfdata.step = wfdata.flow.steps[i];///
					break;
				}
			}
		}
			
		if (wfdata.flowOptions != null && wfdata.flow.flowOptions != null)
		{
			var opts = new Array();
			for(var i=0; i<wfdata.flowOptions.length; i++)
			{
				var id = wfdata.flowOptions[i];
				for(var j=0; j<wfdata.flow.flowOptions.length; j++)
				{
					var opt = wfdata.flow.flowOptions[j];
					if (opt.foid == id)
					{
						opts.add(opt);
						break;
					}
				}
			}
			
			if (opts.length == 0)
				opts = null;		
			wfdata.flowOptions = opts;////
		}
		
		//意见带环节名, 落款带前缀 
		if (wfdata.opinions && wfdata.historySteps)
		{
			var h = new hashtable();			
			for(var i=0; i<wfdata.flow.steps.length; i++)
			{	
				if (wfdata.flow.steps[i].opinionsignprefix == 1)
					h.add(wfdata.flow.steps[i].stepid);
			}
			
			var _h = new hashtable();
			var _h2 = new hashtable();
			var _h3 = new hashtable();
			for(var k=0; k<wfdata.historySteps.length; k++)
			{
				var his = wfdata.historySteps[k];				
				if (his.hsid && h.contains(his.stepid))
					_h.add(his.hsid);
				if (his.hsid)
				{
					_h2.add(his.hsid, his.stepaliasname);
					_h3.add(his.hsid, his.stepname);
				}
			}
			
			if (wfdata.currentStep)
			{
				_h2.add(wfdata.currentStep.csid, wfdata.currentStep.stepaliasname);
				_h3.add(wfdata.currentStep.csid, wfdata.currentStep.stepname);
			}
			
			for(var m=0; m<wfdata.opinions.length; m++)
			{
				for(var n=0; n<wfdata.opinions[m].opinions.length; n++)
				{
					if (_h.contains( wfdata.opinions[m].opinions[n].category ) )
						wfdata.opinions[m].opinions[n]._viewPrefix = true;
					if (_h2.contains( wfdata.opinions[m].opinions[n].category ) )
					{
						wfdata.opinions[m].opinions[n].categoryName = _h2.getvalue(wfdata.opinions[m].opinions[n].category);
						wfdata.opinions[m].opinions[n].categoryUniqueName = _h3.getvalue(wfdata.opinions[m].opinions[n].category);
					}
				}
			}				
		}
		
		if (wfdata.attachments)
		{
			for(var i=0; i<wfdata.attachments.length; i++)
			{
				var _att = wfdata.attachments[i];
				var category = _att.category;
				if (wfdata.__stephash.contains(category))
				{
					var _tmpStep = wfdata.__stephash.getvalue(category);
					_att.stepaliasname = _tmpStep.stepaliasname;
					_att.stepname = _tmpStep.stepname;
					_att.stepid =  _tmpStep.stepid;
				}

				_att.hasUpdate = false;
				if (lastHistoryStep != null && lastHistoryStep.finishtime != null && _att.updatetime != null && lastHistoryStep.finishtime.time < _att.updatetime.time)
				{
					_att.hasUpdate = true;				
				}				
			}
		}
		
		wfdata.canHandround = LWFP.innerApi.__canHandround(wfdata);
		
		return wfdata;
	}
	finally
	{
		acts = i = id = j = act = _acts = opts = opt = h = _h = _h2 = k = his = m = n = category = __stepname = __flag = null;
	}
}

LWFP.innerApi.__canHandround = function(wfdata)
{
	if (wfdata.entry == null || wfdata.historySteps == null)
		return false;
		
	if (wfdata.currentStep != null)
		return true;
	
	if (wfdata.historySteps != null)
	{
		for(var i=0; i<wfdata.historySteps.length; i++)
		{
			if (wfdata.historySteps[i].owner == LEAP.getUserInfo().userflag)
				return true;
		}
	}
	
	return false;	
}

LWFP.innerApi.getCurrentStepByCSID = function(curSteps, csid)
{
	if (curSteps == null || curSteps.length == 0)
		return null;
	
	try
	{
		for(var i=0; i<curSteps.length; i++)
		{
			if (curSteps[i].csid == csid)
				return curSteps[i];
		}
	}
	finally
	{
		i= null;
	}
}

LWFP.innerApi.getHistoryStepByHSID = function(hisSteps, hsid)
{
	if (hisSteps == null || hisSteps.length == 0)
		return null;
	
	try
	{
		for(var i=0; i<hisSteps.length; i++)
		{
			if (hisSteps[i].hsid == hsid)
				return hisSteps[i];
		}
	}
	finally
	{
		i= null;
	}
}

LWFP.innerApi.getNextSteps = function(hsid, cursteps, hissteps, excludeSteps)
{
	try
	{
		var rst = [];
		if (cursteps != null && cursteps.length>0)
		{
			for(var i=0; i<cursteps.length; i++)
			{
				var tmp = cursteps[i];
				if (tmp.prevId != hsid)
					continue;
					
				var flag = true;
				if (excludeSteps != null)
				{
					for(var k=0; k<excludeSteps.length; k++)
					{
						if (excludeSteps[k] && excludeSteps[k].hsid == tmp.hsid)
						{
							flag = false;
							break;
						}				
					}				
				}
				
				if (flag == true)
					rst.add(tmp);			
			}	
		}
		
		if (hissteps != null && hissteps.length>0)
		{
			for(var i=0; i<hissteps.length; i++)
			{
				var tmp = hissteps[i];
				if (tmp.prevId != hsid)
					continue;
					
				var flag = true;
				if (excludeSteps != null)
				{
					for(var k=0; k<excludeSteps.length; k++)
					{
						if (excludeSteps[k] && excludeSteps[k].hsid == tmp.hsid)
						{
							flag = false;
							break;
						}				
					}				
				}
				
				if (flag == true)
					rst.add(tmp);			
			}	
		}
		
		if (rst.length == 0)
			return null;
		else
			return rst;
	}
	finally
	{
		rst = i = tmp = flag = k = null;
	}
}

LWFP.innerApi.construtStepChain = function(startStep, hisSteps, curSteps)
{
	var chain = {step:startStep, chains:null};
	chain = LWFP.innerApi.__construtStepChain_re(chain, hisSteps, curSteps);
	
	return chain;
}

LWFP.innerApi.__construtStepChain_re = function(chain, hisSteps, curSteps)
{
	var step = chain.step;
	var arr = LWFP.innerApi.getNextSteps(step.hsid, curSteps, hisSteps);
	if (arr)
	{
		var nexts = [];
		for(var i=0; i<arr.length; i++)
		{
			var tmpStep = arr[i];
			var tmpChain = {step:tmpStep, chains:null};				
			tmpChain = LWFP.innerApi.__construtStepChain_re(tmpChain, hisSteps, curSteps);
			
			nexts.add(tmpChain);
		}
		
		chain.chains = nexts;			
	}
	
	return chain;
}

LWFP.innerApi.getStepStatus = function(code)
{
	if (code == 0)
		return "未阅";
	else if (code == 1)
		return "已阅";
	else if (code == 2)
		return "在办";
	else if (code == 3)
		return "办结";
	else if (code == 4)
		return "已回收";
}

LWFP.innerApi.setActionTrgStep = function(action, steps)
{
	try
	{
		for(var i=0; i<steps.length; i++)
		{
			if (steps[i].stepid == action.trgstepid)
			{
				action.trgStep = steps[i];
				return action;
			}
		}
	}
	finally
	{
		i = 0;
	}
}

/**
 * 检查下环节执行者是否唯一 
 * 应用界面: WFRunning
 */
LWFP.innerApi.checkNextOwner = function(orgTree, refNextOwner, refAllOwner)
{	
	refNextOwner.clear();
	refAllOwner.clear();
	var ret = false;
	
	if (orgTree == null)
		return ret;
	
	if (orgTree.authVersion == 2)
		return 	LWFP.innerApi.checkNextOwner_vir(true, orgTree, refNextOwner, refAllOwner);
	else if (orgTree.authVersion == 3)
		return LWFP.innerApi.checkNextOwner_auth3(true, orgTree, refNextOwner, refAllOwner);
	
	try
	{
		if (orgTree.nodes)
		{
			for(var i=0; i<orgTree.nodes.length; i++ )
			{
				if (orgTree.nodes[i].isTip == true)
				{						
					refNextOwner.add(orgTree.nodes[i]);
					refAllOwner.add(orgTree.nodes[i]);
				}
			}
			
			ret = true;
		}
		if (orgTree.customNodes)
		{
			for(var i=0; i<orgTree.customNodes.length; i++ )
			{
				if (orgTree.customNodes[i].isTip == true)
				{
					refNextOwner.add(orgTree.customNodes[i]);
					refAllOwner.add(orgTree.nodes[i]);
				}
			}
			
			ret = true;
		}
		
		if (orgTree.disableOrganTree == true)
		{	
			ret = false;
		}
		else
		{
			if (orgTree.extendNodes != null)
			{
				refNextOwner.clear();
				for(var i=0; i<orgTree.extendNodes.length; i++ )
					refNextOwner.add(orgTree.extendNodes[i]);
				
				ret = true;
			}
			else
			{
				if (orgTree.onlyOne == true)
					ret = false;
				else
					refNextOwner.clear();
			}
		}		
				
		return ret;
	}
	finally
	{
		i = ret = null;
	}
}

LWFP.innerApi.checkNextOwner_auth3 = function(whole, orgTree, refNextOwner, refAllOwner)
{
	try
	{
		if (whole == true)
		{			
			if (orgTree == null)
				return false;
			
			var ret = false;		
			for(var i=0; i<orgTree.treesByTab.length; i++)
			{
				var tmp = orgTree.treesByTab[i];
				var _r = LWFP.innerApi.checkNextOwner_auth3(false, tmp, refNextOwner, refAllOwner);
				if (_r == true)
					ret = true;
			}
			
			if (refAllOwner.length >0)
				ret = true;
			
			if (orgTree.disableOrganTree == true)
			{	
				ret = false;
			}
			else
			{
				if (orgTree.extendNodes != null)
				{
					refNextOwner.clear();
					for(var i=0; i<orgTree.extendNodes.length; i++ )
						refNextOwner.add(orgTree.extendNodes[i]);
					
					ret = true;
				}
				else
				{
					if (orgTree.onlyOne == true)
						ret = false;
					else
						refNextOwner.clear();
				}
			}		
					
			return ret;			
		}
		else
		{
			var _ret = false;
			if (orgTree.nodes)
			{
				for(var i=0; i<orgTree.nodes.length; i++ )
				{
					if (orgTree.nodes[i].isTip == true)
					{						
						refNextOwner.add(orgTree.nodes[i]);
						refAllOwner.add(orgTree.nodes[i]);
					}
				}
				
				_ret = true;
			}
			
			if (orgTree.extendNodes != null)
			{
				for(var i=0; i<orgTree.extendNodes.length; i++ )
				{
					refNextOwner.add(orgTree.extendNodes[i]);
				}
				
				_ret = true;
			}
			
			return _ret;
		}
		
	}
	finally
	{
		ret = i=tmp = _r = null;
	}
}

LWFP.innerApi.checkNextOwner_vir = function(whole, orgTree, refNextOwner, refAllOwner)
{
	try
	{
		if (whole == true)
		{			
			if (orgTree == null)
				return false;
			
			var ret = false;		
			for(var i=0; i<orgTree.treesByTab.length; i++)
			{
				var tmp = orgTree.treesByTab[i];
				var _r = LWFP.innerApi.checkNextOwner_vir(false, tmp, refNextOwner, refAllOwner);
				if (_r == true)
					ret = true;
			}
			
			if (refAllOwner.length >0)
				ret = true;
			
			if (orgTree.disableOrganTree == true)
			{	
				ret = false;
			}
			else
			{
				if (orgTree.extendNodes != null)
				{
					refNextOwner.clear();
					for(var i=0; i<orgTree.extendNodes.length; i++ )
						refNextOwner.add(orgTree.extendNodes[i]);
					
					ret = true;
				}
				else
				{
					if (orgTree.onlyOne == true)
						ret = false;
					else
						refNextOwner.clear();
				}
			}		
					
			return ret;			
		}
		else
		{
			var _ret = false;
			if (orgTree.nodes)
			{
				for(var i=0; i<orgTree.nodes.length; i++ )
				{
					if (orgTree.nodes[i].isTip == true)
					{						
						refNextOwner.add(orgTree.nodes[i]);
						refAllOwner.add(orgTree.nodes[i]);
					}
				}
				
				_ret = true;
			}
			
			if (orgTree.extendNodes != null)
			{
				for(var i=0; i<orgTree.extendNodes.length; i++ )
				{
					refNextOwner.add(orgTree.extendNodes[i]);
				}
				
				_ret = true;
			}
			
			return _ret;
		}
		
	}
	finally
	{
		ret = i=tmp = _r = null;
	}
}

/*
LWFP.innerApi.checkNextOwner = function(orgTree, refNextOwner, refAllOwner)
{
	refNextOwner.clear();
	refAllOwner.clear();
	var ret = false;
	
	if (orgTree == null)
		return ret;
	
	try
	{
		if (orgTree.nodes)
		{
			for(var i=0; i<orgTree.nodes.length; i++ )
			{
				if (orgTree.nodes[i].isTip == true)
				{						
					refNextOwner.add(orgTree.nodes[i]);
					refAllOwner.add(orgTree.nodes[i]);
				}
			}
			
			ret = true;
		}
		if (orgTree.customNodes)
		{
			for(var i=0; i<orgTree.customNodes.length; i++ )
			{
				if (orgTree.customNodes[i].isTip == true)
				{
					if (orgTree.extendNodes == null)
						refNextOwner.add(orgTree.customNodes[i]);
					
					refAllOwner.add(orgTree.nodes[i]);
				}
			}
			
			ret = true;
		}
		
		if (orgTree.disableOrganTree == true)
		{
			ret = false;
		}
		else
		{
			if (orgTree.extendNodes != null)
			{
				ret = true;
			}
			else
			{
				if (orgTree.onlyOne == true)
					ret = false;
				else
					refNextOwner.clear();
			}
		}		
				
		return ret;
	}
	finally
	{
		count = i = ret = null;
	}
}
*/

/*
LWFP.innerApi.checkNextOwner = function(orgTree, refNextOwner, refAllOwner)
{
	refNextOwner.clear();
	refAllOwner.clear();
	var ret = false;
	
	if (orgTree == null)
		return ret;
	
	try
	{
		var count = 0;
		if (orgTree.nodes)
		{
			for(var i=0; i<orgTree.nodes.length; i++ )
			{
				if (orgTree.nodes[i].isTip == true)
				{
					count ++;					
					refNextOwner.add(orgTree.nodes[i]);
					refAllOwner.add(orgTree.nodes[i]);
				}
			}
		}
		if (orgTree.customNodes)
		{
			for(var i=0; i<orgTree.customNodes.length; i++ )
			{
				if (orgTree.customNodes[i].isTip == true)
				{
					count ++;
					refNextOwner.add(orgTree.customNodes[i]);
					refAllOwner.add(orgTree.nodes[i]);
				}
			}
		}
		
		if (count == 0) 
		{			
			refNextOwner = null;
			refAllOwner = null;
			ret = (orgTree.extendNodes != null);
		}
		else if (count == 1)
		{
			ret = (orgTree.extendNodes != null);
		}
		else if (count>1)
		{
			if (orgTree.disableOrganTree == true)
			{
				ret = false;
			}
			else
			{
				if (orgTree.extendNodes == null)
				{
					refNextOwner.clear();		
				}
				
				ret = true;				
			}
		}
		
		return ret;
	}
	finally
	{
		count = i = ret = null;
	}
}*/

LWFP.frequentContacts = null;
LWFP.innerApi.getFrequentContacts = function()
{
	if (LWFP.frequentContacts == null)
	{
		LWFP.frequentContacts = LEAP.routerRequest('WfGetFrequentContact');
	}	
	
	return LWFP.frequentContacts;

}
LWFP.innerApi.getNextOwner = function(domain, par)
{
	try
	{
		var rst = domain.request2({name:'WfGetNextOwner2', par:par});
		if (rst != null)
		{
			rst = LWFP.innerApi.getNextOwner_change(rst);
			
			if (rst.splitTrees != null)
			{
				for(var i=0; i<rst.splitTrees.length; i++)
				{
					var _tmp = rst.splitTrees[i];
					_tmp = LWFP.innerApi.getNextOwner_change(_tmp);
					if (_tmp.treesByTab != null)
					{
						for(var k=0; k<_tmp.treesByTab.length; k++)
						{
							_tmp.treesByTab[k] = LWFP.innerApi.getNextOwner_change(_tmp.treesByTab[k]);
						}
					}
					
					rst.splitTrees[i] = _tmp;
				}
			}
			if (rst.treesByTab != null)
			{
				for(var i=0; i<rst.treesByTab.length; i++)
				{
					rst.treesByTab[i] = LWFP.innerApi.getNextOwner_change(rst.treesByTab[i]);
				}
			}
			
			if (rst.frequentContacts != null)
			{
				if (LWFP.userPrefixLevel != null)
				{
					for(var i=0; i<rst.frequentContacts.length; i++)
					{
						var remark = rst.frequentContacts[i].remark;
						if (remark.indexOf(".") > 0)
						{							
							var arr = remark.split(".");
							if (arr.length > LWFP.userPrefixLevel)
							{
								var str = "";								
								for(var k=arr.length - LWFP.userPrefixLevel - 1; k<arr.length; k++)
								{
									if (str != "")
										str += ".";
										
									str += arr[k]; 
								}
								
								rst.frequentContacts[i].remark = str;
							}
						}
						
					}
				}
				
				LWFP.frequentContacts = rst.frequentContacts;
			}
		}
		
		return rst; 
	}
	finally
	{
		rst = i = null;
	}
}


LWFP.innerApi.getNextOwner_change = function(rst)
{
	try
	{		
		if (rst != null)
		{
			if (rst._nodes != null)
			{
				rst.nodes = [];
				for(var i=0; i<rst._nodes.length; i++)
					rst.nodes.add( LWFP.innerApi.b2treeNode(rst._nodes[i]) );
				rst._nodes = null;
			}
			if (rst._customNodes != null)
			{
				rst.customNodes = [];
				for(var i=0; i<rst._customNodes.length; i++)
					rst.customNodes.add( LWFP.innerApi.b2treeNode(rst._customNodes[i]));
					
				rst._customNodes = null;
			}
			if (rst._extendNodes != null)
			{
				rst.extendNodes = [];
				for(var i=0; i<rst._extendNodes.length; i++)
					rst.extendNodes.add( LWFP.innerApi.b2treeNode(rst._extendNodes[i]));				
				rst._extendNodes = null;
			}
			if (rst._ccNodes != null)
			{
				rst.ccNodes = [];
				for(var i=0; i<rst._ccNodes.length; i++)
					rst.ccNodes.add( LWFP.innerApi.b2treeNode(rst._ccNodes[i]));				
				rst._ccNodes = null;
			}
		}
		
		return rst; 
	}
	finally
	{
		i = null;
	}
}

LWFP.innerApi.b2treeNode = function(b)
{
	try
	{
		var n = {};
			n.javaClass = "com.longrise.LWFP.BLL.Cache.OrganTree.OrganTreeNode";
			n.ID = b.id;
			n.haschild = b.haschild;
			n.isMaster = b.ismaster;
	    	n.isTip = b.istip;
	    	n.isValid = b.isvalid;
	    	n.istoporg = b.istoporg;
	    	n.level = b.level;
	    	n.nodeType = b.nodetype;
	    	n.orderID = b.orderid;
	    	n.parentID = b.parentid;
	    	n.syscode = b.syscode;
	    	n.sysorder = b.sysorder;
	    	n.userId =  b.userid;
	    	
	    	var o = new Object();
	    	if (b.nodetype == 0)
	    	{
	    		o.javaClass = "com.longrise.LEAP.BLL.Cache.Extend.leaporganization";
	    		o.id = b.id_z;
	    		o.cnname = b.cnname_z;
	    		n.viewName = b.cnname_z;
	    	}
	    	else if (b.nodetype == 1)
	    	{
	    		o.javaClass = "com.longrise.LEAP.BLL.Cache.Extend.leapposition";
	    		o.id = b.id_z;
	    		o.cnname = b.cnname_z;
	    		n.viewName = b.cnname_z;
	    	}
	    	else if (b.nodetype == 2)
	    	{
	    		o.javaClass = "com.longrise.LEAP.BO.Authority.leapusertable";
	    		o.id = b.id_z;
	    		o.name = b.name_z;
	    		o.fullname = b.fullname_z;
	    		o.userflag = b.userflag;
	    		o.exflagA = b.exflaga;
	    		o.exflagB = b.exflagb;	    		
	    		if (b.id_za != null)
	    		{
	    			var a = {};
	    			a.id = b.id_za;
	    			
	    			o.appointposition = a;
	    		}
	    		
	    		if ( b.fullname_z != null)
	    			n.viewName = b.fullname_z;
				else if (b.name_z != null)
					n.viewName = b.name_z;
				else
					n.viewName = b.userflag;	    		
	    	}	    	
	    	else if (b.nodetype == 10)
            {
            	o.javaClass = "com.longrise.LWFP.BLL.Cache.VirtualOrganization.Object.VirtualOrganization";
            	o.id = b.id_z;
            	o.cnname = b.cnname_z;
            	n.viewName = b.cnname_z;
            }
            else if (b.nodetype == 11)
            {
            	o.javaClass = "com.longrise.LWFP.BLL.Cache.VirtualOrganization.Object.VirtualUser";
            	o.virtualId = b.virtualid_z;
				if ( b.fullname_z != null)
	    			n.viewName = b.fullname_z;
				else if (b.name_z != null)
					n.viewName = b.name_z;
				else
					n.viewName = b.userflag_z;            	
            }
            
            
	    	    
	    n.orgObject = o;	    
	    n.remark = n.viewName;
	    return n;
	}
	finally
	{
		n = o = a = null;
	}
}

LWFP.innerApi.getAction = function(actions, actionid)
{
	try
	{
		for(var i=0; i<actions.length; i++)
		{
			if (actions[i].actionid == actionid)
				return actions[i];
		}
		
		return null;
	}
	finally
	{
		i = null;
	}
}
LWFP.innerApi.getNextAction = function(_actions, _stepid)
{
	try
	{
		var arr = new Array();
		for(var i=0; i<_actions.length; i++)
		{
			if (_actions[i].srcstepid != null && _actions[i].srcstepid == _stepid)
			{
				arr.add(_actions[i]);
			}
		}
		if (arr.length>0)
			return arr;
		else
			return null;
	}
	finally
	{
		i = arr = null;
	}	
}
LWFP.innerApi.getActionByName = function(actions, actionName)
{
	try
	{
		if (actions != null && actions.length>0)
		{
			for(var i=0; i<actions.length; i++)
			{
				if (actions[i].actionname == actionName)
					return actions[i];
			}
		}
		
		return null;
	}
	finally
	{
		i = null;
	}
}
LWFP.innerApi.getActionById = function(actions, actionId)
{
	try
	{
		for(var i=0; i<actions.length; i++)
		{
			if (actions[i].actionid == actionId)
				return actions[i];
		}
		
		return null;
	}
	finally
	{
		i = null;
	}
}
LWFP.innerApi.getStep = function(steps, stepid)
{
	try
	{
		if (steps == null || steps.length == 0 || stepid == null)
			return null;
		for(var i=0; i<steps.length; i++)
		{
			if (steps[i].stepid == stepid)
				return steps[i];
		}
		
		return null;
	}	
	finally
	{
		i = null;
	}
}

LWFP.innerApi.getChildBeans = function(wfbean)
{
	if (wfbean == null || wfbean.childWfBeans == null)
		return;
	
	wfbean.childBeans = [];		
	for(var i=0; i<wfbean.childWfBeans.length; i++)
	{
		if (wfbean.childWfBeans[i].primaryBean != null)
			wfbean.childBeans.push(wfbean.childWfBeans[i].primaryBean);
	}
	
	if (wfbean.childBeans.length == 0)
		wfbean.childBeans = null;
		
	i = 0;
}

LWFP.innerApi.getModuleOptions = function(_module, readonly)
{
	if (_module == null)
		return null;
	
	try
	{
		if (readonly == true)
		{				
			if (_module.optionsDefine != null)
			{
				var hash = new hashtable();		
				//hash配置项
				if (_module.moduleoptions != null)
				{
					var _arr = _module.moduleoptions.split(',');			
					for(var i=0; i<_arr.length; i++)
					{	
						var str = _arr[i];
						var idx = str.indexOf(':');			
						var name = str.substring(0, idx);
						var status = str.substring(idx + 1);
						
						hash.add(name, status);				
					}
				}
				
				var auths = [];
				var arr = _module.optionsDefine.split(',');
				for(var i=0; i<arr.length; i++)
				{
					var name = arr[i];
					var status = 110;	//默认只读
					if (hash.contains(name))
						status = hash.getvalue(name); //使用配置装填

					auths.add({name:name, status:status});
				}
			
				return auths;
			}
			else
			{			
				return null;
			}
		}
		else
		{
			var auths = LWFP.innerApi.str2OptionAuthority(_module.moduleoptions);	
			return auths;
		}
	}
	finally
	{
		hash = _arr = i = str = idx = name = status = auths = arr = name = status = null;
	}	
}

LWFP.innerApi.str2OptionAuthority = function(_str)
{
	if (_str == null || "" == _str)
		return null;

	try
	{
		var rst = [];
		var arr = _str.split(',');			
		for(var i=0; i<arr.length; i++)
		{	
			var str = arr[i];
			var idx = str.indexOf(':');			
			var op = {};
			op.name = str.substring(0, idx);
			op.status = str.substring(idx + 1);
			
			rst.add(op);				
		}
		
		if (rst.length == 0)
			return null;
		else
			return rst;
	}
	finally
	{
		rst = _str = arr = str = idx = i = op = null;
	}	
}


LWFP.innerApi.checkValue2Decimal = function(_val)
{	
	try
	{
		if (null == _val)
			return 0;
			
		var result = 0;
		var arr = _val.split(",");
		for(var i=0; i<arr.length; i++)
		{
			if ( arr[i] != "")
				result += parseInt(arr[i], 2);
		}
			
		return result;		
	}
	finally
	{
		result = arr = i = null;
	}
}

LWFP.innerApi.Decimal2checkValue = function(_dec, _len)
{
	try
	{	
		if (_dec == null || _dec == 0) 
			return "";
		var str = "0000000000";
		var bin = _dec.toString(2);
		var result = ",";
		for(var i=0; i<bin.length; i++)
		{
			var tmp = bin.substr(i,1);
			if (tmp == 1)
			{
				tmp = tmp + str.substr(0, bin.length - 1 - i);
				tmp = str.substring(0, _len-tmp.length) + tmp;
				result += tmp + ",";
			}
			
		}	
		
		return result;
	}
	finally
	{
		str = bin = result = tmp = i = null;
	}
}

LWFP.innerApi.String2Arr = function(str, spliter, includeBlank)
{
	try
	{
		if (str == null)
			return null;
			
		var _str = str.Trim();
		if (_str == "")
			return null;
		
		var _ret = new Array();		
		var _arr = _str.split(spliter);
		for(var i=0; i<_arr.length; i++)
		{
			if (includeBlank)
				_ret.add(_arr[i]);
			else if (_arr[i].Trim() != "")
				_ret.add(_arr[i].Trim());
		}
		
		if (_ret.length>0)
			return _ret;
		else
			return null;
		
	}
	finally
	{
		_str = _ret = _arr = i = null;
	}
}
LWFP.innerApi.Arr2String = function(arr, spliter)
{
	try
	{
		if (arr == null || arr.length == 0)
			return null;
		
		var str = "";
		for(var i=0; i<arr.length; i++)		
			str += arr[i] + spliter;
		
		str = str.substring(0, str.length-1);
		
		return str;		
	}
	finally
	{
		arr = str = spliter = i = null;
	}
}
LWFP.innerApi.ExtractFileName = function(filename)
{
	try
	{
		var remain = filename;
		var idx = remain.indexOf('.');
		if (idx<0)
			return '';
		
		while(idx > -1)
		{
			remain = remain.substring(idx + 1);
			idx = remain.indexOf('.');		
		}
		
		return '.' + remain;		
	}
	finally
	{
		remain = idx = null;
	}
}

LWFP.innerApi.getZWAttachment = function(wfdata, tabcode)
{
	try
	{
		if (!wfdata || !wfdata.attachments)
			return null;
		
		for(var i=0; i<wfdata.attachments.length; i++)
		{
			var t = wfdata.attachments[i];
			if (t.atttype<0)
			{
				if (tabcode == t.tabcode)
				{
					return t;
				}
				/*if (tabcode != null)
				{
					if (tabcode == t.tabcode)
						return t;
				}
				else
				{
					return t;
				}*/
			}
		}
		
		return null;
	}
	finally
	{
		i = t =  null;
	}
}
LWFP.innerApi.getFileFilter = function(n)
{	
	try
	{
		var _ftype = "";
		var _ftypedesc = "";
		
		var binStr = n.toString(2); 
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += '*.doc;*.docx;';
			_ftypedesc += "*.doc;*.docx;";
		}
		
		binStr = (n>>1).toString(2);
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += '*.wps;';
			_ftypedesc += "*.wps;";
		}
		
		binStr = (n>>2).toString(2);
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += '*.pdf;';
			_ftypedesc += "*.pdf;";
		}		
		
		binStr = (n>>3).toString(2);
		if (binStr.substring(binStr.length -1) == "1")
		{
			_ftype += '*.ceb;*.cebx;';
			_ftypedesc += "*.ceb;*.cebx;";
		}
		
		binStr = (n>>4).toString(2);
		if (binStr.substring(binStr.length -1) == "1")
		{
			_ftype += '*.ofd;';
			_ftypedesc += "*.ofd;";
		}
		
		return {type:_ftype, desc:_ftypedesc};
	}
	finally
	{
		_cv = _ftype = _ftypedesc = null;
	}	
}			

LWFP.innerApi.getFileFilter2 = function(n)
{	// |ofd|ceb|pdf|wps|doc|
	try
	{
		var _ftype = "";
		var _ftypedesc = "";
		
		var binStr = n.toString(2); 
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += 'doc,docx,';
			_ftypedesc += "|*.doc|*.docx";
		}
		
		binStr = (n>>1).toString(2);
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += 'wps,';
			_ftypedesc += "|*.wps";
		}
		
		binStr = (n>>2).toString(2);
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += 'pdf,';
			_ftypedesc += "|*.pdf";
		}
		
		binStr = (n>>3).toString(2);
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += 'ceb,cebx,';
			_ftypedesc += "|*.ceb|*.cebx";
		}
		
		binStr = (n>>4).toString(2);
		if (binStr.substring(binStr.length -1) == "1")	
		{
			_ftype += 'ofd,';
			_ftypedesc += "|*.ofd";
		}
				
		return {type:_ftype, desc:_ftypedesc};
	}
	finally
	{
		_cv = _ftype = _ftypedesc = null;
	}	
}			

LWFP.innerApi.getFileType = function(n)
{
	try
	{
		var s = n.toLowerCase();
		var t;
		if (s.endWith('.doc') || s.endWith('.docx'))
			t = -9;
		else if (s.endWith('.wps') || s.endWith('.xls') || s.endWith('.xlsx') )
			t = -8
		else if (s.endWith('.pdf'))
			t = -6;
		else if (s.endWith('.ceb') || s.endWith('.cebx'))
			t = -4;
		else if (s.endWith('.ofd'))
			t = -2;
				
		return t;
	}
	finally
	{
		s = t = null;
	}
}		

LWFP.innerApi.getcid = function(_instance)
{
	try
	{
		var s = _instance.substring(_instance.indexof("cid"), _instance.length);
		s = s.replace(']','');
		return s;
	}
	finally
	{
		s = null;
	}
}

LWFP.innerApi.getmodule = function(element)
{
	if (element == null)
		return null;
		
	if (typeof(element) == "string")
	{
		return PageObjectModel.getModule(element);
	}
	else if (element.getAttribute("instance") != null)
	{
		return PageObjectModel.getModule(element.getAttribute("instance"));			
	}
	
	return null;	
}

LWFP.innerApi.clone = function(o)
{
	try
	{
		var r = null;
		
		if (o != null)
		{	
			if (o instanceof Array)
			{
				r = [];
				for(var i=0; i<o.length; i++)
					r.add(LWFP.innerApi.clone(o[i]));
			}
			else
			{
				r = {};
					
				for(var k in o)
				{
					if (o[k] != null && typeof(o[k]) == "object" )
					{
						if (o[k] instanceof Array)
						{			
							r[k] = [];
							for(var i=0; i<o[k].length; i++)
								r[k][i] = LWFP.innerApi.clone(o[k][i]);
						}
						else
						{
							r[k] = LWFP.innerApi.clone(o[k]);
						}
					}
					else
					{
						r[k] = o[k];
					}
				}
			}
		}
		
		return r;
	}
	finally
	{
		r = i = null;
	}	
};

/**
 * 多插件编辑同一个意见时，合并提交意见清单
 * @param {} left 左侧插件值
 * @param {} right 右侧插件值
 * @param {} history 原始意见
 * @return {}
 */
LWFP.innerApi.megerOpinion = function(left, right, history)
{
	try
	{	
		var hash = new hashtable(); //mdid hash
		var hash_left = new hashtable();
		var hash_right = new hashtable();
		var hash_his = new hashtable();
		
		if (hash_left != null)
		{
			for(var i=0; i<left.length; i++)
			{
				hash.add(left[i].mdid, left[i].mdid);
				hash_left.add(left[i].mdid, left[i].opinions);
			}
		}
		
		if (hash_right != null)
		{
			for(var i=0; i<right.length; i++)
			{
				hash.add(right[i].mdid, right[i].mdid);
				hash_right.add(right[i].mdid, right[i].opinions);
			}
		}
		
		if (history != null)
		{
			for(var i=0; i<history.length; i++)
			{
				var _ops = history[i].opinions;
				
				for(var k=0; k<_ops.length; k++)
				{
					var _op = _ops[k];
					if (_op.id)
						hash_his.add(_op.id, _op);
				}
			}
		}
		
		var result = [];
		for(var key in hash.keys) //按mdid构造group数组
		{
			var mdid = hash.getkey(key);
			var ops_left = hash_left.getvalue(key);
			var ops_right = hash_right.getvalue(key);
			
			var group = {mdid:mdid};			
			if (ops_left != null && ops_right != null)  
			{//两边都有，需合并
				var ret = [];
				
				var h_l = new hashtable();
				var h_r = new hashtable();
				//先把新增和删除的加进去, 顺便hash修改的
				for(var i=0; i<ops_left.length; i++)
				{
					var op = ops_left[i];
					if (op.opiniontype == 1)
						h_l.add(op.id, op);
					else
						ret.add(op);
				}
				for(var i=0; i<ops_right.length; i++)
				{
					var op = ops_right[i];
					if (op.opiniontype == 1)
						h_r.add(op.id, op);
					else
						ret.add(op);
				}
				
				//处理左边修改的
				var h = new hashtable();
				for(var _key in h_l.keys)
				{
					var id = h_l.getkey(_key);
					var op = h_l.getvalue(_key);
					
					if (h_r.contains(_key) == false)
					{//只有左边有
						ret.add(op);
					}
					else
					{//两边都有 判断用哪个
						var op_r = h_r.getvalue(_key);	
						var op_his = hash_his.getvalue(id);
						
						var change_l = (op_his.opinioncontent != op.opinioncontent);
						var change_r = (op_his.opinioncontent != op_r.opinioncontent);
						
						if (change_l == false && change_r == false) //两边都没变化
						{}
						else if (change_l == true && change_r == false) //左边改了
						{
							ret.add(op);
						}
						else if (change_l == false && change_r == true) //右边改了
						{
							ret.add(op_r);
						}
						else
						{	//两边都改了已后改的为准
							if (op_r._edit_time > op._edit_time)
								ret.add(op_r);
							else
								ret.add(op);
						}
					}
				}
				
				//处理右边修改的
				for(var _key in h_r.keys)
				{					
					var op = h_r.getvalue(_key);					
					if (h_l.contains(_key) == false)
					{//只有右边有
						ret.add(op);
					}
					else{//两边都有时上面处理左边时已经处理了，此处不用处理
					}
				}
				
				group.opinions = ret;
			}
			else
			{//只有一边有				
				group.opinions = (ops_left == null)?ops_right:ops_left;
			}
			
			result.add(group);
		}		
		
		return result;
	}
	finally
	{
		hash = hash_left = hash_right = hash_his = i = _ops = k = _op = result = key = mdid = ops_left = ops_right = group = 
		ret = h_l = h_r = op = h = _key = id = op_r = op_his = change_l = change_r = null;
	}
}

/**
 * 按环节、部门分组流程意见
 
 	参数：
		 	groups:
					 [{groupName: "分组名称1",
					   groupSteps: "分组包含环节名称 ["stepname1", "stepname2"...]
					 	}, ...
					 ]
			workflow: 流程数据对象(this.workflow)
			
			
	return:
			[{groupName:"分组名称1",
			  groupSteps: "分组包含环节名称 ["stepname1", "stepname2"...]
				datas:[{organid:"部门id", organname:"部门名称", opinoins:意见数组}, ... ]
			 }...
			]

 */
LWFP.API.GroupOpinions = function(groups, wfdata)
{
	try
	{
		var ops = wfdata.getOpinions();
		if (ops == null)
			return groups;
		
		//先按step+organ分组hash意见
		//hash h1 key:stepname val: [organid]
		//hash h2 key:stepname + organid val [op]			
		var h1 = new hashtable();
		var h2 = new hashtable();			
		for(var i=0; i<ops.length; i++)
		{
			var arr = ops[i].opinions;
			if (arr == null)
				continue;
				
			for(var k=0; k<arr.length; k++)
			{
				var op = arr[k];
				
				var key1 = op.categoryUniqueName;
				if (!h1.contains(key1))
				{
					h1.add(key1, [op.organid]);						
				}
				else
				{
					var _arr_orgid = h1.getvalue(key1);
					if (_arr_orgid.indexOf(op.organid) <0 )
					{
						_arr_orgid.add(op.organid);
					}
				}
				
				var key2 = op.categoryUniqueName + op.organid;
				if (!h2.contains(key2))
				{
					h2.add(key2, [op]);
				}
				else
				{
					var _arr_op = h2.getvalue(key2);
					_arr_op.add(op);
				}
			}			
		}
		
		//按指定分组整理
		for(var i=0; i<groups.length; i++)
		{
			var group = groups[i];
			var hashData = new hashtable();
			
			for(var k=0; k<group.groupSteps.length; k++)
			{
				var stepname = group.groupSteps[k];
				var orgids = h1.getvalue(stepname);
				if (orgids != null)
				{
					for(var M=0; M<orgids.length; M++ )
					{
						var orgid = orgids[M];
						
						var arrOps = h2.getvalue(stepname + orgid);
						if (arrOps != null)
						{
							if (!hashData.contains(orgid) )
							{
								hashData.add(orgid, {organid:orgid, organname:arrOps[0].organname, opinoins:arrOps});
							}
							else
							{
								var obj = hashData.getvalue(orgid);
								obj.opinoins.addall(arrOps);
							}							
						}
					}
				}					
			}
			
			var datas = [];
			for(key in hashData.keys)
			{
				datas.add(hashData.getvalue(key));
			}
			
			if (datas.length > 0)
				group.datas = datas;
		}
		
		return groups;		
	}
	finally
	{
		ops = h1 = h2 = i = arr = k= op = key1 = _arr_orgid = key2 = _arr_op = group = stepname = orgids = M=orgid = arrOps = obj = datas = null;
	}		
}
	
	
LWFP.API.getWorkflow = function(domain)
{	
	if (domain && domain.parentPageModule && domain.parentPageModule.getWorkflow)
		return domain.parentPageModule.getWorkflow();
	else
		return null;
}

/**
 * 获取标签页信息 
 * @param {} tabcode 标签页代码
 * @param {} domain	当前作用域
 * @return {}
 */
LWFP.API.getUITabInfo = function(tabcode, domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.getUITabInfo)
		return domain.parentPageModule.getUITabInfo(tabcode);
		
	return null;
}

/**
 * 创建附加标签页 
 * @param {} tabinfos 标签信息, 如：[{name:'企业基本信息', type:9, code:'t97', module:'lbcplwfpoveroffice', mode:'insert', data:data}]
 * @param {} domain 当前作用域
 */
LWFP.API.createAddtionalTabUI = function(tabinfos, domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.createAddtionalTabUI)
		return domain.parentPageModule.createAddtionalTabUI(tabinfos);
}

/**
 *清除标签页 
 * @param {} tabCodes 标签页代码清单数组,如：['code1', 'code2',...]
 * @param {} domain 当前作用域
 */
LWFP.API.removeTabUI = function(tabCodes, domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.removeTabUI)
		return domain.parentPageModule.removeTabUI(tabCodes);
}

/**
 * 设置当前活动标签
 * @param {} tabcode 活动标签代码
 * @param {} domain 当前作用域
 */
LWFP.API.setActiveTabUI = function(tabcode, domain)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.setActiveTabUI)
		return domain.parentPageModule.setActiveTabUI(tabcode);	
}


/**
 * 绑定标签页数据
 * @param {} tabcode 标签页代码
 * @param {} data	数据
 * @param {} domain	当前作用域
 * @param {} pageMode 模式 insert modify
 * @return {}
 */
LWFP.API.setTabUiPageData = function(tabcode, data, domain, pageMode)
{
	if (domain && domain.parentPageModule && domain.parentPageModule.setTabUiPageData)
		return domain.parentPageModule.setTabUiPageData(tabcode, data, pageMode);
}

/**
标签式表单定义：
标签属性说明：
	name:标签名
	type:类型
	code:代码，流程内唯一，不可变更，流程版本更新时需继承过去
	step:首次显示该标签页的环节名称, 仅type=3,9时生效, type=3时必须
	viewtype:显示类型，0一直显示 1仅指定环节显示 2记录存才显示, 默认0
	module:加载模型名，仅type=3,9时生效
	foreignkey:外键名称，该外键指向主表单ID，仅type=3时生效，必须
	mode: 表单模式(insert, modify, view),仅type=9时生效
	remarktype:备注类型，0显示意见1显示环节备注，默认0， 仅type=10时生效
	remarktitle:备注标题，默认:"办理意见"， 仅type=10时生效	
	isDefault:是否默认显示标签,true时默认显示
	

	扩展表单和附加表单的区别：
		扩展表单——流程负责自动保存数据和加载数据，扩展表单在新增的时候要求必填
		附加表单——流程只负责自动保存数据，表单展现、加载数据等逻辑需自行实现，不为必填
		附加模型——流程只负责加载模型，不负责保存数据和其他逻辑
	
	{"tabs":[	{"name":"流程表单", "type":1,	"code":"t0", "isDefault":true},
	 	     	{"name":"正文",     "type":2,	"code":"t1"}, 
	 	  		{"name":"扩展正文", "type":4,	"code":"t99"},
	 	  		{"name":"扩展表单", "type":3,	"code":"t2", "step":"领导审批", "module":"lbcplwfpoveroffice", "foreignkey":"fkey"},
	 	  		{"name":"附加表单", "type":9,	"code":"t97", "module":"lbcplwfpoveroffice", "mode":"insert"},
	 	  		{"name":"附加模型", "type":15,	"code":"t9999", "module":"lbcplwfpoveroffice"},
	 			{"name":"流程历程", "type":"10",	"code":"t10", "remarktype":1, "remarktitle":"处理情况"},
	 			{"name":"流程附件", "type":"11",	"code":"t11"}
	 			{"name":"关联件",   "type":"12",	"code":"t12"}
	 		]}
*/
LWFP.innerApi.getTabInfo = function(wfdata, _tabuiparam)
{
	try
	{
		var tabuiparam = null;
		if (_tabuiparam != null && _tabuiparam.Trim() != "")
			tabuiparam = JSON.parse(_tabuiparam);
			
		if (tabuiparam == null || tabuiparam.tabs == null || tabuiparam.tabs.length ==0)
			return null;
			
		
		var h_view = new hashtable(); //需要展现的表单
		//先缓存主表单和正文表单
		for(var i=0; i<tabuiparam.tabs.length; i++)	
		{
			var tab = tabuiparam.tabs[i];
			if (tab.type == 1 || tab.type == 2 || tab.type == 4)
				h_view.add(tab.code, tab);
		}
		
		//再缓存已有记录的扩展表单
		if (wfdata.exRecords != null)
		{
			for(var i=0; i<wfdata.exRecords.length; i++)
			{
				var r = wfdata.exRecords[i];
				var code = r.modulecode;
				
				for(var k=0; k<tabuiparam.tabs.length; k++)
				{
					var tmp =  tabuiparam.tabs[k];
					if (tmp.code == code)
					{
						if (tmp.viewtype != 1 || (tmp.viewtype==1 && wfdata.CSID == r.hsid) ) 
						{
							tmp._datamodule = r.datamodule;
							tmp._recordid = r.recordid;
							tmp._hsid = r.hsid;
							if (wfdata.CSID == r.hsid)
								tmp.mode = "modify";
							else
								tmp.mode = "view";		
							
							h_view.add(code, tmp);
						}
						
						break;
					}
				}				
			}
		}
			
		//再缓存本环节定义的扩展表单和其他表单
		for(var i=0; i<tabuiparam.tabs.length; i++)
		{
			var _tab = tabuiparam.tabs[i];
			if (_tab.type == 10 || _tab.type == 13 || _tab.type == 11 || _tab.type == 12)
			{
				h_view.add(_tab.code, _tab);
			}
			else if (_tab.type == 9)
			{
				if ( (_tab.step == null) 
					|| (wfdata.step && wfdata.step.stepname == _tab.step) )
				{
					h_view.add(_tab.code, _tab);
				}
			}
			else if (_tab.type == 3)			
			{					
				if (!h_view.contains(_tab.code) && wfdata.step && wfdata.step.stepname == _tab.step)
				{
					_tab.mode = 'insert';
					h_view.add(_tab.code, _tab);
				}
			}
		}
		
		var arr = []; //结果清单		
		for(var i=0; i<tabuiparam.tabs.length; i++)
		{
			var __tab = tabuiparam.tabs[i];
			if (h_view.contains(__tab.code))
			{
				__tab = h_view.getvalue(__tab.code);
				arr.add(__tab);
			}
		}
			
		return {tabs:arr};
	}
	finally
	{
		tabuiparam = h_view = i = tab = r = code = k = tmp = _tab = arr = __tab = null;
	}	
}

LWFP.API.getTabInfosByType = function(domain, ttype)
{
	try
	{
		if (!domain || !domain.workflow)
			return null;
			
		var WF_Data = domain.workflow.getData();
		if (!WF_Data)
			return null;
			
		var param = WF_Data.flow.tabuiparam;
		if (!param)
			return null;
		
		var tabuiparam = JSON.parse(param);
			
		if (tabuiparam == null || tabuiparam.tabs == null || tabuiparam.tabs.length ==0)
			return null;
		
		var arr = [];
		for(var i=0; i<tabuiparam.tabs.length; i++)	
		{
			var tab = tabuiparam.tabs[i];
			if (tab.type == ttype)
				arr.add(tab);
		}
		
		if (arr.length == 0)
			arr = null;
			
		return arr;
	}
	finally
	{
		WF_Data = param = tabuiparam = arr = tab = null;
	}	
}


/*
 LWFP.innerApi.getTabInfo = function(wfdata)
{
	try
	{
		var tabuiparam = null;
		if (wfdata.flow.tabuiparam && wfdata.flow.tabuiparam.Trim() != "")
			tabuiparam = JSON.parse(wfdata.flow.tabuiparam);
			
		if (tabuiparam == null || tabuiparam.tabs == null || tabuiparam.tabs.length ==0)
			return null;
		
		var arr = [];
		var h = new hashtable();
		var _h = new hashtable();
		
		//先加主表单和正文表单
		for(var i=0; i<tabuiparam.tabs.length; i++)	
		{
			var tab = tabuiparam.tabs[i];
			if (tab.type == 1 || tab.type == 2 || tab.type == 4)
				arr.add(tab);
			else
				h.add(tab.code, tab);
		}
		
		//再加已有记录的扩展表单
		if (wfdata.exRecords != null)
		{
			for(var i=0; i<wfdata.exRecords.length; i++)
			{
				var r = wfdata.exRecords[i];
				var code = r.modulecode;
				if (h.contains(code))
				{
					var t = h.getvalue(code);
					if (t.viewtype != 1 || (t.viewtype==1 && wfdata.CSID == r.hsid) )
					{
						t._datamodule = r.datamodule;
						t._recordid = r.recordid;
						t._hsid = r.hsid;
						if (wfdata.CSID == r.hsid)
							t.mode = "modify";
						else
							t.mode = "view";		
						
						arr.add(t);
						_h.add(code, t);
					}					
				}
			}
		}
			
		//再加本环节定义的扩展表单和其他表单
		for(var i=0; i<tabuiparam.tabs.length; i++)
		{
			var tab = tabuiparam.tabs[i];
			if (tab.type == 10)
			{
				arr.add(tab);
			}
			else if (tab.type == 9)
			{
				if ( (tab.step == null) 
					|| (wfdata.step && wfdata.step.stepname == tab.step) )
				{
					arr.add(tab);
				}
			}
			else if (tab.type == 3)			
			{					
				if (!_h.contains(tab.code) && wfdata.step && wfdata.step.stepname == tab.step)
				{
					tab.mode = 'insert';
					arr.add(tab);
				}
			}
		}
		
			
		return {tabs:arr};
	}
	finally
	{
		tabuiparam = arr = h = _h = i = tab = r = code = t = null;	
	}	
}
 
 
 */

/**
 * 图片签名类
 * @type 
 */
LWFP.innerApi.SignImg = {};
LWFP.innerApi.SignImg.Cache = new hashtable(); //图片签名缓存
LWFP.innerApi.SignImg.getSignImg = function(userflag, element)//获取图片签名
{
	if (LWFP.innerApi.SignImg.Cache.contains(userflag))
	{
		return LWFP.innerApi.SignImg.Cache.getvalue(userflag);
	}
	else
	{
		LEAP.wfrouter.getRouter(element);
		var img = LEAP.routerRequest('WfSignImgGet', {userflag:userflag});
		
		LWFP.innerApi.SignImg.Cache.add(userflag, img);
		
		return img;
	}	
}


LWFP.innerApi.Postil = {lasttime:0, postils:null};
LWFP.innerApi.getPostil = function(par)
{
	var now = new Date().getTime()
	var t = now - LWFP.innerApi.Postil.lasttime;
	if (LWFP.innerApi.Postil.lasttime == 0 || t > 60 * 1000 )
	{
		var postils = null;		
		par.pageSize = par.pageSize - 0;
		if (par.pageSize != 0)			
		{
			var postils = LEAP.routerRequest('WfGetAllLwfpPostil', {searchParameters : par});
		}
		
		LWFP.innerApi.Postil.postils = postils;
		LWFP.innerApi.Postil.lasttime = now;
	}
	
	return LWFP.innerApi.Postil.postils;
}


/**
 archmode 归档方式 0分表（默认）1分库 
 archtype:归档类型，分表归档（0:按年 1:按月 9:不按时间分表统一归到基表）
 */
LWFP.innerApi.archConfig = null; //{isarch:false, archmode:0, archtype:0};
LWFP.innerApi.getArchConfig = function(domain)
{
	if (LWFP.innerApi.archConfig == null)
	{
		var router = (domain && domain.leapclient)?domain.leapclient.router:null;		
		LWFP.innerApi.archConfig = LEAP.request2({router:router, name:'WfGetArchConfig'});
	}
	
	return LWFP.innerApi.archConfig;
}
LWFP.API.getArchConfig = function(domain)
{
	return LWFP.innerApi.getArchConfig(domain);
}
LWFP.innerApi.getArchCategory = function(def, domain)
{
	if (def.isarch != null && def.isarch == 1 && def.entryCreatetime != null)
	{
		var config = LWFP.innerApi.getArchConfig(domain);
		
		var category = null;
		if (config.archtype == 0)
		{
			category = def.entryCreatetime.substring(0,4);
		}
		else if (config.archtype == 1)
		{
			category = def.entryCreatetime.replaceall('-','').substring(0,6);
		}
		
		def.archCategory = category;	
	}
	
	return def;	
}


/**
 * 运行界面管理
 */
LWFP.FormManager = new Object();
LWFP.FormManager.cache = null;
LWFP.FormManager.regist = function(ins, module, caller, callback, type)
{
	if (LWFP.FormManager.cache == null)
		LWFP.FormManager.cache = new hashtable();
	
	LWFP.FormManager.cache.add(LWFP.innerApi.getcid(ins), {form:ins, module:module, caller:caller, callback:callback, type:type});		
}
LWFP.FormManager.clear = function()
{
	try
	{
		if (LWFP.FormManager.cache != null && LWFP.FormManager.cache.count != null && LWFP.FormManager.cache.count>0)
		{
			var keys = LWFP.FormManager.cache.keys;
			for(var key in keys)
			{
				var _value =  LWFP.FormManager.cache.getvalue(key);
				if (_value.type == 1)
				{
					LEAP.form.close(_value.form);
					LWFP.FormManager.cache.remove(key);
				}
			}
		}	
	}
	finally
	{	
		keys = key = _value = null;
	}
}
LWFP.FormManager.callback = function(handle, args)
{
	if (handle == null)
		return;
	if (LWFP.FormManager.cache == null)
		return;
		
	try
	{
		if (LWFP.FormManager.cache.contains(LWFP.innerApi.getcid(handle)))
		{
			var _form = LWFP.FormManager.cache.getvalue(LWFP.innerApi.getcid(handle));
			if (_form != null && _form.callback != null && _form.caller != null)
			{
				if (args != null)
				{
					if (_form.callback.length > 0)
						_form.callback.apply(_form.caller, [args]);
					else
						_form.callback.apply(_form.caller);
				}
				else
				{
					_form.callback.apply(_form.caller);
				}
			}
		}
	}
	catch(e)
	{
	}
	finally
	{
		_form == null;
	}
}
LWFP.FormManager.formHided = function(args)
{
	try
	{
		if (args && args.arg2 && args.arg2.removeTaskItem != null && args.arg2.removeTaskItem)
		{
			var cid = LWFP.innerApi.getcid(args.arg2.form);		
			if (LWFP.FormManager.cache.contains(cid) )
			{
				var _form = LWFP.FormManager.cache.getvalue(cid);
				var pm = _form.module.parentPageModule;
				var hc1 = _form != null && _form.module != null && _form.module.dispose != null;
				
				var hc2 = _form != null && _form.module != null && _form.module.__hasCallback==false 
							&& _form.module.parentPageModule != null && _form.module.parentPageModule.onWFFromHide != null;
				
				var hc3 = _form != null && _form.module != null 
				&& _form.module.getCurrentStepForm() != null && _form.module.getCurrentStepForm().onWFFromHide != null;
				
				if (hc3)
					_form.module.getCurrentStepForm().onWFFromHide();
				
				if (hc1)
					_form.module.dispose();
				
				if (hc2)
					pm.onWFFromHide();
				
				pm = _form = null;
				LWFP.FormManager.cache.remove(cid);				
			}
		}
	}
	finally
	{
		cid = null;
	}
}



/**
 * WFParameter 流程参数
 */
var WFParameter = function(){this.javaClass = "com.longrise.LWFP.BLL.Object.WFParams";};
WFParameter.prototype.javaClass = "com.longrise.LWFP.BLL.Object.WFParams";
WFParameter.prototype.getParameter = function(wfData)
{	
	if (wfData == null || wfData.entry == null)
	{
		this.entryId = null;
		this.delegate = null;
	}
	else
	{
		this.entryId = wfData.entry.entryid;
		this.delegate = wfData.delegate; 	
		this.datasource = wfData.datasource; 
	}
	
	return this;
}
WFParameter.prototype.setBusinessNo = function(businessNo)
{
	if(businessNo == null || businessNo.Trim() == '')
		this.businessNo = null;
	else
	{		
		businessNo += "";
		this.businessNo = businessNo;
	}
	return this;	
}
WFParameter.prototype.setEntryId = function(entryId)
{
	this.entryId = entryId;
	return this;
}
WFParameter.prototype.setCsid = function(csid)
{
	this.csid = csid;
	return this;
}
WFParameter.prototype.setHsid = function(hsid)
{
	this.hsid = hsid;
	return this;
}
WFParameter.prototype.setOwner = function(owner)
{
	if (owner == null || owner.length==0)
		this.owner = null;
	else
		this.owner = owner;

	return this;
}
WFParameter.prototype.setNextOwner1 = function(nextOwner)
{
	if (nextOwner == null || nextOwner.length==0)
		this.nextOwner1 = null;
	else
		this.nextOwner1 = nextOwner;

	return this;
}
WFParameter.prototype.setNextOwner2 = function(nextOwner)
{
	if (nextOwner == null || nextOwner.length==0)
		this.nextOwner2 = null;
	else
		this.nextOwner2 = nextOwner;

	return this;
}
WFParameter.prototype.setNextOwner3 = function(nextOwner)
{
	if (nextOwner == null || nextOwner.length==0)
		this.nextOwner3 = null;
	else
		this.nextOwner3 = nextOwner;

	return this;
}

WFParameter.prototype.setNextSplitOwners = function(nextSplitOwners)
{
	if (nextSplitOwners == null || nextSplitOwners.length==0)
		this.nextSplitOwners = null;
	else
		this.nextSplitOwners = nextSplitOwners;

	return this;
}

WFParameter.prototype.setOptionName = function(optionName)
{
	this.optionName = optionName;
	return this;
}
WFParameter.prototype.setRemind = function(remind)
{
	this.remind = remind;
	return this;
}
WFParameter.prototype.setDataModuleName = function(dataModuleName)
{
	this.dataModuleName = dataModuleName;
	return this;
}
WFParameter.prototype.setRecordId = function(recordId)
{
	this.recordId = recordId;
	return this;
}
WFParameter.prototype.setDelegater = function(delegate)
{
	this.delegate = delegate;
	return this;
}
WFParameter.prototype.setNextActionName = function(nextActionName)
{
	this.nextActionName = nextActionName;
	return this;
}
WFParameter.prototype.setTopOrgan = function(topOrgan)
{
	this.topOrgan = topOrgan;
	return this;
}
WFParameter.prototype.setSmallNote = function(smallNote)
{
	this.smallNote = smallNote;
	return this;
}
WFParameter.prototype.setLimitDate = function(limitDate)
{
	this.limitDate = limitDate;
	return this;
}
WFParameter.prototype.setAlermtime = function(alermtime)
{
	this.alermtime = alermtime;
	return this;
}
WFParameter.prototype.setAttachments = function(attachments)
{
	this.attachments = attachments;
	return this;
}
WFParameter.prototype.setBranchJoinId = function(branchJoinId)
{
	this.branchJoinId = branchJoinId;
	return this;
}
WFParameter.prototype.setLazy = function(lazy)
{
	this.lazy = lazy;
	return this;
}
WFParameter.prototype.setLazyid = function(lazyid)
{
	this.lazyid = lazyid;
	return this;
}
WFParameter.prototype.setLazysyscode = function(lazysyscode)
{
	this.lazysyscode = lazysyscode;
	return this;
}
WFParameter.prototype.setLazyout = function(lazyout)
{
	this.lazyout = lazyout;
	return this;
}
WFParameter.prototype.setSubFlowBusinessid = function(subFlowBusinessid)
{
	this.subFlowBusinessid = subFlowBusinessid;
	return this;
}





var WFRecParams = function(){this.javaClass = "com.longrise.LWFP.BLL.Object.RecordParams";};
WFRecParams.prototype.javaClass = "com.longrise.LWFP.BLL.Object.RecordParams";
WFRecParams.prototype.setType = function(_type)
{
	this.type = _type;
	return this;
}
WFRecParams.prototype.setDelegate = function(_delegater)
{
	this.delegater = _delegater;
	return this;
}
WFRecParams.prototype.setBusinessNo = function(_businessNo)
{
	this.businessNo = _businessNo;
	return this;
}
WFRecParams.prototype.setcsid = function(_csid)
{
	this.csid = _csid;
	return this;
}
WFRecParams.prototype.setActionId = function(_actionId)
{
	this.actionId = _actionId;
	return this;
}
WFRecParams.prototype.setFlowOptionId = function(_flowOptionId)
{
	this.flowOptionId = _flowOptionId;
	return this;
}
WFRecParams.prototype.setEntryId = function(_entryId)
{
	this.entryId = _entryId;
	return this;
}
WFRecParams.prototype.getEntryId = function()
{
	return this.entryId;
}
WFRecParams.prototype.sethsid = function(_hsid)
{
	this.hsid = _hsid;
	return this;
}
WFRecParams.prototype.setPageModule = function(_pageModule)
{
	this.pageModule = _pageModule;
	return this;
}
WFRecParams.prototype.setStartRecordId = function(_startRecordId)
{
	this.startRecordId = _startRecordId;
	return this;
}
WFRecParams.prototype.setOpinions = function(_opinions)
{
	this.opinions = _opinions;
	return this;
}
WFRecParams.prototype.setAttachments = function(_attachments)
{
	this.attachments = _attachments;
	return this;
}
WFRecParams.prototype.setWfparams = function(_wfparams)
{
	this.wfparams = _wfparams;
	return this;
}
WFRecParams.prototype.setDocnumbers = function(_docnumbers)
{
	this.docnumbers = _docnumbers;
	return this;
}
WFRecParams.prototype.setExBeans = function(_exBeans)
{
	this.exBeans = _exBeans;
	return this;
}
WFRecParams.prototype.setModifyPkid = function(_modifyPkid)
{
	this.modifyPkid = _modifyPkid;
	return this;
}
WFRecParams.prototype.setChangeData = function(_changeData)
{
	this.changeData = _changeData;
	return this;
}
WFRecParams.prototype.setPreOwner = function(_preOwner)
{
	this.preOwner = _preOwner;
	return this;
}



//运行时数据
var LWFPWorkFlow = function(){this.___data = null;};
LWFPWorkFlow.prototype.Create = function(wfData)
{
	this.___data = wfData;
	this.___extendParam = null;
	this.___isNew = false;
	return this;
}
LWFPWorkFlow.prototype.Create2 = function(wfData, action)
{
	this.___data = wfData;
	this.action = action;
	return this;
}
LWFPWorkFlow.prototype.setProperty = function(name, value)
{
	this[name] = value;
	return this;
}
LWFPWorkFlow.prototype.setExtendParam = function(extendParam)
{
	this.___extendParam = extendParam;
	return this;
}
LWFPWorkFlow.prototype.getExtendParam = function()
{
	return this.___extendParam;
}
LWFPWorkFlow.prototype.setIsNew = function(isNew)
{
	this.___isNew = isNew;
	return this;
}
LWFPWorkFlow.prototype.getIsNew = function()
{
	return this.___isNew;
}
LWFPWorkFlow.prototype.setPreEntryid = function(preEntryid)
{
	this.___preEntryid = preEntryid;
	return this;
}
LWFPWorkFlow.prototype.getPreEntryid = function()
{
	return this.___preEntryid;
}

LWFPWorkFlow.prototype.getData = function() //
{
	return this.___data;
}
LWFPWorkFlow.prototype.getEntry = function() //获取流程实例
{
	if (this.___data && this.___data.entry)
		return this.___data.entry;
	else
		return null;
}
LWFPWorkFlow.prototype.getBusinessNo = function() //获取事项编号
{
	if (this.___data && this.___data.businessNo)
		return this.___data.businessNo;
	else
		return null;
}
LWFPWorkFlow.prototype.getEventCode = function() //获取流水号
{
	if (this.___data && this.___data.entry)
		return this.___data.entry.eventcode;
	else return null;
}
LWFPWorkFlow.prototype.getStep = function() //获取当前环节定义
{
	if (this.___data)
		return this.___data.step;
	else
		return null;
}
LWFPWorkFlow.prototype.getStepName = function() //获取当前环节名称
{
	if (this.___data && this.___data.step)
		return this.___data.step.stepname;	
	else
		return null;
}
LWFPWorkFlow.prototype.getEnterAction = function() //获取当前步骤进入动作
{
	if (this.___data && this.___data.currentStep && this.___data.currentStep.enteractionid)
		return LWFP.innerApi.getAction(this.___data.flow.actions, this.___data.currentStep.enteractionid);
	else
		return null;
}
LWFPWorkFlow.prototype.getCurrentStep = function() //获取当前办理步骤
{
	return this.___data.currentStep;	
}
LWFPWorkFlow.prototype.getIsFirstStep = function() //是否第一个步骤
{	
	if (this.___data)
	{
		if (this.___data.historySteps == null)
			return true;
		else
			return false;
	}	
	return null;
}
LWFPWorkFlow.prototype.hasStart = function() //流程是否启动
{
	if (this.___data && this.___data.entry)
		return true;
	else
		return false;
}
LWFPWorkFlow.prototype.hasFinished = function() //流程是否办结
{
	if (this.___data && this.___data.entry && this.___data.entry.state == 1)
		return true;
	else
		return false;
}
LWFPWorkFlow.prototype.getCurrentRecord = function() //获取当前表单
{	
	return this.___data.recordBean;		
}
LWFPWorkFlow.prototype.getCurrentRecordId = function() //获取当前表单记录
{
	if (this.___data.recordBean != null && this.___data.recordBean.primaryBean != null)
	{
		return this.___data.recordBean.primaryBean[LWFP.ENUM.WFBean_lwfp_businessPkId];
	}
		
	return null;		
}
LWFPWorkFlow.prototype.getPrevStep = function() //获取前一步骤
{
	if (this.___data.currentStep != null && this.___data.currentStep.prevId)
	{
		return LWFP.innerApi.getHistoryStepByHSID(this.___data.historySteps, this.___data.currentStep.prevId);
	}
	return null;
}
LWFPWorkFlow.prototype.getPrevStepRecord = function() //获取前一步骤表单记录
{
	try
	{
		if (this.___data.currentStep != null && this.___data.currentStep.prevId)
		{
			var prev = LWFP.innerApi.getHistoryStepByHSID(this.___data.historySteps, this.___data.currentStep.prevId);
			if (prev != null)
			{
				return LEAP.routerRequest("WfSearchHistoryRecord", {stepid:prev.stepid, recordId:prev.recid, archCategory:null,entryid:prev.entryid});
			}		
		}
		
		return null;		
	}
	finally
	{
		prev = null;
	}
}
LWFPWorkFlow.prototype.getFirstStepRecordId = function() //获取首环节表单记录ID
{
	if (this.___data != null && this.___data.historySteps != null)
	{
		for(var i=0; i<this.___data.historySteps.length; i++)
		{
			if (this.___data.historySteps[1].realrecid != null)
				return this.___data.historySteps[1].realrecid;		
		}	
	}
		
	return null;		
}
LWFPWorkFlow.prototype.getRuntimeVaribleList = function() //获取运行时变量清单
{
	if (this.___data != null && this.___data.varible != null && this.___data.varible.length>0)
		return this.___data.varible;
	else
		return null;
}
LWFPWorkFlow.prototype.getRuntimeVarible = function(varname) //根据变量名获取运行时变量值
{
	try
	{
		if (varname == null)
			return null;
		var arr = this.getRuntimeVaribleList();
		if (arr != null)
		{
			for(var i=0; i<arr.length; i++)
			{
				if (arr[i].name.toLowerCase() == varname.toLowerCase())
					return arr[i].value;
			}
		}
		
		return null;
	}
	finally
	{
		arr = i = null;
	}
}
LWFPWorkFlow.prototype.getExtendParameters = function() //获取扩展参数
{
	return this.___data.__extendParam;
}
LWFPWorkFlow.prototype.getModuleParam = function() //获取表单参数
{
	return this.___data.flow.moduleparam
}
LWFPWorkFlow.prototype.getOpinions = function() //获取表单意见
{
	return LWFP.innerApi.clone(this.___data.opinions);
}
LWFPWorkFlow.prototype.getLastCurrentOpinions = function(mdid) //获取当前用户当前环节最后一条意见
{	
	try
	{	
	 	var ret = null;
		if (this.___data.opinions && this.___data.currentStep)
		{
			for(var i=0; i<this.___data.opinions.length; i++)
			{
				var group = this.___data.opinions[i];
				if (group.mdid == mdid)
				{
					for(var k=group.opinions.length-1; k>=0; k--)
					{
						var op = group.opinions[k];
						if (op.category == this.___data.currentStep.csid)
						{
							ret = op;
							break;
						}
					}
					
					break;
				}
				
			}
		}		
	
		return ret;
	}
	finally
	{
		ret = i = group = k = op = null;
	}
}
LWFPWorkFlow.prototype.getHistorysteps = function() //获取历史步骤清单
{
	return this.___data.historySteps;
}
LWFPWorkFlow.prototype.getCurrentSteps = function() //获取待办步骤清单
{
	return this.___data.curSteps;
}
LWFPWorkFlow.prototype.getHistoryStepById = function(HSID) //获取某步骤
{
	try
	{
		var ret = LWFP.innerApi.getCurrentStepByCSID(this.getCurrentSteps(), HSID);
		if (ret == null)
			ret = LWFP.innerApi.getHistoryStepByHSID(this.getHistorysteps(), HSID);
		
	
		return ret;
	}
	finally
	{
		ret = null;
	}
}
LWFPWorkFlow.prototype.getAttachments = function() //获取当前流程实例附件清单
{
	return this.___data.attachments;
}
LWFPWorkFlow.prototype.setAttachments = function(attachments) //设置当前流程实例附件清单（无法提交到数据库，仅供显示用）
{
	this.___data.attachments = attachments;
}



/**
 * 根据进入动作名向上追溯步骤，返回进入动作名为指定动作的步骤
 * @param {} actionName
 * @param {} startStep
 * @return {}
 */
LWFPWorkFlow.prototype.traceStepByEnterAction = function(actionName, startStep)
{
	if (startStep == null)
		startStep = this.___data.currentStep;			
	if (startStep == null)
		return null;
	
	var action = LWFP.innerApi.getActionByName(this.___data.flow.actions, actionName);
	if (action == null)
		return null;
					
	var rst = null;
	var tmp = startStep;
	while (rst == null)
	{
		if (tmp == null || tmp.prevId == null)
			break;
		
		if (tmp.enteractionid == action.actionid)
		{
			rst = tmp;
			break
		}
		else
		{
			tmp = LWFP.innerApi.getHistoryStepByHSID(this.___data.historySteps, tmp.prevId);			
		}
	}
	
	return rst;
}

LWFPWorkFlow.prototype.findHistoryStep = function(stepName, enterActionName, outActionName)
{
	if (!this.___data.historySteps && !this.___data.curSteps)
		return null;
		
	var ret = null;
	for(var i=0; i<this.___data.historySteps.length; i++)
	{
		var tmp = this.___data.historySteps[i];
		if ( (!stepName || (stepName && stepName==tmp.stepname) )
				&& (!enterActionName || (enterActionName && enterActionName==tmp.enteractionname) )
				&& (!outActionName || (outActionName && outActionName==tmp.outactionname) )
			)
		{
			ret = tmp;
			break;
		}
	}
	
	return ret;
}


//		enteractionname	"签收"	String

//end api **************************************************************************************************************************


LWFP.Global = {};
LWFP.Global.uploadPath = {};
LWFP.Global.uploadPath._att_uploadPath = "default";
LWFP.Global.uploadPath._scan_uploadpath = "default2";
LWFP.Global.uploadPath.getAttachmentUploadPath = function()
{
	return LWFP.Global.uploadPath._att_uploadPath; 
}
LWFP.Global.uploadPath.setAttachmentUploadPath = function(path)
{
	LWFP.Global.uploadPath._att_uploadPath = path;
}
LWFP.Global.uploadPath.getScanUploadPath = function()
{
	return LWFP.Global.uploadPath._scan_uploadpath; 
}
LWFP.Global.uploadPath.setScanUploadPath = function(path)
{
	LWFP.Global.uploadPath._scan_uploadpath = path;
}


LWFP.ENUM = {
 	WFBean_lwfp_recordId: "wfbean_lwfp_recordid",
 	WFBean_lwfp_businessPkCol: "wfbean_lwfp_businesspkcol",
	WFBean_lwfp_businessPkId: "wfbean_lwfp_businesspkid",
	WFBean_lwfp_serviceName: "wfbean_lwfp_servicename",
	form_closed_after_submit:"form_closed_after_submit"
};

//activex
LWFP.Activex = {};
//LWFP.Activex.LUPL = null;
LWFP.Activex.LCAPT = null;
LWFP.Activex.getUploadActivex = function()
{
	/*if (LWFP.Activex.LUPL == null)
	{
		window.LoadUploadActivex = 1;
		LWFP.Activex._LoadActivex();
	}
	
	return LWFP.Activex.LUPL;*/
	
	return LWFP.Activex.getCaptureActivex();
}
LWFP.Activex.getCaptureActivex = function()
{
	if (LWFP.Activex.LCAPT == null)
	{
		window.LoadCaptureActivex = 1;
		LWFP.Activex._LoadActivex();
	}
	
	return LWFP.Activex.LCAPT;
}
document.write('<SCRIPT language=javascript event=OnHandwriteComplete(a,b,c,d,e) for=handwriter type=text/javascript>LEAP.capture.handwriteCompleted(a, b, c, d, e); </SCRIPT>  ');
LWFP.Activex.LoadActivex  = function()
{
	if (document != null && document.body != null)
		LWFP.Activex._LoadActivex();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.Activex._LoadActivex);
}
LWFP.Activex._LoadActivex = function()
{
	if (!LWFP.Activex.LCAPT && LEAPBrowser.isIE == true && (document.documentElement.getAttribute('LoadCapActivex') || window.LoadCaptureActivex==1))
	{
		try
		{
			var div = document.createElement("div");
			div.style.position = "absolute";
			div.style.top = "0px";
			div.style.left = "0px";
			div.style.height = "1px";
			div.style.width = "1px";
			div.innerHTML="<OBJECT id='_global_lcapt' ut='_global_lcapt' classid='clsid:441C8E75-6069-4D17-B09F-0C878CB6819B' display='none' sc='resource' resource.att='CODEBASE' width=1 height=1></OBJECT>";
						
			document.body.appendChild(div);		
			
			LWFP.Activex.LCAPT = document.getElementById("_global_lcapt");
		}
		catch(e){}
		
		
		
		
		//LWFP.Activex.update0();
		//setTimeout(LWFP.Activex.update, 100);
	}
	
	UIEventManager.removeEvent(window, 'load', LWFP.Activex.LoadActivex);
}

LWFP.Activex.update0 = function()
{
	var a = '';
	try
	{
		var a = LWFP.Activex.LCAPT._getVersion();
	}
	catch(e){}			
	
	if (a != "")
	{
		if (a < "1.0.2.0")
		{
			LWFP.Activex.LCAPT = null;
			
			var _form = LEAP.form.create3({name:null, title:'提示', width:600, height:300, formtype:3});				
			if (_form != null)
			{
				var str = '<div style="height:100%; width:100%; text-align:center;">';
					str += '<div style="margin:20px 0px 50px 0px; font-size:18px; color:#FF0000;">系统插件已更新，请点击下面的链接下载最新的插件安装程序并安装 :</div>';
					str += '<a style="color:#0000FF; font-size:30px;" href="' + leapconfig.server + 'LEAP/LWFP/HTML/activex/ActivexSetup.exe">点击此处下载</a>';
					str += '</div>'
			
				LEAP.form.setContent(_form.form, str);
				LEAP.form.show(_form.form);
			}
		}
		else
		{	
			setTimeout(LWFP.Activex.update, 100);
		}
	}
}

LWFP.Activex.update = function()
{
	try
	{
		if (window.activexupdated == 1)
			return;
			
		if (LWFP.Activex.LCAPT == null)
			return;
		
		var a = '';
		try
		{
			var a = LWFP.Activex.LCAPT._getVersion();
		}
		catch(e){}			
		
		if (a != '')
		{				
			var v = "LStart.exe|1.0.3.3," ;
			v+= "LComb.exe|1.0.3.3," ;			
			v+= "LCAPTUDP.exe|1.0.3.0," ;
			v+= "LDSM.exe|1.0.3.3," ;
			v+= "LUPL.exe|1.0.3.3," ;
			v+= "LDocViewer.exe|1.0.3.1," ;
			v+= "LCAPT.ocx|1.0.3.2," ;
			v+= "LDoc.exe|1.0.3.3,";
			v+= "LNET.ocx|1.0.0.17";
				
			LWFP.Activex.LCAPT._update(leapconfig.server + 'LEAP/LWFP/HTML/activex/', v);								
		}
		
		window.activexupdated = 1;
	}
	catch(e){}
}
	
LWFP.Activex.LoadActivex();

		

LWFP.Activex.ActivexType = {scanner:1, handsign:2, word:3, wps:4, pdf:5, ceb:7,lupl:6};
LWFP.Activex.ActivexStatus = {scanner:0, handsign:0, word:0, wps:0, pdf:0, lupl:0};
LWFP.Activex.ActivexDetect = function(_type, showmsg)
{
    try
    {
    	if (LEAPBrowser.isIE == true){}else return false; 
    	
    	var step = 0;
    	if (_type == LWFP.Activex.ActivexType.scanner)
    	{
    		if (LWFP.Activex.ActivexStatus.scanner == 1) return true;
			var obj = new ActiveXObject('LDSM.LRScanner');
			LWFP.Activex.ActivexStatus.scanner = 1;
    	}
		else if (_type == LWFP.Activex.ActivexType.handsign)
		{
			if (LWFP.Activex.ActivexStatus.handsign == 1) return true;
			var obj = new ActiveXObject('LRHS.LRHandsign');
			LWFP.Activex.ActivexStatus.handsign = 1;
		}
		else if (_type == LWFP.Activex.ActivexType.lupl)
		{
			if (LWFP.Activex.ActivexStatus.lupl == 1) return true;
			var obj = new ActiveXObject('LUPL.LUPLX');
			LWFP.Activex.ActivexStatus.lupl = 1;
		}
		else if (_type == LWFP.Activex.ActivexType.word)
		{
			if (LWFP.Activex.ActivexStatus.word == 1) return true;
			//var obj = new ActiveXObject('LONGRISE.OfficeControl');
			//obj = null;
			//step = 1;
			//obj = new ActiveXObject("word.Application");
			LWFP.Activex.ActivexStatus.word = 1;
		}
		else if (_type == LWFP.Activex.ActivexType.wps)
		{
			if (LWFP.Activex.ActivexStatus.wps == 1) return true;
			/*var obj = new ActiveXObject('LONGRISE.OfficeControl');
			obj = null;
			step = 1;
			obj = new ActiveXObject("wps.Application");*/
			LWFP.Activex.ActivexStatus.wps = 1;
		}
		else if (_type == LWFP.Activex.ActivexType.pdf)
		{
			if (LWFP.Activex.ActivexStatus.pdf == 1) return true;
			if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
			{
				var obj = new ActiveXObject('iStylePDF.Application');
			}
			else
			{
				var obj = new ActiveXObject('iWebPDF.PDFReader');
			}
			
			LWFP.Activex.ActivexStatus.pdf = 1;
		}
		else if (_type == LWFP.Activex.ActivexType.ceb)
		{
			if (LWFP.Activex.ActivexStatus.ceb == 1) return true;
			var obj = new ActiveXObject('CEBVIEWER.CEBViewerCtrl.1');
			LWFP.Activex.ActivexStatus.ceb = 1;
		}
		
       	return true;
    }
    catch(e)
    {
    	if(showmsg == null)
    		showmsg = true;
    	
    	if(showmsg == true)
		{
    		var msg = "该操作需要相关插件支持，请安装相关插件后重试！";
        	var download = true;
        	if (_type == LWFP.Activex.ActivexType.word)
        	{
        		if (step == 1)
        		{
        			msg = "检测到您的电脑未安装word程序，请安装后重试！";
        			download = false;
        		}
        	}
        	else if (_type == LWFP.Activex.ActivexType.wps)
    		{
    			if (step == 1)
        		{
        			msg = "检测到您的电脑未安装wps程序，请安装后重试！";
        			download = false;
        		}
    		}
    		
    		alert(msg);    	
        	
    		//if (download == true)
    		//	window.open (window.geturl(leapconfig.server + "LEAP/LWFP/HTML/Default/capture/ActivexDown.html"), "newwindow", 'resizable=1,menubar=1,location=0,status=0,toolbar=1,top=0,left=0,height='+screen.availHeight+',width='+screen.availWidth);
		}
    	
       	return false;        
    }
    finally
    {
    	obj = null;	
    }
}

LWFP.__openBlankWindow = function()
{
	var __s1 = "location";
	var __s2 = "href";
	if (LEAPBrowser && LEAPBrowser.isIE == true && window[__s1][__s2].toLowerCase().indexOf('index.html') > -1
		&& window.opener && window.opener.location && window.opener.location.href && window.opener.location.href.toLowerCase().indexOf('nav.html')>-1 )
	{			
		window.setTimeout(function(){window.open(leapconfig.server + "LEAP/LWFP/HTML/blank.html", "", "location=1");}, 10);
	}
}
//LWFP.__openBlankWindow();




/**
 *表单属性说明
 *
 *autoConverZWToPDF  		//是否自动生成PDF版本正文, 默认false
 *WFPdfPageDoccumentField 	//设置了该字段即认为需要显示pdf签批列表，该字段用来存储pdf签批表单清单
 *WFAttachmentTitleNowrap	//附件列表中附件标题是否不换行，默认true
 *WFToolbarPosition			//0:toolbar在上方 1:toolbar在下方，默认0
 *WFToolbarShowMore			//1：toolbar显示更多按钮
 */

/**
 *表单方法
 * WFGenerateWordPage 
 * boolean WFBeforeSend() 发送功能校验
 * boolean WFActionValidate(actionName) 动作合法校验 
 * getSubflowTransAttachments(atts)
 * WFBeforeBindOpinions(opinions)
 * WFBeforeSubmit() 
 * WFBeforeSubmitOpinions(opinions)
 * WFGetDocnumberValue
 * WFIsActionAutoSend(___action)
 * WFGetCCUserRange(arg)   //return {organRange:"", roleRange:"部门经理"};

 * WFRelatedEntrySearch()
 * OnWfuiTabDocumentLoad({tabInfo:arg.arg.tabInfo, documentView:arg.caller}
 * OnWfAttachmentDownload({attachment:arg.arg2})
 * WFAfterSave 
 */




LWFP.Config = {openFlowInWorkarea:0};

/**
 * 打开流程启动界面
 * @param {} def
 * 		businessNo 	事项编号 必须
 * 		delegate   	代理信息
 * 		extendParam	扩展参数
 * 		container   流程界面容器
 * 		formtype	3弹出 4滑出
 * 		maxsize  true最大化
 * 		callBackFunc 回调函数
 * 		otherRouter 其他路由,如果指定了其他路由则优先使用其他路由
 * 		title 标签页模式打开时自定义标题
 * @param {} domain
 */
LWFP.API.StartFlow = function(def, domain)
{
	LWFP.debug();
	try
	{
		if (LEAP.getUserInfo().userflag == "super")
		{
			alert("当前用户无权限操作流程！");
			return;
		}
		var WF_Data = LWFP.innerApi.getWFRunningData(domain, true, null, def.businessNo, def.delegate, null, def.otherRouter);					  
		if (WF_Data == null || WF_Data.flow == null)
		{
			//alert('数据加载失败，请检查流程配置！');
			return;
		}
		
		if (WF_Data.module == null)
		{
			alert("获取流程模型配置信息失败，请检查流程配置！");
			return;
		}
		
		if (WF_Data.flow.uimodule == "ModuleProcess")
		{
			var modulename = WF_Data.module.modulename;
			var mode = "insert";
			var preEntryid = UUID.randomUUID().replaceall('-', '');
			var workflow = new LWFPWorkFlow().Create(WF_Data).setIsNew(true).setPreEntryid(preEntryid)
											 			.setExtendParam({extendParam:def.extendParam, callBackFunc:def.callBackFunc});			
			if (LWFP.Config.openFlowInWorkarea == 1)
			{
				var title = def.title;
				if(!title)
					title = LWFP.API.ModuleProcess.__getTitle(WF_Data);				
				var module = LEAP.modulebar.addModuleBar(title, preEntryid,  {path:modulename, pageMode:mode, 
								moduleLoadArg:{workflow:workflow}, domain:domain, closeCallback:def.closeCallbackFunc, 
								router:def.otherRouter, holdParent:def.holdParent,reload:false});
				
				return module;
			}
			else if (def.container == null)
			{
				LWFP.API.__clearCache(domain, modulename);
				
				var form = domain.forms(modulename, mode, {workflow:workflow }, null, 
										(def.formtype==null)?3:def.formtype, def.otherRouter
								);
				if (form)
				{
					LWFP.API.ModuleProcess.__setTitle.call(form.module);
					form.module._wf_formshow = 1;
					form.show();
					
					if (def.maxsize == true)
						LEAP.form.maxSize(form.form);
						
					//domain.addEvent(form.form, "formHided", LWFP.API.__OnWfFormHided, {instance:form.module.instance}, false, domain);
				}
				
				return form;
			}
			else
			{
				var module = domain.loadModule2({name:modulename, parent:def.container, moduleLoadArg:{workflow:workflow }});
				return module;
			}	
		}
		else
		{
			return LWFP.innerApi.loadForm(def.container, true, WF_Data, def.delegate, def.callBackFunc, domain, def.extendParam, def.otherRouter);
		}
	}
	finally
	{
		WF_Data = modulename = mode = workflow = form = module = null;
	}

}

/**
 * 打开流程启动界面_新浏览器窗口
 * @param {} def, 格式如下：
  				{ businessNo:事项编号  			
	  			  extendParam:扩展参数
	  			  callBackFunc:回调函数	 }
	  				
 * @param {} domain
 */
LWFP.API.StartFlow_newWindow = function(def, domain)
{
	def.isNew = true;
	var router = def.otherRouter;
	if (router == null)
		router = (domain && domain.leapclient)?domain.leapclient.router:null;
	def.otherRouter = router;
		
	LWFP.innerApi.CreateWFWindow(domain, def);
}



/**
 * 打开流程
 * @param {} def
 * 			entryId 
 * 			csid
 * 			delegate
 * 			isarch 是否已归档 
 * 			entryCreatetime 实例创建时间，如果指定了isarch和entryCreatetime，则无需指定archCategory
 * 			archCategory 归档年、月份分类
 * 			extendParam
 * 			maxsize  true最大化
 * 			formtype	3弹出 4滑出
 * 			callBackFunc 回调函数
 * 			closeCallbackFunc
 * 			otherRouter 其他路由,如果指定了其他路由则优先使用其他路由
 * 			title 标签页模式打开时自定义标题
 * @param {} domain
 */
LWFP.API.OpenFlow = function(def, domain)
{
	LWFP.debug();
	try
	{
		if (LEAP.getUserInfo().userflag == "super")
		{
			alert("当前用户无权限操作流程！");
			return;
		}
		
		var WF_Data = def.WF_Data;
		if (WF_Data == null)
		{
			def = LWFP.innerApi.getArchCategory(def);			
			WF_Data = LWFP.innerApi.getWFRunningData(domain, false, def.entryId, def.csid, def.delegate, def.archCategory, def.otherRouter);	
		}
		
		if (WF_Data == null || WF_Data.flow == null)
		{
			/*var err = leapclient.getLastWarring();
			if (err == null)
				err = "";
			err = '数据加载失败！' + err;
			alert(err);*/

			return;
		}
		
		if (WF_Data.flow.uimodule == "ModuleProcess")
		{		
			if (WF_Data.module)
			{			
							
				var modulename = WF_Data.module.modulename;
				var mode = "insert";
				var workflow = new LWFPWorkFlow().Create(WF_Data).setIsNew(false)
													 			.setExtendParam({extendParam:def.extendParam, callBackFunc:def.callBackFunc, closeCallbackFunc:def.closeCallbackFunc});
				
				if (LWFP.Config.openFlowInWorkarea == 1 && def.notInWorkarea != true)
				{
					var reload = false;
					if (def.extendParam && def.extendParam.continuity == 1)
					{//连续办件时不管
					}
					else
					{//非连续办件时，掐断
						
						var oldModule = null;
						if (LEAP.modulebar && LEAP.modulebar.getModuleByItemID)					
						{
							oldModule = LEAP.modulebar.getModuleByItemID(WF_Data.entry.entryid); 
						}
						if (oldModule && oldModule.workflow && oldModule.workflow.___extendParam && oldModule.workflow.___extendParam.extendParam)
						{
							oldModule.workflow.___extendParam.extendParam.continuity = null;
						}
						if (oldModule)
						{
							reload = true;
						}
					}
					
					var title = def.title;
					if(!title)
						title = LWFP.API.ModuleProcess.__getTitle(WF_Data);				
					var module = LEAP.modulebar.addModuleBar(title, WF_Data.entry.entryid,  {path:modulename, pageMode:mode, 
										moduleLoadArg:{workflow:workflow}, domain:domain, closeCallback:def.closeCallbackFunc, 
										router:def.otherRouter, holdParent:def.holdParent, reload:reload});					
					module.superDelegate = domain.superDelegate;
					
					return module;
				}
				else if (def.container == null)
				{	
					LWFP.API.__clearCache(domain, modulename);
					
					var form = domain.forms(modulename, mode, {workflow:workflow }, null, 
											(def.formtype==null)?3:def.formtype, def.otherRouter);
					if (form)
					{
						LWFP.API.ModuleProcess.__setTitle.call(form.module);
						
						form.module.superDelegate = domain.superDelegate;
						form.module._wf_formshow = 1;
						form.show(form.module.pageMode);
						
						if (def.maxsize == true)
							LEAP.form.maxSize(form.form);
						
						//domain.addEvent(form.form, "formHided", LWFP.API.__OnWfFormHided, {instance:form.module.instance}, false, domain);
					}
					
					return form;
				}
				else
				{
					var module = domain.loadModule2({name:modulename, parent:def.container, moduleLoadArg:{workflow:workflow }});
					module.superDelegate = domain.superDelegate;
					
					return module;
				}
			}
			else
			{
				alert('您没有查看该事务的权限！');
				return null;
			}
		}
		else
		{
			return LWFP.innerApi.loadForm(def.container, false, WF_Data, def.delegate, def.callBackFunc, domain, def.extendParam, def.otherRouter);
		}
	}
	finally
	{
		WF_Data = err = modulename = mode = workflow = form = null;
	}
}


LWFP.API.__clearCache = function(domain, modulename)
{
	try
	{
		if (domain && domain.___forms2 && domain.___forms2.contains(modulename.toLowerCase()))
		{
			var form = domain.___forms2.getvalue(modulename.toLowerCase());
			if (form != null)
			{
				if (form.module)
				{
					if (form.module.dispose)
	            		form.module.dispose();
	            		
	            	form.module = null;
				}
				
				domain.___forms2.remove(modulename.toLowerCase());
			}
		}
	}
	catch(e)
	{}
	finally
	{
		form = null;
	}
	
}

/*LWFP.API.__OnWfFormHided = function(arg)
{
	try
	{
		var module = PageObjectModel.getModule(arg.arg.instance);			
		if (module != null)
		{
			var name = module.name.toLowerCase();
			var form = this.___forms2.getvalue(name);
			if (form != null )
			{
				if (form.module)
				{
					if (form.module.dispose)
	            		form.module.dispose();
	            		
	            	form.module = null;
				}
				
				this.___forms2.remove(name);
			}
		}		
	}
	finally
	{
		module = name = form = null;
	}
}*/

/**
 * 打开流程_新浏览器窗口
 * @param {} def 格式：
 			  {entryId:实例ID
	  			csid:当前步骤ID
	  			delegate:代理
	  			isarch 是否已归档
				entryCreatetime 实例创建时间，如果指定了isarch和entryCreatetime，则无需指定archCategory
				archCategory 归档年、月份分类
	  			extendParam:扩展参数
	  			callBackFunc:回调函数	 }
 * @param {} domain
 */
LWFP.API.OpenFlow_newWindow = function(def, domain)
{
	def.isNew = false;
	LWFP.innerApi.CreateWFWindow(domain, def);
}



LWFP.API.___OpenSubflow = function(maincsid, mainData, domain)
{	//TODO 测试
	setTimeout(function()
	{
			var arr = LWFP.innerApi.getNextSteps(maincsid, mainData.curSteps, mainData.historySteps, null);
			if (arr != null)
			{
				for(var i=0; i<arr.length; i++)
				{
					if (arr[i].subflowentry != null)
					{
						LWFP.API.OpenFlow({entryId:arr[i].subflowentry}, domain); 
						break;
					}
				}
			}
			arr = null;

	}, 0);
}

LWFP.API.__closeMainFlowModule = function(parentDomain, subFLowDomain)
{
	try
	{
		var subInstance = subFLowDomain.instance;
		for(key in parentDomain.___forms2.keys)
		{
			var form = parentDomain.___forms2.getvalue(key);
			if (form && form.module && form.module.instance != subFLowDomain.instance &&
				form.module.autoCloseAfterDoSubFlow == true)
			{
				if (form.module.dispose)
	            		form.module.dispose();
	            		
	            form.module = null;

	            parentDomain.___forms2.remove(key);	
			}
		}
	}
	catch(err)
	{
	}
	finally
	{
	
	}
}

LWFP.API.ModuleProcess = new Object();
LWFP.API.ModuleProcess.process = function(domain)
{	
	if (!domain || !domain.workflow)
		return;
		
	if (domain && domain.workflow && domain.workflow.dontloadworkflow == true)
		return;
		
	if (domain._wf_formshow == 1 )
	{
		if (domain._wf_has_pro == 1)
		{
			domain._wf_has_pro = null;
			return;
		}
	}
	else
	{
		domain._wf_formshow = null;
		domain._wf_has_pro = 1;
	}
	
	domain.workflow.___processstate = 0;
	
	domain._WF_ModuleProcess_beforeSetPageData = LWFP.API.ModuleProcess.beforeSetPageData;
			
	domain._WF_ModuleProcess_process = LWFP.API.ModuleProcess.innerProcess;
	domain._WF_ModuleProcess_process_asyn = LWFP.API.ModuleProcess.innerProcess_asyn;
	domain._WF_ModuleProcess_initControl = LWFP.API.ModuleProcess.initControl;	
	domain._WF_ModuleProcess_refreshPage = LWFP.API.ModuleProcess.refreshPage;
	domain._WF_ModuleProcess_callback = LWFP.API.ModuleProcess.callback;	
	domain.setDownloadParameter = LWFP.API.ModuleProcess.setDownloadParameter;
	
	domain._WF_ModuleProcess_process.call(domain);
}

LWFP.API.ModuleProcess.innerProcess = function()
{
	if (this.workflow == null || this.workflow.___processstate == 1)
		return;
		
	//LEAP.asyn(this._WF_ModuleProcess_process_asyn, this, 50);
	this._WF_ModuleProcess_process_asyn();
}
LWFP.API.ModuleProcess.innerProcess_asyn = function()
{
	LWFP.debug();
	try
	{
		var WF_Data = this.workflow.___data;
		
		var extendParam = this.workflow.getExtendParam();	
		var WF_isNew = this.workflow.getIsNew();
		
		WF_Data.__extendParam = (extendParam == null) ? null : extendParam.extendParam;
			
		
		if (this.beforeLoadWorkflow)
			this.beforeLoadWorkflow();
		
		LWFP.API.ModuleProcess.__initTabUI.call(this);
		
		var pageMode = "insert";		
		//if (WF_Data.currentStep != null && WF_Data.currentStep.recid != null)
		if (WF_Data.recordBean != null)
			pageMode = "modify";
		if ((WF_Data.module && WF_Data.module.readonly == true) || (WF_Data.currentStep && WF_Data.currentStep.readstep ==1) )
			pageMode = "view";
			
		var WF_pageMode = "insert";
		if (WF_Data.currentStep != null && WF_Data.currentStep.recid != null)
			WF_pageMode = "modify";			
		if ((WF_Data.module && WF_Data.module.readonly == true) || (WF_Data.currentStep && WF_Data.currentStep.readstep ==1) )
			WF_pageMode = "view";

		this.pageMode = pageMode;	
		this.WF_pageMode = WF_pageMode;
		this.setWordTemplateValues = function(arg){this.__wordTemplateValues = arg};
		
		//处理表单提交参数
		var recParam = new WFRecParams();
			recParam.setPageModule(this.WF_pageMode);
			recParam.setDelegate(WF_Data.delegate);
			//recParam.setPageModule(this.pageMode);
		
		if (WF_Data.entry != null && WF_Data.entry.entryid != null)
			recParam.setEntryId(WF_Data.entry.entryid);
			
		if (WF_isNew == true || WF_Data.currentStep != null)
		{
			if (WF_Data.delegate != null)
				recParam.setDelegate(WF_Data.delegate);
		}
		
		if (WF_isNew == true)
		{	
			//recParam.setEntryId(UUID.randomUUID().replaceall('-', ''));			
			recParam.setEntryId(this.workflow.getPreEntryid());
			recParam.setType(1);
			recParam.setBusinessNo(WF_Data.businessNo);
			
			if (extendParam != null && extendParam.startRecordId != null)
			{
				recParam.setType(6);
				recParam.setStartRecordId(extendParam.startRecordId);
			}
		}
		else if (WF_Data.currentStep != null)
		{
			recParam.setType(2);
			recParam.setcsid(WF_Data.currentStep.csid);					
		}
		
		this.___LWFPDynaParameter = recParam;
				
		//意见晚绑定/参数
		LEAP.opinion.setPageAutoBinding(this.instance, this.moduleElement, false, (WF_Data.currentStep==null)?null:WF_Data.currentStep.csid);
		LEAP.opinion.enableHandsign(this.instance, this.moduleElement, WF_Data.flow.handsign);
		LEAP.opinion.setExtendParams(this.instance, this.moduleElement, {currentStep:WF_Data.currentStep, attachments:WF_Data.attachments});
				
		//绑定表单数据
		if (WF_Data.recordBean != null)
		{	
			this.workflow.processBindingData = true;
			
			LWFP.innerApi.getChildBeans(WF_Data.recordBean);			
			this.setPageDataOnWF(WF_Data.recordBean.primaryBean, WF_Data.recordBean.childBeans);
			
			this.workflow.processBindingData = false;
						
			this._WF_ModuleProcess_initControl();
		}
		else
		{
			this.clearPageData();
			this._WF_ModuleProcess_initControl();
		}

		this.WFMode = true;
		this.WFMode2 == true;
		this.innerWFModuleSubmit = LWFP.API.ModuleProcess.innerWFModuleSubmit;
		this.innerWFInsertSubmit = LWFP.API.ModuleProcess.moduleSubmit;
		this.innerWFModifySubmit = LWFP.API.ModuleProcess.moduleSubmit;
		this.childModuleSubmit = LWFP.API.ModuleProcess.childModifySubmit;
		
		this.___LwfpMchilds_insert = null;
		this.___LwfpMchilds_modify = null;
		this.___LwfpMchilds_delete = null;	

		if (this.afterLoadWorkflow)
		{			
			LEAP.asyn(this.afterLoadWorkflow, this, 20);
		}
		
		this.workflow.___processstate = 1;		
		
		//LWFP.API.ModuleProcess.autoSubmit(this, 10000, true);
	}
	finally
	{
		WF_Data = extendParam = WF_isNew = pageMode = recParam = null;
	}
}
/*
LWFP.API.ModuleProcess.autoSubmit = function(domain, inttime, autoRefresh)
{
	if (!this._____auto____ && (domain.pageMode == "modify" || domain.pageMode == "insert") )
	{
		this._____auto____ = true;
		LEAP.asyn(LWFP.API.ModuleProcess._autoSubmit, domain, inttime, inttime, autoRefresh);
	}
}

LWFP.API.ModuleProcess._autoSubmit = function(inttime, autoRefresh)
{
	var a = this.innerWFModuleSubmit({autoRefresh:autoRefresh});
	
	if (a != null)	
		LEAP.asyn(LWFP.API.ModuleProcess._autoSubmit, this, inttime, inttime, autoRefresh);
}*/

LWFP.API.ModuleProcess.beforeSetPageData = function(data)
{
	try
	{
		if (this.workflow != null && this.workflow.processBindingData == true)
		{
			return true;
		}
		else
		{
			var entryId = data.lwfp_entryid;
			if (entryId== null)
				entryId = data.wf_entry_id;
				
			var csid = data.lwfp_step_hsid;
			
			if (entryId == null && csid == null)
			{
				LEAP.messagebox.alert("获取流程实例ID参数失败，无法加载流程信息。")
				
				this.hideForm();
				return false;
			}
			
			var wfdata = LWFP.innerApi.getWFRunningData(this, false, entryId, csid, null, null);
			if (wfdata == null)
			{
				LEAP.messagebox.alert("获取流程实例信息失败，无法加载该流程信息。");
				
				this.hideForm();				
				return false;
			}
			
			this.workflow = new LWFPWorkFlow().Create(wfdata).setIsNew(false);	
			
			this._WF_ModuleProcess_process.call(this);
			
			return false;	
		}
	}
	catch(e)
	{
		return false;
	}
	finally
	{
		entryId = csid = wfdata = null; 
	}
}

LWFP.API.ModuleProcess.callback = function(operationParam)
{
	try
	{
		if (this.parentPageModule)
		{			
			if (this.workflow.getExtendParam() != null && this.workflow.getExtendParam().callBackFunc != null)
			{
				LEAP.asyn(this.workflow.getExtendParam().callBackFunc, this.parentPageModule, 50, operationParam);
			}
			else if (this.parentPageModule.innerRefreshPage)
			{
				LEAP.asyn(this.parentPageModule.innerRefreshPage, this.parentPageModule, 50);
			}
			else if (window.workflowFormCallback)
			{				
				LEAP.asyn(window.workflowFormCallback, this, 50, operationParam);
			}
		}
	}
	catch(e)
	{
	}
}
LWFP.API.ModuleProcess.refreshPage = function(tabIndex, csid, operationParam)
{
	try
	{
		this.__wf_refresh = true; //不再弹小纸条
		
		if (this.afterDoAction && operationParam && operationParam.key == "doaction")
		{
			try
			{
				this.afterDoAction({operationParam:operationParam});
			}
			catch(e){}
		}
		
		if (this.parentPageModule)
		{			
			LWFP.API.__closeMainFlowModule(this.parentPageModule, this);
			
			if (this.workflow.getExtendParam() != null && this.workflow.getExtendParam().callBackFunc != null)
			{
				var p = operationParam;
				if (p == null)
					p = {};
				p.extendParam = this.workflow.getExtendParam().extendParam;					
				LEAP.asyn(this.workflow.getExtendParam().callBackFunc, this.parentPageModule, 100, p);
			}
			else if (this.parentPageModule.innerRefreshPage)
			{	
				LEAP.asyn(this.parentPageModule.innerRefreshPage, this.parentPageModule, 100);
			}
			else if (window.workflowFormCallback)
			{				
				LEAP.asyn(window.workflowFormCallback, this, 100, operationParam);
			}
		}
		
		var WF_Data = this.workflow.___data;
		var WF_isNew = this.workflow.getIsNew();
		
		if (WF_Data.entry != null)
		{
			WF_Data = LWFP.innerApi.getWFRunningData(this, WF_isNew, WF_Data.entry.entryid, csid, null);
		}
		else
		{
			if (csid == null)
				WF_Data = LWFP.innerApi.getWFRunningData(this, WF_isNew, null, WF_Data.businessNo, null);
			else
				WF_Data = LWFP.innerApi.getWFRunningData(this, WF_isNew, null, csid, null);
		}
		
		if (WF_Data == null)
		{
			var err = leapclient.getLastWarring();
			if (err == null)
				err = ""
			err = "获取数据错误 " + err;
			alert(err);

			if (this.workflow.getExtendParam() != null && this.workflow.getExtendParam().closeCallbackFunc != null && this.parentPageModule)
				LEAP.asyn(this.workflow.getExtendParam().closeCallbackFunc, this.parentPageModule, 100, {workflow:this.workflow});
			
			this.__clearCache = true;
			
			/*if (LWFP.Config.openFlowInWorkarea == 1)
				LEAP.modulebar.closeModuleBar(WF_Data.entry.entryid, false);
			else
				this.hideForm();*/
			this[LWFP.ENUM.form_closed_after_submit] = true;
			if (LWFP.Config.openFlowInWorkarea == 1)
			{						
				//LEAP.modulebar.closeModuleBar(WF_Data.entry.entryid, false);
				LEAP.asyn(LEAP.modulebar.closeModuleBar, this, 50, WF_Data.entry.entryid, false);
			}
			else
			{
				//LEAP.form.hide(this.form);
				LEAP.asyn(LEAP.form.hide, this, 50, this.form);
			}
			
			return;
		}
		else
		{
			LWFP.API.ModuleProcess.__oprationChange.call(this, operationParam, WF_Data)
			
			var _close = false;
			if (WF_Data.nextActions == null && WF_Data.currentStep == null)// && WF_Data.module == null)
				_close = true;
			
			if (operationParam != null && operationParam.openSubflow == true)
			{	
				//LWFP.API.___OpenSubflow(operationParam.csid, WF_Data, this.parentPageModule);
				var __csid = operationParam.csid;
				LEAP.asyn(LWFP.API.___OpenSubflow, this, 150, __csid, WF_Data, this.parentPageModule);				
			}
			
			if (_close == true)
			{
				if (this.workflow.getExtendParam() != null && this.workflow.getExtendParam().closeCallbackFunc != null && this.parentPageModule)
					LEAP.asyn(this.workflow.getExtendParam().closeCallbackFunc, this.parentPageModule, 100, {workflow:this.workflow});
				
				this[LWFP.ENUM.form_closed_after_submit] = true;
				if (LWFP.Config.openFlowInWorkarea == 1)
				{						
					//LEAP.modulebar.closeModuleBar(WF_Data.entry.entryid, false);
					LEAP.asyn(LEAP.modulebar.closeModuleBar, this, 50, WF_Data.entry.entryid, false);
				}
				else
				{
					//LEAP.form.hide(this.form);
					LEAP.asyn(LEAP.form.hide, this, 50, this.form);
				}
			}
			else
			{	
				var exp = this.workflow.getExtendParam();
				
				this.workflow = new LWFPWorkFlow().Create(WF_Data).setIsNew(false);
				
				if (exp != null)
					this.workflow.setExtendParam(exp); //传递打开参数
				
				if (operationParam && operationParam.key == "savedata")
				{
					this.__refreshTab_zw = null;
				}
				else
				{
					this.__refreshTab_zw = true;
				}
					
				this._WF_ModuleProcess_process();
			}
		}		
	}
	finally
	{
		WF_Data = WF_isNew = err = _close = exp = null;
	}
}



LWFP.API.ModuleProcess.__oprationChange  = function(operationParam, WF_Data)
{
	if (!this.tabuiparam || !this.tabuiparam.hasExtab || this.tabuiparam.hasExtab != true)
		return;

	try
	{			
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		var labels = LEAP.tab.getTabLables(tabCtrl);
		if (labels == null)
			return;
				
		for(var i=0; i<labels.length; i++)
		{
			var lab = labels[i];
			var tabinfo = lab['wftabinfo'];
			
			if (tabinfo.type==1)
			{  
				if (this.afterWorkFlowOperation)
					this.afterWorkFlowOperation({newModuleData:WF_Data.recordBean, exData:WF_Data.exRecords, operation:operationParam});
			}
			else if (tabinfo.type==3 || tabinfo.type==9) 
			{	
				if (lab.getAttribute('hasfill') == "true" || lab.getAttribute('hasfill') == true)
				{				
					var exM = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));
					if (exM.afterWorkFlowOperation)
					{	
						exM.afterWorkFlowOperation({newModuleData:WF_Data.recordBean, exData:WF_Data.exRecords, operation:operationParam});
					}
				}				
			}
		}
		
	}
	finally
	{			
		tabCtrl = labels = i = lab = tabinfo =  exM = null;
	}	
}

LWFP.API.ModuleProcess.initControl = function()
{
	try
	{		
		var WF_Data = this.workflow.___data;
				
		if (this.pageMode != "view")
		{
			if (this.removeViewClass)
				this.removeViewClass();
		}
		
		//表单权限		
		if (this.____hasSaveAuth != true)
		{
			this.saveModuleAuthoritySatus();
			this.____hasSaveAuth = true;
		}
		
		this.resotreModuleAuthoritySatus();
		
		var auths = LWFP.innerApi.getModuleOptions(WF_Data.module, this.pageMode=="view" );
		LEAP.processModuleAuthority(this, this.moduleElement, auths, null, null);
		
		//
		var sendPanel = LEAP.getElement("[transct=SendPanel]", this.moduleElement);
		if (sendPanel)
		{
			LEAP.setRangeReadonly(sendPanel, false);
		}
		
		LWFP.API.ModuleProcess.__setAuth.call(this);		
		//绑定意见数据
		LEAP.opinion.setPageValue(this.instance, this.moduleElement, 
									 ( (this.WFBeforeBindOpinions) ? this.WFBeforeBindOpinions( {opinions:WF_Data.opinions}) : WF_Data.opinions) );
			
		//附件		
		var wordButton = (WF_Data.step != null && WF_Data.step.wordbuttons != null)?WF_Data.step.wordbuttons:null;
		var templateValues = this.wordTemplateValues;
		if (this.getWordTemplateValues)
			templateValues = this.getWordTemplateValues();
			
		if (window._showmark != '0')
			this.officeWaterMark = true;
			
		LEAP.attlist.setWordParams(this.instance, this.moduleElement, 
													{	officeWaterMark:this.officeWaterMark,
														ZWType:WF_Data.flow.atttype, 
														wordButton: wordButton, 
														templateValues:templateValues,
														businessNo:WF_Data.businessNo, 
														isCurrentstep:(WF_Data.step != null)?1:null, 
														curstep:WF_Data.currentStep, 
														templateValueFn:null,
														exParam2:{businessid:(WF_Data.entry!=null)?WF_Data.entry.businessid:null}});
			
		LEAP.attlist.setPageValue(this.instance, this.moduleElement, WF_Data.attachments, {currentStep:WF_Data.currentStep,zwInside:this.__zwInside});
		
		//设置下载等操作权限控制
		if (LEAP.buildOperation)
		{
			LEAP.buildOperation(this, this.moduleElement);
		}
		
		//关联件
		var relatedEntry = LEAP.getElement("[ct=RelatedEntry]", this.moduleElement);
		if (relatedEntry)
		{
			LEAP.RelatedEntry.setParams(relatedEntry, WF_Data.entry?WF_Data.entry.entryid:this.___LWFPDynaParameter.getEntryId(), WF_Data.currentStep, WF_Data.archCategory);
			var readonly = (WF_Data.currentStep==null || 
						(WF_Data.currentStep != null && WF_Data.currentStep.readstep==1) || 
						(WF_Data.entry != null && WF_Data.entry.state != 0) );
			if (WF_Data.entry == null )
				readonly = false;
			
			LEAP.RelatedEntry.insertEntrys(relatedEntry, WF_Data.relatedentrys, true, readonly);
		}
				
		//发送
		if (this.___autoRefreshTransControl != false)
			LEAP.trans.loadRunningData(this);
		
		this.___autoRefreshTransControl = true;
		
		LWFP.API.ModuleProcess.__setTitle.call(this);
	}
	finally
	{
		WF_Data = auths = wordButton = templateValues = null;
	}
}

LWFP.API.ModuleProcess.__getTitle = function(WF_Data)
{
	var title = "";		
	if (WF_Data.flow.aliasname != null && WF_Data.flow.aliasname != "")
		title = WF_Data.flow.aliasname;
	if (WF_Data.currentStep)
	{
		if (WF_Data.currentStep.readstep == 1)
			title = title + "(阅件)";
		else if (WF_Data.currentStep.stepaliasname)	
			title = title + "(" + WF_Data.currentStep.stepaliasname +")";
	}
	
		
	if (WF_Data.delegate != null && WF_Data.delegate.ownerName != null)
		title = title + "    代理【" + WF_Data.delegate.ownerName + "办理】";	
	
	return title;
}
LWFP.API.ModuleProcess.__setTitle = function()
{
	try
	{					
		var WF_Data = this.workflow.___data;
		
		var title = "";		
		if (WF_Data.flow.aliasname != null && WF_Data.flow.aliasname != "")
			title = WF_Data.flow.aliasname;
		if (WF_Data.currentStep)
		{
			if (WF_Data.currentStep.readstep == 1)
				title = title + "(阅件)";
			else if (WF_Data.currentStep.stepaliasname)	
				title = title + "(" + WF_Data.currentStep.stepaliasname +")";
		}
		
			
		if (WF_Data.delegate != null && WF_Data.delegate.ownerName != null)
			title = title + "    代理【" + WF_Data.delegate.ownerName + "办理】";			
				
		if (this.form)
			LEAP.form.setTitle(this.form, title);
		
		if (true == document._isNewWfWindow)
		{
			/*var t = "";
			if (WF_Data.entry != null && WF_Data.entry.eventname != null)
				t = WF_Data.entry.eventname;
			else if (WF_Data.flow.aliasname != null && WF_Data.flow.aliasname != "")
				t = WF_Data.flow.aliasname;
			
			document.title = t;*/
			document.title = title;
		}
	}
	finally
	{
		WF_Data = title = null;		
	}	
}

LWFP.API.ModuleProcess.__setAuth = function()
{
	try
	{		
		var WF_isNew = this.workflow.getIsNew();
		var WF_Data = this.workflow.___data;
		
		var readonly = false; //表单权限
		if ( ((WF_Data.currentStep != null && WF_Data.currentStep.readstep != 1) || WF_isNew==true) )
			readonly = false;
		else
			readonly = true;
			
		//附件
		var attElements = LEAP.getElements("div[ct=" + LEAP.attlist.d + "][instance=" + this.instance + "]", this.moduleElement);
		if (attElements != null)
		{	
			var attReadonly = true; 
			if (WF_Data.step != null && (WF_Data.step.attachmentreadonly == null || WF_Data.step.attachmentreadonly ==0)) 
				attReadonly = false;
				
			if (readonly == true)
				attReadonly = true;
			
			for(var i=0; i<attElements.length; i++)
			{
				var attEle = attElements[i];
				var change = true;
				if (attEle.getAttribute("readonly") == "true")
				{
					if (attEle.getAttribute("___isoparea_status") == "110")
					{
						change = false;
					}
					else
					{
						if (attReadonly == true)
							change = false;
						else
							change = true;
					}
				}
				else 
				{
					if (attReadonly == true)
						change = true
					else
						change = false;						
				}			
				
				if (change == true)
					LEAP.attlist.setReadOnly(attEle, attReadonly, true);
			}
		}
		
		//意见
		var opinionElements = LEAP.getElements("div[ct=" + LEAP.opinion.d + "][instance=" + this.instance + "]", this.formElement);
		if (opinionElements != null)
		{
			for(var i=0; i<opinionElements.length; i++)
			{
				var opinionEle = opinionElements[i];
				var change = true;
				if (opinionEle.getAttribute("readonly") == "1")
				{
					if (opinionEle.getAttribute("___isoparea_status") == "110")
					{
						change = false;
					}
					else
					{
						if (readonly == true)
							change = false;
						else
							change = true;
					}
				}
				else 
				{
					if (readonly == true)
						change = true
					else
						change = false;						
				}			
				
				if (change == true)
					LEAP.opinion.setReadOnly(opinionEle, readonly);
			}
		}
		
		//关联件
		var RelatedEntryElements = LEAP.getElements("div[ct=" + LEAP.RelatedEntry.d + "][instance=" + this.instance + "]", this.formElement);
		if (RelatedEntryElements != null)
		{
			for(var i=0; i<RelatedEntryElements.length; i++)
			{
				var RelatedEle = RelatedEntryElements[i];
				var change = true;
				if (RelatedEle.getAttribute("readonly") == "1")
				{
					if (RelatedEle.getAttribute("___isoparea_status") == "110")
					{
						change = false;
					}
					else
					{
						if (readonly == true)
							change = false;
						else
							change = true;
					}
				}
				else 
				{
					if (readonly == true)
						change = true
					else
						change = false;						
				}			
				
				if (change == true)
					LEAP.RelatedEntry.setReadOnly(RelatedEle, readonly, true);
			}
		}
	}
	finally
	{
		WF_isNew = WF_Data = readonly = attElements = attReadonly = i = attEle = change = opinionElements = opinionEle =  
		RelatedEntryElements = RelatedEle = null;
	}
}

/**
 * @param {} arg: {
 * 					autoRefresh:自动刷新(默认true)
 *                } 
 * @return {Boolean}
 */
LWFP.API.ModuleProcess.innerWFModuleSubmit = function(arg)
{
	try
	{
		try
		{
			var WF_Data = this.workflow.___data;
			var WF_isNew = this.workflow.getIsNew();
			var recordParams = null;
			var atts = null;
			var ops = null;
			var docnos = null;
			recordParams = this.___LWFPDynaParameter;
			//atts = this.getAttachmentChange();		
			atts = LEAP.attlist.getPageValue(this.instance, this.moduleElement);
			if (atts == null)
				atts = [];					
						
			var b = LWFP.API.ModuleProcess._getZWInside.call(this, atts);
			if (b != true)
			{
				alert('正文保存失败！');
				return false;
			}
			if(LEAP.opinion.checkNoneUpdateOpinion(this.instance,this.moduleElement)){
				alert('您还有正在编辑的意见未保存！');
				return false;
			}
			
			ops = LEAP.opinion.getPageValue(this.instance, this.moduleElement);				
			if (WF_isNew == true || WF_Data.historySteps == null)
			{
				if ( this.WFGetDocnumberValue )
					docnos = this.WFGetDocnumberValue();
				else
					docnos = LEAP.docnumber.getPageValue(this.instance, this.moduleElement);
			}
						
			recordParams.setAttachments(atts);
			recordParams.setOpinions(ops);
			recordParams.setDocnumbers(docnos);
				
			var exDatas = LWFP.API.ModuleProcess.__getExTabUIModuleData.call(this);
			if (exDatas && exDatas._type)
				return false;				
			recordParams.setExBeans(exDatas);
			
			//
			if(WF_Data.flow.disablesnapshot && WF_Data.flow.disablesnapshot==1)
			{
				var ret = LEAP.getData(this.data, this.instance);
				if (ret && ret.change)
				{
					if(Object.getOwnPropertyNames(ret.change).length == 1 && ret.change["updatetime"])
					{}
					else
						recordParams.setChangeData(JSON.stringify(ret.change));
				}			
			}
			//
			var preOwner = null;
			if (this.WFGetPreOwners)
				preOwner = this.WFGetPreOwners();
			recordParams.setPreOwner(preOwner);
			//
			
			this.WFMode2 = false;
			var flag = this.innerInfoSubmit();
			if (flag == 1 || flag == -2)
			{
				var rst = this.___LWFPSubmitResult;
				var repost = false;
				if (flag == -2 && this.pageMode == "insert")
				{
					return false;
				}
				else if (flag == -2 && this.pageMode == "modify" && (atts != null || recordParams.opinions != null || recordParams.preOwner != null
																		|| this.___LwfpMchilds_insert != null 
																		|| this.___LwfpMchilds_modify != null 
																		|| this.___LwfpMchilds_delete != null))
				{
					var service = "WfDynaModify";
					if (this.moduleVersion > 1 )
						service = "WfBeanModify";	
					recordParams.setModifyPkid(this.data[this.pks[0]]);
					var bean = {beanname:this.data.beanname};
					bean[this.pks[0]] = this.data[this.pks[0]];
					rst = this.request(service, {DataResult : bean, 
													insertpar : this.___LwfpMchilds_insert, 
													changepar : this.___LwfpMchilds_modify, 
													deletepar : this.___LwfpMchilds_delete, 
													RecordParams : recordParams} );
					repost = true;
				}
									
				if (rst && rst.breakservice && rst.breakservice == true)
				{	 
					//this.hideForm();
					
					var err = leapclient.getLastWarring();
					if (err == null)
						err = "保存失败！";
					throw(err);
				}
				else if ( (repost==false && rst && rst.cresult == false) || (repost == true && rst == null) )
				{
					var err = leapclient.getLastWarring();
					if (err == null)
						err = "保存失败！";
					throw(err);
				}
				
				if (!(this.silence == true || (arg && arg.silence == true)))
					LEAP.messagebox.alert('保存成功');
				
				if (flag == 1)
					this.workflow.setIsNew(false);
				
				var csid = null;
				if (rst)
					csid = rst.csid;
				if (csid == null && WF_Data.currentStep)
					csid = WF_Data.currentStep.csid;
				
				var preventRefresh = false; //是否阻止刷新
				if (arg && arg.mustRefreshPage == true)
				{//流程操作必须刷新
					preventRefresh = false;
				}
				else
				{
					if ((arg && arg.preventRefresh == true) || this.WfPreventAutoRefreshPage  == true)
					{//流程操作或业务阻止刷新
						preventRefresh = true;
					}
				}
				
				if (arg && arg.autoRefreshTransControl == false)
					this.___autoRefreshTransControl = false;
				
				if(preventRefresh == false)
					this._WF_ModuleProcess_refreshPage(0, csid, {key:"savedata", id:rst.cresult});
				
					
				return true;
			}				
			else
			{
				if (flag == -4)
				{
					var err = leapclient.getLastWarring();
					if (err == null)
						err = "保存失败!";
					alert(err);
					
				}
				else if (flag == -9 || flag == -1)
				{					
					if (this.tabuiparam != null)
					{
						var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
						if (tabCtrl)
						{
							LEAP.tab.setSelectedIndex(tabCtrl, 0, false);
						}	
					}
				}
				else if(flag != -9 && flag != -1)
				{
						alert("保存失败！");
				}
					
				return false;
			}
		}
		catch(e)
		{
			var err = null;
			if (e)
				err = e;

			if (err == null)
				err = "保存失败!";
			
			alert(err);
								
			return false;
		}
	}
	finally
	{	
		this.WFMode2 == true;
		WF_Data = WF_isNew = recordParams = atts = ops = docnos = exDatas = flag = rst = repost = service = err = csid = tabCtrl = null;
		LEAP.hideMask();
	}
}

LWFP.API.ModuleProcess.moduleSubmit = function(parameter, insertPar, changePar, deletePar, noModify)
{
	try
	{
		this.___LWFPSubmitResult = null;
		
		//获取表单上标记扩展字段的值
		var exs = LEAP.getElements("[lwfpentryex=true][instance=" + this.instance + "]", this.moduleElement);
		if (exs && parameter != null && this.moduleVersion>1)
		{
			var hasex = false;
			var obj = {};
			for(var i=0;i<exs.length;i++)
			{
				//发生变更的值
				var md = exs[i].getAttribute("md");
				for(f in parameter)
				{
					if(f == md)
					{
						hasex = true;
						obj[md] = parameter[md];
						break;
					}
				}			
			}
			if(hasex == true)
				parameter["_lwfpentryex"] = JSON.stringify(obj);
		}
		
		
		var referencenumber = LEAP.getElement('[ct=referencenumber][instance=' + this.instance + ']', this.moduleElement);
		
		if (referencenumber && parameter != null && this.moduleVersion>1)
		{
			var obj = {};
			var doc_nameElement  = LEAP.getElement('[ctf=doc_name][instance=' + this.instance + ']', referencenumber);
			var doc_numElement  = LEAP.getElement('[ctf=doc_num][instance=' + this.instance + ']', referencenumber);
			var doc_monthElement  = LEAP.getElement('[ctf=doc_month][instance=' + this.instance + ']', referencenumber);
			if(doc_nameElement)
			{
				if(doc_numElement)
				{
					var md = doc_nameElement.getAttribute("md");
					if(parameter[md])
					obj["docname"] = parameter[md];
					
					md = doc_numElement.getAttribute("md");
					if(parameter[md])
					obj["docnum"] = parameter[md];
					
					if(doc_monthElement)
					{
						md = doc_monthElement.getAttribute("md");
						if(parameter[md])
						obj["docmonth"] = parameter[md];
						
					}
					
					if(obj["docnum"]){
						parameter["_lwfpdcoumentnumber"] = JSON.stringify(obj);
					}
					
				}
			}
			
		}
		
		
		
		
		if (this.___LWFPDynaParameter.pageModule == "insert")
		{
			var service = "WfBeanCreate";
			//附件插件默认值
			if (this.workflow.getData().entry == null)
			{
				var elements = LEAP.getElements("div[ct=" + LEAP.attlist.d + "]", this.moduleElement);	
				if (elements)
				{
					for(var k=0; k<elements.length; k++)
					{
						var ele = elements[k];
						var md = ele.getAttribute("md");
						if (md != null && parameter[md] == null)
						{
							parameter[md] = UUID.randomUUID().replaceall('-', '');
						}						
					}
				}	
			}
				
			if (this.___LWFP_insertService_ex != null)
				service = this.___LWFP_insertService_ex; //外部特殊服务

			//加ID
			if (this.data != null && this.data[LWFP.ENUM.WFBean_lwfp_businessPkCol] != null && this.data[LWFP.ENUM.WFBean_lwfp_businessPkId] != null)
			{
				var _enterAction = this.workflow.getEnterAction();
				if (_enterAction != null && _enterAction.transdatatype != null && _enterAction.transdatatype == 0)
				{}
				else
				{
					if (this.moduleVersion>1)
					{
						if (parameter != null)
						{
							parameter[this.data[LWFP.ENUM.WFBean_lwfp_businessPkCol]] = this.data[LWFP.ENUM.WFBean_lwfp_businessPkId];
						}
					}
					else
					{
						if (parameter != null && parameter.metaData != null && parameter.result != null)
						{
							parameter.metaData.add(this.data[LWFP.ENUM.WFBean_lwfp_businessPkCol])
							parameter.result.add(this.data[LWFP.ENUM.WFBean_lwfp_businessPkId])
						}					
					}
				}
			}
			
			//提交
			this.___LWFPSubmitResult = this.request(service, {DataResult:parameter, 
																insertPar:(insertPar != null)?insertPar:this.___LwfpMchilds_insert, 
																changePar:(changePar != null)?changePar:this.___LwfpMchilds_modify, 
																deletePar:(deletePar != null)?deletePar:this.___LwfpMchilds_delete, 
																noModify:noModify, 
																RecordParams: this.___LWFPDynaParameter});
				
			if (this.___LWFPSubmitResult)
				return this.___LWFPSubmitResult.cresult;
		}
		else if (this.___LWFPDynaParameter.pageModule == "modify")
		{
			var service = "WfDynaModify";
			if (this.moduleVersion>1)
				service = "WfBeanModify";				
			this.___LWFPSubmitResult = this.request(service, {DataResult:parameter, 
																insertpar:this.___LwfpMchilds_insert, 
																changepar:this.___LwfpMchilds_modify, 
																deletepar:this.___LwfpMchilds_delete, 
																RecordParams: this.___LWFPDynaParameter});				
			if (this.___LWFPSubmitResult)
				return this.___LWFPSubmitResult.mresult;
		}
		
		return null;
	}
	finally
	{
		service = null;
	}
}

LWFP.API.ModuleProcess.childModifySubmit = function(_service_modify, parameter, type)
{
	try
	{
		var _service = _service_modify;
		if (_service == "DynaModify")
			_service = "beanModify";
		else if (_service == "DynaCreate3")
			_service = "beanCreate";
		
		if (_service == "beanDelete" || _service == "beanModify" || _service == "beanCreate")
			_service = null;
							
		var id = UUID.randomUUID().replaceall('-','');
		if (this.moduleVersion>1) //"beanDelete" "beanModify"  "beanCreate"
		{
			if (_service != null)
				parameter[LWFP.ENUM.WFBean_lwfp_serviceName] = _service;
				
			if (type == 0)
				parameter["id"] = id;
		}
		else //"beanDelete" "DynaModify"  "DynaCreate3"
		{
			if (_service != null)
			{
				parameter.metaData.add(LWFP.ENUM.WFBean_lwfp_serviceName);
				parameter.result.add(_service_modify);
			}
			
			if (type == 0)
			{
				parameter.metaData.add("id");
				parameter.result.add(id);
			}
		}
		
		if (type == 0)
		{
			if (this.___LwfpMchilds_insert == null)
				this.___LwfpMchilds_insert = [];
			this.___LwfpMchilds_insert.push(parameter);
		}
		else if (type == 1)
		{
			if (this.___LwfpMchilds_modify == null)
				this.___LwfpMchilds_modify = [];
			this.___LwfpMchilds_modify.push(parameter);
		}
		else if (type == 2)
		{
			if (this.___LwfpMchilds_delete == null)
				this.___LwfpMchilds_delete = [];
			this.___LwfpMchilds_delete.push(parameter);
		}
		
		if (type == 0)
			return id;
		else
			return true;
	}
	finally
	{
		_service = id = null; 
	}
}
	
LWFP.API.ModuleProcess._getZWInside = function(atts)
{
	try
	{
		if (this.__zwInside != true)
			return true;
					
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		if (tabCtrl == null)
			return true;
		
		var labels = LEAP.tab.getTabLables(tabCtrl);
		if (labels == null)
			return true;
						
		for(var i=0; i<labels.length; i++)
		{
			var lab = labels[i];
			var tabinfo = lab['wftabinfo'];
			if (tabinfo == null)
				continue;
			
			if (tabinfo.type == 2 || tabinfo.type == 4)
			{	
				var con = LEAP.getElement("div[ctf=tab_content][tabcode=" + tabinfo.code + "]", tabCtrl);
				
				var _docView = LEAP.getElement('div[ct=DocumentView]', con);
				if(_docView["_opened"] == true)
				{
					var forceSaveZW = false; 
					if (this.WFGetForceSaveZW) {
						forceSaveZW = this.WFGetForceSaveZW({"tabinfo":tabinfo});
					}
					var b = LEAP.DocumentView.innerSaveDocument(_docView, forceSaveZW);
					if (b == true)
					{
						var c = LEAP.DocumentView.getChange(_docView);
						if (c && c.newValue)
						{
							c.newValue.tabcode = tabinfo.code; //标签页代码
							atts.add(c.newValue);
						}
						if (c && c.deleted)
						{
							atts.add(c.deleted);
						}
					}
					else
					{
						LEAP.messagebox.alert("保存文件失败：" + lab.innerText);
						return false;
					}
				}				
			}
		}
		
		if (atts.length ==0)
			atts = null;
		
		return true;
	}
	finally
	{
		tabCtrl = labels = i = lab = tabinfo = con = _docView = b = c = null; 
	}
}
	
LWFP.API.ModuleProcess.__getExTabUIModuleData = function()
{
	if (!this.tabuiparam || !this.tabuiparam.hasExtab || this.tabuiparam.hasExtab != true)
		return null;

	try
	{			
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		var labels = LEAP.tab.getTabLables(tabCtrl);
		if (labels == null)
			return null;
		
		var err;
		var exDatas = [];
		var addDatas = [];
		try
		{
			for(var i=0; i<labels.length; i++)
			{
				var lab = labels[i];
				var tabinfo = lab['wftabinfo'];
				if (tabinfo.mode == "view")
					continue;
				
				if (tabinfo.type==3) 
				{	
					if (lab.getAttribute('hasfill') == "true" || lab.getAttribute('hasfill') == true)
					{				
						var exM = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));
						var exD = exM.innerInfoSubmit();
						if (exD == -2)
						{
							if (tabinfo.mode == 'insert')
							{
								err = new Error("请正确填写[" + tabinfo.name + "]信息"); err._idx = i; err._type=1; throw err;
								break;
							}
						}
						else if (typeof(exD) ==	"number")
						{
							err = new Error(""); err._idx = i; err._type=1; throw err;								
						}
						else if (exD && exD.parameter) 
						{
							exD.parameter.parentField = tabinfo.foreignkey;
							exD.parameter.__wf_tabuicode = tabinfo.code;
							exDatas.add({primaryBean:exD.parameter, childWfBeans:exD.childPar});
						}
					}
					else
					{
						if (tabinfo.mode == 'insert')
						{
							err = new Error("请正确填写[" + tabinfo.name + "]信息"); err._idx = i; err._type=1; throw err;
							break;
						}
					}
				}
				else if (tabinfo.type==9)
				{
					if (lab.getAttribute('hasfill') == "true" || lab.getAttribute('hasfill') == true)
					{
						var exM = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));
						if (exM && exM.moduleName)
						{
							var exD = exM.innerInfoSubmit();
							if (exD == -2)
							{}
							else if (exD && typeof(exD) ==	"number")
							{
								err = new Error(""); err._idx = i; throw err;								
							}
							else if (exD && exD.parameter)
							{							
								addDatas.add({primaryBean:exD.parameter, childWfBeans:exD.childPar});
							}
						}
					}
				}
			}
		}
		catch(e)
		{
			if (e.message != "") alert(e.message);
			if (e._type ==1)
				LEAP.tab.setSelectedIndex(tabCtrl, e._idx, true);
			else
				e._type = 2;
			
			return e;
		}
		
		//if (currentStepForm && currentStepForm.getWfAddtionalTabData)
			//currentStepForm.getWfAddtionalTabData(addDatas);
		
		if (addDatas.length>0)
		{
			for(var j=0; j<addDatas.length; j++)
				exDatas.add(addDatas[j]);
		}

		return (exDatas.length == 0)?null:exDatas;
	}
	finally
	{			
		tabCtrl = labels = err = exDatas = addDatas = i = lab = tabinfo = exM = exD = exM = exD = j= null;
	}	
}

LWFP.API.ModuleProcess.__initTabUI = function()
{
	try
	{	
		var WF_Data = this.workflow.___data;
		var param = WF_Data.flow.tabuiparam;
		if (this.beforeLoadTabui)
		{
			if (param != null && param.Trim() != "")
				param = JSON.parse(param);
				
			param = this.beforeLoadTabui(param);			
			if (param != null)
				param = JSON.stringify(param);
		}
		
		this.tabuiparam = LWFP.innerApi.getTabInfo(WF_Data, param);
				
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		
		if (this.tabuiparam == null || this.tabuiparam.tabs == null || tabCtrl == null)
			return;
		
		if (tabCtrl.getAttribute("__hasInit__"))
		{//刷新时如果已经初始化过了则不重复加载，但需要重新绑定正文附件			
			var _labels = LEAP.tab.getTabLables(tabCtrl);
			if (_labels == null)
				return true;
							
			for(var i=0; i<_labels.length; i++)
			{
				var _lab = _labels[i];
				var _tabinfo = _lab['wftabinfo'];				
				if (_tabinfo.type == 2 || _tabinfo.type == 4)
				{
					var _att = LWFP.innerApi.getZWAttachment(WF_Data, _tabinfo.code);
					if (_att)
					{
						var _con = LEAP.getElement("div[ctf=tab_content][tabcode=" + _tabinfo.code + "]", tabCtrl);		
						var _docView = LEAP.getElement('div[ct=DocumentView]', _con);
						LEAP.DocumentView.setValue(_docView, _att);
						if (_docView["_opened"] == true && this.__refreshTab_zw == true)
						{
							LEAP.asyn(LEAP.DocumentView.loadDocument, this, 200, _docView, true, _tabinfo.name, _tabinfo.code);
							this.__refreshTab_zw = null;
						}
					}
				}
			}
			
			return;
		}
		
		
		this.__zwInside = false;
		
		if (!tabCtrl.getAttribute("__hasInit__"))
		{
			this.addEvent(tabCtrl, 'selectedIndexChange', LWFP.API.ModuleProcess.__TabUISelectedIndexChange);	
		}
			
		var labels = LEAP.tab.getTabLables(tabCtrl);
		if (labels && labels.length>1)
		{
			for(var i=labels.length-1; i>0; i--)
			{
				LEAP.tab.removeItem(tabCtrl, i);
			}
		}
		
		this.tabuiparam.defaultTabIdx = -1;
		for(var i=0; i<this.tabuiparam.tabs.length; i++)
		{
			var m = this.tabuiparam.tabs[i];
			if ((m.type == 2 || m.type == 4) && LEAP.DocumentView.OSType.indexOf("Win") < 0)
				continue;
			
			if (m.isDefault == true)
				this.tabuiparam.defaultTabIdx = i;
			
			if (m.type == 1)
			{
				labels[0]["wftabinfo"] = m;
				labels[0].setAttribute("tabcode", m.code);
				labels[0].setAttribute('wftabinstance', this.instance);
				labels[0].innerText = m.name;
				labels[0].style.styleFloat = "left";
			}
			else
			{
				var _tab = LEAP.tab.addItem(tabCtrl, m.name);			
				_tab.tabli["wftabinfo"] = m;
				_tab.tabli.setAttribute("tabcode", m.code);
				_tab.tabli.removeAttribute('wftabinstance');
				_tab.tabli.style.display = "block";	
				_tab.tabli.style.styleFloat = "left";
			
				if (m.type == 2 || m.type == 4)
				{
					var _ut = "__DocumentView" + ( (m.code==null) ? "" : ("_" + m.code) );
					_tab.tabcontent.setAttribute("tabcode", m.code);
					_tab.tabcontent.setAttribute("ndis", "1");
					_tab.tabcontent.innerHTML = "<div ut='" + _ut + "' instance='" + this.instance +  "' ct=DocumentView uploadpath='" + LWFP.Global.uploadPath.getAttachmentUploadPath() + "' scan_uploadpath='" + LWFP.Global.uploadPath.getScanUploadPath() + "' class='wf_documentView'><IMG style='DISPLAY: none' onerror='LEAP.DocumentView.i(1);' src='data:image:png,base64'></div>";						
					this.removeUTCache("__DocumentView");
					var _documentViewer = LEAP.getElement('div[ut=' + _ut + '][instance=' + this.instance + ']', _tab.tabcontent);
					
					var templateValues = this.wordTemplateValues;
					if (this.getWordTemplateValues)
						templateValues = this.getWordTemplateValues();
					
					LEAP.DocumentView.setParams(_documentViewer,
								(WF_Data.step != null && WF_Data.step.wordbuttons != null)?WF_Data.step.wordbuttons:null,							
								templateValues,				
								WF_Data.businessNo, (WF_Data.step != null)?1:null, WF_Data.flow.atttype,							
								WF_Data.currentStep, this.getWordTemplateValues, {tabinfo:m}, 
								{businessid:(WF_Data.entry != null)?WF_Data.entry.businessid:null});

					var att = LWFP.innerApi.getZWAttachment(WF_Data, m.code);
					if (att)
					{
						if (!WF_Data.currentStep || (WF_Data.currentStep.readstep != null || WF_Data.currentStep.readstep==1))
							att.canEdit = false;						
						
						LEAP.DocumentView.setValue(_documentViewer, att);
					}
					else if (m.viewtype == 2)
					{
						_tab.tabli.style.display = "none";							
					}
					
					if (m.type == 2)
					{
						this.__addZWButton = true;
						this.__zwTabIndex = i;
						this.__zwTabCode = m.code;
					}
					
					this.__zwInside = true;
				}
				else if (m.type == 3 || m.type == 9)
				{
					this.tabuiparam.hasExtab = true;
				}	
			}
		}

		if (this.tabuiparam.defaultTabIdx < 0)
			this.tabuiparam.defaultTabIdx = 0;	
		LEAP.tab.setSelectedIndex(tabCtrl, this.tabuiparam.defaultTabIdx, true);
		
		tabCtrl.setAttribute("__hasInit__", "1");	
	}
	finally
	{
		WF_Data = param = tabCtrl = labels = i = m = _tab = _ut = _documentViewer = att = null;
	}
}

LWFP.API.ModuleProcess.__TabUISelectedIndexChange = function(arg)
{
	if (arg == null || arg.arg2 == null || arg.arg2.element_tab == null || arg.arg2.element_content == null)
		return;
		
	try
	{
		var lab = arg.arg2.element_tab;
		var con = arg.arg2.element_content;
		var tab = arg.arg2.element_tab['wftabinfo'];
		
		var WF_Data = this.workflow.___data;
		
		if (tab.type == 1)
		{
			if (this.OnWfuiTabChange)
				this.OnWfuiTabChange({tabInfo:tab});
		}
		else if (tab.type == 2 || tab.type == 4)
		{
			var _docView = LEAP.getElement('div[ct=DocumentView][instance=' + this.instance + ']', con);			
			LEAP.asyn(LEAP.DocumentView.loadDocument, this, 200, _docView, null, tab.name, tab.code);
			
			if (this.OnWfuiTabChange)
				this.OnWfuiTabChange({tabInfo:tab});
			
			_docView["_opened"] = true;
		}
		else if (tab.type == 3)	//扩展
		{
			var m = null;
			if (lab.getAttribute('hasfill') == "true")
			{
				m = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));					
			}
			else
			{
				m = this.loadModule2({name:tab.module, parent:con, pageMode:tab.mode});

				if (m)
				{
					m.WFExtMode = true;
			
					if (tab.mode == "modify" || tab.mode == "view")
						m.setPageDataByPK(tab._recordid);
					lab.setAttribute('hasfill', "true");
					lab.setAttribute('wftabinstance', m.instance);
				}
			}
			
			if (m && m.OnWfuiTabChange)
				m.OnWfuiTabChange({tabInfo:tab});
			
			if (this.OnWfuiExTabChange)
				this.OnWfuiExTabChange({tabInfo:tab, tabModule:m});
		}
		else if (tab.type == 9) //附加
		{
			if (lab.getAttribute('hasfill') == "true")
			{
				m = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));					
			}
			else
			{
				m = this.loadModule2({name:tab.module, parent:con, pageMode:tab.mode});				
				if (m)
				{
					m.WFExtMode = true;
					
					if (tab.data != null)
						m.setPageData(tab.data);				
					lab.setAttribute('hasfill', "true");
					lab.setAttribute('wftabinstance', m.instance);
				}
			}
			
			if (m && m.OnWfuiTabChange)
				m.OnWfuiTabChange({tabInfo:tab});				
		}
		else if (tab.type == 10) //流程监控
		{
			LWFP.API.ModuleProcess.__loadMonitorView(this, WF_Data, tab, lab, con, "LBPMRTM.hisForm2", 0);			
			/*
			var hisModule = null;			
			if (lab.getAttribute('hasfill') == "true")
			{
				hisModule = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));					
			}
			else
			{				
				var mm = LEAP.trans.__mon_loadmodule_getView(this, WF_Data, "LBPMRTM.hisForm2", tab.view);				
				var _con = this.getElement('div[ctf=moduleContainer]', con);
				hisModule = this.loadModule2({name:mm, parent:con});		
				if (hisModule)
				{							
					lab.setAttribute('hasfill', "true");
					lab.setAttribute('wftabinstance', hisModule.instance);
				}
				
				LEAP.trans.__mon_loadmodule_afterLoad(hisModule, WF_Data, mm, tab.view, {lab:lab});
			}
			
			hisModule._wfmoduleversion = 3;
			hisModule.initPage(WF_Data, tab.remarktype, tab.remarktitle);*/
		}
		else if (tab.type == 13) //流程监控3
		{
			LWFP.API.ModuleProcess.__loadMonitorView(this, WF_Data, tab, lab, con, "LBPMRTM.hisForm3", 0);
			/*var hisModule = null;
			if (lab.getAttribute('hasfill') == "true")
			{
				hisModule = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));					
			}
			else
			{								
				var _con = this.getElement('div[ctf=moduleContainer]', con);
				
				hisModule = this.loadModule2({name:"LBPMRTM.hisForm3", parent:con});					
				if (hisModule)
				{							
					lab.setAttribute('hasfill', "true");
					lab.setAttribute('wftabinstance', hisModule.instance);
				}
			}
			
			hisModule._wfmoduleversion = 3;
			hisModule.initPage(WF_Data, this.historyCustomgroups);*/
		}
		else if (tab.type == 11) //流程附件
		{
			var attModule = null;
			if (lab.getAttribute('hasfill') == "true")
			{
				attModule = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));					
			}
			else
			{	
				attModule = this.loadModule2({name:"LWFP.AttachmentTab", parent:con});					
				if (attModule)
				{
					lab.setAttribute('hasfill', "true");
					lab.setAttribute('wftabinstance', attModule.instance);
				}
				attModule.initPage(WF_Data);
			}				
		}
		else if (tab.type == 12) //关联件
		{
			var reModule = null;
			if (lab.getAttribute('hasfill') == "true")
			{
				reModule = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));					
			}
			else
			{
				reModule = this.loadModule2({name:"LBPMRuntime.RelatedEntryTab", parent:con});					
				if (reModule)
				{
					lab.setAttribute('hasfill', "true");
					lab.setAttribute('wftabinstance', reModule.instance);
				}
				reModule.initPage(WF_Data);
			}				
		}
	}
	finally
	{		
		lab = con = tab = WF_Data = _docView = m = attModule = reModule = null;
	}	
}

LWFP.API.ModuleProcess.__loadMonitorView = function(domain, WF_Data, tabinfo, label, container, defaultView, flag)
{
	try
	{
		var hisModule = null;
		if (flag == 0)
		{//标签切换
					
			if (label.getAttribute('hasfill') == "true")
			{
				hisModule = PageObjectModel.getModule(label.getAttribute('wftabinstance'));					
			}
			else
			{
				var mm = LEAP.trans.__mon_loadmodule_getView(WF_Data, "LBPMRTM.hisForm2", tabinfo.view, false);				
				var _con = domain.getElement('div[ctf=moduleContainer]', container);
				hisModule = domain.loadModule2({name:mm, parent:container});
				
				LEAP.trans.__mon_loadmodule_afterLoad(hisModule, WF_Data, mm, tabinfo.view, {tabinfo:tabinfo, label:label, container:container});
			
			}
		}
		else
		{	
			var mm = LEAP.trans.__mon_loadmodule_getView(WF_Data, defaultView, tabinfo.view, true);				
			var _con = domain.getElement('div[ctf=moduleContainer]', container);
			hisModule = domain.loadModule2({name:mm, parent:container});
			
			LEAP.trans.__mon_loadmodule_afterLoad(hisModule, WF_Data, mm, tabinfo.view, {tabinfo:tabinfo, label:label, container:container});
			
			
			
		}
		
		label.setAttribute('hasfill', "true");
		label.setAttribute('wftabinstance', hisModule.instance);
		hisModule._wfmoduleversion = 3;
		
		var param = {};
			param.customgroups = domain.historyCustomgroups;
			param.remarktype = tabinfo.remarktype;
			param.remarktitle = tabinfo.remarktitle;
				
		hisModule.initPage(WF_Data, param);
	}
	finally
	{
		hisModule = mm = _con = param = null;	
	}
}

LWFP.API.ModuleProcess.setDownloadParameter = function(attData)
{
	try
	{
		var p = null;
		if (this.workflow && this.workflow.getEntry())
		{
			p = "wflog=1&terminal=0&entryid=" + this.workflow.getEntry().entryid;
			p += "&id=" + attData.name.substring(0, attData.name.lastIndexOf("."));
			if (attData.title != null)
				p += "&remark=" + encodeURIComponent(encodeURIComponent(attData.title + attData.name.substring(attData.name.lastIndexOf("."))));
		}
		
		return p;	
	}
	finally
	{
		p = null;
	}
}




LWFP.API.ModuleProcess.api = new Object();
/**
 * 根据标签页code获取标签页信息
 * @param {} tabcode
 * @param {} domain
 * @return {tabInfo:标签页配置信息, tabModule:如果当前标签页加载了模型则返回模型对象, documentView:如果当前标签页加载了正文则返回正文插件}
 */
LWFP.API.ModuleProcess.api.getUITabinfo = function(tabcode, domain)
{
	if (domain != null)
		return LWFP.API.ModuleProcess.api.getUITabinfo.call(domain, tabcode); 
	
	try
	{
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		if (!tabCtrl)
			tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.parentPageModule.instance + "]", this.parentPageModule.moduleElement);
		if (!tabCtrl)
			return null;
			
		var lab = LEAP.getElement("li[tabcode=" + tabcode + "]", tabCtrl);
		if (lab == null)
			return null;
		
		var tabinfo = lab['wftabinfo'];			
		var ret = {tabInfo:tabinfo};		
		
		if (tabinfo.type == 2 || tabinfo.type == 4)
		{
			var con = LEAP.getElement("div[ctf=tab_content][tabcode=" + tabcode + "]", tabCtrl);
			if (con)
				ret.documentView = LEAP.getElement('div[ct=DocumentView]', con);
		}
		else if (lab.getAttribute('wftabinstance'))
		{
			ret.tabModule = PageObjectModel.getModule(lab.getAttribute('wftabinstance'));
		}
			
		return ret;
		
	}
	finally
	{
		tabCtrl = lab = tabinfo = ret = null;		
	}			
}
/**
 * 加载标签页表单
 * @param {} tabcode
 * @param {} domain
 * @return {}
 */
LWFP.API.ModuleProcess.api.loadTabUI = function(tabcode, domain)
{
	if (domain != null)
		return LWFP.API.ModuleProcess.api.loadTabUI.call(domain, tabcode); 
	
	try
	{
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		if (!tabCtrl)
			return;
			
		var labels = LEAP.tab.getTabLables(tabCtrl);
		if (labels == null)
			return;
			
		var idx = -1;
		var label = null;
		var con = null;
		for(var i=0; i<labels.length; i++)
		{
			label = labels[i];
			if (tabcode == label.getAttribute("tabcode"))
			{
				idx = i;
				break;
			}
		}
		
		if (idx < 0)
			return;
		
		var contents = LEAP.getElements("[ctf=tab_content]", tabCtrl);
		con = contents[idx];
		
		LWFP.API.ModuleProcess.__TabUISelectedIndexChange.call(this, {arg2:{element_tab:label, element_content:con}});		
	}
	finally
	{
		tabCtrl = labels = idx = label = con = i = contents = null;	
	}			
}

LWFP.API.ModuleProcess.api.setActiveTabUI = function(tabcode, domain)
{
	if (domain != null)
		return LWFP.API.ModuleProcess.api.setActiveTabUI.call(domain, tabcode); 
	
	try
	{
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		if (!tabCtrl)
			return;
			
		var labels = LEAP.tab.getTabLables(tabCtrl);
		if (labels == null)
			return;
		
		var label = null;
		for(var i=0; i<labels.length; i++)
		{
			label = labels[i];
			if (tabcode == label.getAttribute("tabcode"))
			{
				LEAP.tab.setSelectedIndex(tabCtrl, i, true);
				break;
			}
		}		
	}
	finally
	{
		tabCtrl = labels = label = i = null;	
	}	
}

/**
 * 创建附加标签页 
 * @param {} tabinfos 标签信息, 如：[{name:'企业基本信息', type:9, code:'t97', module:'lbcplwfpoveroffice', mode:'insert', data:data}]
 * @param {} domain 当前作用域
 */
LWFP.API.ModuleProcess.api.createAddtionalTabUI = function(tabinfos, domain)
{
	if (domain != null)
		return LWFP.API.ModuleProcess.api.createAddtionalTabUI.call(domain, tabinfos);
	
	try
	{
		var tabCtrl = LEAP.getElement("div[wtf=tabcontrol][instance=" + this.instance + "]", this.moduleElement);
		if (!tabCtrl)
			return;
		
		for(var i=0; i<tabinfos.length; i++)
		{
			var m = tabinfos[i];
			
			var old = LEAP.getElement("[tabcode" + m.code + "]", tabCtrl);
			if (old)
				continue;
			
			var _tab = LEAP.tab.addItem(tabCtrl, m.name);			
			_tab.tabli["wftabinfo"] = m;
			_tab.tabli.setAttribute("tabcode", m.code);
			_tab.tabli.removeAttribute('wftabinstance');
			_tab.tabli.style.display = "block";			
			_tab.tabli.removeAttribute('hasfill');
			
			if (m.type == 3 || m.type == 9)
			{
				if (this.tabuiparam)
				{
					this.tabuiparam.hasExtab = true;
				}
			}
		}	
	}
	finally
	{
		tabCtrl = i = m = _tab = null;
	}	
}


/**
 * 执行动作
 * @param {} domain
 * @param {} actionname
 */
LWFP.API.ModuleProcess.api.doAction = function(domain, actionname)
{
	LEAP.trans.send(domain, actionname);
}

/**
 * 指定下一步骤可执行动作
 * @param {} domain
 * @param {} actionNames
 */
LWFP.API.ModuleProcess.api.ChangeNextActions = function(domain, actionNames)
{
	LEAP.trans.ChangeNextActions(domain, actionNames);
}

/**
 * 指定跳过后续执行人选择检查的动作
 * @param {} domain
 * @param {} actionNames 动作名称，逗号分隔
 */
LWFP.API.ModuleProcess.api.setSkipNextownerValidateActions = function(domain, actionNames)
{
	LEAP.trans.setSkipNextownerValidateActions(domain, actionNames);
}

/**
 * 从表单UI上获取（用户选择的）下环节执行人
 * @param {} domain 表单作用域
 */
LWFP.API.ModuleProcess.api.getNextOwners = function(domain)
{
	return LEAP.trans.getNextOwners(domain);
}

/**
 * 设置表单UI上的下环节执行人
 * @param {} domain
 * @param {} actionName
 * @param {} owners
 */
LWFP.API.ModuleProcess.api.setNextOwners = function(domain, actionName, owners)
{
	LEAP.trans.setNextOwners(domain, actionName, owners)
}

/**
 * 刷新运行界面
 * @param {} domain
 */
LWFP.API.ModuleProcess.api.refreshRunningUI = function(domain)
{
	domain._WF_ModuleProcess_refreshPage();
}





/**
流程页面事件 
 this.beforeLoadWorkflow()
 this.afterLoadWorkflow()
 this.beforeLoadTabui(tabinfos)
 this.OnWfuiTabChange({tabInfo:tab});
 this.OnWfuiExTabChange({tabInfo:tab, tabModule:m});
 this.OnWfNextOwnerCheckedChange(arg);
 
 
 this.WFForceSave(action):boolean
 this.WFGetTransForm(action): {name:"LBPMRTM.transform2", title:"转下一步", formtype:3, top:10, left:10}
 this.WFGetNextSubflowList(action) : [{id:'事项名称或事项编号', aliasname:'事项别名'}]
 this.afterDoAction()
 */


/*
----------LEAP.loadModule------------------------------------------------------------
dbger.start('处理加载事件步骤2');
if (moduleLoadArg == null)
	d.pageLoad.call(d);
else d.pageLoad.call(d, moduleLoadArg);
dbger.end();

//加载流程
if (d.moduleElement && "1" == d.moduleElement.getAttribute("workflowmodule"))
{
	if (moduleLoadArg && moduleLoadArg.arg && moduleLoadArg.arg.workflow)
		d.workflow = moduleLoadArg.arg.workflow;									
	d.isworkflow = true;
	LWFP.API.ModuleProcess.process(d);
}
else d.isworkflow = false;

dbger.start('处理加载事件步骤3');




----------pageObject.pageLoad----------------------------------------------
pageObject.pageLoad = function(arg)
{
	this.exdata = null;
	this.moduleLoadArg = arg;
	
	if (this.moduleElement && "1" == this.moduleElement.getAttribute("workflowmodule"))
	{
		if (this.moduleLoadArg && this.moduleLoadArg.arg && this.moduleLoadArg.arg.workflow)
		{
			this.workflow = this.moduleLoadArg.arg.workflow;
			this.isworkflow = true;
		}
	}
	else
	{
		this.isworkflow = false;
	}
	
	.....
	if (this.isworkflow == true)
	{
		LWFP.API.ModuleProcess.process(this);
	}

							
--------LEAP.form.create----------------------------------------------------------------
if (path != null)
{
	ret.module =
			LEAP.form.setContentModule(ct, path, distributeFlag, moduleLoadArg, pageMode, moduleParameter, authority);
	if (ret.module.pageLoad != null)
	{
		ret.module.form = ret.form;
		var mdf = ret.module.___def;
		if (mdf != null)
		{
			if (!String.isEmpty(mdf.width))
				width = mdf.width;
			if (!String.isEmpty(mdf.height))
				height = mdf.height;

			if (mdf.ismax != null)
				ismax = mdf.ismax == 1;
		}

		if (width == null && ret.module.isworkflow && ret.module.pageModuleWidth)
			width = ret.module.pageModuleWidth * 1;
		if (height == null && ret.module.isworkflow && ret.module.pageModuleHeight)
			height = ret.module.pageModuleHeight * 1;
		if(title == null && ret.module.moduleCNName)
			title = ret.module.moduleCNName;
	}
}

{
	if (width == null)
		width = 800;
	if (height == null)
		height = 500;




		
-----------pageObjectExtend.forms-----------------------------------------------------
if (this.___forms2.contains(name))
{
	.......
	this.___afterGetModule(form.module);

	if (form.module.isworkflow && moduleLoadArg && moduleLoadArg.workflow)
	{
		form.module.workflow = moduleLoadArg.workflow;
		LWFP.API.ModuleProcess.process(form.module);
	}
	
	......
	
}


form.show = function()
{
	.....
	try
	{
		if (this.module.isworkflow)
		{
			LWFP.API.ModuleProcess.process(this.module);
		}
		if (this.__showCount > 1 && this.mode && this.module)
		{
			var m = LEAP._peGetMM(this.module);
			this.module.pageMode = m.pageMode = this.mode;
			if (this.mode == 'search' && m && m.searchPageLoad)
			{
				m.searchPageLoad(this.moduleLoadArg);
			}
			else if (this.mode == 'insert' && m && m.insertPageLoad)
			{
		...........
		

		
-----------------pageObjectExtend.innerInfoSubmit----------------------------------------
pageObjectExtend.innerInfoSubmit = function()
{

	try
	{
		if (this.innerWFModuleSubmit && this.WFMode2 != null && this.WFMode2 == true)
		{
			return this.innerWFModuleSubmit();
		}
		else if (this.pageMode)
		{
			if (this.pageMode == 'modify')
			{
				return this.innerModifySubmit();
			}
			else if (this.pageMode == 'insert') { return this.innerInsertSubmit(); }
		}
		else
		{
			return this.innerInsertSubmit();
		}
	................
	

---------------------pageObjectExtend.innerInsertSubmitStep2----------------------------------
.......
if (this.WFMode2 == null)
{
	this.clearPageData();
	this.hideForm();
}

if (this.autoRefreshParentModule)
{
........

---------------------pageObjectExtend.innerModifySubmitStep2---------------------------------- 
if (this.WFMode2 == null)
{
	this.clearPageData();
	this.hideForm();
}

if (this.autoRefreshParentModule)
{
	var p = this.getParentModule();
	if (p)
	{
		if (p.pageMode == 'search')
......


  
 */






/*******************************************************************************
 * opinion插件
 * 
 * @class LEAP.opinion control
 * @type user control
 *       @example
 * 
 * 
 * 定义：
 * <DIV class=wfcontrol_opinion style="MARGIN: 8px; WIDTH: 100%; HEIGHT: 100%" ct="opinion" md="appopinion" ut="appopinion" bt="text" mdcn="appopinion">
 * 		<IMG style="DISPLAY: none" onerror=LEAP.opinion.i(0); src="data:image:png,base64">
 * </DIV>
 * 
 * 生成后示例:
 * <DIV class=wfcontrol_opinion style="MARGIN: 8px; WIDTH: 100%; HEIGHT: 100%" ct="opinion" ut="appopinion" instance="cid_1322727231506_0_4262071277230114_132" mdcn="appopinion" bt="text" md="appopinion" ___isoparea="1" ___isoparea_status="110" readonly="1" autobinding="false" mdid="84100f3ca342f92f40baa0d3d058a06a">
 * 		<DIV class=wfcontrol_opinion_list ctf="opinionlist"></DIV>
 * 		<DIV class=wfcontrol_opinion_editor style="DISPLAY: none" ctf="opinioncontrol">
 * 			<TEXTAREA class=wfcontrol_opinion_editor_textarea style="COLOR: #999" rows=5 ctf="opinion_text" ptf="postil">双击此处.显示常用批示语.</TEXTAREA>
 * 			<DIV class=wfcontrol_opinion_editor_btnarea>
 * 				<A class="lgimgbtn wfcontrol_opinion_editor_btncancel" style="FLOAT: right" href="javascript:" ctf="_cancel" ht="button">清空</A>
 * 				<A class="lgimgbtn wfcontrol_opinion_editor_btnconfirm" style="FLOAT: right" href="javascript:" ctf="_confirm" ht="button" href?>确定</A>
 * 			</DIV>
 * 		</DIV>
 * </DIV>
 * 
 * 属性说明：
 * readonly 设置是否只读:值域为1或者0,默认0 ,1表示只读,0表示可以填写意见
 * autobinding
 * mdid
 * showpostil 设置是否显示公共批示语:值域为1或者0,默认0 ,1表示显示公共批示语
 * showspecialsign 设置是否可修改落款:值域为1或者0,默认0 ,1表示显示落款修改
 * formattype 设置时间显示格式, 0 : 长时间 ， 显示时分秒 1 : 短时间 ， 不显示时分秒
 * showsignimg 设置是否显示手写签名:值域为1或者0,默认0 ,1表示显示手写签名
 * signimgheight 设置手写签名显示的高度（宽度等比例缩放）
 * showdelegate 是否显示代理人，值域为1或者0,默认1 ,1表示显示代理人
 * showbutton 是否显示确定和清空按钮，0否1是，默认1
 * singleopinion 是否只允许输入一条意见，0否1是，默认1
 * postiltxt 意见输入框提示文本
 * postiltype 0替换输入框文本 1追加输入框文本
 * signcolor 落款文字颜色, 如：#55FFEE
 * edittype 0输入框在下方 1 输入框在上方
 * usernameexp 落款显示格式
 * postilmaxwidth 常用批示语显示最大宽度
 * hideEditor 1隐藏输入部分
 * hideList   1隐藏列表部分 * 
 * order   意见排序字段,order="opiniontime desc" 意见倒排序 * 
 * itmfontsize="33" signfontsize="28" inputfontsize="22"
 */

LEAP.opinion =
{};
LEAP.opinion.d = "opinion";
LEAP.opinion.ctf =
{
	_list : "opinionlist",
	_control : "opinioncontrol",
	_txt : "opinion_text",
	_cancel : "_cancel",
	_confirm : "_confirm",
	_item : "op_item",
	_itemContent : "op_content",
	_delete : "_delete",
	_edit : "_edit",
	_handsignViewer : "_handsignViewer",
	_handwrite : "_handwrite",
	_postil : "_postil",
	_morepostil : "_morepostil",
	_specialsign : "_specialsign",
	_signimg : "_signimg",
	postiltxt : "postiltxt",
	attItem : "uploadItem",
	attItemTxt : "uploadItemTxt",
	attItemDel : "uploadItemDel",
	attcontainer : "attcontainer",
	attuploadcontainer : "attuploadcontainer",
	attItemcontainer : "attItemcontainer",
	
	update_frame:"update_frame",
	update_frame_txt:"update_frame_txt",
	update_frame_sign:"update_frame_sign",
	update_frame_btn_confirm:"update_frame_btn_confirm",
	update_frame_btn_delete:"update_frame_btn_delete",
	update_frame_btn_cancel:"update_frame_btn_cancel",
	update_frame_item:"update_frame_item",
	
	groupcontainer : "groupcontainer", // 分组按钮栏
	groupButton : "groupButton", // 分组按钮
	// groupitem:"groupitem",

	topic_list : "topic_list", // 分栏
	topic : "topic",
	topicTitle : "topicTitle",
	topicFolding : "topicFolding",

	group_list : "group_list",
	group : "group",
	groupTitle : "groupTitle",
	groupFolding : "groupFolding"

};
LEAP.opinion.def = '双击此处.显示常用批示语.';
LEAP.opinion.handsignViewer = null;

LEAP.opinion.init = function()
{
	if (document != null && document.body != null)
	{
		LEAP.opinion._init();
	} else
	{
		UIEventManager.addEvent(window, "load", LEAP.opinion._init);
	}
	
	ElementEventManager.addManagedEventType(LEAP.opinion.d, 'onConfirm');
	ElementEventManager.addManagedEventType(LEAP.opinion.d, 'onUpdate');
	ElementEventManager.addManagedEventType(LEAP.opinion.d, 'onEdit');
	ElementEventManager.addManagedEventType(LEAP.opinion.d, 'onDelete');
	ElementEventManager.addManagedEventType(LEAP.opinion.d, 'onGroupChange');
	ElementEventManager.addManagedEventType(LEAP.opinion.d, 'onAppend');
}
LEAP.opinion._init = function()
{
	LEAP.addEvent(document.body, "click", LEAP.opinion.uiProcess, null, null, true);
	LEAP.addEvent(document.body, "click", LEAP.opinion._hideHandsign, null, null, true);

	UIEventManager.removeEvent(window, "load", LEAP.opinion._init);
}

/**
 * 注册按钮所有操作的方法
 * 
 * @param {}
 *            arg
 */
LEAP.opinion.uiProcess = function(arg)
{
	try
	{
		if (!arg)
			return;
		var src = arg.e.srcElement;
		var ctf = src.getAttribute(commfields.ctf);
		if (!ctf)
			return;

		var element = LEAP._match(src, LEAP.opinion.d);
		if (!element && ctf != LEAP.opinion.ctf.update_frame_btn_cancel && ctf != LEAP.opinion.ctf.update_frame_btn_confirm)		
			return;
		
		if (ctf == LEAP.opinion.ctf._confirm)
		{
			LEAP.opinion.addopinion(element);
		} 
		else if (ctf == LEAP.opinion.ctf._cancel)
		{
			LEAP.opinion.clear_txt(element);
			LEAP.opinion._attachment_clearAtts(element);
		} 
		else if (ctf == LEAP.opinion.ctf._delete)
		{
			LEAP.opinion._delete(src);
		} 
		else if (ctf == LEAP.opinion.ctf._edit)
		{
			//LEAP.opinion._edit(src);
			LEAP.opinion._updateContent(src);
		} 
		else if (ctf == LEAP.opinion.ctf._handsignViewer)
		{
			LEAP.opinion._showHandsign(arg);
		} 
		else if (ctf == LEAP.opinion.ctf._handwrite)
		{
			LEAP.opinion.clear_txt(element);
			LEAP.opinion._attachment_clearAtts(element);
		} 
		else if (ctf == LEAP.opinion.ctf._postil)
		{
			LEAP.opinion.set_txt(element, src.innerText);
		} 
		else if (ctf == LEAP.opinion.ctf.attItemTxt)
		{
			LEAP.opinion._attachment_down(element, src);
		} 
		else if (ctf == LEAP.opinion.ctf.attItemDel)
		{
			LEAP.opinion._attachment_del(element, src);
		} 
		else if (ctf == LEAP.opinion.ctf.groupButton)
		{
			LEAP.opinion._groupClick(element, src);
		} 
		else if (ctf == LEAP.opinion.ctf.topic || ctf == LEAP.opinion.ctf.topicTitle || ctf == LEAP.opinion.ctf.topicFolding)
		{
			LEAP.opinion._topic_foldding(src);
		}
		else if (ctf == LEAP.opinion.ctf.group || ctf == LEAP.opinion.ctf.groupTitle || ctf == LEAP.opinion.ctf.groupFolding)
		{
			LEAP.opinion._group_foldding(src);
		}
		else if (ctf == LEAP.opinion.ctf._morepostil)
		{
			var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
			LEAP.postil.getallPostilDIV(text, arg.e, false);
		}
		else if (ctf == LEAP.opinion.ctf._itemContent)
		{
			//LEAP.opinion._updateContent(src);
		}
		else if (ctf == LEAP.opinion.ctf.update_frame_btn_cancel)
		{
			LEAP.opinion._updateContent_cancel(src);
		}
		else if (ctf == LEAP.opinion.ctf.update_frame_btn_confirm)
		{
			LEAP.opinion._updateContent_confirm(src);
		}
		else if (ctf == LEAP.opinion.ctf.update_frame_txt || ctf == LEAP.opinion.ctf.update_frame_sign)
		{
			src.style.backgroundColor = "#ecf5fd";
		}

	} 
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	} finally
	{
		arg = src = ctf = element = null;
	}
}

/**
 * 设置意见控件只读状态
 * 
 * @param {}
 *            element
 * @param {}
 *            _readOnly
 */
LEAP.opinion.setReadOnly = function(_element, _readOnly)
{
	try
	{
		var element = LEAP._check(_element, LEAP.opinion.d);
		if (!element || _readOnly == null)
		{
			return;
		}
		var opinioncontrol = LEAP.getElement('[ctf=' + LEAP.opinion.ctf._control + ']', element);
		if (!opinioncontrol)
		{
			// 没有初始化的时候 只用设置值
			if (_readOnly == true)
			{
				element.setAttribute("readonly", "1");
			} else if (_readOnly == false)
			{
				element.setAttribute("readonly", "-1");
			}
		} 
		else
		{
			if (_readOnly == true)
			{
				opinioncontrol.style.display = 'none';
				element.setAttribute("readonly", "1");
			} 
			else if (_readOnly == false)
			{
				if (!opinioncontrol)
					return;
					
				var hideEditor = _element.getAttribute("hideEditor");
				if (hideEditor != "1")
				{
					opinioncontrol.style.display = 'block';
				}
				else
				{
					opinioncontrol.style.display = 'none';
				}
				
				element.setAttribute("readonly", "-1");
			}
		}
	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	} finally
	{
		element = _readOnly = opinioncontrol = null;
	}
}

/**
 * 普通控件获取值的方法.
 * 
 * @param {}
 *            element
 */
LEAP.opinion.getValue = function(_element)
{
	try
	{
		var element = LEAP._check(_element, LEAP.opinion.d);
		if (element == null)
		{
			return;
		}

		// var hasValue = LEAP.opinion._hasValue(element);
		// if (hasValue == true)
		// {
		var mdid = element.getAttribute("mdid");
		if (!mdid)
			mdid = UUID.randomUUID().replaceall('-', '');
		return mdid;
		// }
		/*
		 * else { return null; }
		 */
	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	} finally
	{
		element = mdid = null;
	}

}
/**
 * 普通控件设置的方法
 * 
 * @param {}
 *            element
 * @param {}
 *            mdid
 */
LEAP.opinion.setValue = function(element, mdid)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion.d);
		if (!element)
			return;

		if (!mdid || mdid == "")
		{
			element.removeAttribute('mdid');
		} else
		{
			element.setAttribute('mdid', mdid);

			var auto = element.getAttribute('autobinding');
			if (auto != null && (!auto || auto == 'false'))
				auto = false;
			else
				auto = true;

			if (auto)
			{
				LEAP.opinion._i(element);
				LEAP.opinion.innerSetValue(element, mdid);
			}
		}

	} catch (e)
	{
		alert("错误：" + err.number + ":" + err.description);
	} finally
	{
		element = auto = null;
		LEAP.hideMask();
	}
}
/**
 * 业务意见控件绑定数据方法
 * 
 * @param {}
 *            element
 * @param {}
 *            mdid
 */
LEAP.opinion.innerSetValue = function(element, mdid)
{
	try
	{
		var fn = function()
		{
			var module = LWFP.innerApi.getmodule(element);

			var ops = module.request2(
					{
						name : 'WfGetOpinionsByMD',
						par :
						{
							mdid : mdid,
							archCategory : element.getAttribute("archCategory")
						}
					});
			if (ops != null)
			{
				for (var k = 0; k < ops.opinions.length; k++)
					LEAP.opinion.append(element, ops.opinions[k]);
			}

			ops = k = null;
		};

		setTimeout(fn, 0);
	} finally
	{
		fn = null;
	}
}

/**
 * 插入外部构造意见
 */
LEAP.opinion.appendValue = function(element, opinions)
{
	try
	{
		if (!opinions)
			return;

		var fn = function()
		{
			for (var k = 0; k < opinions.length; k++)
			{
				if (!opinions[k].hasconfirm)
					opinions[k].hasconfirm = 1;
				LEAP.opinion.append(element, opinions[k]);
			}
			k = null;
		};

		setTimeout(fn, 0);
	} finally
	{
		fn = null;
	}
}

/**
 * 设置页面是否自动绑定
 * 
 * @param {}
 *            instance
 * @param {}
 *            formElement
 * @param {}
 *            auto
 */
LEAP.opinion.setPageAutoBinding = function(instance, formElement, auto, csid)
{
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion.d + "][instance=" + instance + "]", formElement);
		if (!elements)
			return;

		for (var i = 0; i < elements.length; i++)
		{
			elements[i].setAttribute('autobinding', auto);
			if (csid)
				elements[i].setAttribute('_csid', csid);
			else
				elements[i].removeAttribute('_csid');
		}
	} finally
	{
		elements = i = null;

		LEAP.opinion2.setPageAutoBinding(instance, formElement, auto, csid);
	}
}

LEAP.opinion.setExtendParams = function(instance, formElement, extendParams)
{
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion.d + "][instance=" + instance + "]", formElement);
		if (!elements)
			return null;

		for (var i = 0; i < elements.length; i++)
		{
			elements[i]['extendParams'] = extendParams;
		}
	} finally
	{
		elements = i = null;
		LEAP.opinion2.setExtendParams(instance, formElement, extendParams);
	}
}

LEAP.opinion.enableHandsign = function(instance, formElement, h)
{
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion.d + "][instance=" + instance + "]", formElement);
		if (!elements)
			return;

		if (h != 0)
			h = 1;

		for (var i = 0; i < elements.length; i++)
		{
			elements[i].setAttribute('enablehandsign', h);
		}
	} finally
	{
		LEAP.opinion2.enableHandsign(instance, formElement, h);
	}
}
LEAP.opinion.setPageArchiveCategory = function(instance, formElement, category)
{
	if (category != null)
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion.d + "][instance=" + instance + "]", formElement);
		if (!elements)
			return;

		for (var i = 0; i < elements.length; i++)
		{
			elements[i].setAttribute('archCategory', category);
		}
	}
}

/**
 * 获取意见控件意见数据,供流程使用
 * 
 * @param {}
 *            instance
 * @param {}
 *            formElement
 * @return {}
 */
LEAP.opinion.getPageValue = function(instance, formElement)
{
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion.d + "][instance=" + instance + "]", formElement);

		var value = [];
		if (elements)
		{
			for (var i = 0; i < elements.length; i++)
			{
				var _value = LEAP.opinion._getChange(elements[i]);
				if (_value != null)
					value.add(_value);
			}
		}

		if (value.length == 0)
		{
			return LEAP.opinion2.getPageValue(instance, formElement);
		} else
		{
			return value;
		}
	} finally
	{
		elements = value = _value = null;
	}
}

LEAP.opinion.setAgentInformation = function(instance, formElement, value)
{

}

/**
 * 设置意见控件意见数据,供流程使用
 * 
 * @param {}
 *            instance
 * @param {}
 *            formElement
 * @param {}
 *            value
 */
LEAP.opinion.setPageValue = function(instance, formElement, value)
{
	try
	{
		if (LEAP.opinion._update_Frame)
		{
			LEAP.opinion._update_Frame[LEAP.opinion.ctf.update_frame_item] = null;
		}
		
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion.d + "][instance=" + instance + "]", formElement);
		if (!elements)
			return;

		for (var i = 0; i < elements.length; i++)
		{
			var element = elements[i];

			LEAP.opinion.__i(element);

			var mdid = element.getAttribute('mdid');
			if (!mdid)
			{
				mdid = UUID.randomUUID().replaceall('-', '');
				element.setAttribute('mdid', mdid);
			}

			if (value != null)
			{
				var _value = null;
				_value = value;
				for (var j = 0; j < _value.length; j++)
				{
					var ops = _value[j];
					if (ops.mdid == mdid)
					{
						LEAP.opinion.innerSetValue2(element, ops.opinions);
					}
				}
			}
		}
		var module = LWFP.innerApi.getmodule(formElement);
		if(module && module.___autoHeight)
		{
			module.___autoHeight(formElement);
		}
	} finally
	{
		elements = element = mdid = i = j = ops = _value = null;

		LEAP.opinion2.setPageValue(instance, formElement, value);
	}
}

LEAP.opinion.innerSetValue2 = function(element, opinions)
{
	try
	{
		var groupContainer = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.groupcontainer + "]", element);

		if (!opinions)
		{
			if (groupContainer)
				groupContainer.style.display = "none";
			return;
		}
		if (opinions.length == 1)
		{
			if (groupContainer)
				groupContainer.style.display = "none";
		}

		element["__data"] = opinions;

		var group = null;
		if (groupContainer)
		{
			groupContainer.style.display = "block";

			var groups = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.groupButton + "]", element);
			group = groups[0];
			for (var i = 0; i < groups.length; i++)
			{
				var tmp = groups[i];
				if ("1" == tmp.getAttribute("checked"))
				{
					group = tmp;
				}
			}
		}

		if (group && group["_data"] && true != group["_data"].isdefault)
		{
			LEAP.opinion.innerSetValue2_group(element, opinions, group);
		} else
		{
			LEAP.opinion.innerSetValue2_default(element, opinions);
		}
	} finally
	{
	}
}

LEAP.opinion.innerSetValue2_default = function(element, _opinions)
{
	var singleopinion = element.getAttribute("singleopinion");
	var _csid = element.getAttribute("_csid");
	var _idx = -1;// 限制单条时，获取当前环节当前用户最后一条索引
	//意见是否倒序展示
	var order = element.getAttribute("order");
	var opinions = [];
	if(order && order.replace(/\s+/g,"").toLowerCase()=="opiniontimedesc")
	{
		for (var i = _opinions.length-1; i > 0; i--)
		{
			opinions.push(_opinions[i]);
		}
	}
	else
		opinions = _opinions;
	
	if (singleopinion && singleopinion == "1" && _csid)
	{
		for (var i = 0; i < opinions.length; i++)
		{
			if ((opinions[i].category == _csid) && (opinions[i].handsignimg == null || opinions[i].handsignimg.isEmpty()))
				_idx = i;
		}
	}

	for (var k = 0; k < opinions.length; k++)
	{
		if (opinions[k].display == false)
			continue;

		var item = LEAP.opinion.append(element, opinions[k], (k == 0) ? null : opinions[k - 1]);
		if (k == _idx && (opinions[k].handsign == null && opinions[k].handsignimg == null))
		{
			item.style.display = "none"; // 隐藏最后一条
			LEAP.opinion._edit(item);
		}
	}

}

LEAP.opinion.groupFlag = "groupFlag";
LEAP.opinion.innerSetValue2_group = function(element, _opinions, groupSrc)
{
	var module = LWFP.innerApi.getmodule(element);
	var WF_Data = module.workflow.___data;

	var singleopinion = element.getAttribute("singleopinion");
	var _csid = element.getAttribute("_csid");
	var _idx = -1;// 限制单条时，获取当前环节当前用户最后一条索引
	//意见是否倒序展示
	var order = element.getAttribute("order");
	var opinions = [];
	if(order && order.replace(/\s+/g,"").toLowerCase()=="opiniontimedesc")
	{
		for (var i = _opinions.length-1; i > 0; i--)
		{
			opinions.push(_opinions[i]);
		}
	}
	else
		opinions = _opinions;
	
	if (singleopinion && singleopinion == "1" && _csid)
	{
		for (var i = 0; i < opinions.length; i++)
		{
			if ((opinions[i].category == _csid) && (opinions[i].handsignimg == null || opinions[i].handsignimg.isEmpty()))
				_idx = i;
		}
	}

	var list = LEAP.getElement("div[ctf=" + LEAP.opinion.ctf._list + "]", element);
	var groupDef = groupSrc["_data"];
	var enterActions = groupDef.enteractions.split(",");
	var steps = groupDef.steps.split(",");

	// 首先将分组入口意见打上标记__groupPrevCategory
	for (var i = 0; i < opinions.length; i++)
	{
		var op = opinions[i];
		if (op.display == false)
			continue;
		
		var step = WF_Data.__stephash.getvalue(op.category);		
		if (step && enterActions.contains(step.enterActName))
		{
			op.__groupPrevCategory = step.prevId + "_" + step.enteractionid; //发散可能来源于同一个prevId，因此加上enteractionid
		}
	}
	//处理断头意见（即入口环节没有填意见，入口后续的环节填的意见）
	for (var i = 0; i < opinions.length; i++)
	{
		var op = opinions[i];
		if (op.display == false)
			continue;
		
		if (op.__groupPrevCategory == null && steps.contains(op.categoryUniqueName))
		{
			var _enterStep = LEAP.opinion.__group_getEnterStep(WF_Data, enterActions, steps, op.category);
			op.__groupPrevCategory = _enterStep.prevId + "_" + step.enteractionid;
		}
	}

	var lastIsGroup = false;
	var hash = new hashtable(); // 记录已经绑定的hash
	for (var i = 0; i < opinions.length; i++)
	{
		var op = opinions[i];
		if (hash.contains(op.id))
			continue;

		var topicList = null;
		var groupList = null;
		if (op.__groupPrevCategory)
		{// 遇到需要分组
			if (!topicList)
				topicList = LEAP.getElement("[" + LEAP.opinion.groupFlag + "=" + op.__groupPrevCategory + "]", element);
						
			if (!topicList)
			{ // 第一次遇到没有分栏，则建分栏
				topicList = document.createElement("div");
				topicList.setAttribute("ctf", LEAP.opinion.ctf.topic_list);
				topicList.className = "wfcontrol_opinion_topicList";
				topicList.setAttribute(LEAP.opinion.groupFlag, op.__groupPrevCategory);

				var topic = document.createElement("div");
				topic.setAttribute("ctf", LEAP.opinion.ctf.topic);
				topic.className = "wfcontrol_opinion_topic";

				var topicTitle = document.createElement("span");
				topicTitle.setAttribute("ctf", LEAP.opinion.ctf.topicTitle);
				if (groupDef.topicTitle)
					topicTitle.textContent = groupDef.topicTitle;
				else
					topicTitle.textContent = op.categoryName + "意见";
				
				topicTitle.className = "wfcontrol_opinion_topictitle";

				var topicFolding = document.createElement("span");
				topicFolding.setAttribute("ctf", LEAP.opinion.ctf.topicFolding);
				topicFolding.textContent = "收起";
				topicFolding.className = "wfcontrol_opinion_topicfolding wfcontrol_opinion_topicfolding_col";
				
				topic.appendChild(topicTitle);
				topic.appendChild(topicFolding);
				topicList.appendChild(topic);

				list.appendChild(topicList);
			}

			if (!groupList)
			{// 第一次遇到木有分组，则创建分组
				var groupList = document.createElement("div");
				groupList.setAttribute("ctf", LEAP.opinion.ctf.group_list);
				groupList.className = "wfcontrol_opinion_groupList";

				var group = document.createElement("div");
				group.setAttribute("ctf", LEAP.opinion.ctf.group);
				group.className = "wfcontrol_opinion_groupItem";

				var groupTitle = document.createElement("span");
				groupTitle.setAttribute("ctf", LEAP.opinion.ctf.groupTitle);
				groupTitle.textContent = ((groupDef.organtype == "1") ? ("【" + op.top2orgname + "】") : ("【" + op.organname + "】"));
				groupTitle.className = "wfcontrol_opinion_groupTitle";

				var groupFolding = document.createElement("span");
				groupFolding.setAttribute("ctf", LEAP.opinion.ctf.groupFolding);
				groupFolding.textContent = "隐藏";
				groupFolding.className = "wfcontrol_opinion_groupFolding wfcontrol_opinion_groupFolding_col";

				group.appendChild(groupTitle);
				group.appendChild(groupFolding);
				groupList.appendChild(group);

				topicList.appendChild(groupList);
			}

		}
		
		//绑定意见 
		var item = LEAP.opinion.append(element, op);
			item.className = "wfcontrol_opinion_item wfcontrol_opinion_item_inner";
			item.setAttribute("opid", op.id);
		hash.add(op.id); 
		if (i == _idx) 
		{ 
			item.setAttribute("editting", "1");
			item.style.display = "none";//隐藏最后一条 
			LEAP.opinion._edit(item); 
		}		
		if (groupList)
		{ //有分组时拉到分组里面来
			groupList.appendChild(item);
		}
		
		if (groupList)
		{ // 绑定分组后续意见
			for (var k = i + 1; k < opinions.length; k++)
			{
				var _op = opinions[k];
				var _flag = LEAP.opinion.__group_checkCagegoryIsAfterGroup(WF_Data, enterActions, steps, _op.category, op.category);
				if (true == _flag)
				{
					var _item = LEAP.opinion.append(element, _op);
						_item.className = "wfcontrol_opinion_item wfcontrol_opinion_item_inner";
						_item.setAttribute("opid", _op.id);
					hash.add(_op.id);
					if (k == _idx)
					{
						_item.setAttribute("editting", "1");
						_item.style.display = "none"; // 隐藏最后一条
						LEAP.opinion._edit(_item);
					}
					
					//拉到分组里面来
					groupList.appendChild(_item);
					
				}
			}
		}
	}
	
	//某分栏某分组最后一条意见隐藏时，如果意见唯一则分组或分栏隐藏
	var topicLists = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.topic_list + "]", element);
	if (topicLists)
	{
		for(var i=0; i<topicLists.length; i++)
		{
			var topicList = topicLists[i];
			var groupLists = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.group_list + "]", topicList);
			if (groupLists)
			{
				for(var k=0; k<groupLists.length; k++)
				{
					var groupList = groupLists[k];
					var items = LEAP.getElements("[ctf=" + LEAP.opinion.ctf._item + "]", groupList);
					if (items && items.length == 1 && items[0].style.display == "none")
					{
						groupList.style.display = "none";
						
						if (groupLists.length == 1)
							topicList.style.display = "none";
					}
				}
			}		
		}
	}
	
	LEAP.opinion._default_foldding(element);
}

LEAP.opinion._default_foldding = function(element)
{
	var groupsfoldding = element.getAttribute("groupsfoldding");
	if (!groupsfoldding)
		return;
		
	if (groupsfoldding == "1" || groupsfoldding == "2")
	{
		var arr = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.groupFolding + "]", element);
		if (arr != null)
		{
			for(var i=0; i<arr.length; i++)
			{
				LEAP.opinion._group_foldding(arr[i]);		
			}
		}
	}
	
	if (groupsfoldding == "2")
	{
		var arr = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.topicFolding + "]", element);
		if (arr != null)
		{
			for(var i=0; i<arr.length; i++)
			{
				LEAP.opinion._topic_foldding(arr[i]);		
			}
		}
	}
	
	
	
}

LEAP.opinion._topic_foldding = function(src)
{
	var topicList = LEAP._match(src, LEAP.opinion.ctf.topic_list, "ctf");		
	var groups = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.group_list + "]", topicList);
	var btn = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.topicFolding + "]", topicList);
	
	var b = false;
	if (btn.className == "wfcontrol_opinion_topicfolding wfcontrol_opinion_topicfolding_col")
	{
		b = "none";
		btn.className = "wfcontrol_opinion_topicfolding wfcontrol_opinion_topicfolding_exp";
		btn.textContent = "展开";
	}
	else
	{
		b = "inline-block";
		btn.className = "wfcontrol_opinion_topicfolding wfcontrol_opinion_topicfolding_col";
		btn.textContent = "收起";
	}
	
	if (groups != null)
	{
		for(var i=0; i<groups.length; i++)
			groups[i].style.display = b;
	}		
}

LEAP.opinion._group_foldding = function(src)
{
	var groupList = LEAP._match(src, LEAP.opinion.ctf.group_list, "ctf");		
	var ops = LEAP.getElements("[ctf=" + LEAP.opinion.ctf._item + "]", groupList);
	var btn = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.groupFolding + "]", groupList);
	
	var b = false;
	if (btn.className == "wfcontrol_opinion_groupFolding wfcontrol_opinion_groupFolding_col")
	{
		b = "none";
		btn.className = "wfcontrol_opinion_groupFolding wfcontrol_opinion_groupFolding_exp";
		btn.textContent = "显示";
	}
	else
	{
		b = "inline-block";
		btn.className = "wfcontrol_opinion_groupFolding wfcontrol_opinion_groupFolding_col";
		btn.textContent = "隐藏";
	}
	
	if (ops != null)
	{
		for(var i=0; i<ops.length; i++)
		{
			if (ops[i].getAttribute("editting"))
				continue;
			
			ops[i].style.display = b;			
		}
	}		
		
}


LEAP.opinion.__group_checkCagegoryIsAfterGroup = function(wfdata, enterActions, steps, category, preCategory)
{// 判断当前意见步骤是否是指定分组入口环节的后续步骤
	var rst = false;

	var step = wfdata.__stephash.getvalue(category);
	if (enterActions.contains(step.enterActName))
		return false;

	if (steps.contains(step.stepname))
	{
		var prev = step.prev;
		while (prev != null)
		{
			if (prev.hsid == preCategory)
			{
				rst = true;
				break;
			}

			if (enterActions.contains(prev.enterActName))
				break; // 到达入口还未匹配到则，防止其他分组的意见进入本分组

			prev = prev.prev;
		}
	}

	return rst
}

LEAP.opinion.__group_getEnterStep = function(wfdata, enterActions, steps, category)
{//
	var step = wfdata.__stephash.getvalue(category);
	if (enterActions.contains(step.enterActName))
		return null;

	if (steps.contains(step.stepname))
	{
		var prev = step.prev;
		while (prev != null)
		{
			if (enterActions.contains(prev.enterActName))
				return prev;

			prev = prev.prev;
		}
	}

	return null
}


LEAP.opinion._groupClick = function(element, groupSrc)
{
	var list = LEAP.getElement("div[ctf=" + LEAP.opinion.ctf._list + "]", element);
	if (list)
		list.innerHTML = "";

	var opinions = element["__data"];
	if (true != groupSrc["_data"].isdefault)
	{
		LEAP.opinion.innerSetValue2_group(element, opinions, groupSrc);
	} else
	{
		LEAP.opinion.innerSetValue2_default(element, opinions);
	}

	var groups = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.groupButton + "]", element);
	for (var i = 0; i < groups.length; i++)
	{
		var tmp = groups[i];
		if (tmp.value == groupSrc.value)
		{
			tmp.setAttribute("checked", "1");
			tmp.className = "LC_button_conner wfcontrol_opinion_group_check";
		} else
		{
			tmp.setAttribute("checked", "0");
			tmp.className = "LC_button_conner wfcontrol_opinion_group";
		}
	}
	
	ElementEventManager.handleEvent(element, "onGroupChange", groupSrc["_data"]);

}

/**
 * 控件验证: 此方式使用场景:意见控件需要添加验证.没有填写意见不允许保存
 * 
 * 业务方法说明: 此方法用来判断意见控件是否有值,分三种情况 1.判断文本框中是否有值 2.判断列表清单中是否有新增的（包括前一次保存的和本次新填写的）
 * 
 * @return String 校验不通过返回 null，否则返回任意值
 */
LEAP.opinion.validate = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion.d);
		if (element == null)
			return true;

		// 1.判断文本框中是否有值
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);

		var ptxt = element.getAttribute(LEAP.opinion.ctf.postiltxt);
		if (text != null && text.value != "" && text.value != ptxt)
			return true;

		// 2.判断已填写的意见中是否存在新增意见
		var bool = false;
		var addobjs = LEAP.getElements("[ctf=" + LEAP.opinion.ctf._item + "]", element);
		if (!addobjs)
		{
			bool = false;
		} else
		{
			for (var i = 0; i < addobjs.length; i++)
			{
				if (addobjs[i] && addobjs[i]._obj)
				{
					if (!addobjs[i]._obj.opiniontype)
					{
						if (addobjs[i]._obj.hasconfirm == 0) // 判断是否有上次保存提交的
						{
							bool = true;
							break;
						}
					} else if (addobjs[i]._obj.opiniontype == 0 || addobjs[i]._obj.opiniontype == 1)
					{ // 本次填写的 或者
						// 本次修改的
						bool = true;
					}
				}
			}
		}

		if (bool == false)
			return null;
		else
			return true;

	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	} finally
	{
		element = bool = text = addobjs = i = null;
	}
}

/**
 * 获取插件当前的值,返回数组
 * 
 * @param {}
 *            element
 */
LEAP.opinion.getCurrentValues = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion.d);
		if (element == null)
			return;

		var obj = [];
		var addobjs = LEAP.getElements("[ctf=" + LEAP.opinion.ctf._item + "]", element);
		if (addobjs)
		{
			for (var i = 0; i < addobjs.length; i++)
			{
				if (addobjs[i])
				{
					var itemobj = addobjs[i]['_obj'];
					if (itemobj && itemobj.opiniontype == 0)
					{
						obj.add(itemobj);
					}
				}
			}
		}
		// 判断输入框中是否有值有的话，把此值也添加进change
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		var ptxt = element.getAttribute(LEAP.opinion.ctf.postiltxt);
		if (text != null && !text['edititem'] && text.value != "" && text.value != ptxt)
		{
			var t_value = text.value;
			var obj1 =
			{};
			obj1.opiniontype = 0;
			obj1.entryid = element.getAttribute('entryid');
			obj1.parentid = "";
			obj1.entrymdid = element.getAttribute('mdid');
			obj1.opinioncontent = t_value;
			obj1.hasconfirm = 0;
			obj1.username = LEAP.userInfo.fullName;
			obj1.userflag = LEAP.userInfo.userflag;
			obj1.opiniontime =
			{
				time : LEAP.getServerTimeTicket()
			}; // {time : LEAP.getServerTime()};
			obj.add(obj1);
		}
		if (obj.length == 0)
		{
			return null;
		} else
		{
			return obj;
		}

	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return null;
	} finally
	{
		element = obj = itemobj = addobjs = obj1 = t_value = text = null;
	}
}

LEAP.opinion._hasValue = function(_element)
{
	try
	{
		var element = LEAP._check(_element, LEAP.opinion.d);
		if (element == null)
			return false;

		var _obj = element['changeobj'];
		if (_obj != null)
			return true;

		var addobjs = LEAP.getElements("[ctf=" + LEAP.opinion.ctf._item + "]", element);
		if (addobjs)
			return true;

		// 判断输入框中是否有值有的话，把此值也添加进change
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		var ptxt = element.getAttribute(LEAP.opinion.ctf.postiltxt);
		if (text != null && !text['edititem'] && text.value != "" && text.value != ptxt)
			return true;

		return false;
	} finally
	{
		element = _obj = addobjs = text = null;
	}
}

/**
 * 控件取值
 * 
 * 业务方法说明:
 * 1.取last_changeobj,如果没有表示第一次进入此element._getChange方法,此时返回A列表中新增的值.B.与文本框中值的集合.C.删除的对象
 * 2.存在last_changeobj,说明已经执行说element._getChange方法
 * 2.1判断是否执行过数据校验的方法,如果没有直接返回last_changeobj 2.2如果执行数据校验方法. 2.2.1
 * 校验成功直接返回last_changeobj 2.2.2 校验失败.在原对象中再次进行数据添加A列表中新增的值.B.与文本框中值的集合.C.删除的对象
 * 
 * @param {}
 *            element
 */
LEAP.opinion._getChange = function(_element)
{
	try
	{
		var element = LEAP._check(_element, LEAP.opinion.d);
		if (element == null)
			return;
		
		var obj = [];

		// 输入框有值的话，先变更
		//LEAP.opinion.addopinion(element);
		// 判断输入框中是否有值有的话，把此值也添加进change
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		var singleopinion = element.getAttribute("singleopinion");
		var ptxt = element.getAttribute(LEAP.opinion.ctf.postiltxt);
		var atts = LEAP.opinion._attachment_getAtts(element);
		var t_edittime = (text['__edittime'] == null) ? 0 : text['__edittime'];
		
		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._specialsign + "]", element);
		var t_specialsign = null;
		if (specialsign)
			t_specialsign = specialsign.value;
		
		
		if (text['edititem'])
		{
			var t_value = text.value;
			if ((t_value && t_value != "" && t_value != ptxt) || atts)
			{
				if(t_value == ptxt)
					t_value = "";
				LEAP.opinion.update(text['edititem'], t_value, t_specialsign, t_edittime, atts);
			} 
			else if (singleopinion == "1" && (t_value == "" || t_value == ptxt))
			{
				LEAP.opinion._delete(text['edititem']);
			}
		} 
		else if ((text != null && !text['edititem'] && text.value != "" && text.value != ptxt) || atts)
		{
			var t_value = text.value;
			var obj1 =
			{};
			
			if(t_value == ptxt)
				t_value = "";
			obj1.opiniontype = 0;
			obj1.entryid = element.getAttribute('entryid');
			obj1.parentid = "";
			obj1.entrymdid = element.getAttribute('mdid');
			obj1.opinioncontent = t_value;
			obj1.hasconfirm = 0;
			obj1.username = LEAP.userInfo.fullName;
			obj1.userflag = LEAP.userInfo.userflag;
			obj1.opiniontime =
			{
				time : LEAP.getServerTimeTicket()
			}; // {time : LEAP.getServerTime()};
			obj1.specialsign = t_specialsign;
			obj1.opatts = atts;

			obj.add(obj1);
		}
		

		var _obj = element['changeobj'];
		if (_obj && _obj.length > 0)
		{
			for (var i = 0; i < _obj.length; i++)
				obj.add(_obj[i]);
		}

		var addobjs = LEAP.getElements("[ctf=" + LEAP.opinion.ctf._item + "]", element);
		if (addobjs)
		{
			for (var i = 0; i < addobjs.length; i++)
			{
				if (addobjs[i])
				{
					var itemobj = addobjs[i]['_obj'];
					if (itemobj && itemobj.opiniontype == 0)
					{
						obj.add(itemobj);
					}
				}
			}
		}

		

		if (obj.length == 0)
		{
			return null;
		} else
		{
			return {mdid : element.getAttribute('mdid'),opinions : obj};
		}

	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return null;
	} finally
	{
		element = obj = itemobj = addobjs = _obj = null;
	}
}

/**
 * 意见控件删除按钮事件
 * 
 * @param {}
 *            element
 * @param {}
 *            src
 */
LEAP.opinion._delete = function(src)
{
	try
	{
		if (!src)
			return;
		var element = LEAP._match(src, LEAP.opinion.d);
		if (!element)
			return;
		
		var update_Frame = LEAP.getElement("[ctf=" +  LEAP.opinion.ctf.update_frame + "]");		
		if (update_Frame != null && update_Frame[LEAP.opinion.ctf.update_frame_item] && update_Frame.style.display == "block")
		{
			var _txtArea = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.update_frame_txt + "]", update_Frame);
			_txtArea.style.backgroundColor = "#FFDDDD";
			
			LEAP.messagebox.alert("请先完成正在修改意见。")
			return;
		}
			
		var opinionlistdiv = LEAP.getElement('[ctf=' + LEAP.opinion.ctf._list + ']', element);
		var item = LEAP._match(src, LEAP.opinion.ctf._item, "ctf");
		if (!item)
			return;
		var obj = item._obj;
		if (!obj)
			return;
		
		var module = LWFP.innerApi.getmodule(element);
		if(module && module.WFBeforeDeleteOpinion)
		{
			var ret = module.WFBeforeDeleteOpinion({element:element,item:item,opinion:obj});
			if(!ret)
				return;
		}
		
		var changeobj = element['changeobj'];
		if (!changeobj)
		{
			changeobj = [];
			element['changeobj'] = changeobj;
		}
		// 等于0表示是新增的，则不缓存
		if (obj.opiniontype == null || (obj.opiniontype != null && obj.opiniontype != 0))
		{
			obj.opiniontype = 2;
			changeobj.add(obj);
			element['changeobj'] = changeobj;
		}
		LEAP.removeElement(item);

		LEAP.opinion.clear_txt(element);
		LEAP.opinion._attachment_clearAtts(element);
		
		ElementEventManager.handleEvent(element, "onDelete");
	} catch (e)
	{
		alert("错误：" + e.number + ":" + e.description);
	} finally
	{
		element = src = opinionlistdiv = item = changeobj = obj = null;
	}
}

LEAP.opinion._updateContent = function(src)
{
	try
	{
		var item = LEAP._match(src, LEAP.opinion.ctf._item, "ctf");
		var element = LEAP._match(item, LEAP.opinion.d);
		var data = item['_obj'];
		
		if (element.getAttribute('readonly') == "1" || data.canUpdate != true)
			return;
		
		var update_Frame = LEAP.getElement("[ctf=" +  LEAP.opinion.ctf.update_frame + "]");		
		if (update_Frame == null)
		{
			update_Frame = document.createElement("div");
			update_Frame.className = "wfcontrol_opinion_update_frame";
			update_Frame.setAttribute("ctf", LEAP.opinion.ctf.update_frame);
			
			var txtarea = document.createElement("textarea");
				txtarea.rows = 5;
				txtarea.setAttribute("ctf", LEAP.opinion.ctf.update_frame_txt);
				txtarea.setAttribute("check", 'maxlen:8000');
				//txtarea.setAttribute("heightauto", "1");
			
			var input = document.createElement("input");
				input.setAttribute("ctf", LEAP.opinion.ctf.update_frame_sign);			
			
			var btndiv = document.createElement("div");
			
			var btnConfirm = document.createElement("span");
				btnConfirm.setAttribute("ctf", LEAP.opinion.ctf.update_frame_btn_confirm);
				btnConfirm.innerText = "确定";
			var btnCancel = document.createElement("span");
				btnCancel.setAttribute("ctf", LEAP.opinion.ctf.update_frame_btn_cancel);
				btnCancel.innerText = "取消";
			
			btndiv.appendChild(btnCancel);
			btndiv.appendChild(btnConfirm);
			
			update_Frame.appendChild(txtarea);
			update_Frame.appendChild(input);
			update_Frame.appendChild(btndiv);
		}
		//element.appendChild(update_Frame);
		document.body.appendChild(update_Frame);
		
		var _txtArea = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.update_frame_txt + "]", update_Frame);
		if (update_Frame != null && update_Frame[LEAP.opinion.ctf.update_frame_item] && update_Frame.style.display == "block")
		{
			_txtArea.style.backgroundColor = "#FFDDDD";
			
			LEAP.messagebox.alert("请先完成正在修改意见。")
			return;
		}

		_txtArea.value = data.opinioncontent;
		_txtArea.style.backgroundColor = "#ecf5fd";
		_txtArea.style.height = "auto";
		var _inputSign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.update_frame_sign + "]", update_Frame);
			_inputSign.style.backgroundColor = "#ecf5fd";
		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._specialsign + "]", element);
		if (specialsign)
		{
			_inputSign.style.display = "block";
			if (data.specialsign)
				_inputSign.value = data.specialsign;
			else
				_inputSign.value = "";
		}
		else
		{
			_inputSign.style.display = "none";
		}		
		update_Frame[LEAP.opinion.ctf.update_frame_item] = item;
		
		/*var rect1 = element.getBoundingClientRect();
		var rect2 = item.getBoundingClientRect();
		
		update_Frame.style.top = (rect2.top - rect1.top) + "px";
		update_Frame.style.left = (rect2.left - rect1.left) + "px";
		update_Frame.style.width = rect2.width + "px";*/
				
		var min_h = 200; //最小高度
		var margin = 200; //上下边距
		var item_rect = item.getBoundingClientRect();		
		var src_rect = src.getBoundingClientRect();
		var x = item_rect.left;
		var y = (item_rect.top < margin) ? ( (src_rect.top<margin) ? src_rect.top : margin ) : (item_rect.top);
		var w = item_rect.width;
		var h = (item_rect.height + 100 < min_h) ? min_h : (item_rect.height + 100);

		if (h > document.body.clientHeight - margin*2) 
		{//较高
			h = document.body.clientHeight - margin - y;
			if ((y + h) < src_rect.top)
			{//底部尽可能靠按钮
				h = src_rect.top - y;
			}
		}
		else
		{//不高			
			if (document.body.clientHeight - y - h < margin) //不高但是底部超范围
				y = src_rect.top - h;
		}		
							
		update_Frame.style.top = y + "px";
		update_Frame.style.left = x + "px";
		update_Frame.style.width = w + "px";
		update_Frame.style.height = h + "px";
		
		_txtArea.style.height = (h - 100) + "px";
	
		update_Frame.style.display = "block";
		
		//LEAP.opinion._updateContent_autoHeight(_txtArea);
		
		ElementEventManager.handleEvent(element, "onEdit", {update_Frame:update_Frame} );
	}
	finally
	{
		item = element = data = txtarea = btndiv = btnConfirm = btnDelete = btnCancel = rect1 = rect2 = _txtArea = null;
	}
}

/*
		检查修改意见未完成的操作（意见修改页面显示且属于当前流程）
 */
/*
		检查修改意见未完成的操作（意见修改页面显示且属于当前流程）
 */
LEAP.opinion.checkNoneUpdateOpinion = function(instance,element){
	var update_Frame = LEAP.getElement("[ctf=" +  LEAP.opinion.ctf.update_frame + "]");	
	if(update_Frame){
		if(update_Frame.style.display == "block"){
			var itemdata =  update_Frame[LEAP.opinion.ctf.update_frame_item];
			if(itemdata && itemdata._obj && itemdata._obj.entrymdid){
				if(LEAP.getElement("[mdid=" + itemdata._obj.entrymdid + "][instance=" + instance + "]", element)){
					return true;
				}
			}
		}
		return false;
	}
	return false;
}

/*LEAP.opinion._updateContent_autoHeight = function(src)
{
	var lastH = src.scrollHeight ;
	if(lastH && lastH >0)
	{
		src.style.minHeight = lastH + "px";
		src.style.height = lastH + "px";
	    src.style["overflow"] = "hidden";
	}
}*/

LEAP.opinion._updateContent_cancel = function(src)
{
	var update_Frame = LEAP._match(src, LEAP.opinion.ctf.update_frame, "ctf");
	if (update_Frame)
	{
		update_Frame.style.display = "none";
		update_Frame[LEAP.opinion.ctf.update_frame_item] = null;
	}
}

LEAP.opinion._updateContent_confirm = function(src)
{
	var update_Frame = LEAP._match(src, LEAP.opinion.ctf.update_frame, "ctf");
	
	var item = update_Frame[LEAP.opinion.ctf.update_frame_item];
	var element = LEAP._match(item, LEAP.opinion.d);
	
	var _txtArea = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.update_frame_txt + "]", update_Frame);
	var _inputSign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.update_frame_sign + "]", update_Frame);
	
	var t_value = _txtArea.value;
	var t_specialsign = null;
	var flag = true;
	if (t_value && t_value != "")
	{
		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._specialsign + "]", element);
		if (specialsign)
		{			
			t_specialsign = _inputSign.value;
		}
	}
	else
	{
		flag = false;
		_txtArea.style.backgroundColor = "#FFDDDD";
	}
	
	if (flag == true)
	{
		var _op = item['_obj'];
		
		var flag = true;
		if (0 != _op.opiniontype)
		{
			var module = LWFP.innerApi.getmodule(element);
			if (module.workflow && module.workflow.getEntry())
			{	
				var _obj = LWFP.innerApi.clone( _op );
				_obj.opinioncontent = t_value;
				_obj.opiniontype = 1;
				_obj.specialsign = t_specialsign;
				
				var ret = module.request2({name:'WfUpdateOpinion', par:{datasource:module.workflow.getData().datasource, ops:_obj}});
				if (true != ret)
				{
					flag = false;
					alert("修改失败");
				}
			}
		}
		
		if (flag == true)
		{
			LEAP.opinion.update(item, t_value, t_specialsign, null, _op.opatts);
			update_Frame[LEAP.opinion.ctf.update_frame_item] = null;
			update_Frame.style.display = "none";
		}
		
	}
}


LEAP.opinion._edit = function(src)
{
	try
	{
		var element = LEAP._match(src, LEAP.opinion.d);

		var item = LEAP._match(src, LEAP.opinion.ctf._item, "ctf");
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);

		var _obj = item['_obj'];

		text.value = _obj.opinioncontent;

		LEAP.opinion._attachment_bindUpload(element, _obj.opatts);

		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._specialsign + "]", element);
		if (specialsign)
		{
			if (_obj.specialsign)
				specialsign.value = _obj.specialsign;
			else
				specialsign.value = "";
		}

		text['edititem'] = item;
		text.style.color = LEAP.postil._color._normal;
	} catch (e)
	{
		alert("错误：" + e.number + ":" + e.description);
	} finally
	{
		element = item = text = _obj = null;
	}
}

LEAP.opinion.setDefaultOpinion = function(element, txt)
{
	try
	{
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		if (!text)
			return;

		if (txt == null || txt.isEmpty())
			text.value = null;
		else
			text.value = txt;
	} finally
	{
		txt = null;
	}
}

/**
 * 意见控件添加意见
 * 
 * @param {}
 *            element
 */
LEAP.opinion.addopinion = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion.d);
		if (!element)
			return;
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		if (!text)
			return;

		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._specialsign + "]", element);
		var t_specialsign = null;
		if (specialsign)
			t_specialsign = specialsign.value;

		var singleopinion = element.getAttribute("singleopinion");
		var ptxt = element.getAttribute(LEAP.opinion.ctf.postiltxt);

		var atts = LEAP.opinion._attachment_getAtts(element);

		var t_edittime = (text['__edittime'] == null) ? 0 : text['__edittime'];
		if (text['edititem'])
		{
			try
			{
				var t_value = text.value;
				if  ((t_value && t_value != "" && t_value != ptxt) || atts)
				{
					if(t_value == ptxt)
						t_value = "";
					LEAP.opinion.update(text['edititem'], t_value, t_specialsign, t_edittime, atts);
				} 
				else if (singleopinion == "1" && (t_value == "" || t_value == ptxt))
				{
					LEAP.opinion._delete(text['edititem']);
				}
			} 
			finally
			{
				LEAP.opinion.clear_txt(element);
				LEAP.opinion._attachment_clearAtts(element);
			}
		} 
		else
		{
			//if (singleopinion != "1")
			{
				var t_value = text.value;
				if ((!t_value || t_value == ptxt) && !atts)
					return;
				
				if(t_value == ptxt)
					t_value = "";

				var obj =
				{};
				obj.opiniontype = 0;
				obj.entryid = element.getAttribute('entryid');
				obj.parentid = "";
				obj.entrymdid = element.getAttribute('mdid');
				obj.opinioncontent = t_value;
				obj.hasconfirm = 0;
				obj.username = LEAP.userInfo.fullName;
				obj.userflag = LEAP.userInfo.userflag;
				obj.opiniontime =
				{
					time : LEAP.getServerTimeTicket()
				}; // {time : LEAP.getServerTime()};
				obj.canDelete = true;
				obj.canUpdate = true;
				obj.opatts = atts;

				if (t_specialsign)
					obj.specialsign = t_specialsign;
				obj._edit_time = t_edittime;

				LEAP.opinion.append(element, obj);

				LEAP.opinion.clear_txt(element);
				LEAP.opinion._attachment_clearAtts(element);
			}
		}
		
		ElementEventManager.handleEvent(element, "onConfirm");
		
	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	} finally
	{
		element = text = specialsign = t_edittime = t_specialsign = t_value = singleopinion = null;
	}
}

LEAP.opinion.___processimg = function(url, target, callback, domain)
{
	var img = new Image();
	var imgctid = LEAP.ctid(img);
	var targetctid = null;
	if (target && target.tagName)
	{
		targetctid = LEAP.ctid(target);
		// target.style.display = 'none';
	}
	if (domain == null)
		domain = window;
	if (callback == null)
	{
		callback = function(arg)
		{
			if (arg.target)
			{
				var target = LEAP.getElement('IMG[ctid=' + arg.target + ']');
				if (target)
				{
					if (arg.error)
					{
						// target.style.display = 'none';
					} else
					{
						var trgSize =
						{
							W : target.parentElement.clientWidth,
							H : target.parentElement.clientHeight
						};

						var w = arg.width;
						var h = arg.height;
						if (arg.width > target.parentElement.clientWidth)
						{
							w = target.parentElement.clientWidth;
							h = Math.floor(arg.height * (target.parentElement.clientWidth - 5) / arg.width);
						}

						target.style.width = w + "px";
						target.style.height = h + "px";
						target.src = arg.url;
					}
				}
				target = trgSize = w = h = null;
			}
		}
	}
	if (LEAPBrowser.isIE && LEAPBrowser.IEVersion < 11)
	{
		img.onreadystatechange = function()
		{
			if (img.readyState == "complete" || img.readyState == "loaded")
			{
				LEAP.asyn(callback, domain, 400,
						{
							url : url,
							error : false,
							target : targetctid,
							width : img.width,
							height : img.height
						});
				/*
				 * callback.apply(domain, [ { url : url, error : false, target :
				 * targetctid, width : img.width, height : img.height }]);
				 */
				img = null;
			}
		}
	} else
	{
		img.onload = function()
		{
			if (img.complete == true)
			{
				LEAP.asyn(callback, domain, 400,
						{
							url : url,
							error : false,
							target : targetctid,
							width : img.width,
							height : img.height
						});
				/*
				 * callback.apply(domain, [ { url : url, error : false, target :
				 * targetctid, width : img.width, height : img.height }]);
				 */
				img = null;
			}
		}
	}
	img.onerror = function()
	{
		callback.apply(domain, [
						{
							url : url,
							error : true,
							target : targetctid,
							width : null,
							height : null
						}]);
		img = null;
	}
	img.src = url;
	target = null;
}

/**
 * 意见列表添加方法
 * 
 * @param {}
 *            element
 * @param {}
 *            opinion
 */
LEAP.opinion.append = function(element, opinion, prev)
{
	try
	{
		var opinionlistdiv = LEAP.getElement('[ctf=' + LEAP.opinion.ctf._list + ']', element);
		if (opinionlistdiv == null)
			return;

		var item = document.createElement("DIV");
		item.setAttribute('ctf', LEAP.opinion.ctf._item);
		item.className = 'wfcontrol_opinion_item';
		item.setAttribute("opid", opinion.id);
		item['_obj'] = opinion;

		opinionlistdiv.appendChild(item);

		// 内容
		if (opinion.handsign != null && opinion.handsign != "")
		{
			var handsign = opinion.handsign;
			if (typeof(opinion.handsign) == "string")
				handsign = JSON.parse(opinion.handsign);
			item['handsignValue'] = handsign;

			if (opinion.categoryName && element.getAttribute('showstepname') && (element.getAttribute('showstepname') == "1" || element.getAttribute('showstepname') == "2"))
			{
				var _span = document.createElement("span");
				_span.style.styleFloat = "left";
				_span.style.fontSize = (element.getAttribute("itmfontsize") == null) ? "14px" : element.getAttribute("itmfontsize") + "px";
				_span.style.fontFamily = "'楷体','Microsoft Yahei','宋体','黑体'";
				_span.innerText = opinion.categoryName + "：";

				item.appendChild(_span);
				if (element.getAttribute('showstepname') == "2")
					item.appendChild(document.createElement("br"));
			}

			var url = LEAP.upload.getPath(handsign.nameedPath || handsign.nameedpath, handsign.viewName || handsign.viewname, handsign.uuid, null, null, null, null, handsign.fileid, LEAP.wfrouter.router);
			var _img = document.createElement("img");
			item.appendChild(_img);
			LEAP.opinion.___processimg(url, _img, null, LEAP.opinion);
			_img.style.styleFloat = "left";
			_img.setAttribute("ctf", LEAP.opinion.ctf._handsignViewer);
		} else if (opinion.handsignimg != null && opinion.handsignimg != "")
		{
			var handsignimg = opinion.handsignimg;
			item['handsignValue'] = handsignimg;

			var _img = document.createElement("img");
			item.appendChild(_img);
			_img.style.styleFloat = "left";
			_img.setAttribute("ctf", LEAP.opinion.ctf._handsignViewer);
			_img.setAttribute("src", "data:image/jpeg;base64," + handsignimg);
		} 
		else
		{
			var _div = document.createElement("div");
			_div.style.textAlign = "left";
			_div.style.styleFloat = "left";
			_div.setAttribute("ctf", LEAP.opinion.ctf._itemContent);
			_div.style.fontSize = (element.getAttribute("itmfontsize") == null) ? "14px" : element.getAttribute("itmfontsize") + "px";
						
			if (opinion.opinioncontent == null)
				opinion.opinioncontent = "";

			if (opinion.categoryName && element.getAttribute('showstepname') && (element.getAttribute('showstepname') == "1" || element.getAttribute('showstepname') == "2"))
			{
				_div.style.textIndent = "";
				_div.innerHTML = "<span style='font-Family:\"楷体\",\"Microsoft Yahei\",\"宋体\",\"黑体\";'>" + opinion.categoryName + "：</span>" + ((element.getAttribute('showstepname') == "2") ? "<br/>&emsp;&emsp;" : "") + opinion.opinioncontent.replace(/(^\s*)|(\s*$)/g, "").replaceall(" ", "&nbsp;").replaceall("\n", "\r\n").replaceall("\r\n", "<br>&emsp;&emsp;");
			}
			else
			{
				//_div.style.textIndent = Number(_div.style.fontSize.replaceall("px", "")) * 2 + "px";
				//_div.innerHTML = opinion.opinioncontent.replace(/(^\s*)|(\s*$)/g, "").replaceall(" ", "&nbsp;").replaceall("\n", "\r\n").replaceall("\r\n", "<br>");
				//_div.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + opinion.opinioncontent.replace(/(^\s*)|(\s*$)/g, "").replaceall(" ", "&nbsp;").replaceall("\n", "\r\n").replaceall("\r\n", "<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
				var opinioncontent = opinion.opinioncontent.replace(/(^\s*)|(\s*$)/g, "").replaceall("\n", "\r\n");
				var module = LWFP.innerApi.getmodule(element);
				if(module.WFOpinionKeyWords && module.WFOpinionKeyWords instanceof Array){//意见关键词 数组
					opinioncontent = LEAP.opinion.checkhighLightKeywords(opinioncontent,module.WFOpinionKeyWords,"strong");
				}
				var opinioncontents = opinioncontent.split("\r\n");
				var tem = "&emsp;&emsp;";
				if(opinioncontents && opinioncontents.length >0){
					for (var n = 0; n < opinioncontents.length; n++) {
						tem += opinioncontents[n].trim();
						if(n != opinioncontents.length-1){
							tem +="<br>&emsp;&emsp;";
						}						
					}
				}
				_div.innerHTML =tem;
				
				
				//_div.innerHTML = "&emsp;&emsp;" + opinion.opinioncontent.replace(/(^\s*)|(\s*$)/g, "").replaceall(" ", "").replaceall(" ", "&nbsp;").replaceall("\n", "\r\n").replaceall("\r\n", "<br>&emsp;&emsp;");
			
			}

			item.appendChild(_div);
		}

		if (element.getAttribute('showImageAttachments') == "1")
		{
			var imgs = LEAP.opinion.__getImageAttachments(element, opinion.category, prev);
			if (imgs)
			{
				var _imgDiv = document.createElement("div");
				_imgDiv.style.width = "100%";
				_imgDiv.style.height = "50px";
				_imgDiv.style.styleFloat = "left";
				item.appendChild(_imgDiv);

				var _imgView = document.createElement("div");
				_imgView.className = 'wfcontrol_imgview';
				_imgView.setAttribute('ct', 'imgview');
				_imgView.setAttribute('viewmode', '0');
				_imgDiv.appendChild(_imgView);
				_imgView.innerHTML = "<IMG style='DISPLAY: none' onerror=LEAP.imgview.i(0); src='data:image:png,base64'>";

				LEAP.imgview.setValue(_imgView, imgs);
				// _imgDiv.innerHTML = "<DIV class='wfcontrol_imgview'
				// ct='imgview' viewmode='0'><IMG style='DISPLAY: none'
				// onerror=LEAP.imgview.i(0);
				// src='data:image:png,base64'></DIV>";
			}
		}

		// 附件
		LEAP.opinion._attachment_bindItem(item, opinion);

		// 人、日期
		var _div2 = document.createElement("div");
		_div2.style.styleFloat = "right";
		_div2.style.width = "100%";
		item.appendChild(_div2);

		if (element.getAttribute('readonly') != "1")
		{
			if (opinion.canDelete == true)
			{
				var amd = document.createElement("A");
				amd.setAttribute('ctf', LEAP.opinion.ctf._delete);
				amd.className = 'wfcontrol_opinion_item_delete';
				_div2.appendChild(amd);
			}
			
			if (opinion.canUpdate == true && opinion.handsign == null && (opinion.handsignimg == null || opinion.handsignimg.isEmpty() == true))
			{
				amd = document.createElement("A");
				amd.setAttribute('ctf', LEAP.opinion.ctf._edit);
				amd.className = 'wfcontrol_opinion_item_edit';
				_div2.appendChild(amd);
			}
		}		

		var lasttxt = "[" + opinion.username + "]";
		if (opinion._viewPrefix == true)
			var lasttxt = "[" + ((opinion.organname && !opinion.organname.isEmpty()) ? opinion.organname : "") + opinion.username + "]";

		var showdelegate = element.getAttribute("showdelegate");
		if (showdelegate != null && showdelegate == '0')
		{
		} 
		else if (opinion.agentuserflag != null && opinion.agentusername != "")
		{
			lasttxt += "[代理人:" + opinion.agentusername + "]";
		}
		
		if (element.getAttribute('usernameexp'))
		{
			lasttxt = element.getAttribute('usernameexp').replace("$username$", opinion.username).replace("$organname$", (opinion.organname ? opinion.organname : "")).replace("$toporgname$", (opinion.toporgname ? opinion.toporgname : "")).replace("$top2orgname$", (opinion.top2orgname ? opinion.top2orgname : "")); 
			if (opinion.agentusername && element.getAttribute('agentusernameexp'))
				lasttxt += element.getAttribute('agentusernameexp').replace("$agentusername$", (opinion.agentusername ? opinion.agentusername : ""));
		}

		if (element.getAttribute('formattype'))
			lasttxt += "　　" + LEAP.formatdate(opinion.opiniontime.time, element.getAttribute('formattype'));
		else
			lasttxt += "　　" + LEAP.formatdate(opinion.opiniontime.time, 0);

		var atx = document.createElement("A");
		atx.className = 'wfcontrol_opinion_item_text';
		atx.style.styleFloat = "right";
		atx.style['float'] = "right";
		atx.style.width = "auto";
		atx.style.fontSize = (element.getAttribute("signfontsize") == null) ? "14px" : element.getAttribute("signfontsize") + "px";

		if (element.getAttribute('signcolor'))
			atx.style.color = element.getAttribute('signcolor');

		if (opinion.specialsign)
		{
			atx.innerText = opinion.specialsign;
			
			if ("1" != element.getAttribute('hideSpecialSignTitle'))  
				atx.title = lasttxt;
		} 
		else
		{
			// 是否显示手写签名
			var showsignimg = element.getAttribute("showsignimg");
			var hassignimg = false;
			if (showsignimg != null && showsignimg == '1')
			{
				var img = LWFP.innerApi.SignImg.getSignImg(opinion.userflag, element);
				if (img && img.imguri)
				{
					var img = JSON.parse(img.imguri);
					if (img.name)
					{
						hassignimg = true;
						// 手写签名高度
						var signimgheight = element.getAttribute("signimgheight");
						if (!signimgheight)
							signimgheight = "26px";
						atx.style.lineHeight = signimgheight;

						var uri = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/Download/" + img.nameedPath + "/" + img.name;
						uri = "<img height=" + signimgheight + " src='" + uri + "'></img>";

						if (element.getAttribute('formattype'))
							atx.innerHTML = uri + "　　" + LEAP.formatdate(opinion.opiniontime.time, element.getAttribute('formattype'));
						else
							atx.innerHTML = uri + "　　" + LEAP.formatdate(opinion.opiniontime.time, 0);
					}
				}

			}

			if (hassignimg == false)
				atx.innerText = lasttxt;
		}

		_div2.appendChild(atx);

		element.setAttribute('entryid', opinion.entryid);
		
		ElementEventManager.handleEvent(element, "onAppend", {element:element,item:item});

		return item;
	} finally
	{
		opinionlistdiv = lasttxt = item = atx = amd = handsign = url = null;
		imgs = _imgDiv = _imgView = tem = n =opinioncontents = opinioncontent =null;
	}
}
/**
 * 意见匹配关键字加粗显示 匹配整个关键词 
 * @param {Object} text 内容
 * @param {Object} keyword 关键词
 * @param {Object} tag 被包裹的标签
 */
LEAP.opinion.checkhighLightKeywords = function(text, keyword, tag) 
{
    if(text && keyword && keyword.length>0)
    {
    	// 默认的标签，如果没有指定，使用span
	    tag = tag || 'span';
	    // 匹配每一个关键词
	    keyword.forEach(function (self, index) 
	    {
		     if(text.indexOf(self) != -1) 
		     {
	            text = text.replace(new RegExp(self, 'g'), '<' + tag + ' >' + self + '</' + tag + '>');
	        }
		});
    }
    return text;
}

LEAP.opinion.__getImageAttachments = function(element, category, prev)
{
	try
	{
		if (element['extendParams'] == null || element['extendParams'].attachments == null)
			return null;

		if (prev != null && prev.category == category)
			return null;

		var ret = [];
		for (var i = 0; i < element['extendParams'].attachments.length; i++)
		{
			var att = element['extendParams'].attachments[i];

			if (att.category == category)
			{
				var n = att.name.toLowerCase();
				if (n.endWith('.jpg') || n.endWith('.jpeg') || n.endWith('.png') || n.endWith('.gif'))
					ret.add(att);
			}
		}

		return (ret.length == 0) ? null : ret;
	} finally
	{
		ret = i = att = n = null;
	}
}

LEAP.opinion.update = function(_item, content, specialsign, t_edittime, opatts, opiniontime)
{
	try
	{
		var item = LEAP._match(_item, LEAP.opinion.ctf._item, "ctf");
		if (!item)
			return;
		var element = LEAP._match(item, LEAP.opinion.d);
		if (!element)
			return;
		var con = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._itemContent + "]", item);

		var _obj = item['_obj'];
		_obj.opinioncontent = content;
		if (_obj.opiniontype != 0) // 如果不是新增的则改为修改的
			_obj.opiniontype = 1;

		_obj._edit_time = t_edittime;
		_obj.opatts = opatts;
		//增加参数opiniontime供对外调用，如果客户端指定时间以客户端时间为准修改签批时间
		if(opiniontime)
			_obj.opiniontime = opiniontime;

		// con.innerText = content;
		// con.innerText = " " + content.replaceall(" ", "").replaceall("\n",
		// "\r\n").replaceall("\r\n", "\r\n ");
		con.innerHTML = "&emsp;&emsp;" + content.replace(/(^\s*)|(\s*$)/g, "").replaceall(" ", "&nbsp;").replaceall("\n", "\r\n").replaceall("\r\n", "<br>&emsp;&emsp;");

		if (specialsign)
		{
			var a = LEAP.getElement("a.wfcontrol_opinion_item_text", item);
			a.innerText = specialsign;
			_obj.specialsign = specialsign;
		}

		item['_obj'] = _obj;

		var changeobj = element['changeobj'];
		if (_obj.id != null) // id为空则是新增的，不做考虑
		{
			if (!changeobj)
				changeobj = [];

			changeobj.add(_obj);

			element['changeobj'] = changeobj;
		}
		
		ElementEventManager.handleEvent(element, "onUpdate");
		
	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	} finally
	{
		item = element = con = _obj = changeobj = null;
	}
}

LEAP.opinion.addOrUpdateDefaultOpinion = function(_element, txt)
{
	try
	{
		var element = LEAP._check(_element, LEAP.opinion.d);
		if (!element)
			return;

		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		if (text != null && !text['edititem'])
		{
			text.value = txt;
		} else
		{
			LEAP.opinion.setDefaultOpinion(element, txt);
		}
	} finally
	{
		element = text = null;
	}
}

LEAP.opinion._showHandsign = function(arg)
{
	try
	{
		var _value = arg.e.srcElement.parentElement['handsignValue'];
		if (_value.name == null || _value.name == '')
			return;

		if (LEAP.opinion.handsignViewer == null)
		{
			LEAP.opinion.handsignViewer = document.createElement("div");
			LEAP.opinion.handsignViewer.style.position = "absolute";
			LEAP.opinion.handsignViewer.style.zIndex = 99999999;
			LEAP.opinion.handsignViewer.style.left = 0;
			LEAP.opinion.handsignViewer.style.top = 0;
			LEAP.opinion.handsignViewer.style.borderWidth = 4;
			LEAP.opinion.handsignViewer.style.borderColor = "#5192C8"; // "#C2C4C6";
			LEAP.opinion.handsignViewer.style.borderStyle = "solid";
			LEAP.opinion.handsignViewer['ctf'] = "handsign_show";

			document.body.appendChild(LEAP.opinion.handsignViewer);
			LEAP.opinion.handsignViewer.style.display = "none";

			var _a = document.createElement("A");
			_a['ctf'] = "handsign_close";
			_a.className = 'wfcontrol_opinion_handsign_close';
			LEAP.opinion.handsignViewer.appendChild(_a);
		}

		var _url = LEAP.upload.getPath(_value.nameedPath, _value.name, _value.uuid, null, null, null, null, _value.fileid, LEAP.wfrouter.router);

		LEAP.opinion.handsignViewer.style.width = _value.width;
		LEAP.opinion.handsignViewer.style.height = _value.height;
		LEAP.opinion.handsignViewer.style.left = arg.e.clientX;
		LEAP.opinion.handsignViewer.style.top = arg.e.clientY;
		LEAP.opinion.handsignViewer.style.backgroundImage = "url(" + _url + ")";

		LEAP.opinion.handsignViewer['canhide'] = "no";
		LEAP.opinion.handsignViewer.style.display = "block";
	} finally
	{
		_value = _url = _a = null;
	}
}

LEAP.opinion._hideHandsign = function(arg)
{
	try
	{
		var flag = true;
		if (arg && arg.e && arg.e.srcElement)
		{
			var ctf = arg.e.srcElement.getAttribute(commfields.ctf);
			if (ctf == "handsign_show")
				flag = false;
		}

		if (flag == true && LEAP.opinion.handsignViewer != null)
		{
			if (LEAP.opinion.handsignViewer['canhide'] == "yes")
				LEAP.opinion.handsignViewer.style.display = "none";
			else
				LEAP.opinion.handsignViewer['canhide'] = "yes";
		}
	} finally
	{
		flag = ctf = null;
	}

}

/**
 * 意见控件设置显示内容
 * 
 * @param {}
 *            element
 */
LEAP.opinion.last_txt = "";
LEAP.opinion.set_txt = function(element, value)
{
	try
	{
		if (!element)
			return;
		// 文本
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		if (!text)
			return;

		if(value){
			value = value.trim();			
		}
			
			
		if (value[value.length - 1] != "。")
			value = value + "。";

		if (element.getAttribute("postiltype") == "1" && LEAP.opinion.last_txt!= text.value)
		{
			var ptxt = element.getAttribute(LEAP.opinion.ctf.postiltxt);
			if (text.value == ptxt)
				text.value = "";
		
			text.value = text.value + value;
		}
		else
		{
			text.value = value;
		}
		LEAP.opinion.last_txt = value;
		
		text.style.color = LEAP.postil._color._normal;
	} catch (e)
	{
		alert("错误：" + err.number + ":" + err.description);
	} finally
	{
		element = text = null;
	}
}

/**
 * 意见控件清除按钮事件
 * 
 * @param {}
 *            element
 */
LEAP.opinion.clear_txt = function(element)
{
	try
	{
		if (!element)
			return;
		// 清空按钮
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		if (!text)
			return;

		text.value = "";
		text['edititem'] = null;

		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._specialsign + "]", element);
		if (specialsign)
			specialsign.value = "";
	} catch (e)
	{
		alert("错误：" + err.number + ":" + err.description);
	} finally
	{
		element = text = null;
	}
}

/**
 * 意见控件设置落款
 * 
 * @param {}
 *            element
 */
LEAP.opinion.setSpecialSignValue = function(element, value)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion.d);
		if (!element)
			return;
		var text = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._txt + "]", element);
		if (!text)
			return;

		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._specialsign + "]", element);

		if (specialsign)
			specialsign.value = value;

	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	} finally
	{
		element = text = null;
	}
}

LEAP.opinion.onHandwriteComplete = function(e, result)
{
	try
	{
		var obj =
		{};
		obj.opiniontype = 0;
		obj.entryid = e.getAttribute('entryid');
		obj.entrymdid = e.getAttribute('mdid');
		obj.hasconfirm = 0;
		obj.username = LEAP.userInfo.fullName;
		obj.userflag = LEAP.userInfo.userflag;
		obj.canDelete = true;
		obj.opiniontime =
		{
			time : LEAP.getServerTimeTicket()
		}; // {time : Date.parse(new Date())}; //{time : LEAP.getServerTime()};

		result.viewName = result.name;
		result.viewWidth = result.width + 1;
		result.viewHeight = result.height + 1;
		result.name = null;
		result.width = 0;
		result.height = 0;

		obj.handsign = JSON.stringify(result);

		LEAP.opinion.append(e, obj);
	} finally
	{
		obj = null;
	}

	// {"name":"aaa.jpg","nameedPath":"default/2012/7/31","path":"C:/uploadfile//2012/7/31/aaa.jpg","viewName":"aaa_view.jpg","viewWidth":90,
	// "viewHeight":50, "width":657, "height":263}
}

LEAP.opinion._attachment_down = function(element, src)
{
	var item = LEAP._match(src, LEAP.opinion.ctf.attItem, "ctf");
	if (item)
	{
		var obj = item["_data"];

		LEAP.upload._download(obj, false, null, LEAP.wfrouter.getRouter(element));
	}
}

LEAP.opinion._attachment_del = function(element, src)
{
	var item = LEAP._match(src, LEAP.opinion.ctf.attItem, "ctf");
	if (item)
	{
		item.parentElement.removeChild(item);
	}

}

LEAP.opinion._attachment_getAtts = function(element)
{
	var container = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.attuploadcontainer + "]", element);
	if (container)
	{
		var arr = [];
		var items = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.attItem + "]", container);
		if (items != null)
		{
			for (var i = 0; i < items.length; i++)
			{
				var itm = items[i];
				arr.add(itm["_data"]);
			}
		}

		if (arr.length > 0)
		{
			return JSON.stringify(arr);
		} else
		{
			return null;
		}
	}

}

LEAP.opinion._attachment_clearAtts = function(element)
{
	var container = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.uploadcontainer + "]", element);
	if (container)
	{
		container.innerHTML = "";
	}

}

LEAP.opinion._attachment_bind = function(container, obj, del)
{
	var attItem = document.createElement("li");
	attItem.className = "wfcontrol_opinion_Att_li";
	attItem.setAttribute("ctf", LEAP.opinion.ctf.attItem);

	var span = document.createElement("span")
	span.setAttribute("ctf", LEAP.opinion.ctf.attItemTxt);
	span.textContent = obj.title;
	attItem.appendChild(span);

	if (del != null && del == true)
	{
		var btn = document.createElement("span");
		btn.setAttribute("ctf", LEAP.opinion.ctf.attItemDel);
		btn.textContent = "删除";
		attItem.appendChild(btn);
	}

	attItem["_data"] = obj;

	container.appendChild(attItem);

}

LEAP.opinion._attachment_bindItem = function(item, opinion)
{
	if (opinion.opatts == null || opinion.opatts == "")
		return;

	var container = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.attItemcontainer + "]", item);
	if (container == null)
	{
		container = document.createElement("ul");
		container.setAttribute("ctf", LEAP.opinion.ctf.attItemcontainer);
		container.className = "wfcontrol_opinion_Att_ul";
		item.appendChild(container);
	}

	var atts = JSON.parse(opinion.opatts);
	for (var i = 0; i < atts.length; i++)
	{
		LEAP.opinion._attachment_bind(container, atts[i], false);
	}

	LEAP.asyn(LEAP.opinion._attachment_autoSize, this, 100, container);
}

LEAP.opinion._attachment_bindUpload = function(element, opatts)
{
	if (opatts == null || opatts == "")
		return;

	var container = LEAP.opinion._attachment_initUploadContainer(element);
	if (container)
	{
		container.innerHTML = "";
		var atts = JSON.parse(opatts);
		for (var i = 0; i < atts.length; i++)
		{
			LEAP.opinion._attachment_bind(container, atts[i], true);
		}

		LEAP.asyn(LEAP.opinion._attachment_autoSize, this, 100, container);
	}
}

LEAP.opinion._attachment_autoSize = function(container)
{
	var attItems = LEAP.getElements("[ctf=" + LEAP.opinion.ctf.attItemTxt + "]", container);
	if (attItems)
	{
		for (var i = 0; i < attItems.length; i++)
		{
			attItems[i].style.maxWidth = (attItems[i].parentElement.clientWidth - 200) + "px";
		}
	}
}

LEAP.opinion._attachment_initUploadContainer = function(element)
{
	var container = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.attuploadcontainer + "]", element);
	if (container == null)
	{
		var editor = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._control + "]", element);
		container = document.createElement("ul");
		container.setAttribute("ctf", LEAP.opinion.ctf.attuploadcontainer);
		container.className = "wfcontrol_opinion_Att_ul";

		editor.appendChild(container);
	}

	return container;
}

LEAP.opinion.onUploadComplete = function(element, rst)
{
	var container = LEAP.opinion._attachment_initUploadContainer(element);

	for(var i=0; i<rst.length; i++)
	{
		LEAP.opinion._attachment_bind(container, rst[i], true);
	}

	LEAP.asyn(LEAP.opinion._attachment_autoSize, this, 100, container);
}

/**
 * 意见控件初始化方法
 * 
 * @param {}
 *            wait
 * @param {}
 *            src
 */
LEAP.opinion.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;

	/*
	 * if (LEAPBrowser.isIE && wait != null) { var fn = function() {
	 * LEAP.opinion.i(null, src); src = null; }; setTimeout(fn, wait); return; }
	 */

	LEAP.opinion._i(src);
	if (src.parentElement)
		src.parentElement.removeChild(src);
}

LEAP.opinion._i = function(src)
{
	try
	{
		var _element = LEAP._match(src, LEAP.opinion.d);
		if (_element == null)
			return;
		LEAP.opinion.__i(_element);
	} finally
	{
		_element = null;
	}
}

/**
 * 控件html初始化
 * 
 * @param {}
 *            _element
 */
LEAP.opinion.__i = function(element)
{
	try
	{	
		var _element = LEAP._check(element, LEAP.opinion.d);
		if (!_element)
			return;

		if ((_element.parentNode.tagName).toUpperCase() == 'TD')
			_element.parentNode.parentNode.style.height = 'auto';

		_element['changeobj'] = null;

		var mdid = _element.getAttribute("mdid");
		if (!mdid)
		{
			mdid = UUID.randomUUID().replaceall('-', '');
			_element.setAttribute("mdid", mdid);
		}
		// 编辑类型，edittype=1时输入框在上部
		var edittype = _element.getAttribute("edittype") ? _element.getAttribute("edittype") : "0";
		// 手写
		var handsign = _element.getAttribute("enablehandsign");

		// 显示公共批示语
		var showcommonpostil = _element.getAttribute("showcommonpostil") == null ? 0 : _element.getAttribute("showcommonpostil");
		// 是否显示常用批示语
		var showpostil = _element.getAttribute("showpostil");
		// 是否显示落款修改
		var showspecialsign = _element.getAttribute("showspecialsign");
		// 是否自动过滤批示语
		var autofilter = _element.getAttribute("autofilter");
		if (autofilter != null && autofilter == "0")
			autofilter = 0;
		else
			autofilter = 1;
		//批示语分类
		var postilcategory = _element.getAttribute("postilcategory");
		if (!postilcategory)
		{
			postilcategory = "";
		}
		//是否隐藏编辑部分
		var hideEditor = _element.getAttribute("hideEditor");
		//是否隐藏列表部分
		var hideList = _element.getAttribute("hideList");

		// 是否显示手写签名
		var showsignimg = _element.getAttribute("showsignimg");
		// 是否显示确定按钮
		var showbutton = _element.getAttribute("showbutton");
		// 是否只能输入单条意见
		var singleopinion = _element.getAttribute("singleopinion");
		if (!singleopinion)
		{
			_element.setAttribute("singleopinion", 1);
			singleopinion = "1";
		}
		if (singleopinion == "1")
			showbutton = "0";

		var allowAttachment = _element.getAttribute("allowattachment");

		var pasteformat = _element.getAttribute("pasteformat");
		
		var hassignimg = false;

		if (!LEAP.getElement('div[ctf=' + LEAP.opinion.ctf._list + ']', _element))
		{
			var inner = "";
			if (edittype == "0")
				inner += "<div class='wfcontrol_opinion_list' ctf='" + LEAP.opinion.ctf._list + "'></div>";

			inner += "<div class='wfcontrol_opinion_editor' ctf='" + LEAP.opinion.ctf._control + "'>";
			
			var ___textarea = "<textarea class='wfcontrol_opinion_editor_textarea' $pasteFormat$ check='maxlen:8000' minheight='40' heightauto='1' rows=5 ctf='" + LEAP.opinion.ctf._txt + "' instance='" + _element.getAttribute('instance') + "' ptf='postil' autofilter=$autofilter$ postilcategory='$postilcategory$' showcommonpostil=$showcommonpostil$></textarea>";
			if (_element.getAttribute("fixeditorheight") == "1")
				___textarea = "<textarea class='wfcontrol_opinion_editor_textarea' $pasteFormat$ check='maxlen:8000' minheight='40' rows=5 ctf='" + LEAP.opinion.ctf._txt + "' instance='" + _element.getAttribute('instance') + "' ptf='postil' autofilter=$autofilter$ postilcategory='$postilcategory$' showcommonpostil=$showcommonpostil$></textarea>";
			
			___textarea = ___textarea.replace("$autofilter$", autofilter);
			___textarea = ___textarea.replace("$postilcategory$", postilcategory);
			___textarea = ___textarea.replace("$showcommonpostil$", showcommonpostil);
			
			if ("1" == pasteformat)
				___textarea = ___textarea.replace("$pasteFormat$", "pasteFormat='1'");
			
			inner += ___textarea;

			if (showsignimg != null && showsignimg == '1')
			{
				var img = LWFP.innerApi.SignImg.getSignImg(LEAP.getUserInfo().userflag, _element);
				if (img && img.imguri)
				{
					img = JSON.parse(img.imguri);
					if (img.name)
					{
						hassignimg = true;
						// 手写签名高度
						var signimgheight = _element.getAttribute("signimgheight");
						if (!signimgheight)
							signimgheight = "26px";
						var uri = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(_element)) + "LEAP/Download/" + img.nameedPath + "/" + img.name;

						inner += "<img height=" + signimgheight + " style='float: right;margin-top:5px;' src='" + uri + "' ctf='" + LEAP.opinion.ctf._signimg + "' ptf='_signimg' ></img>";
					}
				}

			}
			if (hassignimg == false && showspecialsign != null && showspecialsign == '1')
			{
				inner += "<input style='border:1px solid #9f9d9d;background-color:#f8f8f6;float: right;width:400px;margin-top:5px;font-size:12px;border-radius:2px;' ctf='" + LEAP.opinion.ctf._specialsign + "' ptf='_specialsign' ></input>";
			}

			inner += "<div class='wfcontrol_opinion_editor_btnarea'>";

			inner += "<IMG style='DISPLAY: none' src='data:image:png,base64'/>";

			if (handsign != 0 && handsign != '0')
			{
				inner += "<a class='wfcontrol_opinion_editor_btnhandwrite' href='javascript:' ht='button' ctf='" + LEAP.opinion.ctf._handwrite + "' tct='opinion' ct='capture' cap_type=4>手写</a>";
			}

			if (showpostil != null && showpostil == '1')
			{
				if (_element.getAttribute("fixpostils") != null)
				{
					var arr = _element.getAttribute("fixpostils").split(";");
					for (var i = 0; i < arr.length; i++)
					{
						inner += "<a fix='1' href='javascript:' ht='button' style='float:left;font-size:12px;text-overflow:ellipsis;white-space: nowrap; overflow: hidden;max-width:" + postilmaxwidth + "' ctf='" + LEAP.opinion.ctf._postil + "' title='" + arr[i] + "'>" + arr[i] + "</a>";
					}
				}

				var par = new SearchParameters();
				par.pageNum = 1;
				par.pageSize = (_element.getAttribute("postilcount") == null) ? 4 : _element.getAttribute("postilcount");
				if (showcommonpostil == 0)
				{
					par.addParameter("postiltype", "1");
					if(postilcategory)
						par.addParameter("category", postilcategory);
				}

				var postils = LWFP.innerApi.getPostil(par);

				var postilmaxwidth = (!_element.getAttribute("postilmaxwidth")) ? "72px" : _element.getAttribute("postilmaxwidth");
				if (postils != null)
				{
					for (var i = 0; i < postils.length; i++)
					{
						inner += "<a href='javascript:' ht='button' style='float:left;font-size:12px;text-overflow:ellipsis;white-space: nowrap; overflow: hidden;max-width:" + postilmaxwidth + "' ctf='" + LEAP.opinion.ctf._postil + "' title='" + postils[i].postilcontent + "'>" + postils[i].postilcontent + "</a>";
					}
				} else if (_element.getAttribute("defaultpostil") != null)
				{
					var arr = _element.getAttribute("defaultpostil").split(";");
					for (var i = 0; i < arr.length; i++)
					{
						inner += "<a href='javascript:' ht='button' style='float:left;font-size:12px;text-overflow:ellipsis;white-space: nowrap; overflow: hidden;max-width:" + postilmaxwidth + "' ctf='" + LEAP.opinion.ctf._postil + "' title='" + arr[i] + "'>" + arr[i] + "</a>";
					}
				}

				inner += "<a href='javascript:' ht='button' class='wfcontrol_opinion_editor_btnarea_postil' style='float:left;padding-left: 0px;width:80px;font-size:12px;' ctf='" + LEAP.opinion.ctf._morepostil + "' ptf='_morepostil' >常用批示语</a>";
			}

			if (showbutton != null && showbutton == '0')
			{
			} else
			{
				inner += "<a class='wfcontrol_opinion_editor_btncancel' href='javascript:' ht='button' style='float:right;' ctf='" + LEAP.opinion.ctf._cancel + "'>清空</a>";
				inner += "<a class='wfcontrol_opinion_editor_btnconfirm'href' href='javascript:' ht='button' style='float:right;' ctf='" + LEAP.opinion.ctf._confirm + "'>确定</a>";
			}

			if (allowAttachment != null && allowAttachment == "1")
			{
				inner += '<div class="LC_fileupload_file leap_app_upload wfcontrol_opinion_Att_upload"  ct="fileupload" tct="opinion" ctfe ="fileupload_upload_btn" showtext="上传附件" title="" mulit="1" bt="text" mdtype="upload_file" completefn="__uploadComplate"  mdcn="path"  uploadpath="default">' + '<img style="float: left; display: none;" onerror="LEAP.fileupload.i(0);" src="data:image:png,base64">' + '</div>';
			}

			inner += "</div></div>";

			if (edittype == "1")
				inner += "<div class='wfcontrol_opinion_list' ctf='" + LEAP.opinion.ctf._list + "'></div>";

			_element.innerHTML = inner;
		}

		// 清空意见列表清单
		var list = LEAP.getElement("div[ctf=" + LEAP.opinion.ctf._list + "]", _element);
		if (list)
		{
			list.innerHTML = "";
			if (hideList == "1")
			{
				list.style.display = "none";
			}
		}
		
		var uploadlist = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.attuploadcontainer + "]", _element);
		if (uploadlist)
			uploadlist.innerHTML = "";

		// 设置意见控件的textare的常用批示语支持
		var txtare = LEAP.getElement('[ctf=' + LEAP.opinion.ctf._txt + ']', _element);

		// 自定义编辑器高度
		var editorheight = _element.getAttribute("editorheight");
		if (editorheight)
		{
			if (txtare)
			{
				txtare.style.minHeight = editorheight + "px";
			}
		}
		// 意见输入框提示文本
		var postiltxt = _element.getAttribute("postiltxt");
		if (postiltxt == null)
		{
			postiltxt = LEAP.opinion.def;
			_element.setAttribute("postiltxt", postiltxt);
		}

		if (txtare)
		{
			LEAP.postil._setload(txtare, postiltxt);
			txtare['edititem'] = null;
			txtare.style.fontSize = (_element.getAttribute("inputfontsize") == null) ? "14px" : _element.getAttribute("inputfontsize") + "px";
		}
				
		var _readonly = _element.getAttribute('readonly');
		if (_readonly && _readonly == '1')
			_readonly = true;
		else
			_readonly = false;
		
		var _editorCtrl = LEAP.getElement("[ctf=" + LEAP.opinion.ctf._control + "]", _element);		
		if (_readonly)
		{
			_editorCtrl.style.display = 'none';
		}
		else
		{
			if (hideEditor != "1")
			{
				_editorCtrl.style.display = 'block';
			}
			else
			{
				_editorCtrl.style.display = 'none';
			}
		}
			
		LEAP.opinion.__initGroup(_element);
	} catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	} finally
	{
		_element = mdid = handsign = showpostil = showspecialsign = autofilter = showsignimg = showbutton = singleopinion = hassignimg = null;
		inner = img = signimgheight = uri = par = postils = i = txtare = editorheight = _readonly = null;
	}
}

LEAP.opinion.__initGroup = function(element)
{
	var def = element.getAttribute("groups");
	if (def == null || def == "")
		return;

	var div = LEAP.getElement("[ctf=" + LEAP.opinion.ctf.groupcontainer + "]", element);
	if (div)
		return;

	var groups = JSON.parse(def);

	div = document.createElement("div");
	div.setAttribute("ctf", LEAP.opinion.ctf.groupcontainer);
	div.style.display = "none";
	element.insertBefore(div, element.childNodes[0]);

	for (var i = 0; i < groups.length; i++)
	{
		var group = groups[i];
		var input = document.createElement("input");
		input.type = "button";
		input.value = group.title;
		input.setAttribute("ctf", LEAP.opinion.ctf.groupButton);
		if (true == group.isdefault)
		{
			input.setAttribute("checked", "1");
			input.className = "LC_button_conner wfcontrol_opinion_group_check";
		} else
		{
			input.className = "LC_button_conner wfcontrol_opinion_group";
		}

		input["_data"] = group;

		div.appendChild(input);
	}
}

LEAP.opinion.__reloadPostil = function(src)
{
	var element = LEAP._match(src, LEAP.opinion.d);
	if (element == null)
		return;

	// 显示公共批示语
	var showcommonpostil = element.getAttribute("showcommonpostil") == null ? 0 : element.getAttribute("showcommonpostil");
	// 是否显示常用批示语
	var showpostil = element.getAttribute("showpostil");

	if (showpostil != null && showpostil == '1')
	{
		var items = LEAP.getElements("[ctf=_postil]", element);
		if (items != null)
		{
			for (var i = 0; i < items.length; i++)
			{
				if (items[i].getAttribute("fix") != "1")
					items[i].parentElement.removeChild(items[i]);
			}
		}

		var btnMore = LEAP.getElement("[ctf=_morepostil]", element);

		LWFP.innerApi.Postil.lasttime = 0;
		var par = new SearchParameters();
		par.pageNum = 1;
		par.pageSize = (element.getAttribute("postilcount") == null) ? 4 : element.getAttribute("postilcount");
		if (showcommonpostil == 0)
			par.addParameter("postiltype", "1");

		var postils = LWFP.innerApi.getPostil(par);

		var postilmaxwidth = (!element.getAttribute("postilmaxwidth")) ? "72px" : element.getAttribute("postilmaxwidth");
		if (postils != null)
		{
			for (var i = 0; i < postils.length; i++)
			{
				var p = postils[i];
				var a = document.createElement("a");
				a.href = 'javascript:';
				a.setAttribute("ht", 'button');
				a.setAttribute("ctf", LEAP.opinion.ctf._postil);
				a.style.styleFloat = "left";
				a.style.float = "left";
				a.style.fontSize = "12px";
				a.style.textOverflow = "ellipsis";
				a.style.whiteSpace = "nowrap";
				a.style.overflow = "hidden";
				a.style.maxWidth = postilmaxwidth;
				a.title = p.postilcontent;
				a.innerText = p.postilcontent;

				btnMore.parentElement.insertBefore(a, btnMore);
			}
		} else if (element.getAttribute("defaultpostil") != null)
		{
			var arr = element.getAttribute("defaultpostil").split(";");
			for (var i = 0; i < arr.length; i++)
			{
				var a = document.createElement("a");
				a.href = 'javascript:';
				a.setAttribute("ht", 'button');
				a.setAttribute("ctf", LEAP.opinion.ctf._postil);
				a.style.styleFloat = "left";
				a.style.float = "left";
				a.style.fontSize = "12px";
				a.style.textOverflow = "ellipsis";
				a.style.whiteSpace = "nowrap";
				a.style.overflow = "hidden";
				a.style.maxWidth = postilmaxwidth;
				a.title = arr[i];
				a.innerText = arr[i];

				btnMore.parentElement.insertBefore(a, btnMore);
			}
		}
	}

}

// {"name":"aaa.jpg","nameedPath":"default/2012/7/31","path":"C:/uploadfile//2012/7/31/aaa.jpg","viewName":"aaa_view.jpg","viewWidth":90,
// "viewHeight":50, "width":657, "height":263}

LEAP.opinion.init();

/*******************************************************************************
 * opinion2插件
 * 
 * @class LEAP.opinion2 control
 * @type user control
 *       @example
 * 
 * 
 * 定义：
 * <DIV class=wfcontrol_opinion2 style="MARGIN: 8px; WIDTH: 100%; HEIGHT: 100%" ct="opinion" md="appopinion" ut="appopinion" bt="text" mdcn="appopinion">
 * 		<IMG style="DISPLAY: none" onerror=LEAP.opinion2.i(0); src="data:image:png,base64">
 * </DIV>
 * 
 * 生成后示例:
 * <DIV class=wfcontrol_opinion2 style="MARGIN: 8px; WIDTH: 100%; HEIGHT: 100%" ct="opinion" ut="appopinion" instance="cid_1322727231506_0_4262071277230114_132" mdcn="appopinion" bt="text" md="appopinion" ___isoparea="1" ___isoparea_status="110" readonly="1" autobinding="false" mdid="84100f3ca342f92f40baa0d3d058a06a">
 * 		<DIV class=wfcontrol_opinion2_list ctf="opinionlist"></DIV>
 * 		<DIV class=wfcontrol_opinion2_editor style="DISPLAY: none" ctf="opinioncontrol">
 * 			<TEXTAREA class=wfcontrol_opinion2_editor_textarea style="COLOR: #999" rows=5 ctf="opinion_text" ptf="postil">双击此处.显示常用批示语.</TEXTAREA>
 * 			<DIV class=wfcontrol_opinion2_editor_btnarea>
 * 				<A class="lgimgbtn wfcontrol_opinion2_editor_btncancel" style="FLOAT: right" href="javascript:" ctf="_cancel" ht="button">清空</A>
 * 				<A class="lgimgbtn wfcontrol_opinion2_editor_btnconfirm" style="FLOAT: right" href="javascript:" ctf="_confirm" ht="button" href?>确定</A>
 * 			</DIV>
 * 		</DIV>
 * </DIV>
 * 
 * 属性说明：
 * readonly 设置是否只读:值域为1或者0,默认0 ,1表示只读,0表示可以填写意见
 * autobinding
 * mdid
 * showpostil 设置是否显示公共批示语:值域为1或者0,默认0 ,1表示显示公共批示语
 * showspecialsign 设置是否显示落款修改:值域为1或者0,默认0 ,1表示显示落款修改
 * formattype 设置时间显示格式, 0 : 长时间 ， 显示时分秒 1 : 短时间 ， 不显示时分秒
 * showsignimg 设置是否显示手写签名:值域为1或者0,默认0 ,1表示显示手写签名
 * signimgheight 设置手写签名显示的高度（宽度等比例缩放）
 * showdelegate 是否显示代理人，值域为1或者0,默认1 ,1表示显示代理人
 * showbutton 是否显示确定和清空按钮，0否1是，默认1
 * singleopinion 是否只允许输入一条意见，0否1是，默认1
 * postiltxt 意见输入框提示文本
 * signcolor 落款文字颜色, 如：#55FFEE
 * 
 * showImageAttachments "1"
 * quirks 1怪异模式
 */

LEAP.opinion2 ={};
LEAP.opinion2.d = "opinion2";
LEAP.opinion2.ctf =
{
	_save : "opinionlist",
	_control : "opinioncontrol",
	_txt : "opinion_text",
	_cancel : "_cancel",
	_confirm : "_confirm",
	_item : "op_item",
	_itemContent : "op_content",
	_delete : "_delete",
	_edit : "_edit",
	_handsignViewer: "_handsignViewer",
	_handwrite:"_handwrite",
	_postil:"_postil",
	_morepostil:"_morepostil",
	_specialsign:"_specialsign",
	_signimg:"_signimg",
	_open:"_open"
};
LEAP.opinion2.___lastEditElement = null;
LEAP.opinion2.ectf =
{
	e_editor	: "opinionEditor",
	e_textarea	: "opinionEditor_textarea",
	e_table		: "opinionEditor_table",
	e_input		: "opinionEditor_input",
	e_save 		: "opinionEditor_save",
	e_delete	: "opinionEditor_delete",
	e_saveas	: "opinionEditor_saveas",
	e_savep 	: "opinionEditor_savep",
	e_deletep	: "opinionEditor_deletep",
	e_close 	: "opinionEditor_close",
	e_prow		: "opinionEditor_prow",
	e_pcell		: "opinionEditor_pcell"
};
LEAP.opinion2.def = '双击此处.显示常用批示语.';
LEAP.opinion2.handsignViewer = null;
LEAP.opinion2.opinionEditor = null;
LEAP.opinion2.init = function()
{
	if (document != null && document.body != null)
	{
		LEAP.opinion2._init();
	}
	else
	{
		UIEventManager.addEvent(window, "load", LEAP.opinion2._init);
	}
}
LEAP.opinion2._init = function()
{
	LEAP.addEvent(document.body, "click", LEAP.opinion2.uiProcess, null, null, true);
	LEAP.addEvent(document.body, "click", LEAP.opinion2._hideHandsign, null, null, true);
	LEAP.addEvent(document.body, "dblclick", LEAP.opinion2.uiProcess, null, null, true);
	
	UIEventManager.removeEvent(window, "load", LEAP.opinion2._init);
}

/**
 * 注册按钮所有操作的方法
 * 
 * @param {}
 *            arg
 */
LEAP.opinion2.uiProcess = function(arg)
{
	try
	{
		if (!arg)
			return;
		var src = arg.e.srcElement;
		var type = arg.e.type;
		var index = 0;
		var ctf = src.getAttribute(commfields.ctf);
		
		var element = LEAP._match(src, LEAP.opinion2.d);
		var editor = LEAP._match(src, LEAP.opinion2.ectf.e_editor, "ctf");
		
		if (ctf && (element || ctf.indexOf("opinionEditor") >= 0) )
		{
			if (type == "dblclick")
			{
				if (ctf == LEAP.opinion2.ectf.e_pcell)
				{
					LEAP.opinion2.__editor_selectPostil(src);
				}
			}
			else if (type=="click")
			{
				if (element)
				{
					if (ctf == LEAP.opinion2.ctf._confirm)
					{
						LEAP.opinion2.addopinion(element);
					}
					else if (ctf == LEAP.opinion2.ctf._cancel)
					{
						LEAP.opinion2.clear_txt(element);
					}
					else if (ctf == LEAP.opinion2.ctf._delete)
					{
						LEAP.opinion2._delete(src);
					}
					else if (ctf == LEAP.opinion2.ctf._edit)
					{
						var quirks = element.getAttribute("quirks");
						if (quirks == "1")
							LEAP.opinion2.__editor_edit(src);
						else
							LEAP.opinion2._edit(src);
					}
					else if (ctf == LEAP.opinion2.ctf._handsignViewer)
					{
						LEAP.opinion2._showHandsign(arg);
					}
					else if (ctf == LEAP.opinion2.ctf._handwrite)
					{
						LEAP.opinion2.clear_txt(element);	
					}
					else if (ctf == LEAP.opinion2.ctf._postil)
					{
						LEAP.opinion2.set_txt(element,src.innerText);	
					}
					else if (ctf == LEAP.opinion2.ctf._morepostil)
					{
						var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
							element);
						LEAP.postil.getallPostilDIV(text);	
					}
					else if (ctf == LEAP.opinion2.ctf._open)
					{			
						LEAP.opinion2.__editor_showEditor(element);
					}
				}
				else
				{
					if (ctf == LEAP.opinion2.ectf.e_save)
					{
						LEAP.opinion2.__editor_addopinion();
					}
					else if (ctf == LEAP.opinion2.ectf.e_saveas)
					{
						LEAP.opinion2.__editor_saveasPostil();
					}
					else if (ctf == LEAP.opinion2.ectf.e_pcell)
					{
						LEAP.opinion2.__editor_editPostil(src);					
					}
					else if (ctf == LEAP.opinion2.ectf.e_savep)
					{
						LEAP.opinion2.__editor_updatePostil();
					}
					else if (ctf == LEAP.opinion2.ectf.e_deletep)
					{
						LEAP.opinion2.__editor_deletePostil();
					}
					else if (ctf == LEAP.opinion2.ectf.e_close)
					{
						LEAP.opinion2.__editor_closeEditor();
					}
				}
			}
		}		
		
//		if (!editor && !element)
//		{
//			LEAP.opinion2.__editor_closeEditor();
//		}
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		src = type = index = ctf = element = editor = quirks = null;
	}
}


//*********************************************************************************************************************
LEAP.opinion2.__editor_showEditor = function(element)
{
	LEAP.opinion2.__editor_initEditor(element);
	
	LEAP.opinion2.opinionEditor.style.display = "block";
	
	var L = 220;
	var T = 100;
	var curModule = PageObjectModel.getModule(element.getAttribute('instance'));
	if (curModule && curModule.parentPageModule && curModule.parentPageModule.moduleElement)
	{
		var w =  curModule.parentPageModule.moduleElement.clientWidth;
		var h = curModule.parentPageModule.moduleElement.clientHeight;
		var mPos = LEAP.getAbsolutePos(curModule.parentPageModule.moduleElement);
		L = Math.floor( (w - LEAP.opinion2.opinionEditor.clientWidth) / 2 ) + mPos.x;
		T = Math.floor( (h - LEAP.opinion2.opinionEditor.clientHeight) /2 ) + mPos.y;
	}
	else
	{
		L = Math.floor((document.body.clientWidth - EAP.opinion2.opinionEditor.clientWidth) / 2);
	}
	
	LEAP.opinion2.opinionEditor.style.left = L + "px";
	LEAP.opinion2.opinionEditor.style.top = T + "px";
	
	
	
}
LEAP.opinion2.__editor_closeEditor = function()
{
	if (LEAP.opinion2.opinionEditor)	
		LEAP.opinion2.opinionEditor.style.display = "none";
}

LEAP.opinion2.__editorOldValue = "";
LEAP.opinion2.__editorTextChange = function(obj, max)
{
	if (obj && obj.srcElement && obj.srcElement.value && obj.srcElement.value.length>max)
	{
		obj.srcElement.value = LEAP.opinion2.__editorOldValue;
	}
	LEAP.opinion2.__editorOldValue = obj.srcElement.value;
}
LEAP.opinion2.__editor_initEditor = function(element)
{
	try
	{
		if (LEAP.opinion2.opinionEditor == null)
		{
			LEAP.opinion2.opinionEditor =  document.createElement("div");
			LEAP.opinion2.opinionEditor.className = "wfcontrol_opinion2_opinionEditor";
			LEAP.opinion2.opinionEditor.setAttribute("ctf", LEAP.opinion2.ectf.e_editor);
			
			var p = document.createElement("p");
				p.innerText = "填写意见"
			LEAP.opinion2.opinionEditor.appendChild(p);	
			
			var fieldset = document.createElement("fieldset");
			var legend = document.createElement("legend");
				legend.innerText = "请输入意见"
			fieldset.appendChild(legend);
				
			var textArea = document.createElement("TEXTAREA");
				textArea.rows = 8;
				textArea.onpropertychange = function(arg){LEAP.opinion2.__editorTextChange(arg, 2000)};	
				textArea.setAttribute("ctf", LEAP.opinion2.ectf.e_textarea);
			fieldset.appendChild(textArea);
			
			var div = document.createElement("div");
				div.className = "wfcontrol_opinion2_opinionEditor_btnDiv1";
			var a1 = document.createElement("a");
				a1.href = 'javascript:void(0)';
				a1.className = "lgbtn";
				a1.innerText = "存为常用语";
				a1.style.styleFloat = "right";
				a1.style.width = "100px";
				a1.setAttribute("ctf", LEAP.opinion2.ectf.e_saveas);
			var a2 = document.createElement("a");
				a2.href = 'javascript:void(0)';
				a2.className = "lgbtn";
				a2.innerText = "确定";
				a2.style.styleFloat = "right";
				a2.setAttribute("ctf", LEAP.opinion2.ectf.e_save);
				
			div.appendChild(a1);
			div.appendChild(a2);
			fieldset.appendChild(div);
			LEAP.opinion2.opinionEditor.appendChild(fieldset);
			
			
			var fieldset2 = document.createElement("fieldset");
			var legend2 = document.createElement("legend");
				legend2.innerText = "请选择常用语"
			fieldset2.appendChild(legend2);
			
			var div2 = document.createElement("div");
				div2.className = "wfcontrol_opinion2_opinionEditor_tableDiv";
			var table = document.createElement("table");
				table.setAttribute("ctf", LEAP.opinion2.ectf.e_table);
			div2.appendChild(table);
			
			var div3 = document.createElement("div");
				div3.className = "wfcontrol_opinion2_opinionEditor_btnDiv2";
				
			var inpt = document.createElement("INPUT");
				inpt.style.width = "410px";
				inpt.style.styleFloat = "left";
				inpt.setAttribute("ctf", LEAP.opinion2.ectf.e_input);
			var a3 = document.createElement("a");
				a3.href = 'javascript:void(0)';
				a3.className = "lgbtn";
				a3.innerText = "存为常用语";
				a3.style.styleFloat = "left";
				a3.style.width = "80px";
				a3.setAttribute("ctf", LEAP.opinion2.ectf.e_savep);
			var a4 = document.createElement("a");
				a4.href = 'javascript:void(0)';
				a4.className = "lgbtn";
				a4.innerText = "删除 ";
				a4.style.styleFloat = "left";
				a4.style.width = "40px";
				a4.setAttribute("ctf", LEAP.opinion2.ectf.e_deletep);
			div3.appendChild(inpt);
			div3.appendChild(a3);
			div3.appendChild(a4);
			
			fieldset2.appendChild(div2);
			fieldset2.appendChild(div3);
			LEAP.opinion2.opinionEditor.appendChild(fieldset2);
			
			var div4 = document.createElement("div");
			var a5 = document.createElement("a");
				a5.href = 'javascript:void(0)';
				a5.className = "lgbtn";
				a5.innerText = "关闭";
				a5.style.styleFloat = "right";
				a5.style.marginTop = "15px";	
				a5.setAttribute("ctf", LEAP.opinion2.ectf.e_close);
			div4.appendChild(a5);		
			LEAP.opinion2.opinionEditor.appendChild(div4);
			
			LEAP.opinion2.opinionEditor.style.display = "none";
			document.body.appendChild(LEAP.opinion2.opinionEditor);
			
			//加载常用语
			LEAP.opinion2.__editor_loadpostil();
		}
		
		// 初始化
		LEAP.opinion2.___lastEditElement = null;
		LEAP.opinion2.___lastEditElement = element;
		
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_textarea + "]",	LEAP.opinion2.opinionEditor);
		if (text)
		{
			text['edititem'] = null;
			text.value = "";
		}
	}
	finally
	{	
		p = fieldset = legend = textArea = div = a1 = a2 = fieldset2 = legend2 = div2 = table = div3 = inpt = a3 = a4 = div4 = a5 = text = null;
	}
}
LEAP.opinion2.__editor_loadpostil = function()
{
	try
	{
		var par = new SearchParameters();
		var objs = LEAP.request("WfGetAllLwfpPostil",{searchParameters:par});
		
		var table = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_table + "]",	LEAP.opinion2.opinionEditor);
		if (table.firstChild)
			table.firstChild.removeNode(true);
			
		if (!objs)
			return;		
		
		for(var i=0; i<objs.length; i++)
		{
			var tr = table.insertRow(-1);			
				tr['ctf'] = LEAP.opinion2.ectf.e_prow;
			
			if (i % 2 == 0) 
				tr.className = "wfcontrol_opinion2_opinionEditor_row01";
			else 
				tr.className = "wfcontrol_opinion2_opinionEditor_row02";

			var td = tr.insertCell(-1);
				td.setAttribute("ctf", LEAP.opinion2.ectf.e_pcell);
				td['con'] = objs[i];
				td.innerText = objs[i].postilcontent;
		}

	}
	finally
	{
		par = objs = table = i = tr = td = null
	}
}

LEAP.opinion2.__editor_addopinion = function()
{
	try
	{
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_textarea + "]",	LEAP.opinion2.opinionEditor);
				
		if (text['edititem'])
		{
			var t_value = text.value;
			if (t_value && t_value.isEmpty() == false)
				LEAP.opinion2.update(text['edititem'], t_value, null);
		}
		else
		{	
			var t_value = text.value;
			if (!t_value || t_value.isEmpty()==true)
				return;
				
			var _csid = LEAP.opinion2.___lastEditElement.getAttribute("_csid");
			
			var obj = {};
			obj.opiniontype = 0;
			obj.entryid = LEAP.opinion2.___lastEditElement.getAttribute('entryid');
			obj.parentid = "";
			obj.entrymdid = LEAP.opinion2.___lastEditElement.getAttribute('mdid');
			obj.opinioncontent = t_value;
			obj.hasconfirm = 0;
			obj.username = LEAP.userInfo.fullName;
			obj.userflag = LEAP.userInfo.userflag;
			obj.opiniontime ={time: LEAP.getServerTimeTicket()};	//{time : LEAP.getServerTime()};
			obj.canDelete = true;
			obj.canUpdate = true;			
			if (_csid)
				obj.category = _csid;
				
			if (LEAP.opinion2.___lastEditElement['extendParams'] && LEAP.opinion2.___lastEditElement['extendParams'].currentStep)
				obj.categoryName = LEAP.opinion2.___lastEditElement['extendParams'].currentStep.stepaliasname;


			LEAP.opinion2.append(LEAP.opinion2.___lastEditElement, obj);
			
			LEAP.opinion2.__displayButton(LEAP.opinion2.___lastEditElement, false);
		}
		
		LEAP.opinion2.__editor_closeEditor();
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		text = t_value = t_value = obj = _csid = null;
	}
}

LEAP.opinion2.__displayButton = function(element, display)
{
	try
	{
		var singleopinion = element.getAttribute("singleopinion");
		if (singleopinion == "1")
		{
			var o = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._open + "]", element);
			if (o)
				o.style.display = (display==true)?"block":"none";
			var o2 = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._handwrite + "]", element);
			if (o2)
				o2.style.display = (display==true)?"block":"none";
		}
	}
	finally
	{
		singleopinion = o = o2 = null;
	}
}

LEAP.opinion2.__editor_edit = function(src)
{
	try
	{
		var element = LEAP._match(src, LEAP.opinion2.d);
		
		LEAP.opinion2.__editor_showEditor(element);
		
		var item = LEAP._match(src, LEAP.opinion2.ctf._item, "ctf");		
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_textarea + "]",	LEAP.opinion2.opinionEditor);
		
		var _obj = item['_obj'];
		
		text.value = _obj.opinioncontent;
		
		text['edititem'] = item;	
		text.style.color = LEAP.postil._color._normal;
	}
	catch (e)
	{
		alert("错误：" + e.number + ":" + e.description);
	}
	finally
	{
		element = item = text = _obj = null;
	}
}

LEAP.opinion2.__editor_saveasPostil = function()
{
	try
	{
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_textarea + "]",	LEAP.opinion2.opinionEditor);
		if (text.value != null &&  false == text.value.isEmpty())
		{
			var rst = LEAP.request('WfCreateLwfpPostil2', {par : {postilcontent:text.value, postiltype:1} });
			if (rst == 1)
			{
				LEAP.opinion2.__editor_loadpostil();
			}
		}
		
	}
	finally
	{	
		text = rst = null;
	}
}

LEAP.opinion2.__editor_editPostil = function(src)
{
	try
	{
		var postil = src["con"];
		var inpt = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_input + "]",	LEAP.opinion2.opinionEditor);
		inpt["con"] = postil;
		inpt.value = postil.postilcontent;
		return 	postil.postilcontent;
	}
	finally
	{
		 postil = inpt = null;
	}
}

LEAP.opinion2.__editor_selectPostil = function(src)
{
	try
	{
		var txt = LEAP.opinion2.__editor_editPostil(src);
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_textarea + "]",	LEAP.opinion2.opinionEditor);
		text.value = txt;
	}
	finally
	{
		txt = text = null;
	}
}

LEAP.opinion2.__editor_updatePostil = function()
{
	try
	{
		var inpt = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_input + "]",	LEAP.opinion2.opinionEditor);
		if (inpt.value.isEmpty() == true)
		{
			alert("常用语不能为空!");
			return;
		}
		else
		{
			var postil = inpt["con"];
			if (postil)
			{
				postil.postilcontent = inpt.value;
				var rst = LEAP.request('WfModifyLwfpPostil', {par : postil });
				if (rst == true)
				{
					LEAP.opinion2.__editor_loadpostil();
				}
			}
			else
			{	
				var rst = LEAP.request('WfCreateLwfpPostil2', {par : {postilcontent:inpt.value, postiltype:1} });
				if (rst == 1)
				{
					LEAP.opinion2.__editor_loadpostil();
				}
			}
		}
		
		inpt.value = '';
		inpt["con"] = null;
		
	}
	finally
	{
		inpt = postil = rst = null;
	}
}
LEAP.opinion2.__editor_deletePostil = function()
{
	try
	{
		var inpt = LEAP.getElement("[ctf=" + LEAP.opinion2.ectf.e_input + "]",	LEAP.opinion2.opinionEditor);
		
		var postil = inpt["con"];
		if (postil == null)
		{
			alert("请选择要删除的常用语");
			return;
		}

		if (window.confirm("确定删除该常用语？"))
		{	
			var bool = LEAP.request("WfDeleteLwfpPostil", {postil:postil});
			if (bool == 1)
			{
				LEAP.opinion2.__editor_loadpostil();
				inpt['con'] = null;
				inpt.value = "";
			}
			else if (bool == -1) 
				alert("您无权删除公共常用语");
			else 
				alert("删除失败");				
		}		
	}
	finally
	{
		inpt = postil =  bool = null;
	}
}

//***********************************************************************************************************************************

















/**
 * 设置意见控件只读状态
 * 
 * @param {}
 *            element
 * @param {}
 *            _readOnly
 */
LEAP.opinion2.setReadOnly = function(element, _readOnly)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (!element || _readOnly == null)
		{
			return;
		}
		var opinioncontrol = LEAP.getElement('[ctf='
						+ LEAP.opinion2.ctf._control + ']', element);
		if (!opinioncontrol)
		{
			// 没有初始化的时候 只用设置值
			if (_readOnly == true)
			{
				element.setAttribute("readonly", "1");
				//element.style.height = "100px";
			}
			else if (_readOnly == false)
			{
				element.setAttribute("readonly", "-1");
			}
		}
		else
		{
			if (_readOnly == true)
			{
				if (!opinioncontrol)
					return;
				opinioncontrol.style.display = 'none';
				element.style.height = "100px";
			}
			else if (_readOnly == false)
			{
				if (!opinioncontrol)
					return;
				opinioncontrol.style.display = 'block';
			}
		}
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element = _readOnly = opinioncontrol = null;
	}
}

/**
 * 普通控件获取值的方法.
 * 
 * @param {}
 *            element
 */
LEAP.opinion2.getValue = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (element == null)
		{
			return;
		}
		/*var change = LEAP.opinion2._getChange(element);
		var elements = LEAP.getElements("div[ctf=" + LEAP.opinion2.ctf._item
						+ "]", element);

		if (change != null || elements)
		{*/
			var mdid = element.getAttribute("mdid");
			if (!mdid)
				mdid = UUID.randomUUID().replaceall('-', '');
			return mdid;
		/*}
		else
		{
			return null;
		}*/
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element = change = elements = null;
	}

}
/**
 * 普通控件设置的方法
 * 
 * @param {}
 *            element
 * @param {}
 *            mdid
 */
LEAP.opinion2.setValue = function(element, mdid)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (!element)
			return;

		if (!mdid || mdid == "")
		{
			element.removeAttribute('mdid');
		}
		else
		{
			element.setAttribute('mdid', mdid);

			var auto = element.getAttribute('autobinding');
			if (auto != null && (!auto || auto == 'false'))
				auto = false;
			else
				auto = true;

			if (auto)
			{
				LEAP.opinion2.innerSetValue(element, mdid);
			}
		}

	}
	catch (e)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element = auto = null;
		LEAP.hideMask();
	}
}
/**
 * 业务意见控件绑定数据方法
 * 
 * @param {}
 *            element
 * @param {}
 *            mdid
 */
LEAP.opinion2.innerSetValue = function(element, mdid)
{
	try
	{
		var fn = function()
		{
			var ops = LEAP.request('WfGetOpinionsByMD',
					{
						mdid : mdid,
						archCategory : element.getAttribute("archCategory")
					});
			if (ops != null)
			{
				for (var k = 0; k < ops.opinions.length; k++)
					LEAP.opinion2.append(element, ops.opinions[k]);
			}

			ops = k = null;
		};

		setTimeout(fn, 0);
	}
	finally
	{
		fn = null;
	}
}

/**
 * 插入外部构造意见
 */
LEAP.opinion2.appendValue = function(element, opinions)
{
	try
	{
		if (!opinions)
			return;
			
		var fn = function()
		{	
			for (var k = 0; k < opinions.length; k++)
			{
				if (!opinions[k].hasconfirm)
					opinions[k].hasconfirm = 1;
				LEAP.opinion2.append(element, opinions[k]);
			}
			k = null;
		};
		
		setTimeout(fn, 0);
	}
	finally
	{
		fn = null;
	}
}

/**
 * 设置页面是否自动绑定
 * 
 * @param {}
 *            instance
 * @param {}
 *            formElement
 * @param {}
 *            auto
 */
LEAP.opinion2.setPageAutoBinding = function(instance, formElement, auto, csid)
{

	var elements = LEAP.getElements("div[ct=" + LEAP.opinion2.d + "][instance="
					+ instance + "]", formElement);
	if (!elements)
		return;

	for (var i = 0; i < elements.length; i++)
	{
		elements[i].setAttribute('autobinding', auto);
		if (csid)
			elements[i].setAttribute('_csid', csid);
	}
}
LEAP.opinion2.enableHandsign = function(instance, formElement, h)
{

	var elements = LEAP.getElements("div[ct=" + LEAP.opinion2.d + "][instance="
					+ instance + "]", formElement);
	if (!elements)
		return;
		
	if (h != 0)
		h = 1;

	for (var i = 0; i < elements.length; i++)
	{
		elements[i].setAttribute('enablehandsign', h);
	}
}
LEAP.opinion2.setPageArchiveCategory = function(instance, formElement, category)
{
	if (category != null)
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion2.d
						+ "][instance=" + instance + "]", formElement);
		if (!elements)
			return;

		for (var i = 0; i < elements.length; i++)
		{
			elements[i].setAttribute('archCategory', category);
		}
	}
}

/**
 * 获取意见控件意见数据,供流程使用
 * 
 * @param {}
 *            instance
 * @param {}
 *            formElement
 * @return {}
 */
LEAP.opinion2.getPageValue = function(instance, formElement)
{
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion2.d
						+ "][instance=" + instance + "]", formElement);
		if (!elements)
			return null;
		var value = [];
		for (var i = 0; i < elements.length; i++)
		{
			var _value = LEAP.opinion2._getChange(elements[i]);
			if (_value != null)
				value.add(_value);
		}

		if (value.length == 0)
			return null;
		else
			return value;
	}
	finally
	{
		elements = value = _value = null;
	}
}

LEAP.opinion2.setAgentInformation = function(instance, formElement, value)
{

}

/**
 * 设置意见控件意见数据,供流程使用
 * 
 * @param {}
 *            instance
 * @param {}
 *            formElement
 * @param {}
 *            value
 */
LEAP.opinion2.setPageValue = function(instance, formElement, value)
{
	try
	{
		if (value == null)
			return;
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion2.d
						+ "][instance=" + instance + "]", formElement);
		if (!elements)
			return;

		for (var i = 0; i < elements.length; i++)
		{
			var element = elements[i];

			LEAP.opinion2.__i(element);

			var mdid = element.getAttribute('mdid');
			if (!mdid)
			{
				mdid = UUID.randomUUID().replaceall('-', '');
				element.setAttribute('mdid', mdid);
			}

			for (var j = 0; j < value.length; j++)
			{
				var ops = value[j];
				if (ops.mdid == mdid)
				{	
					/*for (var k = 0; k < ops.opinions.length; k++)
					{
						LEAP.opinion2.append(element, ops.opinions[k]);
					}*/
					LEAP.opinion2.innerSetValue2(element, ops.opinions);
				}
			}
		}
	}
	finally
	{
		elements = element = mdid = i = j = ops = null;
	}
}

LEAP.opinion2.innerSetValue2 = function(element, opinions)
{
	try
	{
		if (!opinions)
			return;
		
		var singleopinion = element.getAttribute("singleopinion");
		var _csid = element.getAttribute("_csid");
		var _idx = -1;//限制单条时，获取当前环节当前用户最后一条索引
		if (singleopinion && singleopinion=="1" && _csid)
		{
			for (var i = 0; i < opinions.length; i++)
			{
				if ((opinions[i].category == _csid) && (opinions[i].handsignimg==null || opinions[i].handsignimg.isEmpty()))
					_idx = i;
			}
		}
		
		if (_idx >= 0)
		{
			LEAP.opinion2.__displayButton(element, false);
		}

		for (var k = 0; k < opinions.length; k++)
		{
			var op = opinions[k];
			var item = LEAP.opinion2.append(element, op, (k==0)?null:opinions[k-1]);
			if (_csid && _csid==op.category)
			{
				item.setAttribute("___category", _csid);
			}
				
			if (k == _idx)
			{	
				var quirks = element.getAttribute("quirks");
				if (quirks == "1")
				{
					//quirks模式下不隐藏，并且点修改按钮才修改
				}
				else
				{
					item.style.display = "none"; //隐藏最后一条
					LEAP.opinion2._edit(item);
				}
			}
		}
	}
	finally
	{
		singleopinion = _csid = _idx = i = k = item = k = quirks = _csid = null;
	}
}

/**
 * 控件验证: 此方式使用场景:意见控件需要添加验证.没有填写意见不允许保存
 * 
 * 业务方法说明: 此方法用来判断意见控件是否有值,分三种情况 1.判断文本框中是否有值 2.判断列表清单中是否有新增的（包括前一次保存的和本次新填写的）
 * 
 * @return String 校验不通过返回 null，否则返回任意值
 */
LEAP.opinion2.validate = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (element == null)
			return true;

		// 1.判断文本框中是否有值
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
				element);
		if (text != null && text.value != "" && text.value != LEAP.opinion2.def)
			return true;

		// 2.判断已填写的意见中是否存在新增意见
		var bool = false;
		var addobjs = LEAP.getElements("[ctf=" + LEAP.opinion2.ctf._item + "]",
				element);
		if (!addobjs)
		{
			bool = false;
		}
		else
		{
			for (var i = 0; i < addobjs.length; i++)
			{
				if (addobjs[i] && addobjs[i]._obj)
				{
					if (!addobjs[i]._obj.opiniontype)
					{
						if (addobjs[i]._obj.hasconfirm == 0) // 判断是否有上次保存提交的
						{
							bool = true;
							break;
						}
					}
					else if (addobjs[i]._obj.opiniontype == 0 || addobjs[i]._obj.opiniontype == 1)
					{ // 本次填写的 或者 本次修改的
						bool = true;
					}
				}
			}
		}

		if (bool == false)
			return null;
		else
			return true;

	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element = bool = text = addobjs = i = null;
	}
}

/**
 * 获取插件当前的值,返回数组
 * @param {} element
 */
LEAP.opinion2.getCurrentValues = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (element == null)
			return;

		var obj = [];
		var addobjs = LEAP.getElements("[ctf=" + LEAP.opinion2.ctf._item + "]",
				element);
		if (addobjs)
		{
			for (var i = 0; i < addobjs.length; i++)
			{
				if (addobjs[i])
				{
					var itemobj = addobjs[i]['_obj'];
					if (itemobj && itemobj.opiniontype == 0)
					{
						obj.add(itemobj);
					}
				}
			}
		}
		// 判断输入框中是否有值有的话，把此值也添加进change
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
				element);
		
		if (text != null && !text['edititem'] && text.value != "" && text.value != LEAP.opinion2.def)
		{
			var t_value = text.value;
			var obj1 =
			{};
			obj1.opiniontype = 0;
			obj1.entryid = element.getAttribute('entryid');
			obj1.parentid = "";
			obj1.entrymdid = element.getAttribute('mdid');
			obj1.opinioncontent = t_value;
			obj1.hasconfirm = 0;
			obj1.username = LEAP.userInfo.fullName;
			obj1.userflag = LEAP.userInfo.userflag;
			obj1.opiniontime = {time: LEAP.getServerTimeTicket()};	//{time : LEAP.getServerTime()};
			obj.add(obj1);
		}
		if (obj.length == 0)
		{
			return null;
		}
		else
		{
			return obj;
		}

	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return null;
	}
	finally
	{
		element = obj = itemobj = addobjs = obj1 = t_value = text = null;
	}
}

/**
 * 控件取值
 * 
 * 业务方法说明:
 * 1.取last_changeobj,如果没有表示第一次进入此element._getChange方法,此时返回A列表中新增的值.B.与文本框中值的集合.C.删除的对象
 * 2.存在last_changeobj,说明已经执行说element._getChange方法
 * 2.1判断是否执行过数据校验的方法,如果没有直接返回last_changeobj 2.2如果执行数据校验方法. 2.2.1
 * 校验成功直接返回last_changeobj 2.2.2 校验失败.在原对象中再次进行数据添加A列表中新增的值.B.与文本框中值的集合.C.删除的对象
 * 
 * @param {}
 *            element
 */
LEAP.opinion2._getChange = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (element == null)
			return;

		// 输入框有值的话，先变更
		LEAP.opinion2.addopinion(element);
		
		var _obj = element['changeobj'];

		var obj = [];
		if (_obj && _obj.length > 0)
		{
			for (var i = 0; i < _obj.length; i++)
				obj.add(_obj[i]);
		}

		var addobjs = LEAP.getElements("[ctf=" + LEAP.opinion2.ctf._item + "]",
				element);
		if (addobjs)
		{
			for (var i = 0; i < addobjs.length; i++)
			{
				if (addobjs[i])
				{
					var itemobj = addobjs[i]['_obj'];
					if (itemobj && itemobj.opiniontype == 0)
					{
						obj.add(itemobj);
					}
				}
			}
		}
		
		// 判断输入框中是否有值有的话，把此值也添加进change
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
				element);		
		if (text != null && !text['edititem'] && text.value != "" && text.value != LEAP.opinion2.def)
		{
			var t_value = text.value;
			var obj1 =
			{};
			obj1.opiniontype = 0;
			obj1.entryid = element.getAttribute('entryid');
			obj1.parentid = "";
			obj1.entrymdid = element.getAttribute('mdid');
			obj1.opinioncontent = t_value;
			obj1.hasconfirm = 0;
			obj1.username = LEAP.userInfo.fullName;
			obj1.userflag = LEAP.userInfo.userflag;
			obj1.opiniontime ={time: LEAP.getServerTimeTicket()};	//{time : LEAP.getServerTime()};
			var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._specialsign + "]",
				element);
			if(specialsign && specialsign.value)
				obj1.specialsign = specialsign.value;
			var _csid = element.getAttribute("_csid");
			if (_csid)
				obj1.category = _csid;
				
			obj.add(obj1);
		}
		
		
		if (obj.length == 0)
		{
			return null;
		}
		else
		{
			return {mdid : element.getAttribute('mdid'),opinions:obj};
		}

	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return null;
	}
	finally
	{
		element = obj = itemobj = addobjs = _obj = _csid = null;
	}
}

/**
 * 意见控件删除按钮事件
 * 
 * @param {}
 *            element
 * @param {}
 *            src
 */
LEAP.opinion2._delete = function(src)
{
	try
	{
		if (!src)
			return;
		var element = LEAP._match(src, LEAP.opinion2.d);
		if (!element)
			return;
		var opinionlistdiv = LEAP.getElement('[ctf=' + LEAP.opinion2.ctf._list
						+ ']', element);
		var item = LEAP._match(src, LEAP.opinion2.ctf._item, "ctf");
		if (!item)
			return;
		var obj = item._obj;
		if (!obj)
			return;
		var changeobj = element['changeobj'];
		if (!changeobj)
		{
			changeobj = [];
			element['changeobj'] = changeobj;
		}
		//等于0表示是新增的，则不缓存
		if (obj.opiniontype == null || (obj.opiniontype != null && obj.opiniontype != 0))
		{
			obj.opiniontype = 2;
			changeobj.add(obj);
			element['changeobj'] = changeobj;
		}
		LEAP.removeElement(item);
		
		LEAP.opinion2.clear_txt(element);
				
		var singleopinion = element.getAttribute("singleopinion");
		var quirks = element.getAttribute("quirks");
		if (quirks == "1" && singleopinion == "1")
		{			
			var _csid = element.getAttribute("_csid");			
			var __itms = LEAP.getElements("[___category=" + _csid + "]", element);
			if (!__itms)
			{
				LEAP.opinion2.__displayButton(element, true);				
			}	
		}

	}
	catch (e)
	{
		alert("错误：" + e.number + ":" + e.description);
	}
	finally
	{
		element = opinionlistdiv = item = obj = changeobj = singleopinion = quirks = _csid = __itms = null;
	}
}

LEAP.opinion2._edit = function(src)
{
	try
	{
		var element = LEAP._match(src, LEAP.opinion2.d);
		
		var item = LEAP._match(src, LEAP.opinion2.ctf._item, "ctf");		
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]", element);
		
		var _obj = item['_obj'];
		
		text.value = _obj.opinioncontent;
		
		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._specialsign + "]",
					element);
		if(specialsign)
		{
			if(_obj.specialsign)
				specialsign.value = _obj.specialsign;
			else
				specialsign.value = "";
		}
		
		text['edititem'] = item;	
		text.style.color = LEAP.postil._color._normal;
	}
	catch (e)
	{
		alert("错误：" + e.number + ":" + e.description);
	}
	finally
	{	
		element = item = text = _obj = specialsign = null;
	}
}

LEAP.opinion2.setDefaultOpinion = function(element, txt)
{
	try
	{
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]", element);
		if (!text)
			return;
			
		if (txt == null || txt.isEmpty())
			text.value = null;
		else
			text.value = txt;
	}
	finally
	{
		txt = null;
	}
}

LEAP.opinion2.addDefaultOpinion = function(element, txt, overwrite)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (!element)
			return;
		
		var done = false;
		if (overwrite == true)
		{
			var lastItem = LEAP.getElement("[isTempItem=1]", element);
			if (lastItem)
			{				
				lastItem['_obj'].opinioncontent = txt;				
				LEAP.opinion2.update(lastItem, txt, null);				
				LEAP.opinion2.clear_txt(element);				
				done = true;
			}
		}
		
		if (done == false)
		{
			var obj = {};
			obj.opiniontype = 0;
			obj.entryid = element.getAttribute('entryid');
			obj.parentid = "";
			obj.entrymdid = element.getAttribute('mdid');
			obj.opinioncontent = txt;
			obj.hasconfirm = 0;
			obj.username = LEAP.userInfo.fullName;
			obj.userflag = LEAP.userInfo.userflag;
			obj.opiniontime ={time: LEAP.getServerTimeTicket()};	//{time : LEAP.getServerTime()};
			obj.canDelete = true;
			obj.canUpdate = true;
			
			var _csid = element.getAttribute("_csid");			
			if (_csid)
				obj.category = _csid;
				
			if (element['extendParams'] && element['extendParams'].currentStep)
				obj.categoryName = element['extendParams'].currentStep.stepaliasname;

			var item = LEAP.opinion2.append(element, obj);
			if (item)
			{
				item.setAttribute("isTempItem", 1);	
				LEAP.opinion2.clear_txt(element);
				
				LEAP.opinion2.__displayButton(element, false);
			}
		}
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		element = done = lastItem = obj = _csid = item = null;
	}
}

LEAP.opinion2.addOrUpdateDefaultOpinion = function(element, txt)
{
	var done = false;
	var items = LEAP.getElements("[ctf=" + LEAP.opinion2.ctf._item + "]",	element);
	if (items)
	{
		var op = items[items.length-1]['_obj'];
		if (op.canUpdate == true)
		{	
			LEAP.opinion2.update(items[items.length-1], txt, null);
			
			done = true;
		}
	}
	
	if (done == false)
	{
		LEAP.opinion2.addDefaultOpinion(element, txt, true);
	}
}


/**
 * 意见控件添加意见
 * 
 * @param {}
 *            element
 */
LEAP.opinion2.addopinion = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (!element)
			return;
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
				element);
		if (!text)
			return;
			
		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._specialsign + "]",
				element);
		var t_specialsign = null;
		if(specialsign)
			t_specialsign = specialsign.value; 
			
		var singleopinion = element.getAttribute("singleopinion");
		
		if (text['edititem'])
		{
			try
			{
				var t_value = text.value;	
				var singleopinion = element.getAttribute("singleopinion");
				if (t_value && t_value != "" && t_value != LEAP.opinion2.def)
				{
					LEAP.opinion2.update(text['edititem'], t_value, t_specialsign);
				}
				else if (singleopinion == "1"  && (t_value == "" || t_value == LEAP.opinion2.def) )
				{
					LEAP.opinion2._delete(text['edititem']);
				}			
			}
			finally
			{			
				LEAP.opinion2.clear_txt(element);
			}
		}
		else
		{	
			if (singleopinion != "1")
			{
				var _csid = element.getAttribute("_csid");
				var t_value = text.value;
				if (!t_value || t_value == LEAP.opinion2.def)
					return;
				var obj =
				{};
				obj.opiniontype = 0;
				obj.entryid = element.getAttribute('entryid');
				obj.parentid = "";
				obj.entrymdid = element.getAttribute('mdid');
				obj.opinioncontent = t_value;
				obj.hasconfirm = 0;
				obj.username = LEAP.userInfo.fullName;
				obj.userflag = LEAP.userInfo.userflag;
				obj.opiniontime ={time: LEAP.getServerTimeTicket()};	//{time : LEAP.getServerTime()};
				obj.canDelete = true;
				obj.canUpdate = true;
				if(t_specialsign)
					obj.specialsign = t_specialsign;
				if (_csid)
					obj.category = _csid;
		
				LEAP.opinion2.append(element, obj);
		
				LEAP.opinion2.clear_txt(element);
			}
		}
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		element = text = specialsign = t_specialsign = singleopinion = t_value = singleopinion = _csid = t_value = obj = null;
	}
}

LEAP.opinion2.___processimg = function(sourceImg, src)
	{
		var img = new Image();
		img.targetImg = LEAP.ctid(sourceImg);
		
		if (img.attachEvent)
		{
			img.onreadystatechange = function()
			{
				var state = this.readyState;
				if (state == 'complete' || state == 'loaded')
				{
					this.onreadystatechange = null;
					this.onerror = null;
					
					var ctid = this.targetImg;
					var si = LEAP.getElement('IMG[ctid='+ctid+']:first');
					si.src = this.src;
					
					si = null;
				}
				else
				{
				}
			};
			img.onerror = function()
			{
				this.onreadystatechange = null;
				this.onerror = null;
			};
		}
		else
		{
			img.onload = function()
			{
				var ctid = this.targetImg;
				var si = LEAP.getElement('IMG[ctid='+ctid+']:first');
				si.src = this.src;
				
				si = null;	
				this.onload = null;
			};
		}
		img.src = src;
		sourceImg = null;
	}

LEAP.opinion2.__getImageAttachments = function(element, category, prev)
{
	try
	{
		if (element['extendParams'] == null || element['extendParams'].attachments == null)
			return null;
		
		if (prev != null && prev.category == category)
			return null;
			
		var ret = [];
		for(var i=0; i<element['extendParams'].attachments.length; i++)
		{	
			var att = element['extendParams'].attachments[i];
			
			if (att.category == category)
			{			
				var n = att.name.toLowerCase();
				if (n.endWith('.jpg') || n.endWith('.jpeg') || n.endWith('.png') || n.endWith('.gif'))
					ret.add(att);
			}
		}
		
		return (ret.length == 0)?null:ret;
	}
	finally
	{
		ret = i = att = n = null;
	}	
}

/**
 * 意见列表添加方法
 * 
 * @param {}
 *            element
 * @param {}
 *            opinion
 */
LEAP.opinion2.append = function(element, opinion, prev)
{
	try
	{
		var opinionlistdiv = LEAP.getElement('[ctf=' + LEAP.opinion2.ctf._list + ']', element);
		if (opinionlistdiv == null)
			return;
		
		var item = document.createElement("DIV");
			item.setAttribute('ctf', LEAP.opinion2.ctf._item);
			item.className = 'wfcontrol_opinion2_item';
			item['_obj'] = opinion;
		
		opinionlistdiv.appendChild(item);
		
		//内容
		if (opinion.handsign != null && opinion.handsign != "")
		{
			var handsign = opinion.handsign;
			if (typeof(opinion.handsign) == "string")
				handsign = JSON.parse(opinion.handsign);
				
			item['handsignValue'] = handsign;
			
			var url = LEAP.upload.getPath(handsign.nameedPath||handsign.nameedpath, handsign.viewName||handsign.viewname, handsign.uuid);
			
			var _img = document.createElement("img");
			item.appendChild(_img);
			LEAP.opinion2.___processimg(_img, url);
			_img.style.styleFloat = "left";
			if(handsign.viewWidth)
				_img.width = handsign.viewWidth;				
			if(handsign.viewHeight)
				_img.height = handsign.viewHeight;
			_img.setAttribute("ctf", LEAP.opinion2.ctf._handsignViewer);		
						
		}
		else if (opinion.handsignimg != null && opinion.handsignimg != "")
		{
			var handsignimg = opinion.handsignimg;
			item['handsignValue'] = handsignimg;
			
			var _img = document.createElement("img");
			item.appendChild(_img);
			_img.style.styleFloat = "left";
			_img.setAttribute("ctf", LEAP.opinion2.ctf._handsignViewer);
			_img.setAttribute("src", "data:image/jpeg;base64," + handsignimg);
		}
		else
		{
			var _div = document.createElement("div");
				_div.style.textAlign = "left";
				_div.style.styleFloat = "left";
				_div.setAttribute("ctf", LEAP.opinion2.ctf._itemContent);
				if (opinion.opinioncontent == null)
					 opinion.opinioncontent = "";
				if (element.getAttribute('showstepname') && element.getAttribute('showstepname') == "1" && opinion.categoryName)
					_div.innerHTML = "<span style='font-weight: bold;'>" + opinion.categoryName + "：</span>" + opinion.opinioncontent.replaceall("\r\n", "\n").replaceall("\n", "\n        ");
				else
					_div.innerText = "        " + opinion.opinioncontent.replaceall("\r\n", "\n").replaceall("\n", "\n        ");
				
				
			item.appendChild(_div);
		}
		
		if (element.getAttribute('showImageAttachments') == "1")
		{			
			var imgs = LEAP.opinion2.__getImageAttachments(element, opinion.category, prev);
			if (imgs)
			{			
				var _imgDiv = document.createElement("div");
					_imgDiv.style.width = "100%";
					_imgDiv.style.height = "50px";
					_imgDiv.style.styleFloat = "left";
				item.appendChild(_imgDiv);
				
				var _imgView = document.createElement("div");
					_imgView.className = 'wfcontrol_imgview';
					_imgView.setAttribute('ct', 'imgview');
					_imgView.setAttribute('viewmode', '0');
				_imgDiv.appendChild(_imgView);
				_imgView.innerHTML = "<IMG style='DISPLAY: none' onerror=LEAP.imgview.i(0); src='data:image:png,base64'>";
				
				LEAP.imgview.setValue(_imgView, imgs);
				//_imgDiv.innerHTML = "<DIV class='wfcontrol_imgview' ct='imgview' viewmode='0'><IMG style='DISPLAY: none' onerror=LEAP.imgview.i(0); src='data:image:png,base64'></DIV>";
			}
		}
		
		//人、日期
		var _div2 = document.createElement("div");
			_div2.style.styleFloat = "right";
			_div2.style.width = "100%";			
		item.appendChild(_div2);
		
		if (element.getAttribute('readonly') != "1")
		{
			if (opinion.canDelete == true)
			{
				var amd = document.createElement("A");
				amd.setAttribute('ctf', LEAP.opinion2.ctf._delete);
				amd.className = 'wfcontrol_opinion2_item_delete';			
				//item.appendChild(amd);
				_div2.appendChild(amd);
			}
		}
		if (opinion.canUpdate == true && opinion.handsign == null && (opinion.handsignimg == null || opinion.handsignimg.isEmpty() == true))
		{
			amd = document.createElement("A");
			amd.setAttribute('ctf', LEAP.opinion2.ctf._edit);
			amd.className = 'wfcontrol_opinion2_item_edit';			
				//item.appendChild(amd);
			_div2.appendChild(amd);
		}
		
		var lasttxt = "[" + opinion.username + "]";
		if (opinion._viewPrefix == true)
			lasttxt = "[" + ((opinion.organname && !opinion.organname.isEmpty())?opinion.organname:"")  + opinion.username + "]";
		
		var showdelegate = element.getAttribute("showdelegate");	
		if (showdelegate != null && showdelegate == '0')
		{			
		}
		else if (opinion.agentuserflag != null && opinion.agentusername != "")
			lasttxt += "[代理人:" + opinion.agentusername + "]";	
			
		if(element.getAttribute('formattype'))
			lasttxt += "　　" + LEAP.formatdate(opinion.opiniontime.time, element.getAttribute('formattype'));
		else
			lasttxt += "　　" + LEAP.formatdate(opinion.opiniontime.time, 0); 
		
		var atx = document.createElement("A");
			atx.className = 'wfcontrol_opinion2_item_text';
			atx.style.styleFloat = "right";
			atx.style['float'] = "right";
			atx.style.width = "auto";			
		if (element.getAttribute('signcolor'))
			atx.style.color = element.getAttribute('signcolor');		
			
			if(opinion.specialsign)
			{
				atx.innerText = opinion.specialsign;
				atx.title = lasttxt;
			}
			else
			{
				//是否显示手写签名
				var showsignimg = element.getAttribute("showsignimg");
				var hassignimg = false;
				if (showsignimg != null && showsignimg == '1')
				{
					var img = LWFP.innerApi.SignImg.getSignImg(opinion.username);          
	                if(img && img.imguri)
	                {
	                    var img = JSON.parse(img.imguri);
	                    if(img.name)
	                    {
	                    	hassignimg = true;
	                    	//手写签名高度
							var signimgheight = element.getAttribute("signimgheight");
							if(!signimgheight)
								signimgheight = "26px";
							atx.style.lineHeight = signimgheight;	
							
	                    	var uri = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/Download/"+img.nameedPath+"/"+img.name;                        
		                    uri = "<img height="+signimgheight+" src='"+uri+"'></img>";		                   
		                    
		                    if(element.getAttribute('formattype'))
								 atx.innerHTML = uri + "　　　" + LEAP.formatdate(opinion.opiniontime.time, element.getAttribute('formattype'));
							else
								 atx.innerHTML = uri + "　　　" + LEAP.formatdate(opinion.opiniontime.time, 0);
	                    }                   
	                }                
														
				}
				
				if(hassignimg == false)
					atx.innerText = lasttxt;
			}
			
		_div2.appendChild(atx);		
		
		element.setAttribute('entryid', opinion.entryid);
	
		var _csid = element.getAttribute("_csid");
		if (_csid && _csid == opinion.category)
		{
			item.setAttribute("___category", _csid);
		}
		
		return item;
	}
	finally
	{	
		opinionlistdiv = item = handsign = url = _img = handsignimg = _img = _div = _div2 = amd = lasttxt = showdelegate = atx = null; 
		showsignimg = hassignimg = img = signimgheight = uri = _csid = _imgDiv = _imgView = null 
	}
}

LEAP.opinion2.update = function(item, content, specialsign)
{
	try
	{
		var item = LEAP._match(item, LEAP.opinion2.ctf._item, "ctf");
		if (!item)
			return;
		var element = LEAP._match(item, LEAP.opinion2.d);
		if (!element)
			return;
		var con = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._itemContent + "]", item);
		
		var _obj = item['_obj'];
			_obj.opinioncontent = content;
		if (_obj.opiniontype != 0) //如果不是新增的则改为修改的
			_obj.opiniontype = 1;
		
		//con.innerText = content;
		con.innerText = "        " + content.replaceall(" ", "").replaceall("\r\n", "\n").replaceall("\n", "\n        ");
		if(specialsign)
		{
			var a = LEAP.getElement("a.wfcontrol_opinion2_item_text", item);
			a.innerText = specialsign;
			_obj.specialsign = specialsign;
		}
		item['_obj'] = _obj;
				
		var changeobj = element['changeobj'];
		if (_obj.id != null) //id为空则是新增的，不做考虑
		{
			if (!changeobj)
				changeobj = [];
			
			changeobj.add(_obj);
			
			element['changeobj'] = changeobj;		
		}
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		item = element = con = _obj = changeobj = null;
	}	
}

LEAP.opinion2._showHandsign = function(arg)
{
	try
	{
		var _value = arg.e.srcElement.parentElement['handsignValue'];
		if (_value.name == null || _value.name == '')
			return;			
		
		if (LEAP.opinion2.handsignViewer == null)
		{
			LEAP.opinion2.handsignViewer = document.createElement("div");
			LEAP.opinion2.handsignViewer.style.position = "absolute";			
			LEAP.opinion2.handsignViewer.style.zIndex = 99999999;
			LEAP.opinion2.handsignViewer.style.left = 0;
			LEAP.opinion2.handsignViewer.style.top = 0;
			LEAP.opinion2.handsignViewer.style.borderWidth = 4;
			LEAP.opinion2.handsignViewer.style.borderColor = "#5192C8"; //"#C2C4C6";
			LEAP.opinion2.handsignViewer.style.borderStyle = "solid";
			LEAP.opinion2.handsignViewer['ctf'] = "handsign_show";
			
			document.body.appendChild(LEAP.opinion2.handsignViewer);			
			LEAP.opinion2.handsignViewer.style.display = "none";
			
			var _a = document.createElement("A");
			_a['ctf'] = "handsign_close";
			_a.className = 'wfcontrol_opinion2_handsign_close';
			LEAP.opinion2.handsignViewer.appendChild(_a);
		}		
		
		var _url = LEAP.upload.getPath(_value.nameedPath, _value.name, _value.uuid);
		
		LEAP.opinion2.handsignViewer.style.width = _value.width;
		LEAP.opinion2.handsignViewer.style.height = _value.height;
		LEAP.opinion2.handsignViewer.style.left = arg.e.clientX;
		LEAP.opinion2.handsignViewer.style.top = arg.e.clientY;
		LEAP.opinion2.handsignViewer.style.backgroundImage = "url(" + _url + ")";
		
		LEAP.opinion2.handsignViewer['canhide'] = "no";
		LEAP.opinion2.handsignViewer.style.display = "block";		
	}
	finally
	{
		_value = _url = _a = null; 	
	}	
}

LEAP.opinion2._hideHandsign = function(arg)
{		
	try
	{
		var flag = true;		
		if (arg && arg.e && arg.e.srcElement)
		{
			var ctf = arg.e.srcElement.getAttribute(commfields.ctf);
			if (ctf == "handsign_show")
				flag = false;
		}
		
		if (flag == true && LEAP.opinion2.handsignViewer != null)
		{
			if (LEAP.opinion2.handsignViewer['canhide'] == "yes")
				LEAP.opinion2.handsignViewer.style.display = "none";
			else
				LEAP.opinion2.handsignViewer['canhide'] = "yes";
		}		
	}	
	finally
	{
		flag = ctf = null;
	}
	
}

/**
 * 意见控件设置显示内容
 * 
 * @param {}
 *            element
 */
LEAP.opinion2.set_txt = function(element,value)
{
	try
	{
		if (!element)
			return;
		// 文本
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
				element);
		if (!text)
			return;
		
		text.value = value;		
	}
	catch (e)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element = text = null;
	}
}

/**
 * 意见控件清除按钮事件
 * 
 * @param {}
 *            element
 */
LEAP.opinion2.clear_txt = function(element)
{
	try
	{
		if (!element)
			return;
		// 清空按钮
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
				element);
		if (!text)
			return;
		
		text.value = "";
		text['edititem'] = null;
		
		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._specialsign + "]",
				element);
		if(specialsign)
			specialsign.value = "";
	}
	catch (e)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element = text = null;
	}
}

/**
 * 意见控件设置落款
 * 
 * @param {}
 *            element
 */
LEAP.opinion2.setSpecialSignValue = function(element,value)
{
	try
	{
		element = LEAP._check(element, LEAP.opinion2.d);
		if (!element)
			return;
		var text = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._txt + "]",
				element);
		if (!text)
			return;
			
		var specialsign = LEAP.getElement("[ctf=" + LEAP.opinion2.ctf._specialsign + "]",
				element);
				
		if(specialsign)	
			specialsign.value = value;
		
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		element = text = null;
	}
}

LEAP.opinion2.onHandwriteComplete = function(e, result)
{
	try
	{
		var obj = {};
			obj.opiniontype = 0;
			obj.entryid = e.getAttribute('entryid');		
			obj.entrymdid = e.getAttribute('mdid');		
			obj.hasconfirm = 0;
			obj.username = LEAP.userInfo.fullName;
			obj.userflag = LEAP.userInfo.userflag;		
			obj.canDelete = true;
			obj.opiniontime = {time: LEAP.getServerTimeTicket()}; //{time : Date.parse(new Date())};	//{time : LEAP.getServerTime()};
						
			result.viewName = result.name;
			result.viewWidth = result.width + 1;
			result.viewHeight = result.height + 1;			
			result.name = null;
			result.width = 0;
			result.height = 0;
			
			obj.handsign = JSON.stringify(result);
	
			LEAP.opinion2.append(e, obj);
			
			LEAP.opinion2.__displayButton(e, false);
	}
	finally
	{
		obj = null;
	}
	
	//{"name":"aaa.jpg","nameedPath":"default/2012/7/31","path":"C:/uploadfile//2012/7/31/aaa.jpg","viewName":"aaa_view.jpg","viewWidth":90, "viewHeight":50, "width":657, "height":263}
}

LEAP.opinion2.setExtendParams = function(instance, formElement, extendParams)
{
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.opinion2.d
						+ "][instance=" + instance + "]", formElement);
		if (!elements)
			return null;
		
		for (var i = 0; i < elements.length; i++)
		{
			elements[i]['extendParams'] = extendParams;
		}
	}
	finally
	{
		elements = i = null;
	}
}


/**
 * 意见控件初始化方法
 * 
 * @param {}
 *            wait
 * @param {}
 *            src
 */
LEAP.opinion2.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;

	/*
	 * if (LEAPBrowser.isIE && wait != null) { var fn = function() {
	 * LEAP.opinion2.i(null, src); src = null; }; setTimeout(fn, wait); return; }
	 */

	LEAP.opinion2._i(src);
	if (src.parentElement)
		src.parentElement.removeChild(src);
}

LEAP.opinion2._i = function(src)
{
	try
	{
		var _element = LEAP._match(src, LEAP.opinion2.d);
		if (_element == null)
			return;
		LEAP.opinion2.__i(_element);
	}
	finally
	{
		_element = null;
	}
}


LEAP.opinion2.__i = function(_element)
{
	try
	{
		_element = LEAP._check(_element, LEAP.opinion2.d);
		if (!_element)
			return;

		if ((_element.parentNode.tagName).toUpperCase() == 'TD')
			_element.parentNode.parentNode.style.height = 'auto';

		var mdid = _element.getAttribute("mdid");
		if (!mdid)
		{
			mdid = UUID.randomUUID().replaceall('-', '');
			_element.setAttribute("mdid", mdid);
		}
		var handsign = _element.getAttribute("enablehandsign");
		//是否显示公共批示语
		var showpostil = _element.getAttribute("showpostil");
		//是否显示落款修改
		var showspecialsign = _element.getAttribute("showspecialsign");
		//是否自动过滤批示语
		var autofilter = _element.getAttribute("autofilter");
		//是否显示手写签名
		var showsignimg = _element.getAttribute("showsignimg");
		//是否显示确定按钮
		var showbutton = _element.getAttribute("showbutton");
		//是否只能输入单条意见
		var singleopinion = _element.getAttribute("singleopinion");
		var quirks = _element.getAttribute("quirks");
		if (!singleopinion)
		{
			_element.setAttribute("singleopinion", 1);
			singleopinion = "1";
		}
		if (singleopinion == "1")
			showbutton = "0";
		if (quirks == "1")
			showbutton = "0";

		var hassignimg = false;
		
		if (!LEAP.getElement('div[ctf=' + LEAP.opinion2.ctf._list + ']',	_element))
		{	
			var inner = "<div class='wfcontrol_opinion2_list' ctf='" + LEAP.opinion2.ctf._list + "'></div>";
			inner += "<div class='wfcontrol_opinion2_editor' ctf='" 	+ LEAP.opinion2.ctf._control + "'>";
					
			if (quirks != "1")
			{
				if(autofilter!=null && autofilter=="0")
				{
					inner += "<textarea class='wfcontrol_opinion2_editor_textarea' rows=5 ctf='"
							+ LEAP.opinion2.ctf._txt + "' ptf='postil' autofilter=0 ></textarea>";
				}
				else
				{
					inner += "<textarea class='wfcontrol_opinion2_editor_textarea' rows=5 ctf='"
							+ LEAP.opinion2.ctf._txt + "' ptf='postil' ></textarea>";
				}
			}
			
			if (showsignimg != null && showsignimg == '1')
			{
				var img = LWFP.innerApi.SignImg.getSignImg(LEAP.getUserInfo().fullName);          
                if(img && img.imguri)
                {
                    img = JSON.parse(img.imguri);
                    if(img.name)
                    {
                    	hassignimg = true;
                    	//手写签名高度
						var signimgheight = _element.getAttribute("signimgheight");
						if(!signimgheight)
							signimgheight = "26px";
                    	var uri = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(_element)) + "LEAP/Download/"+img.nameedPath+"/"+img.name;                   
                    
	                    inner += "<img height="+signimgheight+" style='float: right;margin-top:5px;' src='"+uri+"' ctf='"
							+ LEAP.opinion2.ctf._signimg + "' ptf='_signimg' ></img>";
                    }                   
                }                
													
			}
			if (hassignimg == false && showspecialsign != null && showspecialsign == '1')
			{
				inner += "<input style='border:1px solid #9f9d9d;background-color:#f8f8f6;float: right;width:400px;margin-top:5px;font-size:12px' ctf='"
						+ LEAP.opinion2.ctf._specialsign + "' ptf='_specialsign' ></input>";									
			}			
			
			inner += "<div class='wfcontrol_opinion2_editor_btnarea'>";				
				
			inner += "<IMG style='DISPLAY: none' src='data:image:png,base64'/>";

			if (handsign != 0 && handsign != '0')
			{
				inner += "<a class='wfcontrol_opinion2_editor_btnhandwrite' href='javascript:' ht='button' ctf='"
						+ LEAP.opinion2.ctf._handwrite + "' tct='opinion2' ct='capture' cap_type=4>手写</a>";					
			}
			
			if (quirks == "1")
			{
				inner += "<a class='wfcontrol_opinion2_editor_btnopen' href='javascript:' ht='button' ctf='"
						+ LEAP.opinion2.ctf._open + "'>录入</a>";
			}			
						
			if (showbutton !=null && showbutton=='0')
			{}
			else
			{
				inner += "<a class='wfcontrol_opinion2_editor_btncancel' href='javascript:' ht='button' style='float:right;' ctf='"
						+ LEAP.opinion2.ctf._cancel + "'>清空</a>";
				inner += "<a class='wfcontrol_opinion2_editor_btnconfirm'href' href='javascript:' ht='button' style='float:right;' ctf='"
						+ LEAP.opinion2.ctf._confirm + "'>确定</a>";
			}
			
			inner += "</div></div>";
			
			_element.innerHTML = inner;
			
			// 设置意见控件的textare的常用批示语支持
			var txtare = LEAP.getElement('[ctf=' + LEAP.opinion2.ctf._txt + ']',
					_element);
			//意见输入框提示文本
			var postiltxt = _element.getAttribute("postiltxt");
			if (txtare)
			{
				LEAP.postil._setload(txtare,postiltxt);
			}
			
			//自定义编辑器高度
			var editorheight = _element.getAttribute("editorheight");
			if(editorheight)
			{
				if (txtare)
				{
					txtare.style.height = editorheight;
				}
			}
		}

		var _readonly = _element.getAttribute('readonly');
		if (_readonly && _readonly == '1')
			_readonly = true;
		else
			_readonly = false;
		if (_readonly)
			LEAP.getElement('div[ctf=opinioncontrol]', _element).style.display = 'none';
		else
			LEAP.getElement('div[ctf=opinioncontrol]', _element).style.display = 'block';
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		_element = mdid = handsign = showpostil = showspecialsign = autofilter = showsignimg = showbutton = singleopinion = null;
		quirks = hassignimg = inner = img = signimgheight = uri = txtare = postiltxt = editorheight = _readonly = null;
	}
}

LEAP.opinion2.init();

/**
 * 附件
 * @class LEAP.Attachment control
 * @type user control
 * @example
 
HTML定义:
<DIV class='wfcontrol_attachment' uploadpath='default' ct='attachment' includemain=1 style="border:1px solid #CCCCCC;"></DIV>
	<IMG style="DISPLAY: none" onerror=LEAP.attachment.i(0); src="data:image:png,base64">			
</DIV>

示例：
<DIV class='wfcontrol_attachment' style="border:1px solid #CCCCCC;">
	 <div class='wfcontrol_attachment_top'>
	      <table>
			<tr class='wfcontrol_attachment_fix_tr'>
				<td>
					文件名
				</td>
				<td>
					操作
				</td>
			</tr>
			<tr>
				<td><a href='' style='color:red;' title='单击此处修改文件'>流程常见问题解决办法.doc【正文】</a></td>
				<td>
					<a class='wfcontrol_attachment_download' href = 'javascript:void(0)' title='下载文件'></a>
					<a class='wfcontrol_attachment_edit' href = 'javascript:void(0)' title='修改文件名'></a>
					<a class='wfcontrol_attachment_delete' href = 'javascript:void(0)' title='删除文件'></a>
				</td>
			</tr>
			<tr>
				<td><a href=''>流程常见问题解决办法.doc</a></td>							
				<td>
					<a class='wfcontrol_attachment_download' href = 'javascript:void(0)' title='下载文件'></a>
					<a class='wfcontrol_attachment_edit' href = 'javascript:void(0)' title='修改文件名'></a>
					<a class='wfcontrol_attachment_delete' href = 'javascript:void(0)' title='删除文件'></a>
				</td>
			</tr>
		</table>						            
 	</div>
	
	<div class='wfcontrol_attachment_bottom'>
		<a class='lgbtn' ct='scanner' tct='attachment' href='javascript:' style='float:right;font-weight:normal;'>扫描上传</a>
		<div tct='attachment' ct='uploadbtn' showtext='上传附件' userpar='0' style='width:76px;height:21px;float:right;' style='float:left;' ><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);' style='float:left;' ></div>
		<div tct='attachment' ctf='wordbtn' ct='uploadbtn' showtext='上传正文' userpar='-9' types='*.doc' style='width:76px;height:21px;float:right;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>
    </div>
</div>

标签:
	readonly 只读,值域为1或者0,默认0
	viewsize 当图片超出该大小时创建缩略图 , 默认50
	minsize 允许上传文件的最小限制,单位为KB 默认0
	maxsize 允许上传文件的最大限制,单位为KB 默认1024*10
	types 选择框过滤的文件类型  ; 分割  如: *.jpg;*.gif;*.png
	typesdesc 选择框过滤的文件类型说明  如: 所有文件
	savesource 是否保存源文件
	viewwidth 缩略图宽度,默认200
	viewheight 缩略图高度,默认200
	quality 缩略图质量 1-100,数字越小质量越低,生成图片的大小越小,默认50
	uploadpath 上传路径 如:default
	
	includemain 是否包含正文0不包含1包含,默认0

	scan 是否带扫描，值域0否1是，默认0
	scan_quality 压缩比率1..100 
	scan_maxwidth 图片压缩最大宽度（像素）
	scan_maxheight 图片压缩最大高度（像素）	
	scan_title 文件显示名
	scan_uploadpath 上传路径
	scan_tct 目标插件
	
*/


LEAP.attachment = {};
LEAP.attachment.d = 'attachment';
LEAP.attachment.n = 'attdata';
LEAP.attachment.ctf = {atttable:'atttable', attrow:'attrow', wordbtn:'wordbtn', scanbtn:'scanbtn', batchUpload:'batchUpload', batchdownload:"batchdownload", editzw:'editzw', open:'open', 
						down:'down', _down:'_down', update:'update', del:'del', uploadbackdiv:'uploadbackdiv',
						btnMD:'btnMD', btnMU:'btnMU',btnMD2:'btnMD2', btnMU2:'btnMU2'};
//LEAP.attachment.symbol ={zw:-9, PDFZW:-6, FJ:1, SM:9};
LEAP.attachment.symbol ={zw:-9, wps:-8, PDFZW:-6, ceb:-4, scan:-3, OFDZW:-2, FJ:0, SM:9}; //{word:-9,wps:-8,pdf:-6,ceb:-4,scan:-3};

LEAP.attachment.udpform = null;
LEAP.attachment.init = function()
{
	if (document != null && document.body != null)
		LEAP.attachment._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.attachment._init);	
		
	ElementEventManager.addManagedEventType(LEAP.attachment.d, 'onAttachmentDownload');
	ElementEventManager.addManagedEventType(LEAP.attachment.d, 'onAttachmentUploadComplete');
}
LEAP.attachment._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.attachment.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.attachment._init);
}
LEAP.attachment.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		var ctf = src.getAttribute('ctf');
		if (ctf == null) 
			return;
				
		var element = LEAP._match(src, LEAP.attachment.d);
		if(null == element) return;
		
		LWFP.debug();
		
		var row = LEAP._match(src, LEAP.attachment.ctf.attrow, 'ctf');
		if (ctf == LEAP.attachment.ctf.open){
			if(LEAP.attachment.useOpenWithNew == true){
				LEAP.attachment._open2(element, row, false, true);
			}else{
				LEAP.attachment._open(row);
			}
			
		}else if (ctf == LEAP.attachment.ctf.down || ctf == LEAP.attachment.ctf._down)
			LEAP.attachment._down(row);
		else if (ctf == LEAP.attachment.ctf.update)
			LEAP.attachment._update(row);
		else if (ctf == LEAP.attachment.ctf.del)
			LEAP.attachment._del(element, row);
		else if (ctf == LEAP.attachment.ctf.uploadbackdiv)
			LEAP.attachment._loadUploadFlash(src, row);
		else if (ctf == LEAP.attachment.ctf.editzw)
			LEAP.attachment._wordEditUpload(src);
		else if (ctf == LEAP.imgview.ctf.preview)
			LEAP.attachment.preview(src);
		else if (ctf == LEAP.attachment.ctf.scanbtn)
			LEAP.attachment.scan(src);
		else if (ctf == LEAP.attachment.ctf.batchUpload)
			LEAP.attachment.batchUpload(element);
		else if (ctf == LEAP.attachment.ctf.batchdownload)
			LEAP.attachment.batchDownload(element);
		else if (ctf == LEAP.attachment.ctf.btnMD2 || ctf == LEAP.attachment.ctf.btnMU2 )
			LEAP.attachment.move(element, row, ctf);
		
		/*else if (ctf == LEAP.attachment.ctf.btnMD)
			LEAP.attachment.move(element, LEAP.attachment.ctf.btnMD);
		else if (ctf == LEAP.attachment.ctf.btnMU)
			LEAP.attachment.move(element, LEAP.attachment.ctf.btnMU);
		
		if (row && row.getAttribute('cccrt') == '_select')
		{
			element.__selectedRow = row.rowIndex;
			LEAP.attachment.setMoveButton(element);
		}*/		
	}
	finally
	{
		src = ctf = element = row = null;
	}
}

LEAP.attachment.move = function(element, row, type)
{
	try
	{
		var idx = row.rowIndex;					
		var table = LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", element);
				
		if (type == LEAP.attachment.ctf.btnMD2 && idx < table.rows.length-1 )
		{
			var rowU = table.rows[idx];
			var rowD = table.rows[idx + 1];
			
			rowU.parentNode.insertBefore(rowD, rowU);
			
			rowU[LEAP.attachment.n].orderid = rowU.rowIndex;			
			if (rowU[LEAP.attachment.n].updateType != 0)
				rowU[LEAP.attachment.n].updateType = 1;
				
			rowD[LEAP.attachment.n].orderid = rowD.rowIndex;
			if (rowD[LEAP.attachment.n].updateType != 0)
			rowD[LEAP.attachment.n].updateType = 1;									
		}
		else if (type == LEAP.attachment.ctf.btnMU2 && idx >1)
		{
			var rowU = table.rows[idx - 1 ];
			var rowD = table.rows[idx];
			
			rowU.parentNode.insertBefore(rowD, rowU);
			
			rowU[LEAP.attachment.n].orderid = rowU.rowIndex;
			if (rowU[LEAP.attachment.n].updateType != 0)
				rowU[LEAP.attachment.n].updateType = 1;
			
			rowD[LEAP.attachment.n].orderid = rowD.rowIndex;
			if (rowD[LEAP.attachment.n].updateType != 0)
				rowD[LEAP.attachment.n].updateType = 1;
		}		
	}
	finally
	{
		table = rowU = rowD = null;
	}
}

/*
LEAP.attachment.setMoveButton = function(element)
{
	try
	{
		if (element['_fixitems'])
			return;
		
		var table = LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", element);
		for(var i=1; i<table.rows.length; i++)
			table.rows[i].style.backgroundColor = "#FFFFFF";
		
		var btnMD = LEAP.getElement("a[ctf=" + LEAP.attachment.ctf.btnMD + "]", element);
		var btnMU = LEAP.getElement("a[ctf=" + LEAP.attachment.ctf.btnMU + "]", element);
		if (btnMD)
			btnMD.style.display = "none";
		if (btnMU)
			btnMU.style.display = "none";
			
		var _readonly = element.getAttribute('readonly');
						
		if (element.__selectedRow && element.__selectedRow >0 && element.__selectedRow <= (table.rows.length-1) 
			&& (_readonly == null || _readonly != '1' ))
		{
			var row = table.rows[element.__selectedRow];
			row.style.backgroundColor = "#DBE8F1";
			
			if (btnMD && element.__selectedRow < (table.rows.length-1))
				btnMD.style.display = "block";
								
			if (btnMU && element.__selectedRow >1)
				btnMU.style.display = "block";				
		}
		else
		{
			element.__selectedRow = null;
		}
	}
	finally
	{
		table = _readonly = row = i = btnMD = btnMU = null;
	}
}

LEAP.attachment.move = function(element, type)
{
	try
	{
		var idx = element.__selectedRow;
		if (idx <=0)
			return;
			
		var table = LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", element);					
		if (type == LEAP.attachment.ctf.btnMD && idx < table.rows.length-1 )
		{
			var rowU = table.rows[idx];
			var rowD = table.rows[idx + 1];
			
			rowU.parentNode.insertBefore(rowD, rowU);
			
			rowU[LEAP.attachment.n].orderid = rowU.rowIndex;
			rowU[LEAP.attachment.n].updateType = 1;
			
			rowD[LEAP.attachment.n].orderid = rowD.rowIndex;
			rowD[LEAP.attachment.n].updateType = 1;
			
			element.__selectedRow = idx + 1;						
		}
		else if (type == LEAP.attachment.ctf.btnMU && idx >1)
		{
			var rowU = table.rows[idx - 1 ];
			var rowD = table.rows[idx];
			
			rowU.parentNode.insertBefore(rowD, rowU);
			
			rowU[LEAP.attachment.n].orderid = rowU.rowIndex;
			rowU[LEAP.attachment.n].updateType = 1;
			
			rowD[LEAP.attachment.n].orderid = rowD.rowIndex;
			rowD[LEAP.attachment.n].updateType = 1;
			
			element.__selectedRow = idx - 1;
		}
		
		LEAP.attachment.setMoveButton(element);
	}
	finally
	{
		idx = table = rowU = rowD = null;
	}	
}*/

LEAP.attachment.preview = function(src)
{
	try
	{	
		var element = LEAP._match(src, LEAP.attachment.d);
		var row = LEAP._match(src, LEAP.attachment.ctf.attrow, 'ctf');
		var att = row[LEAP.attachment.n];
		
		var atts = LEAP.attachment._getValue(element);
		var _previewIdx = 0;
		var ret = [];
		for(var i=0; i<atts.length; i++)
		{
			var _tmp = atts[i];			
			var n = _tmp.name.toLowerCase();
			if (n.endWith('.jpg') || n.endWith('.jpeg') || n.endWith('.png') || n.endWith('.gif'))
				ret.add(_tmp);
				
			if (_tmp.name == att.name)
				_previewIdx = i;
		}
		
		LEAP.imgview._preview(null, ret, _previewIdx);
	
	}
	finally
	{
		element = row = att = atts = _previewIdx = ret = i = _tmp = n = null;
	}
}

LEAP.attachment.getValue = function(element)
{
	try
	{
		if (!element)
			return null;
		
		var ret = LEAP.attachment._getValue(element);
		if (ret == null)
		{
			return null;
		}
		else
		{
			return JSON.stringify(ret);
		}
	}
	finally
	{
		ret = null;
	}
}

LEAP.attachment._getValue = function(element)
{
	try
	{
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachment.ctf.attrow + "]", element);
		if (rows == null)
			return null;
		
		var ret = []; 
		for(var i=0; i<rows.length; i++)
		{
			var _rt = rows[i].getAttribute("rt")
			var _d = rows[i][LEAP.attachment.n];
			
			if (_rt && _rt == "fixrow")
			{
				if (_d.namedpath != null || _d.exstatus != null)
					ret.add(_d);
			}
			else
			{
				ret.add(_d);	
			}
		}
		
		if (ret.length == 0)
			ret = null;
					
		return ret;
	}
	finally
	{
		rows = ret = i = _rt = _d = null;
	}
}

LEAP.attachment.setValue = function(element, value)
{
	try
	{
		if (value == null)
			return;
		
		var _value = value;
		if (typeof(value) == 'string' && value.Trim() != "")
		{
			try
			{
				_value = eval("(" + value + ")");
			}
			catch(err)
			{
				_value = null;
			}
		}
		
		if (_value == null || _value.length==0)
			return;
			
		LEAP.attachment.__i(element);
		
		for(var i=0; i<_value.length; i++)
		{
			var att = _value[i];
			if (element['hideZW'] == true && att.atttype<0) //隐藏正文时
				continue;
			else
				LEAP.attachment.insert(element, att, null, false);
		}
	}
	finally
	{
		_value = i = null;
	}
}

LEAP.attachment.getPageValue = function(instance, formElement)
{
	try
	{
		var element = LEAP.getElement("div[ct=" + LEAP.attachment.d + "][instance=" + instance + "]", formElement);
		if (element == null)
			return null;
		
		var value = LEAP.attachment._getChange(element);
		
		return value;
	}
	finally
	{
		element = value = null;	
	}	
}

LEAP.attachment.setPageValue = function(instance, formElement, value)
{
	try
	{
		if (value == null)
			return;
		var element = LEAP.getElement("div[ct=" + LEAP.attachment.d + "][instance=" + instance + "]", formElement);
		if (element == null)
			return null;
			
		LEAP.attachment.__i(element);
		
		LEAP.attachment.setValue(element, value);
	}
	finally
	{
		element = null;
	}
}

LEAP.attachment.validate = function(element, checkItems)
{
	try
	{
		if (checkItems == null || checkItems == "")
			return true;

		var h = new hashtable();
		var _fixitems = element['_fixitems'];
		if (_fixitems != null)
		{
			for(var k=0; k<_fixitems.length; k++)
				h.add(_fixitems[k].code, _fixitems[k].name);
		}
		else
		{
			return true;
		}
		
		var _v = LEAP.attachment._getValue(element);
		if (checkItems == null || checkItems =="" )
		{
			if (_v == null)
			{
				for(var _key in h.keys)
					break;
				var _err = h.getvalue(_key);				
				if (_err == null)
					_err = "必须上传附件！";
				else
					_err = '必须上传附件:' + _err + "！";
					
				alert(_err);
				return false;
			}
		}
		else
		{
			var _items = checkItems.split(',');
			var b = true;
			for(var i=0; i<_items.length; i++)
			{
				var _code = _items[i];
				
				if (_code == "")
					continue;
				
				var flag = false;			
				if (_v != null)
				{
					for(var k=0; k<_v.length; k++ )
					{
						if (_v[k].fixitemcode != null && _v[k].fixitemcode.toLowerCase() == _code.toLowerCase())
						{
							flag = true;
							break;
						}
					}
				}
				
				if (flag == false)
				{
					b = false;
					var _err = h.getvalue(_code);				
					if (_err == null)
						_err = "必须上传附件！";
					else
						_err = '必须上传附件:' + _err + "！";
						
					alert(_err);
					
					break;
				}
			}
			
			return b;
		}
	}
	finally
	{
		_v = _items = b = i = _code = flag = k = _fixitems = _key = _err = h = null;
	}	
}

LEAP.attachment._getChange = function(element)
{
	try
	{
		var ret = [];
		
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachment.ctf.attrow + "]", element);
		if (rows != null)
		{ 
			for(var i=0; i<rows.length; i++)
			{
				var att = rows[i][LEAP.attachment.n];
				if (att.updateType != null)
					ret.add(att);
			}
		}
		
		var _deleted = element['deleted'];
		if (_deleted != null && _deleted.length>0)
		{
			for(var i=0; i<_deleted.length; i++)
				ret.add(_deleted[i]);
		}
		
		if (ret.length == 0)
			return null;
		else
			return ret;
	}
	finally
	{
		ret = rows = att = _deleted = i = null;
	}	
}

LEAP.attachment._open = function(row)
{	
	try
	{
		var att = row[LEAP.attachment.n];
		if (att.atttype == LEAP.attachment.symbol.FJ)
		{
			var s = att.name.toLowerCase();
			if (s.endWith('.doc') || s.endWith('.docx') || s.endWith('.wps') || s.endWith('.xls') || s.endWith('.xlsx'))
			{
				LEAP.attachment._openZW(row);
			}
			else if (s.endWith('.pdf'))
			{
				LEAP.attachment._openPDF(row);
			}
			else if (s.endWith('.ceb') || s.endWith('.cebx'))
			{
				LEAP.attachment._openCEB(row);
			}
			else
			{
				LEAP.attachment._down(row, true);
			}
		}
		else if (att.atttype == LEAP.attachment.symbol.PDFZW)
		{
			LEAP.attachment._openPDF(row);
		}
		else if (att.atttype == LEAP.attachment.symbol.SM || att.atttype == LEAP.attachment.symbol.scan)
		{
			/*var url = LEAP.attachment._getPath(att);
			var element = LEAP._match(row, LEAP.attachment.d);
			var p = {element:row, tct:'attachment', url:url, uri:att, readonly:!att.canEdit};
			
			p.quality = element.getAttribute('scan_quality');
			p.maxwidth = element.getAttribute('scan_maxwidth');
			p.maxheight = element.getAttribute('scan_maxheight');
			p.uploadpath = element.getAttribute('uploadpath');

			var __scanner = LEAP.getElement('a[ct=capture]');
			LEAP.capture.ScanRead(__scanner, p, row);*/
			LEAP.attachment.ScanRead(row);
		}
		else if (att.name.toLowerCase().endWith('.ceb') || att.name.toLowerCase().endWith('.cebx'))
		{
			LEAP.attachment._openCEB(row);
		}
		else if (att.atttype <0 || att.name.toLowerCase().endWith('.doc') || att.name.toLowerCase().endWith('.docx') || att.name.toLowerCase().endWith('.wps') || att.name.toLowerCase().endWith('.ceb'))
		{	
			LEAP.attachment._openZW(row);
		}
		else
		{
			LEAP.attachment._down(row, true);
		}
		
	}
	catch(e)
	{
	}
	finally
	{
		att = s = null; //__telement = 
	}	
}

LEAP.attachment._openZW = function(row)
{	
	try
	{		
		var att = row[LEAP.attachment.n];
		if (att.name.toLowerCase().endWith('.doc') || att.name.toLowerCase().endWith('.docx') || att.name.toLowerCase().endWith('.wps'))
		{
			var element = LEAP._match(row, LEAP.attachment.d);	
			
			var url = LEAP.attachment._getPath(att, element);
			var arg = {url:url, name:att.name, uuid:att.uuid, nameedPath:att.namedpath, username:LEAP.getUserInfo().fullName,readonly:!att.canEdit,title:att.title};
			arg.attid = att.id;
			arg.attentryid = att.entryid;
						
					
			
			arg.attbusinessid = element.getAttribute('wfbusinessid');
			if (element['__currentstep'] != null)
				arg.attcategory = element['__currentstep'].hsid;			
			
			var curstep = element['currentstep']; 
			if (att.atttype == LEAP.attachment.symbol.zw && curstep && curstep == 1)
				arg.readonly = false; //如果是正文，则交给正文按钮权限控制
						
			var btns = element['wordButton'];			
			var businessNo = element['businessNo'];

			if (btns != null && att.atttype == LEAP.attachment.symbol.zw)
				arg.wordButton = btns;
			else
				arg.wordButton = null;			
			
			var tmpValues = element['templateValues'];
			if (tmpValues == null)
			{				
				if (element['WordtemplateFn'])
					tmpValues = element['WordtemplateFn'].call(this);
			}
			if (tmpValues != null)
				arg.templateValues = tmpValues;
			
			var forceclose = element.getAttribute('forceclose');
			if(forceclose != null)
				arg.forceclose = forceclose;
			else
				arg.forceclose = false;
							
			arg.businessNo = businessNo;
			arg._hasPDFZW = LEAP.attachment._hasPDFZW(element);
			
			
			arg._office_download_url = LWFP._office_download_url;
			
			
			if(arg.showModalDialog == true)
			{
				//预留参数showModalDialog方式
				var ret = window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(row)) + "LEAP/LWFP/HTML/WFRunning/WordEditor.html"),arg,"scroll:0;status:0;help:1;location:0;resizable:0;dialogWidth:"+(screen.availWidth-10)+"px;dialogHeight:"+(screen.availHeight-80)+"px");
				
				if (ret && ret.__callBackOption && ret.__callBackOption == "ZWToPDF")
				{
					LEAP.attachment._converToPDF(element, att, true);
				}
				if (ret && ret.__callBackOption && ret.__callBackOption == "ZWToPDF_Local")
				{				
					LEAP.attachment._converToPDF_Local(element, ret, true);			
				}
				
			}
			else 
			{
				arg.pwindow = window;
				arg.attachmentelement = element;
				
				window.showModelessDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(row)) + "LEAP/LWFP/HTML/WFRunning/WordEditor.html"),arg,"scroll:0;status:0;help:1;location:0;resizable:0;minimize:yes;maximize:yes;dialogWidth:"+(screen.availWidth-10)+"px;dialogHeight:"+(screen.availHeight-80)+"px");	
			}
				
		}
		else if (att.name.toLowerCase().endWith('.xls') || att.name.toLowerCase().endWith('.xlsx'))
		{
			var element = LEAP._match(row, LEAP.attachment.d);	
			
			arg = {att:att};	
			arg.curstep = element['__currentstep'];
			arg.exParam2 = {businessid:element.getAttribute('wfbusinessid')};
			
			//var ret = window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(row)) + "LEAP/LWFP/HTML/WFRunning/OfficeEditor.html"),arg,"scroll:0;status:0;help:1;resizable:1;dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px");			
			var ret = window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(row)) + "LEAP/LWFP/HTML/WFRunning/OfficeEditor.html"),arg,"scroll:0;status:0;help:1;location:0;resizable:0;dialogWidth:"+(screen.availWidth-10)+"px;dialogHeight:"+(screen.availHeight-80)+"px");			
		}
		else if (att.name.toLowerCase().endWith('.ceb') || att.name.toLowerCase().endWith('.cebx'))
		{
			LEAP.attachment._openCEB(row);								
		}
	}
	catch(e)
	{
	}
	finally
	{
		att = url = arg = element = btns = tmpValues = businessNo = ret = null;
	}	
}

LEAP.attachment._converToPDF_callback = function(arg)
{
	if (arg && arg.__callBackOption && arg.__callBackOption == "ZWToPDF_Local")
	{
		LEAP.attachment._converToPDF_Local(arg.attachmentelement, arg, true);
		
		arg = arg.attachmentelement = arg.pwindow = null;
	}
};

window.LWFPAttachmentConverToPDF_callback = LEAP.attachment._converToPDF_callback;

LEAP.attachment._hasPDFZW = function(element)
{
	var b = false;
	var arr = LEAP.attachment._getValue(element);
	if(arr)
	{
		for(var i=0; i<arr.length; i++)
		{
			if (arr[i].atttype == LEAP.attachment.symbol.PDFZW)
			{
				b = true;
				break;
			}
		}
	}
	return b;
}

LEAP.attachment._hasCEB = function(element)
{
	var b = false;
	var arr = LEAP.attachment._getValue(element);
	if(arr)
	{
		for(var i=0; i<arr.length; i++)
		{
			if (arr[i].name.toLowerCase().endWith('.ceb') || arr[i].name.toLowerCase().endWith('.cebx'))			
			{
				b = true;
				break;
			}
		}
	}
	return b;
}

LEAP.attachment._getRow = function(element,type)
{
	try
	{
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachment.ctf.attrow + "]", element);
		if (rows == null)
			return null;
		
		var ret = []; 
		for(var i=0; i<rows.length; i++)
		{
			var _rt = rows[i].getAttribute("rt")
			var _d = rows[i][LEAP.attachment.n];
			
			if (_d && _d.atttype == type)
			{
				return rows[i];
			}
		}
	}
	finally
	{
		rows = ret = i =  _d = null;
	}
}

LEAP.attachment._hasZW = function(element)
{
	var b = false;
	var arr = LEAP.attachment._getValue(element);
	if(arr)
	{
		for(var i=0; i<arr.length; i++)
		{
			if (arr[i].atttype == LEAP.attachment.symbol.zw)
			{
				b = true;
				break;
			}
		}
	}
	return b;
}

/**
 * 获取可上传的文件的类型
 * @param {} element
 * @return {}
 */
LEAP.attachment._getUploadTypes = function(element)
{
	var _hasZW = LEAP.attachment._hasZW(element);
	var _hasPDFZW = LEAP.attachment._hasPDFZW(element);
	var _hasCEB = LEAP.attachment._hasCEB(element);
	var _type = element["zhengwenType"];
	var _cv = LWFP.innerApi.Decimal2checkValue(_type, 4);
	var _ftype = "";
	var _ftypedesc = "";
	if (_cv.indexof('0001') >=0 && _hasZW == false)	
	{
		_ftype += ',doc,docx';
		_ftypedesc += "|*.doc|*.docx";
	}
	if (_cv.indexof('0010') >=0 && _hasZW == false)
	{
		_ftype += ',wps';
		_ftypedesc += "|*.wps";
	}
	if (_cv.indexof('0100,') >=0 && _hasPDFZW == false)
	{
		_ftype += ',pdf';
		_ftypedesc += "|*.pdf";
	}	
	if (_cv.indexof('1000') >=0 && _hasCEB == false)	
	{
		_ftype += ',ceb,cebx';
		_ftypedesc += "|*.ceb|*.cebx";
	}
	
	if (!_type)
	{
		_ftype = ',doc,docx';
		_ftypedesc = "|*.doc|*.docx";
	}
		
	_ftype = _ftype.substring(1);
	_ftypedesc = _ftypedesc.substring(1);
			
	return [_ftype,_ftypedesc];
}

LEAP.attachment._converToPDF = function(element, att, showResult)
{
	try
	{
		var b = LEAP.attachment._hasPDFZW(element);
				
		var url = LEAP.attachment._getPath(att, element);
		var _zwinfo = {name:att.name, uuid:att.uuid, title:att.title, namedPath:att.namedpath, title:att.title};
					//username:LEAP.getUserInfo().fullName, userflag:LEAP.getUserInfo().userflag, __localZWFile:localFile, __option:'ZWToPDF'};
		var cs = element['__currentstep'];
		if (cs)
		{
			_zwinfo.csid = cs.csid;
			_zwinfo.entryid = cs.entryid;
		}
		
		var module = LWFP.innerApi.getmodule(element);
		
		var ret = module.request2({name:'WFOffice_convertWordZW2PDF', par:{zwinfo:_zwinfo}}	);
		
		if (ret)
		{	
			if (b == false)
			{	
				ret.canEdit = true;
				ret.canDelete = true;
				if (ret.id == null)
					ret.updateType = 0;
				LEAP.attachment._insert(element, ret, LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", element), false, false)
			}
			
			if (showResult == true)
			{
				var url = LEAP.attachment._getPath(ret, element);
				var arg = {url:url, name:ret.name, uuid:ret.uuid, nameedPath:ret.namedpath, username:LEAP.getUserInfo().fullName,readonly:!ret.canEdit};
				window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/WFRunning/PdfEditor.html"),arg,"scroll:0;status:0;help:1;location:0;resizable:0;dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px");
			}
		}
		else
		{
			alert("正文转换为PDF格式失败！");	
		}
		
			
	}
	finally
	{
		url = arg = cs = ret = null;
	}
}

LEAP.attachment._converToPDF_Local = function(element, att, showResult)
{
	var b = LEAP.attachment._hasPDFZW(element);
	if(b == true)
	{
		var row = LEAP.attachment._getRow(element,LEAP.attachment.symbol.PDFZW);
		LEAP.attachment._del(element,row,true);
	}
	
	var _att={};
		_att.atttype = LEAP.attachment.symbol.PDFZW;
		_att.fileid = att.fileid;
		_att.title = att.title; 
		_att.attsize = att.attsize; 
		_att.name = encodeURIComponent(att.name);									
		_att.namedpath = att.namedpath;
		_att.updateType = 0;
		_att.ownername = LEAP.getUserInfo().fullName;					
		_att.uploadtime = {time:att.uploadtime};
		_att.canDelete = true;
		_att.canEdit = true;
	
	LEAP.attachment.insert(element, _att, null, false);
	
	if (showResult == true)
	{
		var url = LEAP.attachment._getPath(_att, element);
		var arg = {url:url, name:_att.name, uuid:_att.uuid, nameedPath:_att.namedpath, username:LEAP.getUserInfo().fullName,readonly:!_att.canEdit};
		window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/WFRunning/PdfEditor.html"),arg,"scroll:0;status:0;help:1;location:0;resizable:0;dialogWidth:"+(screen.availWidth-10)+"px;dialogHeight:"+(screen.availHeight-80)+"px");
	}
}

LEAP.attachment._openPDF = function(row)
{
	try
	{		
		var att = row[LEAP.attachment.n];
		var element = LEAP._match(row, LEAP.attachment.d);	
		var url = LEAP.attachment._getPath(att, element);
		var arg = {url:url, name:att.name, uuid:att.uuid, nameedPath:att.namedpath, username:LEAP.getUserInfo().fullName,readonly:!att.canEdit, title:att.title};
		
		window.showModelessDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(row)) + "LEAP/LWFP/HTML/WFRunning/PdfEditor.html"),arg,"scroll:0;status:0;help:1;location:0;resizable:0;minimize:yes;maximize:yes;dialogWidth:"+(screen.availWidth-10)+"px;dialogHeight:"+(screen.availHeight-80)+"px");
	}
	catch(e)
	{
	}
	finally
	{
		att = url = arg = ret = null;
	}	
	
}

LEAP.attachment._openCEB = function(row)
{	
	try
	{	
		var att = row[LEAP.attachment.n];
		var element = LEAP._match(row, LEAP.attachment.d);
		var url = LEAP.attachment._getPath(att, element);
		var objSealStampCom;
		try
		{
			objSealStampCom = new ActiveXObject("SealStampComSvr.SealStampCom");
		}
		catch(e)
		{
			//alert("初始化CEB插件失败，请检查插件是否正确安装！");			
			LEAP.attachment._down(row);
			
			return;
		}
		
		if (objSealStampCom)
		{
			objSealStampCom.PreviewCEB(url, 0, "408e15ca-86a9-4525-acd9-69584316d5fd");	
		}
	}
	finally
	{
		att = objSealStampCom = url = null;
	}
}		

LEAP.attachment._wordEditUpload = function(src)
{
	try
	{
		var element = LEAP._match(src, LEAP.attachment.d);
		if(null == element) return;
		
		var row = null;		
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachment.ctf.attrow + "]", element);
		if (rows != null)
		{		 
			for(var i=0; i<rows.length; i++)
			{				
				var _d = rows[i][LEAP.attachment.n];					
				if (_d && _d.namedpath && _d.atttype && _d.atttype == LEAP.attachment.symbol.zw)
				{
					row = rows[i];
					break;
				}				
			}
		}
		
		if (row != null)
		{
			LEAP.attachment._open(row);
		}
		else
		{		
			var btns = element['wordButton'];
			var businessNo = element['businessNo'];
			var uploadpath = element.getAttribute("uploadpath");
					
			var uuid = UUID.randomUUID().replaceall('-', '');
			var arg = {isnew:1, uploadpath: uploadpath, viewname:'new.doc', username:LEAP.getUserInfo().fullName, readonly:false, forceclose:false};
			
			if (btns != null)
				arg.wordButton = btns;
				
			var tmpValues = element['templateValues'];
			if (tmpValues == null)
			{
				if (element['WordtemplateFn'])
					tmpValues = element['WordtemplateFn'].call(this);
			}
			if (tmpValues != null)
				arg.templateValues = tmpValues;
				
			if (element['WordtemplateFn'])
				arg.templateValues = element['WordtemplateFn'].call(this);
			arg.businessNo = businessNo;
			
			arg._office_download_url = LWFP._office_download_url;
			var rst = window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/WFRunning/WordEditor.html"),arg,"scroll:0;status:0;help:1;location:0;resizable:0;dialogWidth:"+(screen.availWidth-10)+"px;dialogHeight:"+(screen.availHeight-80)+"px");			
			
			if (rst != null && rst.physicFileName != null)
			{
				var _att={};
					_att.atttype = LEAP.attachment.symbol.zw;
					_att.title = "新建正文"; 
					_att.name = rst.name;
					_att.namedpath = rst.namedpath;
					_att.updateType = 0;
					_att.ownername = LEAP.getUserInfo().fullName;				
					_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
					_att.canDelete = true;
					_att.canEdit = true;
		
				LEAP.attachment.insert(element, _att, null, false);	
			}
			
		}
	}
	catch(e)
	{		
	}
	finally
	{
		element = row = rows = i = _d = btns = tmpValues = businessNo = uploadpath = uuid = arg = rst = _att = null;
	}
}

LEAP.attachment._down = function(row, isopen)
{
	try
	{
		var att = row[LEAP.attachment.n];
			
		if (att && att.namedpath)
		{
			att.nameedPath = att.namedpath; 
			var p = null;
			if (att.entryid != null)
			{
				var t = att.title; 
				if (t.length > 50)
					t = t.substring(0, 50) + "...";
				p = "entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id + "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
			}
			if (isopen == true)
				LEAP.upload.download(att, true, true, p, LEAP.wfrouter.getRouter(row));
			else				
				LEAP.upload.download(att, true, false, p, LEAP.wfrouter.getRouter(row));
		}
		
		var e = LEAP._match(row, LEAP.attachment.d);
		
		ElementEventManager.handleEvent(e, "onAttachmentDownload", att);
	}
	finally
	{
		att = e = null;
	}
}

LEAP.attachment.ForceDelete = function(element, name)
{
	try
	{
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachment.ctf.attrow + "]", element);
		if (rows != null)
		{ 
			for(var i=0; i<rows.length; i++)
			{
				var row = rows[i];
				var att = row[LEAP.attachment.n];
				if (att.name == name)
				{
					LEAP.attachment._del(element, row, true);
				}
			}
		}
	}
	finally
	{
		rows = row = att = null;
	}
}

LEAP.attachment._del = function(element, row, noconfirm)
{
	if(!noconfirm)
	{
		if (!window.confirm('确定执行删除操作？'))
			return;
	}

	try
	{
		var _att = row[LEAP.attachment.n];
		var _rt = row.getAttribute('rt');
		if (_att.updateType != 0)
			_att.updateType = 2;
			
		if (_att.updateType == 2)
		{		
			var _deleted = element['deleted'];
			if (!_deleted)
				_deleted = [];
			
			_deleted.add(_att);
			
			element['deleted'] = _deleted;
		}
		
		if (_rt == "fixrow")
		{
			var _d = {};
				_d.fixitemcode = _att.fixitemcode;
				_d.fixitemname = _att.fixitemname;
				_d.fixitemmulti = _att.fixitemmulti;
				_d.defaultcolor = _att.defaultcolor;
				_d.uploadcolor = _att.uploadcolor;
				_d.types = _att.types;
				_d.typesdesc = _att.typesdesc;
				_d.isFixItem = _att.isFixItem;
				
			row[LEAP.attachment.n] = _d;

			var _a = LEAP.getElement('a[ctf=' + LEAP.attachment.ctf._down + ']', row);
			if (!_a)
				_a = LEAP.getElement('a[ctf=' + LEAP.attachment.ctf.open + ']', row);
				_a.href = 'javascript:void(0)'; 	
				_a.setAttribute("ctf", LEAP.attachment.ctf._down);
				_a.title = _a.innerText;
				_a.style.cursor = 'default';
				_a.style.color = _att.defaultcolor;//"#000000";	
				_a.innerText = _att.fixitemname;
			
			row.cells[1].innerHTML = "";
			
			var _div = document.createElement("div");			
			row.cells[1].appendChild(_div);
			
			var str = "<div pp='att' tct='attachment' ct='uploadbtn'";
			if (_d.types)
				str += " types='" + _d.types + "'";
			if (_d.typesdesc)
				str += " typesdesc='" + _d.typesdesc + "'";	
			str += "showtext='上传' userpar='0' style='float:left; width:20px;height:21px;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";	
			_div.innerHTML = str;			
			//_div.innerHTML = "<div pp='att' tct='attachment' ct='uploadbtn' showtext='上传' userpar='0' style='float:left; width:20px;height:21px;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";
			
			LEAP.attachment._loadExbtutton(element, _div);
		}
		else
		{			
			row.parentNode.deleteRow(row.rowIndex);
		}
		
		if (_att.atttype == LEAP.attachment.symbol.zw || _att.atttype == LEAP.attachment.symbol.PDFZW)
		{
			var _wordbtn = LEAP.getElement("div[ctf=" + LEAP.attachment.ctf.wordbtn + "]", element);	
			if (_wordbtn)
			{
				if (LEAP.uploadbtn.setVisible)
					LEAP.uploadbtn.setVisible(_wordbtn, true);
					
				LEAP.uploadbtn.setReadonly(_wordbtn, false);
				var type = LEAP.attachment._getUploadTypes(element);
				var _ftype = type[0];
				var _ftypedesc = type[1];
				
				if(_ftype)
				{
					LEAP.uploadbtn.setUploadAttr(_wordbtn,"types",_ftype);
					LEAP.uploadbtn.setUploadAttr(_wordbtn,"typesdesc",_ftypedesc);
					
					if (LEAP.fileupload && LEAP.fileupload.setAccept)
						LEAP.fileupload.setAccept(_wordbtn, _ftype);
				}
			}
			
		}
						
		LEAP.attachment._autoSize(element);
	}
	finally
	{
		_att = _rt = _deleted = _wordbtn = _d = _a = _div = null;
	}
}

LEAP.attachment._update = function(row)
{	
	try
	{
		var _formElement = null;
		var _txt = null;
		var _btn = null;
		if (LEAP.attachment.udpform == null)
		{
			LEAP.attachment.udpform = LEAP.form.create(null, '修改文件名', 500, 150, null, null);
			LEAP.form.setContent(LEAP.attachment.udpform.form, "<div style='padding:10px'>文件名修改为：<input ut='filename' class='lginfoct' ht='input' bt='text' check='maxlen:100' style='border:1px solid #666; width:95%; margin-left:20px;marginright:1px;'/><br><a class='lgbtn' href='javascript:' ut='submit' ht='button' style='float: right'>确定</a></div>");
			_formElement = LEAP.getElement(LEAP.attachment.udpform.form);
			LEAP.attachment.udpform._txt = LEAP.getElement("input[ut=filename]", _formElement);
			_btn = LEAP.getElement("a[ut=submit]", _formElement);
			LEAP.addEvent(_btn, 'click', LEAP.attachment.__update);
		}		
		
		var att = row[LEAP.attachment.n];
		LEAP.attachment.udpform.FileName = att.title;
		LEAP.attachment.udpform._txt.value = att.title;
		LEAP.attachment.udpform._attRow = row;
		
		LEAP.form.show(LEAP.attachment.udpform.form);	
	}
	finally
	{
		_formElement = _txt = _btn = att = null;		
	}
}

LEAP.attachment.__update = function(arg)
{
	try
	{
		var _title = LEAP.attachment.udpform._txt.value.trim();
		if (_title == '')
		{
			alert('文件名不可为空！');
			return;
		}
		if ((_title.indexof('\\')>=0) || 
			(_title.indexof('/')>=0) ||
			(_title.indexof(':')>=0) ||
			(_title.indexof('*')>=0) ||
			(_title.indexof('?')>=0) ||
			(_title.indexof('"')>=0) ||
			(_title.indexof('<')>=0) ||
			(_title.indexof('>')>=0) ||
			(_title.indexof('|')>=0) )			
		{
			alert('文件名不可包含如下字符： \\ / : * ? " < > |');
			return;
		}
		
		var _row = LEAP.attachment.udpform._attRow;
		var _att = _row[LEAP.attachment.n];
		if (LEAP.warpChangedLog)
			LEAP.warpChangedLog(_att);
		_att.title = _title;

		if (_att.updateType == null)
			_att.updateType = 1;
		
		_row[LEAP.attachment.n] = _att;
		
		_row.cells[0].childNodes[0].innerText = _title;
				
		if (_att.atttype == LEAP.attachment.symbol.PDFZW)
		{
			_row.cells[0].childNodes[0].innerHTML = '<font ctf="' + LEAP.attachment.ctf.open + '" color=red>【PDF正文】</font>' + _title;
		}
		else if (_att.atttype == LEAP.attachment.symbol.OFDZW)
		{
			_row.cells[0].childNodes[0].innerHTML = '<font ctf="' + LEAP.attachment.ctf.open + '" color=red>【OFD正文】</font>' + _title;
		}
		else if (_att.atttype == LEAP.attachment.symbol.SM)
		{	
			if (_att.title.endWith('.zip'))
				_row.cells[0].childNodes[0].innerText = _att.title.substring(0,_att.title.length-4);			
		}
		else if (_att.atttype <0)
		{
			_row.cells[0].childNodes[0].innerHTML = '<font ctf="' + LEAP.attachment.ctf.open + '" color=red>【正文】</font>' + _title;
		}
		
		LEAP.form.hide(LEAP.attachment.udpform.form);
	}
	finally
	{
		_title = _row = _att = null;
	}	
}

LEAP.attachment._getPath = function(_att, element)
{
	var module = LWFP.innerApi.getmodule(element);
	
	var url = null;

		url = LEAP.upload.getPath(_att.namedpath, _att.name, _att.uuid, null, null, null, null, _att.fileid, ((module.leapclient == null) ? null : module.leapclient.router));
		
		
	if (_att.entryid != null && _att.id != null)
	{
		var p = "entryid=" + _att.entryid + "&wflog=1&terminal=0&id=" + _att.id;
		if (_att.title != null && _att.name != null)
		{
			var t = _att.title; 
			if (t.length > 50)
				t = t.substring(0, 50) + "...";
			p += "&remark=" + encodeURIComponent(encodeURIComponent(t + _att.name.substring(_att.name.lastIndexOf("."))));
		}
		
		if (url.indexOf('?') == -1)	
			url += "?" + p;
		else
			url += "&" + p;
	}
			
	return url;
}

LEAP.attachment.setReadonly = function(element, readonly, reload)
{
	element = LEAP._match(element, LEAP.attachment.d);
	if(null == element) return;
	
	element.setAttribute('readonly', readonly);
	
	if (reload == true)
			LEAP.attachment.__i(element);
	
}

/**
 * 
 * @param {} instance
 * @param {} formElement
 * @param {} wordButton 正文按钮
 * @param {} templateValues模板值
 * @param {} businessNo事项编号
 * @param {} isCurrentstep是否当前环节
 * @param {} attType正文类型
 * @return {}
 */
LEAP.attachment.setWordParams = function(instance, formElement, wordButton, templateValues, businessNo,
									isCurrentstep, attType, curstep, hideZW)
{	
	try
	{		
		var element = LEAP.getElement("div[ct=" + LEAP.attachment.d + "][instance=" + instance + "]", formElement);
		if (element == null)
			return null;
			
		if (wordButton != null)
			element['wordButton'] = wordButton;
		if (templateValues != null)
			element['templateValues'] = templateValues;		
		if (isCurrentstep)
			element['currentstep'] = isCurrentstep;		
		if (businessNo)
			element['businessNo'] = businessNo;
		if (attType)
			element['zhengwenType'] = attType;
		if (curstep)
			element['__currentstep'] = curstep;
		if (hideZW)
			element['hideZW'] = hideZW;
			
		LEAP.attachment.__i(element);
	}
	finally
	{
		element = null;
	}
}

/**
 * 
 * @param {} element
 * @param {} _att
 * @param {} src
 * @param {} isInitFixItemExStatus //默认初始化固定项选中状态
 */
LEAP.attachment.insert = function(element, _att, src, isInitFixItemExStatus)
{
	try
	{
		var _isFix = (element['_fixitems'])?true:false; //是否固定项
			
		var _readonly = element.getAttribute('readonly'); //是否只读
		if (_readonly && _readonly=='1') 
			_readonly = true; 
		else 
			_readonly = false;

		var _table = LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", element);
		
		if (_att.isFixItem == true)
			_att.title = _att.fixitemname;			
		
		var _isFixItemDetail = false;		
		if (_att.fixitemcode != null && _att.fixitemcode != "" && (_att.namedpath != null || _att.exstatus != null) )
			_isFixItemDetail = true;
		if (isInitFixItemExStatus == true)
			_isFixItemDetail = false;
		
		if (src)
		{
			var _src_row = LEAP._match(src, LEAP.attachment.ctf.attrow, 'ctf', 5);
			if (_src_row)
			{
				var _d = _src_row[LEAP.attachment.n];
				if (_d.fixitemcode != null)
				{
					_isFixItemDetail = true;
					
					_att.fixitemcode = _d.fixitemcode;
				}
			}
		}
		
		if (_isFixItemDetail == true)
		{
			LEAP.attachment._bindItemDetail(element, _att, _table, _readonly);
		}
		else
		{
			LEAP.attachment._insert(element, _att, _table, _readonly, _isFix);
			if (isInitFixItemExStatus == true && _att.exstatus != null) //默认初始化固定项选中状态, 绑定后需要插值
			{
				_att.updateType = 0;
				LEAP.attachment._bindItemDetail(element, _att, _table, _readonly);
			}
		}
		
		LEAP.attachment._autoSize(element);
	}
	finally
	{
		_isFix =  _readonly = _table = _isFixItemDetail = _src_row = _d = null;
	}
}

LEAP.attachment._bindItemDetail = function(element, _att, _table, _readonly)
{
	try
	{
		var _itemRow;
		var _d;
		for(var i=0; i<_table.rows.length; i++)
		{
			var __d = _table.rows[i][LEAP.attachment.n];
			if (__d && __d.fixitemcode == _att.fixitemcode)
			{
				_itemRow = _table.rows[i];
				_d = __d;
				
				_att.fixitemcode = _d.fixitemcode;
				_att.fixitemname = _d.fixitemname;
				_att.fixitemmulti = _d.fixitemmulti;
				_att.defaultcolor = _d.defaultcolor;
				_att.uploadcolor = _d.uploadcolor;
				_att.types = _d.types;
				_att.typesdesc = _d.typesdesc;
				_att.isFixItem = _d.isFixItem;	
				
				break;
			}
		}
		if (!_itemRow || !_d)
			return;
		
		if (_d.fixitemmulti)  //在固定行下缩进
		{
			var _idx;
			for(var i=_itemRow.rowIndex + 1; i<_table.rows.length; i++)
			{
				var __d = _table.rows[i][LEAP.attachment.n];
				if (__d.fixitemcode != _d.fixitemcode)
				{
					_idx = i;
					break;
				}
			}
			
			if (_idx == null)
				_idx = _table.rows.length;
		
			var _text = _att.title;			
			var _rt = "normalrow"; //
			var _href = LEAP.attachment._getPath(_att, element);
			
			var _title = _att.title
			if (_att.ownername != null && _att.uploadtime != null)			
				_title = _title + '【' + _att.ownername + ' ' + LEAP.formatdate(_att.uploadtime.time, 0) + '】';
			
			var _ctf = LEAP.attachment.ctf._down;
			if (_att.atttype != null)
			{
				if (_att.atttype == LEAP.attachment.symbol.zw)
				{					
					_href = 'javascript:void(0)';					 
					_ctf = LEAP.attachment.ctf.open;
				}
				else if (_att.atttype == LEAP.attachment.symbol.SM)
				{
					_href = 'javascript:void(0)';					
					_ctf = LEAP.attachment.ctf.open;
				}				
			}
					
			var _tr = _table.insertRow(_idx);
			_tr[LEAP.attachment.n] = _att;
			_tr.setAttribute('ctf', LEAP.attachment.ctf.attrow);
			_tr.setAttribute('rt', _rt);
			_tr.title = _title;

			var _td1 = _tr.insertCell(-1);
				_td1.style.borderTop = 'none';
			var _a11 = document.createElement("a");			
				_a11.className = 'wfcontrol_attachment_file_indent';
				_a11.href = 'javascript:void(0)';
				_a11.setAttribute('ctf', _ctf);
				_a11.innerText = _text
				_a11.style.color = (_att.uploadcolor==null)?'#1E50D2':_att.uploadcolor;
			_td1.appendChild(_a11);
				
			var _td3 = _tr.insertCell(-1);		
				_td3.style.borderTop = 'none';
				_td3.style.height = 26 + "px";
			var _a31 = document.createElement("a");
				_a31.className = 'wfcontrol_attachment_download';
				_a31.href = 'javascript:void(0)';
				_a31.title = '下载文件';				
				if (LEAPBrowser.isChrome == true)
					_a31.innerHTML = "&nbsp;&nbsp;&nbsp;";
				else
					_a31.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";				
				_a31.setAttribute('ctf', LEAP.attachment.ctf.down);
				if (_att.atttype == LEAP.attachment.symbol.SM)
					_a31.setAttribute('ctf', LEAP.attachment.ctf.open);
			_td3.appendChild(_a31);
			
			if (!_readonly && (_att.canDelete == null || (_att.canDelete && _att.canDelete == true)) )
			{
				var _a32 = document.createElement("a");		
					_a32.className = 'wfcontrol_attachment_edit';
					_a32.href = 'javascript:void(0)';
					_a32.title = '修改文件名';
					if (LEAPBrowser.isChrome == true)
						_a32.innerHTML = "&nbsp;&nbsp;&nbsp;";
					else
						_a32.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";					
					_a32.setAttribute('ctf', LEAP.attachment.ctf.update);
				_td3.appendChild(_a32);
				var _a33 = document.createElement("a");
					_a33.className = 'wfcontrol_attachment_delete';
					_a33.href = 'javascript:void(0)';
					_a33.title = '删除文件';
					if (LEAPBrowser.isChrome == true)
						_a33.innerHTML = "&nbsp;&nbsp;&nbsp;";
					else
						_a33.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
					_a33.setAttribute('ctf', LEAP.attachment.ctf.del);
				_td3.appendChild(_a33);
			}
			
			if (_readonly || _att.canDelete == false)
				_itemRow.cells[1].innerHTML = "";
			
		}
		else
		{	
			_itemRow[LEAP.attachment.n] = _att;
			var _a = LEAP.getElement('a[ctf=' + LEAP.attachment.ctf._down + ']', _itemRow);
				_a.className = 'wfcontrol_attachment_file_normal_blue';				
				_a.href = 'javascript:void(0)';
				_a.setAttribute('ctf', LEAP.attachment.ctf._down);
				if (_att.atttype == LEAP.attachment.symbol.SM)
				{
					_a.setAttribute("ct", "capture");
					_a.setAttribute("cap_type", "3");
					_a.setAttribute('ctf', LEAP.attachment.ctf.open);
				}
				else if (_att.atttype == LEAP.attachment.symbol.FJ &&  _att.canEdit == true 
							&& (_att.name.toLowerCase().endWith('.pdf') || _att.name.toLowerCase().endWith('.doc') 
									|| _att.name.toLowerCase().endWith('.docx') )
						)
				{
					_a.setAttribute('ctf', LEAP.attachment.ctf.open);
				}
				
				if (_att.atttype == 4)
				{
					_a.innerText = _att.fixitemname + "【" + _att.title + "】";
				}
				
				_a.title = _a.innerText;
				_a.style.color = (_att.uploadcolor==null)?'#1E50D2':_att.uploadcolor;
				_a.style.cursor = 'hand';				
				
			var _cell = _itemRow.cells[1];
				_cell.innerHTML = "";
				_cell.style.height = 26 + "px";
				
			if (_att.atttype != 4)
			{
				var _a31 = document.createElement("a");
					_a31.className = 'wfcontrol_attachment_download';
					_a31.href = 'javascript:void(0)';					
					_a31.title = '下载文件';
					if (LEAPBrowser.isChrome == true)
						_a31.innerHTML = "&nbsp;&nbsp;&nbsp;";
					else
						_a31.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";					
					_a31.setAttribute('ctf', LEAP.attachment.ctf.down);
					if (_att.atttype == LEAP.attachment.symbol.SM)
					{
						_a31.setAttribute("ct", "capture");
						_a31.setAttribute("cap_type", "3");
						_a31.setAttribute('ctf', LEAP.attachment.ctf.open);
					}
				_cell.appendChild(_a31);
			}
			
			if (!_readonly && (_att.canDelete == null || (_att.canDelete && _att.canDelete == true)) )
			{
				var _a33 = document.createElement("a");
					_a33.className = 'wfcontrol_attachment_delete';
					_a33.href = 'javascript:void(0)';
					_a33.title = '删除文件';
					if (LEAPBrowser.isChrome == true)
						_a33.innerHTML = "&nbsp;&nbsp;&nbsp;";
					else
						_a33.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";					
					_a33.setAttribute('ctf', LEAP.attachment.ctf.del);
				_cell.appendChild(_a33);
			}
			
		}
	}
	finally
	{
		_itemRow = _d = i = _idx = __d = _text = _href = _title = _ctf = _rt = _tr = _td1 = _a11 = _td3 = _a31 = _a32 = _a33 = _a = _cell = null;
	}	
}

LEAP.attachment._insert = function(element, _att, _table, _readonly, _isFix)
{
	try
	{
		var _text = _att.title;
		var _href = LEAP.attachment._getPath(_att, element);		
		
		var _title = _att.title
		if (_att.ownername != null && _att.uploadtime != null)			
			_title = _title + '【' + _att.ownername + ' ' + LEAP.formatdate(_att.uploadtime.time, 0) + '】';
		
		var _ctf = LEAP.attachment.ctf._down;
		var _cursor = 'hand';
		var _rt = "normalrow"; //
		if (_att.atttype != null)
		{
			if (_att.atttype == LEAP.attachment.symbol.PDFZW)
			{
				_ctf = LEAP.attachment.ctf.open;
				_text = '<font  ctf="' + _ctf + '" color=red>【PDF正文】</font>' + _att.title;
				_href = 'javascript:void(0)';
			} 
			else if (_att.atttype == LEAP.attachment.symbol.OFDZW)
			{
				_ctf = LEAP.attachment.ctf.open;
				_text = '<font  ctf="' + _ctf + '" color=red>【OFD正文】</font>' + _att.title;
				_href = 'javascript:void(0)';
			} 
			else  if (_att.atttype == LEAP.attachment.symbol.SM)
			{
				if (_att.title.endWith('.zip'))
					_text = _att.title.substring(0,_att.title.length-4);
				_href = 'javascript:void(0)';				
				_ctf = LEAP.attachment.ctf.open;
			}
			else if (_att.atttype <0)
			{
				_ctf = LEAP.attachment.ctf.open;
				_text = '<font ctf="' + _ctf + '" color=red>【正文】</font>' + _att.title;
				_href = 'javascript:void(0)';	
			}
			else if (_att.name.toLowerCase().endWith('.doc') || _att.name.toLowerCase().endWith('.docx') || _att.name.toLowerCase().endWith('.wps') || _att.name.toLowerCase().endWith('.xls') || _att.name.toLowerCase().endWith('.xlsx'))
			{
				_text = _att.title;
				_href = 'javascript:void(0)';				
				_ctf = LEAP.attachment.ctf.open;
			}			
			else if (_att.name.toLowerCase().endWith('.ceb') || _att.name.toLowerCase().endWith('.cebx'))
			{	
				_href = 'javascript:void(0)';				
				_ctf = LEAP.attachment.ctf.open;
			}
			else if (_att.name.toLowerCase().endWith('.png') || _att.name.toLowerCase().endWith('.jpg') || _att.name.toLowerCase().endWith('.jpeg') || _att.name.toLowerCase().endWith('.gif'))
			{
				_href = 'javascript:void(0)';				
				_ctf = LEAP.imgview.ctf.preview;			
			}			
			
			//根据配置属性决定附件是直接打开还是下载
			var pdfopenmode = element['_pdfopenmode'];
			if(pdfopenmode && _att.name.toLowerCase().endWith('.pdf'))
			{
				if(pdfopenmode == "open")
					_ctf = LEAP.attachment.ctf.open;
				else if(pdfopenmode == "down")
					_ctf = LEAP.attachment.ctf._down;
			}
		}
		if (_att.isFixItem == true)
		{
			_href = 'javascript:void(0)';
			_ctf = LEAP.attachment.ctf._down;
			_cursor = 'default';
			_rt = "fixrow";
			
			if (_att.tip != null && _att.tip.trim() != "")
				_title = _att.tip;
		}
		
		var _tr;
		if (_att.atttype == LEAP.attachment.symbol.zw && _table.rows.length>1)
		{
			_tr = _table.insertRow(1);
		}
		else if (_att.atttype == LEAP.attachment.symbol.PDFZW)
		{
			if (_table.rows.length>1)
				_tr = _table.insertRow(2);
			else
				_tr = _table.insertRow(1);
		}
		else
		{
			_tr = _table.insertRow(-1);
		}

		_att.orderid = _tr.rowIndex;
		_tr[LEAP.attachment.n] = _att;
		_tr.setAttribute('ctf', LEAP.attachment.ctf.attrow);
		_tr.setAttribute('rt', _rt);
		_tr.setAttribute('cccrt', '_select');
		_tr.setAttribute('sssid', _att.name.replace(".",""));
		_tr.title = _title;

		var _td1 = _tr.insertCell(-1);	
			_td1.style.overflow = "hidden";
			_td1.setAttribute('ctf', '0r9r08u9');
			_td1.style.paddingRight = "5px";
		var _a11 = document.createElement("a");
			_a11.className = 'wfcontrol_attachment_file_normal';
			_a11.href = 'javascript:void(0)';
			_a11.setAttribute('ctf', _ctf);			
			_a11.innerHTML = _text;			
			_a11.style.cursor = _cursor;
			
			var _color = '#000000';
			if (_att.defaultcolor != null)
				_color = _att.defaultcolor;
			if (_att.isFixItem != true)
			{
				_color = (element.getAttribute("uploadcolor") == null) ? _color : element.getAttribute("uploadcolor");
			}
			_a11.style.color = _color;
			//_a11.style.color = (_att.defaultcolor == null)?'#000000':_att.defaultcolor;
		_td1.appendChild(_a11);
		
		
		var __td3 = _tr.insertCell(-1);
			__td3.setAttribute('ctf', '0r9r08u9w4');
		var _td3 = document.createElement("div");
			//_td3.style.width = "50px";			
		__td3.appendChild(_td3);
		
		if (_att.isFixItem != true)
		{
			if (element['_oprateStyle'] != null && element['_oprateStyle'] == 1)
			{
				var _a30 = document.createElement("a");
					_a30.className = 'wfcontrol_attachment_operate_btn';
					_a30.href = 'javascript:void(0)';
					_a30.title = '打开文件';
					_a30.innerText = "打开";				
					_a30.setAttribute('ctf', LEAP.attachment.ctf.open);
				_td3.appendChild(_a30);
				
				var _a31 = document.createElement("a");
					_a31.className = 'wfcontrol_attachment_operate_btn';
					_a31.href = 'javascript:void(0)';
					_a31.title = '下载文件';
					_a31.innerText = "下载";									
					_a31.setAttribute('ctf', LEAP.attachment.ctf.down);					
				_td3.appendChild(_a31);
				
				if (!_readonly)
				{
					var _a34 = document.createElement("a");		
						_a34.className = 'wfcontrol_attachment_operate_btn';
						_a34.href = 'javascript:void(0)';
						_a34.title = '上移';
						_a34.innerText = "上移";
						_a34.setAttribute('ctf', LEAP.attachment.ctf.btnMU2);
					_td3.appendChild(_a34);
					
					var _a35 = document.createElement("a");		
						_a35.className = 'wfcontrol_attachment_operate_btn';
						_a35.href = 'javascript:void(0)';
						_a35.title = '下移';
						_a35.innerText = "下移";
						_a35.setAttribute('ctf', LEAP.attachment.ctf.btnMD2);
					_td3.appendChild(_a35);
					
				}
				
				if (!_readonly && (_att.canEdit == null || (_att.canEdit && _att.canEdit == true)) )
				{
					var _a32 = document.createElement("a");		
						_a32.className = 'wfcontrol_attachment_operate_btn';
						_a32.href = 'javascript:void(0)';
						_a32.title = '修改文件名';
						_a32.innerText = "改名";
						_a32.setAttribute('ctf', LEAP.attachment.ctf.update);
					_td3.appendChild(_a32);			
				}
				
				if (!_readonly && (_att.canDelete == null || (_att.canDelete && _att.canDelete == true)) )
				{				
					var _a33 = document.createElement("a");
						_a33.className = 'wfcontrol_attachment_operate_btn';
						_a33.href = 'javascript:void(0)';
						_a33.title = '删除文件';
						_a33.innerText = "删除";
						_a33.setAttribute('ctf', LEAP.attachment.ctf.del);
					_td3.appendChild(_a33);
				}
			}
			else
			{			
				var _a31 = document.createElement("a");
					_a31.className = 'wfcontrol_attachment_download';
					_a31.href = 'javascript:void(0)';
					_a31.title = '下载文件';
					if (LEAPBrowser.isChrome == true)
						_a31.innerHTML = "&nbsp;&nbsp;&nbsp;";
					else
						_a31.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";				
					_a31.setAttribute('ctf', LEAP.attachment.ctf.down);
					if (_att.atttype == LEAP.attachment.symbol.SM)
						_a31.setAttribute('ctf', LEAP.attachment.ctf.open);
				_td3.appendChild(_a31);
				
				if (!_readonly && (_att.canEdit == null || (_att.canEdit && _att.canEdit == true)) )
				{
					var _a32 = document.createElement("a");		
						_a32.className = 'wfcontrol_attachment_edit';
						_a32.href = 'javascript:void(0)';
						_a32.title = '修改文件名';
						if (LEAPBrowser.isChrome == true)
							_a32.innerHTML = "&nbsp;&nbsp;&nbsp;";
						else
							_a32.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
						_a32.setAttribute('ctf', LEAP.attachment.ctf.update);
					_td3.appendChild(_a32);			
				}
				if (!_readonly && (_att.canDelete == null || (_att.canDelete && _att.canDelete == true)) )
				{				
					var _a33 = document.createElement("a");
						_a33.className = 'wfcontrol_attachment_delete';
						_a33.href = 'javascript:void(0)';
						_a33.title = '删除文件';
						if (LEAPBrowser.isChrome == true)
							_a33.innerHTML = "&nbsp;&nbsp;&nbsp;";
						else
							_a33.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";					
						_a33.setAttribute('ctf', LEAP.attachment.ctf.del);
					_td3.appendChild(_a33);
				}
			}
		}
		else if (!_readonly)
		{
			var _div = document.createElement("div")
				_div.style.styleFloat = "left";
			_td3.appendChild(_div);	
			
			var _u = document.createElement("div");
				_u.className = "wfcontrol_attachment_upload";
				_u.setAttribute("ctf", LEAP.attachment.ctf.uploadbackdiv);
				_u.style.cursor = "hand";
			_div.appendChild(_u);
			
			LEAP.addEvent(_u, 'mouseenter', LEAP.attachment.uiProcess, null, null, true);
			
			LEAP.attachment._loadExbtutton(element, _td3);			
		}
		
		if (_isFix == false && (_att.atttype == LEAP.attachment.symbol.zw || _att.atttype == LEAP.attachment.symbol.PDFZW))
		{
			var _wordbtn = LEAP.getElement("div[ctf=" + LEAP.attachment.ctf.wordbtn + "]", element);
			var type = LEAP.attachment._getUploadTypes(element);
			var _ftype = type[0];
			var _ftypedesc = type[1];
			
			if(_ftype)
			{	
				_wordbtn.style.display = "block";
				
				if (_wordbtn.getAttribute("ct") == LEAP.uploadbtn.d)
					_wordbtn.innerHTML = _wordbtn.innerHTML;
				
				LEAP.uploadbtn.setUploadAttr(_wordbtn,"types",_ftype);
				LEAP.uploadbtn.setUploadAttr(_wordbtn,"typesdesc",_ftypedesc);
				
				if (LEAP.fileupload && LEAP.fileupload.setAccept)
						LEAP.fileupload.setAccept(_wordbtn, _ftype);
			}
			else
			{
				_wordbtn.style.display = "none";
				/*if (LEAP.uploadbtn.setVisible)
					LEAP.uploadbtn.setVisible(_wordbtn, false);
				else
					LEAP.uploadbtn.setReadonly(_wordbtn, true);		*/
			}
		}	
		
		//LEAP.attachment.setMoveButton(element);
	}
	finally
	{
		_text = _href = _title = _ctf = _cursor = _rt = _tr = _td1 = _a11 = _td3 = _a31 = _a32 = _a33 = _wordbtn = _color = _div = null;
	}
}

LEAP.attachment._loadUploadFlash = function(src, row)
{
	try
	{
		var _att = row[LEAP.attachment.n];
		var str = "<div pp='att' tct='attachment' ct='uploadbtn'";
		if (_att.types)
			str += " types='" + _att.types + "'";
		if (_att.typesdesc)
			str += " typesdesc='" + _att.typesdesc + "'";	
		str += "showtext='上传' userpar='0' style='float:left; width:20px;height:21px;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";	
		src.parentNode.innerHTML = str
	}
	finally
	{
		_att = str = null;
	}
}

LEAP.attachment._loadExbtutton = function(e,td)
{
	try
	{
		var _buttons = e['_buttons'];
		if (_buttons && _buttons.indexOf("scan")>=0)
		{
			var _s = document.createElement("div");
				_s.className = "wfcontrol_attachment_scanupload";					
				/*_s.setAttribute("pp", "scan");
				_s.setAttribute("ct", "capture");
				_s.setAttribute("tct", "attachment");
				_s.setAttribute("cap_type", "2");*/				
				_s.setAttribute("title", "扫描上传");
				_s.setAttribute("ctf", LEAP.attachment.ctf.scanbtn);
				
			td.appendChild(_s);
		}
					
		var exstatus = e['exstatus'];
		if (exstatus)
		{
			if (e.offsetWidth != 0 && e.offsetWidth<300)
			{
				
				td.parentElement.style.height = "60px";
				td.style.height = "55px";
				td.style.width = "100px";
			}
			else
			{
				td.parentElement.style.height = "26px";
				td.style.height = "25px";
				td.style.width = "150px";
			}						
			
			var sv = document.createElement("div");
				sv.className = "select lginfoct";
				sv.setAttribute('ct', 'select');
				sv.setAttribute('ctf', 'exstatueselect');
				sv.style.width = "95px";
				sv.style.height = "18px";
				sv.style.border = "1px solid #c2c4c6";
				sv.style.marginTop = "auto";
				sv.style.styleFloat = "left";
			var sv1 = document.createElement("div");
				sv1.className = "lg_p_lr_right select_drop selectdropout";
				sv1.setAttribute('ctf', 'select_drop');
				sv1.style.height = "100%";
			var sv2 = document.createElement("div");
				sv2.className = "lg_p_lr_fill input_fill";
			var sv3 = document.createElement("div");
				sv3.className = "lg_p_lr_fill_c input_fill_c";
			var sv4 = document.createElement("input");
				sv4.className = "selectbtn ellipsis";
				sv4.setAttribute('ctf', 'selectbtn');		
				sv4.type = 'button';
				sv4.value = "－选择状态－";
			var sv5 = document.createElement("div");
				sv5.className = "select_items";
				sv5.setAttribute('ctf', 'select_items');
				sv5.setAttribute('sizset', exstatus.length);	
				sv5.style.width = "100%";
				sv5.style.height = 20*exstatus.length + "px";
				
				
			sv3.appendChild(sv4);
			sv2.appendChild(sv3);
			sv.appendChild(sv1);
			sv.appendChild(sv2);
			sv.appendChild(sv5);
			
			td.appendChild(sv);
						
			for(var i=0; i<exstatus.length; i++)
				LEAP.select.addItem(sv, exstatus[i].value, exstatus[i].title);
			
			LEAP.addEvent(sv, 'valueChange', LEAP.attachment.onExstatueSelected, null, null, false);
		}
	}
	finally
	{
		_buttons = _s = exstatus = sv = sv1 = sv2 = sv3 = sv4 = sv5 = i = null;	
	}
}

LEAP.attachment.onExstatueSelected = function(arg)
{
	if (arg.arg2.caller == null)
		return;
	
	var element = LEAP._match(arg.arg2.caller, LEAP.attachment.d);
	if (element == null)
		return;

	if (arg && arg.arg2 && arg.arg2.lv && arg.arg2.lv.trim() !='')
	{		
		var title = LEAP.getElement("input[ctf=selectbtn]", arg.arg2.caller).value
		
		LEAP.attachment.onUploadComplete(element, {title:title, exstatus:arg.arg2.lv.trim()}, null, 4, null, arg.arg2.caller);
		
		title = null;
	}

}

LEAP.attachment.onUploadComplete = function(e, data, err, par, operationSN, upLoadElement)
{	
	try
	{
		var arr = null;
		if (data instanceof Array)
			arr = data;
		else
			arr = [data];		
			
		for(var i=0; i<arr.length; i++)
		{			
			var result = arr[i];
			var _att={};
				_att.atttype = par;
				_att.fileid = result.fileid;
				_att.title = result.title; 
				_att.name = result.name;
				_att.viewname = result.viewname;
				_att.uuid = result.uuid;
				_att.namedpath = result.nameedPath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;
				_att.filecount = result.filecount;
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
				_att.exstatus = result.exstatus;
				_att.exdata = result.exdata;
				_att.attsize = result.size;
				
				if (e.getAttribute("_fixgroupid"))
					_att.fixgroupid = e.getAttribute("_fixgroupid") 
				
				if (_att.atttype == LEAP.attachment.symbol.zw)
				{
					var n = _att.name.toLowerCase(); 
					if (n.endWith('pdf'))
						_att.atttype = LEAP.attachment.symbol.PDFZW;
					else if (n.endWith('wps'))
						_att.atttype = LEAP.attachment.symbol.wps;
					else if (n.endWith('ceb') || n.endWith('cebx'))
						_att.atttype = LEAP.attachment.symbol.ceb;			
				}
			
			ElementEventManager.handleEvent(e, "onAttachmentUploadComplete", _att);
			LEAP.attachment.insert(e, _att, upLoadElement, false);
			
			if (_att.atttype == LEAP.attachment.symbol.zw && e['exAttributes'] && e['exAttributes'].autoConverZWToPDF == true)
				LEAP.attachment._converToPDF(e, _att, false);
		}
	}
	finally
	{
		arr = i = result = _att = n = null;
	}
}
LEAP.attachment.onBatchUploadComplete = function(arg)
{
	try
	{
		if (arg == null || arg.value != 1)
			return;
			
		var result = JSON.parse("[" + arg.result + "]");
		
		var element = arg.param.batchUploadElement;
		for(var i=0; i<result.length; i++)
			LEAP.attachment.onUploadComplete(element, result[i], null, 0, null, null);		
			
		LEAP.messagebox.alert('上传成功，一共' + result.length + '个文件。');
	}
	finally
	{
		result = element = i = null;
		
		LEAP.hideMask();
	}
}

LEAP.attachment.batchUpload = function(element)
{
	try
	{			
		var uploadpath = element.getAttribute('uploadpath') ? element.getAttribute('uploadpath') : "default"; 
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/Service/RPC/RPC.DO?type=3&rt=o&path=" + uploadpath + "&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
		var filter = "";
		if (element.getAttribute("typesdesc") != null && element.getAttribute("types") != null)
			filter =  element.getAttribute("typesdesc") + "|" + element.getAttribute("types");
		LEAP.Comb.upload.batchUpload({uploadurl: uploadurl,
										filter: filter,
										callback: LEAP.attachment.onBatchUploadComplete,
										callbackParam:	{batchUploadElement:element},
										domain:	this,
										showMask: true});
	}
	finally
	{
		uploadpath = uploadurl = null;
	}	
}

LEAP.attachment.batchDownload = function(element)
{
	try
	{		
		var module = LWFP.innerApi.getmodule(element);
		
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachment.ctf.attrow + "]", element);
		if (rows == null)
			return null;
		
		var arr = [];
		for(var i=0; i<rows.length; i++)
		{
			var _d = rows[i][LEAP.attachment.n];
			if (_d && _d.namedpath)
			{
				var url = LEAP.upload.getPath(_d.namedpath, _d.name, _d.uuid, _d.viewname, _d.title, null, null, _d.fileid, ((module.leapclient == null) ? null : module.leapclient.router));
				arr.add(url); 
			}
		}
		
		if (arr.length == 0)
			return;

		LEAP.Comb.upload.download(arr);
		
	}
	finally
	{
		rows = arr = i = _d = url = null;	
	}
}

LEAP.attachment.ScanRead = function(row)
{
	try
	{
		var att = row[LEAP.attachment.n];
		var element = LEAP._match(row, LEAP.attachment.d);
		
		var quality = (element.getAttribute('scan_quality') == null)?100:element.getAttribute('scan_quality') == null;
		var maxwidth = (element.getAttribute('scan_maxwidth') == null)?0:element.getAttribute('scan_maxwidth');
		var maxheight = (element.getAttribute('scan_maxheight') == null)?0:element.getAttribute('scan_maxheight');
		var uploadpath = element.getAttribute('scan_uploadpath');
		var sid = 'JSESSIONID=' + leapclient.getsid();
		var readonly = (att.canEdit==true)?0:1;
		var title = att.title;
		var exCapParam = "1&0&0&2&2&&&扫描&扫描下一张";
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(row)) + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&readscan=1&old_namedpath=' + att.namedpath + '&old_name=' + att.name+ '&old_uuid=' + att.uuid + '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
		
		var downloadUrl = LEAP.attachment._getPath(att, element);
		if (downloadUrl.endWith('.zip'))
		{
			downloadUrl = downloadUrl.substring(0, downloadUrl.length-4);
			downloadUrl += '/';
			title = title.endWith('.zip')?att.title:att.title+'.zip';
		}
		else
		{
			title = title.endWith('.pdf')?att.title:att.title+'.pdf';
			exCapParam = "1&0&0&2&2&&&扫描&扫描下一张&1";
			
			uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(row)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&readscan=1&old_namedpath=' + att.namedpath + '&old_name=' + att.name+ '&old_uuid=' + att.uuid + '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
		}
		
		var def = {	uploadurl	:uploadurl,
		 		downloadUrl	:downloadUrl,
		 		filecount	:att.filecount,	
		 		title		:title.replaceall(" ",""),
		 		readonly	:readonly,	
		 		quality		:quality,
		 		maxwidth	:maxwidth,
		 		maxheight	:maxheight,
		 		exCapParam	:exCapParam,
		 		callback	:LEAP.attachment.OnScanCompleted,
				callbackParam:{scantype:"scanread", scanreadrow:row},
				domain		:this};
				
		LEAP.Comb.scanner.scanread(def);

	}
	finally
	{
		att = element = quality = maxwidth = maxheight = uploadpath = sid = readonly = title = exCapParam = uploadurl = downloadUrl = def = null;
	}
}

LEAP.attachment.scan = function(src)
{
	try
	{
		var element = LEAP._match(src, LEAP.attachment.d);
		
		var quality = (element.getAttribute('scan_quality') == null)?100:element.getAttribute('scan_quality') == null;
		var maxwidth = (element.getAttribute('scan_maxwidth') == null)?0:element.getAttribute('scan_maxwidth');
		var maxheight = (element.getAttribute('scan_maxheight') == null)?0:element.getAttribute('scan_maxheight');
		var uploadpath = element.getAttribute('scan_uploadpath');
		var __url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(src)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
		var exCapParam = "1&0&0&2&2&&&扫描&扫描下一张&1";
		var title = '新扫描件.pdf';
				
		var def = {uploadurl	:__url,
		 		title		:title,
		 		quality		:quality,	//图片质量，默认100
		 		maxwidth	:maxwidth,		//图片尺寸最大宽度，0不缩放
		 		maxheight	:maxheight,		//图片尺寸最大高度，0不缩放		
		 		exCapParam	:exCapParam,
		 		groupParams	:"",		 		
		 		callback	:LEAP.attachment.OnScanCompleted,
				callbackParam:	{scantype:"scan", scansrc:src},
				domain		:this};
	
		LEAP.Comb.scanner.scanupload(def);	
	}
	finally
	{
		element = quality = maxwidth = maxheight = uploadpath = __url = exCapParam = title = def = null;
	}
}

LEAP.attachment.OnScanCompleted = function(arg)
{
	try
	{
		if (arg == null || arg.value != 1)
			return;
			
		var type = arg.param.scantype;
		
		if (arg.result != null && arg.result != '')
		{
			var uri = JSON.parse(arg.result);
			uri.filecount = arg.count;
			
			if (type == "scanread")
			{	
				var row = arg.param.scanreadrow;	
				var old = row[LEAP.attachment.n];
				
				uri.atttype = old.atttype;
				
				LEAP.attachment.onScanReadComplete(row, uri);
			}
			else if (type == "scan")
			{
				var src = arg.param.scansrc;
				var element = LEAP._match(src, LEAP.attachment.d);
				
				LEAP.attachment.onScanComplete(element, uri, src);			
			}		
		}
	}
	finally
	{
		type = uri = row = old = src = element = null;
	}
}

LEAP.attachment.onScanComplete = function(e, result, uploadElement)
{
	result.title = "新扫描件";
	result.showName = "新扫描件";
	
	LEAP.attachment.onUploadComplete(e, result, null, LEAP.attachment.symbol.SM, null, uploadElement);	
}

LEAP.attachment.onScanReadComplete = function(row, result)
{
	var _att = row[LEAP.attachment.n];
		//_att.title = result.title; 
		_att.name = result.name;
		_att.uuid = result.uuid;
		_att.namedpath = result.nameedPath;
		if (_att.updateType != 0)
			_att.updateType = 1;
			
		_att.attsize = result.size;
		//_att.ownername = LEAP.getUserInfo().fullName;
		_att.filecount = result.filecount;
		//_att.uploadtime = {time:Date.parse(new Date())};
	row[LEAP.attachment.n] = _att;
}

LEAP.attachment.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;

	/*if (LEAPBrowser.isIE && wait != null)
	{
		var fn = function()
		{
			LEAP.attachment.i(null, src);
			src = null;
		};
		setTimeout(fn, wait);
		return;
	}*/

	LEAP.attachment._i(src);
	
	if (src.parentElement)
		src.parentElement.removeChild(src);
}

LEAP.attachment._i = function(src)
{
	try
	{
		var _element = LEAP._match(src, LEAP.attachment.d);
		if (_element == null)
			return;
		
		var auto = _element.getAttribute('autoinit');
		if (auto != null && auto==0)
		{}
		else
		{
			LEAP.attachment.__i(_element);
		}
	}
	finally
	{
		_element = null;
	}
}

LEAP.attachment.setWordtemplateFn = function(element, fn)
{
	element = LEAP._match(element, LEAP.attachment.d);
	if (element)
	{
		element['WordtemplateFn'] = fn;
	}
}


LEAP.attachment.setExAttributes = function(element, exAttributes)
{
	element = LEAP._match(element, LEAP.attachment.d);
	if (element)
	{
		element['exAttributes'] = exAttributes;
	}	
}

LEAP.attachment.setUploadPath = function(element, uploadPath, scanUploadPath)
{
	element = LEAP._match(element, LEAP.attachment.d);
	if (uploadPath != null)
		element.setAttribute("uploadpath", uploadPath);
	if (scanUploadPath != null)
		element.setAttribute("scan_uploadpath", scanUploadPath);
}

LEAP.attachment.setFixItems = function(element, option, reload)
{
	element = LEAP._match(element, LEAP.attachment.d);
	if (element)
	{
		if (option == null)
		{
			element.setAttribute("_fixitems", '');
		}
		else
		{	
			if (option.currentStep != null)
				element['__currentstep'] = option.currentStep;			
			if (option.businessid != null)
				element.setAttribute("wfbusinessid", option.businessid);
			if (option.uploadpath != null)
				element.setAttribute("uploadpath", option.uploadpath);
			if (option.scan_uploadpath != null)
				element.setAttribute("scan_uploadpath", option.scan_uploadpath);
			if (option.defaultcolor != null)
				element.setAttribute("defaultcolor", option.defaultcolor);
			if (option.uploadcolor != null)
				element.setAttribute("uploadcolor", option.uploadcolor);
			if (option.groupid != null)
				element.setAttribute("_fixgroupid", option.groupid);
			else
				element.removeAttribute("_fixgroupid");
			if (option.readonly)
				LEAP.attachment.setReadonly(element, (option.readonly==true)?"1":"0", false);
			if (option.items != null)
				element['_fixitems'] = option.items;
			else
				element.setAttribute("_fixitems", "");
			if (option.uploadbuttons != null)
				element['_buttons'] = option.uploadbuttons;
			else
				element.setAttribute("_buttons", 'word,att,scan');	
			if (option.pdfopenmode != null)
				element['_pdfopenmode'] = option.pdfopenmode;
			if (option.oprateStyle != null)
				element['_oprateStyle'] = option.oprateStyle;
			
			if (option.exstatus != null && option.exstatus!='')
			{
				var arr = option.exstatus.split(',');
				for(var i=0; i<arr.length; i++)
				{
					var s = arr[i];
					var idx = s.indexof(':');
					arr[i] = {value: s.substring(0,idx).trim(), title :s.substring(idx+1,s.length).trim()};
				}				
				element['exstatus'] = arr;
			}
		}
		
		if (reload == true)
			LEAP.attachment.__i(element);
	}
}

LEAP.attachment.setExistAttachements = function(_element, atts)
{
	try
	{
		var element = LEAP._match(_element, LEAP.attachment.d);
		if (element == null)
			return;
			
		LEAP.attachment.__i(element);
		
		if (atts == null)
			return;
		
		var _table = LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", element);	
		if (_table == null)
			return;
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachment.ctf.attrow + "]", _table);
		if (rows == null)
			return;
		
		for(var i=0; i<atts.length; i++)
		{
			var _a = atts[i];			
			var code = _a.attcode; 
			if (code == null)
				continue;
			
			for(var k=0; k<rows.length; k++)
			{
				var row = rows[k];				
				var _att = row[LEAP.attachment.n];
				if (_att == null || _att.fixitemcode != code || _att.id != null)
					continue;
								
				_att.atttype = (_a.atttype == null) ? 0 : _a.atttype;				 
				_att.title = _a.title; 
				_att.fileid = _a.fileid;
				_att.name = _a.name;
				_att.uuid = _a.uuid;
				_att.namedpath = _a.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;
				_att.filecount = _a.filecount;
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = (_a.canDelete == null)?true:_a.canDelete;
				_att.canEdit = (_a.canEdit == null)?true:_a.canDelete;
				_att.exstatus = _a.exstatus;
				_att.exdata = _a.exdata;				
		
				LEAP.attachment._bindItemDetail(element, _att, _table, false);
				
				break;
			}			
		}
	}
	finally
	{
		element = _table = rows = i = _a = k = row = _att = null;
	}
		
}

LEAP.attachment.setZWForceClose = function(element, forceclose) 
{
	var element = LEAP._match(element, LEAP.attachment.d);
	if (element == null) {
		return;
	}
	
	element.setAttribute("forceclose", forceclose);
};

LEAP.attachment._autoSize = function(element)
{
	setTimeout(function(){LEAP.attachment.__autoSize(element)},1);
}

LEAP.attachment.__autoSize = function(element)
{
	var _div_top = LEAP.getElement("div.wfcontrol_attachment_top", element);
	var _table = LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", element);
	var	arr = LEAP.getElements("div[ctf=exstatueselect]", _table);
	var _readonly = element.getAttribute('readonly');
	_readonly = (_readonly && _readonly=='1')?true:false;
		
	if (_table)
	{
		var w = 100;
		if (element.offsetWidth != 0 && element.offsetWidth<300)
		{
			if (arr != null)
				w = 100;
			else if (element['_oprateStyle'] && element['_oprateStyle'] == 1)
				w = (_readonly == true)?70:205;
			else
				w = 65;
		}
		else
		{
			if (arr != null)
				w = 150;
			else if (element['_oprateStyle'] && element['_oprateStyle'] == 1)
				w = (_readonly == true)?70:205;
			else
				w = 65;
		}
		
		if (_table.rows.length > 0)
		{
			_table.rows[0].cells[1].style.width = w+"px";
		
			if (LEAPBrowser.isChrome == true)
				_table.rows[0].cells[0].style.width = (_table.offsetWidth - w - 10)+"px";
		}
	}

	if (_div_top && _table)
		_div_top.style.height = ( ((_table.offsetHeight + 30) <100)?100:_table.offsetHeight + 15 ) + "px";
	
	_div_top = _table = arr = w = null;
}

LEAP.attachment.__i = function(_element)
{
	try
	{	
		_element.setAttribute('_height', _element.offsetHeight);
		
		var  _fixitems = _element['_fixitems'];
		if (_fixitems == "")
			_fixitems = null;
		var _buttons = _element['_buttons'];
		if (!_buttons)
			_buttons = ",word,att,scan";
		
		var _readonly = _element.getAttribute('readonly');
		if (_readonly && _readonly=='1')
			_readonly = true;
		else
			_readonly = false;
		
				
		var _div_top = LEAP.getElement("div.wfcontrol_attachment_top", _element);
		var _div_bottom = LEAP.getElement("div.wfcontrol_attachment_bottom", _element);
		var _table = LEAP.getElement("table[ctf=" + LEAP.attachment.ctf.atttable + "]", _element);
		if (!_table)
		{
			_div_top = document.createElement('div')
			_div_top.className = 'wfcontrol_attachment_top';			
			
			_table = document.createElement("table");
			_table.setAttribute('ctf', LEAP.attachment.ctf.atttable);		
			var _tr = _table.insertRow();
				_tr.className = 'wfcontrol_attachment_fix_tr';			
			var _td1 = _tr.insertCell();
				_td1.innerText = '文件名';
				_td1.style.textAlign='center'
			var _td2 = _tr.insertCell();
				_td2.style.width = '120px';
				_td2.style.textAlign='center'
				_td2.innerText = '操作';
				
			_div_top.appendChild(_table);
			_element.appendChild(_div_top);
		}
		else
		{
			for(var i=_table.rows.length-1; i>0; i--)
				_table.deleteRow(i);
		}
				
		if (_fixitems)
		{			
			for(var i=0; i<_fixitems.length; i++)
			{
				var _att={};
					_att.fixitemcode = _fixitems[i].code;
					_att.fixitemname = _fixitems[i].name;
					_att.fixitemmulti = _fixitems[i].multifile;		
					_att.defaultcolor = (_fixitems[i].defaultcolor == null)?'#000000':_fixitems[i].defaultcolor;
					_att.uploadcolor = (_fixitems[i].uploadcolor == null)?'#1E50D2':_fixitems[i].uploadcolor;
					_att.types = _fixitems[i].types;
					_att.typesdesc = _fixitems[i].typesdesc;
					_att.isFixItem = true;
					_att.tip = _fixitems[i].tip;
					_att.exstatus = _fixitems[i].exstatus;
					_att.exdata = _fixitems[i].exdata;
					
				LEAP.attachment.insert(_element, _att, null, true);
			}
			
			_element.setAttribute("____fixStyle", "1");
			
			if (_div_bottom)
				_div_bottom.style.display = "none";				
			_div_top.style.height = "100%";			
		}
		else
		{	
			if (!_div_bottom)
			{
				_div_bottom = document.createElement('div')
				_div_bottom.setAttribute('ctf', '_attbtn');
				_div_bottom.className = 'wfcontrol_attachment_bottom';
				_div_bottom.style.height = "30px";
				
				_element.appendChild(_div_bottom);
				
				var color;
				if (_div_bottom.currentStyle)
					color = _div_bottom.currentStyle['color'];
				else if (getComputedStyle && getComputedStyle(_div_bottom))
					color = getComputedStyle(_div_bottom)['color'];
					
				if (color == "#aaaaaa" || color == "rgb(170, 170, 170)")
					color = true;
				else
					color = false;
				
				var str = '';					
				if (_buttons.indexOf("batchdownload") >=0)
					str += "<a  pp='batchdownload' class='lgbtn' href='javascript:' ctf='batchdownload' style='float:right; width:60px; font-weight:normal; line-height:19px; border-color:#a0a0a0; margin-left:4px; margin-right:4px;'>全部下载</a>";											
				if (_buttons.indexOf("scan")>=0)
					str += "<a  pp='scan' class='lgbtn' href='javascript:' ctf='scanbtn' style='float:right; width:40px; font-weight:normal; line-height:19px; border-color:#a0a0a0; margin-left:4px;'>扫描</a>";
				if (_buttons.indexOf("batch")>=0)
					str += "<a  pp='batch' class='lgbtn' ut='batchUpload' ctf='batchUpload' href='javascript:' style='float:right; width:60px; font-weight:normal; line-height:19px; border-color:#a0a0a0; margin-left:4px;'>上传附件</a>";
					//str += "<a  pp='batch' class='lgbtn' ut='batchUpload' ct='capture' tct='attachment' cap_type=5 href='javascript:' style='float:right; width:60px; font-weight:normal; line-height:19px; border-color:#a0a0a0; margin-left:4px;'>上传附件</a>";												
				if (_buttons.indexOf("att")>=0)
				{
					if (color == false)
						str += "<div pp='att' ppp='flash' tct='attachment' ct='uploadbtn' showtext='上传附件'  class='wfcontrol_attachment_button_h5' userpar='0'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";
					else
						str += "<div pp='att' ppp='flash' tct='attachment' ct='uploadbtn' showtext='上传附件'   class='wfcontrol_attachment_button_h5' img='LEAP/LWFP/StyleSheet/control/images/attachment/_upload-file.png' imgheight='22' imgwidth='61' userpar='0' ><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";
				}
				if (_buttons.indexOf("word")>=0)
				{
					if (color == false)
						str += "<div pp='file' ppp='flash' tct='attachment' ctf='wordbtn' ct='uploadbtn' showtext='上传正文' userpar='" + LEAP.attachment.symbol.zw + "' types='doc,docx' typesdesc='*.doc文件'   class='wfcontrol_attachment_button_h5'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";
					else
						str += "<div pp='file' ppp='flash' tct='attachment' ctf='wordbtn' ct='uploadbtn' showtext='上传正文' img='LEAP/LWFP/StyleSheet/control/images/attachment/_upload-text.png' imgheight='22' imgwidth='61' userpar='" + LEAP.attachment.symbol.zw + "' types='doc,docx' typesdesc='*.doc文件'   class='wfcontrol_attachment_button_h5'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";
				}
				
				_div_bottom.innerHTML = str;
			}
			

			{
				_div_bottom.style.display = "";
				
				var btn = LEAP.getElement("div[pp=file]", _div_bottom); 
				if (btn && (_buttons.indexOf("word")<0 || _readonly==true || _element['hideZW'] == true) ) //_element['hideZW']==true时隐藏正文
				{					
					btn.style.display = "none";
					btn = LEAP.getElement("div[pp=file2]", _div_bottom);
					if (btn)
						btn.style.display = "none";
				}
				else if (btn)
					btn.style.display = "block";
				
				btn = LEAP.getElement("a[pp=batch]", _div_bottom); 
				if (btn && (_buttons.indexOf("batch")<0 || _readonly==true) )
					btn.style.display = "none";
				btn = LEAP.getElement("a[pp=batchdownload]", _div_bottom); 
				if (btn && _buttons.indexOf("batchdownload")<0 )
					btn.style.display = "none";	
				btn = LEAP.getElement("div[pp=att]", _div_bottom); 
				if (btn && (_buttons.indexOf("att")<0 || _readonly==true) )
					btn.style.display = "none";
				btn = LEAP.getElement("a[pp=scan]", _div_bottom); 
				if (btn && (_buttons.indexOf("scan")<0 || _readonly==true) )
					btn.style.display = "none";
			
			}			

			var _type = _element["zhengwenType"];
			var _cv = LWFP.innerApi.Decimal2checkValue(_type, 4);
			var _ftype = "";
			var _ftypedesc = "";
			if (_cv.indexof('0001') >=0)	
			{
				_ftype += ',doc,docx';
				_ftypedesc += "|*.doc|*.docx";
			}
			if (_cv.indexof('0010') >=0)
			{
				_ftype += ',wps';
				_ftypedesc += "|*.wps";
			}
			if (_cv.indexof('0100,') >=0)
			{
				_ftype += ',pdf';
				_ftypedesc += "|*.pdf";
			}
			if (_cv.indexof('1000') >=0)	
			{
				_ftype += ',ceb,cebx';
				_ftypedesc += "|*.ceb|*.cebx";
			}
			if (_ftype == '')
			{
				_ftype = ',doc,docx';
				_ftypedesc = "|*.doc|*.docx";
			}
				
			_ftype = _ftype.substring(1);
			_ftypedesc = _ftypedesc.substring(1);
						
			var btn = LEAP.getElement("div[pp=file]", _div_bottom);
			if (btn)
			{
				btn.setAttribute('types', _ftype);
				btn.setAttribute('typesdesc', _ftypedesc);
				
				if (LEAP.fileupload && LEAP.fileupload.setAccept)
					LEAP.fileupload.setAccept(btn, _ftype);
					
			}

			LEAP.attachment._autoSize(_element);
			
			LEAP.asyn(LEAP.attachment.__clearFlashBackground, this, 200, _element);
		}
	}
	finally
	{
		_table = _div_top = _tr = _td1 = _td2 = _div_bottom = str = _readonly = _fixitems = _buttons = btn = i = null;
	}
}

LEAP.attachment.__clearFlashBackground = function(element)
{
	if (LEAP.isIE && LEAPBrowser.IEVersion < 10) 
	{
		var arr = LEAP.getElements("[ ppp=flash]", element);
		if (arr != null)
		{
			for(var i=0; i<arr.length; i++)
			{			
				arr[i].style.backgroundColor = "transparent !important";
				arr[i].style.borderWidth = "0px !important";
				arr[i].style.border = "0 !important";
			}
		}	
	}
}

LEAP.attachment._open2 = function(element, row, download, open,exParam)
{	
	try
	{
		var att = row[LEAP.attachment.n];
		if (!att || !att.namedpath)
			return;
			
		if (element.getAttribute("readonly") == "true")
			att.canEdit = false;
		
		var element = LEAP._match(row, LEAP.attachment.d);	
		var att = row[LEAP.attachment.n];
		var wordParam = {};
		wordParam.exParam2= {"businessid":element.getAttribute('wfbusinessid')};
		var hsid = "";
		if (element['__currentstep'] != null){
			hsid = element['__currentstep'].hsid;
		}
		wordParam.curstep = {"hsid":hsid};
		
		var btns = element['wordButton'];			
		var businessNo = element['businessNo'];
	
		if (btns != null && att.atttype == LEAP.attachment.symbol.zw)
			wordParam.wordButton = btns;
		else
			wordParam.wordButton = null;
		
		wordParam.businessNo = businessNo;
		
		var tmpValues = element['templateValues'];
		if (tmpValues == null)
		{				
			if (element['WordtemplateFn']){
				tmpValues = element['WordtemplateFn'].call(this);
			}
		}
		wordParam.templateValues = 	tmpValues;	
			
			
		var isPic = false;
		var _ex = /\.[^\.]+/.exec(att.name);					
		if (_ex && (_ex[0] == '.png' || _ex[0] == '.jpg' || _ex[0] == '.jpeg' || _ex[0] == '.gif'))
			isPic = true;
		var ifOffice = false;
		var ifPDF = false;
		var ifOFD = false;
		
		var wpsAddon = {ifwps:false, type:null};
		if (_ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.wps'))
			wpsAddon = {ifwps:true, type:"wps"};
		else if (_ex && (_ex[0] == '.xls' || _ex[0] == '.xlsx' || _ex[0] == '.et'))
			wpsAddon = {ifwps:true, type:"et"};
		else if (_ex && (_ex[0] == '.ppt' || _ex[0] == '.pptx' || _ex[0] == '.dps'))
			wpsAddon = {ifwps:true, type:"wpp"};
		
		if (_ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.et' || _ex[0] == '.xls' || _ex[0] == '.xlsx' ||  _ex[0] == '.ppt' || _ex[0] == '.pptx' || _ex[0] == '.dps') || _ex[0] == '.wps')
			ifOffice = true;
		if(_ex && _ex[0] == '.pdf')
			ifPDF = true;
		if(_ex && _ex[0] == '.ofd')
			ifOFD = true;
			
		if (LEAP.attlist.open_document_pdf_limit_size >0 && att.attsize>LEAP.attlist.open_document_pdf_limit_size && _ex && _ex[0] == '.pdf' )
			open = false;
		
		if (LEAP.attlist.open_document_doc_limit_size >0 && att.attsize>LEAP.attlist.open_document_doc_limit_size 
			&& _ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.wps') )
			open = false;
		
		if (LEAP.attlist.open_document_xls_limit_size >0 && att.attsize>LEAP.attlist.open_document_xls_limit_size 
			&& _ex && (_ex[0] == '.xls' || _ex[0] == '.xlsx' || _ex[0] == '.et') )
			open = false;	
		
		if (LEAP.attlist.open_document_ppt_limit_size >0 && att.attsize>LEAP.attlist.open_document_ppt_limit_size 
			&& _ex && (_ex[0] == '.ppt' || _ex[0] == '.pptx') )
			open = false;		
		
		var b = false;
				
		if (isPic == true && download != true)
		{
			LEAP.attlist._preview(row);
			return;
		}
		else if (download != true && (att.atttype == LEAP.attlist.symbol.SM || att.atttype == LEAP.attlist.symbol.scan))
		{
			if (ifPDF == true && LEAP.isIE == true)
			{
				LEAP.attlist._ScanRead(row);
				return;
			}
		}
		else if (att.atttype < 0 && open == true) //(att.atttype == LEAP.attlist.symbol.zw)
		{
			var singlepdfzw = element.getAttribute("singlepdfzw");
			if ( singlepdfzw == true || singlepdfzw == "true" ||singlepdfzw=="1" )
			{
				var zw = LEAP.attlist._checkHasZW(element);
				if(zw[1] == true)
				{					
					att._hasPDFZW = true;
					att._singlepdfzw = true;
				}
			}
			
			if (  ( ( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == "wpsAddon")
						|| ( (LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == "wpsAddon")
					)
					&& wpsAddon.ifwps == true && LEAP.WPSAddon && LEAP.WPSAddon.AddonEnable[wpsAddon.type] == true)
			{
				LEAP.attachment._open_document_wpsAddon(element, row, att, wpsAddon.type, exParam,wordParam);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用协议拉起
				LEAP.attlist._openOfd_urlProtocol(element, att);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用jsapi拉起
				LEAP.attlist._openOfd_JsAPI(element, att);
				return;
			}else if (ifPDF == true && ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "browserPlugin")
						|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux  == "browserPlugin")) )
			{
				//不处理，走window.open
			}
			else
			{
				var b = false;
				if(ifOffice == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.word,false);
				if(ifPDF == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.pdf,false);
				if (ifOFD == true)
					b = true;
			
				if ( ( (LEAP.DocumentView.isWin == true) && 
							(LEAP.DocumentView.DocumentEditor_win == "wps" || LEAP.DocumentView.DocumentEditor_win == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_win == "JSPDF" || LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")	)
					||  ( (LEAP.DocumentView.isWin == false) && 
							(LEAP.DocumentView.DocumentEditor_linux == "wps" || LEAP.DocumentView.DocumentEditor_linux == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_linux == "JSPDF")	)
				){
					b = true;
				}
				
				if ( (( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == 'YozoEditor')
						|| ( (LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == 'YozoEditor') ) 
						&& _ex && (_ex[0] == '.doc' || _ex[0] == '.docx') )
				{
					b = true
				}
				
				if (b == true)
				{
					LWFP.windowOpen.open(1, LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/DocumentViewer/DocumentViewer.html", 
											LEAP.ctid(row),
											{att:att} );	
					return;
				}
			}
		}
		else if ( (ifOffice == true || ifPDF == true || ifOFD == true) && download == false && open == true)
		{
			if (  ( ( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == "wpsAddon")
						|| ((LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == "wpsAddon")
					)
					&& wpsAddon.ifwps == true && LEAP.WPSAddon && LEAP.WPSAddon.AddonEnable[wpsAddon.type] == true)
			{
				LEAP.attachment._open_document_wpsAddon(element, row, att, wpsAddon.type, exParam,wordParam);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用协议拉起
				LEAP.attlist._openOfd_urlProtocol(element, att);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用jsapi拉起
				LEAP.attlist._openOfd_JsAPI(element, att);
				return;
			}else if (ifPDF == true && ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "tgeqbreaderUrlProtocol")
						|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "tgeqbreaderUrlProtocol")) )
			{
				////天谷E签宝阅读器
				LEAP.attlist._openPDF_TgeqbProtocol(element, att);
				return;
			}
			else if (ifPDF == true && ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "browserPlugin")
						|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "browserPlugin")) )
			{
				//不处理，走window.open
			}
			else
			{				
				var b = false;
				if(ifOffice == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.word,false);
				if(ifPDF == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.pdf,false);
				if (ifOFD == true)
					b = true;
									
				if ( ( (LEAP.DocumentView.isWin == true) && 
							(LEAP.DocumentView.DocumentEditor_win == "wps" || LEAP.DocumentView.DocumentEditor_win == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_win == "JSPDF" || LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")	)
					||  ( (LEAP.DocumentView.isWin == false) && 
							(LEAP.DocumentView.DocumentEditor_linux == "wps" || LEAP.DocumentView.DocumentEditor_linux == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_linux == "JSPDF")	)
				){
					b = true;
				}
					
					
				if ( (( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == 'YozoEditor')
						|| ( (LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == 'YozoEditor') ) 
					&& _ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.xls' || _ex[0] == '.xlsx' ||  _ex[0] == '.ppt' || _ex[0] == '.pptx') 
				){
					b = true
				}
				
				
				if (b == true)
				{
					LWFP.windowOpen.open(1, LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/DocumentViewer/DocumentViewer.html", 
									LEAP.ctid(row),
									{att:att} );
					
					return;
				}				
			}
		}
		
		
		//以上都不满足则交给LEAP下载打开
		att.nameedPath = att.namedpath;
		var p = null;
		if (att.entryid != null && att.id != null)
		{
			p = "sid=" + leapclient.getsid() + "&entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id;
			if (att.title != null && att.name!= null)
			{
				var t = att.title; 
				if (t.length > 20)
					t = t.substring(0, 20) + "...";
				p += "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
			}
			
			if (element)
			{
				if (element.getAttribute("watermark") == "0")
				{}
				else
				{
					p = p + "&watermark=1";
				}
			}
		}
		
		//LEAP.upload.download(att, true, false,  p);	
		LEAP.upload._download(att, open, p, LEAP.wfrouter.getRouter(element));
	
	}
	catch(e)
	{
		alert(e);
	}
	finally
	{
		att = isPic = _ex = ifOffice = ifPDF = b = p = null;
	}	
}

LEAP.attachment._open_document_wpsAddon = function(element, row, att, wpsDocType, exParam,wordParam)
{
	try
	{
		var module = LWFP.innerApi.getmodule(element);;
		var server = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element));
		//var url = LEAP.attlist._getPath(att, element);
		var url = LEAP.attachment._getPath(att, element);
		var saveAsNoneWatermark = false;
		if (module.saveAsNoneWatermark)
		{
			saveAsNoneWatermark = module.saveAsNoneWatermark(att); 
		}
		if (saveAsNoneWatermark == null)
			saveAsNoneWatermark = false;
		
		var p = "sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();		
		if (att.entryid != null && att.id != null)
		{
			p += "&entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id;
			if (att.title != null && att.name != null)
			{
				var t = att.title; 
				if (t.length > 50)
					t = t.substring(0, 50) + "...";
				p += "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
			}
		}
		
		if (url.indexOf('?') == -1)	
			url += "?" + p;
		else
			url += "&" + p;
		
		var savepath = server + "logic/WFOffice_updateDoc?lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() + "&namedpath=" + encodeURIComponent(att.namedpath) + "&name=" + encodeURIComponent(att.name) + ((att.fileid==null) ? "" : "&fileid=" + att.fileid);
		if (att.id)
			savepath += "&attid=" + att.id;
		if (att.entryid)
			savepath += "&attentryid=" + att.entryid;	
		if (wordParam && wordParam.exParam2 && wordParam.exParam2.businessid)
			savepath += "&attbusinessid=" + wordParam.exParam2.businessid;
		if (wordParam && wordParam.curstep && wordParam.curstep.hsid)	
			savepath += "&attcategory=" + wordParam.curstep.hsid;
		
				
		var ctid = LEAP.ctid(row);
		var srcid = row.getAttribute(LEAP.attlist.ctf.sssid);

		var param = {docType: wpsDocType,
						openType: (LEAP.DocumentView.wpsAddon_openFileType == 0 ? 0 : 1),
 						docId: ((att.id) ? att.id : ctid),
					    isnew: false,
					    readOnly: !att.canEdit,
					    atttype:	att.atttype,
					    fileTitle: att.title,
					    fileName: 	url,
					    name:		att.name,					    					    
					    converAlert: "版式文件转换成功，请回到系统页面查看",
					    waterMark: server + LEAP.getWaterMark(),
					    saveAsNoneWatermark: saveAsNoneWatermark,
					    savePath: savepath, //server + "logic/WFOffice_updateDoc?namedpath=" + encodeURIComponent(att.namedpath) + "&name=" + att.name + ((att.fileid==null) ? "" : "&fileid=" + att.fileid),
					    uploadPath: server + "logic/WFOffice_updateDoc2?uploadpath=default",
					    exparam:	{ctid: ctid, srcid:srcid},
					    domain:		module,
					    notifyFn: 	LEAP.attachment._converToPDF_callback2
					  };
					  
		if (exParam && exParam.qrcode)
			param.qrcode = exParam.qrcode;

		if (module.wpsAddonCustomConfig){
			var customConfig = module.wpsAddonCustomConfig();
			if(customConfig){
				if(customConfig.customJs && customConfig.customButtons){
					param.customJs = customConfig.customJs;
					param.customButtons = customConfig.customButtons;
				}
			}
		}			
		param.acceptRevisions = false;
		if (LEAP.attlist.attachment_acceptRevisions == true)
		{
			param.acceptRevisions = true;
		}
		
		if (wordParam)
		{
			param.buttons = wordParam.wordButton;			
			var bookmarks = wordParam.templateValues;				
			var templates = null;
			var fileTemplates = null; //正文模板	
			if (wordParam.businessNo)
			{
				var temps = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:wordParam.businessNo}});
				if (temps != null && temps.result != null)
				{
					templates = [];
					for(var i=0; i<temps.result.length; i++)
					{
						var temp = temps.result[i];
						var _temp = {templatename:	temp.templatename,
										mode:		temp.mode,
										url:		server + "LEAP/Download/" + temp.path + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() };
						templates.add(_temp);
					}
				}
				
				var fileTemps = module.request2({name:'lbcp_getZWTemplateForBusinessNo', par:{businessNo:wordParam.businessNo} });
				if (fileTemps != null && fileTemps.result != null)
				{
					fileTemplates = [];
					for(var i=0; i<fileTemps.result.length; i++)
					{
						var temp = fileTemps.result[i];
						var _temp = {templatename:	temp.templatename,
										url:		server + "LEAP/Download/" + temp.path + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid()	};
						fileTemplates.add(_temp);
					}
				}
			}
			
			
			var tp = {templates: templates,  //套红模板清单
						bookmarks: bookmarks //书签
					};
			
			param.template = tp;
			param.fileTemplates = fileTemplates;
		}
  					
  		LEAP.WPSAddon.OpenDocument(param);
	}
	finally
	{	
		module = server = 	url = p = t = wordParam = param = bookmarks = templates = temps = i=temp = _temp = tp = null;
	}	
}

LEAP.attachment._converToPDF_callback2 = function(arg)
{
		var obj = arg;
		if (obj.action == "convertToPDF")
		{				
			var ctid = obj.param.exparam.srcid;
			var row = LEAP.getElement("[" + LEAP.attlist.ctf.sssid + "=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attachment.d);
			
			var _att={};
				_att.id = UUID.randomUUID().replaceall('-', '');
				_att.atttype = LEAP.attachment.symbol.PDFZW;
				_att.fileid = obj.msg.fileid; 
				_att.attsize = obj.msg.attsize; 
				_att.title = obj.param.fileTitle; 
				_att.name =	obj.msg.name;					
				_att.namedpath = obj.msg.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;					
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
				
				var b = LEAP.attachment._hasPDFZW(element);
				if(b == true)
				{
					var row = LEAP.attachment._getRow(element,LEAP.attachment.symbol.PDFZW);
					LEAP.attachment._del(element,row,true);
				}
				LEAP.attachment.insert(element, _att, null, false);
		}
		else if (obj.action == "convertToOFD")
		{
			var ctid = obj.param.exparam.srcid;
			var row = LEAP.getElement("[" + LEAP.attlist.ctf.sssid + "=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attachment.d);
			
			var _att={};
				_att.atttype = LEAP.attachment.symbol.OFDZW;
				_att.id = UUID.randomUUID().replaceall('-', '');
				_att.fileid = obj.msg.fileid; 
				_att.attsize = obj.msg.attsize; 
				_att.title = obj.param.fileTitle; 
				_att.name =	obj.msg.name;					
				_att.namedpath = obj.msg.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;					
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
				
				var b = LEAP.attachment._hasOFDZW(element);
				if(b == true)
				{
					var row = LEAP.attachment._getRow(element,LEAP.attachment.symbol.OFDZW);
					LEAP.attachment._del(element,row,true);
				}
				
				
				LEAP.attachment.insert(element, _att, null, false);
		}
};

LEAP.attachment._hasOFDZW = function(element)
{
	var b = false;
	var arr = LEAP.attachment._getValue(element);
	if(arr)
	{
		for(var i=0; i<arr.length; i++)
		{
			if (arr[i].atttype == LEAP.attachment.symbol.OFDZW)
			{
				b = true;
				break;
			}
		}
	}
	return b;
}



LEAP.attachment.init();




/**
 * 附件
 * @class LEAP.attachmentList control
 * @type user control
 * @example
 * 
 * 
 * 
 
 var fixAtts = {uploadpath:'default',  uploadbuttons:'', exstatus:"1:纸质已收取,2:无需提交,3:须补交,4:证照已验证",
						afterUpload:this.__afterUpload,
   							items:[ {code:'a',name:'aaaa',multifile:false, dafaultcolor:'red', uploadcolor:'blue', d:'adfdsa'},
   									{code:'b',name:'bbbb',multifile:false, dafaultcolor:'red', uploadcolor:'blue', d:'adfdsa'},
   									{code:'c',name:'cccc',multifile:true, dafaultcolor:'red', uploadcolor:'blue', d:'adfdsa'} ],
   									
   							cols:[ {title:'序号', width:'50px', md:LEAP.attachmentList.col.sn}, 
									{title:'附件名称', width:'40%', md:LEAP.attachmentList.col.name},
									//{title:'上传者', width:'15%', md:LEAP.attachmentList.col.uploader},
									//{title:'上传环节', width:'10%', md:LEAP.attachmentList.col.uploadstep},
									//{title:'上传时间', width:'100px', md:LEAP.attachmentList.col.uploadtime},
									//{title:'大小', width:'50px', md:LEAP.attachmentList.col.size},									
									{title:'aaaaa', width:'50px', md:'zzz'},
									//{title:'操作', width:'5%', md:LEAP.attachmentList.col.operation}
									{title:'操作', width:'5%', md:LEAP.attachmentList.col.operation2, captureParams:{attname:'材料名称', zoom:2, pagewidth:240, pageheight:320, devno:2, pagestyle:1, toplabel:'上栏标签', bottomlabel:'下栏标签', topbtn:'上栏按钮', bottombtn:'下栏按钮'}}
									//attname:材料名称, devno:视频设备号, pagewidth:页面宽度, pageheight:页面高度, pagestyle:样式（0整页1上下分栏2连续多页）, toplabel:上栏标签, bottomlabel:下栏标签, topbtn:上栏按钮, bottombtn:下栏按钮
									]
	   						};

	LWFP.API.setFixAttachementItems(fixAtts, this);
	LEAP.attachmentList.setFixItems(this.getUT("attList"), fixAtts, true);
 
 

标签:
	readonly 只读,值域为1或者0,默认0
	viewsize 当图片超出该大小时创建缩略图 , 默认50
	minsize 允许上传文件的最小限制,单位为KB 默认0
	maxsize 允许上传文件的最大限制,单位为KB 默认1024*10
	types 选择框过滤的文件类型  ; 分割  如: *.jpg;*.gif;*.png
	typesdesc 选择框过滤的文件类型说明  如: 所有文件
	savesource 是否保存源文件
	viewwidth 缩略图宽度,默认200
	viewheight 缩略图高度,默认200
	quality 缩略图质量 1-100,数字越小质量越低,生成图片的大小越小,默认50
	uploadpath 上传路径 如:default
	
	includemain 是否包含正文0不包含1包含,默认0

	scan 是否带扫描，值域0否1是，默认0
	scan_quality 压缩比率1..100 
	scan_maxwidth 图片压缩最大宽度（像素）
	scan_maxheight 图片压缩最大高度（像素）	
	scan_title 文件显示名
	scan_uploadpath 上传路径
	scan_tct 目标插件
	
*/


LEAP.attachmentList = {};
LEAP.attachmentList.d = 'attachmentList';
LEAP.attachmentList.n = 'attdata';
LEAP.attachmentList.col = {sn:'sn', name:'name', uploader:'uploader', uploadtime:'uploadtime', uploadstep:'uploadstep', uploadtime:'uploadtime', size:'size', operation:'operation', operation2:'operation2'};
LEAP.attachmentList.ctf = {atttable:'atttable', attrow:'attrow', wordbtn:'wordbtn', scanbtn:'scanbtn', editzw:'editzw', open:'open', down:'down',
							_down:'_down', update:'update', del:'del', uploadbackdiv:'uploadbackdiv', preview:'preview', scan2:"scan2"};
//LEAP.attachmentList.symbol ={zw:-9, PDFZW:-6, FJ:1, SM:9};
LEAP.attachmentList.symbol ={zw:-9, wps:-8, PDFZW:-6, ceb:-4, scan:-3, FJ:0, SM:9}; //{word:-9,wps:-8,pdf:-6,ceb:-4,scan:-3};


LEAP.attachmentList.udpform = null;
LEAP.attachmentList.init = function()
{
	if (document != null && document.body != null)
		LEAP.attachmentList._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.attachmentList._init);	
}
LEAP.attachmentList._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.attachmentList.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.attachmentList._init);
}
LEAP.attachmentList.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		var ctf = src.getAttribute('ctf');
		
		var element = LEAP._match(src, LEAP.attachmentList.d);
		if(element && ctf)
		{	
			var row = LEAP._match(src, LEAP.attachmentList.ctf.attrow, 'ctf');
			if (ctf == LEAP.attachmentList.ctf.open)
				LEAP.attachmentList._open(row);
			else if (ctf == LEAP.attachmentList.ctf.down || ctf == LEAP.attachmentList.ctf._down)
				LEAP.attachmentList._down(row);
			else if (ctf == LEAP.attachmentList.ctf.update)
				LEAP.attachmentList._update(row);
			else if (ctf == LEAP.attachmentList.ctf.del)
				LEAP.attachmentList._del(element, row);
			else if (ctf == LEAP.attachmentList.ctf.uploadbackdiv)
				LEAP.attachmentList._loadUploadFlash(src, row);
			else if (ctf == LEAP.attachmentList.ctf.editzw)
				LEAP.attachmentList._wordEditUpload(src);
			else if (ctf == LEAP.attachmentList.ctf.scan2)
				LEAP.attachmentList.scan(src);
			else if (ctf == LEAP.imgview.ctf.preview)
				LEAP.attachmentList.preview(src);	
			else if (ctf == LEAP.attachmentList.ctf.scanbtn)
				LEAP.attachmentList.scan(src);
		}
		else
		{
			return;
		}
	}
	finally
	{
		src = ctf = element = row = null;
	}
}

LEAP.attachmentList.preview = function(src)
{
	try
	{	
		var element = LEAP._match(src, LEAP.attachmentList.d);
		var row = LEAP._match(src, LEAP.attachmentList.ctf.attrow, 'ctf');
		var att = row[LEAP.attachmentList.n];
		
		var atts = LEAP.attachmentList._getValue(element);
		var _previewIdx = 0;
		var ret = [];
		for(var i=0; i<atts.length; i++)
		{
			var _tmp = atts[i];			
			var n = _tmp.name.toLowerCase();
			if (n.endWith('.jpg') || n.endWith('.jpeg') || n.endWith('.png') || n.endWith('.gif'))
				ret.add(_tmp);
				
			if (_tmp.name == att.name)
				_previewIdx = ret.length - 1;
		}

		LEAP.imgview._preview(null, ret, _previewIdx, {previewwidth:20480, previewheight:20480});
	
		/*var row = LEAP._match(src, LEAP.attachmentList.ctf.attrow, 'ctf');
		var table = LEAP._match(row, LEAP.attachmentList.ctf.atttable, 'ctf');
		var att = row[LEAP.attachmentList.n];
		var rect = table.getBoundingClientRect();		
		var url = LEAP.attachmentList._getPath(att);
		var str = "<div style='width:auto;height:400px;'><img src='" + url + "' style='height:98%;margin-top:1%;'></div>";
		
		LEAP.smallTip.show(str, rect.left + 100, rect.top -30);*/	
	}
	finally
	{
		element = row = att = atts = _previewIdx = ret = i = _tmp = n = null;
	}
}

LEAP.attachmentList.getValue = function(element)
{
	try
	{
		if (!element)
			return null;
		
		var ret = LEAP.attachmentList._getValue(element);
		if (ret == null)
		{
			return null;
		}
		else
		{
			return JSON.stringify(ret);
		}
	}
	finally
	{
		ret = null;
	}
}

LEAP.attachmentList._getValue = function(element)
{
	try
	{
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachmentList.ctf.attrow + "]", element);
		if (rows == null)
			return null;
		
		var ret = []; 
		for(var i=0; i<rows.length; i++)
		{
			var _rt = rows[i].getAttribute("rt")
			var _d = rows[i][LEAP.attachmentList.n];
			
			if (_rt && _rt == "fixrow")
			{
				if (_d.namedpath != null || _d.exstatus != null)
					ret.add(_d);
			}
			else
			{
				ret.add(_d);	
			}
		}
		
		if (ret.length == 0)
			ret = null;
					
		return ret;
	}
	finally
	{
		rows = ret = i = _rt = _d = null;
	}
}

LEAP.attachmentList.setValue = function(element, value)
{
	try
	{	
		var _table = LEAP.getElement("table[ctf=" + LEAP.attachmentList.ctf.atttable + "]", element);
		if (_table)
		{	
			for(var i=_table.rows.length-1; i>0; i--)
				_table.deleteRow(i);
				
			_table.style.display = "none";
		}
			
		var _value = value;
		if (_value != null)
		{
			if (typeof(value) == 'string' && value.Trim() != "")
			{
				try
				{
					_value = eval("(" + value + ")");
				}
				catch(err)
				{
					_value = null;
				}
			}
			
			if (_value == null || _value.length==0)
				return;
				
			LEAP.attachmentList.__i(element, true);
			
			for(var i=0; i<_value.length; i++)
			{
				var att = _value[i];
				if (element['hideZW'] == true && att.atttype<0) //隐藏正文时
				{
					continue;
				}
				else
				{
					LEAP.attachmentList.insert(element, att);
				}
			}
		}
	}
	finally
	{
		_value = i = att = _table = null;
	}
}

LEAP.attachmentList._exflagFilt = function(element, att)
{
	if (!element['exflagFilter'])
		return true;
	
	if (!att.exflag)
	{
		return true;
	}
	else
	{
		if (element['exflagFilter'].indexOf(att.exflag)>=0)
			return true;
		if 	(att.owner == LEAP.getUserInfo().userflag)
			return true;
		
		return false;
	}
}

LEAP.attachmentList.getPageValue = function(instance, formElement)
{
	try
	{
		var element = LEAP.getElement("div[ct=" + LEAP.attachmentList.d + "][instance=" + instance + "]", formElement);
		if (element == null)
			return null;
		
		var value = LEAP.attachmentList._getChange(element);
		
		return value;
	}
	finally
	{
		element = value = null;	
	}	
}

LEAP.attachmentList.setPageValue = function(instance, formElement, value)
{
	try
	{	
		var element = LEAP.getElement("div[ct=" + LEAP.attachmentList.d + "][instance=" + instance + "]", formElement);
		if (element == null)
			return null;
		
		LEAP.attachmentList.setValue(element, value);
	}
	finally
	{
		element = null;
	}
}

LEAP.attachmentList.validate = function(element, checkItems)
{
	try
	{
		if (checkItems == null || checkItems == "")
			return true;

		var h = new hashtable();
		var _fixitems = element['_fixitems'];
		if (_fixitems != null)
		{
			for(var k=0; k<_fixitems.length; k++)
				h.add(_fixitems[k].code, _fixitems[k].name);
		}
		else
		{
			return true;
		}
		
		var _v = LEAP.attachmentList._getValue(element);
		if (checkItems == null || checkItems =="" )
		{
			if (_v == null)
			{
				for(var _key in h.keys)
					break;
				var _err = h.getvalue(_key);				
				if (_err == null)
					_err = "必须上传附件！";
				else
					_err = '必须上传附件:' + _err + "！";
					
				alert(_err);
				return false;
			}
		}
		else
		{
			var _items = checkItems.split(',');
			var b = true;
			for(var i=0; i<_items.length; i++)
			{
				var _code = _items[i];
				
				if (_code == "")
					continue;
				
				var flag = false;			
				if (_v != null)
				{
					for(var k=0; k<_v.length; k++ )
					{
						if (_v[k].fixitemcode != null && _v[k].fixitemcode.toLowerCase() == _code.toLowerCase())
						{
							flag = true;
							break;
						}
					}
				}
				
				if (flag == false)
				{
					b = false;
					var _err = h.getvalue(_code);				
					if (_err == null)
						_err = "必须上传附件！";
					else
						_err = '必须上传附件:' + _err + "！";
						
					alert(_err);
					
					break;
				}
			}
			
			return b;
		}
	}
	finally
	{
		_v = _items = b = i = _code = flag = k = _fixitems = _key = _err = h = null;
	}	
}

LEAP.attachmentList._getChange = function(element)
{
	try
	{
		var ret = [];
		
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachmentList.ctf.attrow + "]", element);
		if (rows != null)
		{ 
			for(var i=0; i<rows.length; i++)
			{
				var att = rows[i][LEAP.attachmentList.n];
				if (att.updateType != null)
					ret.add(att);
			}
		}
		
		var _deleted = element['deleted'];
		if (_deleted != null && _deleted.length>0)
		{
			for(var i=0; i<_deleted.length; i++)
				ret.add(_deleted[i]);
		}
		
		if (ret.length == 0)
			return null;
		else
			return ret;
	}
	finally
	{
		ret = rows = att = _deleted = i = null;
	}	
}

LEAP.attachmentList._open = function(row)
{	
	try
	{
		var att = row[LEAP.attachmentList.n];
		if (att.atttype == LEAP.attachmentList.symbol.SM || att.atttype == LEAP.attachmentList.symbol.scan)
		{
			LEAP.attachmentList.ScanRead(row);
		}
		else
		{
			LEAP.attachmentList._down(row);
		}
	}
	catch(e)
	{
	}
	finally
	{
		att = url = element = p = __scanner = null; 
	}	
}

LEAP.attachmentList._down = function(row)
{
	var att = row[LEAP.attachmentList.n];
	if (att && att.namedpath)
	{
		att.nameedPath = att.namedpath; 
		LEAP.upload.download(att, true, false);
	}
	
	att = null;
}

LEAP.attachmentList.ForceDelete = function(element, name)
{
	try
	{
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachmentList.ctf.attrow + "]", element);
		if (rows != null)
		{ 
			for(var i=0; i<rows.length; i++)
			{
				var row = rows[i];
				var att = row[LEAP.attachmentList.n];
				if (att.name == name)
				{
					LEAP.attachmentList._del(element, row, true);
				}
			}
		}
	}
	finally
	{
		rows = row = att = null;
	}
}

LEAP.attachmentList._del = function(element, row, noconfirm)//TODO
{
	if(!noconfirm)
	{
		if (!window.confirm('确定执行删除操作？'))
			return;
	}

	try
	{
		var _att = row[LEAP.attachmentList.n];
		var _rt = row.getAttribute('rt');
		if (_att.updateType != 0)
			_att.updateType = 2;
			
		if (_att.updateType == 2)
		{		
			var _deleted = element['deleted'];
			if (!_deleted)
				_deleted = [];
			
			_deleted.add(_att);
			
			element['deleted'] = _deleted;
		}
		
		if (_rt == "fixrow")
		{
			var _d = {};
				_d.fixitemcode = _att.fixitemcode;
				_d.fixitemname = _att.fixitemname;
				_d.fixitemmulti = _att.fixitemmulti;
				_d.defaultcolor = _att.defaultcolor;
				_d.uploadcolor = _att.uploadcolor;
				_d.types = _att.types;
				_d.typesdesc = _att.typesdesc;
				_d.isFixItem = _att.isFixItem;
				
			row[LEAP.attachmentList.n] = _d;

			var cols = LEAP.attachmentList._getColumns(element);
			for(var i=0; i<cols.length; i++)
			{
				var col = cols[i];
				var cell = row.cells[i];
				
				if (col.md == LEAP.attachmentList.col.name)
				{
					var _a = LEAP.getElement('a[ctf=' + LEAP.attachmentList.ctf._down + ']', row);
					if (!_a)
						_a = LEAP.getElement('a[ctf=' + LEAP.attachmentList.ctf.open + ']', row);
					
					_a.href = 'javascript:void(0)'; 	
					_a.setAttribute("ctf", LEAP.attachmentList.ctf._down);
					_a.title = _a.innerText;
					_a.style.cursor = 'default';
					_a.style.color = _att.defaultcolor;//"#000000";	
					_a.innerText = _att.fixitemname;
					
				}				
				else if (col.md == LEAP.attachmentList.col.operation)
				{
					cell.innerHTML = "";			
					var _div = document.createElement("div");	
						_div.className = 'wfcontrol_attachmentList_opfrm';
					cell.appendChild(_div);
					
					var _att = row[LEAP.attachmentList.n];
					
					var _di = document.createElement("div");
						_di.style.width = '50px';
						_di.style.height = '22px';
						_di.style.styleFloat = 'left';
					_div.appendChild(_di);
							
					var str = "<a pp='att' tct='attachmentList' ct='uploadbtn' class='wfcontrol_attachmentList_button2' ";
					if (_att.types)
						str += " types='" + _att.types + "'";
					if (_att.typesdesc)
						str += " typesdesc='" + _att.typesdesc + "'";	
					str += "showtext='上传66' userpar='0' img='LEAP/LWFP/StyleSheet/control/images/attachmentList/upload.png' imgwidth=40 imgheight=23 style='width:40px;height:23px;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></a>";			
					_di.innerHTML = str;
					
					LEAP.attachmentList._loadExbtutton(element, _div);
					
					LEAP.attachmentList.__setwidth(_div);					
				}
				else if (col.md == LEAP.attachmentList.col.sn)
				{}
				else
				{
					cell.innerText = "";	
				}
			}
		}
		else
		{			
			row.parentNode.deleteRow(row.rowIndex);
		}		
	}
	finally
	{
		_att = _rt = _deleted = _d = _a = _div = _att = _di = null;
	}
}

LEAP.attachmentList._update = function(row)
{	
	try
	{
		var _formElement = null;
		var _txt = null;
		var _btn = null;
		if (LEAP.attachmentList.udpform == null)
		{
			LEAP.attachmentList.udpform = LEAP.form.create(null, '修改文件名', 500, 150, null, null);
			LEAP.form.setContent(LEAP.attachmentList.udpform.form, "<div style='padding:10px'>文件名修改为：<input ut='filename' class='lginfoct' ht='input' bt='text' check='maxlen:100' style='border:1px solid #666; width:95%; margin-left:20px;marginright:1px;'/><br><a class='lgbtn' href='javascript:' ut='submit' ht='button' style='float: right'>确定</a></div>");
			_formElement = LEAP.getElement(LEAP.attachmentList.udpform.form);
			LEAP.attachmentList.udpform._txt = LEAP.getElement("input[ut=filename]", _formElement);
			_btn = LEAP.getElement("a[ut=submit]", _formElement);
			LEAP.addEvent(_btn, 'click', LEAP.attachmentList.__update);
		}		
		
		var att = row[LEAP.attachmentList.n];
		LEAP.attachmentList.udpform.FileName = att.title;
		LEAP.attachmentList.udpform._txt.value = att.title;
		LEAP.attachmentList.udpform._attRow = row;
		
		LEAP.form.show(LEAP.attachmentList.udpform.form);	
	}
	finally
	{
		_formElement = _txt = _btn = att = null;		
	}
}

LEAP.attachmentList.__update = function(arg)
{
	try
	{
		var _title = LEAP.attachmentList.udpform._txt.value.trim();
		if (_title == '')
		{
			alert('文件名不可为空！');
			return;
		}
		if ((_title.indexof('\\')>=0) || 
			(_title.indexof('/')>=0) ||
			(_title.indexof(':')>=0) ||
			(_title.indexof('*')>=0) ||
			(_title.indexof('?')>=0) ||
			(_title.indexof('"')>=0) ||
			(_title.indexof('<')>=0) ||
			(_title.indexof('>')>=0) ||
			(_title.indexof('|')>=0) )			
		{
			alert('文件名不可包含如下字符： \\ / : * ? " < > |');
			return;
		}
		
		var _row = LEAP.attachmentList.udpform._attRow;
		var _att = _row[LEAP.attachmentList.n];
		if (LEAP.warpChangedLog)
			LEAP.warpChangedLog(_att);
		
		_att.title = _title;

		if (_att.updateType == null)
			_att.updateType = 1;
		
		_row[LEAP.attachmentList.n] = _att;
		
		
		if (_att.atttype == LEAP.attachmentList.symbol.SM && _att.title.endWith('.zip'))
			_title = _att.title.substring(0,_att.title.length-4);	
			
		var _ex = /\.[^\.]+/.exec(_att.name);
		if (_ex)
			_title = _title + _ex[0];
		
		var element = LEAP._match(_row, LEAP.attachmentList.d);
		var cols = LEAP.attachmentList._getColumns(element);
		for(var i=0; i<cols.length; i++)
		{
			if (cols[i].md == LEAP.attachmentList.col.name)
			{		
				_row.cells[i].childNodes[0].innerText = _title;
				break;
			}
		}
		
		LEAP.form.hide(LEAP.attachmentList.udpform.form);
	}
	finally
	{
		_title = _row = _att = null;
	}	
}

LEAP.attachmentList._getPath = function(_att, element)
{
	var module = LWFP.innerApi.getmodule(element);
	var url = null;
	if (_att.viewname != null)
		url = LEAP.upload.getPath(_att.namedpath, _att.name, _att.uuid, _att.viewname, _att.viewname, null, null, _att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
	else if (_att.name != null)
		url = LEAP.upload.getPath(_att.namedpath, _att.name, _att.uuid, null, null, null, null, _att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
	return url;
}

LEAP.attachmentList.setReadonly = function(element, readonly, reload)
{
	element = LEAP._match(element, LEAP.attachmentList.d);
	if(null == element) return;
	
	element.setAttribute('readonly', readonly);
	
	if (reload == true)
			LEAP.attachmentList.__i(element, true);
	
}


LEAP.attachmentList.insert = function(element, _att, src)
{
	try
	{	
		var _isFix = (element['_fixitems'])?true:false; //是否固定项
			
		var _readonly = element.getAttribute('readonly'); //是否只读
		if (_readonly && _readonly=='1') 
			_readonly = true; 
		else 
			_readonly = false;

		var _table = LEAP.getElement("table[ctf=" + LEAP.attachmentList.ctf.atttable + "]", element);
		
		_table.style.display = "";
		
		if (_att.isFixItem == true)
			_att.title = _att.fixitemname;			
		
		var _isFixItemDetail = false;		
		if (_att.fixitemcode != null && (_att.namedpath != null || _att.exstatus != null) )
			_isFixItemDetail = true;
		
		if (src)
		{
			var _src_row = LEAP._match(src, LEAP.attachmentList.ctf.attrow, 'ctf', 5);
			if (_src_row)
			{
				var _d = _src_row[LEAP.attachmentList.n];
				if (_d.fixitemcode != null)
				{
					_isFixItemDetail = true;
					
					_att.fixitemcode = _d.fixitemcode;
				}
			}	
		}
		
		if (_isFixItemDetail == true)
		{
			LEAP.attachmentList._bindItemDetail(element, _att, _table, _readonly);
		}
		else
		{
			LEAP.attachmentList._insert(element, _att, _table, _readonly, _isFix);
		}
	}
	finally
	{
		_isFix = _readonly = _table = _isFixItemDetail = _src_row = _d = null;
	}
}

LEAP.attachmentList._bindItemDetail = function(element, _att, _table, _readonly)
{
	try
	{
		var _itemRow;
		var _d;
		for(var i=0; i<_table.rows.length; i++)
		{
			var __d = _table.rows[i][LEAP.attachmentList.n];
			if (__d && __d.fixitemcode == _att.fixitemcode)
			{
				_itemRow = _table.rows[i];
				_d = __d;
				
				_att.fixitemcode = _d.fixitemcode;
				_att.fixitemname = _d.fixitemname;
				_att.fixitemmulti = _d.fixitemmulti;
				_att.defaultcolor = _d.defaultcolor;
				_att.uploadcolor = _d.uploadcolor;
				_att.types = _d.types;
				_att.typesdesc = _d.typesdesc;
				_att.isFixItem = _d.isFixItem;	
				
				break;
			}
		}
		if (!_itemRow || !_d)
			return;
		
		if (element['afterUpload'])
			element['afterUpload'](_att);
			
		if (_d.fixitemmulti)  //在固定行下缩进
		{
			var _idx;
			for(var i=_itemRow.rowIndex + 1; i<_table.rows.length; i++)
			{
				var __d = _table.rows[i][LEAP.attachmentList.n];
				if (__d.fixitemcode != _d.fixitemcode)
				{
					_idx = i;
					break;
				}
			}
			
			if (_idx == null)
				_idx = _table.rows.length;
		
			var _text = _att.title;			
			var _rt = "normalrow"; //
			var _href = LEAP.attachmentList._getPath(_att, element);
			
			var _ctf = LEAP.attachmentList.ctf._down;
			if (_att.atttype != null && _att.atttype == LEAP.attachmentList.symbol.SM)
			{
				_href = 'javascript:void(0)';					
				_ctf = LEAP.attachmentList.ctf.open;							
			}
			
			var _tr = _table.insertRow(_idx);
			_tr[LEAP.attachmentList.n] = _att;
			_tr.setAttribute('ctf', LEAP.attachmentList.ctf.attrow);
			_tr.setAttribute('rt', _rt);
			
			var cols = LEAP.attachmentList._getColumns(element);
			for(var i=0; i<cols.length; i++)
			{
				var col = cols[i];
				
				var _td = _tr.insertCell(-1);
				
				if (col.md == LEAP.attachmentList.col.name)
				{
					_td.style.borderTop = 'none';
					_td.style.textAlign = "left";				
					var _a1 = document.createElement("a");		
						_a1.className = "wfcontrol_attachmentList_indent";
						_a1.href = 'javascript:void(0)';
						_a1.setAttribute('ctf', _ctf);
						_a1.innerText = _text
						_a1.style.color = (_att.uploadcolor==null)?'#1E50D2':_att.uploadcolor;
					_td.appendChild(_a1);	
				}
				else if (col.md == LEAP.attachmentList.col.uploader)
				{
					_td.innerText = (_att.ownername != null)?_att.ownername : "";	
				}
				else if (col.md == LEAP.attachmentList.col.uploadstep)
				{
					_td.innerText = (_att.stepaliasname != null)?_att.stepaliasname : "";
				}
				else if (col.md == LEAP.attachmentList.col.uploadtime)
				{
					_td.innerText = (_att.uploadtime != null)?LEAP.formatdate(_att.uploadtime.time, 0) : "";
				}
				else if (col.md == LEAP.attachmentList.col.size)
				{
					_td.innerText = LEAP.attachmentList._getAttsize(_att);
				}
				else if (col.md == LEAP.attachmentList.col.operation)
				{
					if (_readonly || _att.canDelete == false)
					{						
					}
					else
					{	
						_td.style.borderTop = 'none';
						_td.style.height = 26 + "px";
							
						if (!element['exstatus'])
						{
							var _a51 = document.createElement("a");
								_a51.className = 'wfcontrol_attachmentList_button';
								_a51.href = 'javascript:void(0)';
								_a51.innerText = "下载";
								_a51.setAttribute('ctf', LEAP.attachmentList.ctf.down);
								if (_att.atttype == LEAP.attachmentList.symbol.SM)
									_a51.setAttribute('ctf', LEAP.attachmentList.ctf.open);
							_td.appendChild(_a51);
						}
						
						if (!_readonly && (_att.canDelete == null || (_att.canDelete && _att.canDelete == true)) )
						{
							var _a52 = document.createElement("a");
								_a52.className = 'wfcontrol_attachmentList_button';
								_a52.href = 'javascript:void(0)';
								_a52.innerText = '修改';										
								_a52.setAttribute('ctf', LEAP.attachmentList.ctf.update);
							_td.appendChild(_a52);
							
							var _a53 = document.createElement("a");
								_a53.className = 'wfcontrol_attachmentList_button';
								_a53.href = 'javascript:void(0)';
								_a53.innerText = '删除';
								_a53.setAttribute('ctf', LEAP.attachmentList.ctf.del);
								
							_td.appendChild(_a53);
						}
					}
				}
			}	
		}
		else
		{
			_itemRow[LEAP.attachmentList.n] = _att;
			
			var cols = LEAP.attachmentList._getColumns(element);
			for(var i=0; i<cols.length; i++)
			{
				var col = cols[i];
				var cell = _itemRow.cells[i];
				
				if (col.md == LEAP.attachmentList.col.name)
				{
					var _a = LEAP.getElement('a[ctf=' + LEAP.attachmentList.ctf._down + ']', cell);					
					if (!_a)
						_a = LEAP.getElement('a[ctf=' + LEAP.attachmentList.ctf.open + ']', cell);
					
					if (_att.type)
						_a.innerText = _att.fixitemname + "【" + _att.title + "】";
					else
						_a.innerText = _att.fixitemname;
						
					_a.href = 'javascript:void(0)';
					_a.setAttribute('ctf', LEAP.attachmentList.ctf._down);
					if (_att.atttype == LEAP.attachmentList.symbol.SM)
					{
						_a.setAttribute("ct", "capture");
						_a.setAttribute("cap_type", "3");
						_a.setAttribute('ctf', LEAP.attachmentList.ctf.open);
					}				
					_a.style.color = (_att.uploadcolor==null)?'#1E50D2':_att.uploadcolor;
					_a.style.cursor = 'hand';		
				}
				else if (col.md == LEAP.attachmentList.col.uploader)
				{
					cell.innerText = (_att.ownername != null)?_att.ownername : "";
				}
				else if (col.md == LEAP.attachmentList.col.uploadtime)
				{
					cell.innerText = (_att.uploadtime != null)?LEAP.formatdate(_att.uploadtime.time, 0) : "";
				}
				else if (col.md == LEAP.attachmentList.col.size)
				{
					cell.innerText = LEAP.attachmentList._getAttsize(_att);
				}
				else if (col.md == LEAP.attachmentList.col.operation)
				{
					cell.innerHTML = "";
				
					if (!element['exstatus'])
					{
						var _a31 = document.createElement("a");
							_a31.className = 'wfcontrol_attachmentList_button';
							_a31.href = 'javascript:void(0)';					
							_a31.innerText = '下载';									
							_a31.setAttribute('ctf', LEAP.attachmentList.ctf.down);
			
						cell.appendChild(_a31);
					}
								
					if (!_readonly && (_att.canDelete == null || (_att.canDelete && _att.canDelete == true)) )
					{
						var _a33 = document.createElement("a");
							_a33.className = 'wfcontrol_attachmentList_button';
							_a33.href = 'javascript:void(0)';
							_a33.innerText = '删除';										
							_a33.setAttribute('ctf', LEAP.attachmentList.ctf.del);
							
						cell.appendChild(_a33);
					}
				}
				else if (col.md == LEAP.attachmentList.col.operation2)
				{
					var btn = LEAP.getElement('a[ppppf=1]', cell);
					btn.style.display = "";
					
					var _ex = /\.[^\.]+/.exec(_att.name);
					if (btn)
					{
						if (_ex && (_ex[0] == '.png' || _ex[0] == '.jpg' || _ex[0] == '.jpeg' || _ex[0] == '.gif'))
						{
							btn.setAttribute('ctf', LEAP.imgview.ctf.preview);
							//btn.setAttribute('ct', 'smallTip');
						}
						else
						{
							btn.setAttribute('ctf', LEAP.attachmentList.ctf.open);
							//btn.removeAttribute('ct');
						}					
					}
					
					LEAP.attachmentList.__setwidth(btn.parentElement);
				}
				else if (_att[col.md])
				{
					cell.innerText = _att[col.md];
				}
				
			}					
		}
	}
	finally
	{
		_itemRow = _d = i = __d = _idx = _text = _rt = _href = _ctf = _tr = cols = i = col = _td = _a1 = _a51 = _a52 = _a53 = cols = 
		col = cell = _a = _a31 = _a33 = btn = _ex = null;
	}	
}

LEAP.attachmentList._insert = function(element, _att, _table, _readonly, _isFix)
{
	try
	{
		var maxOrderid = (element['maxOrderid'] == null)?0:element['maxOrderid'];
			maxOrderid = maxOrderid + 1;
		_att.orderid = maxOrderid;
		element['maxOrderid'] = maxOrderid;
		
		if (LEAP.attachmentList._exflagFilt(element, _att) == false)
			return;
		
		var _text = _att.title;
		var _href = LEAP.attachmentList._getPath(_att, element);		
		var _ex = /\.[^\.]+/.exec(_att.name);
		var _ctf = LEAP.attachmentList.ctf._down;
		var _cursor = 'hand';
		var _rt = "normalrow"; //
		if (_att.atttype != null)
		{
			if (_att.atttype == LEAP.attachmentList.symbol.SM)
			{
				if (_att.title.endWith('.zip'))
					_text = _att.title.substring(0,_att.title.length-4);
				_href = 'javascript:void(0)';				
				_ctf = LEAP.attachmentList.ctf.open;
			}
			
			if (_ex)
				_text = _text + _ex[0];
			
		}
		if (_att.isFixItem == true)
		{
			_href = 'javascript:void(0)';
			_ctf = LEAP.attachmentList.ctf._down;
			_cursor = 'default';
			_rt = "fixrow";		//TODO
		}
		
		var _tr = _table.insertRow(-1);		
		_tr[LEAP.attachmentList.n] = _att;
		_tr.setAttribute('ctf', LEAP.attachmentList.ctf.attrow);
		_tr.setAttribute('rt', _rt);
		
		var columns = LEAP.attachmentList._getColumns(element);
		
		for(var i=0; i<columns.length; i++)
		{
			var col = columns[i];
			
			var _td = _tr.insertCell(-1);
			if (col.md == LEAP.attachmentList.col.sn)
				_td.innerText = _tr.rowIndex;
			else if (col.md == LEAP.attachmentList.col.uploader)
				_td.innerText = ((_att.ownername != null)?_att.ownername : "") + ((_att.ownerorganname!=null)?'(' + _att.ownerorganname + ')':"");
			else if (col.md == LEAP.attachmentList.col.uploadstep)
				_td.innerText = (_att.stepaliasname != null)?_att.stepaliasname : "";
			else if (col.md == LEAP.attachmentList.col.uploadtime)
				_td.innerText = (_att.uploadtime != null)?LEAP.formatdate(_att.uploadtime.time, 1) : "";
			else if (col.md == LEAP.attachmentList.col.size)
				_td.innerText = LEAP.attachmentList._getAttsize(_att);
			else if (col.md == LEAP.attachmentList.col.name)
			{}
			else if (_att[col.md])
				_td.innerText = _att[col.md];
			
			if (col.md == LEAP.attachmentList.col.name)
			{
				_td.style.textAlign = "left";
				_td.style.paddingLeft = "10px";
									
				var _a = document.createElement("a");
					_a.href = 'javascript:void(0)';
					_a.setAttribute('ctf', _ctf);			
					_a.innerHTML = _text;			
					_a.style.cursor = _cursor;
			
					var _color = '#56ABFC';
					if (_att.defaultcolor != null)
						_color = _att.defaultcolor;
					if (_a.isFixItem != true)
					{
						_color = (element.getAttribute("uploadcolor") == null) ? _color : element.getAttribute("uploadcolor");
					}
					_a.style.color = _color;
					
				_td.appendChild(_a);				
			}
			
			if (col.md == LEAP.attachmentList.col.operation)
			{
				var _div = document.createElement("div");			
					_div.className = 'wfcontrol_attachmentList_opfrm';
					
				_td.appendChild(_div);
				
				if (_att.isFixItem != true)
				{
					var _a1 = document.createElement("a");
						_a1.className = "wfcontrol_attachmentList_button";
						_a1.href = 'javascript:void(0)';
						_a1.innerText = "下载";
						_a1.title = '下载文件';
						_a1.setAttribute('ctf', LEAP.attachmentList.ctf.down);
						if (_att.atttype == LEAP.attachmentList.symbol.SM)
							_a1.setAttribute('ctf', LEAP.attachmentList.ctf.open);
					_div.appendChild(_a1);
					
					if (_ex && _att.name && 
							(_ex[0] == '.png' || _ex[0] == '.jpg' || _ex[0] == '.jpeg' || _ex[0] == '.gif'))
					{
						var _a5 = document.createElement("a");
							_a5.className = "wfcontrol_attachmentList_button";
							_a5.href = 'javascript:void(0)';
							_a5.innerText = "预览";					
							_a5.setAttribute('ctf', LEAP.imgview.ctf.preview);
							//_a5.setAttribute('ct', 'smallTip');
						_div.appendChild(_a5);	
					}
					if (!_readonly && (_att.canEdit == null || (_att.canEdit && _att.canEdit == true)) )
					{
						var _a2 = document.createElement("a");
							_a2.className = "wfcontrol_attachmentList_button";
							_a2.href = 'javascript:void(0)';
							_a2.title = '修改文件名';
							_a2.innerText = "修改";
							_a2.setAttribute('ctf', LEAP.attachmentList.ctf.update);
						_div.appendChild(_a2);				
					}
					if (!_readonly && (_att.canDelete == null || (_att.canDelete && _att.canDelete == true)) )
					{				
						var _a3 = document.createElement("a");
							_a3.className = "wfcontrol_attachmentList_button";
							_a3.href = 'javascript:void(0)';
							_a3.title = '删除文件';
							_a3.innerText = "删除";					
							_a3.setAttribute('ctf', LEAP.attachmentList.ctf.del);
						_div.appendChild(_a3);
					}			
					if (element['exflags'])
					{
						if (_att.exflag == null)
						{
							_att.exflag = (element['defaultExflag'] != null)?element['defaultExflag']:element['exflags'][0].value;
							if (_att.updateType != 0)
								_att.updateType = 1;
								
							_tr[LEAP.attachmentList.n] = _att;
						}
		
						if (element['exflags'] && !_readonly && (_att.canEdit == null || (_att.canEdit && _att.canEdit == true)) 
							&& (element['exflagDisplay'] == null || element['exflagDisplay'] != "0")  )
						{
							var sv = LEAP.attachmentList._loadExFlag(element, _div);
							LEAP.select.setValue(sv, _att.exflag);
						}
					}
				}
				else
				{
					if (!_readonly)
					{	
						var _d = document.createElement("div");
							_d.style.width = '50px';
							_d.style.height = '22px';
							_d.style.styleFloat = 'left';
												
						var _au = document.createElement("a");
							_au.className = "wfcontrol_attachmentList_button";
							_au.href = 'javascript:void(0)';
							_au.innerText = "上传";
							_au.setAttribute("ctf", LEAP.attachmentList.ctf.uploadbackdiv);
							_au.style.cursor = "hand";
						
						_d.appendChild(_au);
							
						_div.appendChild(_d);
						
						LEAP.addEvent(_au, 'mouseenter', LEAP.attachmentList.uiProcess, null, null, true);
						
						LEAP.attachmentList._loadExbtutton(element, _div);
					}
				}
				
				LEAP.attachmentList.__setwidth(_div);				
			}
			else if (col.md == LEAP.attachmentList.col.operation2)
			{
				var _div = document.createElement("div");			
					_div.className = 'wfcontrol_attachmentList_opfrm';					
				_td.appendChild(_div);
				
				var _a1 = document.createElement("a");
					_a1.className = "wfcontrol_attachmentList_button";
					_a1.href = 'javascript:void(0)';
					_a1.innerText = "查看";						
					_a1.setAttribute('ctf', LEAP.attachmentList.ctf.open);
					_a1.setAttribute('ppppf', "1");
				_div.appendChild(_a1);
				_a1.style.display = "none";
				
				if (!_readonly)
				{
					/*var _d = document.createElement("div");
						_d.style.width = '50px';
						_d.style.height = '22px';
						_d.style.styleFloat = 'left';
													
					var _au = document.createElement("a");
						_au.className = "wfcontrol_attachmentList_button";
						_au.href = 'javascript:void(0)';
						_au.innerText = "上传";
						_au.setAttribute("ctf", LEAP.attachmentList.ctf.uploadbackdiv);
						_au.style.cursor = "hand";
					
					_d.appendChild(_au);
					_div.appendChild(_d);
					
					LEAP.addEvent(_au, 'mouseenter', LEAP.attachmentList.uiProcess, null, null, true);
					*/
					
					_tr['isNewScanner'] = true;
					var _s = document.createElement("a");				
						_s.className = "wfcontrol_attachmentList_button";					
						_s.href = 'javascript:void(0)';
						_s.innerText = "扫描";
						_s.setAttribute("ctf", LEAP.attachmentList.ctf.scan2);
						_s.setAttribute("title", "扫描上传");
						_s.setAttribute("tct", "attachmentList");
						
						if (_att.captureParams != null)
							_s["captureParams"] = _att.captureParams;
					_div.appendChild(_s);
				}
				
				LEAP.attachmentList.__setwidth(_div);
			}
		}
		
		
	}
	finally
	{
		maxOrderid = _text = _href = _ex = _ctf = _cursor = _rt = _tr = columns = i = col = _td = 
		_a = _color = _div = _a1 = _a5 = _a2 = _a3 = sv = _d = _au = _div = _a1 = _s = null;
	}
}

LEAP.attachmentList._getAttsize = function(_att)
{
	if (_att.attsize == null)
		return "";
	
	if (_att.attsize >= 1048576)
		return Math.floor(_att.attsize/1048576) + "M";
	else if (_att.attsize >= 1024)
		return Math.floor(_att.attsize/1024) + "K";
	else if (_att.attsize >= 0)
		return _att.attsize + "B";	
}


LEAP.attachmentList.__setwidth = function(con)
{
	if (con && con.childNodes)
	{
		var n = 0;
		for(var i=0; i<con.childNodes.length; i++)
		{
			n += con.childNodes[i].clientWidth + 15;
		}
			
		con.style.width = n + "px";
	}	
}

LEAP.attachmentList._loadExFlag = function(e,td)
{
	try
	{	
		var exflags = e['exflags'];
		if (exflags)
		{	
			var sv = document.createElement("div");
				sv.className = "select lginfoct";
				sv.setAttribute('ct', 'select');
				sv.setAttribute('ctf', 'exstatueselect');
				sv.style.width = "105px";
				sv.style.height = "18px";
				sv.style.border = "1px solid #c2c4c6";
				sv.style.marginTop = "auto";
				sv.style.styleFloat = "left";
			var sv1 = document.createElement("div");
				sv1.className = "lg_p_lr_right select_drop selectdropout";
				sv1.setAttribute('ctf', 'select_drop');
				sv1.style.height = "100%";
			var sv2 = document.createElement("div");
				sv2.className = "lg_p_lr_fill input_fill";
			var sv3 = document.createElement("div");
				sv3.className = "lg_p_lr_fill_c input_fill_c";
			var sv4 = document.createElement("input");
				sv4.className = "selectbtn ellipsis";
				sv4.setAttribute('ctf', 'selectbtn');		
				sv4.type = 'button';
				sv4.value = "－选择状态－";
			var sv5 = document.createElement("div");
				sv5.className = "select_items";
				sv5.setAttribute('ctf', 'select_items');
				sv5.setAttribute('sizset', exflags.length);	
				sv5.style.width = "100%";
				sv5.style.height = 20*exflags.length + "px";
				
				
			sv3.appendChild(sv4);
			sv2.appendChild(sv3);
			sv.appendChild(sv1);
			sv.appendChild(sv2);
			sv.appendChild(sv5);
			
			td.appendChild(sv);
						
			for(var i=0; i<exflags.length; i++)
				LEAP.select.addItem(sv, exflags[i].value, exflags[i].title);
			
			LEAP.addEvent(sv, 'valueChange', LEAP.attachmentList.onExflagSelected, null, null, false);
		}
		
		return sv;
	}
	finally
	{
		exflags = sv = sv1 = sv2 = sv3 = sv4 = sv5 = i = null;
	}
}

LEAP.attachmentList.onExflagSelected = function(arg)
{
	try
	{
		var row = LEAP._match(arg.caller, LEAP.attachmentList.ctf.attrow, "ctf");
		if (!row)
			return;			
		var att = row[LEAP.attachmentList.n];
			att.exflag = arg.arg2.lv;
		
		if (att.updateType != 0)
			att.updateType = 1;
						
		row[LEAP.attachmentList.n] = att;
	}
	finally
	{
		row = att = null;
	}
}

LEAP.attachmentList._loadUploadFlash = function(src, row)
{
	try
	{
		var _att = row[LEAP.attachmentList.n];
		var str = "<a pp='att' tct='attachmentList' ct='uploadbtn' class='wfcontrol_attachmentList_button2' ";
		if (_att.types)
			str += " types='" + _att.types + "'";
		if (_att.typesdesc)
			str += " typesdesc='" + _att.typesdesc + "'";	
		str += "showtext='上传66' userpar='0' img='LEAP/LWFP/StyleSheet/control/images/attachmentList/upload.png' imgwidth=40 imgheight=23 style='width:40px;height:23px;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></a>";	
		src.parentNode.innerHTML = str;
	}
	finally
	{
		_att = str = null;
	}
}

LEAP.attachmentList._loadExbtutton = function(e,td)
{
	try
	{
		var _buttons = e['_buttons'];
		if (_buttons && _buttons.indexOf("scan")>=0)
		{
			var _s = document.createElement("div");
				_s.className = "wfcontrol_attachment_scanupload";					
				/*_s.setAttribute("pp", "scan");
				_s.setAttribute("ct", "capture");
				_s.setAttribute("tct", "attachmentList");
				_s.setAttribute("cap_type", "2");*/
				_s.setAttribute("title", "扫描上传");
				_s.setAttribute("ctf", LEAP.attachmentList.ctf.scanbtn);
				
			td.appendChild(_s);
		}
					
		var exstatus = e['exstatus'];
		if (exstatus)
		{	
			var sv = document.createElement("div");
				sv.className = "select lginfoct";
				sv.setAttribute('ct', 'select');
				sv.setAttribute('ctf', 'exstatueselect');
				sv.style.width = "105px";
				sv.style.height = "18px";
				sv.style.border = "1px solid #c2c4c6";
				sv.style.marginTop = "auto";
				sv.style.styleFloat = "left";
			var sv1 = document.createElement("div");
				sv1.className = "lg_p_lr_right select_drop selectdropout";
				sv1.setAttribute('ctf', 'select_drop');
				sv1.style.height = "100%";
			var sv2 = document.createElement("div");
				sv2.className = "lg_p_lr_fill input_fill";
			var sv3 = document.createElement("div");
				sv3.className = "lg_p_lr_fill_c input_fill_c";
			var sv4 = document.createElement("input");
				sv4.className = "selectbtn ellipsis";
				sv4.setAttribute('ctf', 'selectbtn');		
				sv4.type = 'button';
				sv4.value = "－选择状态－";
			var sv5 = document.createElement("div");
				sv5.className = "select_items";
				sv5.setAttribute('ctf', 'select_items');
				sv5.setAttribute('sizset', exstatus.length);	
				sv5.style.width = "100%";
				sv5.style.height = 20*exstatus.length + "px";
				
				
			sv3.appendChild(sv4);
			sv2.appendChild(sv3);
			sv.appendChild(sv1);
			sv.appendChild(sv2);
			sv.appendChild(sv5);
			
			td.appendChild(sv);
						
			for(var i=0; i<exstatus.length; i++)
				LEAP.select.addItem(sv, exstatus[i].value, exstatus[i].title);
			
			LEAP.addEvent(sv, 'valueChange', LEAP.attachmentList.onExstatueSelected, null, null, false);
		}
	}
	finally
	{
		_buttons = _s = exstatus = sv = sv1 = sv2 = sv3 = sv4 = sv5 = i = null;	
	}
}

LEAP.attachmentList.onExstatueSelected = function(arg)
{
	try
	{
		if (arg.arg2.caller == null)
			return;
		
		var element = LEAP._match(arg.arg2.caller, LEAP.attachmentList.d);
		if (element == null)
			return;
	
		if (arg && arg.arg2 && arg.arg2.lv && arg.arg2.lv.trim() !='')
		{		
			var title = LEAP.getElement("input[ctf=selectbtn]", arg.arg2.caller).value
			
			LEAP.attachmentList.onUploadComplete(element, {title:title, exstatus:arg.arg2.lv.trim()}, null, 4, null, arg.arg2.caller);
			
			title = null;
		}
	}
	finally
	{
		element = null;
	}
}


LEAP.attachmentList.onUploadComplete = function(e, result, err, par, operationSN, upLoadElement)
{	
	var _att={};
		_att.atttype = par;
		_att.fileid = result.fileid; 
		_att.title = result.title; 
		_att.name = result.name;
		_att.viewname = result.viewname;
		_att.uuid = result.uuid;
		_att.namedpath = result.nameedPath;
		_att.updateType = 0;
		_att.ownername = LEAP.getUserInfo().fullName;
		_att.filecount = result.filecount;
		_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
		_att.canDelete = true;
		_att.canEdit = true;
		_att.exstatus = result.exstatus;
		_att.attsize = result.size;
		_att.ownerorganname = LEAP.getUserInfo().orgCNName;
		_att.stepaliasname = (e['_currentStep']!=null)?e['_currentStep'].stepaliasname:"";
		
		if (e.getAttribute("_fixgroupid"))
			_att.fixgroupid = e.getAttribute("_fixgroupid") 
		
		if (_att.atttype == LEAP.attachmentList.symbol.zw)
		{
			var n = _att.name.toLowerCase(); 
			if (n.endWith('pdf'))
				_att.atttype = LEAP.attachmentList.symbol.PDFZW;
			else if (n.endWith('wps'))
				_att.atttype = LEAP.attachmentList.symbol.wps;
			else if (n.endWith('ceb') || n.endWith('cebx'))
				_att.atttype = LEAP.attachmentList.symbol.ceb;			
		}
			
	LEAP.attachmentList.insert(e, _att, upLoadElement);
	
	if (_att.atttype == LEAP.attachmentList.symbol.zw && e['exAttributes'] && e['exAttributes'].autoConverZWToPDF == true)
		LEAP.attachmentList._converToPDF(e, _att, false);

	_att = n = null;
}

LEAP.attachmentList.onBatchUploadComplete = function(e, result, uploadElement)
{
	if (result == null || result.length==0)
		return;
	for(var i=0; i<result.length; i++)
		LEAP.attachmentList.onUploadComplete(e, result[i], null, 0, null, uploadElement);
		
	i = null;
}
LEAP.attachmentList.onScanComplete = function(e, result, uploadElement)
{
	result.title = "新扫描件";
	result.showName = "新扫描件";
	LEAP.attachmentList.onUploadComplete(e, result, null, result.atttype, null, uploadElement);
}
LEAP.attachmentList.onScanReadComplete = function(row, result)
{
	try
	{
		var _att = row[LEAP.attachmentList.n];
			//_att.title = result.title; 
			_att.name = result.name;
			_att.uuid = result.uuid;
			_att.namedpath = result.nameedPath;
			if (_att.updateType != 0)
				_att.updateType = 1;
				
			//_att.ownername = LEAP.getUserInfo().fullName;
			_att.filecount = result.filecount;
			_att.attsize = result.size;
			//_att.uploadtime = {time:Date.parse(new Date())};
		row[LEAP.attachmentList.n] = _att;
	}
	finally
	{
		_att = null;
	}
}

LEAP.attachmentList.scan = function(src)
{
	try
	{
		var element = LEAP._match(src, LEAP.attachmentList.d);
		var uploadpath = element.getAttribute('scan_uploadpath');
		if (uploadpath == null)
			uploadpath = "default";
		var sid = 'JSESSIONID=' + leapclient.getsid();
		
		var captureParams = src["captureParams"];
		
		if (captureParams == null || captureParams.pagestyle == 2)
		{			
			var quality = (element.getAttribute('scan_quality') == null)?100:element.getAttribute('scan_quality') == null;
			var maxwidth = (element.getAttribute('scan_maxwidth') == null)?0:element.getAttribute('scan_maxwidth');
			var maxheight = (element.getAttribute('scan_maxheight') == null)?0:element.getAttribute('scan_maxheight');
			var title = '新扫描件.pdf';
				
			var __url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + '&path=' + uploadpath;

			var exCapParam = "";
			if (captureParams)
			{
				exCapParam += captureParams.zoom + "&";
				exCapParam += captureParams.pagewidth + "&";
				exCapParam += captureParams.pageheight + "&";
				exCapParam += captureParams.devno + "&";
				exCapParam += captureParams.pagestyle + "&";
				exCapParam += captureParams.toplabel + "&";
				exCapParam += captureParams.bottomlabel + "&";
				exCapParam += captureParams.topbtn + "&";
				exCapParam += captureParams.bottombtn;
				exCapParam += "&1";
			}
			else
			{
				exCapParam = "1&0&0&2&2&&&扫描&扫描下一张&1";
			}
			
			var def = {uploadurl	:	__url,
			 		title		:	title,
			 		quality		:	quality,	//图片质量，默认100
			 		maxwidth	:	maxwidth,		//图片尺寸最大宽度，0不缩放
			 		maxheight	:	maxheight,		//图片尺寸最大高度，0不缩放		
			 		exCapParam	:	exCapParam,
			 		groupParams	:	"",		 		
			 		callback	:	LEAP.attachmentList.OnScanCompleted,
					callbackParam:	{scantype:"scan", scansrc:src},
					domain		:this};
		
			LEAP.Comb.scanner.scanupload(def);
		}
		else
		{
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + '&path=' + uploadpath;										
			var def = {uploadurl	:	url,
 					attname		:	captureParams.attname, 	//材料名称
 					zoom		:	captureParams.zoom == null?1:captureParams.zoom,			//缩小倍数 
					pagewidth	:	captureParams.pagewidth,		//取景宽度（像素） 
					pageheight	:	captureParams.pageheight, 		//取景高度（像素）
					pagestyle	:	captureParams.pagestyle, 		//拍摄样式（0整页1上下分栏2连续多页）
					toplabel	:	captureParams.toplabel, 		//取景框上栏提示文本 
					bottomlabel	:	captureParams.bottomlabel, 	//取景框下栏提示文本
					topbtn		:	captureParams.topbtn, 	//第一步拍摄按钮名
					bottombtn	:	captureParams.bottombtn,	//第二步拍摄按钮名
					filetype	:	1,			//多页拍摄文件类型(0-zip； 1-pdf；整页和上下分栏时为jpeg)
 					callback	:	LEAP.attachmentList.OnScanCompleted,
					callbackParam:	{scantype:"scan", scansrc:src},
					domain		:this};
			
			LEAP.Comb.scanner.snapshoot(def);
		}
	}
	finally
	{
		element = uploadpath = sid = captureParams = quality = maxwidth = maxheight = title = __url = exCapParam = def = url = null;
	}
}

LEAP.attachmentList.ScanRead = function(row)
{
	try
	{	
		var att = row[LEAP.attachmentList.n];
		var element = LEAP._match(row, LEAP.attachmentList.d);
		
		var quality = (element.getAttribute('scan_quality') == null)?100:element.getAttribute('scan_quality') == null;
		var maxwidth = (element.getAttribute('scan_maxwidth') == null)?0:element.getAttribute('scan_maxwidth');
		var maxheight = (element.getAttribute('scan_maxheight') == null)?0:element.getAttribute('scan_maxheight');
		var uploadpath = element.getAttribute('scan_uploadpath');
		var sid = 'JSESSIONID=' + leapclient.getsid();
		var readonly = (att.canEdit==true)?0:1;
		
		var title = att.title;
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&readscan=1&old_namedpath=' + att.namedpath + '&old_name=' + att.name+ '&old_uuid=' + att.uuid + '&sid=' + leapclient.getsid() + '&path=' + uploadpath;
		var exCapParam = "1&0&0&2&2&&&扫描&扫描下一张";
		
		var downloadUrl = LEAP.attachmentList._getPath(att, element);
		if (downloadUrl.endWith('.zip'))
		{
			downloadUrl = downloadUrl.substring(0, downloadUrl.length-4);
			downloadUrl += '/';
			title = att.title.endWith('.zip')?att.title:att.title+'.zip';
		}
		else
		{
			title = att.title.endWith('.pdf')?att.title:att.title+'.pdf';
			uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&readscan=1&old_namedpath=' + att.namedpath + '&old_name=' + att.name+ '&old_uuid=' + att.uuid + '&sid=' + leapclient.getsid() + '&path=' + uploadpath;
			exCapParam = "1&0&0&2&2&&&扫描&扫描下一张&1";
		}
		
		var def = {	uploadurl	:	uploadurl,
			 		downloadUrl	:	downloadUrl,
			 		filecount	:	att.filecount,	
			 		title		:	title.replaceall(" ",""),
			 		readonly	:	readonly,	
			 		quality		:	quality,
			 		maxwidth	:	maxwidth,
			 		maxheight	:	maxheight,
			 		exCapParam	:	exCapParam,
			 		callback	:	LEAP.attachmentList.OnScanCompleted,
					callbackParam:	{scantype:"scanread", scanreadrow:row},
					domain		:this};
					
		LEAP.Comb.scanner.scanread(def);
	}
	finally
	{
		att = element = quality = maxwidth = maxheight = uploadpath = readonly = title = uploadurl = exCapParam = downloadUrl = def = null;
	}
}

LEAP.attachmentList.OnScanCompleted = function(arg, value, result, count)
{
	try
	{
		if (arg == null || arg.value != 1)
			return;
		
		var type = arg.param.scantype;
		
		if (arg.result != null && arg.result != '')
		{
			var uri = JSON.parse(arg.result);
			uri.filecount = arg.count;
			
			if (type == "scanread")
			{	
				var row = arg.param.scanreadrow;	
				var old = row[LEAP.attachmentList.n];
				
				uri.atttype = old.atttype;
				
				LEAP.attachmentList.onScanReadComplete(row, uri);
			}
			else if (type == "scan")
			{
				var src = arg.param.scansrc;
				var element = LEAP._match(src, LEAP.attachmentList.d);
				
				uri.atttype = LEAP.attachmentList.symbol.SM; 
				if ((!uri.name.endWith('.zip')) && (!uri.name.endWith('.pdf')))
					uri.atttype = LEAP.attachmentList.symbol.FJ;
				
				LEAP.attachmentList.onScanComplete(element, uri, src);			
			}
		}
	}
	finally
	{
		type = uri = row = old = src = element = null;
	}
}

LEAP.attachmentList.setUploadPath = function(element, uploadPath, scanUploadPath)
{
	element = LEAP._match(element, LEAP.attachmentList.d);
	if (uploadPath != null)
		element.setAttribute("uploadpath", uploadPath);
	if (scanUploadPath != null)
		element.setAttribute("scan_uploadpath", scanUploadPath);
}

LEAP.attachmentList.setFixItems = function(element, option, reload)
{
	element = LEAP._match(element, LEAP.attachmentList.d);
	if (element)
	{
		if (option == null)
		{
			element.setAttribute("_fixitems", '');
		}
		else
		{			
			if (option.uploadpath != null)
				element.setAttribute("uploadpath", option.uploadpath);
			if (option.scan_uploadpath != null)
				element.setAttribute("scan_uploadpath", option.scan_uploadpath);
			if (option.defaultcolor != null)
				element.setAttribute("defaultcolor", option.defaultcolor);
			if (option.uploadcolor != null)
				element.setAttribute("uploadcolor", option.uploadcolor);			
			if (option.readonly)
				LEAP.attachmentList.setReadonly(element, (option.readonly==true)?"1":"0", false);				
			if (option.groupid != null)
				element.setAttribute("_fixgroupid", option.groupid);
			else
				element.removeAttribute("_fixgroupid");
			if (option.items != null)
				element['_fixitems'] = option.items;
			else
				element.setAttribute("_fixitems", "");
			if (option.cols != null)
				element['_columns'] = option.cols;
			else
				element['_columns'] = "";
								
			if (option.uploadbuttons != null)
				element['_buttons'] = option.uploadbuttons;
			else
				element.setAttribute("_buttons", 'word,att,scan');	
			
			if (option.exstatus != null && option.exstatus!='')
			{
				var arr = option.exstatus.split(',');
				for(var i=0; i<arr.length; i++)
				{
					var s = arr[i];
					var idx = s.indexof(':');
					arr[i] = {value: s.substring(0,idx).trim(), title :s.substring(idx+1,s.length).trim()};
				}				
				element['exstatus'] = arr;
			}
			if (option.exflags != null && option.exflags!='')
			{
				var arr = option.exflags.split(',');
				for(var i=0; i<arr.length; i++)
				{
					var s = arr[i];
					var idx = s.indexof(':');
					arr[i] = {value: s.substring(0,idx).trim(), title :s.substring(idx+1,s.length).trim()};
				}				
				element['exflags'] = arr;
			}			
			if (option.exflagFilter)
				element['exflagFilter'] = option.exflagFilter;		
			if (option.exflagDisplay != null)
				element['exflagDisplay'] = option.exflagDisplay;
			if (option.defaultExflag != null)
				element['defaultExflag'] = option.defaultExflag;
			if (option.currentStep != null)
				element['_currentStep'] = option.currentStep;
				
			if (option.afterUpload)
				element['afterUpload'] = option.afterUpload;
		}
		
		if (reload == true)
			LEAP.attachmentList.__i(element, true);
	}
}

LEAP.attachmentList.setExistAttachements = function(_element, atts)
{
	try
	{
		var element = LEAP._match(_element, LEAP.attachmentList.d);
		if (element == null)
			return;
			
		LEAP.attachmentList.__i(element, true);
		
		if (atts == null)
			return;
		
		var _table = LEAP.getElement("table[ctf=" + LEAP.attachmentList.ctf.atttable + "]", element);	
		if (_table == null)
			return;
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attachmentList.ctf.attrow + "]", _table);
		if (rows == null)
			return;
		
		for(var i=0; i<atts.length; i++)
		{
			var _a = atts[i];			
			var code = _a.attcode; 
			if (code == null)
				continue;
			
			for(var k=0; k<rows.length; k++)
			{
				var row = rows[k];				
				var _att = row[LEAP.attachmentList.n];
				var _att2 = _a;
				if (_att == null || _att.fixitemcode != code || _att.id != null)
					continue;
					
				_att2.atttype = (_a.atttype == null) ? 0 : _a.atttype;	
				_att2.fileid = _a.fileid; 
				_att2.title = _a.title; 
				_att2.name = _a.name;
				_att2.uuid = _a.uuid;
				_att2.namedpath = _a.namedpath;
				_att2.updateType = 0;
				_att2.ownername = LEAP.getUserInfo().fullName;
				_att2.filecount = _a.filecount;				
				_att2.uploadtime = (_a.uploadtime == null)? {time:LEAP.getUserInfo().getTimeTicket()}:_a.uploadtime;
				_att2.canDelete = (_a.canDelete == null)?true:_a.canDelete;
				_att2.canEdit = (_a.canEdit == null)?true:_a.canDelete;

				LEAP.attachmentList._bindItemDetail(element, _att2, _table, false);
									
				/*_att.atttype = (_a.atttype == null) ? 0 : _a.atttype;				 
				_att.title = _a.title; 
				_att.name = _a.name;
				_att.uuid = _a.uuid;
				_att.namedpath = _a.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;
				_att.filecount = _a.filecount;				
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = (_a.canDelete == null)?true:_a.canDelete;
				_att.canEdit = (_a.canEdit == null)?true:_a.canDelete;
						
				LEAP.attachmentList._bindItemDetail(element, _att, _table, false);*/
				
				break;
			}			
		}
	}
	finally
	{
		element = _table = rows = i = _a = k = row = _att = null;
	}
		
}

LEAP.attachmentList._getColumns = function(e)
{	
	if (e['_columns'] && e['_columns'] != "")
	{
		return e['_columns'];
	}
	else
	{
		return [{title:'序号', width:'50px', md:LEAP.attachmentList.col.sn}, 
							{title:'附件名称', width:'40%', md:LEAP.attachmentList.col.name},
							{title:'上传者', width:'15%', md:LEAP.attachmentList.col.uploader},
							{title:'上传环节', width:'10%', md:LEAP.attachmentList.col.uploadstep},
							{title:'上传时间', width:'100px', md:LEAP.attachmentList.col.uploadtime},
							{title:'大小', width:'50px', md:LEAP.attachmentList.col.size},
							{title:'操作', width:'5%', md:LEAP.attachmentList.col.operation} 
							];
	}
}

LEAP.attachmentList.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;

	LEAP.attachmentList._i(src);
	
	if (src.parentElement)
		src.parentElement.removeChild(src);
}

LEAP.attachmentList._i = function(src)
{
	try
	{
		var _element = LEAP._match(src, LEAP.attachmentList.d);
		if (_element == null)
			return;
		
		var auto = _element.getAttribute('autoinit');
		if (auto != null && auto==0)
		{}
		else
		{
			LEAP.attachmentList.__i(_element);
		}
	}
	finally
	{
		_element = null;
	}
}

LEAP.attachmentList.__i = function(_element, forceInit)
{
	try
	{
		if ("1" == _element["hasinit"] && (forceInit == null || forceInit == false))
		{
			return;
		}
		
		_element.setAttribute('_height', _element.offsetHeight);
		
		_element['hideZW'] = true;
		
		var  _fixitems = _element['_fixitems'];
		if (_fixitems == "")
			_fixitems = null;
		var _buttons = _element['_buttons'];
		if (_buttons == null)
			_buttons = ",att,scan,";
		
		var _readonly = _element.getAttribute('readonly');
		if (_readonly && _readonly=='1')
			_readonly = true;
		else
			_readonly = false;
		
				
		var _btnframe = LEAP.getElement("div.wfcontrol_attachmentList_btnframe", _element);
		if (!_fixitems && !_btnframe)
		{
			_btnframe = document.createElement('div')
			_btnframe.className = 'wfcontrol_attachmentList_btnframe';

			//var str = "<a pp='scan' tct='attachmentList' ct='capture' cap_type=2 href='javascript:' style='float:right;font-weight:bold;font-size:14px;'>扫描上传</a>"
			var str = "<a pp='scan' ctf='scanbtn' href='javascript:' style='float:right;font-weight:bold;font-size:14px;'>扫描上传</a>"
				str += "<div pp='att' tct='attachmentList' ct='uploadbtn' quality='100' showtext='上传附件' imgwidth=73 imgheight=27 img='LEAP/LWFP/StyleSheet/control/images/attachmentList/uploadbtn.png' userpar='0' style='width:80px; height:23px; float:right; display:inline-block;cursor:Pointer;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(200);'></div>";
			
			_btnframe.innerHTML = str;
			_element.appendChild(_btnframe);			
		}
		
		if (_btnframe)
		{
			var btn = LEAP.getElement("div[pp=att]", _btnframe);
				if (btn && (_buttons.indexOf("att")<0 || _readonly==true) )
					btn.style.display = "none";
				
			btn = LEAP.getElement("a[pp=scan]", _btnframe);
			if (btn && (_buttons.indexOf("scan")<0 || _readonly==true) )
				btn.style.display = "none";
		}

		
		var _columns = LEAP.attachmentList._getColumns(_element);
			
		var _table = LEAP.getElement("table.wfcontrol_attachmentList_table", _element);
		if (!_table)
		{	
			_table = document.createElement("table");
			_table.setAttribute('ctf', LEAP.attachmentList.ctf.atttable);
			_table.className = "wfcontrol_attachmentList_table";
			_table.cellSpacing = 0;			
				
			_element.appendChild(_table);			
		}
		else
		{
			for(var i=_table.rows.length-1; i>-1; i--)
				_table.deleteRow(i);
		}
		
		var _tr = _table.insertRow();
			
		for(var i=0; i<_columns.length; i++)
		{
			var _th = _tr.insertCell();
			_th.className = "wfcontrol_attachmentList_table_th";
			_th.innerText = _columns[i].title;
			_th.style.width = _columns[i].width;
		}
		
		_table.style.display = "none";
		
		if (_fixitems)
		{			
			for(var i=0; i<_fixitems.length; i++)
			{
				var _att = _fixitems[i];
					_att.fixitemcode = _fixitems[i].code;
					_att.fixitemname = _fixitems[i].name;
					_att.fixitemmulti = _fixitems[i].multifile;		
					_att.defaultcolor = (_fixitems[i].defaultcolor == null)?'#000000':_fixitems[i].defaultcolor;
					_att.uploadcolor = (_fixitems[i].uploadcolor == null)?'#1E50D2':_fixitems[i].uploadcolor;
					_att.types = _fixitems[i].types;
					_att.typesdesc = _fixitems[i].typesdesc;
					_att.isFixItem = true;					
					
				LEAP.attachmentList.insert(_element, _att);
			}
			
			if (_btnframe)
				_btnframe.style.display = "none";
		}
		
		if (_btnframe && _buttons == "")
			_btnframe.style.display = "none";
			
		_element["hasinit"] = "1";
	}
	finally
	{
		_fixitems = _buttons = _readonly = _btnframe = str = btn = _table = _tr = _th = i = _att = null;
	}
}

LEAP.attachmentList.init();


/**
 * 工具栏
 * @class LWFP.banner control
 * @type user control
 * @example
 
HTML定义:
			<div class='wf_banner' ct='banner'>
				<div class='wf_banner_title'>
					<font style='float:left;'>小纸条</font>
					<a class='wf_banner_icon_collapse' style='float:right;width:16px;' ctf='icon'>&nbsp;</a>
				</div>
				<div class='wf_banner_content' ctf='content'>
					
				</div>
			</div>

示例：


标签:
	
	
*/

LWFP.banner = {};
LWFP.banner.d = 'banner';
LWFP.banner.init = function()
{
	if (document != null && document.body != null)
		LWFP.banner._init();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.banner._init);	
}
LWFP.banner._init = function()
{		
	LEAP.addEvent(document.body, 'click', LWFP.banner.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LWFP.banner._init);
}
LWFP.banner.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		var element = LEAP._match(src, LWFP.banner.d);
		if (null == element) 
			return;
			
		var title = LEAP._match(src, "wf_banner_title", "class");
		if (title == null)
			return;
			
		var contentFlag = element.getAttribute("contentControl");

		var icon = LEAP.getElement("[ctf=icon]", element);
		var icon1 = LEAP.getElement("[ctf=icon1]", element);
		var con = LEAP.getElement("div[ctf=content]", element);
		
		if (contentFlag)
		{
			var range = null;
			var module = LWFP.innerApi.getmodule(element);
			if (module)
				range = module.moduleElement;
				
			con = LEAP.getElement("[bannerContentFlag=" + contentFlag + "]",  range);					
		}
		
		if (icon.className == 'wf_banner_icon_collapse')
		{
			con.style.display = 'none';
			icon.className = 'wf_banner_icon_expand';
			if (element.getAttribute("icon_expand"))
				icon.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon_expand") + ") no-repeat left center";

			if (icon1)
			{
				icon1.className = 'wf_banner_icon_expand1';
				if (element.getAttribute("icon1_expand"))
					icon1.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon1_expand") + ") no-repeat left center";
			}
		}
		else if (icon.className == 'wf_banner_icon_expand')
		{
			con.style.display = ((element.getAttribute("contentDisplayCSS")) ? element.getAttribute("contentDisplayCSS") : 'inline-block');
			
			icon.className = 'wf_banner_icon_collapse';
			if (element.getAttribute("icon_collapse"))
				icon.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon_collapse") + ") no-repeat left center";
			
			if (icon1)
			{
				icon1.className = 'wf_banner_icon_collapse1';
				if (element.getAttribute("icon1_collapse"))
					icon1.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon1_collapse") + ") no-repeat left center";
			}
		}
	
	}
	finally
	{
		src = element = title = icon = icon1 = con = null;
	}
}

/**
 * 
 * @param {} element
 * @param {} type	0折叠 1展开
 */
LWFP.banner.folding = function(_element, type)
{
	try
	{
		var element = LEAP._match(_element, LWFP.banner.d);
		if (null == element) 
			return;
		
		var icon = LEAP.getElement("[ctf=icon]", element);
		var icon1 = LEAP.getElement("[ctf=icon1]", element);
		var con = LEAP.getElement("div[ctf=content]", element);
		
		if (type == 1)
		{
			con.style.display = 'none';
			icon.className = 'wf_banner_icon_expand';
			if (element.getAttribute("icon_expand"))
				icon.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon_expand") + ") no-repeat left center";

			if (icon1)
			{
				icon1.className = 'wf_banner_icon_expand1';
				if (element.getAttribute("icon1_expand"))
					icon1.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon1_expand") + ") no-repeat left center";
			}
		}
		else if (type == 0)
		{
			con.style.display = 'block';
			icon.className = 'wf_banner_icon_collapse';
			if (element.getAttribute("icon_collapse"))
				icon.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon_collapse") + ") no-repeat left center";
			
			if (icon1)
			{
				icon1.className = 'wf_banner_icon_collapse1';
				if (element.getAttribute("icon1_collapse"))
					icon1.style.background = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + element.getAttribute("icon1_collapse") + ") no-repeat left center";
			}
		}
		
	}
	finally
	{
		element = icon = icon1 = con = null;
		
	}
}


LWFP.banner.init();











/**
 * 动作按钮栏组
 * @class LWFP.ButtonGroup control
 * @type user control
 * @example
 
HTML定义:
<DIV class="wfrunningui_btn_group" ct="lwfpbuttongroup" style="FLOAT:left; WIDTH:100%;HEIGHT: 30px; display:none;">
	<fieldset>
		<legend>操作</legend>	
		<DIV class="wfrunningui_btn_frame" ct="lwfpbuttonframe" style="FLOAT:left; WIDTH:100%;HEIGHT: 30px;">
		</DIV>
	</fieldset>
</DIV>

JS定义:

获取: 
	根据自定义标签获取:var btnFrame = this.getUT('controlName');

方法：

事件:

标签:

*/


LWFP.ButtonGroup = {};
LWFP.ButtonGroup.d = 'lwfpbuttongroup';
LWFP.ButtonGroup.groupInstance = '_lwfpButtonGroupInstance';
LWFP.ButtonGroup.init = function()
{
	/*if (document != null && document.body != null)
		LWFP.ButtonGroup._init();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.ButtonGroup._init);*/
}

LWFP.ButtonGroup.initGroups = function(_instance, _element)
{
	var btnGroups = LEAP.getElements("div[ct=" + LWFP.ButtonGroup.d + "][instance=" + _instance + "]", _element);
	LWFP.ButtonGroup.initButtonFrame(btnGroups);
	
	btnGroups = null;
}

LWFP.ButtonGroup.initButtonFrame = function(groups)
{
	if (groups == null || groups.length <=0)
		return;

	try
	{
		for(var i=0; i<groups.length; i++)
		{
			var g = groups[i];			
			var id = UUID.cID();
			g.setAttribute(LWFP.ButtonGroup.groupInstance, id);
			var btnFrames = LEAP.getElements("div[ct=" + LWFP.ButtonFrame.d + "]", g);
			if (btnFrames != null && btnFrames.length>0)
			{
				for(var k=0; k<btnFrames.length; k++)
				{
					btnFrames[k].setAttribute(LWFP.ButtonGroup.groupInstance, id);
				}
			}
			g.style.display = "none";
		}
	}
	finally
	{
		i = g = id = btnFrames = k = null;		
	}
}

LWFP.ButtonGroup.show = function(e, _element)
{
	try
	{
		var cid = e.getAttribute(LWFP.ButtonGroup.groupInstance);
		if (cid == null || cid == "")
			return;

		var g = LEAP.getElement("div[ct=" + LWFP.ButtonGroup.d + "][" + LWFP.ButtonGroup.groupInstance + "=" + cid + "]", _element);
		g.style.display = "block";		
	}
	finally
	{
		cid = g = null;
	}	
}





/**
 * 动作按钮栏
 * @class LWFP.ButtonFrame control
 * @type user control
 * @example
 
HTML定义:
<DIV class="wfrunningui_btn_frame" ut="controlName" ct="lwfpbuttonframe" 
	_actionName='' 
	_flowOptionName='' 
	_jsName='' 
	_type='' 
	style="FLOAT:left; WIDTH:100%;HEIGHT: 30px;"></DIV>

示例一：图标按钮样式
<DIV class="wfrunningui_btn_group wfrunningui_btn_group_iconButton" ct="lwfpbuttongroup" style="FLOAT:left; WIDTH:100%;">
	<DIV class="wfrunningui_btn_frame wfrunningui_btn_group_iconButton" ct="lwfpbuttonframe" style="FLOAT:left; WIDTH:100%;">
	</DIV>
</DIV>

示例二：普通系统按钮样式
<DIV class="wfrunningui_btn_group" ct="lwfpbuttongroup" style="FLOAT:left; WIDTH:100%;HEIGHT: 30px; display:none;">
	<fieldset>
		<legend>操作</legend>	
		<DIV class="wfrunningui_btn_frame" ct="lwfpbuttonframe" _style='1' style="FLOAT:left; WIDTH:100%;HEIGHT: 30px;">
		</DIV>
	</fieldset>
</DIV>

JS定义:

获取: 
	根据自定义标签获取:var btnFrame = this.getUT('controlName');

方法：
	1、显示指定的按钮：显示指定名称的按钮,隐藏指定名称之外的按钮
	LWFP.ButtonFrame.setDisplayButtons = function(element:lwfpbuttonframe插件, names：要显示的名称，多名称间已";"号分隔)	
	
事件:

标签:
	_actionName: 动作名称，多个名称间以“;”号分隔，设置了该标签意味着只显示对应的动作按钮
	_type: 指定显示按钮类型（0动作按钮1全局操作按钮2JS扩展按钮）,没有该标签意味着显示所有合法按钮及固定按钮,该限制优先级别高于：_actionName,_flowOptionName,_jsName 
	_flowOptionName: 全局操作名称，多个名称间以“;”号分隔，设置了该标签意味着只显示对应的全局操作按钮
	_jsName: JS扩展名，多个名称间以“;”号分隔，设置了该标签意味着只显示对应的JS扩展功能按钮
	_style: 按钮样式(0图标按钮；1普通按钮),默认为图标按钮
*/


LWFP.ButtonFrame = {};
LWFP.ButtonFrame.d = 'lwfpbuttonframe';
LWFP.ButtonFrame.n = 'data';
LWFP.ButtonFrame.bc = 'lwfpbutton';
LWFP.ButtonFrame.bn = '_btnname';
LWFP.ButtonFrame.t = '_type';
LWFP.ButtonFrame.symbol ={save:1, pullback:2,pushback:3,js:4,option:5,action:6,aheadaction:7,smallnote:8};
LWFP.ButtonFrame.init = function()
{
	if (document != null && document.body != null)
		LWFP.ButtonFrame._init();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.ButtonFrame._init);

	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnSave');
	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnPullback');
	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnPushback');	
	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnJsFuncButtonClick');
	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnFlowOptionClick');
	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnActionButtonClick');
	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnAheadActionButtonClick');	
	ElementEventManager.addManagedEventType(LWFP.ButtonFrame.d, 'OnSmallNoteClick');	
}
LWFP.ButtonFrame._init = function()
{		
	LEAP.addEvent(document.body, 'click', LWFP.ButtonFrame.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LWFP.ButtonFrame._init);
}

LWFP.ButtonFrame.uiProcess = function(arg)
{		
	try
	{		
		var src = arg.e.srcElement;
		if (null == src) return;
		var __element = LEAP._match(src, LWFP.ButtonFrame.d);
		if(null == __element) return;		
		var element = LEAP._match(src, LWFP.ButtonFrame.bc);
		if(null == element) return;
		
		var __type = element.getAttribute(LWFP.ButtonFrame.t);
		var __data = element[LWFP.ButtonFrame.n];
		
		if (__type == LWFP.ButtonFrame.symbol.save)
			ElementEventManager.handleEvent(__element, "OnSave")
		else if (__type == LWFP.ButtonFrame.symbol.pullback)
			ElementEventManager.handleEvent(__element, "OnPullback")
		else if (__type == LWFP.ButtonFrame.symbol.pushback)		
			ElementEventManager.handleEvent(__element, "OnPushback")
		else if (__type == LWFP.ButtonFrame.symbol.js)		
			ElementEventManager.handleEvent(__element, "OnJsFuncButtonClick", {data:__data})
		else if (__type == LWFP.ButtonFrame.symbol.option)		
			ElementEventManager.handleEvent(__element, "OnFlowOptionClick", {data:__data})
		else if (__type == LWFP.ButtonFrame.symbol.action)		
			ElementEventManager.handleEvent(__element, "OnActionButtonClick", {data:__data})
		else if (__type == LWFP.ButtonFrame.symbol.aheadaction)		
			ElementEventManager.handleEvent(__element, "OnAheadActionButtonClick", {data:__data})
		else if (__type == LWFP.ButtonFrame.symbol.smallnote)
			ElementEventManager.handleEvent(__element, "OnSmallNoteClick")				
	}
	finally
	{
		src = __element = element = __type = __data = null;
	}
}

LWFP.ButtonFrame.setDisplayButtons = function(element, names)
{
	if (element == null || names == null)
		return null;
		
	var e = LEAP._match(element, LWFP.ButtonFrame.d);
	if (e == null) return;		
	var arr = names.split(";");
	
	var btns = LEAP.getElements("div[ctf=" + LWFP.ButtonFrame.bc + "]", e);
	if (btns == null)
		return;
		
	for(var i=0; i<btns.length; i++)
	{		
		var name = btns[i].getAttribute(LWFP.ButtonFrame.bn);
		if (arr.indexof(name)>=0)
			btns[i].style.display = "";
		else
			btns[i].style.display = "none";
	}
	
	e = arr = btns = i = name = null;	
}

LWFP.ButtonFrame.getButtonData = function(e)
{
	try
	{
		if (e == null)
			return null;

		return e[LWFP.ButtonFrame.n];
	}
	catch(e)
	{
		alert(e.message);
		return null;
	}
}

LWFP.ButtonFrame.loadButton = function(e, data, btnCache, domain)
{	
	try
	{
		var _btn;
		var _actions = data.nextActions;	//可显示的动作按钮
		var _funcs = data.stepJsFuncs;
		var _ops = data.flowOptions;
		var hasButton = false;
		var _style = 0;
		
		var _s = e.getAttribute('_style');
		if (_s != null)	_s = _s.Trim();
		if (_s == "1") _style = _s;
		
		if (_actions != null && _actions.length >0 && data.module != null && data.module.modulename != null) //环节有表单
		{
			if (data.flow.actioncheck == 0)
			{
				if (data.currentStep.recid == null || 
						(data.currentStep.recid != null && data.currentStep.issuspended!= null && data.currentStep.issuspended==1))
				{
					if (_actions != null && _actions.length >0)
					for(var i=_actions.length-1; i>=0; i--)
					{
						if (_actions[i].runahead == null || _actions[i].runahead == 0 )
							_actions.removeindex(i);
					}
				}
			}
			else if (data.flow.actioncheck == 1){}
			else if (data.flow.actioncheck == 2)
			{
				if (data.currentStep.recid == null || 
						(data.currentStep.recid != null && data.currentStep.issuspended!= null && data.currentStep.issuspended==1))
				{
					if (_actions != null && _actions.length >0)
					for(var i=_actions.length-1; i>=0; i--)
					{
						if (_actions[i].validateclassname != null || _actions[i].validateshellcodeid != null)
							_actions.removeindex(i);
					}
				}
			}
			if (_actions.length<=0)
				_actions = null;
		}
		
		
		var hasLimit = LWFP.ButtonFrame.hasLimit(e, data);
		if (hasLimit == false) //如果没有指定按钮类型和名称
		{	
			//保存
			if (data.module != null && data.module.modulename != null)
			{
				var _n = "保存";
				if (data.flow.savebtn != null && data.flow.savebtn != "")
					_n = data.flow.savebtn;
					
				if (_style == 0)
					_btn = LWFP.ButtonFrame.createIconButton(e, _n, null, "wfrunningui_iconbutton_icon_save", LWFP.ButtonFrame.symbol.save);
				else if (_style == 1)
					_btn = LWFP.ButtonFrame.createButton(e, _n, null, LWFP.ButtonFrame.symbol.save);
				
				hasButton = true;
			}
			//回收
			if (data.pullbackSteps != null)
			{
				if (_style == 0)
					_btn = LWFP.ButtonFrame.createIconButton(e, "回收", null, "wfrunningui_iconbutton_icon_pullback", LWFP.ButtonFrame.symbol.pullback);
				else if (_style == 1)
					_btn = LWFP.ButtonFrame.createButton(e, "回收", null, LWFP.ButtonFrame.symbol.pullback); 
				hasButton = true;
			}
			//退回
			if (data.userToPushBack != null)
			{
				if (_style == 0)
					_btn = LWFP.ButtonFrame.createIconButton(e, "退回", null, "wfrunningui_iconbutton_icon_pushback", LWFP.ButtonFrame.symbol.pushback);
				else if (_style == 1)
					_btn = LWFP.ButtonFrame.createButton(e, "退回", null, LWFP.ButtonFrame.symbol.pushback); 

				hasButton = true;
			}
			//
			if (_funcs != null)
			{
				if (_style == 0)
					LWFP.ButtonFrame.createSeparator(e);
				for(var i=0; i<_funcs.length; i++)
				{
					if ( btnCache.indexof(_funcs[i].id)<0 )
					{
						if (_style == 0)
							_btn = LWFP.ButtonFrame.createIconButton(e, _funcs[i].func.funcname, _funcs[i].func, null, LWFP.ButtonFrame.symbol.js);
						else if (_style == 1)
							_btn = LWFP.ButtonFrame.createButton(e, _funcs[i].func.funcname, _funcs[i].func, LWFP.ButtonFrame.symbol.js); 	
					}
				}
				hasButton = true;
			}
			//		
			if (_ops != null)
			{
				if (_style == 0)
					LWFP.ButtonFrame.createSeparator(e);
				for(var i=0; i<_ops.length; i++)
				{
					if ( btnCache.indexof(_ops[i].foid)<0 )
					{
						if (_style == 0)
							_btn = LWFP.ButtonFrame.createIconButton(e, _ops[i].opname, _ops[i], null, LWFP.ButtonFrame.symbol.option);
						else if (_style == 1)
							_btn = LWFP.ButtonFrame.createButton(e, _ops[i].opname, _ops[i], LWFP.ButtonFrame.symbol.option); 			
					}
				}
				hasButton = true;
			}
			//
			if (_actions != null && _actions.length>0)
			{
				if (_style == 0)
					LWFP.ButtonFrame.createSeparator(e);
				for(var i=0; i<_actions.length; i++)
				{
					if ( btnCache.indexof(_actions[i].actionid)<0 )
					{
						var ___type = -1;
						if ((_actions[i].runahead != null && _actions[i].runahead == 1) || _actions[i].moduleName != null)
							___type = LWFP.ButtonFrame.symbol.aheadaction;
						else 
							___type = LWFP.ButtonFrame.symbol.action;
						
						if (_style == 0)						
							_btn = LWFP.ButtonFrame.createIconButton(e, _actions[i].aliasname, _actions[i], null, ___type);
						else if (_style == 1)
							_btn = LWFP.ButtonFrame.createButton(e, _actions[i].aliasname, _actions[i], ___type);
					}
				}
				hasButton = true;
			}
			
			//小纸条
			if (data.currentStep != null && data.currentStep.smallnote != null)
			{
				_btn = LWFP.ButtonFrame.createIcon(e, "小纸条", data.currentStep, "wfrunningui_btn_smallnote", "right", LWFP.ButtonFrame.symbol.smallnote);
				hasButton = true;
			}
		}
		else
		{
			var _type = e.getAttribute("_type");
			if (_type != null) _type = _type.Trim();
			if (_type != "0" && _type != "1" && _type != "2") _type = null;
						
			var __names = null;  //0动作按钮1全局操作按钮2JS扩展按钮
			var __arr = null;
			
			if (_type == null || _type == "2")
			{
				__names = LWFP.innerApi.String2Arr(e.getAttribute("_jsName"), ";", false);
				__arr = LWFP.ButtonFrame.matchFunc(_funcs, __names, btnCache);
				if (__arr != null)
				{
					if (_style == 0)
						LWFP.ButtonFrame.createSeparator(e);
					for(var i=0; i<__arr.length; i++)
					{
						if (_style == 0)
							_btn = LWFP.ButtonFrame.createIconButton(e, __arr[i].func.funcname, __arr[i].func, null, LWFP.ButtonFrame.symbol.js);
						else if (_style == 1)
							_btn = LWFP.ButtonFrame.createButton(e, _funcs[i].func.funcname, _funcs[i].func, LWFP.ButtonFrame.symbol.js);
						btnCache.add(__arr[i].id);
					}
					hasButton = true;
				}
			}
			
			if (_type == null || _type == "1")
			{
				__names = LWFP.innerApi.String2Arr(e.getAttribute("_flowOptionName"), ";", false);
				__arr = LWFP.ButtonFrame.matchOption(_ops, __names, btnCache);
				if (__arr != null)
				{
					if (_style == 0)
						LWFP.ButtonFrame.createSeparator(e);
					for(var i=0; i<__arr.length; i++)
					{
						if (_style == 0)
							_btn = LWFP.ButtonFrame.createIconButton(e, __arr[i].opname, __arr[i], null, LWFP.ButtonFrame.symbol.option);
						else if (_style == 1)
							_btn = LWFP.ButtonFrame.createButton(e, __arr[i].opname, __arr[i], LWFP.ButtonFrame.symbol.option);
						btnCache.add(__arr[i].foid);
					}
					hasButton = true;
				}
			}
			
			if (_type == null || _type == "0")
			{
				__names = LWFP.innerApi.String2Arr(e.getAttribute("_actionName"), ";", false);
				__arr = LWFP.ButtonFrame.matchAction(_actions, __names, btnCache);
				if (__arr != null)
				{
					if (_style == 0)
						LWFP.ButtonFrame.createSeparator(e);
					for(var i=0; i<__arr.length; i++)
					{	
						var ___type = -1;
						if ((_actions[i].runahead != null && _actions[i].runahead == 1) || _actions[i].moduleName != null)
							___type = LWFP.ButtonFrame.symbol.aheadaction;
						else 
							___type = LWFP.ButtonFrame.symbol.action;
							
						if (_style == 0)
							_btn = LWFP.ButtonFrame.createIconButton(e, __arr[i].aliasname, __arr[i], null, ___type);
						else if (_style == 1)
							_btn = LWFP.ButtonFrame.createButton(e, __arr[i].aliasname, __arr[i], ___type);
							
						btnCache.add(__arr[i].actionid);
					}
					hasButton = true;
				}
			}
		}
		
		if (hasButton == true)
		{
			e.style.display = "block";
			LWFP.ButtonGroup.show(e, domain.formElement);
		}
			
	}
	finally
	{
		_btn = _actions = _funcs = _ops = hasButton = _style = _s = i = hasLimit = _n = _type = __names = __arr = ___type = null;
	}
	
}

LWFP.ButtonFrame.matchFunc = function(funcs, names, cache)
{
	if (funcs == null || funcs.length<=0 || names == null || names.leng<=0)
		return null;
	
	try
	{
		var arr = new Array();
		for(var i=0; i<names.length; i++)
		{
			for(var k=0; k<funcs.length; k++)
			{
				if (funcs[k].funcname == names[i] && cache.indexof(funcs[k].id)<0 )
					arr.add(funcs[k]);
			}
		}
		if (arr.length <=0)
			return null;
		else
			return arr;
	}
	finally
	{
		arr = i = k = null;		
	}	
}
LWFP.ButtonFrame.matchOption = function(ops, names, cache)
{
	if (ops == null || ops.length<=0 || names == null || names.leng<=0)
		return null;
	
	try
	{
		var arr = new Array();
		for(var i=0; i<names.length; i++)
		{
			for(var k=0; k<ops.length; k++)
			{
				if (ops[k].opname == names[i] && cache.indexof(ops[k].foid)<0 )
					arr.add(ops[k]);
			}
		}
		if (arr.length <=0)
			return null;
		else
			return arr;
	}
	finally
	{
		arr = i = k = null;		
	}	
}
LWFP.ButtonFrame.matchAction = function(actions, names, cache)
{
	if (actions == null || actions.length<=0 || names == null || names.leng<=0)
		return null;
	
	try
	{
		var arr = new Array();
		for(var i=0; i<names.length; i++)
		{
			for(var k=0; k<actions.length; k++)
			{
				if (actions[k].actionname == names[i] && cache.indexof(actions[k].actionid)<0 )
					arr.add(actions[k]);
			}
		}
		if (arr.length <=0)
			return null;
		else
			return arr;
	}
	finally
	{
		arr = i = k = null;		
	}	
}

LWFP.ButtonFrame.createSeparator= function(_e)
{
	var _div = document.createElement("div");
		_div.className = 'wfrunningui_btn_Separator';
	
	_e.appendChild(_div);
	_div = null;
}

LWFP.ButtonFrame.createIconButton = function(_e, _name, _data, _cls, _type)
{
	try
	{
		var _div = document.createElement("div");
			_div.className = 'wfrunningui_iconbutton';
			_div.setAttribute("ct", LWFP.ButtonFrame.bc);
			_div.setAttribute(LWFP.ButtonFrame.bn, _name);
			_div.setAttribute(LWFP.ButtonFrame.t, _type);
			if (_data != null)
				_div[LWFP.ButtonFrame.n] = _data;	
		var _a = document.createElement("a");
		var _b = document.createElement("b");
			_b.className = (_cls == null)? "wfrunningui_iconbutton_icon_default" : _cls;
		var _span = document.createElement("span");			
			_span.setAttribute("ctf", "button");
			_span.innerText = _name;

		_a.appendChild(_b);
		_a.appendChild(_span);
		_div.appendChild(_a);
		_e.appendChild(_div);
		
		return _span;
	}
	finally
	{
		_div = _a = _b = _span = null;
	
	}
}

LWFP.ButtonFrame.createButton = function(_e, _name, _data, _type)
{
	try
	{
		var _div = document.createElement("div");
			_div.className = 'button_frame';
			_div.style.styleFloat = "left";
			_div.setAttribute("ct", LWFP.ButtonFrame.bc);
			_div.setAttribute(LWFP.ButtonFrame.bn, _name);
			_div.setAttribute(LWFP.ButtonFrame.t, _type);
			if (_data != null)
				_div.setAttribute(LWFP.ButtonFrame.n, _data);			
		var _a = document.createElement("a");
			_a.className = 'button';
			_a.href = 'javascript:void(0)';
		var _p = document.createElement("p");
		var _span = document.createElement("span");
			_span.className = "";
			_span.setAttribute("ctf", "button");
			_span.innerText = _name;
			
		_a.appendChild(_p);
		_a.appendChild(_span);
		_div.appendChild(_a);
		_e.appendChild(_div);
		
		return _span;
	}
	finally
	{
		_div = _a = _p = _span = null;
	}
}

LWFP.ButtonFrame.createIcon = function(_e, _name, _data, _css, _float, _type)
{
	try
	{	
		var _div = document.createElement("div");
			_div.className = 'button_frame';
			_div.style.styleFloat = "left";
			_div.setAttribute("ct", LWFP.ButtonFrame.bc);
			_div.setAttribute(LWFP.ButtonFrame.bn, _name);
			_div.setAttribute(LWFP.ButtonFrame.t, _type);
			if (_data != null)
				_div[LWFP.ButtonFrame.n] = _data;
		var _b = document.createElement("b");
			_b.className = _css;
			_b.title = _name;
			_b.href = '#';
			_b.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;";			
			
		_div.appendChild(_b);
		if (_float != null)
			_div.style.styleFloat = _float;
		
		_e.appendChild(_div);

		return _b;
	}
	finally
	{
		_div = _b = null;
	}		
}

LWFP.ButtonFrame.hasLimit = function(e, data)
{	
	try
	{		
		var _actionNames = LWFP.innerApi.String2Arr(e.getAttribute("_actionName"), ";", false);
		var _opNames = LWFP.innerApi.String2Arr(e.getAttribute("_flowOptionName"), ";", false);
		var _jsNames = LWFP.innerApi.String2Arr(e.getAttribute("_jsName"), ";", false);
		
		if (_actionNames != null || _opNames != null || _jsNames != null)
			return true;
		
		var _type = e.getAttribute("_type");
		if (_type == null)
		{
			return false;
		}
		else
		{
			_type = _type.Trim();
			if (_type == "0" || _type == "1" || _type == "2")
				return true;
			else
				return false;
		}		
	}
	finally
	{
		_actionNames = _opNames = _jsNames = _type = null;
	}
}

LWFP.ButtonFrame.getFrames = function(_instance, element)
{
	return LEAP.getElements("div[ct=" + LWFP.ButtonFrame.d + "][instance=" + _instance + "]", element);
}

LWFP.ButtonFrame.init();








/*******************************************************************************
 * docnumber插件
 * @remaks 公文文号插件
 * @class LEAP.docnumber control
 * @type user control
 * @example
 * 
 * 
 * 定义：
 *<DIV class="wfcontrol_docnumber_div" ct="docnumber" docnamewidth="" docyearwidth="" havesearch="false"  controltype="toporg" businessno="" value="">
 * 		<IMG style="DISPLAY: none" onerror=LEAP.docnumber.i(0); src="data:image:png,base64">
 *</DIV>
 *
 * 生成后示例:
 *<DIV class="wfcontrol_docnumber_div" ct="docnumber" docnamewidth="" docyearwidth="" havesearch="false" controltype="toporg" businessno="">
 *	<DIV class="wfcontrol_docnumber_alldiv" ctf="docnumberalldiv">
 *		<DIV class="wfcontrol_docnumber_inputdiv" ctf="docselectdiv">
 *			<DIV class="select lgiact" style="width:80px;float:left"  ct="select"  mdtype="select" bt="select" ctf="doc_name">
 *				<DIV class="lg_p_lr_right select_drop selectdropout" ctf="select_drop"></DIV>
 *				<DIV class="lg_p_lr_fill input_fill">
 *					<DIV class="lg_p_lr_fill_c input_fill_c">
 *						<INPUT class="selectbtn ellipsis " style="margin-left: 3px;" type=button ctf="selectbtn">
 *					</DIV>
 *				</DIV>
 *				<DIV class=select_items style="WIDTH: 100%" ctf="select_items" sizset="0">
 *					<DIV>
 *						<A href="javascript:" ctf="select_item" value="">&nbsp;</A>
 *					</DIV>
 *				</DIV>
 *			</DIV>
 *			<DIV class="wfcontrol_docnumber_spacediv"></DIV>
 *			<DIV class="select lgiact" style="width:60px;float:left"  ct="select" mdtype="select" bt="select" ctf="doc_year">
 *				<DIV class="lg_p_lr_right select_drop selectdropout" ctf="select_drop"></DIV>
 *				<DIV class="lg_p_lr_fill input_fill">
 *					<DIV class="lg_p_lr_fill_c input_fill_c">
 *						<INPUT class="selectbtn ellipsis "style="margin-left: 3px;" type=button ctf="selectbtn">
 *					</DIV>
 *				</DIV>
 *				<DIV class=select_items style="WIDTH: 100%;height:75px;" ctf="select_items" sizset="0">
 *					<DIV>
 *						<A href="javascript:" ctf="select_item" value="">&nbsp;</A>
 *					</DIV>
 *				</DIV>
 *			</DIV>
 *		</DIV>
 *		<DIV class="wfcontrol_docnumber_spacediv"></DIV>	
 *		<DIV class="wfcontrol_docnumber_inputdiv">
 *			<INPUT class="wfcontrol_docnumber_input" ht="input" mdtype="integer" bt="text" ctf="doc_num">
 *		</DIV>
 *		<DIV style='float:left'>
 *			<A class="wfcontrol_docnumber_button" href="javascript:"  ht="button" ctf="doc_create">生成文号</A>
 *			<A class="wfcontrol_docnumber_button" style="display:none" href="javascript:"  ht="button" ctf="doc_search">查询文号</A>
 *		</DIV>
 *	</DIV>
 *	<span class='wfcontrol_docnumber_span' ctf='_docspan'></span>
 *</DIV>
 * 
 * 属性说明：
 * readonly 设置是否只读:默认为true，false表示不显示,true表示显示
 * showsearch 设置是否有查看文号列表的按钮功能，默认为flase，false表示不显示,true表示显示
 * docnamewidth 设置文件字下拉列表框的宽度
 * docyearwidth 设置文件年度下拉列表框的宽度
 * controltype  toporg/areaid 设置顶点机构、区域编码
 * businessno 流程事项流水号
 * value  返回最终的文号 格式:文件字[年度]文件号  如:深永通[2012]0001
 ********************************************************************/

LEAP.docnumber = {};
LEAP.docnumber.d = "docnumber";
LEAP.docnumber.ctf={_alldiv:"docnumberalldiv",_selectdiv:"docselectdiv",_docname:"doc_name", 
					_docyear:"doc_year", _docnum:"doc_num", _doccreate:"doc_create", 
					_docsearch:"doc_search",_docspan:"_doclabel"};

LEAP.docnumber.init = function()
{
	if (document != null && document.body != null)
	{
		LEAP.docnumber._init();
	} 
	else 
	{
		UIEventManager.addEvent(window, "load", LEAP.docnumber._init);
	}
}
LEAP.docnumber._init = function() 
{
	LEAP.addEvent(document.body, "click", LEAP.docnumber.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, "load", LEAP.docnumber._init);
}

/**
 * 注册按钮所有操作的方法
 * @param {} arg
 */
LEAP.docnumber.uiProcess = function(arg) 
{
	try{
		if (!arg) return;
		var src = arg.e.srcElement;
		var ctf = src.getAttribute(commfields.ctf);
		if (!ctf) return;
		
		var element = LEAP._match(src, LEAP.docnumber.d);
		if (!element) return;
		if (ctf == LEAP.docnumber.ctf._doccreate) 
		{
			LEAP.docnumber.doccreate(element);
		} 
		else if (ctf ==LEAP.docnumber.ctf._docsearch) 
		{
			LEAP.docnumber.docsearch(element);
		} 
	}catch(err){
		alert("错误：" + err.number + ":" + err.description);
	}finally{
		arg=src=ctf=element=null;
	}
}

/**
 * 设置意见控件只读状态
 * @param {} element
 */
LEAP.docnumber.setReadOnly=function(element){
	try{
		element = LEAP._check(element, LEAP.docnumber.d);
		if (!element) {
			return;
		}
		element.setAttribute("readonly", "true");
		var docnumberalldiv=LEAP.getElement('div[ctf=' + LEAP.docnumber.ctf._alldiv + ']', element);
		var _value=element.getAttribute("value");
		if(!docnumberalldiv){
			//没有初始化的时候，加入span
			var inner="<span class='wfcontrol_docnumber_span' ctf='"+LEAP.docnumber.ctf._docspan+"'></span>";
			element.innerHTML=inner;
		}else{
			docnumberalldiv.style.display = 'none';
		}
		var myspan=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docspan+']',element);
		if(myspan && _value){
			myspan.innerText=_value;
			myspan.style.display = 'block';
		}
	}catch(err){
		alert("错误：" + err.number + ":" + err.description);
	}finally{
		element=docnumberalldiv=_value=inner=myspan=null;
	}
}

/**
 * 普通控件获取值的方法.
 * @param {} element
 */
LEAP.docnumber.getValue = function(element) {
	try{
		element = LEAP._check(element, LEAP.docnumber.d);
		if (element == null) {
			return;
		}
		var _readonly = element.getAttribute("readonly");
		if(_readonly!=null && _readonly=="true"){
			var myspan=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docspan+']',element);
			if(myspan){
				return myspan.innerText;	
			}
		}else{
			var alldiv=LEAP.getElement('[ctf=' + LEAP.docnumber.ctf._alldiv + ']', element);
			if(!alldiv){return null;}
			if(alldiv.style.display == 'none'){
				var myspan=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docspan+']',element);
				if(myspan){
					return myspan.innerText;	
				}	
			}else{
				var docname_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docname+']',element);
				var docyear_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docyear+']',element);
				var docnum_input=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docnum+']',element);
				if(docname_select && docyear_select && docnum_input){
					var docname=LEAP.select.getSelectedText(docname_select);
					var docyear=LEAP.select.getSelectedText(docyear_select);
					var docnum=docnum_input.value;
					if(!docnum || !docname || !docyear)return null;
					var docid=LEAP.select.getValue(docname_select);
					
					var module = LWFP.innerApi.getmodule(element);
					
					var bean=module.request2({name:'lbcp_getDocumentNumberByID', par:{docid:docid}});
					var docprefix="[";
					var docpostfix="]";
					//前缀
					if(bean!=null&&bean.docprefix!=null&&bean.docprefix.trim()!=""){
						docprefix=bean.docprefix.trim();
					}
					//后缀
					if(bean!=null&&bean.docpostfix!=null&&bean.docpostfix.trim()!=""){
						docpostfix=bean.docpostfix.trim();
					}
					return docname+docprefix+docyear+docpostfix+docnum;
				}
			}
		}
		return null;
	}
	catch(err){
		alert("错误：" + err.number + ":" + err.description);
	}finally{
		element=_readonly=myspan=alldiv=docname_select=docyear_select=docnum_input=docname=docyear=docnum=null;
	}
		
}
/**
 * 普通控件设置的方法
 * @param {} element
 * @param {} value
 */
LEAP.docnumber.setValue = function(element, value) 
{
	try 
	{	
		element = LEAP._check(element, LEAP.docnumber.d);
		if (!element)
			return;
		
		if (!value || value=="")
		{
			element.removeAttribute('value');
		}
		else
		{
			element.setAttribute('value', value);
			
			var _readonly = element.getAttribute("readonly");
			if (_readonly!=null && _readonly=="true")
			{
				var myspan=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docspan+']',element);
				myspan.style.display = "block";
				if (myspan)
					myspan.innerText=value;
			}
			else
			{				
				var docname_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docname+']',element);
				var docyear_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docyear+']',element);
				var docnum_input=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docnum+']',element);
				if(docname_select && docyear_select && docnum_input){

					var jsonDoc=docname_select.getAttribute("jsonDoc");
					var docid="";
					var docyear="";
					var docnum="";
					if(jsonDoc!=null&&jsonDoc!=""){
						var doclist = JSON.parse(jsonDoc);
						for(var i=0;i<doclist.length;i++){
							var data=doclist[i];
							if(data!=null&&data.docname!=null&&value.indexOf(data.docname+data.docprefix)!=-1){
								docid=data.id;
								if(value.indexOf(data.docprefix)!=-1&&value.indexOf(data.docpostfix)!=-1){
									docyear=value.substring(value.indexOf(data.docprefix)+data.docprefix.length,value.indexOf(data.docpostfix));
								}
								if(value.indexOf(data.docpostfix)!=-1){
									docnum=value.substring(value.indexOf(data.docpostfix)+data.docpostfix.length);
								}
								break;
							}else if(data!=null&&data.docname!=null&&value.indexOf(data.docname+"[")!=-1){
								docid=data.id;
								if(value.indexOf("[")!=-1&&value.indexOf("]")!=-1){
									docyear=value.substring(value.indexOf("[")+1,value.indexOf("]"));
								}
								if(value.indexOf("[")!=-1){
									docnum=value.substring(value.indexOf("]")+1);
								}
								break;
							}
						}
					}

					LEAP.select.setValue(docname_select, docid);
					LEAP.select.setValue(docyear_select, docyear);
					docnum_input.value=docnum;
				}
			}
		}
	} catch (e) {
		alert("错误：" + err.number + ":" + err.description);
	} finally {
		element = value = docname=docyear=docnum=docname_select=docyear_select=docnum_input=docs=docid=_readonly=myspan=null;
	}
}

/**
 * 生成新文号
 * @param {} element
 * @param {} mdid
 */
LEAP.docnumber.doccreate=function(element){
	try{
		element = LEAP._check(element, LEAP.docnumber.d);
		if (!element)return;
		
		var docname_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docname+']',element);
		var docyear_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docyear+']',element);
		var docnum_input=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docnum+']',element);
		if(!docname_select || !docyear_select || !docnum_input){
			alert("控件初始化失败!");
			return;
		}
		var docname=LEAP.select.getSelectedText(docname_select);
		var docyear=LEAP.select.getSelectedText(docyear_select);
		if(!docname || docname.trim()==""){
			alert("请选择文件字");
			return;
		}
		if(!docyear || docyear.trim()==""){
			alert("请选择年度");
			return;
		}
		var businessno = element.getAttribute("businessno");
		var aliasname = element.getAttribute("aliasname");
		
		if(!businessno){
			alert("文号相关流程数据不完整!事项编号[businessno]未设置!");
			return;
		}
		/*if(!aliasname){
			alert("文号相关流程数据不完整!事项名称[aliasname]未设置!");
			return;
		}*/
		
		var module = LWFP.innerApi.getmodule(element);
		
		var returnValue=module.request2({name:'lbcp_createDocumentNumber',	par:{
						docname:docname,
						docyear:docyear,
						businessno:businessno,
						aliasname:aliasname
					}});
		docnum_input.value=returnValue;		
	}finally{
		element=docname_select=docyear_select=docnum_input=docname=docyear=businessno=aliasname=returnValue=null;
	}
}

/**
 * 查看文号
 * @param {} element
 */
LEAP.docnumber.docsearch=function(element){
	try{
		element = LEAP._check(element, LEAP.docnumber.d);
		if (!element)return;
		var docname_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docname+']',element);
		var docyear_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docyear+']',element);
		if(!docname_select || !docyear_select){
			alert("控件初始化失败!");
			return;
		}
		var docname=LEAP.select.getSelectedText(docname_select);
		var docyear=LEAP.select.getSelectedText(docyear_select);
		if(!docname){
			alert("请选择文件字");
			return;
		}
		if(!docyear){
			alert("请选择年度");
			return;
		}
		var lbcpdocumentnumbersee = LEAP.form.create('lbcpdocumentnumbersee', "查看文号", 800, 550, null, null, null,null, true);
		lbcpdocumentnumbersee.show();
		lbcpdocumentnumbersee.module.setDocData(docname,docyear);
		lbcpdocumentnumbersee.module.parentElement.style.overflowY="scroll";
	}finally{
		element=null;
	}
}

LEAP.docnumber.setBusinessNo = function(element, businessno)
{
	element = LEAP._check(element, LEAP.docnumber.d);
	if (!element)
		return;
		
	if (businessno == null)
		element.setAttribute("businessno", "");
	else
		element.setAttribute("businessno", businessno);		
}

/**
 * 文号控件初始化方法
 * @param {} wait
 * @param {} src
 */
LEAP.docnumber.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;

	/*if (LEAPBrowser.isIE && wait != null)
	{
		var fn = function()
		{
			LEAP.docnumber.i(null, src);
			src = null;
		};
		setTimeout(fn, wait);
		return;
	}*/

	LEAP.docnumber._i(src);
	if (src.parentElement)
		src.parentElement.removeChild(src);
}

LEAP.docnumber._i = function(src)
{
	try
	{
		var _element = LEAP._match(src, LEAP.docnumber.d);
		if (_element == null)
			return;
		LEAP.docnumber.__i(_element);		
	}
	finally
	{
		_element = null;
	}
}


LEAP.docnumber.__onload=function(_element,_controltype,businessno){
	try{
		_element = LEAP._check(_element, LEAP.docnumber.d);
		if(!_element || !_controltype)return;
		
		var module = LWFP.innerApi.getmodule(_element);
		
		var docs=module.request2({name:'lbcp_OnloadDocnumberData',	par:{controltype:_controltype,businessno:businessno}}	);
		_element['docs'] = docs;
		if(docs){
			var docname_select = LEAP.getElement("[ctf=" + LEAP.docnumber.ctf._docname + "]", _element);
			if(docname_select){
				var doclist=new Array();
				for (var i = 0; i < docs.length; i++) {
					var data={};
					var docprefix="[";
					var docpostfix="]";
					//前缀
					if(docs[i]!=null&&docs[i].docprefix!=null&&docs[i].docprefix.trim()!=""){
						docprefix=docs[i].docprefix.trim();
					}
					//后缀
					if(docs[i]!=null&&docs[i].docpostfix!=null&&docs[i].docpostfix.trim()!=""){
						docpostfix=docs[i].docpostfix.trim();
					}
					LEAP.select.addItem(docname_select,docs[i].id, docs[i].docname);
					data.id=docs[i].id;
					data.docname=docs[i].docname;
					data.docprefix=docprefix;
					data.docpostfix=docpostfix;
					doclist.add(data);
				}
				var jsonDoc=JSON.stringify(doclist); 
				docname_select.setAttribute("jsonDoc",jsonDoc);
			}
		}
		var now = LEAP.userInfo.getTimeFormart();
		var _year = now.substring(0, now.indexof("-"));
		if (_year) {
			var a = [];
			a[0] = _year - 1;
			a[1] = _year;
			a[2] = parseInt(_year) + 1;
			var docyear_select = LEAP.getElement("[ctf=" + LEAP.docnumber.ctf._docyear + "]", _element);
			if (!docyear_select) return;
			for (var j = 0; j < a.length; j++) {
				LEAP.select.addItem(docyear_select, a[j], a[j]); 
			}
			_element['years'] = a;
		}
	}finally{
		_element=_controltype=docname_select=i=docs=now=_year=a=docyear_select=j=null;
	}
}

/**
 * 
 * 文号保存后续动作,流程专用
 * 1.根据文件字.文件年度.到文号主表获取对应的文号编号.
 * 2.根据流程实例编号到文号使用历史里面获取对应的记录,如果没有表示新增,有表示修改
 * 3.根据文号编号docid和docnum获取缓冲表数据,并给予删除.
 * 4.发现缓存表中存在对应的补号信息,将此补号信息设置为不可用
 * 5.当缓存表中的libid为空时,有可能是预留号,将补号表中比当前值小的预留号设置成不可用
 * 6.判断当前保存的号码值与文号表中的号码值比较.如果比文号当前值大的话,就更改,否则不动..
 * @param {} instance
 * @param {} formElement
 * @return {}
 */
LEAP.docnumber.getPageValue = function(instance, formElement){
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.docnumber.d + "][instance=" + instance + "]", formElement);
		if (!elements)return null;
		var value=[];
		for(var i=0;i<elements.length;i++)
		{
			var _value = LEAP.docnumber.getDocAttribute(elements[i]);
			if (_value != null)
				value.add(_value);
		}
		if (value.length == 0)
			return null;
		else
			return value;
	}
	finally
	{
		elements = value =_value= null;	
	}	
}

/**
 * 获取文号控件属性
 * @param {} _element
 * @return {String}
 */
LEAP.docnumber.getDocAttribute=function(_element){
	try{
		_element = LEAP._check(_element, LEAP.docnumber.d);
		if(!_element)return null;
		var docname_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docname+']',_element);
		var docyear_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docyear+']',_element);
		var docnum_input=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docnum+']',_element);
		var docname=LEAP.select.getSelectedText(docname_select);
		var docyear=LEAP.select.getSelectedText(docyear_select);
		var docnum=docnum_input.value;
		if(!docnum)return null;
		var obj={};
		obj.docname=docname;
		obj.docyear=docyear;
		obj.docnum=docnum;
		return obj;
		
	}finally{
		_element=docname_select=docyear_select=docnum_input=docname=docyear=docnum=obj=null;
	}
	
}

/**
 * 文号保存之后的方法.供流程使用
 * @param {} _element
 * @param {} flowenryid
 * @param {} floweventcodename
 */
LEAP.docnumber.saveAfter=function(_element,flowenryid,floweventcodename){
	try{
		_element = LEAP._check(_element, LEAP.docnumber.d);
		if(!_element)return;
		if(!flowenryid || !floweventcodename){
			alert("获取流程实例数据失败!");
			return;
		}
		var docname_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docname+']',_element);
		var docyear_select=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docyear+']',_element);
		var docnum_input=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docnum+']',_element);
		if(!docname_select || !docyear_select || !docnum_input){
			alert("控件初始化失败!");
			return;
		}
		var docname=LEAP.select.getSelectedText(docname_select);
		var docyear=LEAP.select.getSelectedText(docyear_select);
		var docnum=docnum_input.value;
		if(!docname || !docyear || !docnum){
			return;
		}
		
		var module = LWFP.innerApi.getmodule(_element);
		
		module.request2({name:'lbcp_documentnumberSaveAfter',	par:{
			flowenryid:flowenryid,
			floweventcodename:floweventcodename,
			docname:docname,
			docyear:docyear,
			docnum:docnum
		}});
		
	}finally{
		_element=flowenryid=floweventcodename=docname_select=docyear_select=docnum_input=docname=docyear=docnum=null;
	}
}

/**
 * 控件html初始化
 * @param {} _element
 */
LEAP.docnumber.__i = function(_element)
{
	try
	{
		_element = LEAP._check(_element, LEAP.docnumber.d);
		if(!_element)return;
		
		var _readonly = _element.getAttribute("readonly");
		var showsearch = _element.getAttribute("showsearch");
		var docnamewidth = _element.getAttribute("docnamewidth");
		var docyearwidth = _element.getAttribute("docyearwidth");
		var controltype =_element.getAttribute("controltype");
		var businessno=_element.getAttribute("businessno");
		var value = _element.getAttribute("value");
		if(!docnamewidth){
			docnamewidth="80px";				
		}
		if(!docyearwidth){
			docyearwidth="60px";				
		}
		var dis="";
		if(showsearch){
			dis="style='display:block'";
		}else{
			dis="style='display:none'";
		}	
		if (!LEAP.getElement('[ctf=' + LEAP.docnumber.ctf._alldiv + ']', _element))
		{
			var inner="<div class='wfcontrol_docnumber_alldiv'style='float:left' ctf='"+LEAP.docnumber.ctf._alldiv+"'>";
				inner+="<div class='wfcontrol_docnumber_inputdiv' ctf='"+LEAP.docnumber.ctf._selectdiv+"'>";
				inner+="<div class='select lgiact' style='width:"+docnamewidth+";float:left' ct='select' mdtype='select' bt='select' ctf='" + LEAP.docnumber.ctf._docname + "'>";
				inner+="<div class='lg_p_lr_right select_drop selectdropout' ctf='select_drop'></div>";
				inner+="<div class='lg_p_lr_fill input_fill'>";
				inner+="<div class='lg_p_lr_fill_c input_fill_c'>";
				inner+="<input class='selectbtn ellipsis ' style='margin-left: 3px;' type='button' ctf='selectbtn'>";
				inner+="</div>";
				inner+="</div>";
				inner+="<div class='select_items' style='WIDTH: 100%' ctf='select_items' sizset='0'>";
				inner+="<div><A href='javascript:' ctf='select_item' value=''>&nbsp;</A></div>";
				inner+="</div>";
				inner+="</div>";
				inner+="<div class='wfcontrol_docnumber_spacediv'></div>";
				inner+="<div class='select lgiact' style='width:"+docyearwidth+";float:left' ct='select' mdtype='select' bt='select' ctf='" + LEAP.docnumber.ctf._docyear + "'>";
				inner+="<div class='lg_p_lr_right select_drop selectdropout' ctf='select_drop'></div>";
				inner+="<div class='lg_p_lr_fill input_fill'>";
				inner+="<div class='lg_p_lr_fill_c input_fill_c'>";
				inner+="<input class='selectbtn ellipsis ' style='margin-left: 3px;' type='button' ctf='selectbtn'>";
				inner+="</div>";
				inner+="</div>";
				inner+="<div class='select_items' style='WIDTH: 100%;height:75px;' ctf='select_items' sizset='0'>";
				inner+="<div><A href='javascript:' ctf='select_item' value=''>&nbsp;</A></div>";
				inner+="</div>";
				inner+="</div>";
				inner+="</div>";
				inner+="<div class='wfcontrol_docnumber_spacediv'></div>";
				inner+="<div class='wfcontrol_docnumber_inputdiv'>";
				inner+="<input class='wfcontrol_docnumber_input' ht='input' mdtype='integer' bt='text' ctf='"+LEAP.docnumber.ctf._docnum+"'>";
				inner+="</div>";
				inner+="<div style='float:left'><A class='wfcontrol_docnumber_button' href='javascript:'  ht='button' ctf='"+LEAP.docnumber.ctf._doccreate+"'>生成文号</A>";
				inner+="<A class='wfcontrol_docnumber_button'"+dis+" href='javascript:'  ht='button' ctf='"+LEAP.docnumber.ctf._docsearch+"'>查询文号</A>";
				inner+="</div>";
				inner+="</div>";
				inner+="<span class='wfcontrol_docnumber_span' ctf='"+LEAP.docnumber.ctf._docspan+"'></span>"
			_element.innerHTML=inner;
		}
		if (_readonly!=null && _readonly=="true")
		{
			LEAP.getElement('[ctf=' + LEAP.docnumber.ctf._alldiv + ']', _element).style.display = 'none';
			var myspan=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docspan+']',_element);
			myspan.style.display = 'block';
			/*var _value=_element.getAttribute("value");
			if(_value)
			{
				myspan.innerText=_value;
			}*/
		}
		else
		{
			if(!controltype)return;
			var _controltype="toporg";
			if(controltype=="areaid")
			{
				_controltype=controltype;				
			}
			var myspan=LEAP.getElement('[ctf='+LEAP.docnumber.ctf._docspan+']',_element);
			myspan.style.display = 'none';
			//初始化数据
			LEAP.docnumber.__onload(_element,_controltype,businessno);
		}
		
		if (value && value!="")
			LEAP.docnumber.setValue(_element, value);
			
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		_element = _readonly = showsearch = docnamewidth =docyearwidth=controltype =businessno=dis=inner=myspan=_controltype=null;
	}
}

LEAP.docnumber.init();



LWFP.HistoryList = {};
LWFP.HistoryList.d = 'lwfphistorylist';
LWFP.HistoryList.symbol =
{
	itemli      : "itemli",
	itemtype	: "_itemtype",
		steptype	: "step",
		actiontype	: "action",
	data		: "_data"	
};
LWFP.HistoryList.Form = null;
LWFP.HistoryList.init = function()
{
	if (document != null && document.body != null)
		LWFP.HistoryList._init();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.HistoryList._init);

	ElementEventManager.addManagedEventType(LWFP.HistoryList.d, 'onRecordLoad');
	ElementEventManager.addManagedEventType(LWFP.HistoryList.d, 'onJump');
	ElementEventManager.addManagedEventType(LWFP.HistoryList.d, 'onRecend');
	ElementEventManager.addManagedEventType(LWFP.HistoryList.d, 'onSubflowShow');
	ElementEventManager.addManagedEventType(LWFP.HistoryList.d, 'onMainflowShow');
}

LWFP.HistoryList._init = function()
{	
	LEAP.addEvent(document.body, 'click', LWFP.HistoryList.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LWFP.HistoryList._init);
}

LWFP.HistoryList.uiProcess = function(arg)
{	
	try
	{
		var src = arg.e.srcElement;
		if (null == src) return;		
		var element = LEAP._match(src, LWFP.HistoryList.d);		
		if(null == element) return;
				
		var ctf = src.getAttribute(commfields.ctf);
		while(ctf == null)
		{
			src = src.parentNode;
			if (src == null) return;				
			ctf = src.getAttribute(commfields.ctf);
		}
		
		var _li = LEAP._match(src, LWFP.HistoryList.symbol.itemli, commfields.ctf);
		if (_li == null) return;		
		var _data = _li[LWFP.HistoryList.symbol.data];
		if (_data == null) return;
				
		if (ctf == null)
		{}
		else if(ctf == 'procListRow')
		{
			var _type = _li.getAttribute(LWFP.HistoryList.symbol.itemtype);
			if (_type == LWFP.HistoryList.symbol.steptype)
			{
				if (_data.recid != null)					
					ElementEventManager.handleEvent(element, "onRecordLoad", {data:_data, modluename:_data.modulename, stepname:_data.stepaliasname, recid:_data.recid});
			}
			else if (_type == LWFP.HistoryList.symbol.actiontype)
			{
				if (_data.actrecid != null)					
					ElementEventManager.handleEvent(element, "onRecordLoad", {data:_data, modluename:_data.actmodulename, stepname:_data.outactionaliasname, recid:_data.actrecid})
			}
		}
		else if (ctf == 'jump')
		{
			var _csid = src.getAttribute('_csid');
			var _stepid = src.getAttribute('_stepid');
			var _cowner = src.getAttribute('_cowner') == "true" ? true:false;
			
			ElementEventManager.handleEvent(element, "onJump", {csid:_csid, stepid:_stepid, cowner:_cowner});
		}
		else if (ctf == 'resend')
		{
			ElementEventManager.handleEvent(element, "onRecend", {hisstep:_data});
		}
		else if (ctf == 'subflow')
		{	
			ElementEventManager.handleEvent(element, "onSubflowShow", {entryid:_data.subflowentry});
		}
		else if (ctf == 'showmainflow')
		{
			ElementEventManager.handleEvent(element, "onMainflowShow", {entryid:_data});
		}		
	}
	finally
	{
		src = ctf = _li = _data = _csid = _stepid = _type = element = null;
	}
	
}

LWFP.HistoryList.bindList = function(element, wfdata, allowShowRecord, domain)
{
	if (element == null || wfdata == null || wfdata.historySteps == null) 
		return;
	if (element.getAttribute(commfields.ct) != LWFP.HistoryList.d)
		return null;
		
	try
	{
		element.innerHTML = "";		
		var _ul = document.createElement("ul");
		
		if (wfdata.entry != null && wfdata.entry.mainEntry != null)
		{
			var _li = document.createElement("li");
				_li.setAttribute(commfields.ctf, LWFP.HistoryList.symbol.itemli);
				_li[LWFP.HistoryList.symbol.data] = wfdata.entry.mainEntry.entryid;
			
			var _html = "<div><b class='lwfphistorylist_item_symbol' style='float:left;'>&nbsp;&nbsp;</b><div ctf='showmainflow' style='color:blue;float:left;word-break:break-all; white-space:normal !important;width:98%;' _mainentryid='" + wfdata.entry.mainEntry.entryid + "'>主事项: " + wfdata.entry.mainEntry.eventcode + "——" + wfdata.entry.mainEntry.eventname + "</div> </div>";									
			if (wfdata.entry.displayMainEntry == false)
				_html = _html.replaceall("href='javascript:void(0)'", "");
			
			_ul.appendChild(_li);
			_li.innerHTML = LEAP.bindControl(_html, domain);
		}
		
		for(var i=0; i<wfdata.historySteps.length; i++)
		{
			var his = wfdata.historySteps[i];	
			if (his.hsid == null) continue;
			if (his.status == 4) continue;
			
			if (his.outactionid != null || his.finishstatus == 3)
			{
				var _li = document.createElement("li");
					_li.setAttribute(commfields.ctf, LWFP.HistoryList.symbol.itemli);
					_li.setAttribute(LWFP.HistoryList.symbol.itemtype, LWFP.HistoryList.symbol.steptype);					
					_li[LWFP.HistoryList.symbol.data] = his;
					
				_ul.appendChild(_li);
				
				var _html = LWFP.HistoryList.buildItemHTML(wfdata, his, allowShowRecord, LWFP.HistoryList.symbol.steptype);
				_li.innerHTML = LEAP.bindControl(_html, domain);				
			}
			if (his.actrecid != null)
			{
				var _li = document.createElement("li");
					_li.setAttribute(commfields.ctf, LWFP.HistoryList.symbol.itemli);
					_li.setAttribute(LWFP.HistoryList.symbol.itemtype, LWFP.HistoryList.symbol.actiontype);
					_li[LWFP.HistoryList.symbol.data] = his;
					
				_ul.appendChild(_li);
				
				var _html = LWFP.HistoryList.buildItemHTML(wfdata, his, allowShowRecord, LWFP.HistoryList.symbol.actiontype);
				_li.innerHTML = LEAP.bindControl(_html, domain);
			}			
		}
		
		element.appendChild(_ul);
	}
	finally
	{
		_ul = _li = i = his = _html = null;
	}
	
}

LWFP.HistoryList.showArrow = function(element, arrHisstep)
{
	if (element == null)
		return;
		
	var e = LEAP._match(element, LWFP.HistoryList.d);
	if (e == null)
		return;

	try
	{
		var _arrows = LEAP.getElements("a[ctf=arrow]", e);
		if (_arrows == null)
			return;
			
		for(var i=0; i<_arrows.length; i++)
		{
			var _arrow = _arrows[i];
			_arrow.style.display = "none";			
			var _li = LEAP._match(_arrow, LWFP.HistoryList.symbol.itemli, commfields.ctf);
			var _data = _li[LWFP.HistoryList.symbol.data];
			
			if (arrHisstep != null)
			{
				for(var j=0;j<arrHisstep.length;j++)
				{
					if(arrHisstep[j].hsid != null && arrHisstep[j].hsid == _data.hsid)
					{
						_arrow.style.display = '';
						break;
					}
				}
			}
		}
		
	}
	finally
	{
		e = _arrows = _arrow = i = _li = _data = j = null;
	
	}
	
}

/**
<div ctf='procListRow' _recid=''>
	<b class='lwfphistorylist_item_symbol'>&nbsp;&nbsp;</b>
	<a style='color:blue;' href='javascript:void(0)' >
		【Step-B】&nbsp;&nbsp;&nbsp;&nbsp;信息中心a（代理人:his.agentname）&nbsp;&nbsp;&nbsp;&nbsp;
		<font class='lwfphistorylist_font_blue_1'>[&nbsp;摘要&nbsp;]</font>
		his.sumtitle66666666666666666666666664
	</a>
</div>
<div class='lwfphistorylist_item_row'>
	<a>处理时间：
		<font class='lwfphistorylist_font_formatdate'>2011-05-24 08:50:04</font>&nbsp;&nbsp;至&nbsp;&nbsp;
		<font class='lwfphistorylist_font_formatdate'>2011-05-24 08:50:15</font>
	</a>
	<a class='lwfphistorylist_arrow' ctf='arrow' style='display: none;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
</div>
<div class='lwfphistorylist_item_row'>【action-F】发送至：
	<FONT style='FONT-SIZE: 12px' ctf='jump'>a（已阅:2011-05-24 08:50:15）；</FONT>
	<br><br>
	<FONT style='FONT-SIZE:12px; color:red; cursor:hand;' ctf='resend'>[补发]</FONT>
</div>
<div class='lwfphistorylist_item_row'>his.stepdesc</div>
**/

/*LWFP.HistoryList.itemTemplate = 
"<div ctf='procListRow'>" +
	"<b class='lwfphistorylist_item_symbol'>&nbsp;&nbsp;</b>" +
	"<a style='color:blue;' href='javascript:void(0)' <!--sumtitleTooltip-->>" +
		"【<!--stepaliasname-->】&nbsp;&nbsp;&nbsp;&nbsp;<!--ownername--><!--agent-->&nbsp;&nbsp;&nbsp;&nbsp;<!--sumtitle--><!--subflow-->" +
	"</a>" +
"</div>" +
"<div class='lwfphistorylist_item_row'>" +
	"<a>处理时间：<font class='lwfphistorylist_font_formatdate'><!--starttime--></font>&nbsp;&nbsp;至&nbsp;&nbsp;" +
		"<font class='lwfphistorylist_font_formatdate'><!--endtime--></font>" +
	"</a>" +
	"<a class='lwfphistorylist_arrow' ctf='arrow' style='display: none;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>" +
"</div>" +
"<!--nextstepusers--><!--rollbackdesc-->"*/


LWFP.HistoryList.itemTemplate = 
"<div ctf='procListRow'>" +
	"<b class='lwfphistorylist_item_symbol' style='float:left;'>&nbsp;&nbsp;</b>" +
	
	"<div style='width:95%;height:auto;float:left;'>" +
		"<span>【<!--stepaliasname-->】&nbsp;&nbsp;&nbsp;&nbsp;<!--ownername--><!--agent--></span>" +
		"<div style='word-break:break-all;white-space:normal;'><!--sumtitle--><!--subflow--></div>" +
	"</div>" +
		
	//"<a style='color:blue;' href='javascript:void(0)' <!--sumtitleTooltip-->>" +
	//	"【<!--stepaliasname-->】&nbsp;&nbsp;&nbsp;&nbsp;<!--ownername--><!--agent-->&nbsp;&nbsp;&nbsp;&nbsp;<!--sumtitle--><!--subflow-->" +
	//"</a>" +
	
"</div>" +
"<div class='lwfphistorylist_item_row' style='float:left;'> " +
	"<a>【处理时间】&nbsp;<font class='lwfphistorylist_font_formatdate'><!--starttime--></font>&nbsp;&nbsp;至&nbsp;&nbsp;" +
		"<font class='lwfphistorylist_font_formatdate'><!--endtime--></font>" +
	"</a>" +
	"<a class='lwfphistorylist_arrow' ctf='arrow' style='display: none;'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>" +
"</div>" +
"<!--nextstepusers--><!--rollbackdesc-->"

LWFP.HistoryList.buildItemHTML = function(wfdata, data, allowShowRecord, type)
{
	try
	{
		var str = "";
		
		if (type == LWFP.HistoryList.symbol.steptype)
		{
			str = LWFP.HistoryList.itemTemplate;		
			str = str.replace("<!--starttime-->", LEAP.formatdate(data.createtime.time, 0));
			if (data.subflowentry != null)
			{
				var step = LWFP.innerApi.getStep(wfdata.flow.steps, data.stepid);
				if (step.showSubFlowInMain != null && step.showSubFlowInMain == true)
					str = str.replace("<!--subflow-->", "<font ctf='subflow' style='color:blue; cursor:pointer;'>[查看办理进程]</font>");	
				if(data.subflowdone == null || data.subflowdone == 0 )
					str = str.replace("<!--endtime-->", "当前(在办)");
			}
			else
			{
				str = str.replace("<!--endtime-->", LEAP.formatdate(data.finishtime.time, 0));
			}
			
			if (data.ownername != null)
				str = str.replace("<!--ownername-->", data.ownername);
			else if (data.ownerpositionname != null)
				str = str.replace("<!--ownername-->", data.ownerpositionname);
			else if (data.ownerorganname != null)
				str = str.replace("<!--ownername-->", data.ownerorganname);
						
			str = str.replace("<!--stepaliasname-->", ( (data.readstep != null && data.readstep == 1) ? "传阅":data.stepaliasname) );
			if (data.sumtitle != null)
			{
				str = str.replace("<!--sumtitle-->", "【摘要】&nbsp;&nbsp;" + data.sumtitle);
				str = str.replace("<!--sumtitleTooltip-->", "title='" + data.sumtitle + "'");
			}
			else
			{
				str = str.replace("<!--sumtitleTooltip-->", "");
			}			
			if (data.actrecid == null)
				str = str.replace("<!--nextstepusers-->", LWFP.HistoryList.buildNextUserHtml(wfdata, data));
			if (data.stepdesc != null)
				str = str.replace("<!--rollbackdesc-->", "<div class='lwfphistorylist_item_row'>" + data.stepdesc + "</div>");
			if (data.agentname != null)
				str = str.replace("<!--agent-->", "（代理人：" + data.agentname + "）");
		}
		else if (type == LWFP.HistoryList.symbol.actiontype)
		{
			str = LWFP.HistoryList.itemTemplate;
			str = str.replace("<!--starttime-->", LEAP.formatdate(data.createtime.time, 0));
			str = str.replace("<!--ownername-->", data.ownername);
			str = str.replace("<!--stepaliasname-->", data.outactionaliasname); 
			str = str.replace("<!--endtime-->", LEAP.formatdate(data.finishtime.time, 0));
			if (data.actsumtitle != null)
			{
				str = str.replace("<!--sumtitle-->", "<font class='lwfphistorylist_font_blue_1'>[&nbsp;摘要&nbsp;]</font>" + data.actsumtitle);
				str = str.replace("<!--sumtitleTooltip-->", "title='" + data.actsumtitle + "'");
			}
			else
			{
				str = str.replace("<!--sumtitleTooltip-->", "");
			}
			str = str.replace("@stepaliasname", data.outactionaliasname);
			str = str.replace("@modulename", data.actmodulename);
			str = str.replace("@recid", data.actrecid);
			str = str.replace("<!--nextstepusers-->", LWFP.HistoryList.buildNextUserHtml(wfdata, data));
			if (data.agentname != null)
				str = str.replace("<!--agent-->", "（代理人：" + data.agentname + "）");			
		}
		
		if (allowShowRecord == false 
			|| (type == LWFP.HistoryList.symbol.steptype && data.recid == null) 
			|| (type == LWFP.HistoryList.symbol.actiontype && data.actrecid == null) 
			|| (data.subflowentry != null))
			str = str.replaceall("href='javascript:void(0)'","");
		
		return str;
	}
	finally
	{
		str = null;
	}
}

LWFP.HistoryList.buildNextUserHtml = function(wfdata, hisstep)
{	
	try
	{		
		var nextStepCaller = "";//后续步骤的caller
		var allIsRead = true;
		var str = "";
		var arr = new Array();
		if (wfdata.curSteps != null && wfdata.curSteps.length > 0)
		{
			for(var i=0; i<wfdata.curSteps.length; i++)
			{
				var cur = wfdata.curSteps[i];
				if (cur.prevId != null && cur.prevId == hisstep.hsid)
				{					
					nextStepCaller = cur.callername;
					if (cur.ownername != null)
						str = cur.ownerorganname + cur.ownername;
					else if (cur.ownerpositionname != null)
						str = cur.ownerorganname + cur.ownerpositionname;		
					else if (cur.ownerorganname != null)
						str = cur.ownerorganname;
						
					if (cur.readstep != null && cur.readstep == 1)
						str = "(抄送)" + str;
					
					if (cur.status == 0)      
						str = "4<FONT style='FONT-SIZE: 12px;color:red;' ctf='jump' _csid='" + cur.csid + "' _stepid='" + cur.stepid + "' _cowner=" + (cur.canChangeOwner && cur.owner != null) + ">" + str + "（未阅）；</FONT>";
					else if (cur.status == 1) 
						str = "3<FONT style='FONT-SIZE: 12px;color:red;' ctf='jump' _csid='" + cur.csid + "' _stepid='" + cur.stepid + "' _cowner=" + (cur.canChangeOwner && cur.owner != null) + ">" + str + "（" + ( (cur.readstep != null && cur.readstep == 1) ? "在阅" : "已阅" ) + ":" + LEAP.formatdate(cur.readtime.time, 0) + "）；</FONT>";
					else if (cur.status == 2) 
						str = "2<FONT style='FONT-SIZE: 12px;color:red;' ctf='jump' _csid='" + cur.csid + "' _stepid='" + cur.stepid + "' _cowner=" + (cur.canChangeOwner && cur.owner != null) + ">" + str + "（" + ( (cur.readstep != null && cur.readstep == 1) ? "在阅" : "在办" )  + ":" + LEAP.formatdate(cur.readtime.time, 0) + "）；</FONT>";
										
					arr.add(str);
					
					if (cur.readstep == null || cur.readstep != 1)
						allIsRead = false;
				}
			}
		}
		
		for(var i=0; i<wfdata.historySteps.length; i++)
		{
			var his = wfdata.historySteps[i];
			if (his.prevId != null && his.prevId == hisstep.hsid)
			{
				nextStepCaller = his.callername;
				
				if (his.ownername != null)
					str = his.ownerorganname + his.ownername;
				else if (his.ownerpositionname != null)
					str = his.ownerorganname + his.ownerpositionname;	
				else if (his.ownerorganname != null)
					str = his.ownerorganname;

				if (his.subflowentry != null)
				{
					str += "【" + his.stepaliasname + "】";
					if (his.subflowdone != null && his.subflowdone==1)
						str = "1" + str + "（已办:" + LEAP.formatdate(his.finishtime.time, 0) + "）；";
					else
						str = "1" + str + "（在办）；";
				}
				else
				{
					if (his.readstep != null && his.readstep == 1)
						str = "(抄送)" + str;
						
					if (his.status == 4)
						str = "1" + str + "（已回收）；";
					else
						str = "1" + str + "（" +  ((his.readstep != null && his.readstep == 1) ? "已阅":"已办" )  +":" + LEAP.formatdate(his.finishtime.time, 0) + "）；";
				}
				arr.add(str);
				
				if (his.readstep == null || his.readstep != 1)
					allIsRead = false;
			}
		}
		
		if (arr.length <=0)
		{
			if (hisstep.finishstatus == 1)
				return "<div class='lwfphistorylist_item_row' style='float:left;'><font style='FONT-SIZE: 12px; color:red'>由[" + hisstep.ender + "]强制执行[" + hisstep.outactionaliasname + "]</font></div>"; 
			else if (hisstep.finishstatus == 3)
				return "<div class='lwfphistorylist_item_row' style='float:left;'><font style='FONT-SIZE: 12px; color:red'>由[" + hisstep.ender + "]" + ( (hisstep.finishdesc!=null)?hisstep.finishdesc:"强制结束") + "</font></div>";
			else
				return "";
		}
		else
		{
			arr.sort();
			str = "";
			for(var i=0; i<arr.length; i++)
				str += arr[i].substring(1) + "<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";

			if (hisstep.outactionid == "pushback")
			{
				return "<div class='lwfphistorylist_item_row' style='color:red;float:left;'>退回至：" + str + "</div>";
			}
			else
			{	
				if (hisstep.finishstatus == 1)
				{
					return "<div class='lwfphistorylist_item_row' style='float:left;'><font style='FONT-SIZE: 12px; color:red'>由[" + nextStepCaller + "]强制执行[" + hisstep.outactionaliasname + "]</font> <br>发送至：" + str + "</div>";
				}
				else
				{
					var actName = hisstep.outactionaliasname;
					if (actName == null || allIsRead == true) 
						actName = ""; 
					else
						actName = "【" + actName + "】";
				
					if (hisstep.canResend == false)
						return "<div class='lwfphistorylist_item_row' style='float:left;'>" + actName + "发送至：" + str + "</div>";
					else
						return "<div class='lwfphistorylist_item_row' style='float:left;'>" + actName + "发送至：" + str + 
							"<br><FONT style='FONT-SIZE:12px; color:red; cursor:hand;' ctf='resend'>[补发]</FONT>" + "</div>";
				}
			}
		}
	}
	finally
	{
		nextStepCaller = str = arr = i = cur = his = actName = null;
	}
	
}


LWFP.HistoryList.init();
/**
 
 <DIV class='wfcontrol_imgview' ct='imgview' viewmode='0'>
	<IMG style="DISPLAY: none" onerror=LEAP.imgview.i(0); src="data:image:png,base64">			
</DIV>
 
属性：
	viewmode 	:浏览模式，0缩略1预览
 
方法：
	LEAP.imgview.setValue(element, images)
				images: [{namedpath:已命名路径, name:文件名, uuid:uuid}] 

**/

LEAP.imgview = {};
LEAP.imgview.d = 'imgview';
LEAP.imgview.n = 'imgdata';
LEAP.imgview.ctf = {left:"_lef", right:"_right", center:"_center", centerCon:"_centercon", 
					imgdiv:"_imgdiv", img:"_img", cross:"_imgpreviewcross", 
					preview:"___imgpreview", operation:"operation", zoomout:"zoomout", zoomin:"zoomin",
					zoomback:"zoomback", rotateLeft:"rotateLeft", rotateright:"rotateright",
					canvas:"_canvas_"};
LEAP.imgview.W = {W0:30, W1:80, PW:900, PH:600};
LEAP.imgview.PF = null;

LEAP.imgview.init = function()
{
	if (document != null && document.body != null)
	{
		LEAP.imgview._init();
	}
	else
	{
		UIEventManager.addEvent(window, 'load', LEAP.imgview._init);
	}
}
LEAP.imgview._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.imgview.uiProcess, null, null, true);
	LEAP.addEvent(document.body, 'mousedown', LEAP.imgview.uiProcess, null, null, true);
	
	UIEventManager.removeEvent(window, 'load', LEAP.imgview._init);
}
LEAP.imgview.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		var ctf = src.getAttribute('ctf');		
		if (ctf == null)
		{
			if (LEAP.imgview.PF)
				LEAP.imgview.PF.style.display = "none";
			
			return;
		}
		
		var element = LEAP._match(src, LEAP.imgview.d);
		if (arg.e.type == 'click')
		{
			if (element != null)
			{	
				if (ctf == LEAP.imgview.ctf.left)
				{
					if (src.className == "wfcontrol_left_0" || src.className == "wfcontrol_left_1") 
						LEAP.imgview._scroll(element, "L");
				}
				else if (ctf == LEAP.imgview.ctf.right)
				{
					if (src.className == "wfcontrol_right_0" || src.className == "wfcontrol_right_1")
						LEAP.imgview._scroll(element, "R");
				}
				else if (ctf == LEAP.imgview.ctf.img || ctf == LEAP.imgview.ctf.imgdiv)
				{
					LEAP.imgview._preview(element, element[LEAP.imgview.n], parseInt( src.getAttribute('_idx')) );
				}
			}
			else if (ctf == LEAP.imgview.ctf.cross)
			{
				LEAP.imgview.PF.style.display = "none";
			}
			else if (ctf == LEAP.imgview.ctf.preview || ctf == LEAP.imgview.ctf.operation)
			{}
			else if (ctf == LEAP.imgview.ctf.rotateLeft)
			{
				LEAP.imgview.rotate("left");
			}
			else if (ctf == LEAP.imgview.ctf.rotateright)
			{
				LEAP.imgview.rotate("right");
			}
			else if (ctf == LEAP.imgview.ctf.zoomout)
			{
				LEAP.imgview.rotate(null, "+");
			}
			else if (ctf == LEAP.imgview.ctf.zoomin)
			{
				LEAP.imgview.rotate(null, "-");
			}
			else if (ctf == LEAP.imgview.ctf.zoomback)
			{
				LEAP.imgview.rotate(null, "0");
			}
			else if (LEAP.imgview.PF)
			{
				//LEAP.imgview.PF.style.display = "none";
			}
		}
		else if (arg.e.type == 'mousedown')
		{
			if (ctf == LEAP.imgview.ctf.canvas || ctf == LEAP.imgview.ctf.img)
			{
				if (element.getAttribute('viewmode') == '0')
					return;
					
				LEAP.imgview.onmousedown(arg.e);
			}
		}
		else if (arg.e.type == 'mousemove')
		{
			if (ctf == LEAP.imgview.ctf.canvas || ctf == LEAP.imgview.ctf.img)
				LEAP.imgview.onmousemove(arg.e);
		}
		else if (arg.e.type == 'mouseup')
		{
			if (ctf == LEAP.imgview.ctf.canvas || ctf == LEAP.imgview.ctf.img)
			{
				LEAP.imgview.DragParams.flag = false;	
				LEAP.imgview.DragParams.dragobject = null;
				LEAP.removeEvent(document.body, 'mousemove', LEAP.imgview.uiProcess, true);
				LEAP.removeEvent(document.body, 'mouseup', LEAP.imgview.uiProcess, true);
			}
		}
	}
	finally
	{
		src = ctf = element = null;
	}
}

LEAP.imgview.DragParams = {
	left: 0,
	top: 0,
	currentX: 0,
	currentY: 0,
	dragobject: null,
	flag: false
};

LEAP.imgview.onmousedown = function(event)
{	
	try
	{
		var e = event;	
		if (e.srcElement.getAttribute('ctf') == LEAP.imgview.ctf.canvas || e.srcElement.getAttribute('ctf') == LEAP.imgview.ctf.img)
		{
			LEAP.imgview.DragParams.currentX = e.clientX;
			LEAP.imgview.DragParams.currentY = e.clientY;
		
			LEAP.imgview.DragParams.left = e.srcElement.offsetLeft;
			LEAP.imgview.DragParams.top = e.srcElement.offsetTop;
		
			LEAP.imgview.DragParams.flag = true;
			LEAP.imgview.DragParams.dragobject = e.srcElement;
			
			LEAP.stopEvent(e);
			LEAP.addEvent(document.body, 'mousemove', LEAP.imgview.uiProcess, null, null, true);
			LEAP.addEvent(document.body, 'mouseup', LEAP.imgview.uiProcess, null, null, true);
		}
	}
	finally
	{
		e = null;
	}
};
LEAP.imgview.onmousemove = function(event)
{
	try
	{
		var e = event ? event: window.event;
		if(LEAP.imgview.DragParams.flag)
		{
			var nowX = e.clientX;
			var nowY = e.clientY;
			var disX = nowX - LEAP.imgview.DragParams.currentX; 
			var disY = nowY - LEAP.imgview.DragParams.currentY;
			
			LEAP.imgview.DragParams.dragobject.style.left = parseInt(LEAP.imgview.DragParams.left) + disX + "px";
			LEAP.imgview.DragParams.dragobject.style.top = parseInt(LEAP.imgview.DragParams.top) + disY + "px";
		}
		LEAP.stopEvent(e);
	}
	finally
	{
		e = nowX = nowY = disX = disY = null;
	}
};

LEAP.imgview.rotate = function(rotateType, zoomType)
{
	try
	{
		var element = LEAP.getElement("[ct=" + LEAP.imgview.d + "]", LEAP.imgview.PF);
		var _idx = parseInt(element.getAttribute("curIdx"));
		var con = LEAP.getElement("[ctf=" + LEAP.imgview.ctf.centerCon + "]", element);
		var imgDiv = con.childNodes[_idx];
		var img = LEAP.getElement("[ctf=" + LEAP.imgview.ctf.img + "]", imgDiv);
		
	    var n = (img.getAttribute('step')==null) ? 0 : parseInt(img.getAttribute('step')); 
	    var m = (img.getAttribute('zoom')==null) ? 0 : parseInt(img.getAttribute('zoom'));
	        
	    if (rotateType)
	    {
		    if (rotateType == 'right')
		    { 
		        (n==3)? n=0:n++; 
		    }
		    else if (rotateType == 'left')
		    {
		        (n==0)? n=3:n--; 
		    }
	    }
	    
	    if (zoomType)
	    {
		    if (zoomType == '+')
		    { 
		        m++; 
		    }
		    else if (zoomType == '-')
		    {
		        (m==0)? m=0:m--; 
		    }
		    else
		    {
		    	m = 0;
		    }
	    }
	    
	    img.setAttribute('step', n);
	    img.setAttribute('zoom', m);
	    	     
	    var cSize = {W:img.parentElement.clientWidth, H:img.parentElement.clientHeight};
	    if (LEAPBrowser.isIE && LEAPBrowser.IEVersion <= 8)
		{
			var size = {W:img.getAttribute('__w'), H:img.getAttribute('__h')};
			img.style.filter = 'progid:DXImageTransform.Microsoft.BasicImage(rotation='+ n +')';
	        switch(n)
	        {
	            case 0: 
	            	size = {W:size.W, H:size.H};
	            	if (size.W > cSize.W || size.H > cSize.H)
			        	size = LEAP.imgview._getSize(cSize.W, cSize.H, size.W, size.H);
			        	
			        size.W = Math.floor( (m*20 + 100)*size.W/100);
			        size.H = Math.floor( (m*20 + 100)*size.H/100);
			        
			        var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};	            
			        
					img.style.width = size.W + "px";
					img.style.height = size.H + "px";		
					img.style.left = p.L + "px";
					img.style.top = p.T + "px";
					
	                break; 
	            case 1: 
	                size = {W:size.H, H:size.W};                
	                if (size.W > cSize.W || size.H > cSize.H)
			        	size = LEAP.imgview._getSize(cSize.W, cSize.H, size.W, size.H);
			        	
			        size.W = Math.floor( (m*20 + 100)*size.W/100);
			        size.H = Math.floor( (m*20 + 100)*size.H/100);
			        
			        var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};	            
			        
					img.style.width = size.H + "px";
					img.style.height = size.W + "px";		
					img.style.left = p.L + "px";
					img.style.top = p.T + "px";
					                
	                break; 
	            case 2: 
	                size = {W:size.W, H:size.H};
	                if (size.W > cSize.W || size.H > cSize.H)
			        	size = LEAP.imgview._getSize(cSize.W, cSize.H, size.W, size.H);
			        	
			        size.W = Math.floor( (m*20 + 100)*size.W/100);
			        size.H = Math.floor( (m*20 + 100)*size.H/100);
			        
			        var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};	            
			        
					img.style.width = size.W + "px";
					img.style.height = size.H + "px";		
					img.style.left = p.L + "px";
					img.style.top = p.T + "px";
					
	                break; 
	            case 3: 
	                size = {W:size.H, H:size.W};
	                if (size.W > cSize.W || size.H > cSize.H)
			        	size = LEAP.imgview._getSize(cSize.W, cSize.H, size.W, size.H);
			        	
			        size.W = Math.floor( (m*20 + 100)*size.W/100);
			        size.H = Math.floor( (m*20 + 100)*size.H/100);
			        
			        var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};	            
			        
					img.style.width = size.H + "px";
					img.style.height = size.W + "px";		
					img.style.left = p.L + "px";
					img.style.top = p.T + "px";
					
	                break; 
	        }
		}
		else
		{		
			var c = LEAP.getElement("[ctf=" + LEAP.imgview.ctf.canvas + "]", imgDiv); 
			if (c == null)
			{
		    	img.style.visibility = 'hidden';
				img.style.position = 'absolute';
				c = document.createElement('canvas');
				c.style.position = 'absolute';
				c.setAttribute('ctf', LEAP.imgview.ctf.canvas);
				
		    	img.parentNode.appendChild(c);
			}
		    
			var ccanvasContext = c.getContext('2d');
		    switch(n) 
		    {
		        default:
		        case 0 :
		            var size = {W:img.naturalWidth, H:img.naturalHeight};	
					if (size.W > cSize.W || size.H > cSize.H)
		            	size = LEAP.imgview._getSize(cSize.W, cSize.H, img.naturalWidth, img.naturalHeight);
		            	
		            size.W = Math.floor( (m*20 + 100)*size.W/100);
		            size.H = Math.floor( (m*20 + 100)*size.H/100);
		            
		            var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};
		            
		            c.setAttribute('width', size.W);
		    		c.setAttribute('height', size.H);
		    		c.style.left = p.L + "px";
		            c.style.top = p.T + "px";
		    		
		            ccanvasContext.rotate(0 * Math.PI / 180);
		            ccanvasContext.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, size.W, size.H);
		
		            break;
		        case 1 :
		            var size = {W:img.naturalHeight, H:img.naturalWidth};						
					if (size.W > cSize.W || size.H > cSize.H)
		            	size = LEAP.imgview._getSize(cSize.W, cSize.H, img.naturalHeight, img.naturalWidth);
		            
		            size.W = Math.floor( (m*20 + 100)*size.W/100);
		            size.H = Math.floor( (m*20 + 100)*size.H/100);
		            
		            var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};
		            
		            c.setAttribute('width', size.W); 
		    		c.setAttribute('height', size.H);
		    		c.style.left = p.L + "px";
		            c.style.top = p.T + "px";
		            
		            ccanvasContext.rotate( n * 90 * Math.PI / 180);
		            ccanvasContext.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, -size.W, size.H, size.W);
		            
		            break;
		        case 2 :            
		            var size = {W:img.naturalWidth, H:img.naturalHeight};						
					if (size.W > cSize.W || size.H > cSize.H)
		            	size = LEAP.imgview._getSize(cSize.W, cSize.H, img.naturalWidth, img.naturalHeight);
		            	
		            size.W = Math.floor( (m*20 + 100)*size.W/100);
		            size.H = Math.floor( (m*20 + 100)*size.H/100);
		            
		            var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};
		            
		            c.setAttribute('width', size.W); 
		    		c.setAttribute('height', size.H);
		    		c.style.left = p.L + "px";
		            c.style.top = p.T + "px";
		            
		            ccanvasContext.rotate(n * 90 * Math.PI / 180);
		            ccanvasContext.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, -size.W, -size.H, size.W, size.H );
		            
		            break;
		        case 3 :
		            var size = {W:img.naturalHeight, H:img.naturalWidth};						
					if (size.W > cSize.W || size.H > cSize.H)
		            	size = LEAP.imgview._getSize(cSize.W, cSize.H, img.naturalHeight, img.naturalWidth);
		            
		            size.W = Math.floor( (m*20 + 100)*size.W/100);
		            size.H = Math.floor( (m*20 + 100)*size.H/100);
		            
		            var p = {L:Math.floor( (cSize.W - size.W)/2 ), T:Math.floor( (cSize.H - size.H)/2 )};
		                        
		            c.setAttribute('width', size.W); 
		    		c.setAttribute('height', size.H);
		    		c.style.left = p.L + "px";
		            c.style.top = p.T + "px";
		    		
		            ccanvasContext.rotate(n * 90 * Math.PI / 180);
		            ccanvasContext.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, -size.H, 0, size.H, size.W);
		            
		            break;
		    }
		}
	}
	finally
	{
		element = _idx = con = imgDiv = img = n = m = cSize = size = p = c = ccanvasContext = null;		
	}
}

LEAP.imgview.initPreviewForm = function()
{
	if (LEAP.imgview.PF)
		return;
		
	try
	{
		LEAP.imgview.W.PW = document.body.clientWidth - 200;
		LEAP.imgview.W.PH = document.body.clientHeight - 120;
		
		LEAP.imgview.PF = document.createElement('div');
		LEAP.imgview.PF.className = "wfcontrol_pf";
		LEAP.imgview.PF.style.width = LEAP.imgview.W.PW + "px";
		LEAP.imgview.PF.style.height = LEAP.imgview.W.PH + "px";
		LEAP.imgview.PF.setAttribute("ctf", LEAP.imgview.ctf.preview);
		
		var L = Math.floor((document.body.clientWidth - LEAP.imgview.W.PW) / 2);
		var T = Math.floor((document.body.clientHeight - LEAP.imgview.W.PH) / 2);
		
		LEAP.imgview.PF.style.left = L + "px";
		LEAP.imgview.PF.style.top = T + "px";
				
		var cross = document.createElement('div');
			cross.className = "wfcontrol_pf_close";
			cross.setAttribute("ctf", LEAP.imgview.ctf.cross);
			
		var div = document.createElement('div');
			div.className = "wfcontrol_pf_con";
			div.style.width = LEAP.imgview.W.PW + "px";
			div.style.height = (LEAP.imgview.W.PH - 100) + "px";
			
		var div_op = document.createElement('div');
			div_op.className = "wfcontrol_pf_operation";
			div_op.setAttribute("ctf", LEAP.imgview.ctf.operation);
			
		var div_zoomout = document.createElement('div');
			div_zoomout.className = "wfcontrol_pf_operation_zoomout";
			div_zoomout.setAttribute("ctf", LEAP.imgview.ctf.zoomout);
		var div_zoomin = document.createElement('div');
			div_zoomin.className = "wfcontrol_pf_operation_zoomin";
			div_zoomin.setAttribute("ctf", LEAP.imgview.ctf.zoomin);
		var div_zoomback = document.createElement('div');
			div_zoomback.className = "wfcontrol_pf_operation_zoomback";
			div_zoomback.setAttribute("ctf", LEAP.imgview.ctf.zoomback);
		var div_rLeft = document.createElement('div');
			div_rLeft.className = "wfcontrol_pf_operation_rotateLeft";
			div_rLeft.setAttribute("ctf", LEAP.imgview.ctf.rotateLeft);
		var div_rRight = document.createElement('div');
			div_rRight.className = "wfcontrol_pf_operation_rotateright";
			div_rRight.setAttribute("ctf", LEAP.imgview.ctf.rotateright);
		div_op.appendChild(div_zoomout);
		div_op.appendChild(div_zoomin);
		div_op.appendChild(div_zoomback);
		div_op.appendChild(div_rLeft);
		div_op.appendChild(div_rRight);
		
		document.body.appendChild(LEAP.imgview.PF);
		
		LEAP.imgview.PF.appendChild(cross);
		LEAP.imgview.PF.appendChild(div);
		LEAP.imgview.PF.appendChild(div_op);
				
		div.innerHTML = "<DIV ctf='dsafdsimagepreview' class='wfcontrol_imgview' ct='imgview' viewwidth=60000 viewheight=60000 viewmode='1'><IMG style='DISPLAY: none' onerror=LEAP.imgview.i(0); src='data:image:png,base64'></DIV>";
	}
	finally
	{
		L = T = cross = div = div_op = div_zoomout = div_zoomin = div_zoomback = div_rLeft = div_rRight = null;
	}
}

LEAP.imgview.preview = function(element, atts, previewIndex, previewParam)
{
	LEAP.imgview._preview(element, atts, previewIndex, previewParam);
}
LEAP.imgview._preview = function(element, atts, previewIndex, previewParam)
{
	if (element && element.getAttribute('viewmode') != '0')
		return;
		
	LEAP.imgview.initPreviewForm();
	
	LEAP.imgview.PF.style.display = "block";

	LEAP.IFrameTray.tray(LEAP.imgview.PF);
	
	LEAP.imgview.setPreviewParam(LEAP.getElement("div[ctf=dsafdsimagepreview]", LEAP.imgview.PF), previewParam);
	
	LEAP.imgview.setValue(LEAP.getElement("div[ctf=dsafdsimagepreview]", LEAP.imgview.PF), atts, previewIndex);
}

LEAP.imgview.setPreviewParam = function(element, previewParam)
{
	if (previewParam && previewParam.previewwidth && previewParam.previewheight)
	{
		element.setAttribute('viewwidth', previewParam.previewwidth);
		element.setAttribute('viewheight', previewParam.previewheight);
	}
	else
	{
		element.removeAttribute('viewwidth');
		element.removeAttribute('viewheight');
	}	
}

LEAP.imgview._scroll = function(element, type)
{
	try
	{
		var center = LEAP.getElement('div[ctf=' + LEAP.imgview.ctf.center + ']', element);
		var con = LEAP.getElement('div[ctf=' + LEAP.imgview.ctf.centerCon + ']', element);
		var w = parseInt(element.getAttribute("imgwidth"));
		var L = parseInt(center.scrollLeft);
		var _idx = parseInt(element.getAttribute("curIdx"));
				
		//复位当前图片
		if (element.getAttribute('viewmode') == '1')
		{
			var curImgDiv = con.childNodes[_idx];
			var curImg = LEAP.getElement("[ctf=" + LEAP.imgview.ctf.img + "]", curImgDiv);
			curImg.setAttribute("zoom", -1);
			curImg.setAttribute("step", 0);
			LEAP.imgview.rotate(null, "+");			
		}
		
		var _newIdx = _idx;
		if (type == "L")
		{
			if (_idx > 0) 
				_newIdx = _idx - 1;
			
			center.scrollLeft = L - w;	
		}
		else
		{	
			
			if (_idx < element[LEAP.imgview.n].length -1 )
				_newIdx = _idx + 1;
				
			center.scrollLeft = L + w;
		}
		
		element.setAttribute("curIdx", _newIdx);		
		
		LEAP.imgview._changeArrow(element, _newIdx);
	}
	finally
	{
		center = con = w = L = _idx = curImgDiv = curImg = _newIdx = null;
	}
}

LEAP.imgview._changeArrow = function(element, _newIdx)
{	
	try
	{
		var left = LEAP.getElement('div[ctf=' + LEAP.imgview.ctf.left + ']', element);
		var right = LEAP.getElement('div[ctf=' + LEAP.imgview.ctf.right + ']', element);
		var viewmode = element.getAttribute('viewmode');
		if (element[LEAP.imgview.n].length == 1)
		{
			left.className = (viewmode=='0') ? "wfcontrol_left_0_b":"wfcontrol_left_1_b";
			right.className = (viewmode=='0') ? "wfcontrol_right_0_b":"wfcontrol_right_1_b";			
		}
		else
		{
			if (_newIdx == 0)
			{
				left.className = (viewmode=='0') ? "wfcontrol_left_0_b":"wfcontrol_left_1_b";
				right.className = (viewmode=='0') ? "wfcontrol_right_0":"wfcontrol_right_1";
			}
			else if (_newIdx < (element[LEAP.imgview.n].length-1) )
			{
				left.className = (viewmode=='0') ? "wfcontrol_left_0":"wfcontrol_left_1";
				right.className = (viewmode=='0') ? "wfcontrol_right_0":"wfcontrol_right_1";
			}			
			else if (_newIdx == (element[LEAP.imgview.n].length-1) )
			{	
				left.className = (viewmode=='0') ? "wfcontrol_left_0":"wfcontrol_left_1";
				right.className = (viewmode=='0') ? "wfcontrol_right_0_b":"wfcontrol_right_1_b";
			}
		}
	}
	finally
	{
		left = right = viewmode = null;
	}
}

LEAP.imgview.setValue = function(element, images, previewIndex)
{	
	if (element['hasinit'] == true)
	{
		var fn = function()
		{
			LEAP.imgview._setValue(element, images, previewIndex);
		}
		setTimeout(fn, 20);
	}
	else
	{	
		var fn = function()
		{
			LEAP.imgview.setValue(element, images, previewIndex);
		};
		
		setTimeout(fn, 20);
	}
}

LEAP.imgview._setValue = function(element, images, previewIndex)
{
	try
	{
		element[LEAP.imgview.n] = images;
		
		var viewmode = element.getAttribute('viewmode');
		var con = LEAP.getElement('div[ctf=' + LEAP.imgview.ctf.centerCon + ']', element);
		var center = LEAP.getElement('div[ctf=' + LEAP.imgview.ctf.center + ']', element);
		center.scrollLeft = 0;
		con.innerHTML = "";
		
		var H = center.clientHeight;
		var W = center.clientWidth;
		
		if (viewmode == '0')
			var W = Math.floor(H * 5 / 6);
			
		element.setAttribute("imgwidth", W + 10);
			
		for(var i=0; i<images.length; i++)
		{
			var _att = images[i];
			var div = document.createElement('div');
				div.className = 'wfcontrol_img_div';
				div.setAttribute('ctf', LEAP.imgview.ctf.imgdiv);
				div.setAttribute('_idx', i);
				div.style.height = H + 'px';
				div.style.width = W + 'px';				
				
			var img = document.createElement('img');
				img.className = 'wfcontrol_img';
				img.setAttribute('ctf', LEAP.imgview.ctf.img);
				img.setAttribute('_idx', i);				
				img.src = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/StyleSheet/control/images/imgview/loading.gif";								
				img.style.left = Math.floor( (W - 32)/2 ) + "px";
				img.style.top = Math.floor( (H - 32)/2 ) + "px";
				
			con.appendChild(div);
			div.appendChild(img);
			
			//LEAP.upload.getPath = function(nameedPath, path, uuid, showname, title, width, height)
			var url = LEAP.upload.getPath(((_att.namedpath)?_att.namedpath:_att.nameedPath), _att.name, _att.uuid, null, _att.tilte, null, null, _att.fileid, LEAP.wfrouter.router);
			//大于2M才使用缩略图
			if(_att.attsize >2097152){
				url = LEAP.upload.getPath(((_att.namedpath)?_att.namedpath:_att.nameedPath), _att.name, _att.uuid, null, _att.tilte, element.getAttribute('viewwidth'), element.getAttribute('viewheight'), _att.fileid, LEAP.wfrouter.router);
			}

			//var url = LEAP.upload.getPath(((_att.namedpath)?_att.namedpath:_att.nameedPath), _att.name, _att.uuid, null, _att.tilte, element.getAttribute('viewwidth'), element.getAttribute('viewheight'), _att.fileid, LEAP.wfrouter.router);
			if (element.getAttribute('viewwidth') != null && element.getAttribute('viewheight') != null)
			{
				if (url.indexOf("?") > 0)
					url = url + "&w=" +	element.getAttribute('viewwidth') + "&h=" + element.getAttribute('viewheight')+ "&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
				else
					url = url + "?w=" +	element.getAttribute('viewwidth') + "&h=" + element.getAttribute('viewheight')+ "&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
			}else{
				if (url.indexOf("?") > 0){
					url = url + "&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
				}else{
					url = url + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
				}
			}
			
			LEAP.imgview._loadIMG(url, img, null, LEAP.imgview);			
		}
		
		con.style.width = images.length * (W + 10) + "px";
						
		
		if (previewIndex != null)
		{
			center.scrollLeft = parseInt(center.scrollLeft) + (W + 10) * previewIndex;
			element.setAttribute("curIdx", previewIndex);
			LEAP.imgview._changeArrow(element, previewIndex);
		}
		else
		{
			element.setAttribute("curIdx", 0);
			LEAP.imgview._changeArrow(element, 0);
		}
		
		
	}
	finally
	{
		viewmode = con = center = H = W = i = _att = div = img = url = null;
	}
}

LEAP.imgview._loadIMG = function(url, target, callback, domain)
{
	var img = new Image();
	var imgctid = LEAP.ctid(img);
	var targetctid = null;
	if (target && target.tagName)
	{
		targetctid = LEAP.ctid(target);
		//target.style.display = 'none';
	}
	if (domain == null)
		domain = window;
	if (callback == null)
	{
		callback = function(arg)
		{
			if (arg.target)
			{
				var target = LEAP.getElement('IMG[ctid=' + arg.target + ']');
				if (target)
				{
					if (arg.error)
					{
						//target.style.display = 'none';
					}
					else
					{
						target.src = arg.url;
						var trgSize = {W:target.parentElement.clientWidth, H:target.parentElement.clientHeight};						
						var size = {W:arg.width, H:arg.height};						
						if (size.W > trgSize.W || size.H > trgSize.H)						
							size = LEAP.imgview._getSize(trgSize.W, trgSize.H, arg.width, arg.height);
						
						target.style.width = size.W + "px";
						target.style.height = size.H + "px";
						
						target.style.left = Math.floor( (trgSize.W - size.W)/2 ) + "px";
						target.style.top = Math.floor( (trgSize.H - size.H)/2 ) + "px";
						
						target.setAttribute("__w", arg.width);
						target.setAttribute("__h", arg.height);
						
					}
				}
				target = trgSize = size = null;
			}
		}
	}
	if (LEAPBrowser.isIE && LEAPBrowser.IEVersion < 11)
	{
		img.onreadystatechange = function()
		{
			if (img.readyState == "complete" || img.readyState == "loaded")
			{
				callback.apply(domain, [
						{
							url		: url,
							error	: false,
							target	: targetctid,
							width	: img.width,
							height	: img.height
						}]);
				img = null;
			}
		}
	}
	else
	{
		img.onload = function()
		{
			if (img.complete == true)
			{
				callback.apply(domain, [
						{
							url		: url,
							error	: false,
							target	: targetctid,
							width	: img.width,
							height	: img.height
						}]);
				img = null;
			}
		}
	}
	img.onerror = function()
	{
		callback.apply(domain, [
				{
					url		: url,
					error	: true,
					target	: targetctid,
					width	: null,
					height	: null
				}]);
		img = null;
	}
	img.src = url;
	target = null;
}

LEAP.imgview._getSize = function(conW, conH, srcW, srcH)
{
	try
	{
		var H = 0;
		var W = 0;
		if ((conW/conH) > (srcW/srcH)) //高度较大
		{	
			H = conH;
			W =  Math.floor( srcW * conH / srcH );
		}
		else
		{
			W = conW;
			H = Math.floor(srcH * conW / srcW);
		}
		
		return {W:W, H:H};
	}
	finally
	{
		H = W = null;
	}
}

LEAP.imgview.i = function(wait, src)
{
	try
	{
		if (!src)
		{
			if (!event)
				return;
			src = event.srcElement;
		}
		if (!src)
			return;
	
		var _element = LEAP._match(src, LEAP.imgview.d);
		if (_element == null)
			return;
				
		LEAP.imgview._i(_element);
		
		if (src.parentElement)
			src.parentElement.removeChild(src);
	}
	finally
	{
		_element = null;
	}
}

LEAP.imgview._i = function(element)
{
	try
	{
		element['hasinit'] == false;
		
		if (!element.getAttribute('viewmode'))
			element.setAttribute('viewmode', '0');
			
		var viewmode = element.getAttribute('viewmode');
		
		element.innerHTML = "";
		
		var left = document.createElement('div');
			left.className = (viewmode=='0') ? "wfcontrol_left_0_b" : "wfcontrol_left_1_b";
			left.style.width = (viewmode=='0') ? LEAP.imgview.W.W0 + "px" : LEAP.imgview.W.W1 + "px";
			left.setAttribute('ctf', LEAP.imgview.ctf.left);
		
		var right = document.createElement('div');
			right.className = (viewmode=='0') ? "wfcontrol_right_0_b" : "wfcontrol_right_1_b";
			right.style.width = (viewmode=='0') ? LEAP.imgview.W.W0 + "px" : LEAP.imgview.W.W1 + "px";
			right.setAttribute('ctf', LEAP.imgview.ctf.right);
			
		var center = document.createElement('div');
			center.className = "wfcontrol_center";
			center.setAttribute('ctf', LEAP.imgview.ctf.center);
			center.style.width = ( element.clientWidth - ((viewmode=='0') ? LEAP.imgview.W.W0 : LEAP.imgview.W.W1)*2 ) + 'px';
			
		var centerCon = document.createElement('div');
			centerCon.className = "wfcontrol_center_con";
			centerCon.setAttribute('ctf', LEAP.imgview.ctf.centerCon);
			
		center.appendChild(centerCon);
			
		element.appendChild(left);
		element.appendChild(center);
		element.appendChild(right);
		
		element['hasinit'] = true;
	}
	finally
	{
		viewmode = left = right = center = centerCon = null;
	}
}

LEAP.imgview.init();





LEAP.IFrameTray = {};
LEAP.IFrameTray.ctf = "IFrameTray";
LEAP.IFrameTray.tray = function(element)
{
	LEAP.asyn(LEAP.IFrameTray._tray, this, 50, element);
}

LEAP.IFrameTray.iframe = null;
LEAP.IFrameTray._tray = function(element)
{
	try
	{	
		if (LEAP.IFrameTray.iframe == null)
		{
			LEAP.IFrameTray.iframe = document.createElement("iframe");		
			LEAP.IFrameTray.iframe.style.cssText = "left: 0px; top: 0px; width: 100%; height: 100%; border:none; visibility: inherit; position: absolute; z-index: -1;";
			LEAP.IFrameTray.iframe.setAttribute("ctf", LEAP.IFrameTray.ctf);			
			LEAP.IFrameTray.iframe.src = "javascript:false;";			
		}
		
		element.appendChild(LEAP.IFrameTray.iframe);
		
		var rect = element.getBoundingClientRect();
		LEAP.IFrameTray.iframe.style.top = "0px";
		LEAP.IFrameTray.iframe.style.left = "0px";
		LEAP.IFrameTray.iframe.style.width = (rect.clientWidth - 2) + "px";
		LEAP.IFrameTray.iframe.style.height = (rect.clientHeight - 2) + "px";
		
		LEAP.IFrameTray.iframe.style.display = "block";
		  
		LEAP.IFrameTray.iframe.src = "javascript:void(0)";
		try
		{
			LEAP.IFrameTray.iframe.contentWindow.document.write('');
			LEAP.IFrameTray.iframe.contentWindow.document.clear();
			LEAP.IFrameTray.iframe.contentWindow.close();
		}
		catch(e){}
	}
	finally
	{

	}
}

/**
 * capture
 * @class capture control
 * @type user control
 * @example
HTML定义示例:
<DIV class=button_frame style="FLOAT: left">
	<SPAN class="" ut="controlName" ct="capture" cap_type=1	cap_title="照片.jpeg" cap_width=300 
				cap_height=400 cap_uploadpath='default'>拍照</SPAN>
</DIV>

<script language="javascript" for="handwriter" event="OnHandwriteComplete(a,b,c,d,e)" type="text/javascript">
		LEAP.capture.handwriteCompleted(a, b, c, d, e);				
</script>
	
JS定义:

获取: 
	根据自定义标签获取:var capture = this.getUT('controlName');
	

方法：
	LEAP.capture.ScanRead = function(element, oldUri, extendParams)

事件:
	1、拍照结束事件		
		事件注册:
			this.addEvent(element,'OnCaptureComplete', OnCaptureComplete); 	
		事件体:
			this.OnCaptureComplete = function(e)
			{
				alert(e.arg2.uri); //e.arg2.uri为上传文件对象
			}
	2、扫描结束事件
		onScanComplete()
		
	3、扫描编辑结束事件
		onScanReadComplete()
		
	4、手写完成事件
		onHandwriteComplete()

标签:
	//拍照
	cap_type 类型 (1:拍照 默认1)
	cap_title 上传文件名 (默认:"照片.jpeg")	
	cap_width 照片宽度（像素）(默认300) 
	cap_height 照片高度（像素）(默认400)
	cap_uploadpath 上传通道 （默认default）
	
	cap_type 类型（2:扫描）	
	scan_quality 压缩比率1..100
	scan_maxwidth 图片压缩最大宽度（像素）
	scan_maxheight 图片压缩最大高度（像素）	
	scan_title 文件显示名
	scan_uploadpath 上传通道（默认default）
	scan_tct	
	
	cap_type 类型 (4:手写)
	hand_penSpeed 速度阀值， 默认5
	hand_penWidth 画笔笔宽，默认6
	hand_penColor 画笔颜色，默认255 RGB到画笔颜色的计算方式：(blue * 65536) + (green * 256) + red
	hand_charWidth 字符宽度，默认30
	hand_charHeight 字符高度，默认30
	hand_puncSize 符号尺寸 默认10
	hand_puncTh 符号阀值 默认50
	hand_cellspace 字符间距，默认3
	hand_delaytime 识别延时，起笔后到开始识别的时间,默认1000
	hand_filename	文件名，默认"handwrite.jpg"
	hand_uploadpath 上传通道，默认default
*/


LEAP.capture = {};
LEAP.capture.d = 'capture';
LEAP.capture.Frame = null;
LEAP.capture.s2 = "<OBJECT classid='clsid:19D2695A-033C-46CA-9AF4-395DB058F46A' codebase='@server@LEAP/LWFP/HTML/activex/LRHS.ocx#version=1,0,0,12' style='width:100%;height:100%;' id='handwriter' sc='resource' resource.att='CODEBASE'></OBJECT>";
LEAP.capture.capType={shoot:1, scan:2, scanread:3, handwrite:4, batch:5};
LEAP.capture.att={
		cap_type:1,
		cap_title:'照片.jpeg',	
		cap_width:300, 
		cap_height:400,
		cap_uploadpath:'default',
		scan_quality:100,
		scan_maxwidth:0,
		scan_maxheight:0,	
		scan_title:"新扫描件.zip",
		scan_uploadpath:"default",	
		hand_penSpeed:0.5, 
		hand_penWidth:8,
		hand_penColor:0,
		hand_charWidth:30,
		hand_charHeight:30,
		hand_puncSize:10,
		hand_puncTh:60,
		hand_cellspace:3,
		hand_delaytime:1000,
		hand_filename:"handwrite.jpeg",
		hand_uploadpath:"handsign"
	}
LEAP.capture.init = function()
{
	if (document != null && document.body != null)
		LEAP.capture._init();
	else UIEventManager.addEvent(window, 'load', LEAP.capture._init);
	ElementEventManager.addManagedEventType(LEAP.capture.d, 'OnCaptureComplete');
	ElementEventManager.addManagedEventType(LEAP.capture.d, 'onScanComplete');	
	ElementEventManager.addManagedEventType(LEAP.capture.d, 'onHandwriteComplete');
	ElementEventManager.addManagedEventType(LEAP.capture.d, 'onBatchUploadComplete');
	
}

LEAP.capture._init = function()
{	
	LEAP.addEvent(document.body, 'click', LEAP.capture.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LEAP.capture._init);		
}

LEAP.capture.uiProcess = function(arg)
{	
	try
	{
		var src = arg.e.srcElement;
		if(null == src) return;		
		var type = arg.e.type;
		if(null == type) return;
		var element = LEAP._match(src, LEAP.capture.d);
		if(null == element) return;
						
		var cap_type = String.isEmpty(element.getAttribute("cap_type")) ? LEAP.capture.att.cap_type:element.getAttribute("cap_type");
		if (cap_type == 1)
		{
			if (LEAP.capture.ActivexDetect(false, "LDSM") == false)
				return;
			var par = {};
				par.cap_type = LEAP.capture.capType.shoot;
				par.ctid = element.tagName + "[ctid=" + LEAP.ctid(element) + "]";
				
				par.cap_title = String.isEmpty(element.getAttribute("cap_title")) ? LEAP.capture.att.cap_title : element.getAttribute("cap_title");	
				par.cap_width = String.isEmpty(element.getAttribute("cap_width")) ? LEAP.capture.att.cap_width : element.getAttribute("cap_width"); 
				par.cap_height = String.isEmpty(element.getAttribute("cap_height")) ? LEAP.capture.att.cap_height : element.getAttribute("cap_height");
				par.cap_uploadpath = String.isEmpty(element.getAttribute("cap_uploadpath")) ? LEAP.capture.att.cap_uploadpath : element.getAttribute("cap_uploadpath");
							
			var ret = window.showModalDialog(window.geturl(leapconfig.server + "LEAP/LWFP/HTML/Default/capture/capturePage.html"),
								par, "scroll:0;status:0;help:1;resizable:0;dialogWidth:800px;dialogHeight:600px;");

			LEAP.capture.callback(ret);
			par = null;
		}
		else if (cap_type == 2)
		{
			if (LEAP.capture.ActivexDetect(false, "LDSM") == false)
				return;
			var tct = element.getAttribute('tct');				
			var telement = null;
			if (tct)
				telement = LEAP._match(element, tct, 'ct', 9);
				
			var par = {};
				par.cap_type = LEAP.capture.capType.scan;
				par.ctid = element.tagName + "[ctid=" + LEAP.ctid(element) + "]";
				par.scan_tct = tct;
								
				par.scan_quality = LEAP.capture.w(element, telement, "scan_quality");
				par.scan_maxwidth = LEAP.capture.w(element, telement, "scan_maxwidth");
				par.scan_maxheight = LEAP.capture.w(element, telement, "scan_maxheight");
				par.scan_title = LEAP.capture.w(element, telement, "scan_title");
				par.scan_uploadpath = LEAP.capture.w(element, telement, "scan_uploadpath");
								
				par.scan_quality = par.scan_quality==null ? LEAP.capture.att.scan_quality : par.scan_quality;
				par.scan_maxwidth = par.scan_maxwidth==null ? LEAP.capture.att.scan_maxwidth : par.scan_maxwidth;
				par.scan_maxheight = par.scan_maxheight==null ? LEAP.capture.att.scan_maxheight : par.scan_maxheight;
				par.scan_title = par.scan_title==null ? LEAP.capture.att.scan_title : par.scan_title;
				par.scan_uploadpath = par.scan_uploadpath==null ? LEAP.capture.att.scan_uploadpath : par.scan_uploadpath;
				
			var ret = window.showModalDialog(window.geturl(leapconfig.server + "LEAP/LWFP/HTML/Default/capture/capturePage.html"),
								par, "scroll:0;status:0;help:1;resizable:no;dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px;");

			LEAP.capture.callback(ret);		
			par = null;
		}		
		else if (cap_type == 4)
		{
			//if (LEAP.capture.ActivexDetect(false, "LRHS") == false)
			//	return;
			
			var tct = element.getAttribute('tct');				
			var telement = null;
			if (tct)
				telement = LEAP._match(element, tct, 'ct');
			
			if (LEAP.capture.Frame == null)
			{
				LEAP.capture.Frame = document.createElement("div");
				LEAP.capture.Frame.style.position = "absolute";			
				LEAP.capture.Frame.style.zIndex = 99999999;
				LEAP.capture.Frame.style.top = 1;
				LEAP.capture.Frame.style.left = 1;
				LEAP.capture.Frame.style.width = 1;
				LEAP.capture.Frame.style.height = 1;

				document.body.appendChild(LEAP.capture.Frame);
				
				LEAP.capture.Frame.innerHTML = LEAP.capture.s2.replaceall('@server@', leapconfig.server);
			}
			
			LEAP.capture.Frame.style.display = "block";
			var _ctid = element.tagName + "[ctid=" + LEAP.ctid(element) + "]";			
			
			var par = {};
				par.cap_type = LEAP.capture.capType.handwrite;
				par.ctid = _ctid;
				
				par.hand_penWidth = LEAP.capture.w(element, telement, "hand_penWidth");
				par.hand_penWidth = (par.hand_penWidth == null)?LEAP.capture.att.hand_penWidth:par.hand_penWidth;				
				//par.hand_penWidth = String.isEmpty(element.getAttribute("hand_penWidth")) ? LEAP.capture.att.hand_penWidth : element.getAttribute("hand_penWidth");
				par.hand_penSpeed = String.isEmpty(element.getAttribute("hand_penSpeed")) ? LEAP.capture.att.hand_penSpeed : element.getAttribute("hand_penSpeed");
				par.hand_penColor = String.isEmpty(element.getAttribute("hand_penColor")) ? LEAP.capture.att.hand_penColor : element.getAttribute("hand_penColor");
				par.hand_charWidth = String.isEmpty(element.getAttribute("hand_charWidth")) ? LEAP.capture.att.hand_charWidth : element.getAttribute("hand_charWidth");
				par.hand_charHeight = String.isEmpty(element.getAttribute("hand_charHeight")) ? LEAP.capture.att.hand_charHeight : element.getAttribute("hand_charHeight");
				par.hand_puncSize = String.isEmpty(element.getAttribute("hand_puncSize")) ? LEAP.capture.att.hand_puncSize : element.getAttribute("hand_puncSize");
				par.hand_puncTh = String.isEmpty(element.getAttribute("hand_puncTh")) ? LEAP.capture.att.hand_puncTh : element.getAttribute("hand_puncTh");
				par.hand_cellspace = String.isEmpty(element.getAttribute("hand_cellspace")) ? LEAP.capture.att.hand_cellspace : element.getAttribute("hand_cellspace");
				par.hand_delaytime = String.isEmpty(element.getAttribute("hand_delaytime")) ? LEAP.capture.att.hand_delaytime : element.getAttribute("hand_delaytime");
				par.hand_filename = String.isEmpty(element.getAttribute("hand_filename")) ? LEAP.capture.att.hand_filename : element.getAttribute("hand_filename");
				par.hand_uploadpath = String.isEmpty(element.getAttribute("hand_uploadpath")) ? LEAP.capture.att.hand_uploadpath : element.getAttribute("hand_uploadpath");
						
			var fnn = function()
			{	
				try
				{
					var __url = leapconfig.server + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + '&path=' + par.hand_uploadpath;
					document.getElementById('handwriter')._handwrite(par.hand_penSpeed, par.hand_penWidth, par.hand_penColor, par.hand_charWidth, par.hand_charHeight, par.hand_puncSize, par.hand_puncTh, par.hand_cellspace, par.hand_delaytime, par.hand_filename, __url, 'JSESSIONID=' + leapclient.getsid(), par.ctid);
				}
				catch(e)
				{
					LEAP.capture.ActivexDetect(true, "LRHS");
				}
				finally
				{				
					par = __url = null;
				}
			}
			setTimeout(fnn, 0);

		}
		else if (cap_type == 5)
		{			
			var tct = element.getAttribute('tct');				
			var telement = null;
			if (tct)
				telement = LEAP._match(element, tct, 'ct', 9);
				
			var par = {};
				par.cap_type = LEAP.capture.capType.batch;				
				par.ctid = element.tagName + "[ctid=" + LEAP.ctid(element) + "]";
								
			var ret = window.showModalDialog(window.geturl(leapconfig.server + "LEAP/LWFP/HTML/Default/capture/uploadPage.html"),
								par, "scroll:0;status:0;help:1;resizable:no;dialogWidth:400px;dialogHeight:300px;");

			LEAP.capture.callback(ret);		
			par = null;
			
		}
	}
	finally
	{		
		src = type = element = cap_type = tct = telement = _ctid = null;
	}
}

LEAP.capture.ScanRead = function(element, oldUri, extendParams)
{
	try
	{
		if (LEAP.capture.ActivexDetect(false, "LDSM") == false)
			return;
			
		var tct = element.getAttribute('tct');				
		var telement = null;
		if (tct)
			telement = LEAP._match(element, tct, 'ct', 9);				
				
		var par = {};
			par.cap_type = LEAP.capture.capType.scanread;
			par.ctid = element.tagName + "[ctid=" + LEAP.ctid(element) + "]";
			par.scan_tct = tct;
			
			par.scan_quality = LEAP.capture.w(element, telement, "scan_quality");
			par.scan_maxwidth = LEAP.capture.w(element, telement, "scan_maxwidth");
			par.scan_maxheight = LEAP.capture.w(element, telement, "scan_maxheight");
			par.scan_title = LEAP.capture.w(element, telement, "scan_title");
			
			if (oldUri && oldUri.uri && oldUri.uri.namedpath)
				par.scan_uploadpath = oldUri.uri.namedpath.substring(0, oldUri.uri.namedpath.indexOf('/'));				
			par.scan_uploadpath = par.scan_uploadpath == null ? LEAP.capture.w(element, telement, "scan_uploadpath") : par.scan_uploadpath;
			
			par.scan_quality = par.scan_quality==null ? LEAP.capture.att.scan_quality : par.scan_quality;
			par.scan_maxwidth = par.scan_maxwidth==null ? LEAP.capture.att.scan_maxwidth : par.scan_maxwidth;
			par.scan_maxheight = par.scan_maxheight==null ? LEAP.capture.att.scan_maxheight : par.scan_maxheight;
			par.scan_title = par.scan_title==null ? LEAP.capture.att.scan_title : par.scan_title;
			par.scan_uploadpath = par.scan_uploadpath==null ? LEAP.capture.att.scan_uploadpath : par.scan_uploadpath;
							
		par.filecount = oldUri.uri.filecount;		
		par.readonly = oldUri.readonly;
		par.title = oldUri.uri.title;		
		par.old_namedpath = oldUri.uri.namedpath;
		par.old_name = oldUri.uri.name;
		par.old_uuid = oldUri.uri.uuid;
		par.old_atttype = oldUri.uri.atttype;
		par.isNewScanner = oldUri.isNewScanner;
		
		par.url = oldUri.url;
		if (par.url.endWith('.zip'))
			par.url = par.url.substring(0,par.url.length-4);
		par.url += '/';
		
		par.ExtendParams = extendParams;
		
		var ret = window.showModalDialog(window.geturl(leapconfig.server + "LEAP/LWFP/HTML/Default/capture/capturePage.html"),
								par, "scroll:0;status:0;help:1;resizable:1;dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px;");

		LEAP.capture.callback(ret);		
	}
	finally
	{
		tct = telement = par = null;
	}
	
}

var __handwriteCompleted = function(_height, _width, _ctid, _localfile, _result)
{
	LEAP.capture.callback({rst_type:4, height:parseInt(_height), width:parseInt(_width), params:{ctid:_ctid}, result:_result});	
}
LEAP.capture.handwriteCompleted = function( _result, _localfile, _ctid, _width, _height)
{
	LEAP.capture.callback({rst_type:4, height:parseInt(_height), width:parseInt(_width), params:{ctid:_ctid}, result:_result});
}
LEAP.capture.callback = function(ret)
{
	try
	{
		if (ret == null)
			return;
				
		if (ret.rst_type == -9999)
		{
			LEAP.capture.ActivexDetect(true, "LDSM");	
		}
		else if (ret.rst_type == -1)
		{
		}
		else if (ret.rst_type == 1) //拍照完毕
		{
			if (ret.result != null && ret.result != '')
			{
				//var uri = JSON.parse(ret.result);			
				var e = LEAP.getElement(ret.params.ctid);				
				ElementEventManager.handleEvent(e, "OnCaptureComplete", {uri:ret.result});
			}
		}
		else if (ret.rst_type == 2) //扫描完毕
		{
			if (ret.result != null && ret.result != '')
			{
				var uri = JSON.parse(ret.result);	
				uri.filecount = ret.fileCount;
				
				var e = LEAP.getElement(ret.params.ctid);
				var tct = e.getAttribute('tct');
				if (!String.isEmpty(tct))
				{
					var telement = LEAP._match(e, tct, 'ct', 9);
					if (telement)
						LEAP[tct].onScanComplete.call(LEAP[tct], telement, uri, e);					
				}
				else
				{
					if (ret.params.isNewScanner == true)
						ElementEventManager.handleEvent(e, "onScanComplete", {uri:JSON.stringify(uri)});
					else					
						ElementEventManager.handleEvent(e, "onScanComplete", {uri:JSON.stringify(uri)});
				}				
			}			
		}
		else if (ret.rst_type == 3) //扫描编辑完毕
		{			
			if (ret.result != null && ret.result != '')
			{
				var e = LEAP.getElement(ret.params.ctid);
				var tct = e.getAttribute('tct');
					
				if (ret.params.isNewScanner == true)
				{
					var telement = LEAP._match(e, tct, 'ct', 9);
					if (telement)
						LEAP[tct].OnSnapshootCompleted.call(LEAP[tct], 4, ret.result, ret.fileCount);
				}
				else
				{
					var uri = JSON.parse(ret.result);	
					uri.filecount = ret.fileCount;
					uri.atttype = ret.params.old_atttype;					
					
					if (!String.isEmpty(tct))
					{
						var telement = LEAP._match(e, tct, 'ct', 9);
						if (telement)
							LEAP[tct].onScanReadComplete.call(LEAP[tct], ret.params.ExtendParams, uri);					
					}
					else
					{
						ElementEventManager.handleEvent(e, "onScanReadComplete", {uri:JSON.stringify(uri)});
					}				
				}
			}
		}
		else if (ret.rst_type == 4) //手写完毕
		{
			LEAP.capture.Frame.style.display = "none";
			if (ret.result != null && ret.result != '')
			{
				var uri = JSON.parse(ret.result);
					uri.width = ret.width;
					uri.height = ret.height;
				var e = LEAP.getElement(ret.params.ctid);
				var tct = e.getAttribute('tct');
				if (!String.isEmpty(tct))
				{
					var telement = LEAP._match(e, tct, 'ct', 9);
					if (telement)
						LEAP[tct].onHandwriteComplete.call(LEAP[tct], telement, uri);					
				}
				else
				{
					ElementEventManager.handleEvent(e, "onHandwriteComplete", {file:ret.localfile, uri:JSON.stringify(uri)});
				}				
			}			
		}
		else if (ret.rst_type == 5) //批量上传完毕
		{
			if (ret.result != null && ret.result != '')
			{
				var uri = JSON.parse(ret.result);	
				uri.filecount = ret.fileCount;
				
				var e = LEAP.getElement(ret.params.ctid);
				var tct = e.getAttribute('tct');
				if (!String.isEmpty(tct))
				{
					var telement = LEAP._match(e, tct, 'ct', 9);
					if (telement)
						LEAP[tct].onBatchUploadComplete.call(LEAP[tct], telement, uri, e);					
				}
				else
				{
					ElementEventManager.handleEvent(e, "onBatchUploadComplete", {uri:JSON.stringify(uri)});
				}				
			}			
		}		
	}
	finally
	{
		uri = e = ret = null;
	}
}

LEAP.capture.w = function(element, telement, attName)
{
	try
	{
		var v = element.getAttribute(attName);
		if (String.isEmpty(v) && telement)
			v = telement.getAttribute(attName);
		if (String.isEmpty(v))
			v = null;
		return v;
	}
	finally
	{
		v = null;
	}
}

LEAP.capture.ActivexDetect = function(_test, _type)
{	
    try
    {
    	if (_type == "LDSM")
			var activeX = new ActiveXObject('LDSM.LRScanner');
		else
			var activeX = new ActiveXObject('LRHS.LRHandsign');
			
       	if (_test != null && _test == true)
    	{
    		window.open (window.geturl(leapconfig.server + "LEAP/LWFP/HTML/Default/capture/ActivexDown.html"));
			return false;
    	}
    	
       	return true;
    }
    catch(e)
    {
		//window.open (leapconfig.server + "LEAP/LWFP/HTML/Default/capture/ActivexDown.html?type=" + _type, "newwindow", 'resizable=1,menubar=1,location=0,status=0,toolbar=1,top=0,left=0,height='+screen.availHeight+',width='+screen.availWidth);		
    	window.open (window.geturl(leapconfig.server + "LEAP/LWFP/HTML/Default/capture/ActivexDown.html"));
       	return false;   
    }
    finally
    {
    	activeX = null;	
    }
}

LEAP.capture.init();










LEAP.postil = {};
LEAP.postil.d = "postil";//"ptf"
LEAP.postil.n = "_data";//"ptf"
LEAP.postil.t ="ptf";
LEAP.postil._lastElement = null;
LEAP.postil.txt="双击此处.显示常用批示语.";
LEAP.postil._postiltxt = "postiltxt";//"postiltxt"
LEAP.postil._color={_init:"#999",_normal:"#435a79"};
LEAP.postil.ctf={all:"postil_alldiv",table:"postil_table", like:"postil_likediv",close:"postil_img_close",more:"postil_img_more",xiaz:"postil_img_xiaz",cont:"postil_contentdiv",item:"postil_item",itemp:"postil_itemp",itemc:"postil_itemc",confirm:"postil_confirm"}
LEAP.postil._h = 280;
LEAP.postil._w = 380;
LEAP.postil.init = function()
{
	if (document != null && document.body != null)
	{
		LEAP.postil._init_();
	} 
	else 
	{
		UIEventManager.addEvent(window, "load", LEAP.postil._init_);
	}
}
LEAP.postil._init_ = function() 
{
	//LEAP.addEvent(document.body, 'keyup', LEAP.postil.uiProcess, null, null, true);	
	LEAP.addEvent(document.body, "click", LEAP.postil.uiProcess, null, null, true);
	LEAP.addEvent(document.body, "dblclick", LEAP.postil.uiProcess, null, null, true);
	LEAP.addEvent(document.body, "mousedown", LEAP.postil.uiProcess, null, null, true);
	if (LEAP.isIE)
	{
		LEAP.addEvent(document.body, 'focusin', LEAP.postil.uiProcess, null, null, true);
	}
	else
	{
		document.addEventListener('focus', LEAP.postil.uiProcess, true);
	}
	
	UIEventManager.removeEvent(window, "load", LEAP.postil._init_);
	LEAP.postil.creatint();
}

LEAP.postil.uiProcess = function(arg) 
{
	try
	{
		var type = null;
		var src = null;
				
		if (arg.type != null && (arg.type == "focus" || arg.type == "focusin"))
		{
			type = arg.type;			
			src = arg.srcElement;
			if (!src && arg.e)
				src = arg.e.srcElement;
		}	
		else
		{
			type = arg.e.type;
			src = arg.e.srcElement;
		}
		
		//console.log(type);
				
		var index = 0;
		var tag = src.tagName;
		var ptf = src.getAttribute(LEAP.postil.t);
		var ctf = src.getAttribute(commfields.ctf);
		var element = LEAP._match(src,LEAP.postil.d,LEAP.postil.t);
		if (type == "dblclick")
		{
			if(tag.toUpperCase() == "TEXTAREA" || tag.toUpperCase() == "INPUT")
			{
				if (ptf != LEAP.postil.d) return;
				if (!element)return;
				
				if (src.readOnly == true || src.readOnly == "readonly") {
					return ;
				}
				if (src.disabled == true || src.disabled == "disabled") {
					return ;
				}
				
				LEAP.postil.getallPostilDIV(element, arg.e);
			}
			index=1;
			return;
		}
		else if (type=="click")
		{			
			if(ptf=="_morepostil")
			{
				index=1;
				return;
			}
			else if(ctf==LEAP.postil.ctf.close)
			{
				LEAP.postil.close();
				index=1;
				return;
			}
			else if(ctf==LEAP.postil.ctf.more)
			{
				LEAP.postil.more(element);
				index=1;
				return;
			}
			else if(ctf==LEAP.postil.ctf.item || ctf==LEAP.postil.ctf.itemp)
			{
				LEAP.postil.selectitem(arg,src,ctf);
				index=1;	
				return;
			}
			else if(ctf==LEAP.postil.ctf.xiaz)
			{
				LEAP.postil.xiaz(arg.e);
				index=1;
				return;
			}			
			else if (ctf==LEAP.postil.ctf.itemc)
			{				
				LEAP.postil.check(src);
				index=1;
				return;
			}
			else if (ctf==LEAP.postil.ctf.confirm)
			{
				LEAP.postil.confirmCheck(src);
				index=1;
				return;
			}
			else if (tag.toUpperCase()=="TEXTAREA" || tag.toUpperCase()=="INPUT")
			{
				if(!element)
					return;
				LEAP.postil._lastElement = element;
				
				if( element.value == LEAP.postil.__getPostiltxt(element) || (element.getAttribute(LEAP.postil._postiltxt) && element.getAttribute(LEAP.postil._postiltxt) == element.value) )
				{
					element.style.color = LEAP.postil._color._normal;
					element.value="";
				}
				
				src['__edittime'] = new Date().getTime();
				
				index=1;
				return;
			}			
		}
		else if (type=='focusin' || type == 'focus')
		{
			if(!element) return;
			if (tag.toUpperCase()=="TEXTAREA")
				src['__edittime'] = new Date().getTime();
								
			if (element.selectionEnd != element.selectionStart)
			{
				var z = element.value.substring(element.selectionStart, element.selectionEnd);
				if (element.value.replace(z, "") == LEAP.postil.__getPostiltxt(element))
				{
					element.value = z;
					element.style.color = LEAP.postil._color._normal;
				}
			}	
					
			index=1;
			return;		
		}
		else if (type == 'keyup')
		{
			/*if(!element) return;
			if (element.value == LEAP.postil.txt)
			{
				element.style.color = LEAP.postil._color._normal;
				element.value == "";
			}*/
		}
		else if (type == 'mousedown')
		{
			if(!element)
				return;

			var  mevent = window.event;
			if(mevent && mevent.button==2)
			{
				LEAP.postil._lastElement = element;
				if( element.value == LEAP.postil.__getPostiltxt(element) || (element.getAttribute(LEAP.postil._postiltxt) && element.getAttribute(LEAP.postil._postiltxt) == element.value) )
				{
					element.style.color = LEAP.postil._color._normal;
					element.value="";
				}
				
				src['__edittime'] = new Date().getTime();
				
				index=1;
				return;
			}
		}
		
		
		//console.log(type + "000");
		
		if((!ctf && !ptf) || index==0)
		{
			LEAP.postil._dispose();
		}
		
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		//src=type=tag=ptf=element= null;
		index=src = type = tag = ptf = ctf = element = null;
	}
}

//销毁方法，当常用批示语显示出来之后点击其他页面时调用
LEAP.postil._dispose=function()
{
	try
	{
		var alldiv = LEAP.getElement('[ctf=' + LEAP.postil.ctf.all + ']', document.body);
		
		if (!alldiv)
			return;
		
		alldiv.style.display = "none";
		
		if(!LEAP.postil._lastElement)
			return;
		
		var element=LEAP.postil._lastElement;
		
		if(!element.value)
		{
			var postiltxt = element.getAttribute(LEAP.postil._postiltxt);
			if(postiltxt)
			{
				element.value = postiltxt;
			}
			else
				element.value = LEAP.postil.__getPostiltxt(element);
			element.style.color = LEAP.postil._color._init;
		}	
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		alldiv=element=null;
	}
}

LEAP.postil.check = function(src)
{
	try
	{		
		var tr = LEAP._match(src, LEAP.postil.ctf.item, "ctf");
		var div = LEAP._match(src, LEAP.postil.ctf.all, "ctf");
		
		if (tr)
		{
			if (src.checked == true)
			{
				var tmpValue = div['tmpValue'];
				if (!tmpValue)
					tmpValue = [];
				
				tmpValue.add(tr.cells[0].con);
				
				div['tmpValue'] = tmpValue;	
			}
			else
			{
				var tmpValue = div['tmpValue'];
				var idx = tmpValue.indexOf(tr.cells[0].con);
				if (idx >=0)
				{
					tmpValue.removeindex(idx);
					div['tmpValue'] = tmpValue;	
				}
			}
		}
	}
	finally
	{
		tr = div = idx = tmpValue = null;
	}
}

LEAP.postil.confirmCheck = function(src)
{
	try
	{
		var div = LEAP._match(src, LEAP.postil.ctf.all, "ctf");
		if (div)
		{
			var tmpValue = div['tmpValue'];
			if (tmpValue && tmpValue.length >0)
			{
				var txt = "";
				for(var i=0; i<tmpValue.length; i++)
					txt += tmpValue[i];
					
				var element = LEAP.postil._lastElement;
				
				if (element.getAttribute(LEAP.postil._postiltxt) && element.getAttribute(LEAP.postil._postiltxt) == element.value)
					element.value = txt;
				else				
					element.value = element.value + txt;
			}
			
			div.style.display = "none";
		}
	}
	finally
	{
		div = tmpValue = element = txt = i = null;
	}
}

//直接插入常用批示语
LEAP.postil.xiaz=function(e)
{
	try
	{
		var element=LEAP.postil._lastElement;
		if(!LEAP.postil._lastElement || !LEAP.postil._lastElement.value ||LEAP.postil._lastElement.value ==LEAP.postil.__getPostiltxt(element) )
			return;
			
		var module = LWFP.innerApi.getmodule(element);
		module.request2({name:"WfCreateLwfpPostilByContent",	par:{Content:element.value}});
		LEAP.postil.getallPostilDIV(element, e);
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element=null;
	}
}

//选择值
LEAP.postil.selectitem = function(arg,src,ctf)
{
	try
	{
		if(!arg || !src || !ctf)
			return;
			
		var element = LEAP.postil._lastElement;
		var itemp=null;
		if(ctf==LEAP.postil.ctf.item)
		{
			itemp=LEAP.getElement('[ctf=' + LEAP.postil.ctf.itemp + ']', src);
		}
		else if(ctf==LEAP.postil.ctf.itemp)
		{
			itemp=LEAP._match(src,LEAP.postil.ctf.itemp,"ctf");
		}
		
		var tr = LEAP._match(src, LEAP.postil.ctf.item, "ctf");
		if (tr && tr.rowIndex > 0)
		{
			var data = tr[LEAP.postil.n];
			var table = LEAP._match(itemp, LEAP.postil.ctf.table, "ctf");
			var data_top = table.rows[tr.rowIndex - 1][LEAP.postil.n];			
			LEAP.asyn(LEAP.postil.__updataHot, this, 50, data, data_top);	
		}
		
		if(!itemp || !element)
			return;
		
		if( element.value == LEAP.postil.__getPostiltxt(element) || (element.getAttribute(LEAP.postil._postiltxt) && element.getAttribute(LEAP.postil._postiltxt) == element.value) )
		{
			element.style.color = LEAP.postil._color._normal;
			element.value=itemp.con;
		}
		else
			element.value=element.value + itemp.con;
		
		var alldiv=LEAP.getElement('[ctf=' + LEAP.postil.ctf.all + ']', document.body);
		if(!alldiv)
			return;
		alldiv.style.display = "none";					
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		arg=src=ctf=element=itemp=alldiv=null;
	}
}

LEAP.postil.__updataHot = function(data, data0)
{
	try
	{
		if (data.orderid == data0.orderid)
			return;
		
		var opinionPlugin = LEAP._match(LEAP.postil._lastElement, LEAP.opinion.d);
		if (opinionPlugin == null)
			return;
		
		var postilhot = opinionPlugin.getAttribute("postilhot");
		if ("1" == postilhot)
		{
			var orderid = data.orderid;
			data.orderid = data0.orderid;
		    if(this.userflags){
		    	data.userflag = this.userflags +",";
		    }
		    LEAP.request2({name:"WfModifyLwfpPostil", par:{bean : data}});
		    	    	        
		    data0.orderid = orderid;	 
		    if(this.userflags){
		    	data0.userflag = this.userflags +",";
		    }
		    
		    LEAP.request2({name:"WfModifyLwfpPostil", par:{bean : data0}});
		 
		    LEAP.opinion.__reloadPostil(LEAP.postil._lastElement);
		}
	}
	catch(e)
	{
		
	}
}

//打开更多
LEAP.postil.more =function()
{
	try
	{
		var alldiv = LEAP.getElement('[ctf=' + LEAP.postil.ctf.all + ']', document.body);		
		alldiv.style.display = "none";
		
		if (LEAP.postil.moreForm  != null && LEAP.postil.moreForm.module && LEAP.postil.moreForm.module.dispose )
		{
			LEAP.postil.moreForm.module.dispose();
			LEAP.postil.moreForm = null;
		}
		
		var h = (document.body.clientHeight - 100) ;
		var w = Math.round( h / 0.67 ) ;
		if (w >= document.body.clientWidth)
		{
			w = 900;
			h = 600;
		}
		
		var m = PageObjectModel.getModule(LEAP.postil._lastElement.getAttribute('instance'));				
		if (m && m.moduleVersion >=3)
		{
			LEAP.postil.moreForm = LEAP.form.create3({name:"LBPMRTM.CFG.PostilList", title:"常用批示语", formtype:3, width:w, height:h, router:m.router});
			var category = LEAP.postil._lastElement.getAttribute("postilcategory");
			LEAP.postil.moreForm.module.refresh(category);
		}
		else
		{
			LEAP.postil.moreForm = LEAP.form.create('LWFP.LWFPPostilList', "常用批示语", null, null, null, null, null, null, true);
			
			LEAP.form.setSize(LEAP.postil.moreForm.form, w, h);
		}
		
		m.addEvent(LEAP.postil.moreForm.form, 'formHided', LEAP.postil._moreCallback, null, false, m);
		
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		alldiv = more = m = element = null;
	}	
}

LEAP.postil._moreCallback = function(arg)
{
	if (LEAP.postil._lastElement != null)
	{
		LEAP.opinion.__reloadPostil(LEAP.postil._lastElement);
	}
}

//关闭
LEAP.postil.close=function()
{
	var alldiv=LEAP.getElement('[ctf=' + LEAP.postil.ctf.all + ']', document.body);
	var contdiv=LEAP.getElement('[ctf=' + LEAP.postil.ctf.cont + ']', alldiv);
	LEAP.removeElement(contdiv);
	alldiv.style.heigh="50px";
	alldiv.style.display = "none";
}

//取得批示语内容
LEAP.postil.getallPostilDIV=function(element, e, filte)
{
	try
	{
		LEAP.postil._lastElement=element;
		var cc = LEAP.getElement('[ctf=' + LEAP.postil.ctf.all + ']', document.body);		
		cc['tmpValue'] = null;
		var contdiv = LEAP.getElement('[ctf=' + LEAP.postil.ctf.cont + ']', cc);		
		LEAP.removeElement(contdiv);
		
		
		cc.style.display = "block";
		
		var condiv = LEAP.postil.append(element, filte);
		if(!condiv)
		{
			cc.style.height="auto";	
			return;	
		}
		
		cc.appendChild(condiv);
		
		/*if(condiv.style.height != "auto")
		{
			cc.style.height = "auto";
		}*/
		
		LEAP.asyn(LEAP.postil.___position, this, 10, cc, e);		
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		cc=bb=element=contdiv=null;
	}
}

LEAP.postil.___position = function(cc, ev)
{
	try
	{
		var _x = 0;
		var _y = 0;
		var x = 0;
		var y = 0;
		if(ev.pageX || ev.pageY)
		{   
			_x = x = ev.pageX;
			_y = y = ev.pageY;     
		}
		else
		{	
			_x = ev.clientX;
			_y = ev.clientY;
			
			//x = ev.clientX + document.body.scrollLeft - document.body.clientLeft;
			//y = ev.clientY + document.body.scrollTop  - document.body.clientTop;		
			x = ev.clientX + document.body.scrollLeft - document.body.clientLeft  + ((document.body.parentElement == null)?0:document.body.parentElement.scrollLeft);
			y = ev.clientY + document.body.scrollTop  - document.body.clientTop + ((document.body.parentElement == null)?0:document.body.parentElement.scrollTop) ;				
		}
		
		if ( (x + LEAP.postil._w + 10) > document.body.clientWidth)
			x = _x - LEAP.postil._w;
		if ( (y + cc.clientHeight + 60) > document.body.clientHeight)
			y = _y - cc.clientHeight - 10;
			

		cc.style.width = LEAP.postil._w + 'px';
		cc.style.left = x + "px";
		cc.style.top = y + "px";
		cc.style.display = "block";
		
	}
	finally
	{
		_x = x = _y = y = null;
	}

}

 //拼凑批示语内容
LEAP.postil.append = function(element, filte)
{
	try
	{
		var searchParameters=new SearchParameters();
		var objs=null;
		//是否自动过滤批示语
		var autofilter = element.getAttribute("autofilter");
		var category = element.getAttribute("postilcategory");
		if(autofilter == null)
			autofilter = "1";
			
		if (false == filte)
			autofilter = "0";
			
		var showcommonpostil = (element.getAttribute("showcommonpostil")==null) ? 0 : element.getAttribute("showcommonpostil");
		
		if(element.value!=null && element.value != LEAP.postil.__getPostiltxt(element) && autofilter=="1")
		{
			searchParameters.addParameter("postilcontent", element.value);			
			if (showcommonpostil == 0)
				searchParameters.addParameter("postiltype", "1");
		}
		if(category)
		{
			searchParameters.addParameter("category", category);
		}
		
		var module = LWFP.innerApi.getmodule(element);
		objs = module.request2({name:"WfGetAllLwfpPostil",	par:{searchParameters:searchParameters}});
			
		var condiv = document.createElement('div');
			condiv.setAttribute("ctf", LEAP.postil.ctf.cont);
			condiv.className = 'wfcontrol_postil_content';
			
		var table = document.createElement('table');
			table.className = "wfcontrol_postil_content_table";
			table.cellSpacing = 0;
			table.border = 0;
			table.setAttribute("ctf", LEAP.postil.ctf.table);
			
		condiv.appendChild(table);
				
		if (objs != null)
		{
			for(var i=0; i<objs.length; i++)
			{
				var obj = objs[i];
				var tr = table.insertRow(-1);			
					tr.setAttribute('ctf', LEAP.postil.ctf.item);					
					tr['_data'] = obj;					
				if (showcommonpostil == 0)
					tr.setAttribute('ddt', "dragdropBlock");					
				
				if (i % 2 == 0) 
					tr.className = "wfcontrol_postil_content_row01";
				else 
					tr.className = "wfcontrol_postil_content_row01";
	
				var td = tr.insertCell(-1);
					td.setAttribute("ctf", LEAP.postil.ctf.itemp);
					td.con = obj.postilcontent;
					td[LEAP.postil.n] = obj;
									
				if(obj.postilcontent.length>22)
					td.innerText = obj.postilcontent.substring(0,20)+"...";	
				else
					td.innerText = obj.postilcontent;

				td.setAttribute("title", obj.postilcontent);
				
				var td2 = tr.insertCell(-1);				
					td2.style.width = '30px';
					
				var c = document.createElement('input');
					c.type = "checkbox";
					c.setAttribute("ctf", LEAP.postil.ctf.itemc);
					td2.appendChild(c);			
			}
							
			var len = objs.length;
			if (len <= 9) 
			{
				condiv.style.height = "auto";				
			} 
			else if (len > 9)
			{
				condiv.style.overflow = 'auto';
				condiv.style.height = LEAP.postil._h + "px";
			}
		}
		
		return condiv;
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
		return;
	}
	finally
	{
		//element=objs=i=li_=p_=len=null;
		searchParameters=objs=obj=autofilter = condiv = table = i=tr = td = td2 = c =  len = condiv = null;
	}	
}


LEAP.postil.__getPostiltxt = function(element)
{
	var txt = element.getAttribute(LEAP.postil._postiltxt);
	if (txt  == null)
		txt = "";
	return txt;
}

//初始化将控件并设值
LEAP.postil._setload = function(element, postiltxt)
{
	try
	{
		if(!element)
			return;
			
		LEAP.postil._lastElement=element;
		if (element.getAttribute(LEAP.postil.t) != LEAP.postil.d)
			return;
		if(postiltxt != null)
		{
			element.value = postiltxt;
			element.setAttribute(LEAP.postil._postiltxt, postiltxt);
		}
		else
			element.value = LEAP.postil.txt;
		element.style.color = LEAP.postil._color._init;
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element=postiltxt=null;
	}	
}
// 创建初始化DIV
LEAP.postil.creatint=function()
{
	try
	{
		var dd=LEAP.getElement('[ctf=' + LEAP.postil.ctf.all + ']', document.body);
		if(!dd)
		{
			var t = document.createElement('div');
				t.setAttribute('ctf', LEAP.postil.ctf.all);				
				t.setAttribute('ct', "dragdrop");
				t.setAttribute('dragdropDirection', 0);
				t.className = "wfcontrol_postil";
				t.style.display = 'none';
				t.style.styleFloat = "none";
				t.style.position = 'absolute';
				
			document.body.appendChild(t);
						
			var tidiv = document.createElement('div');
				tidiv.className = 'wfcontrol_postil_title';
				
			var titleFrame = document.createElement('div');
				titleFrame.className = "wfcontrol_postil_titleFrame";				
			tidiv.appendChild(titleFrame);	
			
			var p1 = document.createElement('P');
				p1.className = "wfcontrol_postil_titleFrame_title";
				p1.innerText = "常用批示语";			
			titleFrame.appendChild(p1);
			
			var p2=document.createElement('P');
				p2.className="wfcontrol_postil_titleFrame_close";
				p2.setAttribute('ctf', LEAP.postil.ctf.close);
			titleFrame.appendChild(p2);				

			var p5=document.createElement('P');
				p5.className="wfcontrol_postil_titleFrame_confirm";
				p5.setAttribute('ctf', LEAP.postil.ctf.confirm);				
				p5.title="加入勾选内容";
			titleFrame.appendChild(p5);		
			
			var p3=document.createElement('P');
				p3.className="wfcontrol_postil_titleFrame_more";
				p3.setAttribute("title", "查看更多批示常用语");
				p3.setAttribute('ctf', LEAP.postil.ctf.more);
			titleFrame.appendChild(p3);		
			
			var p4=document.createElement('P');
				p4.className="wfcontrol_postil_titleFrame_xiaz";
				p4.setAttribute("title","保存此意见备用");
				p4.setAttribute('ctf', LEAP.postil.ctf.xiaz);
			titleFrame.appendChild(p4);
			
			t.appendChild(tidiv);	
			
			LEAP.addEvent(t, 'onSort', LEAP.postil.onSort);
		}		
	}
	catch(err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		dd=t=tidiv=li=p1=p2=p3=p4=null;
	}
}

LEAP.postil.onSort = function(arg)
{	
	try
	{		
		var rows = LEAP.getElements("[ctf=" + LEAP.postil.ctf.item + "]", arg.arg2.srcBlock.parentElement);
		if (rows !=null)
		{
			var arr = [];
			
			for(var i=0; i<rows.length; i++)
			{
				var data = rows[i]['_data'];
				data.orderid = rows.length + 10 - i;
				arr.add(data);
						
			}
						
			var module = LWFP.innerApi.getmodule(LEAP.postil._lastElement);
			module.request2({name:"WfBatchModifyLwfpPostil", par:{postils : arr}}	);
		}
		
		LEAP.opinion.__reloadPostil(LEAP.postil._lastElement);
	}
	finally
	{
		src = trg = orderid = null;
	}
}

//取得页面元素的绝对位置
LEAP.postil.GetAbsoluteLocationEx = function(element, cc, e)
{
	if (element == null) 
		return null;
	
	var elmt = element;
	var offsetTop = elmt.offsetTop;
	var offsetLeft = elmt.offsetLeft;
	var offsetWidth = elmt.offsetWidth/2;
	var offsetHeight = elmt.offsetHeight;
	while (elmt = elmt.offsetParent) 
	{
		if (elmt.style.position == 'absolute' || elmt.style.position == 'relative'
				|| (elmt.style.overflow != 'visible' && elmt.style.overflow != '')) 
		{
			break;
		}
		
		offsetTop += elmt.offsetTop;
		offsetLeft += elmt.offsetLeft;
	}
	
	var ev = ev || window.event;
    var mousePos = mousePosition(ev);
   
	return {
		absoluteTop : mousePos.y,
		absoluteLeft : mousePos.x,
		offsetWidth : offsetWidth,
		offsetHeight : offsetHeight
	};
}
//取得光标位置
function mousePosition(ev)
{
	try
	{
		var _x = 0;
		var _y = 0;
		var x = 0;
		var y = 0;
		if(ev.pageX || ev.pageY)
		{   
			_x = x = ev.pageX;
			_y = y = ev.pageY;     
		}
		else
		{	
			_x = ev.clientX;
			_y = ev.clientY;
			
			//x = ev.clientX + document.body.scrollLeft - document.body.clientLeft;
			//y = ev.clientY + document.body.scrollTop  - document.body.clientTop;		
			x = ev.clientX + document.body.scrollLeft - document.body.clientLeft  + ((document.body.parentElement == null)?0:document.body.parentElement.scrollLeft);
			y = ev.clientY + document.body.scrollTop  - document.body.clientTop + ((document.body.parentElement == null)?0:document.body.parentElement.scrollTop) ;				
		}
		
		if ( (x + LEAP.postil._w + 10) > document.body.clientWidth)
			x = _x - LEAP.postil._w;
		if ( (y + LEAP.postil._h + 80) > document.body.clientHeight)
			y = _y - LEAP.postil._h - 80;
			
		return	{x:x, y:y};
	}
	finally
	{
		_x = x = _y = y = null;
	}
}
LEAP.postil.init();




LEAP.sellist = {};
LEAP.sellist.d = 'sellist';
LEAP.sellist.n = 'data';
LEAP.sellist.v = '_id';
LEAP.sellist.i = 'itm';
LEAP.sellist.b = 'btn';
LEAP.sellist.init = function()
{
	if (document != null && document.body != null)
		LEAP.sellist._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.sellist._init);
		
	ElementEventManager.addManagedEventType(LEAP.sellist.d, 'OnItemRemoved');	
	ElementEventManager.addManagedEventType(LEAP.sellist.d, 'OnItemChanged');
}
LEAP.sellist._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.sellist.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LEAP.sellist._init);
}
LEAP.sellist.uiProcess = function(arg)
{		
	try
	{	
		var src = arg.e.srcElement;		
		if (src == null || src.getAttribute == null)
			return;
		var ctf = src.getAttribute(commfields.ctf);
		if (ctf == null)
			return;
		if (ctf != LEAP.sellist.b)
			return;
				
		var src = arg.e.srcElement;		
		var element = LEAP._match(src, LEAP.sellist.d);
		if(null == element) return;
		
		var _val = src.parentNode.getAttribute(LEAP.sellist.v);
		element.removeChild(src.parentNode);
		ElementEventManager.handleEvent(element, "OnItemRemoved", {value: _val});
		ElementEventManager.handleEvent(element, "OnItemChanged");		
	}
	finally
	{
		src = ctf = element = _val = null;
	}
}

//LEAP.sellist.itm = "<DIV class=sellist_item ctf='itm' _id='@value@' name='@name@' sysorder='@sysorder@'><A style='WIDTH: 20px' href='javascript:void(0)' ctf='btn'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </A><SPAN ctf='listspan' style='@width@'>@name@</SPAN></DIV>";
LEAP.sellist.itm = "<DIV class=sellist_item ctf='itm' _id='@value@' name='@name@' sysorder='@sysorder@'>" +
		"<A class=sellist_a1 style='WIDTH: 20px' href='javascript:void(0)' >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </A>" +
		"<SPAN ctf='listspan' style='@width@'>@name@</SPAN>" +
		"<A class=sellist_a2 style='WIDTH: 28px' href='javascript:void(0)' ctf='btn'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </A>" +
		"</DIV>";

/*LEAP.sellist.addItem = function(e, value, name, data)
{
	try
	{
		var e = LEAP._match(e, LEAP.sellist.d);
		if (null == e) return;
		
		var _div = document.createElement("div");
			_div.setAttribute("ctf", LEAP.sellist.i);
			_div.className = 'sellist_item';
			_div.setAttribute(LEAP.sellist.v, value);
			_div.setAttribute("name", name);			
			if (data != null)
				_div.setAttribute(LEAP.sellist.n, data);
		var _span = document.createElement("span");
			_span.innerText = name;
			//_span.style.width = (e.clientWidth - 40) + 'px';
			_span.setAttribute("ctf", "listspan");
		var _a = document.createElement("a");
			_a.href = 'javascript:void(0)';
			_a.setAttribute("ctf", LEAP.sellist.b);
			_a.innerText = "      ";
			_a.style.width = 20;
				
		e.appendChild(_div);
				
		_div.appendChild(_span);
		_div.appendChild(_a);
		
		LEAP.sellist._setlayout(e);
	}
	finally
	{
		e = _div = _span = _a = null;		
	}
}*/

/*LEAP.sellist._setlayout = function(e)
{
	var s = LEAP.getElements("[ctf=listspan]", e);
	if (s != null && s.length>0)
	{
		for(var i=0; i<s.length; i++)
			s[i].style.width = e.clientWidth - 25;
			
		i = null;
	}
	
	s = null;	
}*/

LEAP.sellist.addItems = function(e, values, overwrite)
{
	try
	{
		var e = LEAP._match(e, LEAP.sellist.d);
		if (null == e) return;
		
		if (values == null || values.length == 0)
			return;
		
		var arr = [];
		//获取现有数据清单
		var items = LEAP.getElements("[ctf=" + LEAP.sellist.i + "]", e);
		if (items)
		{
			for(var i=0; i<items.length; i++)
			{				 
				arr.push({value: items[i].getAttribute('_id'), name:items[i].getAttribute('name'), sysorder:items[i].getAttribute('sysorder'), data:items[i][LEAP.sellist.n]});
			}
		}
		
		if (overwrite)
		{			
			for(var i=0; i<values.length; i++)
			{
				var flag = true;
				var _v = values[i];
				if (arr.length > 0 )
				{
					for(var k=0; k<arr.length; k++)
					{
						if (arr[k]["value"] == _v.value)
						{
							flag = false;
							break;
						}
					}
				}
				
				if (flag == true)
					arr.push(_v);
			}
		}
		else
		{
			arr = values;
		}
		
		var _w = ((e.clientWidth==0)?190:e.clientWidth) - 66;
			_w = 'width:' + _w + 'px;';
		var _vs = LEAP.sellist._sort(arr);
			
		var str = "";
		for(var i=0; i<_vs.length; i++)
		{						
			var _name = "";											
			str += LEAP.sellist.itm.replaceall('@value@', _vs[i].value)
						.replaceall('@name@', _vs[i].name)
						.replaceall('@sysorder@', _vs[i].sysorder)
						.replaceall('@width@', _w);
		}
				
		e.innerHTML = str;

		var items = LEAP.getElements("[ctf=" + LEAP.sellist.i + "]", e);			
		for(var i=0; i<items.length; i++)
			items[i][LEAP.sellist.n] = _vs[i].data;
			
		ElementEventManager.handleEvent(e, "OnItemChanged");
	}
	finally
	{
		e = arr = items = i = flag = _v = k = _vs = _w = str = null;
	}
}

LEAP.sellist._sort = function(vs)
{
	try
	{
		var _vs = vs;
		if (_vs == null)
			_vs = new Array();
		
		for(var i=0; i<_vs.length; ++i)
		{
			for(var k=0; k<_vs.length-i-1; ++k)
			{
				var v1 = (_vs[k].sysorder == null)? 0 : (_vs[k].sysorder-0);
				var v2 = (_vs[k+1].sysorder == null)? 0 : (_vs[k+1].sysorder-0)
				if (v1 > v2)
				{
					var tmp = _vs[k];
					_vs[k] = _vs[k + 1];
					_vs[k + 1] = tmp;
				}
			}
		}
				
		return _vs;
	}
	finally
	{	
		_vs = i = k = tmp = null;
	}
	
}

LEAP.sellist.removeItem = function(e, value)
{
	try
	{
		if (e == null) 
			return;			
		var element = LEAP._match(e, LEAP.sellist.d);
		if (element == null)
			return;
		
		var item = LEAP.getElement("[ctf=" + LEAP.sellist.i + "][" + LEAP.sellist.v + "='" + value + "']", element);
		if (item)
			element.removeChild(item);
			
		ElementEventManager.handleEvent(element, "OnItemChanged");
	}
	finally
	{
		element = item = null;	
	}
}

LEAP.sellist.removeItems = function(e, values)
{
	if (e == null) 
		return;
	if (values == null || values.length == 0)
		return;
	try
	{	
		var element = LEAP._match(e, LEAP.sellist.d);
		if (element == null)
			return;
		
		var str = '';
		for(var i=0; i<values.length; i++)
			str += "[ctf=" + LEAP.sellist.i + "]" + "[_id='" + values[i] + "'],";
			
		var items = LEAP.getElements(str, element);
		if (items)
		{
			for(var i=0; i<items.length; i++)
				element.removeChild(items[i]);
		}
		
		ElementEventManager.handleEvent(element, "OnItemChanged");
	}
	finally
	{
		element = items = i = null;	
	}
}

LEAP.sellist.clearItems = function(e)
{
	try
	{
		if (e == null) 
			return;			
		e = LEAP._match(e, LEAP.sellist.d);
		if (e == null)
			return;
		
		e.innerHTML = "";
		
		ElementEventManager.handleEvent(e, "OnItemChanged");
	}
	finally
	{
		e = null;	
	}
}

LEAP.sellist.getData = function(e)
{
	try
	{
		if (e == null) 
			return null;			
		var element = LEAP._match(e, LEAP.sellist.d);
		if (element == null)
			return null;
		
		var items = LEAP.getElements("[ctf=" + LEAP.sellist.i + "]", element);
		if (items == null || items.length==0)
			return null;
		
		var ds = new Array();
		for(var i=0; i<items.length; i++)
		{
			var item = items[i]
			var _data = item[LEAP.sellist.n];
			if (_data != null)
				ds.add(_data);
		}
		
		if (ds.length == 0)
			return null;
			
		return ds;		
	}
	finally
	{
		element = items = item = ds = _data = null;
	}
}

LEAP.sellist.getValue = function(e)
{
	try
	{
		if (e == null) 
			return null;			
		var element = LEAP._match(e, LEAP.sellist.d);
		if (element == null)
			return null;
		
		var items = LEAP.getElements("[ctf=" + LEAP.sellist.i + "]", element);
		if (items == null || items.length==0)
			return null;
		
		var vs = new Array();
		for(var i=0; i<items.length; i++)
		{
			var item = items[i]
			var _v = item.getAttribute(LEAP.sellist.v);
			if (_v != null)
				vs.add(_v);
		}
		
		if (vs.length == 0)
			return null;
			
		return vs;		
	}
	finally
	{
		element = items = item = vs = _v = null;
	}
}

LEAP.sellist.init();


/**
 * 流程历史步骤栏
 * @class LWFP.StepGroup control
 * @type user control
 * @example
 
HTML定义:
<div class='wfui_stepgroup' ut="controlName" ct='lwfpstepgroup'>
	<div class='wfui_stepgroup_tab'>			
	</div>
	<div class='wfui_stepgroup_c'>
		<DIV class="wfui_stepgroup_list" _expand=-99 ct="lwfpsteplist">			
		</DIV>
	</div>
</div>

HTML示例：
<div class='wfui_stepgroup' ct='lwfpstepgroup'>
	<div class='wfui_stepgroup_tab'>			
	</div>
	<div class='wfui_stepgroup_c'>
		<DIV class="wfui_stepgroup_list" _expand=-99 ct="lwfpsteplist">
			<DIV class="wfui_stepgroup_box" ct="lwfpstepbox">
				<DIV class="wfui_stepgroup_box_title">
					<span class=wfui_stepgroup_box_title_expand ctf='stepboxtitlebar' href='#'>
						<font class=wfui_stepgroup_f1>【<!--stepname-->环节A】</font>
						<font class=wfui_stepgroup_f2>&nbsp;处理人:&nbsp;</font>
						<font class=wfui_stepgroup_f3><!--ownername-->张三&nbsp;&nbsp;&nbsp;&nbsp;</font>								
						<font class=wfui_stepgroup_f2>处理时间:</font>
						<font class=wfui_stepgroup_f3><!--finishtime-->2009-09-09</font>
					</span>
				</DIV>
				<DIV class="wfui_stepgroup_box_content" ctf='stepboxcontent'>
				</DIV>
			</DIV>
		</DIV>			
	</div>
</div>
	
JS定义:

获取: 
	根据自定义标签获取:var group = this.getUT('controlName');

方法：

事件:

标签:

*/


LWFP.StepGroup = {};
LWFP.StepGroup.d = 'lwfpstepgroup';
LWFP.StepGroup.groupInstance = '_lwfpStepGroupInstance';
LWFP.StepGroup.init = function(){}


LWFP.StepGroup.initGroups = function(_instance, element)
{
	var groups = LEAP.getElements("div[ct=" + LWFP.StepGroup.d + "][instance=" + _instance + "]", element);
	LWFP.StepGroup.initStepList(groups);
	
	groups = null;
}

LWFP.StepGroup.initStepList = function(groups)
{
	if (groups == null || groups.length <=0)
		return;

	try
	{
		for(var i=0; i<groups.length; i++)
		{
			var g = groups[i];
			var id = UUID.cID();
			g.setAttribute(LWFP.StepGroup.groupInstance, id);
			var btnFrames = LEAP.getElements("div[ct=" + LWFP.StepList.d + "]", g);
			if (btnFrames != null && btnFrames.length>0)
			{
				for(var k=0; k<btnFrames.length; k++)
				{
					btnFrames[k].setAttribute(LWFP.StepGroup.groupInstance, id);
				}
			}
			g.style.display = "none";
		}
	}
	finally
	{
		i = g = id = btnFrames = k = null;		
	}
}
LWFP.StepGroup.show = function(e, _element)
{
	try
	{
		var cid = e.getAttribute(LWFP.StepGroup.groupInstance);
		if (cid == null || cid == "")
			return;

		var g = LEAP.getElement("div[ct=" + LWFP.StepGroup.d + "][" + LWFP.StepGroup.groupInstance + "=" + cid + "]", _element);
		g.style.display = "block";
	}
	finally
	{
		cid = g = null;
	}	
}






/**
 * 流程历史步列表
 * @class LWFP.StepList control
 * @type user control
 * @example
 
HTML定义:
	<DIV class="wfui_stepgroup_list" ut="controlName" ct="lwfpsteplist"></DIV>

JS定义:

获取: 
	根据自定义标签获取:var btnFrame = this.getUT('controlName');

方法：

事件:

标签:
	_showtitle: int 是否显示标题栏，0不显示1显示（默认）
	_expand: int展开属性 1展开第一栏

	JS步骤过滤脚本标签组：
		JS步骤过滤脚本标签组包括如下三个必须的标签，插件在加载步骤表单时调用标签中指定的JS文件中的指定类型中的指定方法，并传入所有历史步骤清单，指定的方法必须返回需要显示的历史步骤清单。
		_jspath：JS文件路径，如：/LEAP/LWFP/JavaScript/StepFilter.js
		_jsclass：JS类型，如：StepFilter
		_jsmethod：JS方法，如：Filter
	
		示例脚本:
		var StepFilter = function()
		{
			this.Filter = function(arg)
			{
				try
				{
					var wfData = arg.WFData; //获取流程运行时数据
					var steps = wfData.historySteps; //获取历史步骤清单
					if (steps == null)
						return null;
						
					var result = new Array();
					for(var i=0; i<steps.length; i++)
					{
						if (steps[i]满足显示条件）
							result.add(steps[i]);
					}
					
					if (result.length == 0)
						return null;
					else
						return result;
				
				}
				finally
				{
					wfData = steps = i = null;
				}
			}		
		}
	
	
*/


LWFP.StepList = {};
LWFP.StepList.d = 'lwfpsteplist';
LWFP.StepList.nd = 'wfrunningdata';
LWFP.StepList.init = function(){}

LWFP.StepList.loadSteps = function(e, data, stepCache, domain)
{
	try
	{
		if (data == null || data.historySteps == null)
			return;
		
		var flag;
		var hasItem = false;
		var _steps = LWFP.StepList.matchStep(e, data, domain);
		
		_steps = LWFP.StepList.__sort(_steps);
		if (_steps != null)
		{			
			e[LWFP.StepList.nd] = data;
			e.style.display = "block";
			var idx = 0;
			for(var i=0; i<_steps.length; i++)
			{
				var __step = _steps[i];
				flag = false;
				if (__step.hsid != null && __step.recid != null)
				{
					flag = true;
					LWFP.StepList.CreateStepBox(e, __step, 0, idx, data);
					idx++;
				}
							
				if (__step.hsid != null && __step.actrecid != null)
				{
					flag = true;
					LWFP.StepList.CreateStepBox(e, __step, 1, idx, data);
					idx++;
				}
				
				if (flag == true)
				{	
					hasItem = true;
					stepCache.add(__step.hsid);
				}
			}
			
			if (hasItem == true)
				LWFP.StepGroup.show(e, domain.formElement);
		}		
	}
	finally
	{
		flag = hasItem = _steps = i = __step = idx = null;
	}	
}

LWFP.StepList.matchStep = function(e, data, domain)
{
	var ret = data.historySteps;
	
	var _jspath = e.getAttribute("_jspath");
	var _jsclass = e.getAttribute("_jsclass");
	var _jsmethod = e.getAttribute("_jsmethod");
	
	if (_jspath == null || _jsclass == null || _jsmethod == null)
		return ret;
	
	_jspath = _jspath.Trim();
	_jsclass = _jsclass.Trim();
	_jsmethod = _jsmethod.Trim();
	
	if (_jspath == "" || _jsclass == "" || _jsmethod == "")
		return ret;
		
	try
	{
		leapclient.loadjs(_jspath);
		var o = eval("({funcObject:" + _jsclass + "})");
		var funcObj = new o.funcObject();
		funcObj = LEAP.newPageObjectInstance(_jsmethod, funcObj, null, {___pageObjectModel:domain.pom,___parentModule:domain}, null, null);

		ret = funcObj[_jsmethod]({WFData:data});
		
		if (ret == null)
		{
			return null;
		}
		else
		{
			if (ret.length == 0)
				return null;
			else
				return ret;
		}
	}
	catch(e)
	{
		return ret;		
	}
	finally
	{
		ret = _jspath = _jsclass = _jsmethod = o = funcObj = null;
	}	
		
}

//type: 0-recid; 1-actrecid
LWFP.StepList.CreateStepBox = function(e, step, type, idx, wfdata)
{
	LWFP.StepBox.Create(e, step, type, idx, wfdata);
}

LWFP.StepList.getList = function(_instance, _element)
{
	return LEAP.getElements("div[ct=" + LWFP.StepList.d + "][instance=" + _instance + "]", _element);
}

LWFP.StepList.hasLimit = function(e, data)
{
	return false;
}

LWFP.StepList.__sort = function(steps)
{
	try
	{
		var _arr = [];
		for(var k=0; k<steps.length; k++)
			_arr.add(steps[k]);
		
        for(var i=_arr.length-1; i>0; i--) 
	    {
	    	for(var j = 0; j < i; j++)
		    {
	    		if(_arr[j].finishtime.time > _arr[j + 1].finishtime.time )
		    	{
	    			var tmp = _arr[j];
	    			_arr[j] = _arr[j+1];
	    			_arr[j+1] = tmp;
		        }
		    }
		}
		
		return _arr;        
	}
	finally
	{
		_arr = k = i = j = tmp = null;
	}
}





/**
 * 流程历史步骤框
 * @class StepBox control
 * @type user control
 * @example
*/

LWFP.StepBox = {};
LWFP.StepBox.d = 'lwfpstepbox';
LWFP.StepBox.ctf_titlebar = 'stepboxtitlebar';
LWFP.StepBox.ctf_content = 'stepboxcontent';
LWFP.StepBox.nd = 'data';
LWFP.StepBox.nt = 'type';
LWFP.StepBox.Form = null;
LWFP.StepBox.status = "status"; //状态属性,0折叠1展开
LWFP.StepBox.hasLoad = "hasLoad"; //状态属性,0未加载1已加载
LWFP.StepBox.init = function()
{
	if (document != null && document.body != null)
		LWFP.StepBox._init();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.StepBox._init);
}

LWFP.StepBox._init = function()
{	
	LEAP.addEvent(document.body, 'click', LWFP.StepBox.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LWFP.StepBox._init);		
}

LWFP.StepBox.uiProcess = function(arg)
{
	var type = null;
	
	try
	{
		if (arg != null && arg.e != null && arg.e.type != null)
			type = arg.e.type;
		
		if (type == null || type != "click") 
			return;
		
		var src = arg.e.srcElement;		
		if (src == null || src.getAttribute == null)
			return;
		var ctf = src.getAttribute(commfields.ctf);
		if (ctf == null)
			return;
		if (ctf != LWFP.StepBox.ctf_titlebar)
			return;
		
		var element = LEAP._match(src, LWFP.StepBox.d);
		if (element == null)
			return;
	
		LWFP.StepBox.Change(element);
	}
	finally
	{
		type = src = ctf = element = null;
	}
	
}


LWFP.StepBox.loadStepModule = function(e, wfdata)
{
	try
	{
		var _moduleName = null;
		var _recid = null;
		var _step = e[LWFP.StepBox.nd];
		var _type = e.getAttribute(LWFP.StepBox.nt);
		if (_step == null || _type == null)
			return;
		
		var list = LEAP._match(e, LWFP.StepList.d);
		wfdata = list[LWFP.StepList.nd];
		
		var _container = LEAP.getElement("div[ctf=" + LWFP.StepBox.ctf_content + "]", e);
		_container.style.display = "block";
		
		var _stepid = null;
		if (_type == 0)
		{
			_moduleName = _step.modulename;
			_recid = _step.recid;
			_stepid = _step.stepid;
		}
		else
		{
			_moduleName = _step.actmodulename;
			_recid = _step.actrecid;
		}
		
		var bean = LEAP.request('WfSearchHistoryRecord', {stepid:_stepid, recordId:_recid, archCategory:wfdata.archCategory } ); 			
		if (bean != null)
		{
			LWFP.innerApi.getChildBeans(bean);
			
			var _paentModule = LEAP.getLoadedModule(list.getAttribute("instance"));
			var _form = _paentModule.loadModule2({name: _moduleName, parent: _container,
					pageMode:"view",
					authority: LWFP.innerApi.str2OptionAuthority(bean.primaryBean.lwfp_module_opreations),
					moduleLoadArg:{workflow: new LWFPWorkFlow().Create(wfdata)} });
				
			LEAP.opinion.setPageArchiveCategory(_form.instance, _form.moduleElement, wfdata.archCategory);
			
			_form.setPageDataOnWF(bean.primaryBean, bean.childBeans);
		}
								
		//调整容器高度
		if (_container.childNodes == null || _container.childNodes.length ==0) 
			return;		
		var _formElement;
		for(var i=0; i<_container.childNodes.length; i++)
		{
			if (_container.childNodes[i].nodeName == "DIV")
			{
				_formElement = _container.childNodes[i];
				break;
			}
		}
		if (_formElement == null) 
			return;
			
		//调整容器高度
		LEAP.asyn(LWFP.StepBox.__setSize, 1000, null, _formElement.getAttribute('instance'));
		
		//绑定数据、调用扩展
		//_form.setPageDataByPK(_recid, null, true);
		
		/*var list = e.parentNode;
		var data = list.getAttribute(LWFP.StepList.nd);
		if (data.attachments != null)
			LEAP.attachment.setPageValue(_form.instance, _formElement, data.attachments);
		if (data.opinions != null)
			LEAP.opinion.setPageValue(_form.instance, _formElement, data.opinions);*/
	}
	finally
	{
		_moduleName = _recid = _step = _type = _container = _form = _formElement = _wedgeheight = bean = list = _paentModule = null;
	}		
}

LWFP.StepBox.__setSize = function(c)
{
	try
	{
		if (!c)
			return;
			
		var __b = LEAP.getElement("div[instance=" + c + "]:first");
		
		var _wedgeheight = __b.getAttribute("wedgeheight");				
		if (_wedgeheight != null)
		{
			__b.parentElement.style.height = parseInt(_wedgeheight) + 20 + "px";
		}
		else
		{		
			__b.parentElement.style.height = __b.offsetHeight + 20 + "px";
		}
		
		if (__b.style.width == '')
		{
			__b.style.width = "98%";
			__b.style.marginLeft = "1%";
		}
		
	}
	finally
	{
		c = __b = null;
	}
}

LWFP.StepBox.Change = function(e, wfdata)
{
	try
	{
		var status = e.getAttribute(LWFP.StepBox.status);
		var titlebar = LEAP.getElement("span[ctf=" + LWFP.StepBox.ctf_titlebar + "]", e);
		var container = LEAP.getElement("div[ctf=" + LWFP.StepBox.ctf_content + "]", e);
		if (status == 0) 
		{//折叠状态下，则展开					
			var hasLoad = e.getAttribute(LWFP.StepBox.hasLoad);
			if (hasLoad == null)
			{
				LWFP.StepBox.loadStepModule(e, wfdata);
				e.setAttribute(LWFP.StepBox.hasLoad, true);
			}
			
			container.style.display = "block";
			e.setAttribute(LWFP.StepBox.status, 1);
			if (titlebar != null)
				titlebar.className = "wfui_stepgroup_box_title_collapse";
		}
		else
		{//展开状态下则折叠			
			if (titlebar == null)
			{
				return;
			}
			else
			{
				container.style.display = "none";
				e.setAttribute(LWFP.StepBox.status, 0);
				titlebar.className = "wfui_stepgroup_box_title_expand";
			}
		}
	}
	finally
	{
		status = titlebar = container = hasLoad = null;
	}
}

/**
 * 
 * @param {} e list 
 * @param {} step 步骤
 * @param {} type 0：step 1:action
 */
LWFP.StepBox.Create = function(e, step, type, idx, wfdata)
{
	try
	{		
		var showtitle = e.getAttribute("_showtitle");
		var expand = e.getAttribute('_expand');
		if (showtitle != null) 
			showtitle = showtitle.Trim();
		if (showtitle != "0")
			showtitle = 1;
		
		if (expand != null) expand = expand.Trim();
		if (expand != "1") 
			expand = -1;
		else
			expand = 1;
		
		
		var div1 = document.createElement("div");
			div1.className = "wfui_stepgroup_box";
			div1.setAttribute("ct", LWFP.StepBox.d);
			div1[LWFP.StepBox.nd] = step;
			div1.setAttribute(LWFP.StepBox.nt, type);
			div1.setAttribute(LWFP.StepBox.status, "0");
			
		if (showtitle == "1")
		{
			var div2 = document.createElement("div");
				div2.className = "wfui_stepgroup_box_title";
				div2.setAttribute("ctf", LWFP.StepBox.ctf_titlebar);
			var span = document.createElement("span");
				span.className = "wfui_stepgroup_box_title_expand";
				span.setAttribute("ctf", LWFP.StepBox.ctf_titlebar);
				span.href = "#";
			var f1 = document.createElement("font");
				f1.className = "wfui_stepgroup_f1";
				f1.setAttribute("ctf", LWFP.StepBox.ctf_titlebar);
				f1.innerText = "[" + ((type==0)?step.stepaliasname:step.outactionaliasname) + "]";
			var f2 = document.createElement("font");
				f2.className = "wfui_stepgroup_f2";
				f2.setAttribute("ctf", LWFP.StepBox.ctf_titlebar);
				f2.innerText = "处理人：";
			var f3 = document.createElement("font");
				f3.className = "wfui_stepgroup_f3";
				f3.setAttribute("ctf", LWFP.StepBox.ctf_titlebar);
				f3.innerText = step.ownername + "    ";
			var f4 = document.createElement("font");
				f4.className = "wfui_stepgroup_f2";
				f4.setAttribute("ctf", LWFP.StepBox.ctf_titlebar);
				f4.innerText = "处理时间：";
			var f5 = document.createElement("font");
				f5.className = "wfui_stepgroup_f3";
				f5.setAttribute("ctf", LWFP.StepBox.ctf_titlebar);
				f5.innerText = LEAP.formatdate(step.finishtime.time, 0);

			span.appendChild(f1);
			span.appendChild(f2);
			span.appendChild(f3);
			span.appendChild(f4);
			span.appendChild(f5);
			div2.appendChild(span);
			
			div1.appendChild(div2);		
		}
		else
		{
			div1.setAttribute(LWFP.StepBox.status, "1");
		}
		
		var div3 = document.createElement("div");
			div3.className = "wfui_stepgroup_box_content";
			div3.setAttribute("ctf", LWFP.StepBox.ctf_content);
		
		div1.appendChild(div3);
		
		e.appendChild(div1);

		if (showtitle != 1)
			LWFP.StepBox.loadStepModule(div1, wfdata);
		else if (expand ==1 && idx==0)
			//LEAP.asyn(LWFP.StepBox.Change, this, 0, div1);
			LWFP.StepBox.Change(div1, wfdata);
	}
	finally
	{
		div1 = div2 = span = f1 = f2 = f3 = f4 = f5 = div3 = null;
	}
}

LWFP.StepBox.init();















/**
 * 工具栏
 * @class LWFP.Toolbar control
 * @type user control
 * @example
 
HTML定义:
<DIV class='wfcontrol_toolbar' ct='lwfptoolbar' style='position:relative'>			
</DIV>	
*/


LWFP.Toolbar = {};
LWFP.Toolbar.d = 'lwfptoolbar';
LWFP.Toolbar.n = 'data';
LWFP.Toolbar.t = '_type';
LWFP.Toolbar.bc = 'lwfptoolbutton';
LWFP.Toolbar.symbol ={history:1, save:2, pullback:3, pushback:4, js:5, 
						option:6, action:7, aheadaction:8, send:9, print:10, extend:11,
						del:12, favorite:13, hasread:14,
						smallnote:20, close:21, word:22, addzw:23, more:30};
LWFP.Toolbar.init = function()
{
	if (document != null && document.body != null)
		LWFP.Toolbar._init();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.Toolbar._init);

	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnShowHistory');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnPrint');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnSave');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnPullback');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnPushback');	
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnJsFuncButtonClick');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnFlowOptionClick');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnActionButtonClick');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnAheadActionButtonClick');	
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnSend');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnDelete');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnFavorite');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnWordEdit');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnHasRead');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnAddZWClick');
	ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnMoreClick');
	
	//ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnSmallNoteClick');	
	//ElementEventManager.addManagedEventType(LWFP.Toolbar.d, 'OnCloseButtonClick');	
}
LWFP.Toolbar._init = function()
{		
	LEAP.addEvent(document.body, 'click', LWFP.Toolbar.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LWFP.Toolbar._init);
}
LWFP.Toolbar.uiProcess = function(arg)
{		
	try
	{		
		var src = arg.e.srcElement;
		if (null == src) return;
		var __element = LEAP._match(src, LWFP.Toolbar.d);
		if(null == __element) return;		
		var element = LEAP._match(src, LWFP.Toolbar.bc);
		if(null == element) return;
		
		var __type = element.getAttribute(LWFP.Toolbar.t);
		var __data = element[LWFP.Toolbar.n];
		
		if (__type == LWFP.Toolbar.symbol.history)
			ElementEventManager.handleEvent(__element, "OnShowHistory");
		else if (__type == LWFP.Toolbar.symbol.print)
			ElementEventManager.handleEvent(__element, "OnPrint");
		else if (__type == LWFP.Toolbar.symbol.save)
			ElementEventManager.handleEvent(__element, "OnSave");
		else if (__type == LWFP.Toolbar.symbol.pullback)
			ElementEventManager.handleEvent(__element, "OnPullback", {src: arg.e.srcElement});
		else if (__type == LWFP.Toolbar.symbol.pushback)		
			ElementEventManager.handleEvent(__element, "OnPushback");
		else if (__type == LWFP.Toolbar.symbol.js)		
			ElementEventManager.handleEvent(__element, "OnJsFuncButtonClick", {data:__data});
		else if (__type == LWFP.Toolbar.symbol.option)		
			ElementEventManager.handleEvent(__element, "OnFlowOptionClick", {data:__data});
		else if (__type == LWFP.Toolbar.symbol.action)		
			ElementEventManager.handleEvent(__element, "OnActionButtonClick", {data:__data});
		else if (__type == LWFP.Toolbar.symbol.aheadaction)		
			ElementEventManager.handleEvent(__element, "OnAheadActionButtonClick", {data:__data});
		else if (__type == LWFP.Toolbar.symbol.send)		
			ElementEventManager.handleEvent(__element, "OnSend");
		else if (__type == LWFP.Toolbar.symbol.del)		
			ElementEventManager.handleEvent(__element, "OnDelete");
		else if (__type == LWFP.Toolbar.symbol.favorite)		
			ElementEventManager.handleEvent(__element, "OnFavorite", {src:arg.e.srcElement});
		else if (__type == LWFP.Toolbar.symbol.word)		
			ElementEventManager.handleEvent(__element, "OnWordEdit");
		else if (__type == LWFP.Toolbar.symbol.hasread)		
			ElementEventManager.handleEvent(__element, "OnHasRead");
		else if (__type == LWFP.Toolbar.symbol.addzw)
			ElementEventManager.handleEvent(__element, "OnAddZWClick", {src:arg.e.srcElement});
		else if (__type == LWFP.Toolbar.symbol.more)
			ElementEventManager.handleEvent(__element, "OnMoreClick", {src:arg.e.srcElement});
			
		//else if (__type == LWFP.Toolbar.symbol.close)
		//	ElementEventManager.handleEvent(__element, "OnCloseButtonClick");
	}
	finally
	{
		src = __element = element = __type = __data = null;
	}
}



LWFP.Toolbar.searchToolbars = function(_instance, element)
{
	return LEAP.getElements("div[ct=" + LWFP.Toolbar.d + "][instance=" + _instance + "]", element);
}

LWFP.Toolbar.loadButton = function(e, data, close, domain)
{
	try
	{
		e.innerHTML = '';
				
		//关闭
		//if (domain.loadType == 2)		
		//	LWFP.Toolbar.createButton(e, '关闭', null, null, LWFP.Toolbar.symbol.close,'wfcontrol_toolbar_icon_close');

		//流程监控
		if (data.flow.historybtn != null && data.flow.historybtn != "")
		{
			LWFP.Toolbar.createButton(e, data.flow.historybtn, null, null, LWFP.Toolbar.symbol.history, 'wfcontrol_toolbar_icon_history', "M");
			
			LEAP.addShortKeyEvent("alt+77", domain.formElement, domain.showHistoryForm, null, domain);
		}
		
		if (data.flow.printbtn != null && data.flow.printbtn != "")
		{
			LWFP.Toolbar.createButton(e, data.flow.printbtn, '打印当前表单', null, LWFP.Toolbar.symbol.print, 'wfcontrol_toolbar_icon_print', "P");
			
			LEAP.addShortKeyEvent("alt+80", domain.formElement, domain.print, null, domain);
		}
				
		LWFP.Toolbar._createTag(e, 'extendbutton');
		
		//添加正文 //TODO
		if ((data.entry == null) || (data.entry != null && data.currentStep != null && data.currentStep.readstep !=1) )
		{
			if (e.getAttribute('_addZWButton'))
			{
				var _name = (data.flow.adddocbtn==null || data.flow.adddocbtn.trim()=='') ? '添加正文':data.flow.adddocbtn;
				LWFP.Toolbar.createButton(e, _name, _name, null, LWFP.Toolbar.symbol.addzw, 'wfcontrol_toolbar_icon_zw');
			}
		}
		
		//保存
		if (( (data.currentStep != null && data.currentStep.readstep !=1) || data.entry == null)
				 
				&& data.module != null && data.module.modulename != null)
		{
			if (data.flow.savebtn != null && data.flow.savebtn != "")
			{
				LWFP.Toolbar.createButton(e, data.flow.savebtn, null, null, LWFP.Toolbar.symbol.save, 'wfcontrol_toolbar_icon_save', "S");
				
				LEAP.addShortKeyEvent("alt+83", domain.formElement, domain.submitCurrentModule, null, domain);
			}
		}
		
		//回收
		if (data.currentStep==null || (data.currentStep != null && data.currentStep.readstep !=1))
		{
			if (data.pullbackSteps != null)
				LWFP.Toolbar.createButton(e, '回收', null, null, LWFP.Toolbar.symbol.pullback,'wfcontrol_toolbar_icon_pullback');
			
			//退回
			if (data.userToPushBack != null)
				LWFP.Toolbar.createButton(e, '退回', null, null, LWFP.Toolbar.symbol.pushback,'wfcontrol_toolbar_icon_pushback');
	
			//扩展JS按钮 
			if (data.stepJsFuncs != null)
			{	
				for(var i=0; i<data.stepJsFuncs.length; i++)
					LWFP.Toolbar.createButton(e, data.stepJsFuncs[i].func.funcname, null, data.stepJsFuncs[i].func, LWFP.Toolbar.symbol.js,'wfcontrol_toolbar_icon_js');
			}
		}
				
		//操作
		if (data.flowOptions != null)
		{			
			for(var i=0; i<data.flowOptions.length; i++)
				LWFP.Toolbar.createButton(e, data.flowOptions[i].opname, null, data.flowOptions[i], LWFP.Toolbar.symbol.option, 'wfcontrol_toolbar_icon_option'); 
		}
				
		if (data.currentStep==null || (data.currentStep != null && data.currentStep.readstep !=1))
		{
			//ahead action
			if (data.nextActions != null && data.nextActions.length>0)
			{	
				for(var i=0; i<data.nextActions.length; i++)
				{
					if (data.nextActions[i].runahead != null && data.nextActions[i].runahead == 1)
					{
						if (data.nextActions[i].moduleName != null)
							LWFP.Toolbar.createButton(e, data.nextActions[i].aliasname, data.nextActions[i].aliasname2, data.nextActions[i], LWFP.Toolbar.symbol.aheadaction, 'wfcontrol_toolbar_icon_action');
						else
							LWFP.Toolbar.createButton(e, data.nextActions[i].aliasname, data.nextActions[i].aliasname2, data.nextActions[i], LWFP.Toolbar.symbol.action, 'wfcontrol_toolbar_icon_action');
					}
				}
			}
		}
		
		//发送
		var flag = false;
		if (data.currentStep != null &&　data.currentStep.readstep == 1)
		{			
			LWFP.Toolbar.createButton(e, '已阅', null, null, LWFP.Toolbar.symbol.hasread, 'wfcontrol_toolbar_icon_hasread');
		}
		else if (data.currentStep != null || data.entry == null)
		{
			var flag = false;			
			if (data.nextActions != null)
			{				
				for(var i=0; i<data.nextActions.length; i++)
				{
					if (data.nextActions[i].runahead == null || data.nextActions[i].runahead == 0)
					{
						flag = true;
						break;
					}
				}
			}
			
			if (flag)
			{
				LWFP.Toolbar.createButton(e, (data.flow.sendbtn==null||data.flow.sendbtn=='')?'发送':data.flow.sendbtn, null, null, LWFP.Toolbar.symbol.send, 'wfcontrol_toolbar_icon_send', "G");
				
				LEAP.addShortKeyEvent("alt+71", domain.formElement, domain.OnSend, null, domain);				
			}
		}	
				
		
		if (data.currentStep != null && data.currentStep.readstep !=1)
		{
			//编辑正文
			if ( (data.entry == null || data.currentStep != null) && data.flow.wordbtn != null && data.flow.wordbtn != "")
			{			
				LWFP.Toolbar.createButton(e, data.flow.wordbtn, null, null, LWFP.Toolbar.symbol.word, 'wfcontrol_toolbar_icon_word');	
			}
		}
		
		LWFP.Toolbar._createTag(e, 'righttag', 'right');
		
		//收藏
		if (data.entry != null && data.flow.favbtn != null && data.flow.favbtn != "")
			LWFP.Toolbar.createButton(e, '关注', '添加关注', null, LWFP.Toolbar.symbol.favorite, 'wfcontrol_toolbar_icon_Favorite');
			
		//删除
		if (data.entry != null && data.historySteps == null && data.currentStep != null && data.flow.delbtn != null && data.flow.delbtn != "")
			LWFP.Toolbar.createButton(e, data.flow.delbtn, '删除该事务', null, LWFP.Toolbar.symbol.del, 'wfcontrol_toolbar_icon_delete');
		
		//更多
		//if (flag == true && domain.WFToolbarShowMore == 1)
		//	LWFP.Toolbar.createButton(e, '更多', '', null, LWFP.Toolbar.symbol.more, 'wfcontrol_toolbar_icon_more');
		
	}
	finally
	{
		i = flag = null;
	}
	
}

LWFP.Toolbar.initMoreButton = function(e, data, domain)
{
	try
	{
		//发送
		var flag = false;
		if (data.currentStep != null &&　data.currentStep.readstep == 1)
		{			
			
		}
		else if (data.currentStep != null || data.entry == null)
		{			
			if (data.nextActions != null)
			{				
				for(var i=0; i<data.nextActions.length; i++)
				{
					if (data.nextActions[i].runahead == null || data.nextActions[i].runahead == 0)
					{
						flag = true;
						break;
					}
				}
			}
			
			if (flag == true && domain.WFToolbarShowMore == 1)
			{
				var _btn = LEAP.getElement("a[_type=" + LWFP.Toolbar.symbol.send + "]", e);
				if (_btn)
					_btn.style.display = 'none';
				
				//更多
				LWFP.Toolbar.createButton(e, '更多', '', null, LWFP.Toolbar.symbol.more, 'wfcontrol_toolbar_icon_more');
			}
		}		
	}
	finally
	{
		
	}
}

LWFP.Toolbar.createButton = function(_e, _name, _title, _data, _type, cls, key)
{
	try
	{
		var _a = document.createElement("a");						
			_a.href = 'javascript:void(0)';
			_a.className = cls;
			if (!key)
				_a.innerHTML = '&nbsp;&nbsp;' + _name + '&nbsp;&nbsp;';
			else
				_a.innerHTML = '&nbsp;&nbsp;' + _name + "<font style='vertical-align:top;font-size:10px;'>(<U>" + key + '</U>)</font>&nbsp;&nbsp;';
			_a.setAttribute('ct', LWFP.Toolbar.bc);
			_a.setAttribute(LWFP.Toolbar.t, _type);	
		if (_title != null)
			_a.title = _title;	
		if (_data != null)
			_a[LWFP.Toolbar.n] = _data;	
		
		_e.appendChild(_a);
		
		return _a
	}
	finally
	{
		_a = null;
	}
}

LWFP.Toolbar.createExtendButton = function(_e, _name, _title, _width, _icon, tagName, styleFloat)
{
	try
	{
		var _btns = LEAP.getElements("a[_type=" + LWFP.Toolbar.symbol.extend + "]", _e);
		if (_btns != null)
		{
			for(var i=0; i<_btns.length; i++)
			{
				if (_btns[i].innerText == _name)
					return null;
			}
		}		
		
		if (_width == null)
			_width = 65;
		
		var _tagName = "extendbutton";
		if (tagName)
			_tagName = tagName;		
		var tag = LEAP.getElement("span[ctf=" + _tagName + "]", _e);			
		var _a = document.createElement("a");
			_a.href = 'javascript:void(0)';
			_a.className = "wfcontrol_toolbar_icon_default";
			_a.setAttribute(LWFP.Toolbar.t, LWFP.Toolbar.symbol.extend);
			if (_title != null)
				_a.title = _title;
			_a.innerHTML = _name;
			_a.style.width = _width;
			_a.style.styleFloat = styleFloat?styleFloat:"left";
			
			if (_icon != null)
				_a.style.backgroundImage = "url(" + LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(_e)) + _icon + ")";
			
		
		if (_tagName == "extendbutton")
			_e.insertBefore(_a, tag);
		else if (_tagName == "righttag")
			_e.insertBefore(_a, tag);
			
		
		return _a;
	}
	finally
	{
		_btns = tag = _a = null;
	}
}

LWFP.Toolbar._createTag = function(_e, _ctf, styleFloat)
{
	try
	{
		var _span = document.createElement("span");			
			_span.setAttribute('ctf', _ctf);
			_span.style.styleFloat = styleFloat?styleFloat:"left";
		
		_e.appendChild(_span);
		
		return _span
	}
	finally
	{
		_span = null;
	}	
}

LWFP.Toolbar.displayButton = function(_e, _type, _display)
{
	try
	{
		var btn = LEAP.getElement("a[_type=" + _type + "]", _e);
		if (btn)
		{
			if (_display == true)
				btn.style.display = "block";
			else if (_display == false)
				btn.style.display = "none";
		}
	}
	finally
	{
		btn = null;
	}	
}

LWFP.Toolbar.getToolBarButtons = function(_e, _type)
{
	return LEAP.getElements("a[_type=" + _type + "]", _e);
}


LWFP.Toolbar.init();


LWFP.Warnning = {};
LWFP.Warnning.element = null;
LWFP.Warnning.d = 'wfwranning'
LWFP.Warnning.init = function()
{
	if (document != null && document.body != null)
		LWFP.Warnning._init();
	else 
		UIEventManager.addEvent(window, 'load', LWFP.Warnning._init);
}
LWFP.Warnning._init = function()
{		
	LEAP.addEvent(document.body, 'click', LWFP.Warnning.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LWFP.Warnning._init);
}
LWFP.Warnning.uiProcess = function(arg)
{		
	try
	{		
		var src = arg.e.srcElement;
		if (null == src) return;
		var __element = LEAP._match(src, LWFP.Warnning.d);
		if(null == __element) return;		
				
		var _ctf = src.getAttribute('ctf');
		if (_ctf == null)
			return;
		
		var fn = src.getAttribute('fn');
		if (fn)
		{
			fn.apply(src);
		}
	}
	finally
	{
		src = __element = _ctf = fn = null;
	}
}
LWFP.Warnning.alert = function(title, content, showDefaultButton, btns)
{
	try
	{
		if (LWFP.Warnning.element == null)
			LWFP.Warnning.element = LWFP.Warnning.i();
			
		var _box = LEAP.getElement('div[ctf=warnbox]', LWFP.Warnning.element);
		var _con = LEAP.getElement('div[ctf=warncontent]', LWFP.Warnning.element);
			_con.innerHTML = "";
			
		var h = document.createElement("h1");
			h.className = 'wfcontrol_warnning_font_title';
			h.innerText = title;
		var span = document.createElement("span");
			span.className = 'wfcontrol_warnning_font_content';
			span.innerText = content;
			
		_con.appendChild(h);
		_con.appendChild(span);
		
		if (showDefaultButton == true)
		{
			var a = document.createElement("a");
				a.className = 'lgbtn';
				a.style.width = "auto";
				a.style.paddingTop = 0;
				a.style.paddingRight = 15;
				a.style.paddingBottom = 0;
				a.style.paddingLeft = 15;
				a.innerText = "确定";
				a.style.cursor = 'hand';
				a.setAttribute('fn', LWFP.Warnning.hide);
				a.setAttribute('ctf', 'wfwarnningbtn');
				
			_con.appendChild(a);
		}
		
		if (btns != null)
		{
			for(var i=0; i<btns.length; i++)
			{
				var btn = btns[i];
				var _a = document.createElement("a");
					_a.className = 'lgbtn';
					_a.style.width = "auto";
					_a.style.paddingTop = 0;
					_a.style.paddingRight = 15;
					_a.style.paddingBottom = 0;
					_a.style.paddingLeft = 15;
					_a.innerText = btn.name;
					_a.title = btn.title;
					_a.style.cursor = 'hand';
					_a.setAttribute('fn', btn.fn);
					_a.setAttribute('ctf', 'wfwarnningbtn');
				
				_con.appendChild(_a);	
			}			
		}
		
		_box.style.top = (LWFP.Warnning.element.offsetHeight - _box.offsetHeight)/2;
		_box.style.left = (LWFP.Warnning.element.offsetWidth - _box.offsetWidth)/2;
		
		LWFP.Warnning.element.style.display = "block";
	}
	finally
	{
		_box = _con = h = a = i = btn = _a = null;
	}
	
}

LWFP.Warnning.hide = function()
{
	if (LWFP.Warnning.element != null)
		LWFP.Warnning.element.style.display = "none";
}

LWFP.Warnning.i = function(title, content, btns)
{
	try
	{
		var div_bg = document.createElement("div");
			div_bg.className = 'wfcontrol_warnning_background';		
			div_bg.setAttribute('ct', LWFP.Warnning.d);
		var div_light = document.createElement("div");
			div_light.className = 'wfcontrol_warnning_light';			
		var div_warn = document.createElement("div");
			div_warn.className = 'wfcontrol_warnning';
			div_warn.setAttribute('ctf','warnbox');
		var div_warn_left = document.createElement("div");
			div_warn_left.className = 'wfcontrol_warnning_left';
		var div_warn_right = document.createElement("div");
			div_warn_right.className = 'wfcontrol_warnning_right';
			div_warn_right.setAttribute('ctf', 'warncontent');
			
		div_warn.appendChild(div_warn_left);
		div_warn.appendChild(div_warn_right);
		div_bg.appendChild(div_light);
		div_bg.appendChild(div_warn);
		
		document.body.appendChild(div_bg);
		
		return div_bg;
	}
	finally
	{
		div_bg = div_light = div_warn = div_warn_left = div_warn_right = null;
	}
}

LWFP.Warnning.init();





/*******************************************************************************
 * word模板加载API
 * 
 * @class LEAP.wordtempleate API
 * @type user API
 * @user andy
 * @example
 * 
 * 
 * 定义：
 * this.wordtemplate=function(){
 * 		var url=leapconfig.server + "LEAP/Download/fileDir/book.doc";
 * 		var bookMarkslist=[];
 * 		for(var k=0;k<3;k++){
 * 			bookMarkslist[k]=[];
 * 		}
 * 		bookMarkslist[0][0]="book1";
 * 		bookMarkslist[1][0]="book2";
 * 		bookMarkslist[2][0]="book3";
 * 		bookMarkslist[0][1]="第一";
 * 		bookMarkslist[1][1]="第二";
 * 		bookMarkslist[2][1]="第三";
 *		LEAP.wordtempleate.openTemplate(url, 'default', '新建word文档', this.fn, this, bookMarkslist);
 *	}
 *	this.fn=function(obj){
 *		//obj.ShowDialog(3) //文件另存为
 *	}
 *
 * 属性说明：
 * url：设置模板存放地址 不可为空
 * uploadPath:上传通道，默认default
 * viewname:显示名称
 * fn:回调方法
 * caller:作用域
 * marksdata：模板中书签设置的二维数组，可为空
 * 
 	书签数据格式：[[name1,value1],[name2,value2],[name3,value3],...]
 			其中value可以为纯文本、对象、对象数组，对象用来描述复杂格式，对象的格式{value:"文本或图片路径",type:"类型0文本1图片"}
 	示例：
 	 var marksdata = [];
		marksdata[0] = [];
		marksdata[1] = [];
		marksdata[2] = [];
		marksdata[3] = [];
		
		//纯文本：
		marksdata[0][0] = "签发";	
		marksdata[0][1] = "签发签发签发签发"; 
		
		//文本对象：
		marksdata[1][0] = "公文字号";
		marksdata[1][1] = {value:"公文字号ddddd", type:0};
		
		//图片对象：
		marksdata[2][0] = "审签";
		marksdata[2][1] = {value:leapconfig.server + "LEAP/Download/handsign/2013/12/23/440306000000000000/d1f90eb54b3f4abdaef6fd7badd15b5d_@aGFuZHdyaXRl.jpeg", type:1};
		
		//图文混排(图片＋文本＋图片＋文本)：
		marksdata[3][0] = "会签";		
		marksdata[3][1] = [
			{value:leapconfig.server + "LEAP/Download/handsign/2013/12/23/440306000000000000/d1f90eb54b3f4abdaef6fd7badd15b5d_@aGFuZHdyaXRl.jpeg", type:1},
			{value:"aaaaaaaaaaaaaaa", type:0},
			{value:leapconfig.server + "LEAP/Download/handsign/2013/12/23/440306000000000000/d320e0f49a2542d8a9f9b833723cb6f4_@aGFuZHdyaXRl.jpeg", type:1},
			{value:"bbbbbbbbbbbbbbb", type:0}
					];
		LEAP.wordtempleate.openDocument(leapconfig.server + "LEAP/Download/default/2013/12/23/92d7bbde9c4542ef9f5d59ea6bcc4c96_@dGVzdA==.doc", "default/2013/12/23", "92d7bbde9c4542ef9f5d59ea6bcc4c96_@dGVzdA==.doc", false, null,this, marksdata);
		
 *  
 *  
 * 
 *************************************************************************/

LEAP.wordtempleate = {};
LEAP.wordtempleate.openTemplate = function(url, uploadpath, viewname, fn, caller,marksdata) 
{
	try 
	{
		if (!url)
		{
			alert("模板文件路径不能为空!");
			return;
		}
		
		var arg={};			
			arg.uploadpath = (uploadpath == null) ? "default":uploadpath;
			arg.viewname = (viewname == null) ? "新建文档.doc":viewname;
			arg.marksdata=marksdata;
			arg.url=url;
			
		var ret = window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(  ((caller && caller.leapclient) ? caller.leapclient.router :null) )
				+ "LEAP/LWFP/HTML/Default/wordtempleate/wordtempleateE.html"),
				arg,
				"dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px;status:no;scroll:no;");

		if (ret && caller && fn)
		{	
		 	fn.apply(caller, [ret]);
		}
	}
	catch (err) 
	{
		alert("错误：" + err.number + ":" + err.description);
	} 
	finally 
	{
		fn=caller=marksdata=url=null;
	}
}

LEAP.wordtempleate.openDocument = function(url, namedPath, viewname, readonly, fn, caller, marksdata) 
{
	try 
	{
		if (!url)
		{
			alert("模板文件路径不能为空!");
			return;
		}
		
		var arg={};			
			arg.namedPath = (namedPath == null) ? "default":namedPath;
			arg.viewname = (viewname == null) ? "新建文档.doc":viewname;
			arg.readonly = readonly;
			arg.marksdata = marksdata;
			arg.url=url;
			arg.isOpenExistsDocument = true;

		var ret = window.showModalDialog(window.geturl( LEAP.wfrouter.getServerURL(  ((caller && caller.leapclient) ? caller.leapclient.router :null) )
				+ "LEAP/LWFP/HTML/Default/wordtempleate/wordtempleateE.html"),
				arg,
				"dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px;status:no;scroll:no;");
	
		if (ret && caller && fn)
		{	
		 	fn.apply(caller, [ret]);
		}
	}
	catch (err) 
	{
		alert("错误：" + err.number + ":" + err.description);
	} 
	finally 
	{
		fn=caller=url=null;
	}
}


/**
 * 
 * 
 * @param {} url
 * @param {} arg: {namedPath:已命名路径, 
 * 					viewname：显示名, 
 * 					readonly：是否只读, 
 * 					fn：回调方法, 
 * 					caller：作用域, 
 * 					marksdata：标签值清单, 
 * 					uploadpath: 上传通道,
 * 					isLocalFile:是否打开本地文件(默认false)？如果打开的是本地文件，又需要上传保存，则必须指定上传通道
 * 					isOpenExistsDocument: 是否已经存在的文档(默认true)，true保存上传时为覆盖模式，false新增模式
 * 					operation: 操作类型，"SaveAsPdf_Local"本地VBA存为pdf
 * 					}
 */
LEAP.wordtempleate.openDocument2 = function(url, arg) 
{
	try
	{
		if (!url)
		{
			alert("模板文件路径不能为空!");
			return;
		}
		
		var arg1 = {};			
			arg1.namedPath = (arg.namedPath == null) ? "default" : arg.namedPath;
			arg1.viewname = (arg.viewname == null) ? "新建文档.doc" : arg.viewname;
			arg1.readonly = arg.readonly;
			arg1.marksdata = arg.marksdata;
			arg1.url = url;
			arg1.uploadpath = (arg.uploadpath == null) ? "default" : arg.uploadpath;
			arg1.isLocalFile = (arg.isLocalFile == null) ? false : arg.isLocalFile;
			arg1.isOpenExistsDocument = (arg.isOpenExistsDocument == null) ? true : arg.isOpenExistsDocument;
			arg1.operation = arg.operation;
			
		var ret = window.showModalDialog(window.geturl( LEAP.wfrouter.getServerURL(  ((arg.caller && arg.caller.leapclient) ? arg.caller.leapclient.router :null) )
				+ "LEAP/LWFP/HTML/Default/wordtempleate/wordtempleateE.html"),
				arg1,
				"dialogWidth:"+(screen.availWidth)+"px;dialogHeight:"+(screen.availHeight)+"px;status:no;scroll:no;");
	
		if (ret && arg.caller && arg.fn)
		{	
		 	arg.fn.apply(arg.caller, [ret]);
		}
	}
	catch (err) 
	{
		alert("错误：" + err.number + ":" + err.description);
	} 
	finally 
	{
		fn=caller=url=null;
	}
}











/**
 * @class calendar 日历控件
 * @html
  	<DIV ut='myCalendar' selectcolor="#00a8ec" daycellcolor="#FFFFFF" weekcellcolor="#F8F8F8" headercolor="#C2DEED" yearRange=2 class='wfcontrol_calendar' ct='calendar' style="border:none; width:300px; height:300px; cursor:pointer; float:left;">	
		<IMG style="DISPLAY: none" onerror='LEAP.calendar.i(0);' src="data:image:png,base64">
	</DIV>
 * 
 * @example
 * 	设：公元年数－1977（或1901）＝4Q＋R 
	则：阴历日期=14Q+10.6(R+1)+年内日期序数-29.5n 
	（注:式中Q、R、n均为自然数，R<4） 
	例：1994年5月7日的阴历日期为： 
		1994－1977＝17＝4×4＋1 
		故：Q＝4，R＝1 则：5月7日的阴历日期为： 
		14×4+10.6(1+1)+(31+28+31+30+7)-29.5n =204.2- 29.5n 
		然后用29.5去除204.2得商数6......27.2，6即是n值，余数27即是阴历二十七日。 
 *
 */
LEAP.calendar = {};
LEAP.calendar.d = 'calendar';
LEAP.calendar._init = function()
{
	LEAP.addEvent(document.body, 'click', LEAP.calendar.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.calendar._init);
}
LEAP.calendar.init = function()
{
	if (document != null && document.body != null)
		LEAP.calendar._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.calendar._init);
		
	ElementEventManager.addManagedEventType(LEAP.calendar.d, 'valueChange');
};
LEAP.calendar.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
			
		var element = LEAP._match(src, LEAP.calendar.d);
		if(null == element) return;
		
		var ctf = src.getAttribute('ctf');		
		if (ctf == "btnToday")
		{
			LEAP.calendar.__dayChange2(element);			
		}
		else if (ctf == "daycell")
		{
			LEAP.calendar.__dayChange(element, src);
		}
		else if (ctf == null)
		{		
			var itm = LEAP._match(src, 'daycell', 'ctf', 4);
			if (itm && itm.getAttribute('ctf') == "daycell" )
				LEAP.calendar.__dayChange(element, itm);
		}		
	}
	finally
	{
		src = ctf = element = itm = null;
	}
}

LEAP.calendar.setText = function(element, y, m, d, text, title)
{
	try
	{
		if(null == element) return;
		var _element = LEAP._match(element, LEAP.calendar.d);
		if(null == _element) return;
		
		var _m = m + 1;
		var obj = LEAP.getElement("TD[__x_yy=" + y + "][__x_mm=" + _m + "][__x_dd=" + d+ "]", _element);
		if(obj)
		{
			obj.innerHTML = d + text;
			if (title)
				obj.title = title;
		}
		
	}
	finally
	{		
		_element = _m = obj = null;
	}
}

LEAP.calendar.setFullText = function(element, y, m, d, text, title)
{
	try
	{
		if(null == element) return;
		var _element = LEAP._match(element, LEAP.calendar.d);
		if(null == _element) return;
		
		var _m = m + 1;
		var obj = LEAP.getElement("TD[__x_yy=" + y + "][__x_mm=" + _m + "][__x_dd=" + d+ "]", _element);
		if(obj)
		{
			obj.innerHTML = text;
			if (title)
				obj.title = title;
		}
		
	}
	finally
	{		
		_element = _m = obj = null;
	}
}

LEAP.calendar.__dayChange = function(element, cell)
{
	try
	{
		if (cell.innerText && cell.innerText.trim() != "" && cell.getAttribute("__x_dd"))
		{
			var y = element.getAttribute("_y_value");		
			var m = element.getAttribute("_m_value");
			//var d = cell.innerText.trim();
			var d = cell.getAttribute("__x_dd");
			
			var lv = LEAP.calendar.getValue(element);
			
			LEAP.calendar.refreshcalendar(element, y, m, d);						
			var nv = LEAP.calendar.getValue(element);			
			ElementEventManager.handleEvent(element, "valueChange", {lv:lv, nv:nv});
		}		
	}
	finally
	{
		y = m = d = lv = nv = null;
	}
}
LEAP.calendar.__dayChange2 = function(element)
{
	try
	{
		var lv = LEAP.calendar.getValue(element);
		
		var x = new Date();
		LEAP.calendar.refreshcalendar(element, x.getFullYear(), x.getMonth(), x.getDate());
		LEAP.select.setValue(LEAP.getElement("#xx_year", element),x.getFullYear());
		LEAP.select.setValue(LEAP.getElement("#xx_month", element),x.getMonth());
		x = null;
		
		var nv = LEAP.calendar.getValue(element);			
		ElementEventManager.handleEvent(element, "valueChange", {lv:lv, nv:nv});
	}
	finally
	{
		lv = x = nv = null;
	}
}

LEAP.calendar.___change = function(arg)
{
	try
	{
		if (!arg.caller || !arg.caller.id || !arg.arg2 || !arg.arg2.lv)
			return;
		
		var element = LEAP._match(arg.caller, LEAP.calendar.d);
		if(null == element) return;
		
		var lv = LEAP.calendar.getValue(element);
		
		if (arg.caller.id == "xx_year")
		{
			var y = arg.arg2.lv;
			var m = element.getAttribute("_m_value");
			var d = element.getAttribute("_d_value");
			
			LEAP.calendar.refreshcalendar(element, y, m, d);		
		}
		else if (arg.caller.id == "xx_month")
		{
			var y = element.getAttribute("_y_value");
			var m = arg.arg2.lv;
			var d = element.getAttribute("_d_value");
			
			LEAP.calendar.refreshcalendar(element, y, m, d);	
		}
		
		var nv = LEAP.calendar.getValue(element);			
		ElementEventManager.handleEvent(element, "valueChange", {lv:lv, nv:nv, monthchange:true});
	}
	finally
	{
		element = y = m = d = lv = nv = null;
	}
}

LEAP.calendar.getValue = function(element)
{
	try
	{
		var _element = LEAP._match(element, LEAP.calendar.d);
		if(null == _element) return;
		
		var y = parseInt(_element.getAttribute("_y_value"));
		var m =	parseInt(_element.getAttribute("_m_value"));
		var d = parseInt(_element.getAttribute("_d_value"));
		
		if (y==null || m==null || d==null)
			return null;

		m = "00" + (m+1);
		m = m.substring(m.length -2);
		d = "00" + d;
		d = d.substring(d.length -2);
	
		return y + '-' + m + '-' + d;
	}
	finally
	{
		_element = y = m = d = null;
	}
}

LEAP.calendar.getTime = function(element)
{
	try
	{
		var _element = LEAP._match(element, LEAP.calendar.d);
		if(null == _element) return;
		
		var y = parseInt(_element.getAttribute("_y_value"));
		var m =	parseInt(_element.getAttribute("_m_value"));
		var d = parseInt(_element.getAttribute("_d_value"));
		
		return new Date(y,m,d);
	}
	finally
	{
		_element = y = m = d = null;
	}
}


LEAP.calendar.setValue = function(element, v)
{
	try
	{
		element = LEAP._match(element, LEAP.calendar.d);
		if(null == element) return;
		
		if (v)
		{		
			var _y = v.substring(0,4);
			
			var _s = v.substring(5,7);
			if (_s.substring(0,1) == "0")
				_s = _s.substring(1);
			var _m = parseInt(_s) - 1;
			
			var _d = v.substring(8,10);
			
			LEAP.calendar.refreshcalendar(element, _y, _m, _d);
		}
		else
		{
			var y = element.getAttribute("_y_value");		
			var m = element.getAttribute("_m_value");
			LEAP.calendar.refreshcalendar(element, y, m, null);
		}
	}
	finally
	{
		_y = _s = _m = _d = null;
	}
}

LEAP.calendar.loadcalendar = function(element)
{
	try
	{
		var width = element.style.width;
        var height = element.style.height;
        var wid ="";
        var hei ="";
        
        
        if (width!=null && width!="")
        	wid =parseInt(parseInt(width)/7);
        
        if(width.indexOf("%")>0)
        	wid = wid+"%";
        else
        	wid = wid+"px";
        
        if(height!=null && height!=""&&height.indexOf("%")==0)
            hei = parseInt((parseInt(height)-50)/7);
        else
        	hei = parseInt((parseInt(height)*0.8)/7);
        
        if(height.indexOf("%")>0)
        	hei = hei+"%";
        else
        	hei = hei+"px";
		
        var wcc = element.getAttribute("weekcellcolor");
        var dcc = element.getAttribute("daycellcolor");
        var hc = element.getAttribute("headercolor");        
        var dstr = '<td ctf="daycell" id=xx_d@id@ @style@>0</td>';
        var dsty = 'style="@width@ @height@"';
       	if(wid != "" && hei != "")
       	{
       		dsty = dsty.replace("@width@", "width:" + wid + ";");
       		dsty = dsty.replace("@height@", "height:" + hei + ";");
       	}
       	else
       	{
       		dsty = dsty.replace("@width@", "");
       		dsty = dsty.replace("@height@","");
       	}       	
       	dstr = dstr.replace("@style@", dsty);
       	        
		var s = "";
		s += '<table class="wfcontrol_calendar_tableborder" border=0 cellspacing="1" cellpadding="1" width="100%" style="text-align:center;">';
		if (hc)
			s+=	'<tr align="center" class=wfcontrol_calendar_header style="background-color:' + hc + ';">';
		else			
			s+=	'<tr align="center" class=wfcontrol_calendar_header>';
			
				s+=	'<td colspan=7>';
					s+=	'<DIV id="xx_year" class="select lgiact" style="width:80px !important; float:left;" ct="select" mdtype="select" bt="select">';
						s+=	'<DIV class="lg_p_lr_right select_drop selectdropout" ctf="select_drop"></DIV>';
						s+=	'<DIV class="lg_p_lr_fill input_fill"><DIV class="lg_p_lr_fill_c input_fill_c"><INPUT class="selectbtn ellipsis " type=button ctf="selectbtn"></DIV></DIV>';
						s+=	'<DIV class=select_items style="WIDTH: 100%" ctf="select_items" sizset="0"></DIV>';
					s+=	'</DIV>';
					s+=	'<DIV id="xx_month" class="select lgiact" style="width:70px !important; float:left;" ct="select" mdtype="select" bt="select">';
						s+=	'<DIV class="lg_p_lr_right select_drop selectdropout" ctf="select_drop"></DIV><DIV class="lg_p_lr_fill input_fill"><DIV class="lg_p_lr_fill_c input_fill_c"><INPUT class="selectbtn ellipsis " type=button ctf="selectbtn"></DIV></DIV>';
						s+=	'<DIV class=select_items style="WIDTH: 100%" ctf="select_items" sizset="0"></DIV>';
					s+=	'</DIV>';
					s+=	'<a class="lgbtn" ctf="btnToday" style="float:left;" href="javascript:">今天</a>';
				s+=	'</td>';								
			s+=	'</tr>';
			
			if (wcc)
				s+=	'<tr class="wfcontrol_calendar_category" style="background-color:' + wcc + ';"><td>日</td><td>一</td><td>二</td><td>三</td><td>四</td><td>五</td><td>六</td></tr>';
			else
				s+=	'<tr class="wfcontrol_calendar_category"><td>日</td><td>一</td><td>二</td><td>三</td><td>四</td><td>五</td><td>六</td></tr>';
			
			for(var i = 0;i < 6;i++)
			{	
				if (dcc)
					s += '<tr class="wfcontrol_calendar_cell" style="background-color:' + dcc + ';">';
				else
					s += '<tr class="wfcontrol_calendar_cell">';				
				for(var j = 1;j <= 7;j++)
			    	s += dstr.replace("@id@", (i * 7 + j));
				s += '</tr>';
			}
		s += '</table>';
		
		element.innerHTML = s;
		
		LEAP.addEvent(LEAP.getElement("#xx_year", element), 'valueChange', LEAP.calendar.___change, null, null, false);
		LEAP.addEvent(LEAP.getElement("#xx_month", element), 'valueChange', LEAP.calendar.___change, null, null, false);		
	}
	finally
	{
		width = height = wid = hei = wcc = dcc = hc = bdc = dstr = dsty = s = i = j = null;
	}
}

LEAP.calendar.refreshcalendar = function(_element, _y, _m, _d)
{
	try
	{
		var today;
		if (_d)
			today = new Date(_y, _m, _d);
		else
			today = LEAP.getServerTime();
		
		var x = new Date(_y, _m, 1);
		var mv = x.getDay();
		var d = x.getDate();
		var dd = null;
		var yy = x.getFullYear();
		var mm = x.getMonth();	
		var R = _element.getAttribute("yearRange");	
		if (!R)
			R = 10;
		else
			R = parseInt(R);
			
		var _year = LEAP.getElement("#xx_year", _element);
		if (!_year.getAttribute('__hasinit'))
		{
			LEAP.select.clearItem(_year);
			for(var i=yy-R; i<=yy + R; i++)
				LEAP.select.addItem(_year, i, i + "年");		
			LEAP.select.setValue(_year, yy);
			
			_year.setAttribute('__hasinit', 1);
		}
		
		var _month = LEAP.getElement("#xx_month", _element);
		if (!_month.getAttribute('__hasinit'))
		{
			LEAP.select.clearItem(_month);
			for(var i=0; i<12; i++)
				LEAP.select.addItem(_month, i, (i + 1) + "月");
			LEAP.select.setValue(_month, mm);
			
			_month.setAttribute('__hasinit', 1);
		}
			
		var dcc = _element.getAttribute("daycellcolor");
		if (!dcc)
			dcc = "#C2DEED";
		for(var i = 1;i <= 42;i++)
		{
			dd = LEAP.getElement("#xx_d" + i, _element);
			dd.innerHTML = " ";
			dd.style.backgroundColor = dcc;
			dd.className = "";
			
			dd.removeAttribute("__x_yy");
			dd.removeAttribute("__x_mm");
			dd.removeAttribute("__x_dd");
		}
		while(x.getMonth() == mm)
		{
			dd = LEAP.getElement("#xx_d" + (d + mv), _element);
			dd.innerHTML = d;
			
			if (x.getDay() == 0 || x.getDay() == 6)
			{
				dd.className = 'wfcontrol_calendar_holiday';
				dd.style.backgroundColor = dcc;
			}			
			else
			{
				dd.className = 'wfcontrol_calendar_default';
				dd.style.backgroundColor = dcc;
			}
					
			if (_d && x.getFullYear() == today.getFullYear() && x.getMonth() == today.getMonth() && x.getDate() == today.getDate())
			{
				dd.className = 'wfcontrol_calendar_checked';
				var c =  _element.getAttribute("selectcolor");
				dd.style.backgroundColor =  (c==null) ? "#FFBB00" : c ;
			}
			
			dd.setAttribute("__x_yy", yy);
			dd.setAttribute("__x_mm", mm+1);
			dd.setAttribute("__x_dd", d);			
			
			x.setDate(++d);
		}
		
								
		_element.setAttribute("_y_value", today.getFullYear());		
		_element.setAttribute("_m_value", today.getMonth());
		_element.setAttribute("_d_value", today.getDate());				
	}
	finally
	{
		today = x = mv = d = dd = R = _year = i = _month = i = c = null;
	}
}

LEAP.calendar.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;
	
	LEAP.calendar._i(src);	
}

LEAP.calendar._i = function(src)
{
	try
	{
		var _element = LEAP._match(src, LEAP.calendar.d);
		if (_element == null)
			return;

		LEAP.calendar.__i(_element);
	}
	finally
	{
		_element = null;
	}
}

LEAP.calendar.__i = function(_element)
{
	try
	{	
		LEAP.calendar.loadcalendar(_element);
				
		var x = LEAP.getServerTime();
		LEAP.calendar.refreshcalendar(_element, x.getFullYear(), x.getMonth(), x.getDate());			
		x = null;
	}
	finally
	{
		x = null;
	}
}

LEAP.calendar.init();


LEAP.pasteFormat = {};
LEAP.pasteFormat.d = "pasteFormat";
LEAP.pasteFormat.ctf = {pasteFormat:"pasteFormat"};
LEAP.pasteFormat.init = function()
{
	if (document != null && document.body != null)
	{
		LEAP.pasteFormat._init();
	} 
	else
	{
		UIEventManager.addEvent(window, "load", LEAP.pasteFormat._init);
	}
}
LEAP.pasteFormat._init = function()
{
	LEAP.addEvent(document.body, "paste", LEAP.pasteFormat.format, null, null, true);

	UIEventManager.removeEvent(window, "load", LEAP.pasteFormat._init);
}

LEAP.pasteFormat.format = function(arg)
{
	var src = arg.e.srcElement;
	if ("1" != src.getAttribute(LEAP.pasteFormat.ctf.pasteFormat))
		return;
		
	var event = arg.e;
		
	if (true == LEAPBrowser.isIE)
	{
		var str = window.clipboardData.getData("text");
		if (str)
		{
			var fstr = LEAP.pasteFormat._format(str);
			window.clipboardData.setData("text", fstr);
		}
		
	}
	else if (true == LEAPBrowser.isChrome)
	{
		if (event.clipboardData.items && event.clipboardData.items.length > 0)
		{
			for(var i=0; i<event.clipboardData.items.length; i++)
			{
				event.clipboardData.items[i].getAsString(function gett(str)
				{
					LEAP.asyn(LEAP.pasteFormat._formatAfter, this, 10, src, str);					
				})		
			}
		}	
	}
}

LEAP.pasteFormat._format = function(str)
{
	return str.replace(/(^\s*)|(\s*$)/g, "").replaceall(" ", "").replaceall("\r\n", "").replaceall("\n", "").replaceall("\r", "");		
}

LEAP.pasteFormat._formatAfter = function(src, str)
{
	var fstr = LEAP.pasteFormat._format(str);
	if (src.value)
	{
		var oldValue = src.value.replaceall("\n", "\r\n");
		var newValue = oldValue.replace(str, fstr); 
		src.value = newValue;
	}
}


LEAP.pasteFormat.init();



LEAP.DocumentView = {};
LEAP.DocumentView.d = 'DocumentView';
LEAP.DocumentView.n = 'docdata'; //{isnew:true, doctype:doctype, url:url, _LoadedDoctype: _LoadedDoctype, attachment:attachment};
LEAP.DocumentView.doctype = {word:-9,wps:-8,pdf:-6,ceb:-4,scan:-3,ofd:-2};


LEAP.DocumentView._tb_ie8 = "<DIV onresize=LEAPLG.tb(); class=lg_p2_tb>" +
							"<DIV ar='top' onresize=LEAPLG.tb_layout(0); class='lg_p2_tb_top wf_documentView_toolbar' style='HEIGHT: 40px'></DIV>" +
							"<DIV ar='bottom' class=lg_p2_tb_bottom style='top:40px;'></DIV>" +
							"<IMG onerror=LEAPLG.tb_img(10); style='DISPLAY: none' src='data:image:png,base64'>" +
						"</DIV>";
LEAP.DocumentView._tb = "<div class='divlayoutcon' style='width: 100%; height: 100%;'>	" +
							"<div class='lc_layout_p_con'>" +
								"<div ar='top' class='lc_layout_bt wf_documentView_toolbar' style='height: 30px;'></div>" +
								"<div ar='bottom' class=' lc_layout_bt_p sel' style='top: 30px;overflow-y:hidden;'></div>" +
							"</div>" +
						"</div>";		
LEAP.DocumentView._word = "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='submit'>保存</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='saveAs'>另存为</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='updatename'>修改文件名</A>"+
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='print'>打印</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='showMark'>显示痕迹</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='hideMark'>隐藏痕迹</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='importDoc'>导入文件</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='doHandSign'>加入手写签批</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='doHandSecSign'>加入手写签名</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='taohong'>正文套红</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='addServerSign'>添加服务器签章</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='addServer2Sign2'>添加服务器签章</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='safeDoc'>锁定文件</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='deleteSafe'>取消锁定</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='ConvertPDF'>转为PDF格式</A>"+	
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='ConvertOFD'>转为OFD格式</A>"+	
						"<A class='wf_documentView_toolbar_btn' style='float:right;margin-right:10px; margin-left:0px; display:none;' href='javascript:' ht='button' at=1  al='close'>关闭</A>"+
						"<A class='wf_documentView_toolbar_btn' style='float:right;margin-right:10px; margin-left:0px;' href='javascript:' ht='button' at=1  al='fullscreen'>全屏</A>";

LEAP.DocumentView._word_ie8 = LEAP.DocumentView._word.replaceall("wf_documentView_toolbar_btn", "wf_documentView_toolbar_btn_ie8");

LEAP.DocumentView._wordObj = "<object id='officebody_{{$ID$}}' ctf='officeobj' style='margin-top:-46px;' value='CC0044409F3B1A8EF33AF22CB77E683B1A4F24E2' classid='clsid:A39F1330-3322-4a1d-9BF0-0BA2BB90E970'" +
		" codebase=" + leapconfig.server + "LEAP/LWFP/HTML/activex/OfficeControl.cab#version=5,0,2,4' width='100%' height='100%'>" +
				"<param name='IsUseUTF8URL' value='0'>" +
				"<param name='IsUseUTF8Data' value='0'>" +
				"<param name='MakerCaption' value='永兴元科技www.longrise.com.cn'>" +
				"<param name='MakerKey' value='00ABC2E2E500DDDA42F9FECA12C4C532850BFC32'>" +
				"<param name='ProductCaption' value='深圳市永兴元科技有限公司'>" +
				"<param name='ProductKey' value='46E17CE7896947AC8014C6BB98B980EAD36708F2'>" +
				"<SPAN STYLE='color:blue'>不能装载文档控件。请在浏览器选项中检查浏览器的安全设置。</SPAN>" +
				//"<SPAN STYLE='color:red;cursor:hand;font-size:16px; font-family:宋体' onclick='WordHelp();'>点我解决问题?</SPAN>" +
				"</object>";
var jgcopyright="金格科技iWebOffice2015智能文档中间件[演示版];V5.0S0xGAAEAAAAAAAAAEAAAAJkBAACgAQAALAAAAIyr4RJpeqLXTdr2x0s0ePu2SX7NWzW1ApokhflA7fBJf1rXwQ+QEhtUQ48LgKqeUp21xr4ORm+KqTEyh9QzxH4J3c3mY0+mSkPgLyVWqpbqd4MaakftOUoyABGnduKHIHlTY9f3DcOw6XpBDBySJh3xJ5meCQHvtXKWCEeifBaFqWhnscSrWFAaaNOAS2vBkC3siqB6xBDF69BUg4GeokvAwlPQ2WSnG3ou26L7O0kD0iZcvB0XLwN8X1XNXKRiPHlKqXPRyIMeb6La94qS97S3hPfEnazdkRRmBsKIumAyjd2Ovd103LCJZA8X52H7MMq/vj66v39yZ64MVl6rNqYCa2C8gBpqiL57djqBkOMYtJQof8NcioXWeSqxmdVCAZHSUO40NHyPbgJd1XBczAX5XUbsTA4UKkLXBXXsd5VbDjuplz/jUtDw3IUpFWwiNjXU7ipOBDYgivFazDrZmsUso+0jGGX9iTuw8yRwiYG126KsGyTKqklf/ocoCUaR8K9ytB/MKhVvGdCbqbB5ZB7TgmSzs/aAyE120e8FYrsCcxifcanWP82vljWwGKyw2Q==";

LEAP.DocumentView._webOfficeObj32 = "<object id='officebody_{{$ID$}}' ctf='officeobj' classid='clsid:D89F482C-5045-4DB5-8C53-D2C9EE71D025'" +
									"  width='100%' height='100%'>" +
									"<param name='Copyright' value='{{$jgcopyright$}}'></object>";


LEAP.DocumentView._pdf = "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=0 al='pdf_create'>保存</A>" +				
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=0 al='pdf_saveAs'>另存为</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=0 al='pdf_print'>打印</A>" +
						"<A class='wf_documentView_toolbar_btn' style='float:right;margin-right:10px; margin-left:0px; display:none;' href='javascript:' ht='button' at=0  al='pdf_close'>关闭</A>";
						
//LEAP.DocumentView._pdfObj =	"<OBJECT id='"	+  "pdfbody_" + UUID.cID() + "' ctf=pdfobj width='100%' height='100%' style='margin-top:-31px;' classid='clsid:39E08D82-C8AC-4934-BE07-F6E816FD47A1' codebase='" + leapconfig.server + "LEAP/LWFP/HTML/activex/iWebPDF.cab' VIEWASTEXT></object>";
LEAP.DocumentView._pdfObj =	"<OBJECT id='"	+  "pdfbody_" + UUID.cID() + "' ctf=pdfobj width='100%' height='100%' style='margin-top:-31px;' classid='clsid:39E08D82-C8AC-4934-BE07-F6E816FD47A1' VIEWASTEXT></object>";
//LEAP.DocumentView._pdfObj2018 =	"<OBJECT id='"	+  "pdfbody_" + UUID.cID() + "' ctf=pdfobj width='100%' height='100%' classid='clsid:7017318C-BC50-4DAF-9E4A-10AC8364C315' codebase='" + leapconfig.server + "LEAP/LWFP/HTML/activex/iWebPDF2018.cab#version=2,0,5,1138' VIEWASTEXT></object>";
LEAP.DocumentView._pdfObj2018_IE_win32 =	"<OBJECT id='"	+  "pdfbody_" + UUID.cID() + "' ctf='pdfobj' width='100%' height='100%' classid='CLSID:7017318C-BC50-4DAF-9E4A-10AC8364C315' VIEWASTEXT></object>";
LEAP.DocumentView._pdfObj2018_IE_win64 =	"<OBJECT id='"	+  "pdfbody_" + UUID.cID() + "' ctf='pdfobj' width='100%' height='100%' classid='CLSID:7017318C-BC50-4DAF-9E4A-10AC8364C364' VIEWASTEXT></object>";
LEAP.DocumentView._pdfObj2018_chrome =	"<object id='"	+  "pdfbody_" + UUID.cID() + "' ctf='pdfobj' width='100%' height='100%' clsid='CLSID:7017318C-BC50-4DAF-9E4A-10AC8364C315' type='application/kg-plugin' OnAddinEventInvoke='OnAddinEventInvoke' OnCommand='OnCommand' OnOLECommand='OnOLECommand' copyright='@@copyright@@'></object>";
LEAP.DocumentView.IWebPdf2018_Copyright = "中国保险行业公文信息组[专用];V5.0S0xGAAEAAAAAAAAAEAAAAEsBAABQAQAALAAAANKNauIXKwc8yt69eRAaXpgjmZTomIrUQEU/IKWG8kkryERAtAWY8854QNCtSktfH50SVleI0zfPzyFjlkTHBVbpn6A1tWoO1W0bev1KOYvAullr++hVfEtfm006EzdWI9W9BBZOomG0/xGnSnhKBkMBL5dOCxkcFv/b0Z2hOJQlEOdxuvb7+6C2iiUkR1MYUZfpt3HODIP5V6KfIQYVTDW+hjbySuYWfFBl9kA+htpziaUIgetydLivIO9VS2XQEOcmRDIcXCcA336Gkw29a/Xj9cEqBvhrMtzsw5UoEcPL7lIKpPGhGoTMht3YUXJ0QcH3dYXEiTku1JFhBSAuCRhLSJeZ8Kh43PfNE2sH4UPGYsvwwSQY/XJvutQT19KSxM0irmJ5uwmtU3julPj0r7OKxTaq4ELceMtKKM2t4BdvbfgcYEBgnU3jHocil312nLlTYZ3xTL8fOIdhcEWkIuk=";
LEAP.DocumentView._scannerObj = "<OBJECT ctf=scannerobj id='scanner_" + UUID.cID() + "' classid='clsid:79ECAAA5-BF96-4E6E-9D51-93A9A841F7B6' codebase='" + leapconfig.server +  "LEAP/LWFP/HTML/activex/LDSM.ocx#version=1,1,3,40' style='width:100%;height:100%'  sc='resource' resource.att='CODEBASE'></OBJECT>";
LEAP.DocumentView._cebObj = "<OBJECT ctf=cebObj id='ceb_" + UUID.cID() + "' classid='clsid:898BAE86-7986-4177-B17F-B9D23C53649C' style='width:100%;height:100%'></OBJECT>";

LEAP.DocumentView._wpsObj_linux = "<object ctf='officeobj' id='officebody_{{$ID$}}' type='application/x-wps'  data='" + leapconfig.server + "LEAP/LWFP/HTML/DocumentViewer/Normal.dotm'  width='100%'  height='100%' style='z-index:20000; position:relative;'> <param name='Enabled' value='1'/></object>";
LEAP.DocumentView._wpsObj_win = "<object ctf='officeobj' id='officebody_{{$ID$}}' classid=clsid:8E7DA7EC-07EC-4343-8141-88A2ADB63A5F viewastext=VIEWASTEXT width='100%' height='100%' data=data:application/x-oleobject;base64,7Kd9juwHQ0OBQYiirbY6XwEABAA7DwMAAgAEAB0AAAADAAQAgICAAAQABAD///8ABQBcAFgAAABLAGkAbgBnAHMAbwBmAHQAIABBAGMAdABpAHYAZQBYACAARABvAGMAdQBtAGUAbgB0ACAARgByAGEAbQBlACAAQwBvAG4AdAByAG8AbAAgADEALgAwAAAA></object> ";
LEAP.DocumentView._ofdObject = "<object id='"	+  "ofdbody_{{$ID$}}' ctf=ofdobj CLASSID='CLSID:C7F277DC-6C47-AB2C-FB6A-070DC8BE7533' width= '100%' height='100%'/>";

LEAP.DocumentView._ofdObject = "<div id='"	+  "ofdbody_{{$ID$}}' ctf=ofdobj style='width:100%;height:100%;'></div>";
LEAP.DocumentView._ofd = "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=2 al='ofd_create'>保存</A>" +				
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=2 al='ofd_saveAs'>另存为</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=2 al='ofd_print'>打印</A>";
LEAP.DocumentView.DocumentEditor = {}; // "wps"

LEAP.DocumentView.init = function()
{
	if (document != null && document.body != null)
		LEAP.DocumentView._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.DocumentView._init);
		
	ElementEventManager.addManagedEventType(LEAP.DocumentView.d, 'onDocumentLoad');
}
LEAP.DocumentView._init = function()
{
	LEAP.addEvent(document.body, 'click', LEAP.DocumentView.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.DocumentView._init);
}

LEAP.DocumentView.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		var at = src.getAttribute('at');
		var al = src.getAttribute('al');
		if (at == null || al == null)
			return;

		var element = LEAP._match(src, LEAP.DocumentView.d);
		if(null == element) return;

		if (at == 1)
		{
			if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
			{
				LEAP.DocumentView.IWebOffice.buttonClick(element, al);
			}
			else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wps") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wps"))
			{
				LEAP.DocumentView.WpsEditor.buttonClick(element, al);
			}
			else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoEditor") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoEditor"))
			{ //ningx
				LEAP.DocumentView.YozoEditor.buttonClick(element, al);
			}
			else
			{
				LEAP.DocumentView.WordEditor.buttonClick(element, al);
			}			
		}
		else if (at == 0)
		{
			LEAP.DocumentView.PdfEditor.buttonClick(element, al);
		}
		else if (at == 2)
		{
			LEAP.DocumentView.OFDEditor.buttonClick(element, al);
		}

	}
	finally
	{
		src = at = al = element = null;
	}
}

LEAP.DocumentView.setParams = function(element, wordButton, templateValues, businessNo, isCurrentstep, attType, curstep, templateValueFn, exParam, exParam2, pdfButton)
{	
	try
	{
		if (element == null)
			return null;
			
		if (!element[LEAP.DocumentView.n])
			element[LEAP.DocumentView.n] = {};		
		if (!element[LEAP.DocumentView.n].param)		
			element[LEAP.DocumentView.n].param = {};
		
		if (wordButton != null)
			element[LEAP.DocumentView.n].param.wordButton = wordButton;
		if (pdfButton != null)
			element[LEAP.DocumentView.n].param.pdfButton = pdfButton;
		if (templateValues != null)
			element[LEAP.DocumentView.n].param.templateValues = templateValues;		
		if (isCurrentstep)
			element[LEAP.DocumentView.n].param.isCurrentstep = isCurrentstep;		
		if (businessNo)
			element[LEAP.DocumentView.n].param.businessNo = businessNo;		
		if (curstep)
			element[LEAP.DocumentView.n].param.currentstep = curstep;
		if (templateValueFn)
			element[LEAP.DocumentView.n].param.templateValueFn = templateValueFn;
		if (exParam)
			element[LEAP.DocumentView.n].param.exParam = exParam;
		if (exParam2)
			element[LEAP.DocumentView.n].param.exParam2 = exParam2;
	}
	finally
	{
		
	}
}

LEAP.DocumentView.setParameters = function(element, params)
{	
	try
	{
		if (element == null)
			return null;
			
		if (!element[LEAP.DocumentView.n])
			element[LEAP.DocumentView.n] = {};		
		if (!element[LEAP.DocumentView.n].param)		
			element[LEAP.DocumentView.n].param = {};
		
		if (params.wordButton != null)
			element[LEAP.DocumentView.n].param.wordButton = params.wordButton;
		if (params.templateValues != null)
			element[LEAP.DocumentView.n].param.templateValues = params.templateValues;		
		if (params.isCurrentstep)
			element[LEAP.DocumentView.n].param.isCurrentstep = params.isCurrentstep;		
		if (params.businessNo)
			element[LEAP.DocumentView.n].param.businessNo = params.businessNo;		
		if (params.curstep)
			element[LEAP.DocumentView.n].param.currentstep = params.curstep;
		if (params.templateValueFn)
			element[LEAP.DocumentView.n].param.templateValueFn = params.templateValueFn;
		if (params.exParam)
			element[LEAP.DocumentView.n].param.exParam = params.exParam;
	}
	finally
	{
		
	}
}

LEAP.DocumentView.innerSaveDocument = function(e,forceSaveZW)
{
	try
	{
		var data = e[LEAP.DocumentView.n];
		
		if (data.doctype == LEAP.DocumentView.doctype.word || data.doctype == LEAP.DocumentView.doctype.wps)
		{
			var btn = LEAP.getElement("a[at=1][al=submit]", e);
			if (btn && (btn.style.display=='block' || btn.style.display==''))
			{
				if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
					return LEAP.DocumentView.IWebOffice.save(e, false);
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wps") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wps"))
					return LEAP.DocumentView.WpsEditor.save(e, false);
				else					
					return	LEAP.DocumentView.WordEditor.save(e, false);
			}
			else
			{
				return true;
			}
		}
		else if (data.doctype == LEAP.DocumentView.doctype.pdf)
		{
			var btn = LEAP.getElement("a[at=0][al=pdf_create]", e);
			var obj = LEAP.getElement('[ctf=pdfobj]', e);
			var modified = false;
			if (obj && obj.isOpen == 1)
			{
				//obj.DocumentModified属性无法区分是否为通过工具栏按钮打开本地PDF，如果打开本地PDF则需要保存
				if(obj['___openlocalpdf'] == true)
					modified = true;
				if(obj.DocumentModified!=null && obj.DocumentModified!=0)
					modified = true;					
			}
			obj = null;
			if ((btn && ((btn.style.display=='block' || btn.style.display=='') && modified == true)) || forceSaveZW==true)
				return LEAP.DocumentView.PdfEditor.save(e, false);
			else
				return true;
		}
		else if (data.doctype == LEAP.DocumentView.doctype.ceb)
		{
			return true;
		}
		else if (data.doctype == LEAP.DocumentView.doctype.scan)
		{
			if (data.attachment && data.attachment.canEdit == false)
				return true;
			
			return LEAP.DocumentView.Scanner.save(e);
		}
		else if (data.doctype == LEAP.DocumentView.doctype.ofd)
		{
			return LEAP.DocumentView.OFDEditor.save(e, false);
		}
		
		return false;
	}
	finally
	{
		data = btn = null;
	}
}

/*LEAP.DocumentView.display = function(e)
{
	try
	{
		var obj = LEAP.getElement("[ctf=officeobj]", e);
		if (obj != null && LEAP.DocumentView.DocumentEditor == "wps" && LEAPBrowser.isIE == false)
		{
			//LEAP.DocumentView.WpsEditor.resizeObject(e);
			LEAP.DocumentView.loadDocument(e, true, null, null);
		}
	}
	finally
	{}
}*/

LEAP.DocumentView.loadDocument = function(e, force, defaultName, tabcode)
{
	try
	{
		if (defaultName)
			e.setAttribute('defaultName', defaultName);
		if (tabcode)
			e.setAttribute('tabcode', tabcode);
			
		if (force == null)
			force = e["force"];
		
		var data = e[LEAP.DocumentView.n];
		if (!data.hasInit || force == true)
		{
			var _doctype = data.doctype;			
			var _url = (data && data.attachment)? LEAP.DocumentView._getPath(data.attachment, e) : null;
			//预览的时候添加水印
			if(_url && data && data.attachment && data.attachment.canEdit == false){
				_url = _url + "&watermark=1";
			}
			if(_url && _url.indexOf("&sid")==-1){
				_url = _url +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
			}			
						
			if (_doctype == LEAP.DocumentView.doctype.word)
			{
				if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
				{
					_url = (_url==null)? LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/activex/blank.doc" : _url;
					LEAP.asyn(LEAP.DocumentView.IWebOffice.loadDocument, this, 500, e, _url);
				}
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoWeb") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoWeb"))
				{						
					LEAP.asyn(LEAP.DocumentView.YozoWeb.loadDocument, this, 500, e);
				}
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoEditor") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoEditor"))
				{	
					_url = (_url==null)? LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/activex/blank.doc" : _url;
					LEAP.asyn(LEAP.DocumentView.YozoEditor.loadDocument, this, 500, e, _url, "Word");
				}
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wps") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wps"))
				{
					_url = (_url==null)? LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/activex/blank.wps" : _url;		
					LEAP.asyn(LEAP.DocumentView.WpsEditor.loadDocument, this, 100, e, _url);				
				}
				else
				{
					_url = (_url==null)? LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/activex/blank.doc" : _url;						
					//LEAP.asyn(LEAP.DocumentView.WordEditor.loadDocument, this, 500, e, _url, "Word.Document");
					
					var name = ".doc";
					if (data && data.attachment && data.attachment.name)
						name = data.attachment.name.toLowerCase();
					var t = LEAP.DocumentView._getRHFileType(name);
					LEAP.asyn(LEAP.DocumentView.WordEditor.loadDocument, this, 500, e, _url, t);
				}
			}
			else if (_doctype == LEAP.DocumentView.doctype.wps)
			{
				if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
				{
					_url = (_url==null)? LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/activex/blank.doc" : _url;
					LEAP.asyn(LEAP.DocumentView.IWebOffice.loadDocument, this, 500, e, _url);
				}
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wps") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wps"))
				{
					_url = (_url==null)? LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/activex/blank.wps" : _url;		
					LEAP.asyn(LEAP.DocumentView.WpsEditor.loadDocument, this, 100, e, _url);
				}
				else
				{
					_url = (_url==null)? LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/activex/blank.doc" : _url;				
					
					var name = ".doc";
					if (data && data.attachment && data.attachment.name)
						name = data.attachment.name.toLowerCase();
					var t = LEAP.DocumentView._getRHFileType(name );
					LEAP.DocumentView.WordEditor.loadDocument(e, _url, t);
				}
			}
			else if (_doctype == LEAP.DocumentView.doctype.pdf)
			{		
				if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "JSPDF") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "JSPDF"))
				{
					LEAP.asyn(LEAP.DocumentView.JSPDF.loadDocument, this, 150, e, _url);
				}
				/*else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "browserPlugin") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "browserPlugin"))
				{
					//直接打开
					if(_url.indexOf("?") != -1){
						window.open(_url +"&open=1","_self");
					}else{
						window.open(_url +"?open=1","_self");
					}
					
					
				}*/
				else
				{
					//LEAP.DocumentView.PdfEditor.loadDocument(e, _url);			
					LEAP.asyn(LEAP.DocumentView.PdfEditor.resizeObject, this, 100, e);
					LEAP.asyn(LEAP.DocumentView.PdfEditor.loadDocument, this, 150, e, _url);	
				}
			}
			else if (_doctype == LEAP.DocumentView.doctype.ceb)
			{
				LEAP.DocumentView.CebViewer.loadDocument(e, _url, 1);
			}			
			else if (_doctype == LEAP.DocumentView.doctype.scan)
			{
				LEAP.DocumentView.Scanner.loadDocument(e)
			}
			else
			{
				var name = data.attachment.name.toLowerCase();
				if (name.endWith('.xls') || name.endWith('.xlsx') || name.endWith('.et'))
				{	
					if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
					{
						LEAP.asyn(LEAP.DocumentView.IWebOffice.loadDocument, this, 500, e, _url);
					}
					else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoWeb") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoWeb"))
					{//TODO 测试excle
						LEAP.asyn(LEAP.DocumentView.YozoWeb.loadDocument, this, 500, e);
					}
					else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoEditor") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoEditor"))
					{//TODO 测试excel
						LEAP.asyn(LEAP.DocumentView.YozoEditor.loadDocument, this, 500, e, _url, 'excel');
					}
					else
					{
						LEAP.asyn(LEAP.DocumentView.WordEditor.loadDocument, this, 500, e, _url, "Excel.Sheet");
					}
				}
				else if (name.endWith('.ppt') || name.endWith('.pptx'))
				{ 
					if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
					{
						LEAP.asyn(LEAP.DocumentView.IWebOffice.loadDocument, this, 500, e, _url);
					}
					else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoWeb") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoWeb"))
					{//TODO 测试ppt
						LEAP.asyn(LEAP.DocumentView.YozoWeb.loadDocument, this, 500, e);
					}
					else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoEditor") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoEditor"))
					{//TODO 测试ppt
						LEAP.asyn(LEAP.DocumentView.YozoEditor.loadDocument, this, 500, e, _url, 'ppt');
					}
					else
					{
     					LEAP.asyn(LEAP.DocumentView.WordEditor.loadDocument, this, 500, e, _url, "PowerPoint.Show");
					}
				}
				else if (name.endWith('.doc') || name.endWith('.docx') || name.endWith('.wps') )
				{
					if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
					{
						LEAP.asyn(LEAP.DocumentView.IWebOffice.loadDocument, this, 500, e, _url);
					}
					else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoWeb") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoWeb"))
					{//TODO 测试ppt
						LEAP.asyn(LEAP.DocumentView.YozoWeb.loadDocument, this, 500, e);
					}
					else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoEditor") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoEditor"))
					{
						LEAP.asyn(LEAP.DocumentView.YozoEditor.loadDocument, this, 500, e, _url, 'word');
					}
					else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wps") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wps"))
					{
						LEAP.asyn(LEAP.DocumentView.WpsEditor.loadDocument, this, 500, e, _url);
					}
					else
					{				
						LEAP.asyn(LEAP.DocumentView.WordEditor.loadDocument, this, 500, e, _url, "Word.Document");
					}
				}
				else if (name.endWith('.pdf'))
				{
					if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "JSPDF") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "JSPDF"))
					{
						LEAP.asyn(LEAP.DocumentView.JSPDF.loadDocument, this, 150, e, _url);
					}
					/*else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "browserPlugin") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "browserPlugin"))
					{
						//直接打开
						if(_url.indexOf("?") != -1){
							window.open(_url +"&open=1","_self");
						}else{
							window.open(_url +"?open=1","_self");
						}
						
						
					}*/
					else
					{
						//LEAP.DocumentView.PdfEditor.loadDocument(e, _url);				
						LEAP.asyn(LEAP.DocumentView.PdfEditor.resizeObject, this, 400, e);
						LEAP.asyn(LEAP.DocumentView.PdfEditor.loadDocument, this, 500, e, _url);
					}
				}
				else if (name.endWith('.ofd'))
				{
					LEAP.asyn(LEAP.DocumentView.OFDEditor.loadDocument, this, 100, e, _url);
				}
			}
			
			e.removeAttribute("force");
			e[LEAP.DocumentView.n].hasInit = true;
		}
		else
		{
			if (data.doctype == LEAP.DocumentView.doctype.wps)
			{
				if (LEAPBrowser.isIE == false)
				{
					LEAP.DocumentView.loadDocument(e, true, null, null);
				}			
			}
			else if (data.doctype == LEAP.DocumentView.doctype.ofd)
			{
				if (LEAPBrowser.isIE == false)
				{
					LEAP.DocumentView.loadDocument(e, true, null, null);
				}
			}
			
			//LEAP.DocumentView.display(e);
		}
		
	}
	finally
	{
		_url = name = null;
	}
}

LEAP.DocumentView._getRHFileType = function(name)
{
	if (name.endWith('.xls') || name.endWith('.xlsx'))
		return "Excel.Sheet";
	else if (name.endWith('.ppt') || name.endWith('.pptx'))
		return "PowerPoint.Show";
	else if (name.endWith('.doc') || name.endWith('.docx') || name.endWith('.wps') )
		return "Word.Document";	
}

LEAP.DocumentView.printDoc = function(e)
{
	if (!e)
		return;

	var data = e[LEAP.DocumentView.n];
	
	try
	{
		if (data && data.hasInit)
		{
			if(data.attachment)
			{
				//记录打印日志
				var t = data.attachment.title; 
				if (t.length > 50)
					t = t.substring(0, 50) + "...";
				t = t + data.attachment.name.substring(data.attachment.name.lastIndexOf("."));
				
				var module = LWFP.innerApi.getmodule(e);
				
				module.request2({name:'WfLog', par:{terminal:0,entryid:data.attachment.entryid,type:25,remark:t,dataid:data.attachment.id,phone:""}});
			}
				
			var _doctype = data.doctype;
						
			if (_doctype == LEAP.DocumentView.doctype.word)
			{
				LEAP.DocumentView.WordEditor.printDoc(e);
			}
			else if (_doctype == LEAP.DocumentView.doctype.wps)
			{
				LEAP.DocumentView.WordEditor.printDoc(e);
			}
			else if (_doctype == LEAP.DocumentView.doctype.pdf)
			{
				LEAP.DocumentView.PdfEditor.printDoc(e);
			}
			else if (_doctype == LEAP.DocumentView.doctype.ceb)
			{
				LEAP.DocumentView.CebViewer.printDoc(e);
			}			
			else if (_doctype == LEAP.DocumentView.doctype.scan)
			{
				LEAP.DocumentView.Scanner.printDoc(e);
			}
		}
	}
	finally
	{
		data = null;
	}
}

LEAP.DocumentView._getPath = function(_att, element, noremark)
{
	if (_att == null)
		return null;
	
	var url = null;
	if (_att.draftTemplateUrl)
	{
		url = _att.draftTemplateUrl;
	}
	else
	{
		var module = LWFP.innerApi.getmodule(element);
		url = LEAP.upload.getPath(_att.namedpath, _att.name, _att.uuid, null, null, null, null, _att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
		if (url.indexOf('?') == -1)	
			url += "?lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
		else
			url += "&lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
		
		if (_att.entryid != null && _att.id != null)
		{
			//var sid = (window.createRouterClient != null) ? "LSID=":"JSESSIONID=";
			//sid = "&" + sid + leapclient.getsid();
			var p = "entryid=" + _att.entryid + "&wflog=1&terminal=0&id=" + _att.id;
			if (_att.title != null && _att.name != null)
			{
				var t = _att.title; 
				if (t.length > 20)
					t = t.substring(0, 20) + "...";
				if (noremark == true)
				{}
				else
				{
					p += "&remark=" + encodeURIComponent(encodeURIComponent(t + _att.name.substring(_att.name.lastIndexOf("."))));
					//p += "&remark=" + encodeURIComponent(encodeURIComponent(t ));
				}
			}
			
			if (url.indexOf('?') == -1)	
				url += "?" + p;
			else
				url += "&" + p;
		}
	}
			
	return url;			
}

LEAP.DocumentView.__getmodule = function(element)
{
	if (element == null)
		return null;
		
	if (typeof(element) == "string")
	{
		return PageObjectModel.getModule(element);
	}
	else if (element.getAttribute("instance") != null)
	{
		return PageObjectModel.getModule(element.getAttribute("instance"));			
	}
	
	return null;	
}

LEAP.DocumentView.__pageClosing = function(element)
{
	try
	{
		var data = element[LEAP.DocumentView.n];
		if (data != null)
		{	
			var name = data.attachment.name.toLowerCase();
			
			if ( (LEAP.DocumentView.DocumentEditor_win != "wps" && LEAP.DocumentView.DocumentEditor_win != "wps")
				&& (name.endWith('.xls') || name.endWith('.xlsx') 
					|| name.endWith('.ppt') || name.endWith('.pptx') 
					|| name.endWith('.doc') || name.endWith('.docx') || name.endWith('.wps')) )
			{
				if (LEAP.DocumentView.DocumentEditor_win == "IWebOffice")
				{
					return LEAP.DocumentView.IWebOffice.__pageClose(element); 
				}
				else
				{//处理软航插件保存提示
					return LEAP.DocumentView.WordEditor.__pageClose(element); 
				}
			}
		}
		
		return true;
	}
	catch(err)
	{
	}
}

LEAP.DocumentView.valueChange = function(element, newValue, doctype)
{	
	try
	{
		var data = element[LEAP.DocumentView.n];
		var oldValue;
		if (data)		
			oldValue = data.attachment;
		
		if (newValue == null)
		{	
			if (oldValue && oldValue.id)	//无新值有老值则要删除老值
			{
				element[LEAP.DocumentView.n].deleted = oldValue;
				element[LEAP.DocumentView.n].deleted.updateType = 2;
			}
		}
		else
		{
			if (newValue.id) //新值有ID说明是更新的，无需操作
			{			
			}
			else
			{
				if (oldValue && oldValue.id) //
				{
					element[LEAP.DocumentView.n].deleted = oldValue;
					element[LEAP.DocumentView.n].deleted.updateType = 2;
				}
			}
		}
		
		element["force"] = true;
		LEAP.DocumentView.setValue(element, newValue, doctype);	
	}
	finally
	{
		data = oldValue = null;
	}
}

LEAP.DocumentView.getChange = function(element)
{
	try
	{
		if (!element || !element[LEAP.DocumentView.n])
			return null;
			
		var data = element[LEAP.DocumentView.n];
		var c = {};
		if (data.attachment != null && data.attachment.updateType != null)
			c.newValue = data.attachment;
		if (data.deleted)
			c.deleted = data.deleted;
		
		return c;
	}
	finally
	{
		data = c = null;
	}
}

LEAP.DocumentView.setValue = function(element, value, doctype, isTemplate)
{
	try
	{
		if (element == null)
			return null;
			
		element[LEAP.DocumentView.n].attachment = value;
		if (value == null)
		{
			element[LEAP.DocumentView.n].doctype = doctype;
			element[LEAP.DocumentView.n].isnew = true;
		}
		else
		{
			doctype = value.atttype;
			element[LEAP.DocumentView.n].doctype = value.atttype;
			if (isTemplate == true || value.draftTemplateUrl != null)
				element[LEAP.DocumentView.n].isnew = true;
			else
				element[LEAP.DocumentView.n].isnew = false;
		}
		
		LEAP.DocumentView._i(element, doctype)
	}
	finally
	{
	}
}

LEAP.DocumentView.getValue = function(element)
{
	if (element[LEAP.DocumentView.n])
		return element[LEAP.DocumentView.n].attachment;
	
	return null; 
}


LEAP.DocumentView._detectBrowser = function()
{
	var userAgent = navigator.userAgent, 
					rMsie = /(msie\s|trident.*rv:)([\w.]+)/, 
					rFirefox = /(firefox)\/([\w.]+)/, 
					rOpera = /(opera).+version\/([\w.]+)/, 
					rChrome = /(chrome)\/([\w.]+)/, 
					rSafari = /version\/([\w.]+).*(safari)/;
					
	var ua = userAgent.toLowerCase();
	
	var match = rMsie.exec(ua);
	if (match != null) {
		return { browser : "IE", version : match[2] || "0" };
	}
	var match = rFirefox.exec(ua);
	if (match != null) {
		return { browser : match[1] || "", version : match[2] || "0" };
	}
	var match = rOpera.exec(ua);
	if (match != null) {
		return { browser : match[1] || "", version : match[2] || "0" };
	}
	var match = rChrome.exec(ua);
	if (match != null) {
		return { browser : match[1] || "", version : match[2] || "0" };
	}
	var match = rSafari.exec(ua);
	if (match != null) {
		return { browser : match[2] || "", version : match[1] || "0" };
	}
	if (match != null) {
		return { browser : "", version : "0" };
	}

	return browserMatch;
}



//获取当前操作系统是Windows还是Linux
LEAP.DocumentView._detectOS = function() 
{
	var sUserAgent = navigator.userAgent;
	
	var isWin = (navigator.platform == "Win64") || (navigator.platform == "Win32") || (navigator.platform == "Windows");
	var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");
	
	if (isMac) 
		return "Mac";
	
	var isUnix = (navigator.platform == "X11") && !isWin && !isMac;
	
	if (isUnix) 
		return "Unix";
	
	var isLinux = (String(navigator.platform).indexOf("Linux") > -1);
	
	if (isLinux) 
		return "Linux";
	
	if (isWin) 
	{
		
		return "isWin";
		
		var isWin2K = sUserAgent.indexOf("Windows NT 5.0") > -1 || sUserAgent.indexOf("Windows 2000") > -1;
		if (isWin2K) 
			return "Win2000";
		
		var isWinXP = sUserAgent.indexOf("Windows NT 5.1") > -1 || sUserAgent.indexOf("Windows XP") > -1;
		if (isWinXP) 
			return "WinXP";
		
		var isWin2003 = sUserAgent.indexOf("Windows NT 5.2") > -1 || sUserAgent.indexOf("Windows 2003") > -1;
		if (isWin2003) 
			return "Win2003";
		
		var isWinVista= sUserAgent.indexOf("Windows NT 6.0") > -1 || sUserAgent.indexOf("Windows Vista") > -1;
		if (isWinVista) 
			return "WinVista";
		
		var isWin7 = sUserAgent.indexOf("Windows NT 6.1") > -1 || sUserAgent.indexOf("Windows 7") > -1;
		if (isWin7) 
			return "Win7";
		
		var isWin10 = sUserAgent.indexOf("Windows NT 10.0") > -1 || sUserAgent.indexOf("Windows 10") > -1;
		if (isWin10) 
			return "isWin10";
	}
	
	return "other";
}




LEAP.DocumentView.OSType = LEAP.DocumentView._detectOS();
LEAP.DocumentView.isWin = (LEAP.DocumentView.OSType.indexOf("Win") > -1);
LEAP.DocumentView.Browser = LEAP.DocumentView._detectBrowser();	
LEAP.DocumentView.pluginType = {office:0, pdf:1, ofd:2};
LEAP.DocumentView._DetectPlugin = function(e, pluginType)
{
	var result = {status:1, msg:""};  //0未安装插件  1正常  2环境不对  
	if (LEAP.DocumentView.isWin == true)
	{
		if (LEAP.DocumentView.detectPlugin_win == true)
		{
		
			if (LEAP.DocumentView.Browser.browser == "IE")
			{
				if (pluginType == LEAP.DocumentView.pluginType.office)
				{
					if (LEAP.DocumentView.DocumentEditor_win == null)
					{//软航
						try
						{
							var obj = new ActiveXObject("LONGRISE.OfficeControl");
							result.status = 1;
						}
						catch(err)
						{
							result.status = 0;
							result.msg = "未检测到指定的文档编辑插件：LONGRISE.OfficeControl";
						}
					}
					else if (LEAP.DocumentView.DocumentEditor_win == "IWebOffice")
					{//iweboffice 2015
						if(window.navigator.platform == "Win32") 
						{
							try
							{
								var obj = new ActiveXObject("Kinggrid.iWebOffice");
								result.status = 1;
							}
							catch(err)
							{
								result.status = 0;
								result.msg = "未检测到指定的文档编辑插件：Kinggrid.iWebOffice";
							}						
						}
						else if(window.navigator.platform == "Win64") 
						{
							try
							{
								var obj = new ActiveXObject("Kinggrid.iWebOffice_x64");
								result.status = 1;
							}
							catch(err)
							{
								result.status = 0;
								result.msg = "未检测到指定的文档编辑插件：Kinggrid.iWebOffice_x64";
							}					
						}					
					}			
				}
				else if (pluginType == LEAP.DocumentView.pluginType.pdf)
				{
					if (LEAP.DocumentView.PdfDocumentEditor_win == null)
					{//金格pdfreader
						try
						{
							var obj = new ActiveXObject("iWebPDF.PDFReader");
							result.status = 1;
						}
						catch(err)
						{
							result.status = 0;
							result.msg = "未检测到指定的文档阅读插件：iWebPDF.PDFReader";
						}
					}
					else if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
					{//IWebPdf2018
						if(window.navigator.platform == "Win32") 
						{
							try
							{
								var obj = new ActiveXObject("iStylePDF.Application.1");
								result.status = 1;
							}
							catch(err)
							{
								result.status = 0;
								result.msg = "未检测到指定的文档阅读插件：iStylePDF.Application.1";
							}						
						}
						else if(window.navigator.platform == "Win64") 
						{
							try
							{
								var obj = new ActiveXObject("iStylePDF.Application64.1");
								result.status = 1;
							}
							catch(err)
							{
								result.status = 0;
								result.msg = "未检测到指定的文档编辑插件：iStylePDF.Application64.1";
							}					
						}	
					}			
				
				}
				else if (pluginType == LEAP.DocumentView.pluginType.ofd)
				{
					if (LEAP.DocumentView.OfdDocumentEditor == "suwellreader")
					{
						try
						{
							var obj = new ActiveXObject("suwellreader.OFDReaderActiveX");
							result.status = 1;
						}
						catch(err)
						{
							result.status = 0;
							result.msg = "未检测到指定的OFD文档阅读器插件：suwellreader.OFDReaderActiveX";					
						}
					}
					else if (LEAP.DocumentView.OfdDocumentEditor == "FoxitReader")
					{						
						try
						{
							var obj = new ActiveXObject("FoxitReader.FoxitReaderCtl");
							result.status = 1;
						}
						catch(erre)
						{
							result.status = 0;
							result.msg = "未检测到指定的OFD文档阅读器插件：FoxitReader.FoxitReaderCtl";
						}
					}
				}
			}
			else //if (LEAP.DocumentView.Browser.browser == "chrome")
			{
				if (pluginType == LEAP.DocumentView.pluginType.office)
				{
					if (LEAP.DocumentView.DocumentEditor_win == null)
					{
						result.status = 2;
						result.msg = "未为当前浏览器设置文档编辑插件";
					}
					else if (LEAP.DocumentView.DocumentEditor_win == "IWebOffice")
					{//iweboffice 2015
						var type = "application/kg-plugin";
						if (navigator.mimeTypes && navigator.mimeTypes[type])
						{
							result.status = 1;
						}
						else
						{
							result.status = 0;
							result.msg = "未检测到指定的文档编辑插件：application/kg-plugin";
						}					
					}
				}
				else if (pluginType == LEAP.DocumentView.pluginType.pdf)
				{
					if (LEAP.DocumentView.PdfDocumentEditor_win == null)
					{
						result.status = 2;
						result.msg = "未为当前浏览器设置文档编辑插件";
					}
					else if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
					{//iweboffice 2015
						var type = "application/kg-plugin";
						if (navigator.mimeTypes && navigator.mimeTypes[type])
						{
							result.status = 1;
						}
						else
						{
							result.status = 0;
							result.msg = "未检测到指定的文档编辑插件：application/kg-plugin";
						}					
					}	
				}
				else if (pluginType == LEAP.DocumentView.pluginType.ofd)
				{
					var type = "application/ofd";
					if (navigator.mimeTypes && navigator.mimeTypes[type])
					{
						result.status = 1;
					}
					else
					{						
						result.status = 2;
						result.msg = "未检测到指定的OFD阅读器插件：application/ofd";
					}
				}
			}	
		}
	}
	else if (LEAP.DocumentView.isWin == false) 
	{
		if (LEAP.DocumentView.detectPlugin_linux == true)
		{
			if (pluginType == LEAP.DocumentView.pluginType.ofd)
			{
				var type = "";
				if (LEAP.DocumentView.OfdDocumentEditor == "suwellreader")
				{
					type = 'Suwell Reader Plugin';					
				}
				else if (LEAP.DocumentView.OfdDocumentEditor == "FoxitReader")
				{
					type = 'FoxitOfficeSuitePlugins';
				}

				if (type == "")
				{
					result.status = 2;
					result.msg = "未为OFD文档设置阅读器插件";
				}
				else
				{
					var ver = navigator.plugins[type];
					if (ver == null)
					{
						result.status = 0;
						result.msg = "未检测到指定的OFD文档阅读器插件:" + type;
					}	
				}
			}
		}
	}
	
	if (result.status != 1)
	{
		alert(result.msg);
		
		if (result.status == 0)
		{
			if (LEAP.DocumentView.isWin == true)
				window.open(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + LEAP.DocumentView.pluginDownloadUrl_win);
			else
				window.open(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + LEAP.DocumentView.pluginDownloadUrl_linux);
		}
	}
	
	var ret = (result.status == 1);
	return ret;
}


LEAP.DocumentView.i = function(wait, src)
{
	if (!src)
	{
		if (!event)	return;
		src = event.srcElement;
	}
	if (!src) return;

	if (LEAP._match(src, LEAP.DocumentView.d) == null)
		return;
			
	LEAP.asyn(LEAP.DocumentView._i, this, wait, LEAP._match(src, LEAP.DocumentView.d), null);
	
	if (src.parentElement)
		src.parentElement.removeChild(src);
}

LEAP.DocumentView.afterLoadActive = function(e, doctype)
{
	if (doctype == LEAP.DocumentView.doctype.pdf)
		LEAP.DocumentView.PdfEditor.afterLoadActive(e, doctype);	
	else if (doctype == LEAP.DocumentView.doctype.scan)
		LEAP.DocumentView.Scanner.afterLoadActive(e);
}

LEAP.DocumentView._i = function(e, doctype)
{
	try
	{					
		var reload = true;
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n]._LoadedDoctype && e[LEAP.DocumentView.n]._LoadedDoctype==doctype)
			reload = false;
			
		if (doctype == null && e.getAttribute('readyloadactivex') != "0")
			doctype = LEAP.DocumentView.doctype.word;
			
		if (reload == true && doctype != null)
		{ 
			if (LEAPBrowser.isIE == true && LEAPBrowser.IEVersion <= 9)
				e.innerHTML = LEAP.DocumentView._tb_ie8;
			else			
				e.innerHTML = LEAP.DocumentView._tb
				
			var top = LEAP.getElement("[ar=top]", e);
			var bottom = LEAP.getElement("[ar=bottom]", e);
			var ispdf = false;
			var isofd = false;
			
			if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.name)
			{
				var name = e[LEAP.DocumentView.n].attachment.name.toLowerCase();
				if ( name.endWith(".pdf") )
					ispdf = true;	
				if (name.endWith(".ofd"))
					isofd = true;
			}	
					
			if (doctype == LEAP.DocumentView.doctype.scan)
			{
				top.style.height = '1px';
				top.style.lineHeight = '1px';
				bottom.style.top = '1px';
				
				
				bottom.innerHTML = LEAP.DocumentView._scannerObj;			
			}
			else if (doctype == LEAP.DocumentView.doctype.pdf || ispdf == true)
			{
				if (false == LEAP.DocumentView._DetectPlugin(e, LEAP.DocumentView.pluginType.pdf))
					return;

				if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "JSPDF") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "JSPDF"))
					
				{
					LEAP.DocumentView.JSPDF.init(e);			
				}
				else
				{				
					if (LEAP._match(e, "tab_content", "ctf") != null)
					{
						top.style.height = '1px';
						top.style.lineHeight = '1px';				
						
						bottom.style.top = '1px';
					}
					
					top.innerHTML = LEAP.DocumentView._pdf;			
					if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
					{
						if ((window.ActiveXObject!=undefined) || (window.ActiveXObject!=null) ||"ActiveXObject" in window)
						{
							if(window.navigator.platform == "Win32")
								bottom.innerHTML = LEAP.DocumentView._pdfObj2018_IE_win32;
							if (window.navigator.platform == "Win64")
								bottom.innerHTML = LEAP.DocumentView._pdfObj2018_IE_win64;
		
						}
						else if (LEAP.DocumentView.Browser.browser == "chrome") 
						{
							var _str = LEAP.DocumentView._pdfObj2018_chrome.replace("@@copyright@@", LEAP.DocumentView.IWebPdf2018_Copyright);
							
							LEAP.asyn(LEAP.DocumentView._i_pdf, this, 50, bottom, _str); //异步解决插件越界问题
						}
					}
					else
					{
						bottom.innerHTML = LEAP.DocumentView._pdfObj;
					}
				}
			}
			else if (doctype == LEAP.DocumentView.doctype.ceb)
			{
				top.style.height = '1px';
				top.style.lineHeight = '1px';
				top.innerHTML = "";
				bottom.style.top = '1px';
				bottom.innerHTML = LEAP.DocumentView._cebObj;
			}
			else if (doctype == LEAP.DocumentView.doctype.ofd || isofd == true)
			{
				if (false == LEAP.DocumentView._DetectPlugin(e, LEAP.DocumentView.pluginType.ofd))
					return;
				
				top.style.height = '1px';
				top.style.lineHeight = '1px';				
				top.innerHTML = LEAP.DocumentView._ofd;
				
				bottom.style.top = '1px';
				bottom.innerHTML = LEAP.DocumentView._ofdObject.replace('{{$ID$}}', UUID.cID());
				var div = LEAP.getElement("[ctf=ofdobj]", bottom);
								
				//var ocx = suwell.ofdReaderInit(div.getAttribute("id"), "100%","100%");
				//改为调用标准接口
				var ocx = OFD.OCX.init(div.getAttribute("id"), "100%","100%");
				if (ocx)
				{
					div["ocx"] = ocx;					
					ocx.registListener("f_open", "_OFDEditor_afterLoadDocument", true);
					//ocx.setCompsiteVisible("f_open", false);
					//ocx.setCompsiteVisible("f_save", false);
					
					var ocxobj = eval(ocx.id);
					if(ocxobj && ocxobj.style)
					{
						ocxobj.style.zIndex = 20000;
						ocxobj.style.position = "relative";
					}
				}
			}
			else
			{ //-8 -9 LEAP.DocumentView.doctype.wps LEAP.DocumentView.doctype.word
				
				if (false == LEAP.DocumentView._DetectPlugin(e, LEAP.DocumentView.pluginType.office))
					return;
				
				if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wps") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wps"))
				{	
					top.style.height = '30px';
					top.style.lineHeight = '15px';
					top.innerHTML = LEAP.DocumentView._word;
					
					if (LEAPBrowser.isIE == true)
					{
						bottom.innerHTML = LEAP.DocumentView._wpsObj_win.replace('{{$ID$}}', UUID.cID());
					}
					else
					{
						bottom.innerHTML = LEAP.DocumentView._wpsObj_linux.replace('{{$ID$}}', UUID.cID());
					}
										
					LEAP.DocumentView.WpsEditor.afterLoadActive(e);
				}
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoWeb") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoWeb"))
				{
					top.style.height = '30px';
					top.style.lineHeight = '15px';
					bottom.style.top = '30px';
					top.innerHTML = LEAP.DocumentView.YozoWeb._buttonFrame;
					bottom.innerHTML = LEAP.DocumentView.YozoWeb._editorFrame.replace('{{$ID$}}', UUID.cID());
				}
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "YozoEditor") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "YozoEditor"))
				{
					top.style.height = '30px';
					top.style.lineHeight = '15px';
					bottom.style.top = '30px';
					top.innerHTML = LEAP.DocumentView.YozoEditor._buttonFrame;
					LEAP.DocumentView.YozoEditor.init(e, bottom);					
				}
				else if ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "IWebOffice") || (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "IWebOffice"))
				{
					top.style.height = '30px';
					top.style.lineHeight = '15px';
					bottom.style.top = '30px';
					if (LEAPBrowser.isIE == true && LEAPBrowser.IEVersion ==8)
						top.innerHTML = LEAP.DocumentView._word_ie8;
					else
						top.innerHTML = LEAP.DocumentView._word;
					
					LEAP.DocumentView.IWebOffice.init(e, bottom);
				}
				else
				{
					top.style.height = '30px';
					top.style.lineHeight = '15px';
					bottom.style.top = '30px';
					if (LEAPBrowser.isIE == true && LEAPBrowser.IEVersion ==8)
						top.innerHTML = LEAP.DocumentView._word_ie8;
					else
						top.innerHTML = LEAP.DocumentView._word;

					bottom.innerHTML = LEAP.DocumentView._wordObj.replace('{{$ID$}}', UUID.cID());
				}
			}
			
			if(ispdf == true)
				LEAP.DocumentView.afterLoadActive(e, LEAP.DocumentView.doctype.pdf);
			else
				LEAP.DocumentView.afterLoadActive(e, doctype);
		}
		
		if (!e[LEAP.DocumentView.n])
			e[LEAP.DocumentView.n] = {};
		if (e[LEAP.DocumentView.n].isnew == null)
		{
			if (e[LEAP.DocumentView.n].attachment)
				e[LEAP.DocumentView.n].isnew = false;		
			else
				e[LEAP.DocumentView.n].isnew = true;
		}
		
		e[LEAP.DocumentView.n].doctype = doctype;
		e[LEAP.DocumentView.n]._LoadedDoctype = doctype;
	}
	finally
	{
		top = bottom = doctype = reload = null;
	}
}

LEAP.DocumentView._i_pdf = function(bottom, _str)
{
	bottom.innerHTML = _str;
}


LEAP.DocumentView.init();








/**
 *  *********LEAP.DocumentView.PdfEditor**************************************************************************************
 */
LEAP.DocumentView.PdfEditor = {};
LEAP.DocumentView.PdfEditor.loadDocument = function(e, url)
{
	if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
	{
		LEAP.DocumentView.PdfEditor.afterLoadActive2(e);
		LEAP.DocumentView.PdfEditor.loadDocument2(e, url);
	}
	else
	{
		LEAP.DocumentView.PdfEditor.loadDocument1(e, url);
	}
}
LEAP.DocumentView.PdfEditor.loadDocument1 = function(e, url)
{
	try
	{
		if (!url)
			return;
		
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		if (!obj)
			return;

		console.log(url);
		obj.ShowTitle = false;
		obj.WebClose();
		obj.WebOpenUrlFile(url);
		var data = e[LEAP.DocumentView.n];
		console.log(data);
		if(data && data.attachment && data.attachment.title)
		{
			obj.FileName = data.attachment.title;
		}
		
		//标记是网络打开PDF
		obj['___openlocalpdf'] = false;
	}
	catch(err)
	{
		console.log(err);
		alert('文档加载失败!');
	}
	finally
	{
		obj = data = null;		
	}
}
LEAP.DocumentView.PdfEditor.loadDocument2 = function(e, url)
{
	try
	{
		if (!url)
			return;
		
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		if (!obj)
			return;
		console.log(url);
		obj.Documents.OpenFromURL(url);
		var data = e[LEAP.DocumentView.n];
		console.log(data);
		if(data && data.attachment && data.attachment.title)
		{			
			obj.iWebPDFFun.FileName = data.attachment.title;
		}
		
		//标记是网络打开PDF
		obj['___openlocalpdf'] = false;
	}
	catch(err)
	{
		console.log(err);
		alert('文档加载失败!');
	}
	finally
	{
		obj = data = null;		
	}
}

LEAP.DocumentView.PdfEditor.afterLoadActive = function(e, doctype)
{
	if (LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win != "JSPDF")
	{
		if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
		{
			var obj = LEAP.getElement('[ctf=pdfobj]', e);
			LEAP.asyn(LEAP.DocumentView.PdfEditor.__zoom, this, 200, obj, 10);	
		}
		else
		{
			LEAP.DocumentView.PdfEditor.afterLoadActive1(e, doctype);
			//var obj = LEAP.getElement('[ctf=pdfobj]', e);
			//LEAP.asyn(LEAP.DocumentView.PdfEditor.__zoom, this, 200, obj, 10);	
		}
	}
}

LEAP.DocumentView.PdfEditor.__zoom = function(obj, times)
{	
	if (times>0 && obj)
	{
		obj.Zoom = -1;
		
		if (obj.iWebPDFFun)
			obj.iWebPDFFun.Zoom = -1;
		LEAP.asyn(LEAP.DocumentView.PdfEditor.__zoom, this, 200, obj, times - 1);	
	}
	
	
}

LEAP.DocumentView.PdfEditor.afterLoadActive1 = function(e, doctype)
{
	try
	{		
		if (doctype = LEAP.DocumentView.doctype.pdf)
		{
			var obj = LEAP.getElement('[ctf=pdfobj]', e);		
			if (!obj)
			return;
			
			obj.ShowTitle = false;               //
			obj.ShowPostil = true;
			obj.ShowTools = 1;               //工具栏可见（1,可见；0,不可见）
			obj.AlterUser = true;           //是否允许由控件弹出提示框 true表示允许  false表示不允许
			obj.ShowMenus=0;                 //菜单栏可见（1,可见；0,不可见）
			obj.ShowBookMark = 1;			//是否显示书签树按钮（1,显示；0,不显示）
			obj.ShowSigns = 1;         	    //设置签章工具栏当前是否可见（1,可见；0,不可见）
			obj.ShowSides = 1;				//是否显示侧边栏
			obj.userName = LEAP.getUserInfo().fullName;
			
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.isOpenWindow == true)
			{
				var top = LEAP.getElement("div[ar=top]", e);
				var bottom = LEAP.getElement("div[ar=bottom]", e);
				if (top)
				{
					top.style.height = '30px';
					top.style.lineHeight = '15px';
					bottom.style.top = "30px";
					
					var btnSave = LEAP.getElement("a[al=pdf_create]", top);
					var btnSaveas = LEAP.getElement("a[al=pdf_saveAs]", top);
					var btnPrint = LEAP.getElement("a[al=pdf_print]", top);
					var btnClose = LEAP.getElement("a[al=pdf_close]", top);
					
					//wordButton
					if (e[LEAP.DocumentView.n].param.pdfButton != null)
					{
						var btns = e[LEAP.DocumentView.n].param.pdfButton;						
						if (btns.indexOf("create") >=0)
						{
							if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.canEdit == false)
								btnSave.style.display = "none";
							else
								btnSave.style.display = "block";
						}
						else
						{
							btnSave.style.display = "none";							
						}
						
						btnSaveas.style.display = ( (btns.indexOf("saveAs") >=0) ? "block":"none");
						btnPrint.style.display = ( (btns.indexOf("print") >=0) ? "block":"none");
						btnClose.style.display = ( (btns.indexOf("close") >=0) ? "block":"none");
					}
					else
					{
						btnSaveas.style.display = "block";
						btnPrint.style.display = "block";										
						if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.canEdit == false)
							btnSave.style.display = "none";
						else
							btnSave.style.display = "block";
						
						if (e.getAttribute('newwindow') == "1")
							btnClose.style.display = 'block';
						else
							btnClose.style.display = 'none';
					}					
				}
			}
			
			if (obj.attachEvent)
			{
				obj.attachEvent("OnOpen", function(){LEAP.DocumentView.WordEditor.OnOpenPDF(obj);});
				obj.attachEvent("OnAddSignature", function(){LEAP.DocumentView.WordEditor.OnOpenPDF(obj);});
				obj.attachEvent("OnDelSignature", function(){LEAP.DocumentView.WordEditor.OnOpenPDF(obj);});
			}
			else if(obj.addEventListener)
			{				
				var handler = document.createElement("script");
				handler.setAttribute("for", obj.id);
				handler.event = "OnOpen(param1, param2)";  
				handler.appendChild(document.createTextNode("var a = document.getElementById('" + obj.id + "');"));
				handler.appendChild(document.createTextNode("LEAP.DocumentView.WordEditor.OnOpenPDF(a);"));
				document.body.appendChild(handler);
				
				handler = document.createElement("script");
				handler.setAttribute("for", obj.id);
				handler.event = "OnAddSignature(param1)";  
				handler.appendChild(document.createTextNode("var a = document.getElementById('" + obj.id + "');"));
				handler.appendChild(document.createTextNode("LEAP.DocumentView.WordEditor.OnOpenPDF(a);"));
				document.body.appendChild(handler);
				
				handler = document.createElement("script");
				handler.setAttribute("for", obj.id);
				handler.event = "OnDelSignature(param1)";  
				handler.appendChild(document.createTextNode("var a = document.getElementById('" + obj.id + "');"));
				handler.appendChild(document.createTextNode("LEAP.DocumentView.WordEditor.OnOpenPDF(a);"));
				document.body.appendChild(handler);
			}
			
		}
	}
	finally
	{
		obj = top = btnSave = btnSaveas = btnPrint = null;
	}
}

LEAP.DocumentView.PdfEditor.afterLoadActive2 = function(e, doctype)
{
	if(e['hasinit'])
		return;
	try
	{	
		
		var obj = LEAP.getElement('[ctf=pdfobj]', e);				
		if (!obj)
		return;
		
		if(obj.Documents && obj.Documents.Count == 0)
		{
			obj.Options.UserName = LEAP.getUserInfo().fullName;
			obj.Options.TabCommandBarVisible = false;
			obj.Options.TabBarVisible = false;
			obj.Options.HistoryEnabled = false;
			obj.Options.StartPageVisible = false;
		}		
		
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.isOpenWindow == true)
		{
			var top = LEAP.getElement("div[ar=top]", e);
			var bottom = LEAP.getElement("div[ar=bottom]", e);
			if (top)
			{
				top.style.height = '30px';
				top.style.lineHeight = '15px';
				bottom.style.top = "30px";
				
				var btnSave = LEAP.getElement("a[al=pdf_create]", top);
				var btnSaveas = LEAP.getElement("a[al=pdf_saveAs]", top);
				var btnPrint = LEAP.getElement("a[al=pdf_print]", top);
				var btnClose = LEAP.getElement("a[al=pdf_close]", top);
				
				if (e[LEAP.DocumentView.n].param.pdfButton != null)
				{
					var btns = e[LEAP.DocumentView.n].param.pdfButton;						
					if (btns.indexOf("create") >=0)
					{
						if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.canEdit == false)
							btnSave.style.display = "none";
						else
							btnSave.style.display = "block";
					}
					else
					{
						btnSave.style.display = "none";							
					}
					
					btnSaveas.style.display = ( (btns.indexOf("saveAs") >=0) ? "block":"none");
					btnPrint.style.display = ( (btns.indexOf("print") >=0) ? "block":"none");
					btnClose.style.display = ( (btns.indexOf("close") >=0) ? "block":"none");
				}
				else
				{					
					btnSaveas.style.display = "block";
					btnPrint.style.display = "block";										
					if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.canEdit == false)
						btnSave.style.display = "none";
					else
						btnSave.style.display = "block";
						
					if (e.getAttribute('newwindow') == "1")
						btnClose.style.display = 'block';
					else
						btnClose.style.display = 'none';
				}
				
			}
		}
		
		if (obj.attachEvent)
		{
			obj.attachEvent("OnDocumentOpen", function(){LEAP.DocumentView.WordEditor.OnOpenPDF(obj);});
			obj.attachEvent("OnAddSignature", function(){LEAP.DocumentView.WordEditor.OnOpenPDF(obj);});
			obj.attachEvent("OnDelSignature", function(){LEAP.DocumentView.WordEditor.OnOpenPDF(obj);});
		}
		else if(obj.addEventListener)
		{				
			var handler = document.createElement("script");
			handler.setAttribute("for", obj.id);
			handler.event = "OnDocumentOpen(param1, param2)";  
			handler.appendChild(document.createTextNode("var a = document.getElementById('" + obj.id + "');"));
			handler.appendChild(document.createTextNode("LEAP.DocumentView.WordEditor.OnOpenPDF(a);"));
			document.body.appendChild(handler);
			
			handler = document.createElement("script");
			handler.setAttribute("for", obj.id);
			handler.event = "OnAddSignature(param1)";  
			handler.appendChild(document.createTextNode("var a = document.getElementById('" + obj.id + "');"));
			handler.appendChild(document.createTextNode("LEAP.DocumentView.WordEditor.OnOpenPDF(a);"));
			document.body.appendChild(handler);
			
			handler = document.createElement("script");
			handler.setAttribute("for", obj.id);
			handler.event = "OnDelSignature(param1)";  
			handler.appendChild(document.createTextNode("var a = document.getElementById('" + obj.id + "');"));
			handler.appendChild(document.createTextNode("LEAP.DocumentView.WordEditor.OnOpenPDF(a);"));
			document.body.appendChild(handler);
		}

		e['hasinit'] = true;
	}
	finally
	{
		obj = top = btnSave = btnSaveas = btnPrint = null;
	}
}

LEAP.DocumentView.PdfEditor.resizeObject = function(e)
{
	try
	{
		if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
		{		
		}
		else
		{		
			var obj = LEAP.getElement('object[ctf=pdfobj]', e);
			if (obj && obj.parentNode.parentNode)
			{
				obj.style.marginTop = '-25px';
				//obj.style.minHeight = (obj.parentNode.parentNode.offsetHeight + 21) + 'px'; 
				obj.style.height = "104%";
				
				ElementEventManager.handleEvent(e, "onDocumentLoad");
			}
		}
	}
	finally
	{
		obj = e = null;
	}
}

LEAP.DocumentView.PdfEditor.save = function(e, __alertResult)
{		
	if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
		return LEAP.DocumentView.PdfEditor.save2(e);
	else
		return LEAP.DocumentView.PdfEditor.save1(e);
		
}

LEAP.DocumentView.PdfEditor.save1 = function(e, __alertResult)
{		
	try	
	{	
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		if (!obj)
			return true;
			
		if (obj.isOpen != 1)
			return true;

		var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) +  "logic/JGSavePdf?namedpath=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) +
										"&physicfilename=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);
		
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
			url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
			url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
			url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
			url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
			url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
										
		obj.WebUrl = url;		
		obj.RecordId = "0";
		var res = obj.WebSave();		
		if (res && res == 1)
		{
			var rst = obj.WebGetMsgByName("__result"); 
			if (rst && rst == "1")
			{
				if (__alertResult==false){}else alert("保存成功！");
				return true;
			}
			else
			{
				if (__alertResult==false){}else  alert("保存失败！");
				return false;
			}
			
			return true;
		}
		else
		{
			if (__alertResult==false){}else alert("保存失败！");
			return false;
		}
	}
	catch(e)
	{
		if (__alertResult==false){}else alert("保存失败！");
		return false;
	}
	finally
	{
		obj = url = res = null;
	}
}

LEAP.DocumentView.PdfEditor.save2 = function(e, __alertResult)
{		
	try	
	{	
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		if (!obj)
			return true;
			
		if ( 0 == obj.Documents.Count )
		{
			LEAP.DocumentView.PdfEditor.__alert(e, "没有要保存的文档");
			return;
		}

		var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) +  "logic/JGSavePdf?namedpath=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) +
										"&physicfilename=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);
		
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
			url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
			url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
			url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
			url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
			url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
										
		var addin = obj.iWebPDFFun;//
		
		addin.WebUrl = url;
		addin.RECORDID = "dsafdsa";
		addin.FILENAME = "asd";
		addin.FILETYPE = ".pdf";
		var ret = addin.WebSave();
		if (ret == true)
		{
			if (__alertResult==false){}
			else 
				LEAP.DocumentView.PdfEditor.__alert(e, "保存成功！");
			
			return true;
		}
		else 
		{
			if (__alertResult==false){}
			else 
				LEAP.DocumentView.PdfEditor.__alert(e, "保存失败！");				
				
			return false;
		}
		
		
		/*obj.COMAddins("KingGrid.MsgServer2000").Object.WebUrl = url;
		var tempFile = obj.COMAddins("KingGrid.MsgServer2000").Object.CreateTempFileName();
		obj.Documents.ActiveDocument.Save(tempFile);
		obj.COMAddins("KingGrid.MsgServer2000").Object.MsgFileLoad(tempFile);
		obj.COMAddins("KingGrid.MsgServer2000").Object.SetMsgByName("OPTION","SAVEFILE");

		if (obj.COMAddins("KingGrid.MsgServer2000").Object.PostDBPacket(false))
		{ 
			if (__alertResult==false){}else alert("保存成功！");
			
			return true;
		}
		else
		{
			if (__alertResult==false){}else alert("保存失败！");
			return false;
		}*/
		
		
	}
	catch(e)
	{
		if (__alertResult==false){}else LEAP.DocumentView.PdfEditor.__alert(e, "保存失败！");
		return false;
	}
	finally
	{
		obj = url = null;
	}
}

LEAP.DocumentView.PdfEditor.saveAs = function(e)
{	
	if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")	
		LEAP.DocumentView.PdfEditor.saveAs2(e);
	else 
		LEAP.DocumentView.PdfEditor.saveAs1(e);
}

LEAP.DocumentView.PdfEditor.saveAs1 = function(e)
{	
	try
	{
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		obj.WebSaveLocal();
	}
	catch(e)
	{
	}
	finally
	{
		obj = null;		
	}
}

LEAP.DocumentView.PdfEditor.saveAs2 = function(e)
{	
	try
	{
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		obj.iWebPDFFun.WebSaveLocal();
	}
	catch(e)
	{
	}
	finally
	{
		obj = null;		
	}
}

LEAP.DocumentView.PdfEditor.printDoc = function(e)
{
	if (LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")
		LEAP.DocumentView.PdfEditor.printDoc2(e);
	else 
		LEAP.DocumentView.PdfEditor.printDoc1(e);
}

LEAP.DocumentView.PdfEditor.printDoc1 = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		if (obj.PrintStatus == false)
		{			
			alert("该文档不允许打印！");
			return;
		}
			
		obj.WebPrint(1, "", 0, 0, true);
		//obj.WebPrintControl("", -1, 0, "", true);
	}
	catch(e)
	{
		//alert(9);
		//alert("打印失败：请确保打印机已经开启，并且打印服务已经启动！");
	}
	finally
	{
		obj = null;		
	}
}

LEAP.DocumentView.PdfEditor.printDoc2 = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		
		if (obj.Documents.ActiveDocument.HasPermissions(0) != true)
		{			
			LEAP.DocumentView.PdfEditor.__alert(e, "该文档不允许打印！");
			return;
		}
		var Missing;
		obj.Documents.ActiveDocument.PrintOut(Missing, Missing, 15, 1, false);
	}
	catch(e)
	{

	}
	finally
	{
		obj = null;		
	}
}

LEAP.DocumentView.PdfEditor.close = function(e, windowclose) 
{	
	try
	{		
		window.close();
	}
	finally
	{
	}	
	
}


LEAP.DocumentView.PdfEditor.buttonClick = function(e, al)
{
	if (al == 'pdf_create')
		LEAP.DocumentView.PdfEditor.save(e, false);
	else if (al == 'pdf_print')
		LEAP.DocumentView.PdfEditor.printDoc(e);
	else if (al == 'pdf_saveAs')
		LEAP.DocumentView.PdfEditor.saveAs(e);
	else if (al == 'pdf_close')
		LEAP.DocumentView.PdfEditor.close(e);
		
}


LEAP.DocumentView.PdfEditor.__alert = function(e, content)
{
	var obj = LEAP.getElement('[ctf=pdfobj]', e);
	if (!obj)
		return true;
			
	if(LEAP.DocumentView.OSType.indexOf("Win") > -1 && LEAP.DocumentView.Browser.browser == "chrome")
	{
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		
		if (LEAP.DocumentView.PdfEditor.alertForm == null)
		{
			LEAP.DocumentView.PdfEditor.alertForm = LEAP.form.create3({name:null, title:'提示', width:500, height:150, formtype:3});
			
			var str = '<div style="height:100%; width:100%;">';
				str += '<div style="padding:10px 0px 0px 10px;">';
				str += '<span ut="content" class="LC_input_conner" style="width:97%;font-size:14px;border:none;"></span>';
				str += '</div>'
				str += '<input ut="submit" class="LC_button_conner LC_button_blue" style="float:right; margin:0px 30px 0px 0px;" type="button" value="确定" lcv="2" ht="input">'
				str += '</div>'
				
			LEAP.form.setContent(LEAP.DocumentView.PdfEditor.alertForm.form, str);
			
			_formElement = LEAP.getElement(LEAP.DocumentView.PdfEditor.alertForm.form);
			var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
			if (icon)
				icon.style.display = "none";
	
			var _btn = LEAP.getElement("input[ut=submit]", _formElement);
			LEAP.addEvent(_btn, 'click', LEAP.DocumentView.PdfEditor.__alert_callback, {viewer:e});
		}
		
		var span = LEAP.getElement("span[ut=content]", _formElement);
		span.textContent = content;
		
		var bottom = LEAP.getElement("[ar=bottom]", e);
		bottom.style.transform = "translateX(10000px)";
		
		LEAP.DocumentView.PdfEditor.alertForm.show();
	}
	else
	{
		alert(content);
	}
}

LEAP.DocumentView.PdfEditor.__alert_callback = function(arg)
{
	var e = arg.arg.viewer;
	var obj = LEAP.getElement('[ctf=pdfobj]', e);
	if (!obj)
		return true;
		
	LEAP.DocumentView.PdfEditor.alertForm.hide();
	
	var bottom = LEAP.getElement("[ar=bottom]", e);
	bottom.style.transform = "translateX(0px)";
}













/**
 * *********LEAP.DocumentView.Scanner****************************************************************************************************************
 */
LEAP.DocumentView.Scanner = {};
LEAP.DocumentView.Scanner.afterLoadActive = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=scannerobj]', e);
		if (!obj)
			return;
		
		/*var backOnlad = function() 
		{
			function obj::OnScanComplete()
			{
				LEAP.DocumentView.Scanner.OnScanComplete(e);
			}
		}
		backOnlad();// 注册回调
		*/
		
		if (!obj['______h'])
		{
			obj.attachEvent("OnScanComplete", function(){LEAP.DocumentView.Scanner.OnScanComplete(e);});
			obj['______h'] = 1;
		}
	}
	finally
	{
		obj = null; //backOnlad = null;
	}
}

LEAP.DocumentView.Scanner.save = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=scannerobj]', e);
		if (!obj)
			return false;
					
		var ret = obj._silenceSave();
		var ret = JSON.parse(ret);
		if (ret.state && ret.state == 'clear')
		{
			LEAP.DocumentView.valueChange(e, null, LEAP.DocumentView.doctype.scan);			
			return true;
		}
		else if (ret.state && ret.state == 'nochange')
		{
			return true;
		}
		else
		{			
			var fileCount = obj._scanFileCount;
			var _att;
			if (e[LEAP.DocumentView.n].attachment)
			{
				_att = e[LEAP.DocumentView.n].attachment;
				_att.name = ret.name;
				_att.uuid = ret.uuid;
				_att.namedpath = ret.nameedPath;				
				_att.filecount = fileCount;
				if (_att.id)
					_att.updateType = 1;
				else
					_att.updateType = 0;
			}
			else
			{
				var _att={};
				_att.atttype = LEAP.DocumentView.doctype.scan;
				_att.fileid = ret.fileid;
				_att.title = "正文扫描件";	//ret.title;
				_att.name = ret.name;				
				_att.uuid = ret.uuid;
				_att.namedpath = ret.nameedPath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;
				_att.filecount = fileCount;
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;				
			}
	
			LEAP.DocumentView.valueChange(e, _att);	
			
			return true;
		}
		
		return false;
	}	
	catch(err)
	{
		alert("保存扫描件失败:" + err.description);		
		return false;
	}
	finally
	{
		obj = ret = ret = fileCount = _att = null;		
	}
}

LEAP.DocumentView.Scanner.loadDocument = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=scannerobj]', e);
		if (!obj)
			return;
				
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment)
		{
			var att = e[LEAP.DocumentView.n].attachment;
			var readonly = (att.canEdit == false)?1:0;
			
			var uploadpath;
			if (att.namedpath)
				uploadpath = att.namedpath.substring(0, att.namedpath.indexOf('/'));
			if (!uploadpath)
				uploadpath = e.getAttribute("scan_uploadpath");
							
			var path = LEAP.DocumentView._getPath(att, e);
			if (path.endWith('.zip'))
				path = path.substring(0, path.length-4);
				path += '/';
			
			var __url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&readscan=1&old_namedpath=' + att.namedpath + '&old_name=' + att.name+ '&old_uuid=' + att.uuid + '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
				
			obj._scanread(100, 0, 0, att.title+'.zip', readonly, path, att.filecount, 'JSESSIONID=' + leapclient.getsid(), __url);
		}
		else
		{	
			var __url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + e.getAttribute("scan_uploadpath");
			obj._scanupload(100, 0, 0, "新扫描件.zip",	'JSESSIONID=' + leapclient.getsid(), __url);
		}
	}
	catch(e)
	{
		alert('下载正文扫描件失败！');
	}
	finally
	{
		obj = att = readonly = uploadpath = path = __url = null;
	}
}

LEAP.DocumentView.Scanner.OnScanComplete = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=scannerobj]', e);
		if (!obj)
			return;
		
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment)
		{
			var uri = obj._scanUploadResult;
				uri = JSON.parse(uri);
			var fileCount = obj._scanFileCount;						
			var _att = e[LEAP.DocumentView.n].attachment;
				_att.fileid = uri.fileid;
				_att.name = uri.name;
				_att.uuid = uri.uuid;
				_att.namedpath = uri.nameedPath;
				_att.updateType = 1;
				_att.filecount = fileCount;
	
			LEAP.DocumentView.valueChange(e, _att);
		}
		else
		{
			var uri = obj._scanUploadResult;
				uri = JSON.parse(uri);
			var fileCount = obj._scanFileCount;
						
			var _att={};
				_att.atttype = LEAP.DocumentView.doctype.scan;
				_att.fileid = uri.fileid;
				_att.title = "正文扫描件";//uri.title;
				_att.name = uri.name;
				_att.viewname = uri.viewname;
				_att.uuid = uri.uuid;
				_att.namedpath = uri.nameedPath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;
				_att.filecount = fileCount;
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;

			LEAP.DocumentView.valueChange(e, _att);			
		}
		
	}
	finally
	{
		obj = uri = fileCount = _att = uri = null;
	}
}

LEAP.DocumentView.Scanner.printDoc = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=scannerobj]', e);					
		obj._print();
	}
	catch(e)
	{
	}
	finally
	{
		obj = null;		
	}
}


/**
 * ************LEAP.DocumentView.CebViewer************************************
 */
LEAP.DocumentView.CebViewer = {};
LEAP.DocumentView.CebViewer.loadDocument = function(e, url, time)
{
	try
	{
		if (time)
		{
			setTimeout(
			function(){
			LEAP.DocumentView.CebViewer.loadDocument(e, url);
			}, time);
		}
				
		var obj = LEAP.getElement('[ctf=cebObj]', e);
		if (!obj)
			return;
			
		obj.ViewNetCEB(url);					
	}
	catch(e)
	{
		alert("加载文档失败！");
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.CebViewer.printDoc = function(e)
{
	try
	{
		alert("请点击下方的打印按钮进行打印！");
	}
	catch(e)
	{	
	}
	finally
	{		
	}
}





LEAP.DocumentView.OFDEditor = {};
LEAP.DocumentView.OFDEditor.afterLoadActive = function(e)
{
	//var obj = LEAP.getElement('[ctf=ofdobj]', e);
}

LEAP.DocumentView.OFDEditor.loadDocument = function(e, url)
{
	try
	{
		
		/*var sid = (window.createRouterClient != null) ? "LSID=":"JSESSIONID=";
		sid = "?" + sid + leapclient.getsid();
		
		url += sid;*/
				
		var obj = LEAP.getElement('[ctf=ofdobj]', e);
		var ocx = obj['ocx'];
		
		var saveurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc_ofd?' 
					+ 'namedpath=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) 
					+ '&name=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);	
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
			saveurl += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);	
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
			saveurl += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
			saveurl += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
			saveurl += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
			saveurl += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
				
		var userConfig = LEAP.getUserInfo();
		ocx.setUserID(userConfig.userid);
		ocx.setUserName(userConfig.userflag);

		if (LEAP.DocumentView.OfdDocumentEditor == "FoxitReader")
		{
			ocx.openFile(url, !e[LEAP.DocumentView.n].attachment.canEdit);
		}
		else
		{
			if (userConfig.detail && userConfig.detail.extinfo)
			{				
				var ext = JSON.parse(userConfig.detail.extinfo);
				if (ext.getuserseallist == "true" && ext.sealuserid)
				{
					ocx.setConfigInfo("signature.getuserseallist", true);
					ocx.setConfigInfo("signature.getuserseallist.userid", ext.sealuserid);
				}
			}
			
			ocx.openurl(url, saveurl, !e[LEAP.DocumentView.n].attachment.canEdit);
		}
		
		LEAP.DocumentView.OFDEditor.lastid = obj.getAttribute("id");
		
		setTimeout(LEAP.DocumentView.OFDEditor._afterLoadDocument, 500);
	}
	finally
	{
		sid = obj = ocx = userConfig = null;
	}
}
LEAP.DocumentView.OFDEditor.lastid = null; 
var _OFDEditor_afterLoadDocument = function(arg)
{
	/*var obj = LEAP.getElement("[id="	+  LEAP.DocumentView.OFDEditor.lastid + "][ctf=ofdobj]");
	var e = LEAP._match(obj, LEAP.DocumentView.d);
	//obj["ocx"].setCompsiteVisible("sign", true);
	LEAP.DocumentView.OFDEditor.afterLoadDocument(e);	*/
}
LEAP.DocumentView.OFDEditor._afterLoadDocument = function()
{
	var obj = LEAP.getElement("[id="	+  LEAP.DocumentView.OFDEditor.lastid + "][ctf=ofdobj]");
	var e = LEAP._match(obj, LEAP.DocumentView.d);
	//obj["ocx"].setCompsiteVisible("sign", true);
		
	if (LEAP.DocumentView.OFDEditor.addRuntimeWatermaker != false)
		LEAP.DocumentView.OFDEditor.__addRuntimeWatermaker();
	
	LEAP.DocumentView.OFDEditor.afterLoadDocument(e);	
}

LEAP.DocumentView.OFDEditor.__addRuntimeWatermaker = function()
{
	try
	{
		if (LEAP.DocumentView.OfdDocumentEditor == "FoxitReader")
			return;
		
		var obj = LEAP.getElement("[id="	+  LEAP.DocumentView.OFDEditor.lastid + "][ctf=ofdobj]");	
		var ocx = obj["ocx"];
		
		var str = '<setinfo type="barinfo">' +
				'<parameter name="pages" value="all"/>' +
				'<parameter name="rotate" value="40"/>' +
				'<parameter name="visible" value="true"/>' +
				'<parameter name="printable" value="true"/>' +
				'<parameter name="xpostype" value="absolute"/>' +
				'<parameter name="ypostype" value="absolute"/>' +
				'<parameter name="x" value="&x&"/>' +
				'<parameter name="y" value="&y&"/>' +
				'<parameter name="w" value="1500"/>' +
				'<parameter name="h" value="20"/>' +
				'<parameter name="strcont" font="宋体" size="20" bold="true" italic="false" color= "EEEEEE">&txt&</parameter>' +
				'</setinfo>';
		
		var info = LEAP.getUserInfo();	
		var txt = "";
		for(var i=0; i<10; i++)
			txt = txt + info.userflag + "    " + info.getTimeFormart() + "             ";	
			
		var x = -200; 
		var y = -200; 
		var ss = null;
		for(var i=0; i<20; i++)
		{
			y = y + 50;
			ss = str.replace("&x&", x).replace("&y&", y).replace("&h&", 30).replace("&w&", 20).replace("&txt&", txt);
			
			ocx.addTrackInfo(ss);
		}
	}
	catch(e)
	{
		
	}
	
}

LEAP.DocumentView.OFDEditor.afterLoadDocument = function(e)
{
	try
	{
		if (e == null)
			return;
		
		if (LEAP.DocumentView.OfdDocumentEditor == "FoxitReader")
		{
		}
		else
		{
			return;
		}
				
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.isOpenWindow == true)
		{
			var top = LEAP.getElement("div[ar=top]", e);
			var bottom = LEAP.getElement("div[ar=bottom]", e);
			if (top)
			{
				top.style.height = '30px';
				top.style.lineHeight = '15px';
				bottom.style.top = "30px";
				
				var btnSave = LEAP.getElement("a[al=ofd_create]", top);
				var btnSaveas = LEAP.getElement("a[al=ofd_saveAs]", top);
				var btnPrint = LEAP.getElement("a[al=ofd_print]", top);
				
				btnSaveas.style.display = "block";
				btnPrint.style.display = "block";										
				if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.canEdit == false)
					btnSave.style.display = "none";
				else
					btnSave.style.display = "block";
			}
		}
		
	}
	finally
	{
		top = bottom = btnSave = btnSaveas = btnPrint = null;	
	}
}
LEAP.DocumentView.OFDEditor.save = function(e, __alertResult)
{
	try
	{
		var obj = LEAP.getElement('[ctf=ofdobj]', e);
		if (!obj)
			return false;
		
		var ocx = obj['ocx'];
		
		var hasModify = ocx.isDocumentModified();
		if (hasModify == false)
			return true;
				
		var res;		        
		var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc_ofd?' 
					+ 'namedpath=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) 
					+ '&name=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);	
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
			url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);	
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
			url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
			url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
			url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
			url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
			
		res = ocx.saveFile(url);			
		
		
		if (res == true || res == "true")
		{
			if (__alertResult == false){} else alert("保存成功");
			
			return true;			
		}
		else
		{
			if (__alertResult==false){}else alert("保存失败!");
			return false;
		}
	}
	catch(e)
	{}
	finally
	{
		obj = ocx = hasModify = res = url = null;
	}

}

LEAP.DocumentView.OFDEditor.saveas = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=ofdobj]', e);
		if (!obj)
			return false;
		
		var ocx = obj['ocx'];
		
		var name = e[LEAP.DocumentView.n].attachment.title;
		ocx.decryptAllSeals(true, true, true, name);
	}
	finally
	{
		obj = ocx = name = null;
	}

}

LEAP.DocumentView.OFDEditor.printDoc = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=ofdobj]', e);
		if (!obj)
			return false;
		
		var ocx = obj['ocx'];
		var name = e[LEAP.DocumentView.n].attachment.title;
		ocx.printFile(name, false);
		
	}
	finally
	{
		obj = ocx = name = null;
	}
}

LEAP.DocumentView.OFDEditor.buttonClick = function(e, al)
{
	if (al == "ofd_create")
	{
		LEAP.DocumentView.OFDEditor.save(e);
	}
	else if (al == "ofd_saveAs")
	{
		LEAP.DocumentView.OFDEditor.saveas(e);
	}
	else if (al == "ofd_print")
	{
		LEAP.DocumentView.OFDEditor.printDoc(e);
	}
}


/**
 * *************************LEAP.DocumentView.JSPDF********************************************************************************************************
 */
LEAP.DocumentView.JSPDF = {};
LEAP.DocumentView.JSPDF.init = function(e)
{
	var top = LEAP.getElement("[ar=top]", e);
	var bottom = LEAP.getElement("[ar=bottom]", e);
	
	top.style.height = '0px';
	top.style.lineHeight = '0px';
	top.style.display = 'none';
	bottom.style.top = '0px';
	
	var iframe = document.createElement('iframe');
	iframe.setAttribute('ctf',"pdfobj");
	iframe.style.position = 'absolute';
	iframe.style.visibility = 'inherit';
	iframe.style.top = '0px';
	iframe.style.left = '0px';
	iframe.style.width = '100%';
	iframe.style.height = '100%';

	bottom.appendChild(iframe);
}


LEAP.DocumentView.JSPDF.loadDocument = function(e, url)
{
	try
	{
		if (!url)
			return;
		
		var obj = LEAP.getElement('[ctf=pdfobj]', e);
		if (!obj)
			return;

		/*var data = e[LEAP.DocumentView.n];
		if(data && data.attachment && data.attachment.title)
		{
			obj.FileName = data.attachment.title;
		}*/
		
		obj.src = window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/pdf/web/viewer.html?file=" + url);    	
	}
	catch(err)
	{
		alert('文档加载失败!');
	}
	finally
	{
		obj = null;		
	}
}


//TODO
//流程配置-
//刷附件表的wps正文  -
// refresh界面时销毁原有表单
//快捷键
//销毁插件
//插件安装




/**
 * *************************LEAP.DocumentView.WordEditor********************************************************************************************************
 */
LEAP.DocumentView.WordEditor = {};
//LEAP.DocumentView.WordEditor.version = "v1";
LEAP.DocumentView.WordEditor.loadDocument = function(e, url, type)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		
		obj.style.height = (obj.clientHeight + 46) + "px";
		
		/*var backOnlad = function() 
		{
			function obj::OnDocumentOpened(file,doc)
			{
				LEAP.DocumentView.WordEditor.openDocAfter(e);
			}
		}
		backOnlad();// 注册回调
		*/
		
		/*if (type == "Word.Document")
		{//word的情况下判读版本
			if (!obj.ActiveDocument)
				obj.CreateNew("Word.Document");

			var v = obj.ActiveDocument.application.version;
			if (url.toLowerCase().endWith('.docx') && v && v.indexof("11.")>=0)
			{
				alert("此文档由较高版本office产生，您本地安装的office程序版本较低，请安装较高版本的office程序！");
				if (LWFP._office_download_url)
					window.open(window.geturl(LWFP._office_download_url));
				
				obj.Close();
				return;
			}
		}*/
		
		if (!obj['___h'])
		{
			if (obj.attachEvent)
			{
				obj.attachEvent("OnDocumentOpened", function(){LEAP.DocumentView.WordEditor.openDocAfter(e);});
				obj['___h'] = 1;
			}
			else if(obj.addEventListener)
			{				
				/*var fu = function(){ 
						function obj::OnDocumentOpened(file, doc)
						{
							LEAP.DocumentView.WordEditor.openDocAfter(e);
						}
					}
				fu();*/
				var handler = document.createElement("script");
				handler.setAttribute("for", obj.id);
				handler.event = "OnDocumentOpened(param1, param2)";  
				handler.appendChild(document.createTextNode("var a = '" + obj.id + "';"));
				handler.appendChild(document.createTextNode("LEAP.DocumentView.WordEditor.handleWordOpenedEvent(a);"));
				document.body.appendChild(handler);
							
				obj['___h'] = 1;
			}
		}

		obj.BeginOpenFromURL(url, false, false, type);
	}
	catch (err) 
	{
		console.log(err);
	} 
	finally
	{
		obj = url = handler = null;
	}
}


LEAP.DocumentView.WordEditor.DOWN = "\\WebOffice\\Down\\"; // 指定下载路径并设置名称
LEAP.DocumentView.WordEditor.getDownFilePath = function(obj)
{
	if( obj==null )
		return null;
	var fs = obj.FileSystem;
	return fs.GetSpecialFolderPath(0x1a) + LEAP.DocumentView.WordEditor.DOWN; //临时路径
}
LEAP.DocumentView.WordEditor.WebDownLoadFile = function(obj, Url) 
{
	if( obj==null )
		return null;
		
	//删除本地文件
	var fs = obj.FileSystem;
	fs.ClearDirectory(LEAP.DocumentView.WordEditor.getDownFilePath(obj));
		
	var kwoHttpGet = 0;
	var kwoHttpPost = 1;
	var httpclient = obj.Http;
	httpclient.Clear();
	httpclient.ShowProgressUI = true;
	httpclient.Hidden = false;
	// 异步下载先调用OnSendEnd(),再调用OnRecEnd()
	var info = httpclient.Open(kwoHttpGet,Url, false);
	if (info) 
	{
		var send = httpclient.Send();
		if (send) 
		{
			if (httpclient.Status == 200) 
			{	
				var _u = Url.split("?")[0];
				var FileName = LEAP.DocumentView.WordEditor.getDownFilePath(obj) + UUID.randomUUID().replaceall('-', '') + _u.substring(_u.lastIndexOf("."));
				//保存到本地
				httpclient.ResponseSaveToFile(FileName);
				httpclient.Close();
				//"下载成功";
				return FileName;
			}
			else
			{
				//"下载失败请检查URL是否正确";
				return null;
			}
		}
		else
		{
        	 //"数据包发送失败";
        	 return null;
		}
	}
	else
	{
    	 //"打开连接失败";
    	 httpclient.Clear();
    	 return null;
	}
}

LEAP.DocumentView.WordEditor.handleWordOpenedEvent = function(id)
{
	try
	{
		var obj = document.getElementById(id);
		
		if (obj['___h'])
		{
			var e = LEAP._match(obj, LEAP.DocumentView.d);
			LEAP.DocumentView.WordEditor.openDocAfter(e);
		}
	}
	finally
	{
		obj = e = null;
	}
}

LEAP.DocumentView.WordEditor.getUserConfig = function(e)
{
	if (LEAP.DocumentView.WordEditor.userconfig == null)
	{
		var module = LWFP.innerApi.getmodule(e);
		//LEAP.DocumentView.WordEditor.userconfig = module.request2({name:'lbcp_getControlPaneBean'});
		//if (!LEAP.DocumentView.WordEditor.userconfig)
		{
			LEAP.DocumentView.WordEditor.userconfig = {wordcorrections:1};			
		}
		LEAP.DocumentView.WordEditor.userconfig.username = LEAP.getUserInfo().fullName;	
		LEAP.DocumentView.WordEditor.userconfig.lock = module.request2({name:'lbcp_getOfficeWordLock'});
		if (!LEAP.DocumentView.WordEditor.userconfig.lock)
			LEAP.DocumentView.WordEditor.userconfig.lock = "Longrise123456789";
	}
	
	return LEAP.DocumentView.WordEditor.userconfig;
}

/**
 * 执行操作
 * @param {} e
 * @param {} param 
 * 			{
 * 				buttons:更改要显示的功能按钮，按钮代码逗号分隔，如： "submit,saveAs"
 * 						 按钮代码： submit保存 saveAs另存为 print打印 showMark显示痕迹 hideMark隐藏痕迹 importDoc导入文件 doHandSign加入手写签批 
 * 								doHandSecSign加入手写签名 taohong正文套红 addServerSign添加服务器签章 addServer2Sign2添加服务器签章
								safeDoc锁定文件 deleteSafe取消锁定 ConvertPDF转为PDF格式 close关闭 fullscreen全屏 
 * 			}
 */
LEAP.DocumentView.WordEditor.oprate = function(e, param)
{
	try
	{
		if (param && param.buttons)
		{
			var btns = param.buttons;
				
			var _arr = LEAP.getElements("a[at=1]", e);
			for(var i=0; i<_arr.length; i++)
			{	
				var _a = _arr[i];
				var _al = _a.getAttribute('al');
				if (btns.indexOf(_al) >=0)
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
					
				if (_al == 'fullscreen')
				{
					_a.style.display = 'block';
				}
				else if (_al == 'close')
				{
					if (e.getAttribute('newwindow') == "1")
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
		}
	}
	finally
	{
		btns = _arr = i = _a = _al = null;
	}
}

LEAP.DocumentView.WordEditor.openDocAfter = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return null;
			
		obj.style.marginTop = "0px";
		obj.style.height = "100%";
		
		var hashchange = false; //加载后判断文档的show
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
			
		var btns = "saveAs,print,showMark,hideMark,";
		if (readonly == false)
			btns += "submit,";
		
		if (data.doctype < 0) //正文才使用正文按钮
		{
			if (data && data.param && data.param.wordButton && data.param.wordButton != "")
				btns = data.param.wordButton;
		}
		
		if (readonly == true)
		{
			btns = btns.replace("submit", "").replace("ConvertPDF", "")
			.replace("ConvertOFD", "").replace("addServerSign", "").replace("taohong", "")
			.replace("addServer2Sign2", "")
			.replace("updatename", "").replace("importDoc", "");			
		}
		
		if(obj.DocType == 3 || obj.DocType == 2)
			btns = btns.replace("showMark", "").replace("hideMark", "");
			
		var _arr = LEAP.getElements("a[at=1]", e);
		for(var i=0; i<_arr.length; i++)
		{	
			var _a = _arr[i];
			var _al = _a.getAttribute('al');
			if (btns.indexOf(_al) >=0)
			{
				_a.style.display = 'block';
				
				if (_al == 'updatename')
				{
					if (readonly == false)
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
			else
			{
				_a.style.display = 'none';
			}
				
			if (_al == 'fullscreen')
			{
				_a.style.display = 'block';
			}
			else if (_al == 'close')
			{
				if (e.getAttribute('newwindow') == "1")
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
			}
		}
		
		//3=PowerPoint.Show
		if(obj.DocType == 3)
			return;
				
		var userConfig = LEAP.DocumentView.WordEditor.getUserConfig(e);

		obj.ActiveDocument.Application.UserName = LEAP.DocumentView.WordEditor.userconfig.username;
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{}
		else
		{
			/*if (obj.ActiveDocument && obj.ActiveDocument.ShowRevisions)
			{				
				obj.ActiveDocument.ShowRevisions = (LEAP.DocumentView.WordEditor.userconfig.wordcorrections==1)?true:false;				
			}*/
			
			/*if (obj.ActiveDocument && obj.ActiveDocument.ShowRevisions == true)
			{				
				obj.ActiveDocument.ShowRevisions = false;
			}*/
			
			if (obj.ActiveDocument)
			{
				if (LEAP.DocumentView.WordEditor.userconfig && LEAP.DocumentView.WordEditor.userconfig.wordcorrections==1)
				{
					if (obj.ActiveDocument.ShowRevisions)
						obj.ActiveDocument.ShowRevisions = false;
					//if (obj.ActiveDocument.ActiveWindow && obj.ActiveDocument.ActiveWindow.View)
					//	obj.ActiveDocument.ActiveWindow.View.SplitSpecial = 20;
				}
				else
				{
					if (obj.ActiveDocument.ShowRevisions)
						obj.ActiveDocument.ShowRevisions = false;
					/*if (obj.ActiveDocument.ActiveWindow && obj.ActiveDocument.ActiveWindow.View)
						obj.ActiveDocument.ActiveWindow.View.SplitSpecial = 18;*/
				}
			}
		}
		
				
		var doctype = obj.DocType;//控件类型
		// this.obj.ActiveDocument.ProtectionType =-1 表示文档正常. 2表示文档被锁定
		if (obj.ActiveDocument.ProtectionType == 2) 
		{		
			obj.SetReadOnly(false, "");
			obj.Titlebar = false;	// 标题栏
			obj.Menubar = true;		// 菜单栏
			obj.Statusbar = false;	// 状态栏		
			obj.FileNew = false;	// 新建按钮
			obj.FileOpen = false;	// 打开按钮
			obj.FileClose = false;	// 关闭按钮
			obj.FileSave = false;	// 保存按钮
			obj.IsShowToolMenu = false;	//工具菜单
			//obj.ActiveDocument.Application.UserName = username;
			if (doctype == 1)//doctype=1:word
			{	
				obj.ActiveDocument.CommandBars("Reviewing").Enabled = true;
				obj.ActiveDocument.CommandBars("Track Changes").Enabled = true;	
			}
			else //doctype=6 : wps
			{
				//obj.ActiveDocument.Application.CommandBars("Reviewing").Enabled = true;
				//obj.ActiveDocument.Application.ActiveWindow.View.ShowRevisionsAndComments=true;
			}			
			obj.IsShowToolMenu = true;			
			obj.SetReadOnly(true, "");	
		} 
		else 
		{
			obj.SetReadOnly(false, "");			
			obj.Titlebar = false;// 标题栏			
			obj.Menubar = true;// 菜单栏			
			obj.Statusbar = false;// 状态栏			
			obj.FileNew = false;// 新建按钮			
			obj.FileOpen = false;// 打开按钮			
			obj.FileClose = false;// 关闭按钮			
			obj.FileSave = false;// 保存按钮				
			obj.IsShowToolMenu = false;// 工具菜单			
			if (doctype == 1)//doctype=1:word
			{	
				obj.ActiveDocument.CommandBars("Reviewing").Enabled = true;
				obj.ActiveDocument.CommandBars("Track Changes").Enabled = true;
				obj.ActiveDocument.TrackRevisions = true;
				obj.IsShowToolMenu = true;
			}
			else //doctype=6 : wps
			{				
				//TODO check obj.ActiveDocument.Application.CommandBars("Reviewing").Enabled = true;
				//obj.ActiveDocument.Application.CommandBars("Reviewing").Enabled = true;
				//obj.ActiveDocument.Application.ActiveWindow.View.ShowRevisionsAndComments=true;
				//obj.ActiveDocument.TrackRevisions = true;
			}
		}
				
		obj.Menubar = false;
		obj.BorderStyle = 0;
				
		//设置word缩放比例
		//obj.ActiveDocument.ActiveWindow.ActivePane.View.Zoom.Percentage = 70	

		//添加水印
		LEAP.DocumentView.WordEditor.___addWaterMaker(e, obj);
				
		
		
		ElementEventManager.handleEvent(e, "onDocumentLoad");
		
		LEAP.DocumentView.WordEditor.__initTemplateValue(e);
		
		//防止空文档被保存
		obj.ActiveDocument.saved = true;
		
		LEAP.asyn(LEAP.DocumentView.WordEditor.___resize, this, 900, e, obj.ActiveDocument.saved);
	}
	catch(err)
	{
		if(err.number!=-2147467260)
			alert("错误：" + err.number + ":" + err.description);		
	}
	finally
	{		
		obj = data = readonly = btns = _arr = i = _a = _al = userConfig = doctype = null;
	}
}

LEAP.DocumentView.WordEditor.___addWaterMaker = function(e, activexObj)
{
	try
	{
		if (window._showmark != '0')
		{
			//var module = LEAP.DocumentView.__getmodule(e);
			//if (module && module.officeWaterMark == true)
			{
				try
				{
					if (activexObj.DocType == 2)
					{//excel
						//TDDO
					}
					else
					{//word
						/*activexObj.ActiveDocument.Background.Fill.Transparency = 0;
			    		activexObj.ActiveDocument.Background.Fill.UserTextured(leapconfig.server + LEAP.getWaterMark());
			    		activexObj.ActiveDocument.ActiveWindow.View.DisplayBackgrounds = true;*/
			    		
			    		activexObj.ActiveDocument.Background.Fill.Transparency = 0;
			    		activexObj.ActiveDocument.Background.Fill.UserPicture(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + LEAP.getWaterMark());
			    		activexObj.ActiveDocument.ActiveWindow.View.DisplayBackgrounds = true;
			    		
			    		activexObj.ActiveDocument.saved = true;
					}
				}
				catch(e)
				{}    		
			}
		}
	}
	finally
	{
		
	}
}

LEAP.DocumentView.WordEditor.___delWaterMaker = function(e, activexObj)
{
	try
	{
		if (activexObj.DocType == 2)
		{
			//TODO excel
		}
		else
		{	//word
			activexObj.ActiveDocument.Background.Fill.Visible = false;
		}
	}
	catch(e){}
}

LEAP.DocumentView.WordEditor.___resize = function(e, saved)
{
	try
	{
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.isOpenWindow == true)
		{
			var top = LEAP.getElement("[ar=top]", e);
			var bottom = LEAP.getElement("[ar=bottom]", e);
		
			bottom.style.height = (e.clientHeight - top.clientHeight) + 'px';
		}
		
		if (saved != null)
			LEAP.getElement('[ctf=officeobj]').activeDocument.saved = saved;
			
			
		var str = "<div style='text-align:left; width:440px; padding:2px 10px 2px 10px; color:red;'>" +
					"温馨提示：为避免因长时间未操作导致连接超时引起工作丢失，请及时保存文件！" +
					"</div>"
												
		LEAP.smallTip.show(str, document.body.clientWidth-570, 5, null);
		
	}
	finally
	{
		top = bottom = null;
	}
}

LEAP.DocumentView.WordEditor.__initTemplateValue = function(e)
{//////
	try
	{	
		//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
		//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);
	
		if (e[LEAP.DocumentView.n].param == null || e[LEAP.DocumentView.n].param.templateValues == null)
			return;
			
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
		
		var flag = false;
		if (obj.ActiveDocument.ProtectionType == 2)
		{
			flag = true;
			//obj.SetReadOnly(false, "");	
			obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.WordEditor.userconfig.lock);
		}
			
		LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

		if (obj.ActiveDocument.BookMarks)
		{
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			for (var i=0; i<bookMarkslist.length;i++)
			{
				if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
				{
					var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
	        			bookRange.text = bookMarkslist[i][1];
	        			
	        		obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Delete;
				}
			}	
		}
		
		LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		
		if (flag == true)
			obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.WordEditor.userconfig.lock);
	}
	finally
	{
		obj = bookMarkslist = i = null;
	}	
}

LEAP.DocumentView.WordEditor.buttonClick = function(e, al)
{
	if (al == "submit")
	{
		LEAP.DocumentView.WordEditor.save(e);
	}
	else if (al == "saveAs")
	{
		LEAP.asyn(LEAP.DocumentView.WordEditor.saveLocal, this, 0, e);		
		//LEAP.DocumentView.WordEditor.saveLocal(e);
	}
	else if (al == "print")
	{
		LEAP.DocumentView.WordEditor.printDoc(e);
	}
	else if (al == "showMark")
	{
		LEAP.DocumentView.WordEditor.showRevisions(e);
	}
	else if (al == "hideMark")
	{
		LEAP.DocumentView.WordEditor.hideRevisions(e);
	}
	else if (al == "importDoc")
	{
		LEAP.DocumentView.WordEditor.importdoc(e);
	}
	else if (al == "doHandSign")
	{
		LEAP.DocumentView.WordEditor.doHandSign(e);
	}
	else if (al == "doHandSecSign")
	{
		LEAP.DocumentView.WordEditor.doHandSecSign(e);
	}
	else if (al == "addServerSign")
	{
		LEAP.DocumentView.WordEditor.addServerSign(e);
	}
	else if (al == "addServer2Sign2")
	{
		LEAP.DocumentView.WordEditor.addServerSign2(e);
	}
	else if (al == "taohong")
	{
		LEAP.DocumentView.WordEditor.taohong(e);
	}
	else if (al == "safeDoc")
	{
		LEAP.DocumentView.WordEditor.safeDoc(e);
	}
	else if (al == "deleteSafe")
	{
		LEAP.DocumentView.WordEditor.deleteSafe(e);
	}
	else if (al == "fullscreen")
	{
		LEAP.DocumentView.WordEditor.fullscreen(e);
	}
	else if (al == "ConvertPDF")
	{
		LEAP.DocumentView.WordEditor.ConvertToPDF(e);
	}
	else if (al == "close")
	{
		LEAP.DocumentView.WordEditor.close(e);
	}
	else if (al == 'pdf_create')
	{
		LEAP.DocumentView.PdfEditor.save(e, false);
	}
	else if (al == 'pdf_print')
	{
		LEAP.DocumentView.printDoc(e);
	}
	else if (al == 'pdf_saveAs')
	{
		LEAP.DocumentView.PdfEditor.saveAs(e);
	}
	else if (al == 'pdf_close')
	{
		LEAP.DocumentView.PdfEditor.close(e);
	}
	else if (al == "updatename")
	{
		LEAP.DocumentView.WordEditor.updatename(e);
	}
	
	//TODO "","","","close","blank"
	
}

LEAP.DocumentView.WordEditor.updatename = function(arg)
{
	try
	{
		if (arg.arg == null)
		{
			var e = arg;
			var _formElement = null;
			var _txt = null;
			var _btn = null;
			if (LEAP.DocumentView.WordEditor.udpform == null)
			{
				LEAP.DocumentView.WordEditor.udpform = LEAP.form.create3({name:null, title:'修改文件名', width:500, height:150, formtype:3});
				
				var str = '<div style="height:100%; width:100%;">';
					str += '<input ut="filename" class="LC_input_conner" style="width:97%; margin:10px 2% 10px 1%;" lcv="2" mdtype="text" bt="text" ht="input">';
					str += '<input ut="submit" class="LC_button_conner LC_button_blue" style="float:right; margin:0px 30px 0px 0px;" type="button" value="确定" lcv="2" ht="input">'
					str += '</div>'
					
				LEAP.form.setContent(LEAP.DocumentView.WordEditor.udpform.form, str);
				
				_formElement = LEAP.getElement(LEAP.DocumentView.WordEditor.udpform.form);
				LEAP.DocumentView.WordEditor.udpform._txt = LEAP.getElement("input[ut=filename]", _formElement);
				_btn = LEAP.getElement("input[ut=submit]", _formElement);
				LEAP.addEvent(_btn, 'click', LEAP.DocumentView.WordEditor.updatename, {iscallback:true});
			}
			
			var title = "";
			if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
				title = e.getAttribute('defaultName') ? e.getAttribute('defaultName') : ""; 
			else
				title = e[LEAP.DocumentView.n].attachment.title;

			LEAP.DocumentView.WordEditor.udpform.FileName = title;
			LEAP.DocumentView.WordEditor.udpform._txt.value = title;
			LEAP.DocumentView.WordEditor.udpform.ele = e;
						
			LEAP.form.show(LEAP.DocumentView.WordEditor.udpform.form);	
		}
		else
		{
			var _title = LEAP.DocumentView.WordEditor.udpform._txt.value.trim();
			if (_title == '')
			{
				alert('文件名不可为空！');
				return;
			}
			if ((_title.indexof('\\')>=0) || 
				(_title.indexof('/')>=0) ||
				(_title.indexof(':')>=0) ||
				(_title.indexof('*')>=0) ||
				(_title.indexof('?')>=0) ||
				(_title.indexof('"')>=0) ||
				(_title.indexof('<')>=0) ||
				(_title.indexof('>')>=0) ||
				(_title.indexof('|')>=0) )			
			{
				alert('文件名不可包含如下字符： \\ / : * ? " < > |');
				return;
			}
			
			LEAP.form.hide(LEAP.DocumentView.WordEditor.udpform.form);
		
			var e = LEAP.DocumentView.WordEditor.udpform.ele;
			if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
			{
				e.setAttribute('defaultName', _title);
			}
			else
			{
				var att = e[LEAP.DocumentView.n].attachment;
				att.title = _title;
				if (att.updateType == null)
					att.updateType = 1;
				
				LEAP.DocumentView.valueChange(e, att);				
			}
		}
	}
	finally
	{
		e = _formElement = _txt = _btn = str = title = _title = e = att = null;
	}
}

LEAP.DocumentView.WordEditor.save = function(e, __alertResult)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (!obj)
			return false;
		
		if (!obj.ActiveDocument)
			return true;
			
		//if (obj.ActiveDocument.saved == true)
		//	return true;
		
		//obj.ActiveDocument.TrackRevisions = true;
			
		LEAP.DocumentView.WordEditor.___delWaterMaker(e, obj);
		
		var res;
		
		if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
		{
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc2?isnew=1&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid(); 
			
			url += '&uploadpath=' + encodeURIComponent(e.getAttribute('uploadpath')?e.getAttribute('uploadpath'):"default") + '&viewname=' + encodeURIComponent('new.doc');			
			
			res = obj.SaveToURL(url, 'DocFile', '', 'NewDoc.doc', 0, false); 			
		}
		else
		{
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc?' 
					+ 'namedpath=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) 
					+ '&name=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name)
					+ '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid(); 
					
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
				url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);	
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
				url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
				url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
				url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
				url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
					
			res = obj.SaveToURL(url, 'DocFile', '', 'NewDoc.doc', 0, false);
		}
		
		if (res)
		{
			res = eval("[" + res + "]");
			res = res[0];
			if (res.result == true)
			{
				var callbackAtt_AfterDraft = null;
				var m = PageObjectModel.getModule(e.getAttribute('instance'));				
				if (e[LEAP.DocumentView.n].isnew == true)
				{
					var _att={};
						_att.fileid = res.fileid;
						_att.atttype = e[LEAP.DocumentView.n].doctype;
						_att.title = e.getAttribute('defaultName') ? e.getAttribute('defaultName') : "新建正文"; 
						_att.name = res.name;
						_att.namedpath = res.namedpath;
						_att.updateType = 0;
						_att.ownername = LEAP.getUserInfo().fullName;				
						_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
						_att.canDelete = true;
						_att.canEdit = true;
						_att.attsize = res.attsize;
					
					if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.draftTemplateUrl != null)
						callbackAtt_AfterDraft = _att;
						
					LEAP.DocumentView.valueChange(e, _att);
				}
				
				if (__alertResult == false){} else alert("保存成功");
								
				if(m)
				{
					if (m.afterDraft && callbackAtt_AfterDraft != null)
					{
						try
						{
							m.afterDraft({draftFile:callbackAtt_AfterDraft, action:"afterDraft"});
						}
						catch(ex){}
					}
					else if (m.wordEditorCallback)
					{
						try
						{
							m.wordEditorCallback({data:res, action:"onWordEditorSave"});
						}
						catch(ex){}
					}
				}			
				
				obj.ActiveDocument.saved = true;
				
				return true;	
			}
			else
			{
				alert("保存失败:" + res.msg);
			}
		}
		else
		{
			if (__alertResult==false){}else alert("保存失败!");
			return false;
		}
	}
	catch(e)
	{}
	finally
	{
		LEAP.DocumentView.WordEditor.___addWaterMaker(e, obj);
		if (obj.ActiveDocument)
			obj.ActiveDocument.saved = true;
		obj = res = url = _att = null;
	}
}

LEAP.DocumentView.WordEditor.saveLocal = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj || !obj.ActiveDocument)
			return;
		
		if (!LEAP.DocumentView.DocumentEditor || LEAP.DocumentView.DocumentEditor.saveAsWithWaterMaker != true)
		{
			LEAP.DocumentView.WordEditor.___delWaterMaker(e, obj);
		}
		obj.ShowDialog(3);	    	
	}
	finally
	{
		if (!LEAP.DocumentView.DocumentEditor || LEAP.DocumentView.DocumentEditor.saveAsWithWaterMaker != true)
		{
			LEAP.DocumentView.WordEditor.___addWaterMaker(e, obj);
		}
		obj = null;
	}
}
 
LEAP.DocumentView.WordEditor.printDoc = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj || !obj.ActiveDocument)
			return;
			
		LEAP.DocumentView.WordEditor.___delWaterMaker(e, obj);
		obj.ShowDialog(4);
		

	}
	catch(e)
	{
		//alert("打印失败：请确保打印机已经开启，并且打印服务已经启动！");
	}
	finally
	{
		LEAP.DocumentView.WordEditor.___addWaterMaker(e, obj);
		obj = null;
	}
}

LEAP.DocumentView.WordEditor.showRevisions = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj || !obj.ActiveDocument)
			return;
		
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
 		obj.ActiveDocument.ShowRevisions =true;
 		obj.ActiveDocument.ActiveWindow.View.SplitSpecial = 19;
 		
	}
	finally
	{
		obj = null;
	}
}
 
LEAP.DocumentView.WordEditor.hideRevisions = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if(!obj.ActiveDocument)
			return;
		
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
 		obj.ActiveDocument.ShowRevisions = false;
 		obj.ActiveDocument.ActiveWindow.View.SplitSpecial = 18;
	}
	finally
	{
		obj=null;
	}
}
 
LEAP.DocumentView.WordEditor.importdoc = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
			
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}

		if(obj.AddTemplateFromLocal)
			obj.AddTemplateFromLocal("", true, true);	
		else
			obj.ShowDialog(1);
		
		//加个空格解决saved状态不能修改的问题
		obj.ActiveDocument.Application.Selection.EndKey(6);
		obj.ActiveDocument.Application.Selection.Range.InsertAfter(" ");
		
			
		//obj.ActiveDocument.saved = false;
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WordEditor.doHandSign = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
			
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
		obj.DoHandSign2(
				LEAP.DocumentView.WordEditor.userconfig.username,	// 手写签名用户名称
				"longrise",	// signkey,DoCheckSign(检查印章函数)需要的验证密钥。
				0,// left
				0,// top
				0,// relative,设定签名位置的参照对象.0：表示按照屏幕位置插入，此时，Left,Top属性不起作用。1：光标位置；2：页边距；3：页面距离
					// 4：默认设置栏，段落（为兼容以前版本默认方式）
				100);
		
		obj.HandSign2PenWidth=3; //设置笔宽 取值1－15
		obj.HandSign2Relative=1; //设置全屏签名相对位置。0：相对屏幕。1：相对光标。
		obj.HandSign2Color =000000;    //00255RGB   说明：OLE_COLOR是一个BGR (Blue, Green, Red)数值。BGR value = (blue * 65536) + (green * 256) + red
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WordEditor.doHandSecSign = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
			
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
		obj.AddSecHandSign(LEAP.DocumentView.WordEditor.userconfig.username,10,10,1,1,true,false,true,false,"",false,true);
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WordEditor.addServerSign = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
			
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
		var module = LWFP.innerApi.getmodule(e);
		var signets = module.request2({name:'lbcp_getSignetByUser'});
		
		if(!signets)
		{
			alert("暂无可用的个人印章，请先配置对应的个人印章！");
			return;
		}
		
		var server = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e));
		var path = window.showModalDialog(server + "LEAP/LBCP/lbcpconfig/lbcpsignetmould/lbcpsignetshow.html",
							signets,
							"dialogWidth=500px;dialogHeight=100px;status:no;scroll:no;");
		if(!path)
		{
			alert("未找到服务器印章文件，请检查个人印章配置是否正确！")
			return;
		}
		else
		{
			var signUri = JSON.parse(path);
			var signUrl_ = server + "LEAP/Download/" + signUri.nameedPath + "/" + signUri.name;
			obj.AddSecSignFromURL(LEAP.DocumentView.WordEditor.userconfig.username, signUrl_,0,0,1,2,false,false,true,false,'',false);
		}
		
	}
	finally
	{
		obj = signets = path = signUrl_ = server = null;
	}
}

LEAP.DocumentView.WordEditor.addServerSign2 = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
			
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
		var module = LWFP.innerApi.getmodule(e);
		var signets = module.request2({name:'lbcp_getSignetByUser'});
		
		if(!signets)
		{
			alert("暂无可用的个人印章，请先配置对应的个人印章！");
			return;
		}
		
		var server = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e));
		var path = window.showModalDialog(server + "LEAP/LBCP/lbcpconfig/lbcpsignetmould/lbcpsignetshow.html",
							signets,
							"dialogWidth=500px;dialogHeight=100px;status:no;scroll:no;");
		if(!path)
		{
			alert("未找到服务器印章文件，请检查个人印章配置是否正确！")
			return;
		}
		else
		{
			var signUri = JSON.parse(path);
			var signUrl_ = server + "LEAP/Download/" + signUri.nameedPath + "/" + signUri.name;
			obj.AddSecSignFromURL(LEAP.DocumentView.WordEditor.userconfig.username, signUrl_,0,0,1,2,false,false,false,false,'',false);
		}
		
	}
	finally
	{
		obj = signets = path = signUrl_ = server = null;
	}
}

LEAP.DocumentView.WordEditor.taohong = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
			
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
		var module = LWFP.innerApi.getmodule(e);
		var templates = null;
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.businessNo)
			templates = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:e[LEAP.DocumentView.n].param.businessNo}});
		
		if(!templates)
		{
			alert("暂无可用套红模板，请先在模板配置中进行设置！");
			return ;
		}
		
		if (LEAP.DocumentView.WordEditor.templateForm == null)
		{
			LEAP.DocumentView.WordEditor.templateForm = LEAP.form.create3({name:null, title:'选择套红模板', width:550, height:330, formtype:3});
			var str = '<select ut="templates" size=5 style="width:100%; height:230px; font-size:16px; border:none; border-bottom:1px solid #ccc; padding:5px;"></select>';
				str += '<br/>';
				str += '<button ut="btn_confirm" type="button" class="LC_button_blue LC_button_conner" style="float:right; margin:10px 30px; font-size:14px; padding:5px 20px;">套&nbsp;&nbsp;红</button>';
				str += '<button ut="btn_cancel" type="button" class="LC_button_blue LC_button_conner" style="float:right; margin:10px 10px; font-size:14px; padding:5px 20px;">取&nbsp;&nbsp;消</button>';
				
			LEAP.form.setContent(LEAP.DocumentView.WordEditor.templateForm.form, str);
			
			var _fe = LEAP.getElement(LEAP.DocumentView.WordEditor.templateForm.form);
			
			var btn_confirm = LEAP.getElement("[ut=btn_confirm]", _fe);
			var btn_cancel = LEAP.getElement("[ut=btn_cancel]", _fe);
			
			LEAP.addEvent(btn_confirm, 'click', LEAP.DocumentView.WordEditor.taohong_step2);
			LEAP.addEvent(btn_cancel, 'click', LEAP.DocumentView.WordEditor.taohong_step2);	
		}
		
		var _formElement = LEAP.getElement(LEAP.DocumentView.WordEditor.templateForm.form);
		var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
		if (icon)
		{
			icon.style.display = "none";		
		}
		var fbody = LEAP.getElement("[ctf=form_backcolor]", _formElement);
		if (fbody)
		{
			fbody.style.backgroundColor = "rgba(205, 227, 249, 1)"; 
			fbody.style.height = "97%";
		}
		
		var select = LEAP.getElement("[ut=templates]", _formElement);
		select.innerHTML = "";
		for(var i=0; i<templates.result.length; i++)
		{
			var tmp = templates.result[i];		
			var myOption = document.createElement("option"); //动态创建option标签
				myOption.style.margin = "4px 5px";
	            myOption.value = tmp.templatename; //红头文档id
	            myOption.text = tmp.templatename; //红头文档名称
	            myOption["data"] = tmp;
	            
			select.add(myOption);			
		}
		
		
		LEAP.DocumentView.WordEditor.templateForm.ele = e;
		LEAP.form.show(LEAP.DocumentView.WordEditor.templateForm.form);	
	
	}
	finally
	{
		obj=templates=i=null;
	}
}

LEAP.DocumentView.WordEditor.taohong_step2 = function(arg)
{
	try
	{
		LEAP.form.hide(LEAP.DocumentView.WordEditor.templateForm.form);
		
		var e = LEAP.DocumentView.WordEditor.templateForm.ele;
		
		var btn = arg.e.srcElement;
		if (btn.getAttribute("ut") == "btn_cancel")
		{
			LEAP.form.hide(LEAP.DocumentView.WordEditor.templateForm.form);	
		}
		else
		{
			var _formElement = LEAP.getElement(LEAP.DocumentView.WordEditor.templateForm.form);
			var select = LEAP.getElement("[ut=templates]", _formElement);

		    var index = select.selectedIndex;
		    if (index == -1) { //添加未选中数据时的异常处理
		        LEAP.DocumentView.WordEditor.__alert(e, "请先选择红头文件后再进行套红头！");
		        return;
		    }		    
		    var selectedTemplate = select.options[index]["data"];
    		
			LEAP.DocumentView.WordEditor.taohong_step3(e, selectedTemplate);
		}
	}
	finally
	{
		
	}
}

LEAP.DocumentView.WordEditor.taohong_step3 = function(e, template) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;		
			
		

		if (template.mode && template.mode == 2)		
		{
			var ret = LEAP.DocumentView.WordEditor.save(e,false);
			if(ret == false)
				return;
			
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
			//定位到第一行
			obj.ActiveDocument.Application.Selection.HomeKey(6);
			//obj.ActiveDocument.Words(1).Select();
			//obj.ActiveDocument.Application.Selection.Paste();
			
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			obj.AddTemplateFromURL(templatepath);
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
		        			bookRange.text = bookMarkslist[i][1];	
		        		obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Delete();
					}
				}		
			}
			
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态		
			obj.ActiveDocument.saved = false;
		}
		else
		{
			var WshShell = new ActiveXObject("WScript.Shell"); 
			var path = WshShell.SpecialFolders("AppData") + "\\tmp.docx";			
			path = path.replaceall("\\", "\\\\");
			
			obj.SaveToLocal(path, true);
				
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
			obj.OpenFromURL(templatepath);
			
			var BookMarkName = "zhengwen";
			if(!obj.ActiveDocument.BookMarks.Exists(BookMarkName))
			{
				alert("红头模板中不存在正文(书签名：zhengwen)书签！");
				return;
			}
			var bkmkObj = obj.ActiveDocument.BookMarks(BookMarkName);	
			var saverange = bkmkObj.Range;
			saverange.Select();
			
			obj.AddTemplateFromLocal(path, false, true);
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			//模板打开后，openAfter里面已经替换了书签，不需要再替换
			/*if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
        					bookRange.text = bookMarkslist[i][1];
					}
				}		
			}*/
			
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态		
			obj.ActiveDocument.saved = false;
				
			/*// 拼凑套红模板的路径
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			// 选择对象当前文档的所有内容
			var curSel = obj.ActiveDocument.Application.Selection;
			var view_ = obj.ActiveDocument.Application.ActiveWindow.View;
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			curSel.WholeStory();
			curSel.Cut();
			
			// 插入模板
			//attachmentOfficeObj.AddTemplateFromURL(templatepath);//把所有内容剪切后，插入红头模板，有时会造成红头模板字体等格式丢失
			//打开红头模板,用此方法打开，会保留红头模板所有格式，有个小问题，如果需要打开原始正文，须关闭窗口，重新打开。
				
			obj.OpenFromURL(templatepath);
							
			var BookMarkName = "zhengwen";
			if(!obj.ActiveDocument.BookMarks.Exists(BookMarkName))
			{
				alert("红头模板中不存在正文(书签名：zhengwen)书签！");
				return;
			}
			var bkmkObj = obj.ActiveDocument.BookMarks(BookMarkName);	
			var saverange = bkmkObj.Range;
			var fontName = saverange.Font.Name;//取得正文书签字体类型
			var fontSize = saverange.Font.Size;//取得正文书签字体大小
			saverange.Paste();
			obj.ActiveDocument.Bookmarks.Add(BookMarkName,saverange);//此方法会导致书签格式丢失
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
				e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
        					bookRange.text = bookMarkslist[i][1];
					}
				}		
			}
			
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态		
*/		}

		LEAP.asyn(LEAP.DocumentView.WordEditor.___resize, this, 1000, e, false);
		
	}
	finally
	{
		obj=templatepath= curSel=view_=BookMarkName=bkmkObj=saverange=bookMarkslist=i=null;
	}
}




/*
LEAP.DocumentView.WordEditor.taohong = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
			
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
		var module = LWFP.innerApi.getmodule(e);
		var templates = null;
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.businessNo)
			templates = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:e[LEAP.DocumentView.n].param.businessNo}});
		
		if(!templates)
		{
			alert("暂无可用套红模板，请先在模板配置中进行设置！");
			return ;
		}

		var template = window.showModalDialog(window.geturl(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/Default/wordtempleate/lbcptemplateshow.html"),
												templates.result,"dialogWidth=500px;dialogHeight=100px;status:no;scroll:no;");
		if(!template)
			return;
		
		
		if (template.mode && template.mode == 2)		
		{
			var _url = LEAP.DocumentView._getPath(e[LEAP.DocumentView.n].attachment, e);			
			LEAP.DocumentView.WordEditor.save(e,false);
			if(!_url)
			{
				_url = LEAP.DocumentView._getPath(e[LEAP.DocumentView.n].attachment, e);
			}
			
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			obj.OpenFromURL(templatepath);
			
				
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
				e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
		        			bookRange.text = bookMarkslist[i][1];						
					}
				}		
			}
			
			var curSel = obj.ActiveDocument.Application.Selection;
			var view_ = obj.ActiveDocument.Application.ActiveWindow.View;			
			curSel.WholeStory();
			curSel.Copy();
			
			obj.OpenFromURL(_url);
				
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
			//定位到第一行
			obj.ActiveDocument.Application.Selection.HomeKey(6);
			obj.ActiveDocument.Words(1).Select();
			obj.ActiveDocument.Application.Selection.Paste();
			
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		}
		else
		{
			// 拼凑套红模板的路径
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			// 选择对象当前文档的所有内容
			var curSel = obj.ActiveDocument.Application.Selection;
			var view_ = obj.ActiveDocument.Application.ActiveWindow.View;
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			curSel.WholeStory();
			curSel.Cut();
			
			// 插入模板
			//attachmentOfficeObj.AddTemplateFromURL(templatepath);//把所有内容剪切后，插入红头模板，有时会造成红头模板字体等格式丢失
			//打开红头模板,用此方法打开，会保留红头模板所有格式，有个小问题，如果需要打开原始正文，须关闭窗口，重新打开。
				
			obj.OpenFromURL(templatepath);
							
			var BookMarkName = "zhengwen";
			if(!obj.ActiveDocument.BookMarks.Exists(BookMarkName))
			{
				alert("红头模板中不存在正文(书签名：zhengwen)书签！");
				return;
			}
			var bkmkObj = obj.ActiveDocument.BookMarks(BookMarkName);	
			var saverange = bkmkObj.Range;
			var fontName = saverange.Font.Name;//取得正文书签字体类型
			var fontSize = saverange.Font.Size;//取得正文书签字体大小
			saverange.Paste();
			obj.ActiveDocument.Bookmarks.Add(BookMarkName,saverange);//此方法会导致书签格式丢失
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
				e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
        					bookRange.text = bookMarkslist[i][1];
					}
				}		
			}
			
			LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态		
		}		
	}
	finally
	{
		obj=templates=templatepath= curSel=view_=BookMarkName=bkmkObj=saverange=bookMarkslist=i=null;
	}
}*/

LEAP.DocumentView.WordEditor.setBookmarkValues = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;

		LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
		//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
		//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			

		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
		{
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			for (var i=0; i<bookMarkslist.length;i++)
			{
				if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
				{
					var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
        				bookRange.text = bookMarkslist[i][1];
				}
			}		
		}
		
		LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		
		return true;
	}
	finally
	{
		obj = bookMarkslist = i = null;
	}
}

//进入或退出强制痕迹保留状态，调用该函数下面定义的两个函数。一般可直接调用本函数。
LEAP.DocumentView.WordEditor.TANGER_OCX_SetMarkModify = function(e, boolvalue)
{	   
   	LEAP.DocumentView.WordEditor.TANGER_OCX_SetReviewMode(e, boolvalue);   
   	LEAP.DocumentView.WordEditor.TANGER_OCX_EnableReviewBar(e, !boolvalue);
}

//允许或禁止显示修订工具栏和工具菜单（保护修订,用户不能更改当前修订状态)
LEAP.DocumentView.WordEditor.TANGER_OCX_EnableReviewBar = function(e, boolvalue)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (obj.ActiveDocument)
		{	
			//兼容WORD/WPS
			try
			{
				obj.ActiveDocument.CommandBars("Reviewing").Enabled = boolvalue;
				obj.ActiveDocument.CommandBars("Track Changes").Enabled = boolvalue;
			}catch(e){}
			try{
			//if (obj.ActiveDocument.Application)
				//obj.ActiveDocument.Application.ActiveWindow.View.ShowRevisionsAndComments = boolvalue;
			}catch(e){}
		}
		
		//关闭或打开工具菜单
		if(obj.IsShowToolMenu)
		{
			//软航	
			obj.IsShowToolMenu = boolvalue;	
		}		
		else if(obj.Style)	
		{
			//金格
			obj.Style.ShowToolBars = boolvalue;
		}
			
	}
	finally
	{
		obj = null;
	}
}

//打开或者关闭修订模式
LEAP.DocumentView.WordEditor.TANGER_OCX_SetReviewMode = function(e, boolvalue)
{
 	try
 	{
 		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		if (obj.ActiveDocument.TrackRevisions != null)
 	  		obj.ActiveDocument.TrackRevisions = boolvalue;
 	}
 	finally
 	{
 		obj=null;
 	}
 }

LEAP.DocumentView.WordEditor.safeDoc = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.WordEditor.userconfig.lock);
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WordEditor.deleteSafe = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		obj.ActiveDocument.UnProtect(LEAP.DocumentView.WordEditor.userconfig.lock);
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WordEditor.fullscreen = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		//软航插件属性	
		obj.FullScreenMode = true;
		//金格插件属性
		obj.FullWindowStyle = 1;
		obj.FullSize = true; 
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WordEditor.ConvertToPDF = function(e)
{
	try
	{
		if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment)
		{
			if( e[LEAP.DocumentView.n].attachment._hasPDFZW == true &&  e[LEAP.DocumentView.n].attachment._singlepdfzw == true)
			{
				if (!confirm("PDF格式正文已经存在，该操作将会覆盖原有文件，是否继续？"))
					return;
			}
		}
		
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
		var ret = LEAP.DocumentView.WordEditor.save(e,false);
		if(ret==false)
			return;
			
		LEAP.DocumentView.WordEditor.___delWaterMaker(e, obj);
				
		var v = obj.ActiveDocument.application.version;
		if (v.indexof("11.")>=0)
		{			
		}
		else
		{		
			var WshShell = new ActiveXObject("WScript.Shell"); 
			var path = WshShell.SpecialFolders("AppData") + "\\" + 
						LEAP.getUserInfo().fullName + "_" + 
						LEAP.getUserInfo().getTimeFormart().replaceall('-', '').replaceall(':', '').replaceall(' ', '') + ".pdf";
				path = path.replaceall("\\", "\\\\");
			
			obj.ActiveDocument.ExportAsFixedFormat(path, 17, false, 0, 0, 1, 1, 0, true, true, 0, true, true, false);        
			
			var uploadpath = e.getAttribute('uploadpath') == null?"default":e.getAttribute('uploadpath');
			var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "logic/WFUploadPdf?uploadpath=" + encodeURIComponent(uploadpath) + "&viewname=new.pdf"
			
			LEAP.Comb.upload.upload({uploadurl: uploadurl,
										filename: path,
										callback: LEAP.DocumentView.WordEditor._ConvertToPDF_afterUpload,
										callbackParam: {uploadsrc:e},
										domain:	this,
										showMask: false});

		}
	}
	finally
	{
		obj = ret = v = WshShell = path = uploadpath = uploadurl = null;
	}
}

LEAP.DocumentView.WordEditor._ConvertToPDF_afterUpload = function(arg)
{
	try
	{
		if (arg == null || arg.value != 1)
			return;
		
		var rst = arg.result;
		var e = arg.param.uploadsrc;
				
		if (rst == null || rst == '') 
		{	
			alert('文件保存失败！');	
			return;
		}		
		rst = eval("[" + rst + "]")[0];
		if (rst.result != true) 
		{			
			alert('文件保存失败！');
			return;
		}
		else
		{
			rst.atttype = LEAP.DocumentView.doctype.pdf;
			rst.updateType = 0; 
			if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment)
			{
				rst.title = e[LEAP.DocumentView.n].attachment.title;
			}
			if (rst.fileid == "null")
				rst.fileid = null;
			
			var m = PageObjectModel.getModule(e.getAttribute('instance'));
			if(m)
			{
				if (m.afterConvertPdf)
				{
					if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.tabinfo)
						m.afterConvertPdf({tabinfo:e[LEAP.DocumentView.n].param.exParam.tabinfo, pdffile:rst});
					else
						m.afterConvertPdf({pdffile:rst});
				}
				else
				{
					if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.tabinfo){
						var tabinfo = e[LEAP.DocumentView.n].param.exParam.tabinfo;
						LEAP.DocumentView.WordEditor._inner_afterConvertPdf({tabinfo:e[LEAP.DocumentView.n].param.exParam.tabinfo, pdffile:rst,domain:m});
					}
				
				}
			}
		}
			
	}
	finally
	{
		rst = e = m = null;
	}
}

LEAP.DocumentView.WordEditor._inner_afterConvertPdf = function(arg)
{
	try
	{
		if(arg){
			
			var tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.moduleElement);
			if (!tabCtrl)
				tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.parentPageModule.moduleElement);
			if (!tabCtrl)
				return null;
				
			var pdfTabcode = arg.tabinfo.pdftabcode;
			
			var lab = LEAP.getElement("li[tabcode=" + pdfTabcode + "]", tabCtrl);
			if (lab == null)
				return null;
				
			lab.style.display = "block";
						
			var con = LEAP.getElement("div[tabcode=" + pdfTabcode + "]", tabCtrl);
			if (con)
			{
				var documentView = LEAP.getElement('div[ct=DocumentView]', con);
				if (!arg.pdffile.title)
				{
					arg.pdffile.title = lab.innerText;
				}
				
				LEAP.DocumentView.valueChange(documentView, arg.pdffile, arg.pdffile.atttype);
				arg.domain.convertPDFLoading = true;
				//this.setActiveTabUI(pdfTabcode);
				LWFP.API.ModuleProcess.api.setActiveTabUI(pdfTabcode, arg.domain);
				LEAP.asyn(LEAP.DocumentView.loadDocument, arg.domain, 200, documentView, true, lab.innerText, pdfTabcode);
			}
		}
	}
	finally
	{
		tabCtrl = pdfTabcode = lab = con = null;
	}	
}


LEAP.DocumentView.WordEditor.close = function(e) 
{	
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
		
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
		
		if(readonly==false)
		{	
			if (obj.ActiveDocument.saved == false)
			{
				var b = confirm("是否需要保存？");
				if(b == true)
				{
					LEAP.DocumentView.WordEditor.save(e, false);
				}
			}
		}
		
		obj.Close();
		window.close();

	}
	finally
	{
		obj = data = readonly = null;
	}	
	
}

LEAP.DocumentView.WordEditor.__pageClose = function(e) 
{	
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
		
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
		
		if(readonly==false)
		{	
			if (obj.ActiveDocument.saved == false)
			{
				return false;
			}
		}
		
		return true;
	}
	finally
	{
		obj = data = readonly = null;
	}	
	
}







LEAP.DocumentView.WordEditor.OnOpenPDF = function(obj)
{
	//obj.DocumentModified属性无法区分是否为通过工具栏按钮打开本地PDF，如果打开本地PDF则需要保存.本地打开和网络打开PDF都会回调此方法
	if(obj)
	{
		obj['___openlocalpdf'] = true;
	}
	obj = null;
}





LEAP.DocumentView.WpsEditor = {};
LEAP.DocumentView.WpsEditor.afterLoadActive = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj != null)
		{
			e.style.height = "100%";
			e.style.width = "100%";		
			LEAP.asyn(LEAP.DocumentView.WpsEditor.resizeObject, this, 100, e);
		}
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.resizeObject = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj != null)
		{
			obj.sltReleaseKeyboard();		
		}
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.loadDocument = function(e, url)
{
	try
	{
		if(url.indexOf("?")==-1){
			if(url.indexOf("?sid")==-1){
                url = url +"?sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
            }
		}else{
			if(url.indexOf("sid=")==-1){
                url = templatepath +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
            }
		}
		
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		
		if (LEAPBrowser.isIE == true)
		{
			obj.ShowMenu  = false;
			var b = obj.openDocumentRemote(url, false);
			if (b == true)
			{
				LEAP.DocumentView.WpsEditor.openDocAfter(e);
				LEAP.asyn(LEAP.DocumentView.WpsEditor.resizeObject, this, 100, e);
			}
		}
		else
		{
			obj.sltReleaseKeyboard();
			var b = obj.Application.openDocumentRemote(url, false);
	        if (b == true)		
	        {
				LEAP.DocumentView.WpsEditor.openDocAfter(e);
				LEAP.asyn(LEAP.DocumentView.WpsEditor.resizeObject, this, 100, e);
	        }
		}
		
		
	}
	finally
	{
		obj = b = null;
	}

}

LEAP.DocumentView.WpsEditor.openDocAfter = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return null;
				
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
			
		var btns = "saveAs,print,";
		if (readonly == false)
			btns += "submit,";
		
		if (data.doctype < 0) //正文才使用正文按钮
		{
			if (data && data.param && data.param.wordButton && data.param.wordButton != "")
				btns = data.param.wordButton;
		}
		
		var _arr = LEAP.getElements("a[at=1]", e);
		for(var i=0; i<_arr.length; i++)
		{	
			var _a = _arr[i];
			var _al = _a.getAttribute('al');
			if (btns.indexOf(_al) >=0)
			{
				_a.style.display = 'block';
				
				if (_al == 'updatename')
				{
					if (readonly == false)
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
			else
			{
				_a.style.display = 'none';
			}
				
			if (_al == 'fullscreen')
			{
				_a.style.display = 'block';
			}
			else if (_al == 'close')
			{
				if (e.getAttribute('newwindow') == "1")
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
			}
		}
				
		var isdoc = true;
						
		var userConfig = LEAP.DocumentView.WordEditor.getUserConfig(e);
		
		if (LEAPBrowser.isIE == true)
		{
			obj.setUserName(LEAP.DocumentView.WordEditor.userconfig.username);
			obj.enableRevision(true);
			
			var a = obj.ActiveDocument.Application.OfdExportOptions;
			a.SelectServiceProvider = 0;
		}
		else
		{
			obj.Application.setUserName(LEAP.DocumentView.WordEditor.userconfig.username);
			obj.Application.enableRevision(true);
			
			var a = obj.Application.get_OfdExportOptions();
	        var ret = a.put_SelectServiceProvider(0);
		}
		
		//填充书签
		LEAP.DocumentView.WpsEditor.__initTemplateValue(e);
		
	}
	catch(err)
	{
		if(err.number!=-2147467260)
			alert("错误：" + err.number + ":" + err.description);		
	}
	finally
	{		
		obj = data = readonly = btns = _arr = i = _a = _al = isdoc = userConfig = a = ret = null;
	}
}

LEAP.DocumentView.WpsEditor.__initTemplateValue = function(e)
{
	try
	{	
		//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
		//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);
	
		if (e[LEAP.DocumentView.n].param == null || e[LEAP.DocumentView.n].param.templateValues == null)
			return;
		
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return;
			
		var hasChange = false;
		
		//暂停修订模式
		if (LEAPBrowser.isIE == true)
			obj.enableRevision(false);
		else
			obj.Application.enableRevision(false);
			
		var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
		if (bookMarkslist != null)
		{
			for (var i=0; i<bookMarkslist.length;i++)
			{
				if (obj.Application.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
				{
					var bookRange = obj.Application.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
	        			bookRange.text = bookMarkslist[i][1];
	        			
	        		obj.Application.ActiveDocument.Bookmarks(bookMarkslist[i][0]).Delete();
	        		
	        		hasChange = true;
				}
			}
		}
		
		//开启修订模式
		if (LEAPBrowser.isIE == true)
			obj.enableRevision(true);
		else
			obj.Application.enableRevision(true);

	}
	finally
	{
		obj = bookMarkslist = i = null;
	}	
}

LEAP.DocumentView.WpsEditor.taohong = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return null;
			
		
			
		if (obj.Application.ActiveDocument && obj.Application.ActiveDocument.ProtectionType && obj.Application.ActiveDocument.ProtectionType==3)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		
		var module = LWFP.innerApi.getmodule(e);
		var templates = null;
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.businessNo)
			templates = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:e[LEAP.DocumentView.n].param.businessNo}});
		
		
		if(!templates)
		{
			alert("暂无可用套红模板，请先在模板配置中进行设置！");
			return ;
		}

		var template = window.showModalDialog(window.geturl( LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/LWFP/HTML/Default/wordtempleate/lbcptemplateshow.html"),
												templates.result,"dialogWidth=500px;dialogHeight=100px;status:no;scroll:no;");
		if(!template)
			return;
		
		
		if (template.mode && template.mode == 2)		
		{//模板到正文
			var _url = LEAP.DocumentView._getPath(e[LEAP.DocumentView.n].attachment, e);			
			LEAP.DocumentView.WordEditor.save(e,false);
			if(!_url)
			{
				_url = LEAP.DocumentView._getPath(e[LEAP.DocumentView.n].attachment, e);
			}
			
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;			
			if(templatepath.indexOf("?")==-1){
				if(templatepath.indexOf("?sid")==-1){
	                templatepath = templatepath +"?sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}else{
				if(templatepath.indexOf("sid=")==-1){
	                templatepath = templatepath +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}
			LEAP.DocumentView.WpsEditor.loadDocument(e, templatepath);
				
			//暂停修订模式
			if (LEAPBrowser.isIE == true)
				obj.enableRevision(false);
			else
				obj.Application.enableRevision(false);
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			if (bookMarkslist != null)
			{
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (obj.Application.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = obj.Application.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
		        			bookRange.text = bookMarkslist[i][1];
					}
				}
			}
						
			
			var curSel = obj.Application.ActiveDocument.Application.Selection;
			var view_ = obj.Application.ActiveDocument.Application.ActiveWindow.View;			
			curSel.WholeStory();
			curSel.Copy();
			
			LEAP.DocumentView.WpsEditor.loadDocument(e, _url);
			//暂停修订模式
			if (LEAPBrowser.isIE == true)
				obj.enableRevision(false);
			else
				obj.Application.enableRevision(false);
			
			//定位到第一行
			obj.Application.ActiveDocument.Application.Selection.HomeKey(6);
			obj.Application.ActiveDocument.Words(1).Select();
			obj.Application.ActiveDocument.Application.Selection.Paste();
			
			//开启修订模式
			if (LEAPBrowser.isIE == true)
				obj.enableRevision(true);
			else
				obj.Application.enableRevision(true);
		}
		else
		{//正文到模板
			// 拼凑套红模板的路径
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			if(templatepath.indexOf("?")==-1){
				if(templatepath.indexOf("?sid")==-1){
	                templatepath = templatepath +"?sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}else{
				if(templatepath.indexOf("sid=")==-1){
	                templatepath = templatepath +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}
			// 选择对象当前文档的所有内容
			var curSel = obj.Application.ActiveDocument.Application.Selection;
			var view_ = obj.Application.ActiveDocument.Application.ActiveWindow.View;
			
			curSel.WholeStory();
			curSel.Cut();
			
			// 插入模板			
			LEAP.DocumentView.WpsEditor.loadDocument(e, templatepath);
							
			//暂停修订模式
			if (LEAPBrowser.isIE == true)
				obj.enableRevision(false);
			else
				obj.Application.enableRevision(false);
				
			var BookMarkName = "zhengwen";
			if(!obj.Application.ActiveDocument.BookMarks.Exists(BookMarkName))
			{
				alert("红头模板中不存在正文(书签名：zhengwen)书签！");
				return;
			}
			var bkmkObj = obj.Application.ActiveDocument.BookMarks(BookMarkName);	
			var saverange = bkmkObj.Range;
			var fontName = saverange.Font.Name;//取得正文书签字体类型
			var fontSize = saverange.Font.Size;//取得正文书签字体大小
			saverange.Paste();
			obj.Application.ActiveDocument.Bookmarks.Add(BookMarkName,saverange);//此方法会导致书签格式丢失
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (obj.Application.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = obj.Application.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
        					bookRange.text = bookMarkslist[i][1];
					}
				}		
			}
			
			//开启修订模式
			if (LEAPBrowser.isIE == true)
				obj.enableRevision(true);
			else
				obj.Application.enableRevision(true);
		}
	}
	finally
	{
		obj=templates=templatepath= curSel=view_=BookMarkName=bkmkObj=saverange=bookMarkslist=i=null;
	}

}

LEAP.DocumentView.WpsEditor.save = function(e, __alertResult)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (!obj)
			return false;
		
		var res;		        
		if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
		{
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc_wps_linux?isnew=1';
			
			url += '&uploadpath=' + encodeURIComponent(e.getAttribute('uploadpath')?e.getAttribute('uploadpath'):"default") + '&viewname=' + encodeURIComponent('new.doc');			
			
			if (LEAPBrowser.isIE == true)
				res = obj.saveURL(url, 'NewDoc.doc'); 	
			else
				res = obj.Application.saveURL(url, 'NewDoc.wps'); 	
		}
		else
		{
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc_wps_linux?' 
					+ 'namedpath=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) 
					+ '&name=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);
					
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
				url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);	
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
				url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
				url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
				url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
				url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
					
			if (LEAPBrowser.isIE == true)
			{
				url = url.replace("WFOffice_updateDoc_wps_linux", "WFOffice_updateDoc_wps_win");
				res = obj.saveURL(url, "NewDoc.wps");
			}
			else
			{
				var tabcon = LEAP._match(e, "tab_content", 'ctf');
				if (tabcon != null && tabcon.style.display == "none")
				{
					res = true;					
				}
				else
				{				
					res = obj.Application.saveURL(url, 'NewDoc.wps');
				}
			}
		}
		
		if (res == true)
		{
			if (e[LEAP.DocumentView.n].isnew == true)
			{
				//TODO 
				var res = eval("[" + res + "]");
				var res = res[0];
				var _att={};
					_att.atttype = e[LEAP.DocumentView.n].doctype;
					_att.fileid = res.fileid;
					_att.title = e.getAttribute('defaultName') ? e.getAttribute('defaultName') : "新建正文"; 
					_att.name = res.name;
					_att.namedpath = res.namedpath;
					_att.updateType = 0;
					_att.ownername = LEAP.getUserInfo().fullName;				
					_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
					_att.canDelete = true;
					_att.canEdit = true;
				
				LEAP.DocumentView.valueChange(e, _att);
			}
			
			if (__alertResult == false){} else alert("保存成功");
			
			return true;			
		}
		else
		{
			if (__alertResult==false){}else alert("保存失败!");
			return false;
		}
	}
	catch(e)
	{}
	finally
	{
		obj = res = url = _att = null;
	}
}

LEAP.DocumentView.WpsEditor.saveLocal = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (LEAPBrowser.isIE == true)
			obj.saveAs(); 	
		else
			obj.Application.saveAs(); 
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.printDoc = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (LEAPBrowser.isIE == true)
			obj.printRevision(2);
		else
			obj.Application.printRevision(2);
	}
	catch(e)
	{
		//alert("打印失败：请确保打印机已经开启，并且打印服务已经启动！");
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.showRevisions = function(e, tt)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (LEAPBrowser.isIE == true)
		{
			obj.showRevision(tt);	
		}
		else
		{
			obj.Application.showRevision(tt);
		}
		
	}
	catch(e)
	{
		//alert("打印失败：请确保打印机已经开启，并且打印服务已经启动！");
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.importdoc = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;			
			
		/*if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}*/

		var bb = obj.Application.ShowLocalDocumentDialog();
		var aa = obj.Application.openDocument(bb, false);
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.doHandSign = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		obj.Application.EnterInkDraw();
		
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.safeDoc = function(e, lock) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		if (LEAPBrowser.isIE == true)
			obj.enableProtect(lock);
		else
			obj.Application.enableProtect(lock);
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.fullscreen = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		if (LEAPBrowser.isIE == true)
			obj.FullScreen();
		else
			obj.Application.FullScreen();
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.WpsEditor.ConvertToOFD = function(e)
{
	try
	{		
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		var b = LEAP.DocumentView.WpsEditor.save(e, false);
		if (b == false)
		{
			alert("文件保存失败!");
			return;
		}
		
		var rst = null;
		var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/' + 'WFOffice_updateDoc_wps_to_ofd_linux'
					+ '?namedpath=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) 
					+ '&name=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);	
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
			url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);	
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
			url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
		if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
			url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
			url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
		if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
			url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
				
		if (LEAPBrowser.isIE == false)
		{			
			rst = obj.Application.saveURL(url, "new.ofd", "", "", true);
		}
		else
		{			
			
			
			rst = obj.saveURL(url, "new.ofd", "", "", true);		
		}
				
		if (rst == null || rst == false)
		{
			alert("文件转换失败!");
			return;
		}
		
		
		var ofdfile = LWFP.innerApi.clone(e[LEAP.DocumentView.n].attachment);
		
		ofdfile.id = null;
		ofdfile.name = ofdfile.name.substring(0, ofdfile.name.lastIndexOf(".")) + ".ofd";
		ofdfile.updateType = 0; 
		ofdfile.atttype = LEAP.DocumentView.doctype.ofd;
				
		var tabinfo = e[LEAP.DocumentView.n].param.exParam.tabinfo;
		var m = PageObjectModel.getModule(e.getAttribute('instance'));
		if(m)
		{
			if (m.afterConvertOfd)
			{
				if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && tabinfo)
					m.afterConvertOfd({tabinfo:tabinfo, ofdfile:ofdfile});
				else
					m.afterConvertOfd({ofdfile:ofdfile});
			}
			else
			{
				if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && tabinfo)
				{
					LEAP.DocumentView.WpsEditor._inner_afterConvertOFD({tabinfo:tabinfo, ofdfile:ofdfile,domain:m});
				}			
			}
		}

	}
	finally
	{
		obj = rst = url = rst = ofdfile = tabinfo = m = null;
	}
}

LEAP.DocumentView.WpsEditor._inner_afterConvertOFD = function(arg)
{
	try
	{
		if(arg)
		{			
			var tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.moduleElement);
			if (!tabCtrl)
				tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.parentPageModule.moduleElement);
			if (!tabCtrl)
				return null;
				
			var ofdTabcode = arg.tabinfo.ofdtabcode;
			
			var lab = LEAP.getElement("li[tabcode=" + ofdTabcode + "]", tabCtrl);
			if (lab == null)
				return null;
				
			lab.style.display = "block";
						
			var con = LEAP.getElement("div[tabcode=" + ofdTabcode + "]", tabCtrl);
			if (con)
			{
				var documentView = LEAP.getElement('div[ct=DocumentView]', con);
				arg.ofdfile.title = lab.innerText;
								
				LEAP.DocumentView.valueChange(documentView, arg.ofdfile, arg.ofdfile.atttype);
				LWFP.API.ModuleProcess.api.setActiveTabUI(ofdTabcode, arg.domain);
			}
			
			
		}
		
	}
	finally
	{
		tabCtrl = ofdTabcode = lab = con = null;
	}	
}


LEAP.DocumentView.WpsEditor.buttonClick = function(e, al)
{
	if (al == "submit")
	{
		LEAP.DocumentView.WpsEditor.save(e);
	}
	else if (al == "saveAs")
	{
		LEAP.asyn(LEAP.DocumentView.WpsEditor.saveLocal, this, 0, e);		
	}
	else if (al == "print")
	{
		LEAP.DocumentView.WpsEditor.printDoc(e);
	}
	else if (al == "showMark")
	{
		LEAP.DocumentView.WpsEditor.showRevisions(e, 0);
	}
	else if (al == "hideMark")
	{
		LEAP.DocumentView.WpsEditor.showRevisions(e, 2);
	}
	else if (al == "importDoc")
	{
		LEAP.DocumentView.WpsEditor.importdoc(e);
	}
	else if (al == "doHandSign")
	{
		LEAP.DocumentView.WpsEditor.doHandSign(e);
	}
	else if (al == "doHandSecSign")
	{
		alert("linux下清配置使用OFD进行签名");
		//LEAP.DocumentView.WpsEditor.doHandSecSign(e);
	}
	else if (al == "addServerSign")
	{
		alert("linux下清配置使用OFD进行签章");
		//LEAP.DocumentView.WpsEditor.addServerSign(e);
	}
	else if (al == "addServer2Sign2")
	{
		alert("linux下清配置使用OFD进行签章");
		//LEAP.DocumentView.WpsEditor.addServerSign2(e);
	}
	else if (al == "taohong")
	{
		//alert("linux下套红功能暂未发布（测试中）");
		LEAP.DocumentView.WpsEditor.taohong(e);
	}
	else if (al == "safeDoc")
	{
		LEAP.DocumentView.WpsEditor.safeDoc(e, true);
	}
	else if (al == "deleteSafe")
	{
		LEAP.DocumentView.WpsEditor.safeDoc(e, false);
	}
	else if (al == "fullscreen")
	{
		LEAP.DocumentView.WpsEditor.fullscreen(e);
	}
	else if (al == "ConvertOFD")
	{
		LEAP.DocumentView.WpsEditor.ConvertToOFD(e);
	}
	else if (al == "close")
	{
		//LEAP.DocumentView.WpsEditor.close(e);
	}
	else if (al == 'pdf_create')
	{
		//LEAP.DocumentView.WpsEditor.save(e, false);
	}
	else if (al == 'pdf_print')
	{
		//LEAP.DocumentView.printDoc(e);
	}
	else if (al == 'pdf_saveAs')
	{
		//LEAP.DocumentView.WpsEditor.saveAs(e);
	}
	else if (al == "updatename")
	{
		//LEAP.DocumentView.WpsEditor.updatename(e);
	}
		
}






LEAP.DocumentView.IWebOffice = {};

LEAP.DocumentView.IWebOffice.copyright_win = "金格科技iWebOffice2015智能文档中间件[演示版];V5.0S0xGAAEAAAAAAAAAEAAAAFIBAABgAQAALAAAAKZEm3Cwjf6QAl+AtJec866sTmeS/8TDMGXGx3FXcV9dgckvZpgoOZJfjNJvHxbAGV5o6H+1ZmQvl6YPL1qqLCJemV7b0I+jo7AA+L0zDVphQqnT/22fCXQWCiK0JZk8Q9ymTKjsM4a5om1/SkYZFhL/7Ntmz8W6zKpS81tk6YmnX/p+sniHNiX+vD5TjzMFBOO0QQZuCDzxiTTMI2KM9e5BqilJ/lfsJ5iyqZI7vGxq+BreO1y1ciNWvnllGN5kAaRAC6M0bSkPQ+kkCIbV3OX8oI+c0+BCje2hRmecwvasuQHstp8RP9g+amKYijxW0oqoLm3bciadiNdJfZZnPa0iGh5dx0Wx+iJFHuwi+Aw+EWzuXL6EPmUKReHxVHyg0r3k1dDpssshnBcJoVbQuK4whVFGo1+2ypaYo69nrax2D0l2cA6R6VmKqLyXjO49XmRyAnZQF/9HsOS22zAaDgZrM9gMSvew5+7m5vESnNpZ";
LEAP.DocumentView.IWebOffice.copyright_linux = "金格科技iWebOffice信创中间件[演示];V5.0S0xGAAEAAAAAAAAAEAAAAEgBAABQAQAALAAAAGDV3U7sOUhHpD7WGljlLz3rFC0B82+CKBqCFyjY6jqEVw2UaQ1PYAHyHhj2XHhSTYxTiL5CVQrCjQIFhjMKiCX0GCTA6XR7FS5S7FV9C6KH1WRz25hrmhoIi+m/C+jv/PRYI+tK5ZAUra4cbFbbgbK0UMg1c/bJLDxet/Odbfk0Cq3UUpoPohA8cmU/f6oQKhkcMQ06+yNtTn6sbq8Il9Bd9IX3CDPcfNew2pC7DlPfQb9zVwemncjToJ3COVGenQ/fDhEfsMvPY0Si1PsxYhJTi1SpVwut7Cw0oghqEXXhFyB5z8/2KhSOH7pq7RcJgskDTMJgwXmE9sYGe+zc6Init/8x7qD7MmEVyhlaIcL6gQMjY1HYrxWmSzsVi63VW2Rz7LGtXr/EWjGBckniFrstPin8q1u+wbJltf588HP5r+hbchwLmf9I3ujHufOWSCsjdkfxH+REI4gs60LTKKc=";


LEAP.DocumentView.IWebOffice.init = function(e, container)
{
	LEAP.asyn(LEAP.DocumentView.IWebOffice._init, this, 50, e, container);	
}

LEAP.DocumentView.IWebOffice._init = function(e, container)
{	
	var str = "";

	if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
	{//Windows下加载iWebOffice2015控件
		if ((window.ActiveXObject!=undefined) || (window.ActiveXObject!=null) ||"ActiveXObject" in window)
		{
			str += '<object id="officebody_' + e.getAttribute("instance") + '" ctf="officeobj" ';
			
			str += ' width="100%"';
			str += ' height="100%"';
			//32位控件
			if(window.navigator.platform == "Win32") 
				str += ' CLASSID="CLSID:D89F482C-5045-4DB5-8C53-D2C9EE71D025" ';
			//64位控件
			if (window.navigator.platform == "Win64")
				str += ' CLASSID="CLSID:D89F482C-5045-4DB5-8C53-D2C9EE71D024"  ';
			str += '>';
			str += '<param name="Copyright" value="' + LEAP.DocumentView.IWebOffice.copyright_win + '">';
		}
		else if (LEAP.DocumentView.Browser.browser == "chrome") 
		{
			str += '<object wmode="transparent" id="officebody_' + e.getAttribute("instance") + '"  ctf="officeobj" ';
		
		
			str += ' width="100%"';
			str += ' height="100%"';
			str += ' clsid="CLSID:D89F482C-5045-4DB5-8C53-D2C9EE71D025"';        
			str += ' type="application/kg-plugin"';                              //KGChromePlugin插件type
			//str += ' type="application/kg-activex"';                           //iWebPlugin插件type
			//str += ' type="application/iwebplugin"';
			//str += ' OnCommand="OnCommand"';
			//str += ' OnOLECommand="OnOLECommand"';
			//str += ' OnReady="OnReady"';
			//str += ' OnRightClickedWhenAnnotate="OnRightClickedWhenAnnotate"';
			//str += ' OnSending="OnSending"';
			//str += ' OnSendEnd="OnSendEnd"';
			//str += ' OnRecvStart="OnRecvStart"';
			//str += ' OnRecving="OnRecving"';
			//str += ' OnRecvEnd="OnRecvEnd"';
			//str += ' OnFullSizeBefore="OnFullSizeBefore"';
			//str += ' OnFullSizeAfter="OnFullSizeAfter"';
			str += ' Copyright="' + LEAP.DocumentView.IWebOffice.copyright_win + '"';
			str += '>';
		}
				
		str += '</object>'; 
	}
	else
	{//Linux下加载iWebOffice_ZZKK控件
		var str = '<object id="officebody_' + e.getAttribute("instance") + '"  ctf="officeobj" type="application/iweboffice" height="100%" width="100%" >'
		str += '<param name="Copyright" value="' + LEAP.DocumentView.IWebOffice.copyright_linux + '">';
		str += '</object>';
	
	}
	
	container.innerHTML = str;	
}

LEAP.DocumentView.IWebOffice.loadDocument = function(e, url, type)
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{
			LEAP.DocumentView.IWebOffice.loadDocument_win(e, url, type);
		}
		else
		{
			LEAP.DocumentView.IWebOffice.loadDocument_linux(e, url, type)
		}
	}
	finally
	{
		obj = url = null;
	}
}
LEAP.DocumentView.IWebOffice.loadDocument_win = function(e, url, type)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		
		var nType = 1;
		var docType = LEAP.DocumentView.DocType.DOC;
		var data = e[LEAP.DocumentView.n];
		var att = data.attachment;
		if (att)
		{
			nType = LEAP.DocumentView.IWebOffice.getPluginType(att.name);
			docType = LEAP.DocumentView.getDocumentType(att.name);
		}
		
		obj.PluginType = nType;
		obj._docType = docType;
		
		obj.Style.ShowTitleBar = false;	 //标题栏
		obj.Style.ShowMenuBar = false;
		obj.Style.ShowToolBars = true;
		obj.Style.ShowStatusBar = false; //状态栏
		obj.Style.BorderStyle = 0;
		
		obj.Style.Invalidate();
		if(url.indexOf("?")==-1){
			if(url.indexOf("?sid")==-1){
                url = url +"?sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
            }
		}else{
			if(url.indexOf("sid=")==-1){
                url = url +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
            }
		}
		
		var filepath = LEAP.DocumentView.IWebOffice._WebDownLoadFile(obj, url, e);
		e['localfilepath'] = filepath;
		if(filepath)
		{
			obj.Open(filepath);
			
			if (!obj['___h'])
			{
				LEAP.DocumentView.IWebOffice.openDocAfter(e);
				obj['___h'] = 1;
			}
		}
	}
	finally
	{
		obj = url = null;
	}
}

LEAP.DocumentView.IWebOffice.loadDocument_linux = function(e, url, type)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
				
		var _fileType = ".doc";
		var readOnly = false;
		var nType = 1;
		var docType = LEAP.DocumentView.DocType.DOC;
			
		var data = e[LEAP.DocumentView.n];
		var att = data.attachment;
		if (att)
		{
			readOnly = !att.canEdit;		
			nType = LEAP.DocumentView.getDocumentType(att.name);
			docType = LEAP.DocumentView.getDocumentType(att.name);
			
			var _ex = /\.[^\.]+/.exec(att.name.toLowerCase());
			_fileType = _ex[0];
			
			url = LEAP.DocumentView._getPath(att, e, true);   //TODO 金格有bug，影响附件日志，待处理
		}

		if (!obj.setPluginType(nType))     //自主可控默认加载WPS插件
		{
			LEAP.DocumentView.IWebOffice.__alert(e, "加载插件失败！");
			LEAP.DocumentView.IWebOffice.__alert(e, obj.GetErrMessage());
			return false;
		}
		
		obj._docType = docType;
		obj._filetype = _fileType;
		obj.PluginType = nType;
		obj.WebUrl = url;             //WebUrl:系统服务器路径，与服务器文件交互操作，如保存、打开文档，重要文件
		
		/*obj.RecordID = "mRecordID";            //RecordID:本文档记录编号	   
	    obj.Template="mTemplate";            //Template:模板编号	    
		obj.FileName="mFileName.docx";            //FileName:文档名称	    		
		obj.FileType=".docx";            //FileType:文档类型  .doc  .xls  .wps		
		obj.UserName="mUserName";            //UserName:操作用户名，痕迹保留需要
	    obj.EditType="2";            //EditType:编辑类型,第一位可以为0,1,2,3 其中:0不可编辑;1可以编辑,无痕迹;2可以编辑,有痕迹,不能修订;3可以编辑,有痕迹,能修订
		*/
		
		if (readOnly == true)
			obj.EditType="0";
		else
			obj.EditType="2";			
			
		obj.MaxFileSize = 1024 * 1024;               //最大的文档大小控制，默认是8M，现在设置成4M。
		
		var ret = obj.KGOpenWebFile(url, false);
		if (ret == true)
		{
			if (!obj['___h'])
			{
				LEAP.DocumentView.IWebOffice.openDocAfter(e);
				obj['___h'] = 1;
			}
		}
	}
	catch(ex)
	{
	}
	finally
	{
		obj = url = null;
	}
}

LEAP.DocumentView.IWebOffice.__pageClose = function(e) 
{	
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
		
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
		
		if(readonly==false)
		{	
			if (obj.ActiveDocument.saved == false)
			{
				return false;
			}
		}
		
		return true;
	}
	finally
	{
		obj = data = readonly = null;
	}	
	
}



//LEAP.DocumentView.IWebOffice.TEMP = "\\WebOffice\\Temp\\"; //指定临时路劲
//LEAP.DocumentView.IWebOffice.DOWN = "\\WebOffice\\Down\\"; // 指定下载路径并设置名称

LEAP.DocumentView.IWebOffice.TEMP = "\u005c\u005c\u0057\u0065\u0062\u004f\u0066\u0066\u0069\u0063\u0065\u005c\u005c\u0054\u0065\u006d\u0070\u005c\u005c"; //指定临时路劲
LEAP.DocumentView.IWebOffice.DOWN = "\u005c\u005c\u0057\u0065\u0062\u004f\u0066\u0066\u0069\u0063\u0065\u005c\u005c\u0044\u006f\u0077\u006e\u005c\u005c"; // 指定下载路径并设置名称
LEAP.DocumentView.IWebOffice._getTempFilePath = function(obj)
{
	if( obj==null )
		return null;
	var fs = obj.FileSystem;
	var path = fs.GetSpecialFolderPath(0x1a) + LEAP.DocumentView.IWebOffice.TEMP; //临时路径
	fs.CreateDirectory (path);
	
	return path;
}
LEAP.DocumentView.IWebOffice._getDownFilePath = function(obj)
{
	if( obj==null )
		return null;
	var fs = obj.FileSystem;
	var path = fs.GetSpecialFolderPath(0x1a) + LEAP.DocumentView.IWebOffice.DOWN; //临时路径
	return path;
}
LEAP.DocumentView.IWebOffice._WebDownLoadFile = function(obj, Url, e) 
{
	if( obj==null )
		return null;
		
	//删除本地文件
	var fs = obj.FileSystem;
	var path = LEAP.DocumentView.IWebOffice._getDownFilePath(obj);
	fs.ClearDirectory(path);
		
	var kwoHttpGet = 0;
	var kwoHttpPost = 1;
	var httpclient = obj.Http;
	httpclient.Clear();
	httpclient.ShowProgressUI = true;
	httpclient.Hidden = false;
	// 异步下载先调用OnSendEnd(),再调用OnRecEnd()
	var info = httpclient.Open(kwoHttpGet,Url, false);
	if (info) 
	{
		var send = httpclient.Send();
		if (send) 
		{
			if (httpclient.Status == 200) 
			{
				var ex = Url;
				if (ex.indexOf("?") >0 )
					ex = ex.substring(0, ex.indexOf("?"));
				ex = ex.substring(ex.lastIndexOf("."));

				var FileName = LEAP.DocumentView.IWebOffice._getDownFilePath(obj) + UUID.randomUUID().replaceall('-', '') + ex;
				var header = httpclient.GetAllResponseHeaders();
				
				//保存到本地
				httpclient.ResponseSaveToFile(FileName);
				httpclient.Close();
				//"下载成功";
				
				var size = fs.GetFileSize(FileName);
				if (header.indexOf(size) < 0)
				{
					LEAP.DocumentView.IWebOffice.__alert(e, "文件下载失败：网络故障-01");
					return null;
				}
				
				return FileName;
			}
			else
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "文件下载失败：网络故障-02");
				return null;
			}
		}
		else
		{
        	 LEAP.DocumentView.IWebOffice.__alert(e, "文件下载失败：网络故障-03");
        	 return null;
		}
	}
	else
	{
    	 LEAP.DocumentView.IWebOffice.__alert(e, "文件下载失败：网络故障-04");
    	 httpclient.Clear();
    	 return null;
	}
}

LEAP.DocumentView.IWebOffice.handleWordOpenedEvent = function(id)
{
	try
	{
		var obj = document.getElementById(id);
		
		if (obj['___h'])
		{
			var e = LEAP._match(obj, LEAP.DocumentView.d);
			LEAP.DocumentView.IWebOffice.openDocAfter(e);
		}
	}
	finally
	{
		obj = e = null;
	}
}

LEAP.DocumentView.IWebOffice.getUserConfig = function(e)
{
	if (LEAP.DocumentView.IWebOffice.userconfig == null)
	{
		var module = LWFP.innerApi.getmodule(e);
		//LEAP.DocumentView.IWebOffice.userconfig = module.request2({name:'lbcp_getControlPaneBean'});
		//if (!LEAP.DocumentView.IWebOffice.userconfig)
		{
			LEAP.DocumentView.IWebOffice.userconfig = {wordcorrections:1};			
		}
		LEAP.DocumentView.IWebOffice.userconfig.username = LEAP.getUserInfo().fullName;	
		LEAP.DocumentView.IWebOffice.userconfig.lock = module.request2({name:'lbcp_getOfficeWordLock'});
		if (!LEAP.DocumentView.IWebOffice.userconfig.lock)
			LEAP.DocumentView.IWebOffice.userconfig.lock = "Longrise123456789";
	}
	
	return LEAP.DocumentView.IWebOffice.userconfig;
}

/**
 * 执行操作
 * @param {} e
 * @param {} param 
 * 			{
 * 				buttons:更改要显示的功能按钮，按钮代码逗号分隔，如： "submit,saveAs"
 * 						 按钮代码： submit保存 saveAs另存为 print打印 showMark显示痕迹 hideMark隐藏痕迹 importDoc导入文件 doHandSign加入手写签批 
 * 								doHandSecSign加入手写签名 taohong正文套红 addServerSign添加服务器签章 addServer2Sign2添加服务器签章
								safeDoc锁定文件 deleteSafe取消锁定 ConvertPDF转为PDF格式 close关闭 fullscreen全屏 
 * 			}
 */
LEAP.DocumentView.IWebOffice.oprate = function(e, param)
{
	try
	{
		if (param && param.buttons)
		{
			var btns = param.buttons;
				
			var _arr = LEAP.getElements("a[at=1]", e);
			for(var i=0; i<_arr.length; i++)
			{	
				var _a = _arr[i];
				var _al = _a.getAttribute('al');
				if (btns.indexOf(_al) >=0)
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
					
				if (_al == 'fullscreen')
				{
					_a.style.display = 'block';
				}
				else if (_al == 'close')
				{
					if (e.getAttribute('newwindow') == "1")
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
		}
	}
	finally
	{
		btns = _arr = i = _a = _al = null;
	}
}

LEAP.DocumentView.IWebOffice.openDocAfter = function(e)
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{
			LEAP.asyn(LEAP.DocumentView.IWebOffice.openDocAfter_win, this, 500, e);
		}
		else
		{
			LEAP.asyn(LEAP.DocumentView.IWebOffice.openDocAfter_linux, this, 500, e);
		}
	}
	finally
	{
		obj = url = null;
	}
}

LEAP.DocumentView.IWebOffice.openDocAfter_win = function(e)
{
	LEAP.asyn(LEAP.DocumentView.IWebOffice.openDocAfter_win_, this, 500, e);
}
LEAP.DocumentView.IWebOffice.openDocAfter_win_ = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return null;
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
			
		var btns = "saveAs,print,showMark,hideMark,";
		if (readonly == false)
			btns += "submit,";
		
		if (data.doctype < 0) //正文才使用正文按钮
		{
			if (data && data.param && data.param.wordButton && data.param.wordButton != "")
				btns = data.param.wordButton;
		}
		
		if (obj._docType != LEAP.DocumentView.DocType.DOC)
			btns = btns.replace("showMark", "").replace("hideMark", "");
		
		var _arr = LEAP.getElements("a[at=1]", e);
		for(var i=0; i<_arr.length; i++)
		{	
			var _a = _arr[i];
			var _al = _a.getAttribute('al');
			if (btns.indexOf(_al) >=0)
			{
				_a.style.display = 'block';
				
				if (_al == 'updatename')
				{
					if (readonly == false)
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
			else
			{
				_a.style.display = 'none';
			}
				
			/*if (_al == 'fullscreen')
			{
				_a.style.display = 'block';
			}
			else */
			
			if (_al == 'close')
			{
				if (e.getAttribute('newwindow') == "1")
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
			}
		}
				
		var userConfig = LEAP.DocumentView.IWebOffice.getUserConfig(e);
		
		obj.ActiveDocument.Application.UserName = LEAP.DocumentView.IWebOffice.userconfig.username;
		
		
		if (obj._docType == LEAP.DocumentView.DocType.DOC)
		{
			obj.ActiveDocument.TrackRevisions = true;
			obj.Style.Invalidate(); 
		}
		
		/*if (readonly == true)
		{
			obj.Style.ShowTitleBar = false;	 //标题栏
			obj.Style.ShowMenuBar = false;
			obj.Style.ShowToolBars = false;
			obj.Style.ShowStatusBar = false; //状态栏
			obj.Style.BorderStyle = 0;
		}
		else*/
		/*{
			obj.Style.ShowTitleBar = false;	 //标题栏
			obj.Style.ShowMenuBar = false;
			obj.Style.ShowToolBars = true;
			obj.Style.ShowStatusBar = false; //状态栏
			obj.Style.BorderStyle = 0;
		}
	
		obj.Style.Invalidate();*/
		
		//添加水印
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
				
		ElementEventManager.handleEvent(e, "onDocumentLoad");
		
		if (obj._docType == LEAP.DocumentView.DocType.DOC)
			LEAP.DocumentView.IWebOffice.__initTemplateValue(e);
			
		//防止空文档被保存
		obj.ActiveDocument.saved = true;
		
		if (obj._docType == LEAP.DocumentView.DocType.DOC)
		{
			if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
			{}
			else
			{
				obj.ActiveDocument.ShowRevisions = (LEAP.DocumentView.IWebOffice.userconfig.wordcorrections==1)?true:false;		
			}
		}
		
		LEAP.asyn(LEAP.DocumentView.IWebOffice.___resize, this, 1000, e, obj.ActiveDocument.saved);
	}
	catch(err)
	{
		if(err.message)
			LEAP.DocumentView.IWebOffice.__alert(e, err.message);		
	}
	finally
	{		
		obj = data = readonly = btns = _arr = i = _a = _al = userConfig = doctype = null;
	}
}

LEAP.DocumentView.IWebOffice.openDocAfter_linux = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return null;
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
			
		var btns = "saveAs,print,";
		if (readonly == false)
			btns += "submit,";
		
		if (data.doctype < 0) //正文才使用正文按钮
		{
			if (data && data.param && data.param.wordButton && data.param.wordButton != "")
				btns = data.param.wordButton;
		}
		
		if(obj.DocType == 3 || obj.DocType == 2)
			btns = btns.replace("showMark", "").replace("hideMark", "");
		
		var _arr = LEAP.getElements("a[at=1]", e);
		for(var i=0; i<_arr.length; i++)
		{	
			var _a = _arr[i];
			var _al = _a.getAttribute('al');
			if (btns.indexOf(_al) >=0)
			{
				_a.style.display = 'block';
				
				if (_al == 'updatename')
				{
					if (readonly == false)
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
			else
			{
				_a.style.display = 'none';
			}
				
			if (_al == 'fullscreen')
			{
				_a.style.display = 'block';
			}
			else if (_al == 'close')
			{
				if (e.getAttribute('newwindow') == "1")
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
			}
		}
				
		var isdoc = true;
		var localfilepath = e['localfilepath'];
		if(localfilepath)
		{
			var doctype = localfilepath.substring(localfilepath.lastIndexOf(".")+1).toLowerCase();
			if( doctype=="ppt" || doctype=="pptx" || doctype=="xls" || doctype=="xlsx")
				isdoc = false;
		}
				
		var userConfig = LEAP.DocumentView.IWebOffice.getUserConfig(e);
		
		var doc = obj.WebObject.Application.ActiveDocument;
		doc.Application.UserName = LEAP.DocumentView.IWebOffice.userconfig.username;
		if (doc && doc.ProtectionType && doc.ProtectionType==2)
		{}
		else
		{
			doc.ShowRevisions = (LEAP.DocumentView.IWebOffice.userconfig.wordcorrections==1)?true:false;	
		}
		
		if(isdoc == true)
		{
			if (readonly == true)
			{
				doc.Protect(3, false, LEAP.DocumentView.IWebOffice.userconfig.lock);
			}
			else
			{
				doc.TrackRevisions = true;
			}
	

		}

		//添加水印
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
				
		ElementEventManager.handleEvent(e, "onDocumentLoad");
		
		if(isdoc == true)
			LEAP.DocumentView.IWebOffice.__initTemplateValue(e);
		
		//防止空文档被保存
		doc.Saved = true;
		
		LEAP.asyn(LEAP.DocumentView.IWebOffice.___resize, this, 1000, e, doc.saved);
	}
	catch(err)
	{
		
	}
	finally
	{		
		obj = data = readonly = btns = _arr = i = _a = _al = userConfig = doctype = null;
	}
}

LEAP.DocumentView.IWebOffice.___addWaterMaker = function(e, activexObj)
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			LEAP.DocumentView.IWebOffice.___addWaterMaker_win(e, activexObj);
		else
			LEAP.DocumentView.IWebOffice.___addWaterMaker_linux(e, activexObj);
	}
	catch(ex)
	{
	}
}

LEAP.DocumentView.IWebOffice.___addWaterMaker_win = function(e, activexObj)
{
	try
	{
		if (window._showmark != '0')
		{
			{
				try
				{
					if (activexObj.PluginType == 1)
					{//word			    		
			    		activexObj.ActiveDocument.Background.Fill.Transparency = 0;
			    		activexObj.ActiveDocument.Background.Fill.UserPicture(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + LEAP.getWaterMark());
			    		activexObj.ActiveDocument.ActiveWindow.View.DisplayBackgrounds = true;
					}
				}
				catch(e)
				{}    		
			}
		}
	}
	finally
	{
		
	}
}

LEAP.DocumentView.IWebOffice.___addWaterMaker_linux = function(e, activexObj)
{
	try
	{
		if (window._showmark != '0')
		{
			try
			{
				var doc = activexObj.WebObject.Application.ActiveDocument;
				if (activexObj.PluginType == 1)
				{//word			    		
		    		doc.Background.Fill.Transparency = 0;
		    		doc.Background.Fill.UserPicture(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + LEAP.getWaterMark());
		    		doc.ActiveWindow.View.DisplayBackgrounds = true;
				}
			}
			catch(ex){}
		}
	}
	finally
	{
		
	}
}

LEAP.DocumentView.IWebOffice.___delWaterMaker = function(e, activexObj)
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			LEAP.DocumentView.IWebOffice.___delWaterMaker_win(e, activexObj);
		else
			LEAP.DocumentView.IWebOffice.___delWaterMaker_linux(e, activexObj);	
	}
	catch(ex){}
}

LEAP.DocumentView.IWebOffice.___delWaterMaker_win = function(e, activexObj)
{
	if (activexObj.PluginType == 1)
	{	//word
		activexObj.ActiveDocument.Background.Fill.Visible = false;
	}
}

LEAP.DocumentView.IWebOffice.___delWaterMaker_linux = function(e, activexObj)
{
	if (activexObj.PluginType == 1)
	{	//word
		activexObj.WebObject.Application.ActiveDocument.Background.Fill.Visible = false;
	}
}


LEAP.DocumentView.IWebOffice.___resize = function(e, saved)
{
	try
	{
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.isOpenWindow == true)
		{
			var top = LEAP.getElement("[ar=top]", e);
			var bottom = LEAP.getElement("[ar=bottom]", e);
		
			bottom.style.height = (e.clientHeight - top.clientHeight) + 'px';
		}
		
		if (saved != null)
			LEAP.getElement('[ctf=officeobj]').activeDocument.saved = saved;
			
			
		var str = "<div style='text-align:left; width:440px; padding:2px 10px 2px 10px; color:red;'>" +
					"温馨提示：为避免因长时间未操作导致连接超时引起工作丢失，请及时保存文件！" +
					"</div>"
												
		LEAP.smallTip.show(str, document.body.clientWidth-570, 5, null);
		
	}
	finally
	{
		top = bottom = null;
	}
}


LEAP.DocumentView.IWebOffice.__initTemplateValue = function(e)
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			LEAP.DocumentView.IWebOffice.__initTemplateValue_win(e);
		else
			LEAP.DocumentView.IWebOffice.__initTemplateValue_linux(e);	
	}
	catch(ex){}
}

LEAP.DocumentView.IWebOffice.__initTemplateValue_win = function(e)
{
	try
	{	
		//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
		//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);
	
		if (e[LEAP.DocumentView.n].param == null || e[LEAP.DocumentView.n].param.templateValues == null)
			return;
			
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
		
		var flag = false;
		if (obj.ActiveDocument.ProtectionType == 2)
		{
			flag = true;
			//obj.SetReadOnly(false, "");	
			obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.IWebOffice.userconfig.lock);
		}
			
		LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

		if (obj.ActiveDocument.BookMarks)
		{
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			for (var i=0; i<bookMarkslist.length;i++)
			{
				if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
				{
					var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
	        			bookRange.text = bookMarkslist[i][1];
				}
			}	
		}
		
		LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		
		if (flag == true)
			obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.IWebOffice.userconfig.lock);
	}
	finally
	{
		obj = bookMarkslist = i = null;
	}	
}

LEAP.DocumentView.IWebOffice.__initTemplateValue_linux = function(e)
{
	try
	{	
		//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
		//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);
	
		if (e[LEAP.DocumentView.n].param == null || e[LEAP.DocumentView.n].param.templateValues == null)
			return;
			
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		var doc = obj.WebObject.Application.ActiveDocument;
		
		var flag = false;
		if (doc.ProtectionType == 2)
		{
			flag = true;
			//obj.SetReadOnly(false, "");	
			doc.Protect(3, false, LEAP.DocumentView.IWebOffice.userconfig.lock);
		}
			
		LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

		if (doc.BookMarks)
		{
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			for (var i=0; i<bookMarkslist.length;i++)
			{
				if (doc.BookMarks.Exists(bookMarkslist[i][0]))
				{
					var bookRange = doc.Bookmarks.Item(bookMarkslist[i][0]).Range;
	        			bookRange.text = bookMarkslist[i][1];
				}
			}
		}
		
		LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		
		if (flag == true)
			doc.Protect(3, false, LEAP.DocumentView.IWebOffice.userconfig.lock);
	}
	finally
	{
		obj = bookMarkslist = i = null;
	}	
}


LEAP.DocumentView.IWebOffice.buttonClick = function(e, al)
{
	if (al == "submit")
	{
		LEAP.DocumentView.IWebOffice.save(e);
	}
	else if (al == "saveAs")
	{
		LEAP.asyn(LEAP.DocumentView.IWebOffice.saveLocal, this, 0, e);		
		//LEAP.DocumentView.IWebOffice.saveLocal(e);
	}
	else if (al == "print")
	{
		LEAP.DocumentView.IWebOffice.printDoc(e);
	}
	else if (al == "showMark")
	{
		LEAP.DocumentView.IWebOffice.showRevisions(e);
	}
	else if (al == "hideMark")
	{
		LEAP.DocumentView.IWebOffice.hideRevisions(e);
	}
	else if (al == "importDoc")
	{
		LEAP.DocumentView.IWebOffice.importdoc(e);
	}
	else if (al == "doHandSign")
	{
		LEAP.DocumentView.IWebOffice.doHandSign(e);
	}
	else if (al == "doHandSecSign")
	{
		LEAP.DocumentView.IWebOffice.doHandSecSign(e);
	}
	else if (al == "addServerSign")
	{
		LEAP.DocumentView.IWebOffice.addServerSign(e);
	}
	else if (al == "addServer2Sign2")
	{
		LEAP.DocumentView.IWebOffice.addServerSign2(e);
	}
	else if (al == "taohong")
	{
		LEAP.DocumentView.IWebOffice.taohong(e);
	}
	else if (al == "safeDoc")
	{
		LEAP.DocumentView.IWebOffice.safeDoc(e);
	}
	else if (al == "deleteSafe")
	{
		LEAP.DocumentView.IWebOffice.deleteSafe(e);
	}
	else if (al == "fullscreen")
	{
		LEAP.DocumentView.IWebOffice.fullscreen(e);
	}
	else if (al == "ConvertPDF")
	{
		LEAP.DocumentView.IWebOffice.ConvertToPDF(e);
	}
	else if (al == "ConvertOFD")
	{
		LEAP.DocumentView.IWebOffice.ConvertToOFD(e);
	}	
	else if (al == "close")
	{
		LEAP.DocumentView.IWebOffice.close(e);
	}
	else if (al == "updatename")
	{
		LEAP.DocumentView.IWebOffice.updatename(e);
	}
	
	//TODO "","","","close","blank"
	
}

LEAP.DocumentView.IWebOffice.updatename = function(arg)
{
	try
	{
		if (arg.arg == null)
		{
			var e = arg;
			
			if(LEAP.DocumentView.OSType.indexOf("Win") > -1 && LEAP.DocumentView.Browser.browser == "chrome")
			{
				var obj = LEAP.getElement('[ctf=officeobj]', e);
				obj.HidePlugin(0);
			}
			
			var _formElement = null;
			var _txt = null;
			var _btn = null;
			if (LEAP.DocumentView.IWebOffice.udpform == null)
			{
				LEAP.DocumentView.IWebOffice.udpform = LEAP.form.create3({name:null, title:'修改文件名', width:500, height:150, formtype:3});
				
				var str = '<div style="height:100%; width:100%;">';
					str += '<input ut="filename" class="LC_input_conner" style="width:97%; margin:10px 2% 10px 1%;" lcv="2" mdtype="text" bt="text" ht="input">';
					str += '<input ut="submit" class="LC_button_conner LC_button_blue" style="float:right; margin:0px 30px 0px 0px;" type="button" value="确定" lcv="2" ht="input">'
					str += '</div>'
					
				LEAP.form.setContent(LEAP.DocumentView.IWebOffice.udpform.form, str);
				
				_formElement = LEAP.getElement(LEAP.DocumentView.IWebOffice.udpform.form);
				var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
				if (icon)
					icon.style.display = "none";				
				
				LEAP.DocumentView.IWebOffice.udpform._txt = LEAP.getElement("input[ut=filename]", _formElement);
				_btn = LEAP.getElement("input[ut=submit]", _formElement);
				LEAP.addEvent(_btn, 'click', LEAP.DocumentView.IWebOffice.updatename, {iscallback:true});
			}
			
			var title = "";
			if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
				title = e.getAttribute('defaultName') ? e.getAttribute('defaultName') : ""; 
			else
				title = e[LEAP.DocumentView.n].attachment.title;

			LEAP.DocumentView.IWebOffice.udpform.FileName = title;
			LEAP.DocumentView.IWebOffice.udpform._txt.value = title;
			LEAP.DocumentView.IWebOffice.udpform.ele = e;
						
			LEAP.form.show(LEAP.DocumentView.IWebOffice.udpform.form);	
		}
		else
		{
			var _title = LEAP.DocumentView.IWebOffice.udpform._txt.value.trim();
			if (_title == '')
			{
				LEAP.DocumentView.IWebOffice.__alert(e, '文件名不可为空！');
				return;
			}
			if ((_title.indexof('\\')>=0) || 
				(_title.indexof('/')>=0) ||
				(_title.indexof(':')>=0) ||
				(_title.indexof('*')>=0) ||
				(_title.indexof('?')>=0) ||
				(_title.indexof('"')>=0) ||
				(_title.indexof('<')>=0) ||
				(_title.indexof('>')>=0) ||
				(_title.indexof('|')>=0) )			
			{
				LEAP.DocumentView.IWebOffice.__alert(e, '文件名不可包含如下字符： \\ / : * ? " < > |');
				return;
			}
			
			LEAP.form.hide(LEAP.DocumentView.IWebOffice.udpform.form);
		
			var e = LEAP.DocumentView.IWebOffice.udpform.ele;
			if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
			{
				e.setAttribute('defaultName', _title);
			}
			else
			{
				var att = e[LEAP.DocumentView.n].attachment;
				att.title = _title;
				if (att.updateType == null)
					att.updateType = 1;

				LEAP.DocumentView.valueChange(e, att);			
				
				var obj = LEAP.getElement('[ctf=officeobj]', e);
				obj.ActiveDocument.saved = false;
			}		
			
			if(LEAP.DocumentView.OSType.indexOf("Win") > -1 && LEAP.DocumentView.Browser.browser == "chrome")
			{
				var obj = LEAP.getElement('[ctf=officeobj]', e);
				obj.HidePlugin(1);
			}
			
		}
		
		
	}
	finally
	{			
		e = _formElement = _txt = _btn = str = title = _title = e = att = null;
	}
}

LEAP.DocumentView.IWebOffice.save = function(e, __alertResult)
{		
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			return LEAP.DocumentView.IWebOffice.save_win(e, __alertResult);
		else
			return LEAP.DocumentView.IWebOffice.save_linux(e, __alertResult);
	}
	catch(ex){}
}

LEAP.DocumentView.IWebOffice.save_win = function(e, __alertResult)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (!obj)
			return true;
		
		if ( !obj.ActiveDocument)
			return true;

		if (obj._docType == LEAP.DocumentView.DocType.DOC &&  obj.ActiveDocument.saved == true)
			return true;
			
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		
		var filepath = e['localfilepath'];
		//保存到本地
		var SaveFalg;
		if (obj._docType == LEAP.DocumentView.DocType.XLS)
		{
			SaveFalg = obj.ActiveDocument.Save();
		}
		else
		{
			SaveFalg = obj.Save(filepath, null, true);
		}
				
		if(SaveFalg == 80 || SaveFalg == 81 || SaveFalg == 82)
		{
			//失败："文件路径无效","参数无效","文件创建失败"
			return false;
		}
		
		var res;
		var url = null;
		var httpclient = obj.Http;
		httpclient.AddFile("FileData", filepath); // 需要上传的文件
		if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
		{	
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_save2?option=SAVEFILE&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid();		
			url += '&uploadpath=' + encodeURIComponent(e.getAttribute('uploadpath')?e.getAttribute('uploadpath'):"default") + '&viewname=' + encodeURIComponent('new.doc');					
		}
		else
		{			
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_save2?option=SAVEFILE&' 
					+ 'namedpath=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) 
					+ '&name=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name)
					+ '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid();
			
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
				url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
				url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
				url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
				url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
				url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
		}
		
		if (httpclient.Open(1, url, false)) //true异步方式 ,false同步
		{
			if (!httpclient.Send()) 
			{
				//数据包发送失败！请检查链网络是否畅通。
				if (__alertResult==false){}else  alerLEAP.DocumentView.IWebOffice.__alert(e, "保存失败！");
				return false;
			} 
			else 
			{
				//数据包发送成功，文档已成功保存到后台
				var rst = httpclient.GetResponseHeader("RName");// 获取返回值
				if(rst)
					rst = eval("[" + rst + "]");
				
				if (rst && rst[0].status == "1")
				{
					var callbackAtt_AfterDraft = null;
					if (e[LEAP.DocumentView.n].isnew == true)
					{
						var _att={};
							_att.atttype = e[LEAP.DocumentView.n].doctype;
							_att.fileid = rst[0].fileid;
							_att.title = e.getAttribute('defaultName') ? e.getAttribute('defaultName') : "新建正文"; 
							_att.name = rst[0].name;
							_att.namedpath = rst[0].namedpath;
							_att.updateType = 0;
							_att.ownername = LEAP.getUserInfo().fullName;				
							_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
							_att.canDelete = true;
							_att.canEdit = true;
							_att.attsize = rst[0].attsize;
							
						if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.draftTemplateUrl != null)
							callbackAtt_AfterDraft = _att;
												
						LEAP.DocumentView.valueChange(e, _att);
					}
					
					var m = PageObjectModel.getModule(e.getAttribute('instance'));	
					if (m && m.afterDraft && callbackAtt_AfterDraft != null)
					{
						try
						{
							m.afterDraft({draftFile:callbackAtt_AfterDraft, action:"afterDraft"});
						}
						catch(ex){}
					}
					else if (m.wordEditorCallback)
					{
						try
						{
							m.wordEditorCallback({data:res, action:"onWordEditorSave", att:e[LEAP.DocumentView.n].attachment});
						}
						catch(ex){}
					}
					
					
					if (__alertResult == false){} else LEAP.DocumentView.IWebOffice.__alert(e, "保存成功");
					
					return true;
				}
			}
		} 
		else 
		{
			if (__alertResult==false){}else  LEAP.DocumentView.IWebOffice.__alert(e, "保存失败！");
			return false;
		}
		
	}
	catch(ex)
	{}
	finally
	{
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
		if (obj.ActiveDocument)
			obj.ActiveDocument.saved = true;
		obj = res = url = _att = null;
	}
}
LEAP.DocumentView.IWebOffice.save_linux = function(e, __alertResult)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (!obj)
			return false;
		
		var doc = obj.WebObject.Application.ActiveDocument;

		if (doc.Saved == true)
			return true;
			
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		
		if (e[LEAP.DocumentView.n].isnew && e[LEAP.DocumentView.n].isnew == true)
		{	
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc2?isnew=1&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid();
			url += '&uploadpath=' + encodeURIComponent(e.getAttribute('uploadpath')?e.getAttribute('uploadpath'):"default") + '&viewname=' + encodeURIComponent('new.doc');		
		}
		else
		{	
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc?' 
					+ 'namedpath=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath) 
					+ '&name=' + encodeURIComponent(e[LEAP.DocumentView.n].attachment.name)
					+ '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid();
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.fileid)
				url += "&fileid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.fileid);				
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.id)
				url += "&attid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
			if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.entryid)
				url += "&attentryid=" + encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam2 && e[LEAP.DocumentView.n].param.exParam2.businessid)
				url += "&attbusinessid=" + encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
			if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.currentstep && e[LEAP.DocumentView.n].param.currentstep.hsid)	
				url += "&attcategory=" + encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
		}
		
		var ret = obj.KGSaveWebFile(url, "124.docx");
		if (ret == true)
		{
			ret = obj.WebGetResponseBody();
			if (ret)
			{
				var ret = eval("[" + ret + "]");
				var ret = ret[0];
				if (res.result == true)
				{
					var callbackAtt_AfterDraft = null;
					if (e[LEAP.DocumentView.n].isnew == true)
					{
						
						var _att={};
							_att.fileid = ret.fileid;
							_att.atttype = e[LEAP.DocumentView.n].doctype;
							_att.title = e.getAttribute('defaultName') ? e.getAttribute('defaultName') : "新建正文"; 
							_att.name = ret.name;
							_att.namedpath = ret.namedpath;
							_att.updateType = 0;
							_att.ownername = LEAP.getUserInfo().fullName;				
							_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
							_att.canDelete = true;
							_att.canEdit = true;
						if (e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.draftTemplateUrl != null)
							callbackAtt_AfterDraft = _att;
						
						LEAP.DocumentView.valueChange(e, _att);
					}			
					
					var m = PageObjectModel.getModule(e.getAttribute('instance'));	
					if (m && m.afterDraft && callbackAtt_AfterDraft != null)
					{
						try
						{
							m.afterDraft({draftFile:callbackAtt_AfterDraft, action:"afterDraft"});
						}
						catch(ex){}
					}
					
					if (__alertResult == false){} else LEAP.DocumentView.IWebOffice.__alert(e, "保存成功");
					
					return true; 
				}
				else
				{
					alert("保存失败:" + res.msg);
				}
			}
			else
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "保存失败!");
				return false;
			}
		}
		else
		{
			LEAP.DocumentView.IWebOffice.__alert(e, "保存失败!");
			return false;
		}
	}
	catch(ex)
	{}
	finally
	{
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
		if (obj.ActiveDocument)
			obj.ActiveDocument.saved = true;
		obj = res = url = _att = null;
	}
}

LEAP.DocumentView.IWebOffice.saveLocal = function(e) 
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			LEAP.DocumentView.IWebOffice.saveLocal_win(e);
		else
			return LEAP.DocumentView.IWebOffice.saveLocal_linux(e);
	}
	catch(ex){}
}
LEAP.DocumentView.IWebOffice.saveLocal_win = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj || !obj.ActiveDocument)
			return;
			
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		obj.ShowDialog(3);	    	
	}
	finally
	{
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
		obj = null;
	}
}
LEAP.DocumentView.IWebOffice.saveLocal_linux = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		
		obj.saveAs();
	}
	finally
	{
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
		obj = null;
	}
}

LEAP.DocumentView.IWebOffice.printDoc = function(e) 
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			LEAP.DocumentView.IWebOffice.printDoc_win(e);
		else
			return LEAP.DocumentView.IWebOffice.printDoc_linux(e);
	}
	catch(ex){}
} 
LEAP.DocumentView.IWebOffice.printDoc_win = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj || !obj.ActiveDocument)
			return;
			
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		obj.ShowDialog(4);
		

	}
	catch(e)
	{
	}
	finally
	{
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
		obj = null;
	}
}
LEAP.DocumentView.IWebOffice.printDoc_linux = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		obj.print();		
	}
	catch(e)
	{
		//alert("打印失败：请确保打印机已经开启，并且打印服务已经启动！");
	}
	finally
	{
		LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
		obj = null;
	}
}

LEAP.DocumentView.IWebOffice.showRevisions = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{
			if	(!obj || !obj.ActiveDocument)
				return;
			
			if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "文件处于保护状态.不支持当前操作!");
				return;
			}
			
	 		obj.ActiveDocument.ShowRevisions =true;
	 		//obj.ActiveDocument.ActiveWindow.View.SplitSpecial = 20;
		}
		else
		{
			obj.showRevision(0);	
		}
	}
	finally
	{
		obj = null;
	}
}
LEAP.DocumentView.IWebOffice.hideRevisions = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);	
		if	(!obj)
			return;
		
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{			
			if(!obj.ActiveDocument)
				return;
			
			if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "文件处于保护状态.不支持当前操作!");
				return;
			}
			
	 		obj.ActiveDocument.ShowRevisions = false;
	 		//obj.ActiveDocument.ActiveWindow.View.SplitSpecial = 18;
		}
		else
		{
			obj.showRevision(2);	
		}
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.IWebOffice.importdoc = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{			
			if (!obj.ActiveDocument)
				return;
				
			if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "文件处于保护状态.不支持当前操作!");
				return;
			}
	
			if(obj.AddTemplateFromLocal)
				obj.AddTemplateFromLocal("", true, true);	
			else
				obj.ShowDialog(1);
				
			obj.ActiveDocument.saved = false;
		}
		else
		{
			alLEAP.DocumentView.IWebOffice.__alert(e, "linux下暂不支持该功能");
		}
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.IWebOffice.doHandSign = function(e) 
{
	LEAP.DocumentView.IWebOffice.__alert(e, "暂不支持该功能");
}

LEAP.DocumentView.IWebOffice.addServerSign = function(e) 
{
	LEAP.DocumentView.IWebOffice.__alert(e, "暂不支持该功能");
}

LEAP.DocumentView.IWebOffice.taohong = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		var doc = null;
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			doc = obj.ActiveDocument;
		else
			doc = obj.WebObject.Application.ActiveDocument;
		
		if (!doc)
			return;
			
		if (doc.ProtectionType && doc.ProtectionType==2)
		{
			LEAP.DocumentView.IWebOffice.__alert(e, "文件处于保护状态.不支持当前操作!");
			return;
		}
		
		var module = LWFP.innerApi.getmodule(e);
		var templates = null;
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.businessNo)
			templates = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:e[LEAP.DocumentView.n].param.businessNo}});
		
		if(!templates)
		{
			LEAP.DocumentView.IWebOffice.__alert(e, "暂无可用套红模板，请先在模板配置中进行设置！");
			return ;
		}
		
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1 && LEAP.DocumentView.Browser.browser == "chrome")
		{
			var obj = LEAP.getElement('[ctf=officeobj]', e);
			obj.HidePlugin(0);
		}
		
		if (LEAP.DocumentView.IWebOffice.templateForm == null)
		{
			LEAP.DocumentView.IWebOffice.templateForm = LEAP.form.create3({name:null, title:'选择套红模板', width:550, height:330, formtype:3});
			
			var str = '<select ut="templates" size=5 style="width:100%; height:230px; font-size:14px;"></select>';
				str += '<br/>';
				str += '<button ut="btn_confirm" type="button" style="float:right; margin:10px 30px; font-size:14px; padding:5px 20px;">套&nbsp;&nbsp;红</button>';
				str += '<button ut="btn_cancel" type="button" style="float:right; margin:10px 10px; font-size:14px; padding:5px 20px;">取&nbsp;&nbsp;消</button>';
				
			LEAP.form.setContent(LEAP.DocumentView.IWebOffice.templateForm.form, str);
			
			var _fe = LEAP.getElement(LEAP.DocumentView.IWebOffice.templateForm.form);
			var btn_confirm = LEAP.getElement("[ut=btn_confirm]", _fe);
			var btn_cancel = LEAP.getElement("[ut=btn_cancel]", _fe);
			
			LEAP.addEvent(btn_confirm, 'click', LEAP.DocumentView.IWebOffice.taohong_step2);
			LEAP.addEvent(btn_cancel, 'click', LEAP.DocumentView.IWebOffice.taohong_step2);	
		}
			
		var _formElement = LEAP.getElement(LEAP.DocumentView.IWebOffice.templateForm.form);
		var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
		if (icon)
			icon.style.display = "none";				
			
		var select = LEAP.getElement("[ut=templates]", _formElement);
		select.innerHTML = "";
		for(var i=0; i<templates.result.length; i++)
		{
			var tmp = templates.result[i];		
			var myOption = document.createElement("option"); //动态创建option标签
				myOption.style.margin = "4px 5px";
	            myOption.value = tmp.templatename; //红头文档id
	            myOption.text = tmp.templatename; //红头文档名称
	            myOption["data"] = tmp;
	            
			select.add(myOption);			
		}
		
		
		LEAP.DocumentView.IWebOffice.templateForm.ele = e;
		LEAP.form.show(LEAP.DocumentView.IWebOffice.templateForm.form);	
	}
	finally
	{
		obj = module = templates = str = icon = select =  i= tmp = myOption =  btn_confirm = btn_cancel = null;
	}
}

LEAP.DocumentView.IWebOffice.taohong_step2 = function(arg) 
{
	try
	{
		var e = LEAP.DocumentView.IWebOffice.templateForm.ele;
		
		var btn = arg.e.srcElement;
		if (btn.getAttribute("ut") == "btn_cancel")
		{			
			LEAP.form.hide(LEAP.DocumentView.IWebOffice.templateForm.form);	
			
			if(LEAP.DocumentView.OSType.indexOf("Win") > -1 && LEAP.DocumentView.Browser.browser == "chrome")
			{
				var obj = LEAP.getElement('[ctf=officeobj]', e);
				obj.HidePlugin(1);
			}	
			
		}
		else
		{
			var _formElement = LEAP.getElement(LEAP.DocumentView.IWebOffice.templateForm.form);
			var select = LEAP.getElement("[ut=templates]", _formElement);

		    var index = select.selectedIndex;
		    if (index == -1) { //添加未选中数据时的异常处理
		        LEAP.DocumentView.IWebOffice.__alert(e, "请先选择红头文件后再进行套红头！");
		        return;
		    }		    
		    var selectedTemplate = select.options[index]["data"];
    
			if(LEAP.DocumentView.OSType.indexOf("Win") > -1 && LEAP.DocumentView.Browser.browser == "chrome")
			{
				var obj = LEAP.getElement('[ctf=officeobj]', e);
				obj.HidePlugin(1);
			}
			
			LEAP.form.hide(LEAP.DocumentView.IWebOffice.templateForm.form);
			
			if (LEAP.DocumentView.OSType.indexOf("Win") > -1)
				LEAP.DocumentView.IWebOffice.taohong_win(e, selectedTemplate);
			else
				LEAP.DocumentView.IWebOffice.taohong_linux(e, selectedTemplate);	
		}
	}
	finally
	{
		
	}
}
LEAP.DocumentView.IWebOffice.taohong_win = function(e, template) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		var doc = obj.ActiveDocument;
		
		if (template.mode && template.mode == 2)		
		{
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			if(templatepath.indexOf("?")==-1){
				if(templatepath.indexOf("?sid")==-1){
	                templatepath = templatepath +"?sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}else{
				if(templatepath.indexOf("sid=")==-1){
	                templatepath = templatepath +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}
			
			var templateFile = LEAP.DocumentView.IWebOffice._WebDownLoadFile(obj, templatepath, e);
			if (!templateFile)
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "下载套红模板失败");
				return;
			}
			
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
			doc.Application.Selection.HomeKey(6);
			doc.Words.Item(1).Select();
			
			doc.Application.Selection.InsertFile(templateFile, "", false, false, false);
						
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (doc.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = doc.Bookmarks.Item(bookMarkslist[i][0]).Range;
		        			bookRange.text = bookMarkslist[i][1];						
					}
				}
			}
			
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态	
		}
		else
		{
			//保存
			obj.Save(e.localfilepath);
			//加载模板
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			if(templatepath.indexOf("?")==-1){
				if(templatepath.indexOf("?sid")==-1){
	                templatepath = templatepath +"?sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}else{
				if(templatepath.indexOf("sid=")==-1){
	                templatepath = templatepath +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}
			var filepath = LEAP.DocumentView.IWebOffice._WebDownLoadFile(obj, templatepath, e);
			if (!filepath)
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "下载套红模板失败");
				return;
			}
			var b = obj.Open(filepath);
			//
			doc = obj.ActiveDocument;
			var BookMarkName = "zhengwen";
			if(!doc.BookMarks.Exists(BookMarkName))
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "红头模板中不存在正文(书签名：zhengwen)书签！");
				return;
			}
						
			var bkmkObj = doc.BookMarks.Item(BookMarkName);	
			var saverange = bkmkObj.Range;
			saverange.Select();
			
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			doc.Application.Selection.InsertFile(e.localfilepath, "", false, false, false);
						
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			/*if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (doc.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = doc.Bookmarks.Item(bookMarkslist[i][0]).Range;
        					bookRange.text = bookMarkslist[i][1];
					}
				}
			}*/
			
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态		
		}		
	}
	finally
	{
		
	}
}
LEAP.DocumentView.IWebOffice.taohong_linux = function(e, template) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
				
		var doc = obj.WebObject.Application.ActiveDocument;
		
		if (template.mode && template.mode == 2)		
		{			
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			//var templateFile = "/tmp/tmp.docx";
			if(templatepath.indexOf("?")==-1){
				if(templatepath.indexOf("?sid")==-1){
	                templatepath = templatepath +"?sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}else{
				if(templatepath.indexOf("sid=")==-1){
	                templatepath = templatepath +"&sid="+leapclient.getsid() + LEAP.wfrouter.getLid();
	            }
			}
			var templateFile = "\u002f\u0074\u006d\u0070\u002f\u0074\u006d\u0070\u002e\u0064\u006f\u0063\u0078";
			
			var b = obj.WebDownLoadFile(templatepath, templateFile);
			if (true != b)
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "下载红头模板失败！");
				return;
			}
			
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
			//定位到第一行
			doc.Application.Selection.HomeKey(6);
			doc.Words.Item(1).Select();
			
			b = obj.WebInsertLocalFile("", templateFile);
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (doc.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = doc.Bookmarks.Item(bookMarkslist[i][0]).Range;
		        			bookRange.text = bookMarkslist[i][1];						
					}
				}		
			}
						
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态	
		}
		else
		{
			var tmpDocFile = "/tmp/_kgtmp" + obj._filetype;
			var b = obj.WebSaveLocalFile(tmpDocFile);
			
			// 下载模板
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "LEAP/Download/" + template.path;
			var templateFile = "/tmp/tmp.docx";
			b = obj.WebDownLoadFile(templatepath, templateFile);
			if (true != b)
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "下载红头模板失败！");
				return;
			}
			
			//打开模板
			obj.WebOpenLocalFile(templateFile);
										
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
			doc = obj.WebObject.Application.ActiveDocument;
			var BookMarkName = "zhengwen";
			if(!doc.BookMarks.Exists(BookMarkName))
			{
				LEAP.DocumentView.IWebOffice.__alert(e, "红头模板中不存在正文(书签名：zhengwen)书签！");
				return;
			}
			//插入正文
			obj.WebInsertLocalFile(BookMarkName, tmpDocFile);
			
			
			//正文内容加载完毕之后再针对模板中的其他书签进行设置
			//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			
	
			/*if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
			{
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i=0; i<bookMarkslist.length;i++)
				{
					if (doc.BookMarks.Exists(bookMarkslist[i][0]))
					{
						var bookRange = doc.Bookmarks.Item(bookMarkslist[i][0]).Range;
        					bookRange.text = bookMarkslist[i][1];
					}
				}		
			}*/
			
			LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态	
			
		}
	}
	finally
	{
		
	}
}


LEAP.DocumentView.IWebOffice.setBookmarkValues = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;

		LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			
		//if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
		//	e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);			

		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValues)
		{
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			for (var i=0; i<bookMarkslist.length;i++)
			{
				if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
				{
					var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
        				bookRange.text = bookMarkslist[i][1];
				}
			}		
		}
		
		LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		
		return true;
	}
	finally
	{
		obj = bookMarkslist = i = null;
	}
}

//进入或退出强制痕迹保留状态，调用该函数下面定义的两个函数。一般可直接调用本函数。
LEAP.DocumentView.IWebOffice.TANGER_OCX_SetMarkModify = function(e, boolvalue)
{	   
   	LEAP.DocumentView.IWebOffice.TANGER_OCX_SetReviewMode(e, boolvalue);   
   	LEAP.DocumentView.IWebOffice.TANGER_OCX_EnableReviewBar(e, !boolvalue);
}

//允许或禁止显示修订工具栏和工具菜单（保护修订,用户不能更改当前修订状态)
LEAP.DocumentView.IWebOffice.TANGER_OCX_EnableReviewBar = function(e, boolvalue)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		var doc = null;
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			doc = obj.ActiveDocument;
		else 
			doc =  obj.WebObject.Application.ActiveDocument;
			
		if (doc)
		{	
			//兼容WORD/WPS
			try
			{
				doc.CommandBars("Reviewing").Enabled = boolvalue;
				doc.CommandBars("Track Changes").Enabled = boolvalue;
			}catch(e){}
			try{
			if (doc.Application)
				doc.Application.ActiveWindow.View.ShowRevisionsAndComments = boolvalue;
			}catch(e){}
		}
		
		//关闭或打开工具菜单
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{
			if(obj.Style)	
			{
				//obj.Style.ShowToolBars = boolvalue;
			}
		}
		else
		{
			//obj.ShowToolBars = boolvalue;
		}
			
	}
	finally
	{
		obj = null;
	}
}

//打开或者关闭修订模式
LEAP.DocumentView.IWebOffice.TANGER_OCX_SetReviewMode = function(e, boolvalue)
{
 	try
 	{
 		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		var doc = null;
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			doc = obj.ActiveDocument;
		else 
			doc =  obj.WebObject.Application.ActiveDocument;
			
		if (doc.TrackRevisions != null)
 	  		doc.TrackRevisions = boolvalue;
 	}
 	finally
 	{
 		obj=null;
 	}
 }

LEAP.DocumentView.IWebOffice.safeDoc = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.IWebOffice.userconfig.lock);
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.IWebOffice.deleteSafe = function(e) 
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		obj.ActiveDocument.UnProtect(LEAP.DocumentView.IWebOffice.userconfig.lock);
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.IWebOffice.fullscreen = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
		
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{
			obj.FullWindowStyle = 1;
			obj.FullSize = true; 
		}
		else
		{
			obj.FullSize();
		}
	}
	finally
	{
		obj = null;
	}
}

LEAP.DocumentView.IWebOffice.ConvertToPDF = function(e)
{
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{
			LEAP.DocumentView.IWebOffice.ConvertToPDF_win(e);
		}
		else
		{
			//alert("当前环境下暂不支持转换为PDF格式");
			LEAP.DocumentView.IWebOffice.ConvertToPDF_linux(e);
		}
	}
	finally
	{
		obj = url = null;
	}

}
LEAP.DocumentView.IWebOffice.ConvertToPDF_win = function(e)
{
	try
	{
		if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment)
		{
			if( e[LEAP.DocumentView.n].attachment._hasPDFZW == true &&  e[LEAP.DocumentView.n].attachment._singlepdfzw == true)
			{
				if (!confirm("PDF格式正文已经存在，该操作将会覆盖原有文件，是否继续？"))
					return;
			}
		}
		
		var obj = LEAP.getElement('[ctf=officeobj]', e);			
		var doc = obj.ActiveDocument;
				
		var ret = LEAP.DocumentView.IWebOffice.save(e,false);
		if(ret==false)
			return;
		
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		
		var path = LEAP.DocumentView.IWebOffice._getTempFilePath(obj);
		var filename = path + UUID.randomUUID().replaceall('-', '') + ".pdf";
		
		doc.ExportAsFixedFormat(filename, 17, false, 0, 0, 1, 1, 0, true, true, 0, true, true, true);
		
		var uploadpath = e.getAttribute('uploadpath') == null?"default":e.getAttribute('uploadpath');
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "logic/WFOffice_save2?option=SAVEFILE&uploadpath=" + encodeURIComponent(uploadpath) + "&viewname=new.pdf"
						
		var httpclient = obj.Http;
		httpclient.AddFile("FileData", filename); // 需要上传的文件
       	if (httpclient.Open(1, uploadurl, false)) //true异步方式 ,false同步
		{
			if (!httpclient.Send()) 
			{
				//数据包发送失败！请检查链网络是否畅通。
				if (__alertResult==false){}else  LEAP.DocumentView.IWebOffice.__alert(e, "保存失败！");
				return false;
			} 
			else 
			{
				//数据包发送成功，文档已成功保存到后台
				var rst = httpclient.GetResponseHeader("RName");// 获取返回值
				if(rst)
					rst = eval("[" + rst + "]");
				
				LEAP.DocumentView.IWebOffice._ConvertToPDF_afterUpload(e, rst[0]);
			}
		} 
		else 
		{
			if (__alertResult==false){}else  LEAP.DocumentView.IWebOffice.__alert(e, "保存失败！");
			return false;
		}
       
       	//LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
	}
	finally
	{
		obj = ret = v = WshShell = path = uploadpath = uploadurl = null;
	}
}
LEAP.DocumentView.IWebOffice.ConvertToPDF_linux = function(e)
{
	try
	{
		if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment)
		{
			if( e[LEAP.DocumentView.n].attachment._hasPDFZW == true &&  e[LEAP.DocumentView.n].attachment._singlepdfzw == true)
			{
				if (!confirm("PDF格式正文已经存在，该操作将会覆盖原有文件，是否继续？"))
					return;
			}
		}
		
		var obj = LEAP.getElement('[ctf=officeobj]', e);			
		var doc = obj.WebObject.Application.ActiveDocument;
				
		var ret = LEAP.DocumentView.IWebOffice.save(e,false);
		if(ret==false)
			return;
		
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		
		var filename = "/tmp/kgtmp_.pdf";
		
		doc.ExportAsFixedFormat(filename, 17, false, 0, 0, 1, 1, 0, true, true, 0, true, true, true);
		
		var uploadpath = e.getAttribute('uploadpath') == null?"default":e.getAttribute('uploadpath');
		//var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "logic/WFOffice_save2?option=SAVEFILE&uploadpath=" + encodeURIComponent(uploadpath) + "&viewname=new.pdf"
		
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc2?isnew=1';			
			uploadurl += "&uploadpath=" + encodeURIComponent(uploadpath) + "&viewname=new.pdf";

		
		
		var ret = obj.WebUploadFile(uploadurl, filename);
		if (ret == true)
		{
			ret = obj.WebGetResponseBody();
			if (ret)
			{
				var rst = JSON.parse(ret);
				LEAP.DocumentView.IWebOffice._ConvertToPDF_afterUpload(e, rst);
			}
		}
		
		//LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
	}
	finally
	{
		obj = ret = v = WshShell = path = uploadpath = uploadurl = null;
	}
}
LEAP.DocumentView.IWebOffice._ConvertToPDF_afterUpload = function(e, resultURI)
{
	try
	{
		if (!e || !resultURI)
			return;
		
		var rst = resultURI;
		
		rst.atttype = LEAP.DocumentView.doctype.pdf;
		rst.updateType = 0; 
		if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.title){
			rst.title = e[LEAP.DocumentView.n].attachment.title;
		}
		if (rst.fileid == "null")
			rst.fileid = null;
		
		var m = PageObjectModel.getModule(e.getAttribute('instance'));
		if(m)
		{
			if (m.afterConvertPdf)
			{
				if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.tabinfo)
					m.afterConvertPdf({tabinfo:e[LEAP.DocumentView.n].param.exParam.tabinfo, pdffile:rst});
				else
					m.afterConvertPdf({pdffile:rst});
			}
			else
			{
				if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.tabinfo)
				{
					var tabinfo = e[LEAP.DocumentView.n].param.exParam.tabinfo;
					LEAP.DocumentView.IWebOffice._inner_afterConvertPdf({tabinfo:tabinfo, pdffile:rst,domain:m});
				}
			
			}
		}
	}
	finally
	{

	}
}
LEAP.DocumentView.IWebOffice._inner_afterConvertPdf = function(arg)
{
	try
	{
		if(arg){
			
			var tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.moduleElement);
			if (!tabCtrl)
				tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.parentPageModule.moduleElement);
			if (!tabCtrl)
				return null;
				
			var pdfTabcode = arg.tabinfo.pdftabcode;
			
			var lab = LEAP.getElement("li[tabcode=" + pdfTabcode + "]", tabCtrl);
			if (lab == null)
				return null;
				
			lab.style.display = "block";
						
			var con = LEAP.getElement("div[tabcode=" + pdfTabcode + "]", tabCtrl);
			if (con)
			{
				var documentView = LEAP.getElement('div[ct=DocumentView]', con);
				arg.pdffile.title = lab.innerText;
				LEAP.DocumentView.valueChange(documentView, arg.pdffile, arg.pdffile.atttype);
				arg.domain.convertPDFLoading = true;
				//this.setActiveTabUI(pdfTabcode);
				LWFP.API.ModuleProcess.api.setActiveTabUI(pdfTabcode, arg.domain);
				LEAP.asyn(LEAP.DocumentView.loadDocument, arg.domain, 200, documentView, true, lab.innerText, pdfTabcode);
			}
		}
	}
	finally
	{
		tabCtrl = pdfTabcode = lab = con = null;
	}	
}

LEAP.DocumentView.IWebOffice.ConvertToOFD = function(e)
{	
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
		{
			LEAP.DocumentView.IWebOffice.ConvertToOFD_win(e);
		}
		else
		{
			LEAP.DocumentView.IWebOffice.ConvertToOFD_linux(e);
		}
	}
	finally
	{
		obj = url = null;
	}
}
LEAP.DocumentView.IWebOffice.ConvertToOFD_win = function(e)
{
	try
	{		
		var obj = LEAP.getElement('[ctf=officeobj]', e);			
		var doc = obj.ActiveDocument;
				
		var ret = LEAP.DocumentView.IWebOffice.save(e,false);
		if(ret==false)
			return;
		
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		
		var path = LEAP.DocumentView.IWebOffice._getTempFilePath(obj);
		var filename = path + UUID.randomUUID().replaceall('-', '') + ".ofd";
				
		doc.SaveAs2(filename,"102" );
		
		var uploadpath = e.getAttribute('uploadpath') == null?"default":e.getAttribute('uploadpath');
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "logic/WFOffice_save2?option=SAVEFILE&uploadpath=" + encodeURIComponent(uploadpath) + "&viewname=new.ofd"
						
		var httpclient = obj.Http;
		httpclient.AddFile("FileData", filename); // 需要上传的文件
       	if (httpclient.Open(1, uploadurl, false)) //true异步方式 ,false同步
		{
			if (!httpclient.Send()) 
			{
				//数据包发送失败！请检查链网络是否畅通。
				if (__alertResult==false){}else  LEAP.DocumentView.IWebOffice.__alert(e, "保存失败！");
				return false;
			} 
			else 
			{
				//数据包发送成功，文档已成功保存到后台
				var rst = httpclient.GetResponseHeader("RName");// 获取返回值
				if(rst)
					rst = eval("[" + rst + "]");
				
				LEAP.DocumentView.IWebOffice._ConvertToOFD_afterUpload(e, rst[0]);
			}
		} 
		else 
		{
			if (__alertResult==false){}else  LEAP.DocumentView.IWebOffice.__alert(e, "保存失败！");
			return false;
		}
		
		//LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
	}
	finally
	{
	
	}
}
LEAP.DocumentView.IWebOffice.ConvertToOFD_linux = function(e)
{
	try
	{
		if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment)
		{
			if( e[LEAP.DocumentView.n].attachment._hasPDFZW == true &&  e[LEAP.DocumentView.n].attachment._singlepdfzw == true)
			{
				if (!confirm("PDF格式正文已经存在，该操作将会覆盖原有文件，是否继续？"))
					return;
			}
		}
		
		var obj = LEAP.getElement('[ctf=officeobj]', e);			
		var doc = obj.WebObject.Application.ActiveDocument;
				
		var ret = LEAP.DocumentView.IWebOffice.save(e,false);
		if(ret==false)
			return;
		
		LEAP.DocumentView.IWebOffice.___delWaterMaker(e, obj);
		
		var filename = "/tmp/kgtmp_.ofd";
		
		doc.SaveAs2(filename, "102" );
		
		var uploadpath = e.getAttribute('uploadpath') == null?"default":e.getAttribute('uploadpath');
		//var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + "logic/WFOffice_save2?option=SAVEFILE&uploadpath=" + encodeURIComponent(uploadpath) + "&viewname=new.pdf"
		
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + 'logic/WFOffice_updateDoc2?isnew=1';			
			uploadurl += "&uploadpath=" + encodeURIComponent(uploadpath) + "&viewname=new.ofd";
		
		var ret = obj.WebUploadFile(uploadurl, filename);
		if (ret == true)
		{
			ret = obj.WebGetResponseBody();
			if (ret)
			{
				var rst = JSON.parse(ret);
				LEAP.DocumentView.IWebOffice._ConvertToOFD_afterUpload(e, rst);
			}
		}
		
		//LEAP.DocumentView.IWebOffice.___addWaterMaker(e, obj);
	}
	finally
	{
		obj = ret = v = WshShell = path = uploadpath = uploadurl = null;
	}
}
LEAP.DocumentView.IWebOffice._ConvertToOFD_afterUpload = function(e, resultURI)
{
	try
	{
		if (!e || !resultURI)
			return;
		
		var rst = resultURI;
		
		rst.atttype = LEAP.DocumentView.doctype.ofd;
		rst.updateType = 0; 
		if(e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment && e[LEAP.DocumentView.n].attachment.title){
			rst.title = e[LEAP.DocumentView.n].attachment.title;
		}
		
		if (rst.fileid == "null")
			rst.fileid = null;
		
		var m = PageObjectModel.getModule(e.getAttribute('instance'));
		if(m)
		{
			if (m.afterConvertOfd)
			{
				if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.tabinfo)
					m.afterConvertOfd({tabinfo:e[LEAP.DocumentView.n].param.exParam.tabinfo, ofdfile:rst});
				else
					m.afterConvertOfd({ofdfile:rst});
			}
			else
			{
				if (e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.tabinfo){
					var tabinfo = e[LEAP.DocumentView.n].param.exParam.tabinfo;
					LEAP.DocumentView.IWebOffice._inner_afterConvertOFD({tabinfo:e[LEAP.DocumentView.n].param.exParam.tabinfo, ofdfile:rst,domain:m});
				}
			
			}
		}
	}
	finally
	{

	}
}
LEAP.DocumentView.IWebOffice._inner_afterConvertOFD = function(arg)
{
	try
	{
		if(arg){
			
			var tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.moduleElement);
			if (!tabCtrl)
				tabCtrl = LEAP.getElement("div[wtf=tabcontrol]", arg.domain.parentPageModule.moduleElement);
			if (!tabCtrl)
				return null;
				
			var ofdTabcode = arg.tabinfo.ofdtabcode;
			
			var lab = LEAP.getElement("li[tabcode=" + ofdTabcode + "]", tabCtrl);
			if (lab == null)
				return null;
				
			lab.style.display = "block";
						
			var con = LEAP.getElement("div[tabcode=" + ofdTabcode + "]", tabCtrl);
			if (con)
			{
				var documentView = LEAP.getElement('div[ct=DocumentView]', con);
				arg.ofdfile.title = lab.innerText;
				
				LWFP.API.ModuleProcess.api.setActiveTabUI(ofdTabcode, arg.domain);
				LEAP.asyn(LEAP.DocumentView.loadDocument, arg.domain, 200, documentView, true, lab.innerText, ofdTabcode);
			}			
		}
	}
	finally
	{
		tabCtrl = ofdTabcode = lab = con = null;
	}	
}





LEAP.DocumentView.IWebOffice.close = function(e) 
{	
	try
	{
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)
			LEAP.DocumentView.IWebOffice.close_win(e);
		else
			LEAP.DocumentView.IWebOffice.close_linux(e);

	}
	finally
	{
		obj = data = readonly = null;
	}	
}
LEAP.DocumentView.IWebOffice.close_win = function(e) 
{	
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
		
		if(readonly==false)
		{	
			if (obj.ActiveDocument.saved == false)
			{
				if (LEAP.DocumentView.Browser.browser == "chrome")
					obj.HidePlugin(0);
		
				if(confirm("是否需要保存？"))
				{
					if (LEAP.DocumentView.Browser.browser == "chrome")
						obj.HidePlugin(1);
					
					LEAP.DocumentView.IWebOffice.save(e, false);
				}
			}
		}
		
		if (LEAP.DocumentView.Browser.browser == "chrome")
			obj.HidePlugin(1);
		
		obj.Close();
		window.close();

	}
	finally
	{
		obj = data = readonly = null;
	}	
	
}

LEAP.DocumentView.IWebOffice.close_linux = function(e) 
{	
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		var doc = obj.WebObject.Application.ActiveDocument;
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
		
		if(readonly==false)
		{
			if (doc.Saved == false)
			{
				if(confirm("是否需要保存？"))
				{
					LEAP.DocumentView.IWebOffice.save(e, false);
				}
			}
		}
				
		obj.close();
		obj.CloseCurPlugin();
		window.close();
	}
	finally
	{
		obj = data = readonly = null;
	}	
	
}

LEAP.DocumentView.IWebOffice.__pageClose = function(e) 
{	
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		var doc = null;
		if(LEAP.DocumentView.OSType.indexOf("Win") > -1)	
			doc = obj.ActiveDocument;
		else
			doc = obj.WebObject.Application.ActiveDocument;
			
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
		
		if(readonly==false)
		{	
			if (doc.saved == false)
			{
				return false;
			}
		}
		
		return true;
	}
	finally
	{
		obj = data = readonly = null;
	}	
	
}





LEAP.DocumentView.IWebOffice.__alert = function(e, content)
{
	var obj = LEAP.getElement('[ctf=officeobj]', e);
	if (!obj)
		return true;
			
	if(LEAP.DocumentView.OSType.indexOf("Win") > -1 && LEAP.DocumentView.Browser.browser == "chrome")
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		
		obj.__saved_before_hide = obj.ActiveDocument.saved;
		obj.HidePlugin(0);

	
		if (LEAP.DocumentView.IWebOffice.alertForm == null)
		{
			LEAP.DocumentView.IWebOffice.alertForm = LEAP.form.create3({name:null, title:'提示', width:500, height:150, formtype:3});
			
			var str = '<div style="height:100%; width:100%;">';
				str += '<div style="padding:10px 0px 0px 10px;">';
				str += '<span ut="content" class="LC_input_conner" style="width:97%;font-size:14px;border:none;"></span>';
				str += '</div>'
				str += '<input ut="submit" class="LC_button_conner LC_button_blue" style="float:right; margin:0px 30px 0px 0px;" type="button" value="确定" lcv="2" ht="input">'
				str += '</div>'
				
			LEAP.form.setContent(LEAP.DocumentView.IWebOffice.alertForm.form, str);
			
			_formElement = LEAP.getElement(LEAP.DocumentView.IWebOffice.alertForm.form);
			var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
			if (icon)
				icon.style.display = "none";
	
			var _btn = LEAP.getElement("input[ut=submit]", _formElement);
			LEAP.addEvent(_btn, 'click', LEAP.DocumentView.IWebOffice.__alert_callback, {viewer:e});
		}
		
		var span = LEAP.getElement("span[ut=content]", _formElement);
		span.textContent = content;
		
		LEAP.DocumentView.IWebOffice.alertForm.show();
	}
	else
	{
		alert(content);
	}
}

LEAP.DocumentView.IWebOffice.__alert_callback = function(arg)
{
	var e = arg.arg.viewer;
	var obj = LEAP.getElement('[ctf=officeobj]', e);
	if (!obj)
		return true;
	
	LEAP.DocumentView.IWebOffice.alertForm.hide();
	
	obj.HidePlugin(1);
	
	obj.ActiveDocument.saved = obj.__saved_before_hide;
}


LEAP.DocumentView.IWebOffice.getPluginType = function(filename)
{
	var _ex = /\.[^\.]+/.exec(filename.toLowerCase());		
	var strFileType = _ex[0];
	var nType = 1;
	
	if (strFileType == ".doc" || strFileType == ".docx")
		nType = 1;
	else if(strFileType == ".xls" || strFileType == ".xlsx")
		nType = 12;
	else if(strFileType == ".wps")
		nType = 1;
	else if(strFileType == ".et")
		nType = 12;
	else if (strFileType == ".ofd")
		nType = 3;            //数科ofd阅读器
		//nType = 4;            //福昕ofd阅读器
		//alert(nType);
	return nType;
}

LEAP.DocumentView.DocType = {DOC:1, XLS:2, PPT:3};
LEAP.DocumentView.getDocumentType = function(filename)
{
	var _ex = /\.[^\.]+/.exec(filename.toLowerCase());		
	var strFileType = _ex[0];
	var nType = LEAP.DocumentView.DocType.DOC;
	
	if (strFileType == ".doc" || strFileType == ".docx" || strFileType == ".wps")
		nType = LEAP.DocumentView.DocType.DOC;
	else if(strFileType == ".xls" || strFileType == ".xlsx" || strFileType == ".et")
		nType = LEAP.DocumentView.DocType.XLS;
	
	return nType;
}

/**
 * 永中NPAPI插件
 */

LEAP.DocumentView.YozoEditor = {};

LEAP.DocumentView.YozoEditor._buttonFrame = "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='submit'>保存</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='saveAs'>另存为</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='print'>打印</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='showMark'>显示痕迹</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='hideMark'>隐藏痕迹</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='importDoc'>导入文件</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='taohong'>正文套红</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='safeDoc'>锁定文件</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='deleteSafe'>取消锁定</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='ConvertPDF'>转为PDF格式</A>"
		+ "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='ConvertOFD'>转为OFD格式</A>"
		+ "<A class='wf_documentView_toolbar_btn' style='float:right;margin-right:10px; margin-left:0px;' href='javascript:' ht='button' at=1  al='fullscreen'>全屏</A>";

LEAP.DocumentView.YozoEditor._editorFrame = "<embed id='YozoEditor_{{$ID$}}' ctf='officeobj' type='application/x-yozo-plugin' width='100%' height='100%' >"
		+ "<param name='BorderStyle' value='91' />"
		+ "<param name='MousePointer' value='90' />"
		+ "<param name='Enabled' value='91' />"
		+ "<param name='Min' value='90' />"
		+ "<param name='Max' value='910' /></embed>";

LEAP.DocumentView.YozoEditor.init = function(e, bottom) {
	var fileType = 1;
	if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment) {
		fileType = LEAP.DocumentView.YozoEditor.getFileType(e);
	}
	// 文字-application/x-yozo-plugin 表格-application/x-yozoss-plugin
	// 简报ppt-application/x-yozopg-plugin
	if (fileType == 2) {// excel
		bottom.innerHTML = LEAP.DocumentView.YozoEditor._editorFrame.replace(
				'{{$ID$}}', e.getAttribute("instance")).replace(
				'x-yozo-plugin', 'x-yozoss-plugin');
	} else if (fileType == 3) {// ppt
		bottom.innerHTML = LEAP.DocumentView.YozoEditor._editorFrame.replace(
				'{{$ID$}}', e.getAttribute("instance")).replace(
				'x-yozo-plugin', 'x-yozopg-plugin');
	} else {// word
		bottom.innerHTML = LEAP.DocumentView.YozoEditor._editorFrame.replace(
				'{{$ID$}}', e.getAttribute("instance"));
	}
}

/**
 * 取文件类型，1：word(.doc|.docx),2:excel(.xls|.xlsx),3:ppt(.ppt|.pptx)
 * 
 * @param {}
 *            fileName 带后缀的文件名
 */
LEAP.DocumentView.YozoEditor.getFileType = function(e) {
	if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment) {
		var fileName = e[LEAP.DocumentView.n].attachment.name;
		var suffix = /\.[^\.]+/.exec(fileName);
		if (suffix == ".xls" || suffix == ".xlsx") {
			return 2;
		} else if (suffix == ".ppt" || suffix == ".pptx") {
			return 3;
		} else {
			return 1;
		}
	}
	return 1;
}

/**
 * 获取插件对象
 * 
 * @param {}
 *            e
 * @return {}
 */
LEAP.DocumentView.YozoEditor.getObj = function(e) {
	try {
		var el = document.getElementById("YozoEditor_"
				+ e.getAttribute("instance"));
		return {
			app : el.Application,
			obj : el
		};
	} finally {
		el = null;
	}
	return null;
}

/**
 * 按钮点击事件入口
 * 
 * @param {}
 *            e
 * @param {}
 *            al
 */
LEAP.DocumentView.YozoEditor.buttonClick = function(e, al) {
	if (al == "submit") {
		LEAP.DocumentView.YozoEditor.save(e);
	} else if (al == "saveAs") {
		LEAP.asyn(LEAP.DocumentView.YozoEditor.saveLocal, this, 0, e);
	} else if (al == "updatename") {
		LEAP.DocumentView.YozoEditor.updatename(e);
	} else if (al == "print") {
		LEAP.DocumentView.YozoEditor.printDoc(e);
	} else if (al == "showMark") {
		LEAP.DocumentView.YozoEditor.showRevisions(e);
	} else if (al == "hideMark") {
		LEAP.DocumentView.YozoEditor.hideRevisions(e);
	} else if (al == "importDoc") {
		LEAP.DocumentView.YozoEditor.importdoc(e);
	} else if (al == "taohong") {
		LEAP.DocumentView.YozoEditor.taohong(e);
	} else if (al == "safeDoc") {
		LEAP.DocumentView.YozoEditor.safeDoc(e);
	} else if (al == "deleteSafe") {
		LEAP.DocumentView.YozoEditor.deleteSafe(e);
	} else if (al == "ConvertPDF") {
		LEAP.DocumentView.YozoEditor.ConvertToPDF(e);
	} else if (al == "ConvertOFD") {
		LEAP.DocumentView.YozoEditor.ConvertToOFD(e);
	} else if (al == "fullscreen") {
		LEAP.DocumentView.YozoEditor.fullscreen(e);
	} else if (al == "close") {
		LEAP.DocumentView.YozoEditor.close(e);
	}
}

/**
 * 加载文档
 * 
 * @param {}
 *            e
 * @param {}
 *            url
 * @param {}
 *            type
 */
LEAP.DocumentView.YozoEditor.loadDocument = function(e, url, type) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (yozoApp) {
			var ret = yozoApp.openDocumentRemote(url, false);
			if (ret) {
				LEAP.DocumentView.YozoEditor.openDocAfter(e);
			}
		}
	} finally {
		yozoApp = null;
	}
}

/**
 * 获取用户信息
 * 
 * @param {}
 *            e
 * @return {}
 */
LEAP.DocumentView.YozoEditor.getUserConfig = function(e) {
	if (LEAP.DocumentView.YozoEditor.userconfig == null) {
		var module = LWFP.innerApi.getmodule(e);
		LEAP.DocumentView.YozoEditor.userconfig = {
			wordcorrections : 0
		};
		LEAP.DocumentView.YozoEditor.userconfig.username = LEAP.getUserInfo().fullName;
		LEAP.DocumentView.YozoEditor.userconfig.lock = module.request2({
					name : 'lbcp_getOfficeWordLock'
				});
		if (!LEAP.DocumentView.YozoEditor.userconfig.lock)
			LEAP.DocumentView.YozoEditor.userconfig.lock = "Longrise123456789";
	}

	return LEAP.DocumentView.YozoEditor.userconfig;
}

/**
 * 执行操作
 * 
 * @param {}
 *            e
 * @param {}
 *            param { buttons:更改要显示的功能按钮，按钮代码逗号分隔，如： "submit,saveAs" 按钮代码：
 *            submit保存 saveAs另存为 print打印 showMark显示痕迹 hideMark隐藏痕迹 importDoc导入文件
 *            doHandSign加入手写签批 doHandSecSign加入手写签名 taohong正文套红
 *            addServerSign添加服务器签章 addServer2Sign2添加服务器签章 safeDoc锁定文件
 *            deleteSafe取消锁定 ConvertPDF转为PDF格式 close关闭 fullscreen全屏 }
 */
LEAP.DocumentView.YozoEditor.oprate = function(e, param) {
	try {
		if (param && param.buttons) {
			var btns = param.buttons;

			var _arr = LEAP.getElements("a[at=1]", e);
			for (var i = 0; i < _arr.length; i++) {
				var _a = _arr[i];
				var _al = _a.getAttribute('al');
				if (btns.indexOf(_al) >= 0)
					_a.style.display = 'block';
				else
					_a.style.display = 'none';

				if (_al == 'fullscreen') {
					_a.style.display = 'block';
				} else if (_al == 'close') {
					if (e.getAttribute('newwindow') == "1")
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
		}
	} finally {
		btns = _arr = i = _a = _al = null;
	}
}

/**
 * 文档加载完成的回调方法
 * 
 * @param {}
 *            e
 */
LEAP.DocumentView.YozoEditor.openDocAfter = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return null;
		}
		var yozoApp = obj.app;
		if (yozoApp == null) {
			return null;
		}
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false) {
			readonly = true
		}
		var btns = "saveAs,print,showMark,hideMark,";
		if (readonly == false) {
			btns += "submit,";
		}
		if (data.doctype < 0) // 正文才使用正文按钮
		{
			if (data && data.param && data.param.wordButton
					&& data.param.wordButton != "")
				btns = data.param.wordButton;
		}

		var fileType = 1;
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment) {
			fileType = LEAP.DocumentView.YozoEditor.getFileType(e);
		}

		// 非word类型文档，隐藏相关按钮
		if (fileType == 3) {
			btns = btns.replace("showMark", "").replace("hideMark", "");
			btns = btns.replace("saveAs", "").replace("print", "");// 打印、另存为，没搞定
		}
		if (fileType == 2) {
			btns = btns.replace("showMark", "").replace("hideMark", "");
			btns = btns.replace("print", "");// 打印，没搞定
		}

		var _arr = LEAP.getElements("a[at=1]", e);
		for (var i = 0; i < _arr.length; i++) {
			var _a = _arr[i];
			var _al = _a.getAttribute('al');
			if (btns.indexOf(_al) >= 0) {
				_a.style.display = 'block';

				if (_al == 'updatename') {
					if (readonly == false)
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			} else {
				_a.style.display = 'none';
			}
			if (_al == 'fullscreen') {
				_a.style.display = 'block';
			} else if (_al == 'close') {
				if (e.getAttribute('newwindow') == "1")
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
			}
		}
		/**
		 * 隐藏不必要的菜单，禁用相关按钮
		 */
		var rbView = yozoApp.RibbonView;
		if (rbView && rbView.FileMenu) {
			rbView.FileMenu.Visible = false; // 隐藏文件菜单栏
		}
		var rbTabs = rbView.Tabs;
		if (rbTabs && rbTabs.Tab("开发工具")) {
			rbTabs.Tab("开发工具").Visible = false;// 隐藏选项卡
		}
		if (fileType == 1) {
			var rtTab = rbTabs.Tab("审阅");
			if (rtTab) {
				rtTab.FindControl(8400).Enabled = false; // 禁用保护文档按钮
			}
		}
		var rtTab = rbTabs.Tab("开始");
		if (rtTab) {
			rtTab.FindControl(4790).Enabled = false; // 禁用保存按钮
			rtTab.FindControl(4792).Enabled = false; // 禁用打印按钮
		}
		// 非word类型文档
		if (fileType == 3 || fileType == 2) {
			return;
		}
		var userConfig = LEAP.DocumentView.YozoEditor.getUserConfig(e);
		/**
		 * 设置打开的用户
		 */
		yozoApp.ActiveDocument.Application.UserName = LEAP.DocumentView.YozoEditor.userconfig.username;
		yozoApp.showRevision(2);// 显示修订的最终状态
		if (yozoApp.ActiveDocument
				&& yozoApp.ActiveDocument.ProtectionType == 3) { // 保护模式不处理
		} else {
			if (yozoApp.ActiveDocument) {
				// 判断用户的设置，wordcorrections 没有取值，写死的？？
				if (LEAP.DocumentView.YozoEditor.userconfig
						&& LEAP.DocumentView.YozoEditor.userconfig.wordcorrections == 1) {
					yozoApp.showRevision(0);
				} else {
					yozoApp.showRevision(2);
				}
			}
		}
		yozoApp.enableRevision(true);// 开启修订

		LEAP.DocumentView.YozoEditor.___addWaterMaker(e, yozoApp);
		// 防止空文档被保存
		yozoApp.ActiveDocument.Saved = true;
		// LEAP.DocumentView.YozoEditor.__initTemplateValue(e);
		LEAP.asyn(LEAP.DocumentView.YozoEditor.___resize, this, 1000, e,
				yozoApp.ActiveDocument.Saved);
	} catch (err) {
		alert(err);
	} finally {
		yozoApp = data = readonly = btns = _arr = i = _a = _al = userConfig = null;
	}
}

/**
 * 添加水印
 * 
 * @param {}
 *            e
 * @param {}
 *            activexObj
 */
LEAP.DocumentView.YozoEditor.___addWaterMaker = function(e, yozoApp) {
	LEAP.asyn(LEAP.DocumentView.YozoEditor.___addWaterMaker_, this, 100, e,
			yozoApp);
}

LEAP.DocumentView.YozoEditor.___addWaterMaker_ = function(e, yozoApp) {
	try {
		if (window._showmark != '0') {

			var waterUrl = LEAP.wfrouter.getServerURL(LEAP.wfrouter
					.getRouter(e))
					+ LEAP.getWaterMark();
			var localTmpPath = yozoApp.DownloadFile(waterUrl);
			var doc = yozoApp.ActiveDocument;
			doc.Background.Fill.Transparency = 0;
			// doc.Background.Fill.UserPicture(localTmpPath);
			doc.Background.Fill.UserTextured(localTmpPath);
			doc.ActiveWindow.View.DisplayBackgrounds = true;
		}
	} finally {

	}
}

/**
 * 去除水印
 * 
 * @param {}
 *            e
 * @param {}
 *            activexObj
 */
LEAP.DocumentView.YozoEditor.___delWaterMaker = function(e, yozoApp) {
	try {
		yozoApp.ActiveDocument.Background.Fill.Visible = false;
	} catch (e) {
	}
}

LEAP.DocumentView.YozoEditor.___resize = function(e, saved) {
	try {
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.exParam
				&& e[LEAP.DocumentView.n].param.exParam.isOpenWindow == true) {
			var top = LEAP.getElement("[ar=top]", e);
			var bottom = LEAP.getElement("[ar=bottom]", e);
			bottom.style.height = (e.clientHeight - top.clientHeight) + 'px';
		}
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (saved != null)
			yozoApp.activeDocument.Saved = saved;
		var str = "<div style='text-align:left; width:440px; padding:2px 10px 2px 10px; color:red;'>"
				+ "温馨提示：为避免因长时间未操作导致连接超时引起工作丢失，请及时保存文件！" + "</div>"
		LEAP.smallTip.show(str, document.body.clientWidth - 470, 30, null);
	} finally {
		top = bottom = null;
	}
}

LEAP.DocumentView.YozoEditor.__initTemplateValue = function(e) {// ////
	try {
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.templateValueFn)
			e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn
					.call(this);
		if (e[LEAP.DocumentView.n].param == null
				|| e[LEAP.DocumentView.n].param.templateValues == null)
			return;

		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		if (!yozoApp.ActiveDocument)
			return;

		var flag = false;
		if (yozoApp.ActiveDocument.ProtectionType == 2) {
			flag = true;
			yozoApp.ActiveDocument.Protect(3, false,
					LEAP.DocumentView.YozoEditor.userconfig.lock);
		}
		LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
		if (yozoApp.ActiveDocument.BookMarks) {
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			var bookmarks = yozoApp.ActiveDocument.Bookmarks;
			for (var i = 0; i < bookMarkslist.length; i++) {
				if (bookmarks.Exists(bookMarkslist[i][0])) {
					var bookmark = bookmarks.Item(bookMarkslist[i][0]);
					var range = bookmark.Range;
					bookmark.Delete();
					range.Select();
					range.Text = bookMarkslist[i][1];
					bookmarks.Add(bookMarkslist[i][0], range);
				}
			}
		}
		LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		if (flag == true)
			yozoApp.ActiveDocument.Protect(3, false,
					LEAP.DocumentView.YozoEditor.userconfig.lock);
	} finally {
		yozoApp = bookMarkslist = i = null;
	}
}

/**
 * 修改文件名
 * 
 * @param {}
 *            arg
 */
LEAP.DocumentView.YozoEditor.updatename = function(arg) {
	try {
		if (arg.arg == null) {
			var e = arg;
			var _formElement = null;
			var _txt = null;
			var _btn = null;
			if (LEAP.DocumentView.YozoEditor.udpform == null) {
				LEAP.DocumentView.YozoEditor.udpform = LEAP.form.create3({
							name : null,
							title : '修改文件名',
							width : 500,
							height : 150,
							formtype : 3
						});

				var str = '<div style="height:100%; width:100%;">';
				str += '<input ut="filename" class="LC_input_conner" style="width:97%; margin:10px 2% 10px 1%;" lcv="2" mdtype="text" bt="text" ht="input">';
				str += '<input ut="submit" class="LC_button_conner LC_button_blue" style="float:right; margin:0px 30px 0px 0px;" type="button" value="确定" lcv="2" ht="input">'
				str += '</div>'

				LEAP.form.setContent(LEAP.DocumentView.YozoEditor.udpform.form,
						str);

				_formElement = LEAP
						.getElement(LEAP.DocumentView.YozoEditor.udpform.form);
				LEAP.DocumentView.YozoEditor.udpform._txt = LEAP.getElement(
						"input[ut=filename]", _formElement);
				_btn = LEAP.getElement("input[ut=submit]", _formElement);
				LEAP.addEvent(_btn, 'click',
						LEAP.DocumentView.YozoEditor.updatename, {
							iscallback : true
						});
			}

			var title = "";
			if (e[LEAP.DocumentView.n].isnew
					&& e[LEAP.DocumentView.n].isnew == true)
				title = e.getAttribute('defaultName') ? e
						.getAttribute('defaultName') : "";
			else
				title = e[LEAP.DocumentView.n].attachment.title;

			LEAP.DocumentView.YozoEditor.udpform.FileName = title;
			LEAP.DocumentView.YozoEditor.udpform._txt.value = title;
			LEAP.DocumentView.YozoEditor.udpform.ele = e;

			LEAP.form.show(LEAP.DocumentView.YozoEditor.udpform.form);
		} else {
			var _title = LEAP.DocumentView.YozoEditor.udpform._txt.value.trim();
			if (_title == '') {
				alert('文件名不可为空！');
				return;
			}
			if ((_title.indexof('\\') >= 0) || (_title.indexof('/') >= 0)
					|| (_title.indexof(':') >= 0) || (_title.indexof('*') >= 0)
					|| (_title.indexof('?') >= 0) || (_title.indexof('"') >= 0)
					|| (_title.indexof('<') >= 0) || (_title.indexof('>') >= 0)
					|| (_title.indexof('|') >= 0)) {
				alert('文件名不可包含如下字符： \\ / : * ? " < > |');
				return;
			}

			LEAP.form.hide(LEAP.DocumentView.YozoEditor.udpform.form);
			var e = LEAP.DocumentView.YozoEditor.udpform.ele;
			if (e[LEAP.DocumentView.n].isnew
					&& e[LEAP.DocumentView.n].isnew == true) {
				e.setAttribute('defaultName', _title);
			} else {
				var att = e[LEAP.DocumentView.n].attachment;
				att.title = _title;
				if (att.updateType == null)
					att.updateType = 1;
				LEAP.DocumentView.valueChange(e, att);
			}
		}
	} finally {
		e = _formElement = _txt = _btn = str = title = _title = e = att = null;
	}
}

/**
 * 文档保存方法
 * 
 * @param {}
 *            e
 * @param {}
 *            __alertResult
 * @return {}
 */
LEAP.DocumentView.YozoEditor.save = function(e, __alertResult) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return false;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return false;
		var type = LEAP.DocumentView.YozoEditor.getFileType(e);

		if (type == 1 && !yozoApp.ActiveDocument) {
			return true;
		}

		if (type == 1 && yozoApp.ActiveDocument.Saved == true) {
			return true;
		}
		LEAP.DocumentView.YozoEditor.___delWaterMaker(e, yozoApp);
		var res;
		if (e[LEAP.DocumentView.n].isnew
				&& e[LEAP.DocumentView.n].isnew == true) {
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e))
					+ 'logic/WFOffice_updateDoc2_Yozo?isnew=1';
			url += '&uploadpath='
					+ encodeURIComponent(e.getAttribute('uploadpath') ? e
							.getAttribute('uploadpath') : "default")
					+ '&viewname=' + encodeURIComponent('new.doc');
			res = yozoApp.saveURL(url, '*.doc');
		} else {
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e))
					+ 'logic/WFOffice_updateDoc_Yozo?'
					+ 'namedpath='
					+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath)
					+ '&name='
					+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);
			if (e[LEAP.DocumentView.n].attachment
					&& e[LEAP.DocumentView.n].attachment.id)
				url += "&attid="
						+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
			if (e[LEAP.DocumentView.n].attachment
					&& e[LEAP.DocumentView.n].attachment.entryid)
				url += "&attentryid="
						+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
			if (e[LEAP.DocumentView.n].param
					&& e[LEAP.DocumentView.n].param.exParam2
					&& e[LEAP.DocumentView.n].param.exParam2.businessid)
				url += "&attbusinessid="
						+ encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
			if (e[LEAP.DocumentView.n].param
					&& e[LEAP.DocumentView.n].param.currentstep
					&& e[LEAP.DocumentView.n].param.currentstep.hsid)
				url += "&attcategory="
						+ encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
			res = yozoApp.saveURL(url, e[LEAP.DocumentView.n].attachment.name);
		}
		if (res) {
			if (e[LEAP.DocumentView.n].isnew == true) {
				var res = eval("[" + res + "]");
				var res = res[0];
				var _att = {};
				_att.fileid = res.fileid;
				_att.atttype = e[LEAP.DocumentView.n].doctype;
				_att.title = e.getAttribute('defaultName') ? e
						.getAttribute('defaultName') : "新建正文";
				_att.name = res.name;
				_att.namedpath = res.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;
				_att.uploadtime = {
					time : LEAP.getUserInfo().getTimeTicket()
				};
				_att.canDelete = true;
				_att.canEdit = true;
				LEAP.DocumentView.valueChange(e, _att);
			}

			if (__alertResult == false) {
			} else {
				alert("保存成功");
			}

			if (type == 1) {
				yozoApp.ActiveDocument.Saved = true;
			}
			return true;
		} else {
			if (__alertResult == false) {
			} else
				alert("保存失败!");
			return false;
		}
	} catch (e) {
	} finally {
		LEAP.DocumentView.YozoEditor.___addWaterMaker(e, yozoApp);
		yozoApp = res = url = _att = null;
	}
}

LEAP.DocumentView.YozoEditor.saveLocal = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;
		LEAP.DocumentView.YozoEditor.___delWaterMaker(e, yozoApp);
		LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
		var dlg = yozoApp.FileDialog(2);
		dlg.Show(function(dlg) {
					if (dlg.SelectedItems(2)) {
						dlg.Application.ActiveDocument.SaveAs2(dlg
								.SelectedItems(2));
					}
					var o = LEAP.DocumentView.YozoEditor.getObj(e);
					LEAP.DocumentView.YozoEditor.___addWaterMaker(e, o.app);
					LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
				});
	} finally {
		yozoApp = dlg = null;
	}
}

LEAP.DocumentView.YozoEditor.printDoc = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;
		LEAP.DocumentView.YozoEditor.___delWaterMaker(e, yozoApp);
		var dlg = yozoApp.Dialogs.Item(88);
		dlg.Show(function(dlg) {
					var o = LEAP.DocumentView.YozoEditor.getObj(e);
					LEAP.DocumentView.YozoEditor.___addWaterMaker(e, o.app);
				});
		// yozoApp.Dialogs.Item(88).Show();
		// 打印、不打印修订文字接口原型PrintRevision( )
		/*
		 * flag——为0表示打印修订状态； 为1表示打印原始状态(修订前)； 为2表示打印最终状态(修订后)。
		 * Application.printRevision(flag);
		 */
	} catch (e) {
		// alert("打印失败：请确保打印机已经开启，并且打印服务已经启动！");
	} finally {
		// LEAP.DocumentView.YozoEditor.___addWaterMaker(e, yozoApp);
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor.showRevisions = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp || !yozoApp.ActiveDocument)
			return;

		if (yozoApp.ActiveDocument && yozoApp.ActiveDocument.ProtectionType
				&& yozoApp.ActiveDocument.ProtectionType == 3) {
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		yozoApp.showRevision(0);
	} finally {
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor.hideRevisions = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		if (!yozoApp.ActiveDocument)
			return;

		if (yozoApp.ActiveDocument && yozoApp.ActiveDocument.ProtectionType
				&& yozoApp.ActiveDocument.ProtectionType == 3) {
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		yozoApp.showRevision(2);
	} finally {
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor.importdoc = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		if (!yozoApp.ActiveDocument)
			return;

		if (yozoApp.ActiveDocument && yozoApp.ActiveDocument.ProtectionType
				&& yozoApp.ActiveDocument.ProtectionType == 3) {
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}
		var dlg = yozoApp.FileDialog(1);
		dlg.Show(function(dlg) {
					var filePath = dlg.SelectedItems.Item(1);
					// dlg.Application.Documents.Open(dlg.SelectedItems(1));
					if (filePath) {
						obj.obj.LoadDocument(filePath, false);
						yozoApp.enableRevision(true);// 开启修订
					}
				});
	} finally {
		yozoApp = null;
	}
}

/**
 * 套红方法
 * 
 * @param {}
 *            e
 */
LEAP.DocumentView.YozoEditor.taohong = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		if (!yozoApp.ActiveDocument)
			return;

		if (yozoApp.ActiveDocument && yozoApp.ActiveDocument.ProtectionType
				&& yozoApp.ActiveDocument.ProtectionType == 3) {
			alert("文件处于保护状态.不支持当前操作!");
			return;
		}

		var module = LWFP.innerApi.getmodule(e);
		var templates = null;
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.businessNo)
			templates = module.request2({
						name : 'lbcp_getTemplateForBusinessNo',
						par : {
							businessNo : e[LEAP.DocumentView.n].param.businessNo
						}
					});
		if (!templates) {
			alert("暂无可用套红模板，请先在模板配置中进行设置！");
			return;
		}

		if (LEAP.DocumentView.YozoEditor.templateForm == null) {
			LEAP.DocumentView.YozoEditor.templateForm = LEAP.form.create3({
						name : null,
						title : '选择套红模板',
						width : 550,
						height : 330,
						formtype : 3
					});

			var str = '<select ut="templates" size=5 style="width:100%; height:230px; font-size:14px;"></select>';
			str += '<br/>';
			str += '<button ut="btn_confirm" type="button" style="float:right; margin:10px 30px; font-size:14px; padding:5px 20px;">套&nbsp;&nbsp;红</button>';
			str += '<button ut="btn_cancel" type="button" style="float:right; margin:10px 10px; font-size:14px; padding:5px 20px;">取&nbsp;&nbsp;消</button>';

			LEAP.form.setContent(
					LEAP.DocumentView.YozoEditor.templateForm.form, str);

			var _formElement = LEAP
					.getElement(LEAP.DocumentView.YozoEditor.templateForm.form);
			var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
			if (icon)
				icon.style.display = "none";

			var select = LEAP.getElement("[ut=templates]", _formElement);
			for (var i = 0; i < templates.result.length; i++) {
				var tmp = templates.result[i];
				var myOption = document.createElement("option"); // 动态创建option标签
				myOption.style.margin = "4px 5px";
				myOption.value = tmp.templatename; // 红头文档id
				myOption.text = tmp.templatename; // 红头文档名称
				myOption["data"] = tmp;

				select.add(myOption);
			}

			var btn_confirm = LEAP.getElement("[ut=btn_confirm]", _formElement);
			var btn_cancel = LEAP.getElement("[ut=btn_cancel]", _formElement);

			LEAP.addEvent(btn_confirm, 'click',
					LEAP.DocumentView.YozoEditor.taohong_step2);
			LEAP.addEvent(btn_cancel, 'click',
					LEAP.DocumentView.YozoEditor.taohong_step2);
		}

		LEAP.DocumentView.YozoEditor.templateForm.ele = e;
		LEAP.form.show(LEAP.DocumentView.YozoEditor.templateForm.form);
	} finally {
		yozoApp = module = templates = str = _formElement = icon = select = tmp = myOption = btn_confirm = btn_cancel = null;
	}
}

LEAP.DocumentView.YozoEditor.taohong_step2 = function(arg) {
	try {
		var e = LEAP.DocumentView.YozoEditor.templateForm.ele;
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		if (!yozoApp.ActiveDocument)
			return;
		var template = null;
		var btn = arg.e.srcElement;
		if (btn.getAttribute("ut") == "btn_cancel") {
			LEAP.form.hide(LEAP.DocumentView.YozoEditor.templateForm.form);
			return;
		} else {
			var _formElement = LEAP
					.getElement(LEAP.DocumentView.YozoEditor.templateForm.form);
			var select = LEAP.getElement("[ut=templates]", _formElement);

			var index = select.selectedIndex;
			if (index == -1) { // 添加未选中数据时的异常处理
				alert("请先选择红头文件后再进行套红头！");
				return;
			}
			template = select.options[index]["data"];
			LEAP.form.hide(LEAP.DocumentView.YozoEditor.templateForm.form);
		}

		/**
		 * template.mode == 2 模板到正文，相当于拷贝正文的所有内容到模板的第一行 template.mode != 2
		 * 正文到模板，以书签的形式
		 */
		if (template.mode && template.mode == 2) {
			var _url = LEAP.DocumentView._getPath(
					e[LEAP.DocumentView.n].attachment, e);
			LEAP.DocumentView.YozoEditor.save(e, false);
			if (!_url) {
				_url = LEAP.DocumentView._getPath(
						e[LEAP.DocumentView.n].attachment, e);
			}
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter
					.getRouter(e))
					+ "LEAP/Download/" + template.path;

			LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

			var curSel = yozoApp.ActiveDocument.Application.Selection;
			var view_ = yozoApp.ActiveDocument.Application.ActiveWindow.View;
			curSel.WholeStory();
			curSel.Copy();
			yozoApp.openDocumentRemote(templatepath, false);

			LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

			// 正文内容加载完毕之后再针对模板中的其他书签进行设置
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
					&& e[LEAP.DocumentView.n].param.templateValueFn)
				e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn
						.call(this);

			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
					&& e[LEAP.DocumentView.n].param.templateValues) {
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				var bookmarks = yozoApp.ActiveDocument.Bookmarks;
				for (var i = 0; i < bookMarkslist.length; i++) {
					if (bookmarks.Exists(bookMarkslist[i][0])) {
						var bookmark = bookmarks.Item(bookMarkslist[i][0]);
						var range = bookmark.Range;
						bookmark.Delete();
						range.Select();
						range.Text = bookMarkslist[i][1];
						bookmarks.Add(bookMarkslist[i][0], range);
					}
				}
			}
			// 定位到第一行
			yozoApp.ActiveDocument.Application.Selection.HomeKey(6);
			yozoApp.ActiveDocument.Application.Selection.Paste();
			yozoApp.ActiveDocument.Application.Selection.HomeKey(6); // 光标回到第一行
			LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态

		} else {
			// 拼凑套红模板的路径
			var templatepath = LEAP.wfrouter.getServerURL(LEAP.wfrouter
					.getRouter(e))
					+ "LEAP/Download/" + template.path;
			LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态
			// 选择对象当前文档的所有内容
			var curSel = yozoApp.ActiveDocument.Application.Selection;
			var view_ = yozoApp.ActiveDocument.Application.ActiveWindow.View;
			curSel.WholeStory();
			curSel.Cut();

			// 插入模板
			// 打开红头模板,用此方法打开，会保留红头模板所有格式，有个小问题，如果需要打开原始正文，须关闭窗口，重新打开。
			yozoApp.openDocumentRemote(templatepath, false);
			LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

			var bookmarks = yozoApp.ActiveDocument.Bookmarks;

			var BookMarkName = "zhengwen";
			if (!bookmarks.Exists(BookMarkName)) {
				alert("红头模板中不存在正文(书签名：zhengwen)书签！");
				return;
			}
			var bkmkObj = bookmarks.Item(BookMarkName);
			var saverange = bkmkObj.Range;
			var fontName = saverange.Font.Name;// 取得正文书签字体类型
			var fontSize = saverange.Font.Size;// 取得正文书签字体大小
			saverange.Paste();
			// yozoApp.ActiveDocument.Bookmarks.Add(BookMarkName, saverange);//
			// 此方法会导致书签格式丢失
			// 正文内容加载完毕之后再针对模板中的其他书签进行设置
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
					&& e[LEAP.DocumentView.n].param.templateValueFn)
				e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn
						.call(this);
			if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
					&& e[LEAP.DocumentView.n].param.templateValues) {
				var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
				for (var i = 0; i < bookMarkslist.length; i++) {
					if (bookmarks.Exists(bookMarkslist[i][0])) {
						var bookmark = bookmarks.Item(bookMarkslist[i][0]);
						var range = bookmark.Range;
						bookmark.Delete();
						range.Select();
						range.Text = bookMarkslist[i][1];
						bookmarks.Add(bookMarkslist[i][0], range);
					}
				}
			}
			yozoApp.ActiveDocument.Application.Selection.HomeKey(6); // 光标回到第一行
			LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		}
	} finally {
		e = yozoApp = template = btn = _formElement = select = index = _url = templatepath = curSel = view_ = null;
		bookMarkslist = bookmarks = bookmark = range = bkmkObj = saverange = fontName = fontSize = null;
	}
}

LEAP.DocumentView.YozoEditor.setBookmarkValues = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		if (!yozoApp.ActiveDocument)
			return;

		LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.templateValueFn)
			e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn
					.call(this);

		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.templateValues) {
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			var bookmarks = yozoApp.ActiveDocument.Bookmarks;
			for (var i = 0; i < bookMarkslist.length; i++) {
				if (bookmarks.Exists(bookMarkslist[i][0])) {
					var bookmark = bookmarks.Item(bookMarkslist[i][0]);
					var range = bookmark.Range;
					bookmark.Delete();
					range.Select();
					range.Text = bookMarkslist[i][1];
					bookmarks.Add(bookMarkslist[i][0], range);
				}
			}
		}
		LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态

		return true;
	} finally {
		yozoApp = bookMarkslist = bookmarks = bookmark = range = i = null;
	}
}

// 进入或退出强制痕迹保留状态，调用该函数下面定义的两个函数。一般可直接调用本函数。
LEAP.DocumentView.YozoEditor.TANGER_OCX_SetMarkModify = function(e, boolvalue) {
	LEAP.DocumentView.YozoEditor.TANGER_OCX_SetReviewMode(e, boolvalue);
	LEAP.DocumentView.YozoEditor.TANGER_OCX_EnableReviewBar(e, boolvalue);
}

// 允许或禁止显示修订工具栏和工具菜单（保护修订,用户不能更改当前修订状态)
LEAP.DocumentView.YozoEditor.TANGER_OCX_EnableReviewBar = function(e, boolvalue) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp) {
			return;
		}
		var rbView = yozoApp.RibbonView;
		var rbTabs = rbView.Tabs;
		var rtTab = rbTabs.Tab("审阅");
		if (rtTab) {
			rtTab.Groups.Group("修订").Visible = boolvalue; // 修订
		}
	} finally {
		yozoApp = rbView = rbTabs = rtTab = null;
	}
}

// 打开或者关闭修订模式
LEAP.DocumentView.YozoEditor.TANGER_OCX_SetReviewMode = function(e, boolvalue) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp) {
			return;
		}
		yozoApp.showRevision(2);
		yozoApp.enableRevision(boolvalue);// 开启修订
	} finally {
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor.safeDoc = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp) {
			return;
		}
		yozoApp.ActiveDocument.Protect(3, false,
				LEAP.DocumentView.YozoEditor.userconfig.lock);
	} finally {
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor.deleteSafe = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;
		yozoApp.ActiveDocument
				.Unprotect(LEAP.DocumentView.YozoEditor.userconfig.lock);
		yozoApp.enableRevision(true);// 开启修订,锁定解锁后会把修订关闭，重新打开
	} finally {
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor.fullscreen = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;
		yozoApp.fullScreen();
	} finally {
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor.close = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;
		if (!yozoApp.ActiveDocument)
			return;
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true

		if (readonly == false) {
			if (yozoApp.ActiveDocument.Saved == false) {
				if (confirm("是否需要保存？")) {
					LEAP.DocumentView.YozoEditor.save(e, false);
				}
			}
		}
		yozoApp.Close();
		window.close();
	} finally {
		yozoApp = data = readonly = null;
	}

}

LEAP.DocumentView.YozoEditor.__pageClose = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		if (!yozoApp.ActiveDocument)
			return;

		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true

		if (readonly == false) {
			if (yozoApp.ActiveDocument.Saved == false) {
				return false;
			}
		}

		return true;
	} finally {
		yozoApp = data = readonly = null;
	}
}

/**
 * 转换成ofd
 * 
 * @param {}
 *            e
 */
LEAP.DocumentView.YozoEditor.ConvertToOFD = function(e) {
	try {
		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		var b = LEAP.DocumentView.YozoEditor.save(e, false);
		if (b == false) {
			alert("文件保存失败!");
			return;
		}
		var rst = null;
		var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e))
				+ 'logic/'
				+ 'WFOffice_updateDoc_Yozo_To_PDFOrOFD'
				+ '?flag=ofd&namedpath='
				+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath)
				+ '&name='
				+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);
		if (e[LEAP.DocumentView.n].attachment
				&& e[LEAP.DocumentView.n].attachment.id)
			url += "&attid="
					+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
		if (e[LEAP.DocumentView.n].attachment
				&& e[LEAP.DocumentView.n].attachment.entryid)
			url += "&attentryid="
					+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
		if (e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.exParam2
				&& e[LEAP.DocumentView.n].param.exParam2.businessid) {
			url += "&attbusinessid="
					+ encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
		}
		if (e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.currentstep
				&& e[LEAP.DocumentView.n].param.currentstep.hsid) {
			url += "&attcategory="
					+ encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);
		}

		rst = yozoApp.saveURL(url, "new.ofd");
		if (rst == null || rst == false) {
			alert("文件转换失败!");
			return;
		}

		var ofdfile = LWFP.innerApi.clone(e[LEAP.DocumentView.n].attachment);
		ofdfile.id = null;
		ofdfile.name = ofdfile.name.substring(0, ofdfile.name.lastIndexOf("."))
				+ ".ofd";
		ofdfile.updateType = 0;
		ofdfile.atttype = LEAP.DocumentView.doctype.ofd;

		var tabinfo = e[LEAP.DocumentView.n].param.exParam.tabinfo;
		var m = PageObjectModel.getModule(e.getAttribute('instance'));
		if (m) {
			if (m.afterConvertOfd) {
				if (e[LEAP.DocumentView.n].param
						&& e[LEAP.DocumentView.n].param.exParam && tabinfo)
					m.afterConvertOfd({
								tabinfo : tabinfo,
								ofdfile : ofdfile
							});
				else
					m.afterConvertOfd({
								ofdfile : ofdfile
							});
			} else {
				if (e[LEAP.DocumentView.n].param
						&& e[LEAP.DocumentView.n].param.exParam && tabinfo) {
					LEAP.DocumentView.YozoEditor._inner_afterConvertOFD({
								tabinfo : tabinfo,
								ofdfile : ofdfile,
								domain : m
							});
				}
			}
		}
	} finally {
		yozoApp = rst = url = rst = ofdfile = tabinfo = m = null;
	}
}

LEAP.DocumentView.YozoEditor._inner_afterConvertOFD = function(arg) {
	try {
		if (arg) {
			var tabCtrl = LEAP.getElement("div[wtf=tabcontrol]",
					arg.domain.moduleElement);
			if (!tabCtrl)
				tabCtrl = LEAP.getElement("div[wtf=tabcontrol]",
						arg.domain.parentPageModule.moduleElement);
			if (!tabCtrl)
				return null;
			var ofdTabcode = arg.tabinfo.ofdtabcode;
			var lab = LEAP
					.getElement("li[tabcode=" + ofdTabcode + "]", tabCtrl);
			if (lab == null)
				return null;
			lab.style.display = "block";
			var con = LEAP.getElement("div[tabcode=" + ofdTabcode + "]",
					tabCtrl);
			if (con) {
				var documentView = LEAP.getElement('div[ct=DocumentView]', con);
				arg.ofdfile.title = lab.innerText;

				LEAP.DocumentView.valueChange(documentView, arg.ofdfile,
						arg.ofdfile.atttype);
				LWFP.API.ModuleProcess.api.setActiveTabUI(ofdTabcode,
						arg.domain);
			}
		}
	} finally {
		tabCtrl = ofdTabcode = lab = con = null;
	}
}

/**
 * 转换成pdf
 * 
 * @param {}
 *            e
 */
LEAP.DocumentView.YozoEditor.ConvertToPDF = function(e) {
	try {
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].attachment) {
			if (e[LEAP.DocumentView.n].attachment._hasPDFZW == true
					&& e[LEAP.DocumentView.n].attachment._singlepdfzw == true) {
				if (!confirm("PDF格式正文已经存在，该操作将会覆盖原有文件，是否继续？"))
					return;
			}
		}

		var obj = LEAP.DocumentView.YozoEditor.getObj(e);
		if (!obj) {
			return;
		}
		var yozoApp = obj.app;
		if (!yozoApp)
			return;

		var b = LEAP.DocumentView.YozoEditor.save(e, false);
		if (b == false) {
			alert("文件保存失败!");
			return;
		}
		var rst = null;
		var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e))
				+ 'logic/'
				+ 'WFOffice_updateDoc_Yozo_To_PDFOrOFD'
				+ '?flag=pdf&namedpath='
				+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.namedpath)
				+ '&name='
				+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.name);
		if (e[LEAP.DocumentView.n].attachment
				&& e[LEAP.DocumentView.n].attachment.id)
			url += "&attid="
					+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.id);
		if (e[LEAP.DocumentView.n].attachment
				&& e[LEAP.DocumentView.n].attachment.entryid)
			url += "&attentryid="
					+ encodeURIComponent(e[LEAP.DocumentView.n].attachment.entryid);
		if (e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.exParam2
				&& e[LEAP.DocumentView.n].param.exParam2.businessid)
			url += "&attbusinessid="
					+ encodeURIComponent(e[LEAP.DocumentView.n].param.exParam2.businessid);
		if (e[LEAP.DocumentView.n].param
				&& e[LEAP.DocumentView.n].param.currentstep
				&& e[LEAP.DocumentView.n].param.currentstep.hsid)
			url += "&attcategory="
					+ encodeURIComponent(e[LEAP.DocumentView.n].param.currentstep.hsid);

		rst = yozoApp.saveURL(url, "new.pdf");
		if (rst == null || rst == false) {
			alert("文件转换失败!");
			return;
		}

		rst.atttype = LEAP.DocumentView.doctype.pdf;
		rst.updateType = 0;
		rst.title = e[LEAP.DocumentView.n].attachment.title;
		if (rst.fileid == "null")
			rst.fileid = null;

		var m = PageObjectModel.getModule(e.getAttribute('instance'));
		if (m) {
			if (m.afterConvertPdf) {
				if (e[LEAP.DocumentView.n].param
						&& e[LEAP.DocumentView.n].param.exParam
						&& e[LEAP.DocumentView.n].param.exParam.tabinfo)
					m.afterConvertPdf({
								tabinfo : e[LEAP.DocumentView.n].param.exParam.tabinfo,
								pdffile : rst
							});
				else
					m.afterConvertPdf({
								pdffile : rst
							});
			} else {
				if (e[LEAP.DocumentView.n].param
						&& e[LEAP.DocumentView.n].param.exParam
						&& e[LEAP.DocumentView.n].param.exParam.tabinfo) {
					var tabinfo = e[LEAP.DocumentView.n].param.exParam.tabinfo;
					LEAP.DocumentView.YozoEditor._inner_afterConvertPdf({
								tabinfo : e[LEAP.DocumentView.n].param.exParam.tabinfo,
								pdffile : rst,
								domain : m
							});
				}

			}
		}

	} finally {
		yozoApp = null;
	}
}

LEAP.DocumentView.YozoEditor._inner_afterConvertPdf = function(arg) {
	try {
		if (arg) {

			var tabCtrl = LEAP.getElement("div[wtf=tabcontrol]",
					arg.domain.moduleElement);
			if (!tabCtrl)
				tabCtrl = LEAP.getElement("div[wtf=tabcontrol]",
						arg.domain.parentPageModule.moduleElement);
			if (!tabCtrl)
				return null;

			var pdfTabcode = arg.tabinfo.pdftabcode;

			var lab = LEAP
					.getElement("li[tabcode=" + pdfTabcode + "]", tabCtrl);
			if (lab == null)
				return null;

			lab.style.display = "block";

			var con = LEAP.getElement("div[tabcode=" + pdfTabcode + "]",
					tabCtrl);
			if (con) {
				var documentView = LEAP.getElement('div[ct=DocumentView]', con);
				arg.pdffile.title = lab.innerText;
				LEAP.DocumentView.valueChange(documentView, arg.pdffile,
						arg.pdffile.atttype);
				arg.domain.convertPDFLoading = true;
				// this.setActiveTabUI(pdfTabcode);
				LWFP.API.ModuleProcess.api.setActiveTabUI(pdfTabcode,
						arg.domain);
				LEAP.asyn(LEAP.DocumentView.loadDocument, arg.domain, 200,
						documentView, true, lab.innerText, pdfTabcode);
			}
		}
	} finally {
		tabCtrl = pdfTabcode = lab = con = null;
	}
}

//永中weboffice
LEAP.DocumentView.YozoWeb = {};
LEAP.DocumentView.YozoWeb.symbol = {ctf_officeobj:"officeobj", fileId:"fileId"};
LEAP.DocumentView.YozoWeb._buttonFrame = "<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='submit'>保存</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='saveAs'>另存为</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='updatename'>修改文件名</A>"+
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='print'>打印</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='showMark'>显示痕迹</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='hideMark'>隐藏痕迹</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1 al='importDoc'>导入文件</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='doHandSign'>加入手写签批</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='doHandSecSign'>加入手写签名</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='taohong'>正文套红</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='addServerSign'>添加服务器签章</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='addServer2Sign2'>添加服务器签章</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='safeDoc'>锁定文件</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='deleteSafe'>取消锁定</A>" +
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='ConvertPDF'>转为PDF格式</A>"+	
						"<A class='wf_documentView_toolbar_btn' href='javascript:' ht='button' at=1  al='ConvertOFD'>转为OFD格式</A>";
LEAP.DocumentView.YozoWeb._editorFrame = "<iframe id='YozoWebOffice_{{$ID$}}' ctf='officeobj' style='position:relative;border:none;width:100%;height:100%;'/>";
LEAP.DocumentView.YozoWeb.debug = true;
LEAP.DocumentView.YozoWeb.output = function(txt)
{
	if (LEAP.DocumentView.YozoWeb.debug == true)
		console.log(txt);
}

LEAP.DocumentView.YozoWeb.loadDocument = function(e)
{
	try
	{		
		var data = e[LEAP.DocumentView.n];
		var uri = data.attachment;
		var fileId = ((uri.id != null)?uri.id : UUID.randomUUID().replaceall('-', '') );
		
		
		var bean = {};
			bean.fileId = fileId;
			bean.filePath = ( (uri.namedpath != null) ? uri.namedpath + "/" : "" ) + uri.name;
			bean.fileName = uri.title;
			bean.readOnly = !uri.canEdit;
			bean.mobileFlag = false;
			bean.saveFlag = false;
			
		var module = LWFP.innerApi.getmodule(e);
		var rst = module.request2( {name:'YozoWebOffice_API_OpenFile', par:{par:bean}} );
		
		if (rst.result == null || rst.result.urls == null)
		{
			alert(rst.errormessage + " errorCode:" + rst.errorcode);
			return;
		}
		
		e.setAttribute(LEAP.DocumentView.YozoWeb.symbol.fileId, fileId);
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		
		
		window.onmessage = LEAP.DocumentView.YozoWeb.___receiveMessage;	
		
		//obj.contentWindow.onmessage = LEAP.DocumentView.YozoWeb.___receiveMessage;	
		
		obj.src = rst.result.urls;
		
		
		
		/*debugger
		var _att = {};
			_att.atttype = LEAP.DocumentView.doctype.word;
			_att.title = "aaaaaaaa"; 
			_att.name = "test.docx";									
			_att.namedpath = ""; //"default/2017/5/17";
			_att.updateType = 0;
			_att.canDelete = true;
			_att.canEdit = true;
	*/
	}
	finally
	{
	}	
}

LEAP.DocumentView.YozoWeb.___receiveMessage = function(event)
{
	if (event)
	{
		if (event.data != null && event.data == "mocha")
		{
			var fileId = event.source.fileId;			
			LEAP.DocumentView.YozoWeb.output("receiveMessage fileId:" + fileId);			
			var element = LEAP.getElement("[ct="+LEAP.DocumentView.d+"]["+LEAP.DocumentView.YozoWeb.symbol.fileId+"="+ fileId +"]");				
			LEAP.DocumentView.YozoWeb.output("receiveMessage element:" + (element != null) );			
			LEAP.asyn(LEAP.DocumentView.YozoWeb.__afterLoad, this, 10, element);	
		}
	}
}


LEAP.DocumentView.YozoWeb.__afterLoad = function(e)
{	
	/*if (obj.contentWindow.YozoOffice.Application)
		console.log("666");
	else
		console.log(obj.contentWindow.YozoOffice);*/
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return null;
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
			
		var btns = "saveAs,print,showMark,hideMark,";
		if (readonly == false)
			btns += "submit,";
		
		if (data.doctype < 0) //正文才使用正文按钮
		{
			if (data && data.param && data.param.wordButton && data.param.wordButton != "")
				btns = data.param.wordButton;
		}
		
		var _arr = LEAP.getElements("a[at=1]", e);
		for(var i=0; i<_arr.length; i++)
		{	
			var _a = _arr[i];
			var _al = _a.getAttribute('al');
			if (btns.indexOf(_al) >=0)
			{
				_a.style.display = 'block';
				
				if (_al == 'updatename')
				{
					if (readonly == false)
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
			else
			{
				_a.style.display = 'none';
			}
				
			if (_al == 'fullscreen')
			{
				_a.style.display = 'block';
			}
			else if (_al == 'close')
			{
				if (e.getAttribute('newwindow') == "1")
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
			}
		}
		
		/*//3=PowerPoint.Show
		if(obj.DocType == 3)
			return;
				
		var userConfig = LEAP.DocumentView.YozoWeb.getUserConfig(e);
		
		obj.ActiveDocument.Application.UserName = LEAP.DocumentView.YozoWeb.userconfig.username;
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{}
		else
		{
			
			if (obj.ActiveDocument && obj.ActiveDocument.ShowRevisions == true)
			{				
				obj.ActiveDocument.ShowRevisions = false;
			}
			
		}
		
				
		var doctype = obj.DocType;//控件类型
		// this.obj.ActiveDocument.ProtectionType =-1 表示文档正常. 2表示文档被锁定
		if (obj.ActiveDocument.ProtectionType == 2) 
		{		
			obj.SetReadOnly(false, "");
			obj.Titlebar = false;	// 标题栏
			obj.Menubar = true;		// 菜单栏
			obj.Statusbar = false;	// 状态栏		
			obj.FileNew = false;	// 新建按钮
			obj.FileOpen = false;	// 打开按钮
			obj.FileClose = false;	// 关闭按钮
			obj.FileSave = false;	// 保存按钮
			obj.IsShowToolMenu = false;	//工具菜单
			//obj.ActiveDocument.Application.UserName = username;
			if (doctype == 1)//doctype=1:word
			{	
				obj.ActiveDocument.CommandBars("Reviewing").Enabled = true;
				obj.ActiveDocument.CommandBars("Track Changes").Enabled = true;	
			}
			else //doctype=6 : wps
			{
				//obj.ActiveDocument.Application.CommandBars("Reviewing").Enabled = true;
				obj.ActiveDocument.Application.ActiveWindow.View.ShowRevisionsAndComments=true;
			}			
			obj.IsShowToolMenu = true;			
			obj.SetReadOnly(true, "");	
		} 
		else 
		{
			obj.SetReadOnly(false, "");			
			obj.Titlebar = false;// 标题栏			
			obj.Menubar = true;// 菜单栏			
			obj.Statusbar = false;// 状态栏			
			obj.FileNew = false;// 新建按钮			
			obj.FileOpen = false;// 打开按钮			
			obj.FileClose = false;// 关闭按钮			
			obj.FileSave = false;// 保存按钮				
			obj.IsShowToolMenu = false;// 工具菜单			
			if (doctype == 1)//doctype=1:word
			{	
				obj.ActiveDocument.CommandBars("Reviewing").Enabled = true;
				obj.ActiveDocument.CommandBars("Track Changes").Enabled = true;
				obj.ActiveDocument.TrackRevisions = true;
				obj.IsShowToolMenu = true;
			}
			else //doctype=6 : wps
			{				
				//TODO check obj.ActiveDocument.Application.CommandBars("Reviewing").Enabled = true;
				//obj.ActiveDocument.Application.CommandBars("Reviewing").Enabled = true;
				obj.ActiveDocument.Application.ActiveWindow.View.ShowRevisionsAndComments=true;
				//obj.ActiveDocument.TrackRevisions = true;
			}
		}
				
		obj.Menubar = false;
		obj.BorderStyle = 0;
				
		//设置word缩放比例
		//obj.ActiveDocument.ActiveWindow.ActivePane.View.Zoom.Percentage = 70	

		//添加水印
		LEAP.DocumentView.YozoWeb.___addWaterMaker(e, obj);
				
		//防止空文档被保存
		obj.ActiveDocument.saved = true;	
		
		ElementEventManager.handleEvent(e, "onDocumentLoad");
		
		LEAP.DocumentView.YozoWeb.__initTemplateValue(e);
		
		LEAP.asyn(LEAP.DocumentView.YozoWeb.___resize, this, 1000, e, obj.ActiveDocument.saved);*/
	}
	catch(err)
	{
		if(err.number!=-2147467260)
			alert("错误：" + err.number + ":" + err.description);		
	}
	finally
	{		
		obj = data = readonly = btns = _arr = i = _a = _al = userConfig = doctype = null;
	}

}



/*

LEAP.DocumentView.YozoWeb.DOWN = "\\WebOffice\\Down\\"; // 指定下载路径并设置名称
LEAP.DocumentView.YozoWeb.getDownFilePath = function(obj)
{
	if( obj==null )
		return null;
	var fs = obj.FileSystem;
	return fs.GetSpecialFolderPath(0x1a) + LEAP.DocumentView.YozoWeb.DOWN; //临时路径
}
LEAP.DocumentView.YozoWeb.WebDownLoadFile = function(obj, Url) 
{
	if( obj==null )
		return null;
		
	//删除本地文件
	var fs = obj.FileSystem;
	fs.ClearDirectory(LEAP.DocumentView.YozoWeb.getDownFilePath(obj));
		
	var kwoHttpGet = 0;
	var kwoHttpPost = 1;
	var httpclient = obj.Http;
	httpclient.Clear();
	httpclient.ShowProgressUI = true;
	httpclient.Hidden = false;
	// 异步下载先调用OnSendEnd(),再调用OnRecEnd()
	var info = httpclient.Open(kwoHttpGet,Url, false);
	if (info) 
	{
		var send = httpclient.Send();
		if (send) 
		{
			if (httpclient.Status == 200) 
			{				
				var FileName = LEAP.DocumentView.YozoWeb.getDownFilePath(obj) + UUID.randomUUID().replaceall('-', '') + Url.substring(Url.lastIndexOf("."));
				//保存到本地
				httpclient.ResponseSaveToFile(FileName);
				httpclient.Close();
				//"下载成功";
				return FileName;
			}
			else
			{
				//"下载失败请检查URL是否正确";
				return null;
			}
		}
		else
		{
        	 //"数据包发送失败";
        	 return null;
		}
	}
	else
	{
    	 //"打开连接失败";
    	 httpclient.Clear();
    	 return null;
	}
}

LEAP.DocumentView.YozoWeb.handleWordOpenedEvent = function(id)
{
	try
	{
		var obj = document.getElementById(id);
		
		if (obj['___h'])
		{
			var e = LEAP._match(obj, LEAP.DocumentView.d);
			LEAP.DocumentView.YozoWeb.openDocAfter(e);
		}
	}
	finally
	{
		obj = e = null;
	}
}

LEAP.DocumentView.YozoWeb.getUserConfig = function(e)
{
	if (LEAP.DocumentView.YozoWeb.userconfig == null)
	{
		var module = LWFP.innerApi.getmodule(e);
		//LEAP.DocumentView.YozoWeb.userconfig = module.request2({name:'lbcp_getControlPaneBean'});
		//if (!LEAP.DocumentView.YozoWeb.userconfig)
		{
			LEAP.DocumentView.YozoWeb.userconfig = {wordcorrections:0};			
		}
		LEAP.DocumentView.YozoWeb.userconfig.username = LEAP.getUserInfo().fullName;	
		LEAP.DocumentView.YozoWeb.userconfig.lock = module.request2({name:'lbcp_getOfficeWordLock'});
		if (!LEAP.DocumentView.YozoWeb.userconfig.lock)
			LEAP.DocumentView.YozoWeb.userconfig.lock = "longrise1234567890";
	}
	
	return LEAP.DocumentView.YozoWeb.userconfig;
}

/**
 * 执行操作
 * @param {} e
 * @param {} param 
 * 			{
 * 				buttons:更改要显示的功能按钮，按钮代码逗号分隔，如： "submit,saveAs"
 * 						 按钮代码： submit保存 saveAs另存为 print打印 showMark显示痕迹 hideMark隐藏痕迹 importDoc导入文件 doHandSign加入手写签批 
 * 								doHandSecSign加入手写签名 taohong正文套红 addServerSign添加服务器签章 addServer2Sign2添加服务器签章
								safeDoc锁定文件 deleteSafe取消锁定 ConvertPDF转为PDF格式 close关闭 fullscreen全屏 
 * 			}
 *//*
LEAP.DocumentView.YozoWeb.oprate = function(e, param)
{
	try
	{
		if (param && param.buttons)
		{
			var btns = param.buttons;
				
			var _arr = LEAP.getElements("a[at=1]", e);
			for(var i=0; i<_arr.length; i++)
			{	
				var _a = _arr[i];
				var _al = _a.getAttribute('al');
				if (btns.indexOf(_al) >=0)
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
					
				if (_al == 'fullscreen')
				{
					_a.style.display = 'block';
				}
				else if (_al == 'close')
				{
					if (e.getAttribute('newwindow') == "1")
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
		}
	}
	finally
	{
		btns = _arr = i = _a = _al = null;
	}
}

LEAP.DocumentView.YozoWeb.openDocAfter = function(e)
{
	if(e['office_editor_version'] == "v1")
		LEAP.DocumentView.YozoWeb.openDocAfter1(e);
	else 
		LEAP.DocumentView.YozoWeb.openDocAfter2(e);
}



LEAP.DocumentView.YozoWeb.openDocAfter2 = function(e)
{
	try
	{
		var obj = LEAP.getElement('[ctf=officeobj]', e);
		if (obj == null)
			return null;
		
		var data = e[LEAP.DocumentView.n];
		var readonly = false;
		if (data.attachment && data.attachment.canEdit == false)
			readonly = true
			
		var btns = "saveAs,print,";
		if (readonly == false)
			btns += "submit,";
		
		if (data.doctype < 0) //正文才使用正文按钮
		{
			if (data && data.param && data.param.wordButton && data.param.wordButton != "")
				btns = data.param.wordButton;
		}
		
		var _arr = LEAP.getElements("a[at=1]", e);
		for(var i=0; i<_arr.length; i++)
		{	
			var _a = _arr[i];
			var _al = _a.getAttribute('al');
			if (btns.indexOf(_al) >=0)
			{
				_a.style.display = 'block';
				
				if (_al == 'updatename')
				{
					if (readonly == false)
						_a.style.display = 'block';
					else
						_a.style.display = 'none';
				}
			}
			else
			{
				_a.style.display = 'none';
			}
				
			if (_al == 'fullscreen')
			{
				_a.style.display = 'block';
			}
			else if (_al == 'close')
			{
				if (e.getAttribute('newwindow') == "1")
					_a.style.display = 'block';
				else
					_a.style.display = 'none';
			}
		}
				
		var isdoc = true;
		var localfilepath = e['localfilepath'];
		if(localfilepath)
		{
			var doctype = localfilepath.substring(localfilepath.lastIndexOf(".")+1).toLowerCase();
			if( doctype=="ppt" || doctype=="pptx" || doctype=="xls" || doctype=="xlsx")
				isdoc = false;
		}
				
		var userConfig = LEAP.DocumentView.YozoWeb.getUserConfig(e);
		
		obj.ActiveDocument.Application.UserName = LEAP.DocumentView.YozoWeb.userconfig.username;
		if (obj.ActiveDocument && obj.ActiveDocument.ProtectionType && obj.ActiveDocument.ProtectionType==2)
		{}
		else
		{
			if (obj.ActiveDocument && obj.ActiveDocument.ShowRevisions)
				obj.ActiveDocument.ShowRevisions = (LEAP.DocumentView.YozoWeb.userconfig.wordcorrections==1)?true:false;
				
		}
		
		if(isdoc == true)
		{
			if (readonly == true)
			{
				obj.Style.ShowTitleBar = false;	 //标题栏
				obj.Style.ShowMenuBar = false;
				obj.Style.ShowToolBars = false;
				obj.Style.ShowStatusBar = false; //状态栏
				obj.Style.BorderStyle = 0;
				obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.YozoWeb.userconfig.lock);
				
				obj.ActiveDocument.CommandBars("Reviewing").Enabled = false;
				obj.ActiveDocument.CommandBars("Track Changes").Enabled = false;
				obj.ActiveDocument.TrackRevisions = false;
				obj.ActiveDocument.Application.ActiveWindow.View.ShowRevisionsAndComments=false;
			}
			else
			{
				obj.ActiveDocument.CommandBars("Reviewing").Enabled = true;
				obj.ActiveDocument.CommandBars("Track Changes").Enabled = true;
				obj.ActiveDocument.TrackRevisions = true;
				obj.ActiveDocument.Application.ActiveWindow.View.ShowRevisionsAndComments=true;
			
				obj.Style.ShowTitleBar = false;	 //标题栏
				obj.Style.ShowMenuBar = false;
				obj.Style.ShowToolBars = true;
				obj.Style.ShowStatusBar = false; //状态栏
				obj.Style.BorderStyle = 0;
			}
	
			obj.Style.Invalidate(); 
		}
		
		if (readonly == true)
		{
			obj.Style.ShowTitleBar = false;	 //标题栏
			obj.Style.ShowMenuBar = false;
			obj.Style.ShowToolBars = false;
			obj.Style.ShowStatusBar = false; //状态栏
			obj.Style.BorderStyle = 0;
		}
		else
		{
			obj.Style.ShowTitleBar = false;	 //标题栏
			obj.Style.ShowMenuBar = false;
			obj.Style.ShowToolBars = true;
			obj.Style.ShowStatusBar = false; //状态栏
			obj.Style.BorderStyle = 0;
		}
	
		obj.Style.Invalidate();

		//添加水印
		LEAP.DocumentView.YozoWeb.___addWaterMaker(e, obj);
		
		
		//防止空文档被保存
		obj.ActiveDocument.saved = true;
		
		ElementEventManager.handleEvent(e, "onDocumentLoad");
		
		if(isdoc == true)
			LEAP.DocumentView.YozoWeb.__initTemplateValue(e);
		
		LEAP.asyn(LEAP.DocumentView.YozoWeb.___resize, this, 1000, e, obj.ActiveDocument.saved);
	}
	catch(err)
	{
		if(err.number!=-2147467260)
			alert("错误：" + err.number + ":" + err.description);		
	}
	finally
	{		
		obj = data = readonly = btns = _arr = i = _a = _al = userConfig = doctype = null;
	}
}

LEAP.DocumentView.YozoWeb.___addWaterMaker = function(e, activexObj)
{
	if(e['office_editor_version'] == "v1")
		LEAP.DocumentView.YozoWeb.___addWaterMaker1(e, activexObj);
	else 
		LEAP.DocumentView.YozoWeb.___addWaterMaker_(e, activexObj);
}

LEAP.DocumentView.YozoWeb.___addWaterMaker1 = function(e, activexObj)
{
	LEAP.asyn(LEAP.DocumentView.YozoWeb.___addWaterMaker_, this, 100, e, activexObj);
}

LEAP.DocumentView.YozoWeb.___addWaterMaker_ = function(e, activexObj)
{
	try
	{
		if (window._showmark != '0')
		{
			//var module = LEAP.DocumentView.__getmodule(e);
			//if (module && module.officeWaterMark == true)
			{
				try
				{
					if (activexObj.DocType == 2)
					{//excel
						//TDDO
					}
					else
					{//word

			    		
			    		activexObj.ActiveDocument.Background.Fill.Transparency = 0;
			    		activexObj.ActiveDocument.Background.Fill.UserPicture(LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(e)) + LEAP.getWaterMark());
			    		activexObj.ActiveDocument.ActiveWindow.View.DisplayBackgrounds = true;
			    		
					}
				}
				catch(e)
				{}    		
			}
		}
	}
	finally
	{
		
	}
}

LEAP.DocumentView.YozoWeb.___delWaterMaker = function(e, activexObj)
{
	try
	{
		if (activexObj.DocType == 2)
		{
			//TODO excel
		}
		else
		{	//word
			activexObj.ActiveDocument.Background.Fill.Visible = false;
		}
	}
	catch(e){}
}

LEAP.DocumentView.YozoWeb.___resize = function(e, saved)
{
	try
	{
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.exParam && e[LEAP.DocumentView.n].param.exParam.isOpenWindow == true)
		{
			var top = LEAP.getElement("[ar=top]", e);
			var bottom = LEAP.getElement("[ar=bottom]", e);
		
			bottom.style.height = (e.clientHeight - top.clientHeight - 40) + 'px';
		}
		
		if (saved != null)
			LEAP.getElement('[ctf=officeobj]').activeDocument.saved = saved;
	}
	finally
	{
		top = bottom = null;
	}
}

LEAP.DocumentView.YozoWeb.__initTemplateValue = function(e)
{//////
	try
	{	
		if (e[LEAP.DocumentView.n] && e[LEAP.DocumentView.n].param && e[LEAP.DocumentView.n].param.templateValueFn)
			e[LEAP.DocumentView.n].param.templateValues = e[LEAP.DocumentView.n].param.templateValueFn.call(this);
	
		if (e[LEAP.DocumentView.n].param == null || e[LEAP.DocumentView.n].param.templateValues == null)
			return;
			
		var obj = LEAP.getElement('[ctf=officeobj]', e);		
		if	(!obj)
			return;
			
		if (!obj.ActiveDocument)
			return;
		
		var flag = false;
		if (obj.ActiveDocument.ProtectionType == 2)
		{
			flag = true;
			//obj.SetReadOnly(false, "");	
			obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.YozoWeb.userconfig.lock);
		}
			
		LEAP.DocumentView.YozoWeb.TANGER_OCX_SetMarkModify(e, false);// 暂时退出痕迹保留状态

		if (obj.ActiveDocument.BookMarks)
		{
			var bookMarkslist = e[LEAP.DocumentView.n].param.templateValues;
			for (var i=0; i<bookMarkslist.length;i++)
			{
				if (obj.ActiveDocument.BookMarks.Exists(bookMarkslist[i][0]))
				{
					var bookRange = obj.ActiveDocument.Bookmarks.Item(bookMarkslist[i][0]).Range;
	        			bookRange.text = bookMarkslist[i][1];
				}
			}	
		}
		
		LEAP.DocumentView.YozoWeb.TANGER_OCX_SetMarkModify(e, true);// 痕迹保留状态
		
		if (flag == true)
			obj.ActiveDocument.Protect(3, false, LEAP.DocumentView.YozoWeb.userconfig.lock);
	}
	finally
	{
		obj = bookMarkslist = i = null;
	}	
}

LEAP.DocumentView.YozoWeb.buttonClick = function(e, al)
{
	if (al == "submit")
	{
		LEAP.DocumentView.YozoWeb.save(e);
	}
	else if (al == "saveAs")
	{
		LEAP.asyn(LEAP.DocumentView.YozoWeb.saveLocal, this, 0, e);		
		//LEAP.DocumentView.YozoWeb.saveLocal(e);
	}
	else if (al == "print")
	{
		LEAP.DocumentView.YozoWeb.printDoc(e);
	}
	else if (al == "showMark")
	{
		LEAP.DocumentView.YozoWeb.showRevisions(e);
	}
	else if (al == "hideMark")
	{
		LEAP.DocumentView.YozoWeb.hideRevisions(e);
	}
	else if (al == "importDoc")
	{
		LEAP.DocumentView.YozoWeb.importdoc(e);
	}
	else if (al == "doHandSign")
	{
		LEAP.DocumentView.YozoWeb.doHandSign(e);
	}
	else if (al == "doHandSecSign")
	{
		LEAP.DocumentView.YozoWeb.doHandSecSign(e);
	}
	else if (al == "addServerSign")
	{
		LEAP.DocumentView.YozoWeb.addServerSign(e);
	}
	else if (al == "addServer2Sign2")
	{
		LEAP.DocumentView.YozoWeb.addServerSign2(e);
	}
	else if (al == "taohong")
	{
		LEAP.DocumentView.YozoWeb.taohong(e);
	}
	else if (al == "safeDoc")
	{
		LEAP.DocumentView.YozoWeb.safeDoc(e);
	}
	else if (al == "deleteSafe")
	{
		LEAP.DocumentView.YozoWeb.deleteSafe(e);
	}
	else if (al == "fullscreen")
	{
		LEAP.DocumentView.YozoWeb.fullscreen(e);
	}
	else if (al == "ConvertPDF")
	{
		LEAP.DocumentView.YozoWeb.ConvertToPDF(e);
	}
	else if (al == "close")
	{
		LEAP.DocumentView.YozoWeb.close(e);
	}
	else if (al == 'pdf_create')
	{
		LEAP.DocumentView.PdfEditor.save(e, false);
	}
	else if (al == 'pdf_print')
	{
		LEAP.DocumentView.printDoc(e);
	}
	else if (al == 'pdf_saveAs')
	{
		LEAP.DocumentView.PdfEditor.saveAs(e);
	}
	else if (al == 'pdf_close')
	{
		LEAP.DocumentView.PdfEditor.close(e);
	}
	else if (al == "updatename")
	{
		LEAP.DocumentView.YozoWeb.updatename(e);
	}
	
	//TODO "","","","close","blank"
	
}

LEAP.DocumentView.YozoWeb.updatename = function(arg)
{
}

LEAP.DocumentView.YozoWeb.save = function(e, __alertResult)
{
}

LEAP.DocumentView.YozoWeb.save1 = function(e, __alertResult)
{
}

LEAP.DocumentView.YozoWeb.save2 = function(e, __alertResult)
{
}

LEAP.DocumentView.YozoWeb.saveLocal = function(e) 
{
}
 
LEAP.DocumentView.YozoWeb.printDoc = function(e) 
{
}

LEAP.DocumentView.YozoWeb.showRevisions = function(e) 
{
}
 
LEAP.DocumentView.YozoWeb.hideRevisions = function(e) 
{
}
 
LEAP.DocumentView.YozoWeb.importdoc = function(e) 
{
}

LEAP.DocumentView.YozoWeb.doHandSign = function(e) 
{
}

LEAP.DocumentView.YozoWeb.doHandSecSign = function(e) 
{
}

LEAP.DocumentView.YozoWeb.addServerSign = function(e) 
{
}

LEAP.DocumentView.YozoWeb.addServerSign2 = function(e) 
{
}

LEAP.DocumentView.YozoWeb.taohong = function(e) 
{
}

LEAP.DocumentView.YozoWeb.setBookmarkValues = function(e) 
{
}

//进入或退出强制痕迹保留状态，调用该函数下面定义的两个函数。一般可直接调用本函数。
LEAP.DocumentView.YozoWeb.TANGER_OCX_SetMarkModify = function(e, boolvalue)
{	   
}

//允许或禁止显示修订工具栏和工具菜单（保护修订,用户不能更改当前修订状态)
LEAP.DocumentView.YozoWeb.TANGER_OCX_EnableReviewBar = function(e, boolvalue)
{
}

//打开或者关闭修订模式
LEAP.DocumentView.YozoWeb.TANGER_OCX_SetReviewMode = function(e, boolvalue)
{
}

LEAP.DocumentView.YozoWeb.safeDoc = function(e) 
{
}

LEAP.DocumentView.YozoWeb.deleteSafe = function(e) 
{
}

LEAP.DocumentView.YozoWeb.fullscreen = function(e)
{
}

LEAP.DocumentView.YozoWeb.ConvertToPDF = function(e)
{
}

LEAP.DocumentView.YozoWeb._ConvertToPDF_afterUpload = function(arg)
{
}

LEAP.DocumentView.YozoWeb._inner_afterConvertPdf = function(arg)
{
		
}


LEAP.DocumentView.YozoWeb.close = function(e, dontClose) 
{	
	
}

*/



/**
 *
 * @class LEAP.wordviewer
 * @type user control
 * @example
 
HTML定义:
<DIV class='wf_wordView' ct='wordviewer' includemain=1 style="border:1px solid #CCCCCC;">
	<IMG style="DISPLAY: none" onerror=LEAP.wordviewer.i(); src="data:image:png,base64">			
</DIV>

示例：

</div>

标签:
	
*/


LEAP.wordviewer = {};
LEAP.wordviewer.d = 'wordviewer';
LEAP.wordviewer.symbol = {btnctf:'wordview_btn', btnname:'_btnname', params:'_params',domain:'_domain'}
LEAP.wordviewer._tb = "<DIV onresize=LEAPLG.tb(); class=lg_p2_tb>" +
							"<DIV ar='top' onresize=LEAPLG.tb_layout(0); class='lg_p2_tb_top wf_wordView_toolbar' style='HEIGHT: 45px'></DIV>" +
							"<DIV ar='bottom' class=lg_p2_tb_bottom style='HEIGHT: 755px'>down---</DIV>" +
							"<IMG onerror=LEAPLG.tb_img(0); style='DISPLAY: none' src='data:image:png,base64'>" +
						"</DIV>";
										
LEAP.wordviewer._wordObj = "<object id='officebody_{{$ID$}}' ctf=wordviewer value='CC0044409F3B1A8EF33AF22CB77E683B1A4F24E2' classid='clsid:A39F1330-3322-4a1d-9BF0-0BA2BB90E970'" +
		" codebase=" + leapconfig.server + "LEAP/LWFP/HTML/activex/OfficeControl.cab#version=5,0,2,4' z-index=999999999 width='100%' height='100%'>" +
				"<param name='IsUseUTF8URL' value='0'>" +
				"<param name='IsUseUTF8Data' value='0'>" +
				"<param name='MakerCaption' value='永兴元科技www.longrise.com.cn'>" +
				"<param name='MakerKey' value='00ABC2E2E500DDDA42F9FECA12C4C532850BFC32'>" +
				"<param name='ProductCaption' value='深圳市永兴元科技有限公司'>" +
				"<param name='ProductKey' value='46E17CE7896947AC8014C6BB98B980EAD36708F2'>" +
				"<SPAN STYLE='color:blue'>不能装载文档控件。请在检查浏览器的选项中检查浏览器的安全设置。</SPAN>" +
				"<SPAN STYLE='color:red;cursor:hand;font-size:16px; font-family:宋体' onclick='WordHelp();'>点我解决问题?</SPAN></object>";
				
LEAP.wordviewer._word = "<A class='wf_wordView_toolbar_btn' href='javascript:' ht='button' at=1 al='submit'>保存</A>";
					
LEAP.wordviewer.init = function()
{
	if (document != null && document.body != null)
		LEAP.wordviewer._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.wordviewer._init);	
}

LEAP.wordviewer._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.wordviewer.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LEAP.wordviewer._init);
}

LEAP.wordviewer.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		var ctf = src.getAttribute('ctf');
		if (ctf == null || ctf != LEAP.wordviewer.symbol.btnctf) 
			return;
							
		var element = LEAP._match(src, LEAP.wordviewer.d);
		if(null == element) return;
		
		var obj = LEAP.getElement("[ctf=wordviewer]", element);
		if (!obj)
			return;
		
		var btnName = src.getAttribute(LEAP.wordviewer.symbol.btnname);
		if (btnName == 'wordviewer_print')
		{
			LEAP.wordviewer._print(element);
		}
		else if (btnName == 'wordviewer_saveas')
		{
			LEAP.wordviewer._saveas(element);
		}
		else 
		{		
			var params = element[LEAP.wordviewer.symbol.params];
			var domain = element[LEAP.wordviewer.symbol.domain];
			for(var i=0; i<params.buttons.length; i++)
			{
				var btn = params.buttons[i];
				if (btn.name == btnName && btn.fn)
				{
					btn.fn.apply(domain, [obj.activeDocument]);
				}
			}
		}
	}
	finally
	{
		src = ctf = element = null;
	}
}

LEAP.wordviewer._saveas = function(e)
{
	try
	{
		var obj = LEAP.getElement("[ctf=wordviewer]", e);
		if (!obj)
			return;
			obj.ShowDialog(3);
			
	}
	finally
	{}
}

LEAP.wordviewer._print = function(e)
{
	try
	{
		var obj = LEAP.getElement("[ctf=wordviewer]", e);
		if (!obj)
			return;
		
		//控制“Word选项-显示-打印选项-打印在word中创建的图形”
		//obj.ActiveDocument.Application.Options.PrintDrawingObjects = false;
		//obj.PrintOut(true);
		obj.ShowDialog(4);
	}
	finally
	{}
}

/**
 * 
 * @param {} e
 * @param {} arg  {url:url, afterload:打开后回调方法, buttons:[{name:name, title:title, fn:fn},{}] }
 * @param {} domain
 */
LEAP.wordviewer.loadDoc = function(e, arg, domain)
{
	try 
	{
		var obj = LEAP.getElement("[ctf=wordviewer]", e);
		if (!obj)
			return;
		
		 obj.___e = e;
		 obj.___arg = arg;
		 obj.___domain = domain;
		
		/*var backOnlad = function()
		{
			function obj::OnDocumentOpened(file,doc)
			{
		 		LEAP.wordviewer.openDocAfter(e, arg, domain);
			}
	 	}
		backOnlad();*/
		
		/*if (!obj['___h'])
		{
			obj.attachEvent("OnDocumentOpened", function(){ LEAP.wordviewer.openDocAfter(e, arg, domain); } );
			obj['___h'] = 1;
		}*/
		
		if (!obj['___h'])
		{
			if (obj.attachEvent) 
			{
						obj.attachEvent("OnDocumentOpened", function() {
									LEAP.wordviewer.openDocAfter(e, arg, domain);
								});
			} 
			else 
			{
						/*if (obj.addEventListener) {
							obj.addEventListener("OnDocumentOpened", function() {
										LEAP.wordviewer.openDocAfter(e, arg, domain);
									},false);
						}*/
				var handler = document.createElement("script");
				handler.setAttribute("for", obj.id);
				handler.event = "OnDocumentOpened(param1, param2)";  
				handler.appendChild(document.createTextNode("var a = '" + obj.id + "';"));
				handler.appendChild(document.createTextNode("LEAP.wordviewer.handleWordOpenedEvent(a);"));
				document.body.appendChild(handler);
				
			}
		}
		obj["___h"] = 1;
			
		
		obj.BeginOpenFromURL(arg.url, false, false, "Word.Document");
		
		LEAP.wordviewer.initButton(e, arg.buttons);
		
		e[LEAP.wordviewer.symbol.params] = arg;
		e[LEAP.wordviewer.symbol.domain] = domain;
		
		return true;		
	}
	catch(err)
	{
		console.log(err);
		return false;
	}
	finally 
	{
		obj = null;
	}
}

LEAP.wordviewer.initButton = function(e, buttons)
{
	try
	{
		var toolbar = LEAP.getElement("[ar=top]", e);
		if (!buttons)
		{
			toolbar.style.height = "1px";			
		}
		else
		{
			toolbar.style.height = "30px";		
		}
		
		for(var i=0; i<buttons.length; i++)
		{
			var btn = buttons[i];
			
			var a = document.createElement("a");
			a.className = 'wf_wordView_toolbar_btn';
			a.href = 'javascript:';
			a.setAttribute("ctf", LEAP.wordviewer.symbol.btnctf);			
			a.setAttribute(LEAP.wordviewer.symbol.btnname, btn.name);
			a.innerText = btn.title;
			
			toolbar.appendChild(a);
		}
		
	}
	finally
	{
		toolbar = btn = i = a = null;
	}	
}

LEAP.wordviewer.handleWordOpenedEvent = function(id)
{
	try
	{
		var obj = document.getElementById(id);
		
		if (obj['___h'])
		{
			var e = LEAP._match(obj, LEAP.wordviewer.d);
			LEAP.wordviewer.openDocAfter(obj.___e,obj.___arg,obj.___domain);
		}
	}
	finally
	{
		obj = e = null;
	}
}

LEAP.wordviewer.openDocAfter = function(e, arg, domain)
{
	try
	{
		var obj = LEAP.getElement("[ctf=wordviewer]", e);
		if (!obj)
			return;
			
		obj.Titlebar = false;	// 标题栏
		obj.Menubar = false;		// 菜单栏
		obj.Statusbar = false;	// 状态栏		
		obj.FileNew = false;	// 新建按钮
		obj.FileOpen = false;	// 打开按钮
		obj.FileClose = false;	// 关闭按钮
		obj.FileSave = false;	// 保存按钮
		obj.IsShowToolMenu = false;	//工具菜单		
		obj.BorderStyle = 0;
		
		if (arg.afterload)
		{
			arg.afterload.apply(domain, [obj.activeDocument, obj]);			
		}
		
	}
	catch(err)
	{
		if(err.number!=-2147467260)
		{
			alert("错误：" + err.number + ":" + err.description);		
		}
	}
	finally
	{
		obj = null;
	}
}




LEAP.wordviewer.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;

	LEAP.wordviewer._i(src);
	
	if (src.parentElement)
		src.parentElement.removeChild(src);
}

LEAP.wordviewer._i = function(src)
{
	try
	{
		var _element = LEAP._match(src, LEAP.wordviewer.d, 'ct');
		if (_element == null)
			return;
		
		LEAP.wordviewer.__i(_element);		
	}
	finally
	{
		_element = null;
	}
}


LEAP.wordviewer.__i = function(e)
{
	try
	{
		e.innerHTML = LEAP.wordviewer._tb
		var top = LEAP.getElement("[ar=top]", e);
		var bottom = LEAP.getElement("[ar=bottom]", e);
		
		top.style.height = '30px';
		top.style.lineHeight = '15px';
		bottom.innerHTML = LEAP.wordviewer._wordObj.replace('{{$ID$}}', UUID.cID());
		
	}
	finally
	{
		
	}
}

LEAP.wordviewer.init();



 

/**
 * 时间选择控件
 * defaulttime=1 显示默认时间
 * readonly="1"  设置只读
<div class="wfcontrol_time" ct="time" md="alermtime" ut="alermtime" bt="text" defaulttime="1" readonly="1">
	<img style='display:none' src='data:image:png,base64' onerror='LEAP.time.i(0);'>
</div>
 */

LEAP.time = {};
LEAP.time.d = "time";
LEAP.time._pm = LEAPBrowser && ((LEAPBrowser.documentMode && LEAPBrowser.documentMode < 7) || (LEAPBrowser.IEVersion
		&& LEAPBrowser.IEVersion == 7 && !LEAPBrowser.documentMode))? "absolute" : "fixed";
LEAP.time.init = function(src)
{
	if (document != null && document.body != null)
		LEAP.time._init(src);
	 else 
		UIEventManager.addEvent(window, "load", LEAP.time._init);
};
LEAP.time._init = function(src)
{
	LEAP.addEvent(document.body, "click", LEAP.time.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, "load", LEAP.time._init);
};
LEAP.time.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		var ele = LEAP._match(src, LEAP.time.d);
		if (!ele)
			return;
		var ct = src.getAttribute('ct');
		if (null == ct)
			return;
	} 
	finally
	{
		src = ct = null;
	}
};

LEAP.time.getValue = function(ele) 
{
	try 
	{
		if (!ele)
			return null;
		
		var c = LEAP._match(ele, LEAP.time.d);
		if (!c)
			return;
		
		LEAP.time._i(c, false);
		return LEAP.getElement("div[ctf=timetext]",ele).innerText;
	} 
	finally 
	{
		ele = null;
	}
};

LEAP.time.setValue = function(ele, value)
{
	try 
	{	
		var c = LEAP._match(ele, LEAP.time.d);
		if (!c)
			return;
			
		LEAP.time._i(c, false);
		
		var _value = value;
		var datePattern = /^(?:(?:[0-2][0-3])|(?:[0-1][0-9])):[0-5][0-9]:[0-5][0-9]$/;
		if (value == null || typeof(value) != "string" || value.Trim() == "")
			_value = "";
		else if(datePattern.test(value)==false)
			return;
		
		LEAP.getElement("div[ctf=timetext]",ele).innerText = _value;
	}
	finally 
	{
		_value = datePattern = null;
	}
};

LEAP.time.i = function(wait, src)
{
	if (!src)
	{
		if (!event)
			return;
		src = event.srcElement;
	}
	if (!src)
		return;

	LEAP.time._i(src);
	
	if (src.parentElement)
		src.parentElement.removeChild(src);
};
LEAP.time._i = function(src, defaultTime)
{
	try
	{
		if(!src)
			return;
		
		var _src = LEAP._match(src, LEAP.time.d);
		if (_src == null)
			return;
		
		if(!LEAP.getElement("div[ctf=timetext]", _src))
		{
			var c1 = document.createElement("div");
				c1.setAttribute('ctf','timetext');
				c1.className = 'wfcontrol_time_text';
				
			_src.appendChild(c1);
			if(!_src.getAttribute("readonly"))
			{
				var c2 = document.createElement("div");
				c2.setAttribute('ct','timeselector');
				c2.className = 'wfcontrol_time_img';
				_src.appendChild(c2);
			}
		}
		
		var _defaultTime = defaultTime;
		if (_defaultTime == null)
			_defaultTime = true;
		
		if(_src.getAttribute("defaulttime") && _src.getAttribute("defaulttime")=="1" && _defaultTime == true)
		{	
			var time = LEAP.getUserInfo().getTimeFormart(LEAP.getUserInfo().getTime()).substring(11, 19);
			
			var txt = LEAP.getElement("div[ctf=timetext]", _src);
			if (txt)
				txt.innerText = time;
		}
	}
	finally
	{
		_src = c1 = c2 = _defaultTime = time = txt = null;
	}
};

LEAP.time.init();



LEAP.timeselector = {};
LEAP.timeselector.d = "timeselector";
LEAP.timeselector.lastTimetext = null;
LEAP.timeselector.ui = null;
LEAP.timeselector.curhour = null;
LEAP.timeselector.curminute = null;
LEAP.timeselector.ctfs = 
{
	_now:"time_now",
	_clear:"time_clear",
	_close:"time_close",
	_houritem:"_houritem",
	_minitem:"_minitem"
};
LEAP.timeselector.init = function(src)
{
	if (document != null && document.body != null) 
		LEAP.timeselector._init(src);
	 else 
		UIEventManager.addEvent(window, "load", LEAP.timeselector._init);
};
LEAP.timeselector._init = function(src)
{
	LEAP.addEvent(document.body, "click", LEAP.timeselector.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, "load", LEAP.timeselector._init);
};
LEAP.timeselector.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
			
		var ct  = src.getAttribute('ct');
		var ctf = src.getAttribute('ctf');
		if(ct && ct == LEAP.timeselector.d)
		{
			var timeElement = LEAP._match(src, LEAP.time.d);
			LEAP.timeselector.lastTimetext = LEAP.getElement('div[ctf=timetext]', timeElement);
			LEAP.timeselector.showTime(arg);
		}
		else if (ctf)
		{			
			if(ctf == LEAP.timeselector.ctfs._now)
				LEAP.timeselector._now();
			else if(ctf == LEAP.timeselector.ctfs._clear)
				LEAP.timeselector._clear();
			else if(ctf == LEAP.timeselector.ctfs._close)
				LEAP.timeselector._close();
			else if (ctf == LEAP.timeselector.ctfs._houritem || ctf == LEAP.timeselector.ctfs._minitem)
				LEAP.timeselector.setTime(null, null, src);
		}
		else
		{
			var ui = LEAP._match(src, 'timeselector_UI', 'ctf', 8);
			if (ui)
				return;
			else
				LEAP.timeselector._close();
		}
	}
	finally
	{
		src = ct = ctf = timeElement = ui = null;
	}
};
LEAP.timeselector._now = function()
{
	var _text = LEAP.timeselector.lastTimetext;
	var ctime = LEAP.getUserInfo().getTimeFormart(LEAP.getUserInfo().getTime()).substring(11, 19);
	_text.innerText = ctime;
	LEAP.timeselector._close();
}
LEAP.timeselector._clear = function()
{
	var _text = LEAP.timeselector.lastTimetext;
	_text.innerText = "";
}
LEAP.timeselector._close = function()
{
	if(LEAP.timeselector.ui!=null)
	LEAP.timeselector.ui.style.display = "none";
}
LEAP.timeselector.showTime = function(arg)
{
	LEAP.timeselector.createControl(arg);
	
	var pos = LEAP.timeselector.mousePosition(arg.e);
	LEAP.timeselector.ui.style.left = (pos.x+16) + "px";
	LEAP.timeselector.ui.style.top  = pos.y + "px";
	LEAP.timeselector.ui.style.display = "block";
	var time = LEAP.getUserInfo().getTimeFormart(LEAP.getUserInfo().getTime());
	var _time = time.substring(11, 19);
	var _hour = time.substring(11,13);
	var _minutes = time.substring(14,16);
	LEAP.getElement("[ctf=currenttime]",LEAP.timeselector.ui).innerText = "时间:"+_time;
	
	//设置之前选择的时间
	var oldTime = LEAP.timeselector.lastTimetext.innerText;
	if(oldTime!=null && oldTime!="")
	{
		_hour = oldTime.substring(0,2);
		_minutes = oldTime.substring(3,5);
		LEAP.timeselector.curhour = _hour;
		LEAP.timeselector.curminute = _minutes;
	}
	LEAP.timeselector.setTime(_hour, _minutes, null);
}

LEAP.timeselector.setTime = function(hour, minutes, src)
{	
	try
	{
		if(src)
		{
			var _ctf = src.getAttribute('ctf');
			if(_ctf == LEAP.timeselector.ctfs._houritem)
			{
				LEAP.timeselector.curhour = src.innerText;
			}
			else if(_ctf == LEAP.timeselector.ctfs._minitem)
			{
				LEAP.timeselector.curminute = src.innerText;
				LEAP.timeselector.lastTimetext.innerText = LEAP.timeselector.curhour + ":" + LEAP.timeselector.curminute + ":00";
				LEAP.timeselector._close();
			}
		}
		var arr = LEAP.getElements("span[ctf=" + LEAP.timeselector.ctfs._houritem + "]", LEAP.timeselector.ui);
			for(var i=0; i<arr.length; i++ )
				arr[i].className = "";
			arr = LEAP.getElements("span[ctf=" + LEAP.timeselector.ctfs._minitem + "]", LEAP.timeselector.ui);
			for(var i=0; i<arr.length; i++ )
				arr[i].className = "";
		
		hour = (hour==null)?LEAP.timeselector.curhour:hour;
		minutes = (minutes==null)?LEAP.timeselector.curminute:minutes;
		var h = LEAP.getElement("span[__hv=" + hour + "]", LEAP.timeselector.ui);
		var m = LEAP.getElement("span[__mv=" + minutes + "]", LEAP.timeselector.ui);
		if (h)
			h.className = "sel";
		if (m)
			m.className = "sel";
	}
	finally
	{
		src = _ctf = hour = minutes = arr = h = m = null;
	}
}
LEAP.timeselector.createControl = function(src)
{	
	if (LEAP.timeselector.ui != null)
		return;
		
	var str = 
			"<div class='wfcontrol_timeselector_toolbar'>"+
				"<div class='wfcontrol_timeselector_status' ctf='currenttime'></div>"+
				"<div class='wfcontrol_timeselector_buttons'>"+
					"<span ctf='"+LEAP.timeselector.ctfs._now+"'>现在</span>"+
					"<span ctf='"+LEAP.timeselector.ctfs._clear+"'>清空</span>"+
					"<span ctf='"+LEAP.timeselector.ctfs._close+"'>关闭</span>"+
				"</div>"+
			"</div>"+
			"<div class='time'>"+
				"<div class='hours'>"+
					"<div class='l'>小时</div>";
					var hourslen = 24;
					for(var i=1;i<=hourslen;i++)
					{
						if(i%12==1)
							str+= "<div>"
						var val = (((i<10)?"0"+i:i)==hourslen) ? "00":((i<10)?"0"+i:i);
						str+="<span ctf='" + LEAP.timeselector.ctfs._houritem + "' __hv=" + val + " >"+val+"</span>"
						if(i/6%2==1)
							str+="&nbsp;"
						if((i+1)%12==1 )
							str+= "</div>"
					}	
					
				str+="</div>"+
				"<div class='body'>"+
					"<div class='l'>分钟</div>"+
					"<div class='minutes'>";
					var minuteslen = 60;
					for(var i=1;i<=minuteslen;i++)
					{
						if(i%10==1)
							str+= "<div>"
						var j = i-1;
						var val = ((j<10)?"0"+j:j)==minuteslen?minuteslen-1:((j<10)?"0"+j:j)
						str+="<span ctf='" + LEAP.timeselector.ctfs._minitem + "' __mv=" + val + ">"+val+"</span>"
						if(i/5%2==1)
							str+="&nbsp;"
						if((i+1)%10==1 )
							str+= "</div>"
					}
					str+="</div>"+
				"</div>"+
			"</div>";
	var c = document.createElement("div");
	c.setAttribute("ctf", 'timeselector_UI');
	c.className = 'wfcontrol_timeselector';
	c.style.position = LEAP.time._pm;
	c.innerHTML = str;
	document.body.appendChild(c);
	
	LEAP.timeselector.ui = c;
}
//取得光标位置
LEAP.timeselector.mousePosition = function(ev)
{
	try
	{
		var _x = 0;
		var _y = 0;
		var x = 0;
		var y = 0;
		if(ev.pageX || ev.pageY)
		{   
			_x = x = ev.pageX-(document.body.parentElement?document.body.parentElement.scrollLeft:0);
			_y = y = ev.pageY-(document.body.parentElement?document.body.parentElement.scrollTop:0);
		}
		else
		{	
			_x = ev.clientX;
			_y = ev.clientY;
			x = ev.clientX + document.body.scrollLeft - document.body.clientLeft  + (document.body.parentElement?document.body.parentElement.scrollLeft:0);
			y = ev.clientY + document.body.scrollTop  - document.body.clientTop   + (document.body.parentElement?document.body.parentElement.scrollTop:0);				
		}
		
		if ( (x + LEAP.postil._w + 10) > document.body.clientWidth)
			x = _x - LEAP.postil._w;
		if ( (y + LEAP.postil._h + 40) > document.body.clientHeight)
			y = _y - LEAP.postil._h - 40;
			
		return	{x:x, y:y};
	}
	finally
	{
		_x = x = _y = y = null;
	}
}
LEAP.timeselector.init();
/*
 模板：
		<div ut="RelatedEntry" ct="RelatedEntry" styletype="1">
			<div class="wfcontrol_RelatedEntry_frm" ctf="reContainer">
				<table class="wfcontrol_RelatedEntry_table" cellspacing="0" ctf="reTable">
				</table>
			</div>
			<div class="wfcontrol_RelatedEntry_button_frm" style="display: block;" ctf="reButtonFrame">
				<a class="wfcontrol_RelatedEntry_button_frm_a" href="javascript:" ctf="reButton">添加关联件</a>
			</div>
			<img style="display: none;" onerror="LEAP.RelatedEntry.i(0);" src="data:image:png,base64">
		</div>
		
 */

LEAP.RelatedEntry = {};
LEAP.RelatedEntry.d = 'RelatedEntry';
LEAP.RelatedEntry.n = 'redata';
LEAP.RelatedEntry.ctf = {reContainer:"reContainer", reTable:"reTable", reRow:"reRow", reButtonFrame:"reButtonFrame", reButton:"reButton", reShow:"reShow", reDelete:"reDelete"};
LEAP.RelatedEntry.symbol = {reRelatedEntryId:"reRelatedEntryId", 
		reCurrentEntryid:"reCurrentEntryid", 
		reCurrentstep:"reCurrentstep", 
		reArchCategory:"reArchCategory",
		reModuleInstance:"reModuleInstance"};

LEAP.RelatedEntry.init = function()
{
	if (document != null && document.body != null)
		LEAP.RelatedEntry._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.RelatedEntry._init);	
}

LEAP.RelatedEntry._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.RelatedEntry.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.RelatedEntry._init);
}

LEAP.RelatedEntry.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		var ctf = src.getAttribute('ctf');
		if (ctf == null) 
			return;
			
		var element = LEAP._match(src, LEAP.RelatedEntry.d);
		if(null == element) return;
		
		if (ctf == LEAP.RelatedEntry.ctf.reButton)
		{
			LEAP.RelatedEntry.searchRelatedEntry(element, src);			
		}
		else if (ctf == LEAP.RelatedEntry.ctf.reDelete)
		{
			LEAP.RelatedEntry.deleteEntry(src);
		}
		else if (ctf == LEAP.RelatedEntry.ctf.reShow)
		{
			LEAP.RelatedEntry.showEntry(src);
		}
	}
	finally
	{
		src = ctf = element = row = null;
	}
}

LEAP.RelatedEntry.deleteEntry = function(src)
{
	try
	{
		var _row = LEAP._match(src, LEAP.RelatedEntry.ctf.reRow, 'ctf');
		if (!_row) 
			return;
			
		var table = LEAP._match(_row, LEAP.RelatedEntry.ctf.reTable, 'ctf');
		if (!table)
			return;
		
		var element = LEAP._match(table, LEAP.RelatedEntry.d);
		var module = LWFP.innerApi.getmodule(element);
		
		var _data = _row[LEAP.RelatedEntry.n];		
		
		if (!window.confirm('确定执行删除操作？'))
			return;
		var _ret = module.request2({name:'WfDeleteRelatedEntry', par:{par:_data.id}});
		if (_ret != null && _ret==true)
		{
			table.deleteRow(_row.rowIndex);		
		}
		else
		{
			alert('删除失败！');
		}
	}
	finally
	{
		_row = table = _data = _ret = null;	
	}
}

LEAP.RelatedEntry.showEntry = function(src)
{
	try
	{	
		var _row = LEAP._match(src, LEAP.RelatedEntry.ctf.reRow, 'ctf');
		if (!_row) 
			return;
			
		var element = LEAP._match(src, LEAP.RelatedEntry.d);
		if (!element)
			return;

		var _data = _row[LEAP.RelatedEntry.n];
		
		var module = PageObjectModel.getModule(element.getAttribute('instance'));
		
		if (module.WFShowRelatedEntry)
		{
			module.WFShowRelatedEntry.apply(module, [{entryId:_data.relatedentryid, archCategory:_data.archcategory, isarch:_data.relatedisarch, entryCreatetime:_data.relatedcreatetime}] );
		}
		else
		{		
			if (module.moduleVersion >=3)
			{
				var ele = null;			
				if (module.form)
					ele = LEAP.getElement("div" + module.form);
				else
					ele = module.moduleElement;
	
				var rect = ele.getBoundingClientRect();
 
				var category = null;
				if (_data.relatedisarch != null && _data.relatedisarch == 1 && _data.relatedcreatetime != null)
				{
					var config = LWFP.innerApi.getArchConfig();					
					var d = LEAP.formatdate(_data.relatedcreatetime.time, 0)
					if (config.archtype == 0)
					{
						category = d.substring(0,4);
					}
					else if (config.archtype == 1)
					{
						category = d.replaceall('-','').substring(0,6);
					}
				}
				
				var form = LWFP.API.OpenFlow({entryId:_data.relatedentryid, 
												//isarch:_data.relatedisarch, 
												//entryCreatetime:LEAP.formatdate(_data.relatedcreatetime.time, 0), 
												archCategory:category}, 
												module);
				if (form)
				{
					LEAP.form.setLocation(form.form, rect.left, rect.top);
					LEAP.form.setSize(form.form, rect.width, rect.height);
				}			
			}
			else
			{
				var category = null;
				if (_data.relatedisarch != null && _data.relatedisarch == 1 && _data.relatedcreatetime != null)
				{
					var config = LWFP.innerApi.getArchConfig();					
					var d = LEAP.formatdate(_data.relatedcreatetime.time, 0)
					if (config.archtype == 0)
					{
						category = d.substring(0,4);
					}
					else if (config.archtype == 1)
					{
						category = d.replaceall('-','').substring(0,6);
					}
				}	
	
				LWFP.API.openForm(null, _data.relatedentryid, null, null, null, PageObjectModel.getModule(element.getAttribute('instance')), category);
			}
		}
	}
	finally
	{
		_row = element = _data = module = ele = rect = form = null;
	}
}

LEAP.RelatedEntry.entrySelectForm = null;
LEAP.RelatedEntry.searchRelatedEntry = function(element, src)
{
	try
	{		
		var m = null;
		var ins = element[LEAP.RelatedEntry.symbol.reModuleInstance];
		if (ins != null)
			m = PageObjectModel.getModule(ins);
		else
			m = PageObjectModel.getModule(element.getAttribute('instance'));
		
		//获取已有数据
		var arr = [];
		var table = LEAP.getElement("[ctf=" + LEAP.RelatedEntry.ctf.reTable + "]", element);
		if (table.rows != null && table.rows.length >0)
		{
			for(var i=0; i<table.rows.length; i++)
				arr.add(table.rows[i][LEAP.RelatedEntry.n]);
		}
		if (arr.length == 0)
			arr = null;
		
		//
		if (m.WFRelatedEntrySearch)
		{
			m.WFRelatedEntrySearch(element, {srcElement:src, data:arr});
		}
		else
		{
			if (LEAP.RelatedEntry.entrySelectForm == null)
			{
				
				if (m && m.moduleVersion >=3)
				{
					LEAP.RelatedEntry.entrySelectForm = LEAP.form.create3({name:"LBPMRuntime.RelatedEntrySearch", 
																			title:"选择关联件", 
																			formtype:3
																		});				
				}
				else
				{
					LEAP.RelatedEntry.entrySelectForm = LEAP.form.create("LWFP.LWFPRelatedEntry", '选择关联件');	
				}		
				
				LEAP.RelatedEntry.entrySelectForm.module.regEvent('onSubmit', LEAP.RelatedEntry.addRelatedEntry, this);
			}
			if (LEAP.RelatedEntry.entrySelectForm != null)
			{
				LEAP.RelatedEntry.entrySelectForm.module._related_data = arr;
								
				//LEAP.form.setSize(LEAP.RelatedEntry.entrySelectForm.form, 900, 600);
				LEAP.form.show(LEAP.RelatedEntry.entrySelectForm.form);
				LEAP.RelatedEntry.entrySelectForm.module.innerSearch();
				LEAP.RelatedEntry.entrySelectForm.module.__callback_src = src;
			}
		}
	}
	finally
	{
		m = ins = arr = table = i = null; 
	}
}

LEAP.RelatedEntry.addRelatedEntry = function(arg)
{
	try
	{
		if (!arg || !arg.data || !arg.callback_src)
			return;
			
		var element = LEAP._match(arg.callback_src, LEAP.RelatedEntry.d);
		if (!element)
			return;

		var table = LEAP.getElement("table[ctf=" + LEAP.RelatedEntry.ctf.reTable + "]", element);			
		var entryid = element[LEAP.RelatedEntry.symbol.reCurrentEntryid];
		var _arr = [];
		for(var i=0; i<arg.data.length; i++)
		{
			var _data = arg.data[i];
			if (_data.entryid == entryid)
			{					
				LEAP.messagebox.alert('当前件不能作为自身的关联件！')
				continue;
			}
			if (LEAP.getElement("tr[" + LEAP.RelatedEntry.symbol.reRelatedEntryId + "=" + _data.entryid + "]", table) )
			{
				//LEAP.messagebox.alert('[' + _data.eventname + ']已经是当前件的关联件!')
				continue;
			}
			
			var _d = {};
				_d.id = UUID.randomUUID().replaceall('-','');
				_d.entryid = entryid;
				_d.relatedentryid = _data.entryid;
				_d.relatedeventname = _data.eventname;
				_d.relatedisarch = _data.relatedisarch;
				_d.relatedcreatetime = _data.relatedcreatetime;
				_d.relatedtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_d.userflag = LEAP.getUserInfo().userflag;
				
				
			_arr.add(_d);
		}
		
		if (_arr.length > 0)
		{
			var module = LWFP.innerApi.getmodule(element);
			var _ret = module.request2({name:'WfAddRelatedEntry', par:{par:_arr}});
			if (_ret != null && _ret==true)
			{
				LEAP.RelatedEntry.insertEntrys(element, _arr, false, false);		
			}
			else
			{
				alert('添加失败!');
			}
		}
		else
		{
			alert("关联失败。原因：无法将当前件自身作为关联件，或者所选择的件已经属于当前件的关联件");
		}
	}
	finally
	{
		element = table = entryid = _arr = i = _data = _d = _ret = null;
	}
}

LEAP.RelatedEntry.insertEntrys = function(element, relatedEntrys, clearFirst, readOnly)
{
	LEAP.asyn(LEAP.RelatedEntry._insertEntrys, this, 500, element, relatedEntrys, clearFirst, readOnly);
}

LEAP.RelatedEntry._insertEntrys = function(element, relatedEntrys, clearFirst, readOnly)
{
	try
	{
		var styletype = element.getAttribute('styletype');
		var table = LEAP.getElement("table[ctf=" + LEAP.RelatedEntry.ctf.reTable + "]", element);
		var btnfrm = LEAP.getElement("div[ctf=" + LEAP.RelatedEntry.ctf.reButtonFrame + "]", element);
		
		if (readOnly == true)
			btnfrm.style.display = 'none';
		else
			btnfrm.style.display = 'block';
			
		if (styletype == "1")
		{
			if (clearFirst == true)
				for(var i=table.rows.length-1; i>=0; i--)
					table.deleteRow(i);
			
			if (relatedEntrys != null)
			{
				var currentstep = element[LEAP.RelatedEntry.symbol.reCurrentstep];
				var module = PageObjectModel.getModule(element.getAttribute("instance"));
				var noneEntry = false;
				if (module && module.workflow && module.workflow.getData() && module.workflow.getData().entry == null)
					noneEntry = true;
								
				for(var i=0; i<relatedEntrys.length; i++)
				{
					var _data = relatedEntrys[i];
					var _tr = table.insertRow(-1);
						_tr[LEAP.RelatedEntry.n] = _data;
						_tr.setAttribute(LEAP.RelatedEntry.symbol.reRelatedEntryId, _data.relatedentryid);
						_tr.setAttribute('ctf', LEAP.RelatedEntry.ctf.reRow);
					var _td1 = _tr.insertCell(-1);					
					var _a0 = document.createElement("a");
						_a0.href = 'javascript:void(0)';
						_a0.innerText = _data.relatedeventname;
						_a0.setAttribute('ctf', LEAP.RelatedEntry.ctf.reShow);
						_a0.style.paddingLeft = "4px";
						_a0.style.cursor = 'hand';
						
						_td1.appendChild(_a0);					
				
					var _td2 = _tr.insertCell(-1);
						_td2.style.width = "50px";		
						
					
					if (readOnly == false 
							&& ( (LWFP.RelatedEntryAuthLevel == 0) 
									|| (_data.userflag != null && _data.userflag == LEAP.getUserInfo().userflag))
							&& (currentstep != null || noneEntry == true)   
						)
					{
						var _a = document.createElement('a');
							//_a.className = "wfcontrol_RelatedEntry_table_a";
							
							_a.className = "wfcontrol_RelatedEntry_button";
							_a.href = 'javascript:void(0)';
							_a.title = '取消关联';
							_a.innerText = "删除";			
							
							_a.setAttribute('ctf', LEAP.RelatedEntry.ctf.reDelete);
							_a.href = 'javascript:void(0)';
							//_a.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;';
						_td2.appendChild(_a);
					}
					else
					{
						_td2.innerHTML = "&nbsp;";
					}
				}
			}
		}
		else
		{
			if (clearFirst == true)
				for(var i=table.rows.length-1; i>0; i--)
					table.deleteRow(i);
			
			if (relatedEntrys != null)
			{
				var currentstep = element[LEAP.RelatedEntry.symbol.reCurrentstep];
		
				for(var i=0; i<relatedEntrys.length; i++)
				{
					var _data = relatedEntrys[i];					
					var _tr = table.insertRow(-1);
						_tr[LEAP.RelatedEntry.n] = _data;
						_tr.setAttribute(LEAP.RelatedEntry.symbol.reRelatedEntryId, _data.relatedentryid);
						_tr.setAttribute('ctf', LEAP.RelatedEntry.ctf.reRow);
						
					var _td1 = _tr.insertCell(-1);
						_td1.innerText = _tr.rowIndex;
					var _td2 = _tr.insertCell(-1);
						_td2.style.textAlign = "left";
					var _a0 = document.createElement("a");
						_a0.href = 'javascript:void(0)';
						_a0.innerText = _data.relatedeventname;
						_a0.setAttribute('ctf', LEAP.RelatedEntry.ctf.reShow);
						_a0.style.paddingLeft = "4px";
						_a0.style.cursor = 'hand';				
					_td2.appendChild(_a0);				
					
					var _td3 = _tr.insertCell(-1);
						_td3.innerText = _data.userflag;
					var _td4 = _tr.insertCell(-1);
						_td4.innerText = (_data.relatedtime != null)?LEAP.formatdate(_data.relatedtime.time, 0) : "";
				
					var _td5 = _tr.insertCell(-1);
						_td5.style.width = "20px";
					
					if (readOnly == false && currentstep != null &&
							((_data.userflag != null && _data.userflag == LEAP.getUserInfo().userflag)
								|| (LWFP.RelatedEntryAuthLevel == 0))
						)
					{
						var _a3 = document.createElement("a");
							_a3.className = "wfcontrol_RelatedEntry_button";
							_a3.href = 'javascript:void(0)';
							_a3.title = '取消关联';
							_a3.innerText = "删除";					
							_a3.setAttribute('ctf', LEAP.RelatedEntry.ctf.reDelete);
							
						_td5.appendChild(_a3);
					}
					else
					{
						_td5.innerHTML = "&nbsp;";
					}
				}
			}
			
		
		
		}
	}
	finally
	{
		table = i = btnfrm = currentstep = _data = _tr = _td1 = _a0 = _td2 = _a = null;
	}
}


LEAP.RelatedEntry.setParams = function(element, entryid, currentstep, archCategory, moduleInstance)
{
	element[LEAP.RelatedEntry.symbol.reCurrentEntryid] = entryid;
	element[LEAP.RelatedEntry.symbol.reCurrentstep] = currentstep;
	element[LEAP.RelatedEntry.symbol.reArchCategory] = archCategory;
	element[LEAP.RelatedEntry.symbol.reModuleInstance] = moduleInstance
}

LEAP.RelatedEntry.setReadOnly = function(_element, readonly, reload)
{
	try
	{
		var element = LEAP._match(_element, LEAP.RelatedEntry.d);
		if(null == element) return;
		
		element.setAttribute('readonly', readonly);
		
		if (reload == true)
			LEAP.RelatedEntry._i(element);
	}
	finally
	{
		element = null;
	}
}

LEAP.RelatedEntry.i = function(wait, src)
{
	try
	{
		if (!src)
		{
			if (!event)
				return;
			src = event.srcElement;
		}
		if (!src)
			return;
	
		var element = LEAP._match(src, LEAP.RelatedEntry.d);
		if (!element)
			return;
			
		LEAP.RelatedEntry._i(element);
		
		if (src.parentElement)
			src.parentElement.removeChild(src);
	}
	finally
	{
		element = null;
	}
}

LEAP.RelatedEntry._i = function(element)
{
	try
	{	
		var readonly = element.getAttribute('readonly');
		
		var styletype = element.getAttribute('styletype');
		if (styletype == "1")
		{
			var frm = LEAP.getElement("[ctf=" + LEAP.RelatedEntry.ctf.reContainer + "]", element);
			var _table = LEAP.getElement("[ctf=" + LEAP.RelatedEntry.ctf.reTable + "]", element);
			var btnfrm = LEAP.getElement("[ctf=" + LEAP.RelatedEntry.ctf.reButtonFrame + "]", element);
			
			if (frm == null)
			{
				element.innerHTML = "";
				frm = document.createElement("div");
				frm.className = "wfcontrol_RelatedEntry_frm";
				frm.setAttribute("ctf", LEAP.RelatedEntry.ctf.reContainer);
					
				element.appendChild(frm);
				
				if (_table == null)
				{
					_table = document.createElement("table");
					_table.setAttribute('ctf', LEAP.RelatedEntry.ctf.reTable);
					_table.className = "wfcontrol_RelatedEntry_table";
					_table.cellSpacing = 0;			
					frm.appendChild(_table);
				}
				
				if (btnfrm == null)
				{
					btnfrm = document.createElement("div");
					btnfrm.className = 'wfcontrol_RelatedEntry_button_frm';
					btnfrm.setAttribute('ctf', LEAP.RelatedEntry.ctf.reButtonFrame);
					element.appendChild(btnfrm);
					
					var btn = document.createElement("a");
						btn.className = "lgbtn";
						btn.setAttribute('ctf', LEAP.RelatedEntry.ctf.reButton);
						btn.href = "javascript:";
						btn.innerText = "添加关联件";
									
					var module = PageObjectModel.getModule(element.getAttribute('instance'));
					if (module && module.moduleVersion >=3)
						btn.className = "wfcontrol_RelatedEntry_button_frm_a";	
				}
				
				btnfrm.appendChild(btn);
			}
			
			if (readonly == "true")
				btnfrm.style.display = "none";
		}
		else if (styletype == "2")
		{			
			element.innerHTML = "";
			var _btnframe = document.createElement('div')
				_btnframe.className = 'wfcontrol_RelatedEntry_btnframe';
				_btnframe.setAttribute('ctf', LEAP.RelatedEntry.ctf.reButtonFrame);
			element.appendChild(_btnframe);	
						
			var btn = document.createElement("a");
				btn.setAttribute('ctf', LEAP.RelatedEntry.ctf.reButton);
				btn.href = "javascript:";
				btn.innerText = "添加关联件";			
			_btnframe.appendChild(btn);
			
			if (readonly == "true")
				_btnframe.style.display = "none";
			
			var _table = document.createElement("table");
				_table.setAttribute('ctf', LEAP.RelatedEntry.ctf.reTable);
				_table.className = "wfcontrol_attachmentList_table";
				_table.cellSpacing = 0;
				
				var _tr = _table.insertRow();
				var _th1 = _tr.insertCell();
					_th1.className = "wfcontrol_RelatedEntry_table2_th";
					_th1.innerText = "序号";
					_th1.style.width = "5%";
				var _th2 = _tr.insertCell();
					_th2.className = "wfcontrol_RelatedEntry_table2_th";
					_th2.innerText = "名称";
					_th2.style.width = "50%";
				var _th3 = _tr.insertCell();
					_th3.className = "wfcontrol_RelatedEntry_table2_th";
					_th3.innerText = "关联者";
					_th3.style.width = "10%";
				var _th4 = _tr.insertCell();
					_th4.className = "wfcontrol_RelatedEntry_table2_th";
					_th4.innerText = "关联时间";
					_th4.style.width = "20%";
				var _th5 = _tr.insertCell();
					_th5.className = "wfcontrol_RelatedEntry_table2_th";
					_th5.innerText = "操作";
					_th5.style.width = "15%";
			
				
			element.appendChild(_table);
		}
	
	}
	finally
	{
		frm = _table = btnfrm = btn = module = _btnframe = btn = _table = _tr = _th1 = _th2 = _th3 = _th4 = _th5 = null; 
	}
}

LEAP.RelatedEntry.init();




LEAP.smallTip = {};
LEAP.smallTip.d = 'smallTipshow';
LEAP.smallTip.d2 = 'smallTip';
LEAP.smallTip.n = 'attdata';
LEAP.smallTip.ctf = {};
LEAP.smallTip.container = null;
LEAP.smallTip.conhtml = '<div class="wfcontrol_smallTip_con"></div>';

LEAP.smallTip.init = function()
{
	if (document != null && document.body != null)
		LEAP.smallTip._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.smallTip._init);	
}
LEAP.smallTip._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.smallTip.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.smallTip._init);
}
LEAP.smallTip.uiProcess = function(arg)
{
	try
	{	
		var src = arg.e.srcElement;
		var type = arg.e.type;		
		if (null == src)
			return;
		
		var element = LEAP._match(src, LEAP.smallTip.d);
		var element2 = LEAP._match(src, LEAP.smallTip.d2);
		if (!element && !element2 && LEAP.smallTip.container)
			LEAP.smallTip.container.style.display = "none";
	}
	finally
	{
		src = type = element = element2 = null;
	}
}

LEAP.smallTip._getContinaer = function()
{
	try
	{
		if (LEAP.smallTip.container == null)
		{		
			var div = document.createElement('div');
			document.body.appendChild(div);
			//div.style.display = 'none';
			div.className = "wfcontrol_smallTip";
			div.setAttribute('ct', LEAP.smallTip.d);
			div.innerHTML = LEAP.smallTip.conhtml;	
			LEAP.smallTip.container = div;			
		}		
		return LEAP.smallTip.container;
	}
	finally
	{
		div = null;
	}
}

LEAP.smallTip.show = function(html, x, y, callerRect)
{
	try
	{
		var con = LEAP.getElement('.wfcontrol_smallTip_con', LEAP.smallTip._getContinaer());
		con.innerHTML = html;
		
		if (callerRect != null)
		{
			LEAP.smallTip.container.style.display = "block";
			LEAP.asyn(LEAP.smallTip.__position, this, 200, con, callerRect);			
		}
		else
		{
			LEAP.smallTip.container.style.left = x + 'px';
			LEAP.smallTip.container.style.top = y + 'px';
			
			LEAP.smallTip.container.style.display = "block";
		}		
	}
	finally
	{
		con = null;
	}
}

LEAP.smallTip.__position = function(con, callerRect)
{
	try
	{
		if (callerRect.bottom + con.clientHeight + 10 > document.body.clientHeight)
			LEAP.smallTip.container.style.top = (callerRect.top - con.clientHeight) + 'px';
		else
			LEAP.smallTip.container.style.top = (callerRect.bottom) + 'px';
		
		if (callerRect.left + con.clientWidth > document.body.clientWidth)
			LEAP.smallTip.container.style.left = (callerRect.right - con.clientWidth) + 'px';
		else
			LEAP.smallTip.container.style.left = (callerRect.left) + 'px';
	}
	finally
	{}		
}


LEAP.smallTip.init();




/**
 * 附件
 * @class LEAP.attlist control
 * @type user control
 * @example
 * 
 * dddddddddddddddd
 * 
 模板
 

 

标签:	
	listtype 类型，非固定项0，固定项1，默认0
	showtitle 显示表头,1显示0不显示，默认1
	defaultcolor 默认附件名颜色, 默认'#56ABFC'
	uploadcolor 上传后颜色, 默认'#56ABFC'
	fixitems 固定项定义,如：	
		'{"groupid":"0","items":[
		{"code":"a", "name":"身份证", "title":"验原件收复印件", "nullable":false, "multifile":false, "scantype":1, "captureParams":{"attname":"材料名称", "zoom":1, "pagewidth":240, "pageheight":320, "devno":2, "pagestyle":0, "toplabel":"", "bottomlabel":"", "topbtn":"拍照", "bottombtn":""}},	
		{"code":"b","name":"户口本", "title":"验原件收复印件（户主页和本人页）", "nullable":false, "multifile":false, "scantype":1, "captureParams":{"attname":"材料名称", "zoom":1, "pagewidth":240, "pageheight":320, "devno":2, "pagestyle":1, "toplabel":"身份证正面", "bottomlabel":"身份证反面", "topbtn":"扫描正面", "bottombtn":"扫描反面"}},
		{"code":"c","name":"计生证明", "title":"验原件收复印件", "nullable":false, "multifile":false, "scantype":1, "captureParams":{"attname":"材料名称", "zoom":1, "pagewidth":240, "pageheight":320, "devno":2, "pagestyle":2, "toplabel":"", "bottomlabel":"", "topbtn":"扫描", "bottombtn":"扫描下一张"}},
		{"code":"d","name":"ddddddd", "nullable":false, "multifile":true}]}'
	readonly 只读,值域为1或者0,默认0
	previewwidth
	previewheight
		
	
	viewsize 当图片超出该大小时创建缩略图 , 默认50
	minsize 允许上传文件的最小限制,单位为KB 默认0
	maxsize 允许上传文件的最大限制,单位为KB 默认1024*10
	types 选择框过滤的文件类型  ; 分割  如: *.jpg;*.gif;*.png
	typesdesc 选择框过滤的文件类型说明  如: 所有文件
	savesource 是否保存源文件
	viewwidth 缩略图宽度,默认200
	viewheight 缩略图高度,默认200
	quality 缩略图质量 1-100,数字越小质量越低,生成图片的大小越小,默认50
	uploadpath 上传路径 如:default
	
	includemain 是否包含正文0不包含1包含,默认0

    scanParams 扫描参数 '{"quality":100, "maxwidth":0, "maxheight":0, "title":"新扫描件", "uploadpath":"default"}'
    
    attachmentRange 绑定附件范围（适配原标签页中添加的正文）： 1=windows下根据标签页配置绑定正文（原有规则），linux下绑定正文
*/


LEAP.attlist = {};
LEAP.attlist.d = 'attlist';
LEAP.attlist.n = 'attdata';
LEAP.attlist.col = {sn:'sn', name:'name', uploader:'uploader', ownername:"ownername", uploadstep:'uploadstep', uploadtime:'uploadtime', size:'size', operation:'operation'};
LEAP.attlist.ctf = {atttable:'atttable', attrow:'attrow', cell_sn:"cell_sn", checkAll:"checkAll", check:"check", sn:"sn",
					btnframe:"btnframe", btnscan:"btnscan",	btnword:"btnword",	btnupload:"btnupload",
					btnframe2:"btnframe2",
					btndown:"btndown",		
					btnsingledown:"btnsingledown",	//插件方式下载
					btnimgpreview:"___imgpreview",
					btnupdate:"btnupdate",
					btndel:"btndel",
					btnupload2:"btnupload2",
					btnHide:"btnHide",
					btnbatchupload:"btnbatchupload",
					btnuploaddiv:"btnuploaddiv",
					btnscan2:"btnscan2",
					exstatus:"exstatus",
					downhref:"downhref",
					openhref:"openhref",
					btnbatchscan:"btnbatchscan",
					btnBatchDownload:"btnBatchDownload", btnBatchDownload2:"btnBatchDownload2",
					btnDocView:"btnDocView",
					btnMU:"btnMU",
					btnMD:"btnMD",
					btnMT:"btnMT",
					btnMB:"btnMB",
					changeflag:"changeflag",
					dispflag:"dispflag",
					ishide:"ishide",
					sssid:"sssid"};
					
LEAP.attlist.rt = {titlerow:"titlerow", temprow:"temprow", normalrow:"normalrow", fixrow:"fixrow", fixnormalrow:"fixnormalrow"};

LEAP.attlist.open_document_pdf_limit_size = 0;
LEAP.attlist.open_document_doc_limit_size = 0;
LEAP.attlist.open_document_xls_limit_size = 0;
LEAP.attlist.open_document_ppt_limit_size = 0;

//LEAP.attlist.symbol ={zw:-9, PDFZW:-6, FJ:1, SM:9};
LEAP.attlist.symbol ={zw:-9, wps:-8, PDFZW:-6, OFDZW:-2, ceb:-4, scan:-3, FJ:0, SM:9}; //{word:-9,wps:-8,pdf:-6,ceb:-4,scan:-3};
LEAP.attlist.sm = {wordparam:"wordparam", deleted:"deleted"};
LEAP.attlist.filenamemaxlen = 200;
LEAP.attlist.udpform = null;
LEAP.attlist.init = function()
{
	if (document != null && document.body != null)
		LEAP.attlist._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.attlist._init);	
		
	ElementEventManager.addManagedEventType(LEAP.attlist.d, 'onListChange');
	ElementEventManager.addManagedEventType(LEAP.attlist.d, 'onRowDataChange');
	ElementEventManager.addManagedEventType(LEAP.attlist.d, 'onRowClick');
}
LEAP.attlist._init = function()
{		
	LEAP.addEvent(document.body, 'mouseover', LEAP.attlist.uiProcess,  null, null, true);
	LEAP.addEvent(document.body, 'click', LEAP.attlist.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LEAP.attlist._init);
}

LEAP.attlist.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
			
		var ctf = src.getAttribute('ctf');
		if (!ctf)
			return;
			
		if (arg.type == "mouseover" && ctf == LEAP.attlist.ctf.btnuploaddiv)
		{	
			LEAP.attlist._loadUploadFlash(src);		
		}
		else if (arg.type == "click")
		{
			var element = LEAP._match(src, LEAP.attlist.d);
			if (!element)
				return;
			
			LEAP.attlist.filenamemaxlen = element.getAttribute("filenamemaxlen")?element.getAttribute("filenamemaxlen"):200;
				
			var row = LEAP._match(src, LEAP.attlist.ctf.attrow, 'ctf');
			
			if (ctf == LEAP.imgview.ctf.preview)
				LEAP.attlist._preview(src);
			else if (ctf == LEAP.attlist.ctf.btndel)
				LEAP.attlist._del(element, row);
			else if (ctf == LEAP.attlist.ctf.btnupdate)
				LEAP.attlist._update(row);
			else if (ctf == LEAP.attlist.ctf.btnscan2 || ctf == LEAP.attlist.ctf.btnscan)
				LEAP.attlist._scan(element, src);
			else if (ctf == LEAP.attlist.ctf.btnbatchscan)
				LEAP.attlist._batchScan(element, src);
			else if (ctf == LEAP.attlist.ctf.downhref || ctf == LEAP.attlist.ctf.btnimgpreview){
				LEAP.attlist._open(element, row, false,true,src);
			}
			else if (ctf == LEAP.attlist.ctf.openhref)
				LEAP.attlist._open(element, row, false, true,src);
			else if (ctf == LEAP.attlist.ctf.btndown)
			{
				var canDownload = src.getAttribute("canclick");
				if (canDownload && canDownload == "false") 
				{
					LEAP.messagebox.alert("无下载权限!");
					return;
	            }	           
				LEAP.attlist._open(element, row, true,false,src);
			}
			else if (ctf == LEAP.attlist.ctf.btnupload2)
				LEAP.attlist._upload(element, src);
			else if (ctf == LEAP.attlist.ctf.btnbatchupload)
				LEAP.attlist._batchUpload(element, src);
			else if (ctf == LEAP.attlist.ctf.btnDocView)
				LEAP.attlist._DocView(element);
			else if (ctf == LEAP.attlist.ctf.btnBatchDownload2)
			{	
				LEAP.attlist._batchDownload2(element);
			}
			else if (ctf == LEAP.attlist.ctf.btnBatchDownload)
			{
				try
				{
					var _btndown = LEAP.getElement("a[ctf="+LEAP.attlist.ctf.btndown+"]");
					if (_btndown && _btndown .getAttribute("canclick") == "false")
					{
						LEAP.messagebox.alert("无下载权限!");
						return;
					}
				}finally{
					
				}
				
				LEAP.attlist._batchDownload(element);
			}
			else if (ctf == LEAP.attlist.ctf.btnsingledown)
			{
				if (LEAP.DocumentView.isWin == true && LEAP.DocumentView.Browser.browser == "IE")
					LEAP.attlist._singleDownload(element, src);
				else
					LEAP.attlist._open(element, row, true, false,src);
			}
			else if (ctf == LEAP.attlist.ctf.btnMD || ctf == LEAP.attlist.ctf.btnMU || ctf == LEAP.attlist.ctf.btnMT || ctf == LEAP.attlist.ctf.btnMB)
			{
				LEAP.attlist.move(element, row, ctf);
			}
			else if (ctf == LEAP.attlist.ctf.checkAll)
			{
				LEAP.attlist._checkAll(element, src);
			}
			else if (ctf == LEAP.attlist.ctf.btnHide)
			{
				LEAP.attlist._hide(element);
			}
			
			ElementEventManager.handleEvent(element, "onRowClick", {row:row,src:src});
			/*
			if (ctf == LEAP.attlist.ctf.open)
				LEAP.attlist._open(row);
			else if (ctf == LEAP.attlist.ctf.down || ctf == LEAP.attlist.ctf._down)
				LEAP.attlist._down(row);
			else if (ctf == LEAP.attlist.ctf.editzw)
				LEAP.attlist._wordEditUpload(src);
			else if (ctf == LEAP.attlist.ctf.scan2)
				LEAP.attlist.scan2(src);
				
			else if (ctf == LEAP.attlist.ctf.scanbtn)
				LEAP.attlist.scan(src);
			*/
			
		}		
	}
	finally
	{
		src = ctf = element = row = null;
	}
}

LEAP.attlist.i = function(wait, src)
{
	try
	{
		if (!src)
		{
			if (!event)
				return;
			src = event.srcElement;
		}
		if (!src)
			return;
			
		if (wait != null && wait >0) 
		{ 
			var fn = function() 
			{
		 		LEAP.attlist.i(null, src); src = null; 
		 	};
		 	
			setTimeout(fn, wait); return; 
		}
	 		
		var _element = LEAP._match(src, LEAP.attlist.d);
		
		LEAP.attlist._i(_element, false);
		
		if (src.parentElement)
			src.parentElement.removeChild(src);
	}
	finally
	{
		_element = null;
	}
}

LEAP.attlist._i = function(_element, force)
{
	try
	{	
		var element = LEAP._match(_element, LEAP.attlist.d);
		if (null == element) 
			return;
		
		if (_element.getAttribute("_hasInit__") && (force == null || force == false ))
			return;
							
		LEAP.attlist.__setDefaultAtt(element);
		
		element['_fixitemsdef'] = null;
		element.removeAttribute("_fixgroupid");	
		
		var readonly = element.getAttribute("readonly");
					
		var type = element.getAttribute("listtype");
		if (type == null)
		{
			type = "0";
			element.setAttribute("listtype", type);
		}
		
		var table = LEAP.getElement("table[ctf=" + LEAP.attlist.ctf.atttable + "]", element);
		
		var showtitle = element.getAttribute("showtitle");
		if (showtitle == null)
			showtitle = "1";
		
		if (showtitle == "1")
			table.rows[0].style.display = "";
		else
			table.rows[0].style.display = "none";
				
		//非固定项功能按钮
		var btnframe = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe + "]", element);
		if (btnframe)
		{
			btnframe.style.display = (type == "0") ?"":"none";
			if (type == "0")
			{
				for(var i=0; i<btnframe.childNodes.length; i++)
				{
					if (btnframe.childNodes[i].tagName)
					{
						if ((btnframe.childNodes[i].tagName.toLowerCase() == "a" || btnframe.childNodes[i].tagName.toLowerCase() == "div")
								&& btnframe.childNodes[i].getAttribute("ctf") != LEAP.attlist.ctf.btnBatchDownload
								&& readonly == "true")
						{
							btnframe.childNodes[i].style.display = "none";
						}
						else
						{
							if (btnframe.childNodes[i].getAttribute("ct") == "fileupload")
								LEAP.fileupload.setReadOnly(btnframe.childNodes[i], false);
							
							btnframe.childNodes[i].style.display = "block";
						}
					}
				}				
			}
		}
		
				
		//模板行
		var temprow = LEAP.getElement("tr[rt=" + LEAP.attlist.rt.temprow + "]", table);
		if (!temprow)
		{
			LEAP.messagebox.alert("检索附件插件模板失败,请检查表单定义!");
			return;
		}		
		var btnframe2 = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe2 + "]", temprow);
		
		//模板行内按钮
		var btnupdate = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnupdate + "]", btnframe2);
		var btndel = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndel + "]", btnframe2);
		var btnDown = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndown + "]", btnframe2);
		var btnimgpreview = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnimgpreview + "]", btnframe2);
		var btnuploaddiv = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnuploaddiv + "]", btnframe2);
		var btnupload2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnupload2 + "]", btnframe2);
		var btnscan2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnscan2 + "]", btnframe2);		
		var exstatus = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.exstatus + "]", btnframe2);
		
		if (btnupdate)
			btnupdate.style.display = "none";
		if (btndel)
			btndel.style.display = "none";
		if (btnDown)
			btnDown.style.display = "none";
		if (btnimgpreview)
			btnimgpreview.style.display = "none";			
		if (btnuploaddiv)
			btnuploaddiv.style.display = (type == "0") ?"none":"";
		if (btnupload2)
			btnupload2.style.display = (type == "0") ?"none":"";
		if (btnscan2)
			btnscan2.style.display = (type == "0") ?"none":"";		
		if (exstatus)
			exstatus.style.display = (type == "0") ?"none":"";
		
		LEAP.attlist.__setwidth(btnframe2);
		
		if (temprow)
			temprow.style.display = "none";
		
		LEAP.attlist._clear(element);
		
		LEAP.attlist.__loadFixItems(element);
		
		if (!element["hasmouseover"])
		{
			LEAP.addEvent(element, 'mouseover', LEAP.attlist.uiProcess, null, null, true, 9999);
			element["hasmouseover"] = 1;
		}
		
		element.setAttribute("_hasInit__", "1");		
		
		//LEAP.attlist._setZWButtonDisplay(element);
		
		LEAP.asyn(LEAP.attlist.__clearFlashBackground, this, 900, element);
		LEAP.asyn(LEAP.attlist.initTabcode, this, 300, element);
		
		var dragdrop = LEAP.getElement("[ct=" + LEAP.dragdrop.d + "]", element);
		if (dragdrop != null && dragdrop.getAttribute("__hasRegistSortEvent") == null)
		{
			LEAP.addEvent(dragdrop, 'onSort', LEAP.attlist.__onSort);
			dragdrop.setAttribute("__hasRegistSortEvent", 1);
		}	
	}
	finally
	{
		element = type = table = showtitle = btnframe = temprow = btnframe2 = btnupdate = btndel = 
		btnDown = btnimgpreview = btnuploaddiv = btnupload2 = btnscan2 = exstatus = dragdrop = null; 
	}
}

LEAP.attlist.initTabcode = function(element)
{
	//正文按钮
	var btn = LEAP.getElement("[userpar=-9]", element);
	
	if (btn == null || btn.getAttribute("autotabcode") != "1")
		return;
	
	var module = LWFP.innerApi.getmodule(element);
	var tabs = LWFP.API.getTabInfosByType(module, 2);
	if (tabs == null)
		return;
		
	var tab = tabs[0];
	btn.setAttribute("tabcode", tab.code);
}

LEAP.attlist.__clearFlashBackground = function(element)
{
	if (LEAP.isIE && LEAPBrowser.IEVersion < 10) 
	{	
		var arr = LEAP.getElements("[tct=" + LEAP.attlist.d + "]", element);		
		if (arr != null)
		{
			for(var i=0; i<arr.length; i++)
				arr[i].style.backgroundColor = "transparent !important";
			
		}
	}	
}

LEAP.attlist.__setDefaultAtt = function(element)
{
	if (!element.getAttribute('previewwidth'))
		element.setAttribute('previewwidth', 2048);
	if (!element.getAttribute('previewheight'))
		element.setAttribute('previewheight', 2048);
		
	if (!element.getAttribute('viewsize'))
		element.setAttribute('viewsize', 1024000000);
	if (!element.getAttribute('viewwidth'))
		element.setAttribute('viewwidth', 2048);
	if (!element.getAttribute('viewheight'))
		element.setAttribute('viewheight', 2048);
			
	if (!element.getAttribute('quality'))
		element.setAttribute('quality', 100);
}

LEAP.attlist.__loadFixItems = function(element)
{
	try
	{
		var type = element.getAttribute("listtype");
		var str = element.getAttribute("fixitems");
		var btnbatchscan = LEAP.getElement('a[ctf=' + LEAP.attlist.ctf.btnbatchscan + ']', element); 
		
		if (type == "1" && str != null && str != "")
		{
			var def = JSON.parse(str);
			var groupid = def.groupid;
			element.setAttribute("_fixgroupid", groupid);
			
			var fixitems = def.items;
			for(var i=0; i<fixitems.length; i++)
			{
				var _att = fixitems[i];
					_att.fixgroupid = groupid;
					_att.fixitemcode = fixitems[i].code;
					_att.fixitemname = fixitems[i].name;
					_att.fixitemmulti = fixitems[i].multifile;
					_att.types = fixitems[i].types;
					_att.typesdesc = fixitems[i].typesdesc;
					_att.titletip = fixitems[i].title;
					_att.isFixItem = true;					
					
				LEAP.attlist.insert(element, _att);
			}
			
			element['_fixitemsdef'] = def;
			
			if (btnbatchscan)
				btnbatchscan.style.display = '';
		}
		else
		{
			element['_fixitemsdef'] = null;
			element.removeAttribute("_fixgroupid");
			
			if (btnbatchscan)
				btnbatchscan.style.display = 'none';
		}
		
		var readonly = element.getAttribute("readonly");
		if (readonly == "true" && btnbatchscan)
			btnbatchscan.style.display = "none";
	}
	finally
	{
		type = str = def = groupid = fixitems = i = _att = btnbatchscan = readonly = null;
	}
}

LEAP.attlist.setNullable = function(_element, nullable)
{
	try
	{
		var element = LEAP._match(_element, LEAP.attlist.d);
		if (element)
		{
			var _def = element['_fixitemsdef'];
			if (_def != null && _def.items != null && _def.items.length>0)
			{
				for(var k=0; k< _def.items.length; k++)
				{
					_def.items[k].nullable = nullable;
				}
				
				element['_fixitemsdef'] = _def;
			}
		}
	}
	finally
	{
		element = _def = k = null;
	}
}

LEAP.attlist.setFixItems = function(_element, items)
{
	try
	{
		var element = LEAP._match(_element, LEAP.attlist.d);
		if (element)
		{
			if (items == null)
			{
				element.removeAttribute("fixitems");
			}
			else
			{
				var str = JSON.stringify(items);
				element.setAttribute("fixitems", str);
			}
			
			LEAP.attlist._i(element, true);
		}
	}
	finally
	{
		element = str = null;
	}
}

LEAP.attlist.setBeforeBindingData = function(_element, fn)
{
	var element = LEAP._match(_element, LEAP.attlist.d);
	if (element == null)
		return;
		
	element['BeforeBindingData'] = fn;
}

LEAP.attlist.setExistFixAttachements = function(_element, atts)
{
	try
	{
		var element = LEAP._match(_element, LEAP.attlist.d);
		if (element == null)
			return;
			
		LEAP.attlist._i(element, true);
		
		if (atts == null)
			return;
		
		var _table = LEAP.getElement("table[ctf=" + LEAP.attlist.ctf.atttable + "]", element);	
		if (_table == null)
			return;
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", _table);
		if (rows == null)
			return;
		
		for(var i=0; i<atts.length; i++)
		{
			var _a = atts[i];			
			var code = _a.attcode; 
			if (code == null)
				continue;
			
			for(var k=0; k<rows.length; k++)
			{
				var row = rows[k];				
				var _att = row[LEAP.attlist.n];
				var _att2 = _a;
				if (_att == null || _att.fixitemcode != code || _att.id != null)
					continue;
					
				_att2.atttype = (_a.atttype == null) ? 0 : _a.atttype;				 
				_att2.title = _a.title; 
				_att2.name = _a.name;
				_att2.uuid = _a.uuid;
				_att2.namedpath = _a.namedpath;
				_att2.updateType = 0;
				_att2.ownername = LEAP.getUserInfo().fullName;
				_att2.filecount = _a.filecount;				
				_att2.uploadtime = (_a.uploadtime == null)? {time:LEAP.getUserInfo().getTimeTicket()}:_a.uploadtime;
				_att2.canDelete = (_a.canDelete == null)?true:_a.canDelete;
				_att2.canEdit = (_a.canEdit == null)?true:_a.canDelete;

				LEAP.attlist._bindItemDetail(element, _att2, _table, false);
								
				break;
			}			
		}
	}
	finally
	{
		element = _table = rows = i = _a = code = k = row = _att = _att2 = null;
	}
}

LEAP.attlist.__setwidth = function(con)
{
	LEAP.asyn(LEAP.attlist.___setwidth, this, 50, con);
}
LEAP.attlist.___setwidth = function(con)
{
	try
	{
		if (con && con.childNodes)
		{
			var n = 0;
			for(var i=0; i<con.childNodes.length; i++)
			{
				var node = con.childNodes[i];			
				if (node.style && node.style.display != "none" 
					&& node.clientWidth != null && node.clientWidth >0 )
					n += node.clientWidth + 6;
			}
	
			if (n > 0 )
				con.style.width = n + "px";
				
		}	
	}
	finally
	{
		n = i = node = null;
	}
}

LEAP.attlist._preview = function(src)
{
	try
	{	
		var element = LEAP._match(src, LEAP.attlist.d);
		var row = LEAP._match(src, LEAP.attlist.ctf.attrow, 'ctf');
		var att = row[LEAP.attlist.n];
		
		var atts = LEAP.attlist._getValue(element);
		var _previewIdx = 0;
		var ret = [];
		for(var i=0; i<atts.length; i++)
		{
			var _tmp = atts[i];			
			if (_tmp.name == null)
				continue;
			var n = _tmp.name.toLowerCase();
			if (n.endWith('.jpg') || n.endWith('.jpeg') || n.endWith('.png') || n.endWith('.gif'))
				ret.add(_tmp);
				
			if (_tmp.name == att.name)
				_previewIdx = ret.length - 1;
		}
		
		var previewParam = {previewwidth:2048, previewheight:2048};
		if (element.getAttribute('previewwidth') != null && element.getAttribute('previewheight') != null)
			previewParam = {previewwidth:element.getAttribute('previewwidth'), previewheight:element.getAttribute('previewheight')};
		
		LEAP.imgview._preview(null, ret, _previewIdx, previewParam);
	}
	finally
	{
		element = row = att = atts = _previewIdx = ret = i = _tmp = n = previewParam = null;
	}
}

LEAP.attlist.getValue = function(_element)
{
	try
	{
		var element = LEAP._check(_element, LEAP.attlist.d);
		if (element == null)
			return;
		
		var mdid = element.getAttribute("mdid");
		return mdid;
	}
	catch (err)
	{
		alert("错误：" + err.number + ":" + err.description);
	}
	finally
	{
		element = mdid = null;
	}
}

LEAP.attlist.setValue = function(_element, mdid)
{
	try
	{	
		var element = LEAP._check(_element, LEAP.attlist.d);
		if (!element)
			return;

		element['deleted'] = null;
		
		if (!mdid || mdid == "")
		{
			element.removeAttribute('mdid');
		}
		else
		{
			element.setAttribute('mdid', mdid);
		}
	}
	finally
	{
		element = null;
	}
}

LEAP.attlist.getPageValue = function(instance, formElement)
{
	try
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.attlist.d + "][instance=" + instance + "]", formElement);		
		if (elements == null)
			return null;
			
		var ret = [];
		for(var i=0; i<elements.length; i++)
		{
			var element = elements[i];
			var value = LEAP.attlist._getChange(element);
			if (value != null)
			{
				for(var k=0; k<value.length; k++)
					ret.add(value[k]);
			}
		}
		
		if (ret.length == 0)
			return null;
		else
			return ret;
	}
	finally
	{
		elements = ret = i = element = value = k = null;
	}
}


LEAP.attlist.setPageValue = function(instance, moduleElement, values, extend)
{
	try
	{	
		var elements = LEAP.getElements("div[ct=" + LEAP.attlist.d + "][instance=" + instance + "]", moduleElement);
		if (elements == null)
			return null;
		
		for(var i=0; i<elements.length; i++)
		{
			var ele = elements[i];			
			ele['deleted'] = null;
			
			LEAP.attlist._i(ele, true);
			
			var mdid = ele.getAttribute("mdid");  
				
			if (values != null)
			{
				var flag = true;
				
				for(var k=0; k<values.length; k++)
				{
					var _tmp = values[k];
					var att = LWFP.innerApi.clone(_tmp);
					
					//(!mdid && elements.length==1) 条件是为了兼容从V5升级V6的表单的老数据可以显示（V5的流程表单没有mdid）
					//attachmentRange 绑定附件范围（适配原标签页中添加的正文）： 1=windows下根据标签页配置绑定正文（原有规则），linux下绑定正文
					if ( (att.mdid != null && att.mdid == mdid) 
						|| (!mdid && elements.length==1) 
						|| (att.mdid == null && ele.getAttribute("attachmentRange") == "1" && LEAP.DocumentView.OSType.indexOf("Win")<0) 
					)
					{
						if (ele.getAttribute("attachmentRange") == "1" && LEAP.DocumentView.OSType.indexOf("Win")<0)
						{//linux环境下，绑定
						}
						else if (extend && extend.zwInside && att.atttype<0)
						{
							continue;
						}
						
						LEAP.attlist.insert(ele, att);
						if (att.canEdit == false)
							flag = false;
					}
				}
				
				//批量扫描按钮权限
				var btnbatchscan = LEAP.getElement('a[ctf=' + LEAP.attlist.ctf.btnbatchscan + ']', ele); 
				if (btnbatchscan && flag == false)
				{
					btnbatchscan.style.display = 'none';
				}
			}			
			
			if (extend && extend.currentStep)
				ele['_currentStep'] = extend.currentStep;
		}			
	}
	finally
	{
		elements = i = ele = mdid = k = att = btnbatchscan = flag = null;
	}
}

LEAP.attlist._getChange = function(element)
{
	try
	{
		var ret = [];
		
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", element);
		if (rows != null)
		{
			for(var i=0; i<rows.length; i++)
			{
				var att = rows[i][LEAP.attlist.n];
					att.orderid = rows[i].rowIndex;
				if (att.updateType != null)
					ret.add(att);
			}
		}
		
		var _deleted = element[LEAP.attlist.sm.deleted];
		if (_deleted != null && _deleted.length>0)
		{
			for(var i=0; i<_deleted.length; i++)
				ret.add(_deleted[i]);
		}
		
		if (ret.length == 0)
			return null;
		else
			return ret;
	}
	finally
	{
		ret = rows = i = att = _deleted = i = null;
	}	
}

LEAP.attlist._getValue = function(element)
{
	try
	{
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", element);
		if (rows == null)
			return null;
		
		var ret = []; 
		for(var i=0; i<rows.length; i++)
		{
			var _rt = rows[i].getAttribute("rt")
			var _d = rows[i][LEAP.attlist.n];
			
			if (_d && (_d.namedpath != null || _d.exstatus != null))
			{			
				ret.add(_d);
			}
		}
		
		if (ret.length == 0)
			ret = null;
					
		return ret;
	}
	finally
	{
		rows = ret = i = _rt = _d = null;
	}
}

//引用：leap.trans
LEAP.attlist._getRow = function(element,type)
{
	try
	{
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", element);
		if (rows == null)
			return null;
		
		for(var i=0; i<rows.length; i++)
		{
			var _d = rows[i][LEAP.attachment.n];
			
			if (_d && _d.atttype == type)
			{
				return rows[i];
			}
		}
	}
	finally
	{
		rows = i =  _d = null;
	}
}

LEAP.attlist._clear = function(element)
{
	try
	{
		var _table = LEAP.getElement("table[ctf=" + LEAP.attlist.ctf.atttable + "]", element);
		if (_table)
		{
			for(var i=_table.rows.length-1; i>0; i--)
			{
				var row = _table.rows[i];
				var rt = row.getAttribute("rt");
				
				if (rt != LEAP.attlist.rt.titlerow && rt != LEAP.attlist.rt.temprow)
					_table.deleteRow(i);
			}
		}
	}
	finally
	{
		_table = i = row = rt = null;
	}
}

LEAP.attlist.insert = function(element, _att, src)
{
	try
	{	
		var mdid = element.getAttribute("mdid"); 
		if (mdid == null && (_att.namedpath != null || _att.exstatus != null))
		{
			if (_att.mdid != null)
				mdid = _att.mdid;
			else
				mdid = UUID.randomUUID().replaceall('-', '');
			
			element.setAttribute("mdid", mdid);		
		}		
		if (_att.namedpath != null ||  _att.exstatus != null)
			_att.mdid = mdid;
		
		var _isFix = (element.getAttribute('fixitems'))?true:false; //是否固定项
			
		var _readonly = element.getAttribute('readonly'); //是否只读
		if (_readonly && _readonly=='true') 
			_readonly = true; 
		else 
			_readonly = false;

		var _table = LEAP.getElement("table[ctf=" + LEAP.attlist.ctf.atttable + "]", element);
		
		_table.style.display = "";
				
		if (_att.isFixItem == true)
			_att.title = _att.fixitemname;			
		
		var _isFixItemDetail = false;		
		if (_att.fixitemcode != null && (_att.namedpath != null || _att.exstatus != null) )
			_isFixItemDetail = true;
		
		if (src)
		{
			var _src_row = LEAP._match(src, LEAP.attlist.ctf.attrow, 'ctf', 5);
			if (_src_row)
			{
				var _d = _src_row[LEAP.attlist.n];
				if (_d.fixitemcode != null)
				{
					_isFixItemDetail = true;
					
					_att.fixitemcode = _d.fixitemcode;
					_att.captureParams = _d.captureParams;
				}
			}
		}
		
		if (element['BeforeBindingData'])
			_att = element['BeforeBindingData'](element, _att);
		
		if (_isFixItemDetail == true)
		{
			return LEAP.attlist._bindItemDetail(element, _att, _table, _readonly);
		}
		else
		{
			var _row = LEAP.attlist._insert(element, _att, _table, _readonly, _isFix);
			LEAP.attlist.__refreshSN(element);
			return _row;
		}
	}
	finally
	{
		_isFix = _readonly = _table = _isFixItemDetail = _src_row = _d = null;
	}
}

LEAP.attlist._insert = function(element, att, _table, _readonly, _isFix)
{
	try
	{	
		var temprow = LEAP.getElement("tr[rt=" + LEAP.attlist.rt.temprow + "]", _table);		
		if (temprow == null)
			LEAP.messagebox.alert("检索附件插件模板失败！");
			
		//添加行
		var tr = _table.insertRow(-1);
			tr.setAttribute("ctf", LEAP.attlist.ctf.attrow);
		if (att.fixitemcode != null)
		{
			tr.setAttribute("rt", LEAP.attlist.rt.fixrow);
		}
		else
		{
			tr.setAttribute("rt", LEAP.attlist.rt.normalrow);
			tr.setAttribute("ddt", temprow.getAttribute("ddt"));  
		}
				
		tr[LEAP.attlist.n] = att;		
		for(var i=0; i<temprow.cells.length; i++)
		{
			var tmpcell = temprow.cells[i];			
			var td = tr.insertCell(-1);			
			td.className = tmpcell.className;
			
			var ttd = _table.rows[0].cells[i];
			var md = ttd.getAttribute("md");
			var bt = ttd.getAttribute("bt");
						
			if (md == LEAP.attlist.col.sn)
			{
				td.innerHTML = tmpcell.innerHTML;
				td.setAttribute("ctf", LEAP.attlist.ctf.cell_sn);
				var sn = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", td);
				if (sn != null)
				{	
					sn.innerText = tr.rowIndex -1;
				}
				else
				{
					td.innerText = tr.rowIndex -1;	
				}
				
				var changeflag = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.changeflag + "]", td);
				if (changeflag)
				{
					changeflag.style.display = ((att.hasUpdate == true)?"inline-block":"none");
					changeflag.title = ((att.updater) ? "最近修改人：" + att.updater : "");
				}
			}
			else if (md == LEAP.attlist.col.name)
			{
				//附件名颜色
				var color = "#56ABFC";
				if (element.getAttribute("defaultcolor"))
					color = element.getAttribute("defaultcolor");
				if (att.defaultcolor)
					color = att.defaultcolor;
				if (att.namedpath != null && element.getAttribute("uploadcolor"))
					color = element.getAttribute("uploadcolor");
				if (att.disp == 0)
					color = (element.getAttribute("hidecolor") == null) ? '#9f9d9d' :element.getAttribute("hidecolor");
			
				var _a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  tmpcell);
				if (!_a)
					_a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.openhref + "]",  tmpcell);
				if (_a)
				{	
					var ext = (/\.[^\.]+/.exec(att.name));
					if (ext == null)
						ext = "";
					var _txt = att.title + ext;					
					if (att.atttype <0)
					{						
						_txt = '<font ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【正文】</font>' + att.title + ext;						
						if (att.atttype == LEAP.attlist.symbol.PDFZW)
							_txt = '<font  ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【PDF正文】</font>' + att.title + ext;
						else if (att.atttype == LEAP.attlist.symbol.OFDZW)
							_txt = '<font  ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【OFD正文】</font>' + att.title + ext;
							
						var perfixExpress = ttd.getAttribute("perfix");
						if (perfixExpress)
						{
							var __per = LEAP.attlist._getPerfix(att, perfixExpress);
							if (__per != null)
							{							
								_txt = '<font  ctf="' + LEAP.attlist.ctf.downhref + '" color=red>' + __per + '</font>' + att.title + ext;
							}
						}
					}
					
					var a = _a.cloneNode();
						a.innerHTML = _txt;
						a.style.color = color;
					if (att.titletip)
					{
						a.setAttribute("title", att.titletip);
					}
					else
					{
						var __uploader = "";
						if (att.ownername != null)
							__uploader = ((att.ownername != null) ? "\r\n上传用户：" + att.ownername : "");
						else if (att.owner != null)
							__uploader = ((att.owner != null) ? "\r\n上传用户：" + att.owner : "");							
						var __uploadetime = ((att.uploadtime != null) ? "\r\n上传时间：" + LEAP.formatdate(att.uploadtime.time, 0) : "");
					
						a.setAttribute("title", att.title + ext + __uploader + __uploadetime );
					}
					
					td.appendChild(a);
				}
			}
			else if (md == LEAP.attlist.col.uploader)
			{
				var __uploader = "";
				if (att.ownername != null)
					__uploader = ((att.ownername != null)?att.ownername : "") + ((att.ownerorganname!=null)?'(' + att.ownerorganname + ')':"");
				else if (att.owner != null)
					__uploader = ((att.owner != null)?att.owner : "") + ((att.ownerorganname!=null)?'(' + att.ownerorganname + ')':"");
				
				td.innerText = __uploader;
			}
			else if (md == LEAP.attlist.col.ownername)
			{
				td.innerText = (att.ownername == null)?att.owner:att.ownername;
			}
			else if (md == LEAP.attlist.col.uploadstep)
			{
				td.innerText = (att.stepaliasname != null)?att.stepaliasname : "";
			}
			else if (md == LEAP.attlist.col.uploadtime)
			{
				if(bt =="datetime")
				{
					td.innerText = (att.uploadtime != null)?LEAP.formatdate(att.uploadtime.time, 0) : "";
				}
				else
				{
					td.innerText = (att.uploadtime != null)?LEAP.formatdate(att.uploadtime.time, 1) : "";
				}
			}
			else if (md == LEAP.attlist.col.size)
			{
				td.innerText = LEAP.attlist._getAttsize(att);
			}
			else if (md == LEAP.attlist.col.operation)
			{	
				td.innerHTML = tmpcell.innerHTML;
				var btnframe2 = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe2 + "]", td);
				
				var type = element.getAttribute("listtype");
				
				if (type == "0")
				{
					var btnDown = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndown + "]", td);
					var btnupdate = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnupdate + "]", td);
					var btndel = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndel + "]", td);
					
					if (btnDown)
						btnDown.style.display = "";
					
					if (_readonly == false && att.canEdit == true)
					{
						if (btnupdate)
							btnupdate.style.display = "";
					}
					else
					{
						if (btnupdate)
							btnupdate.style.display = "none";
					}
														
					if (_readonly == false && att.canDelete == true)
					{
						if (btndel)
							btndel.style.display = "";
					}
					else
					{
						if (btndel)
							btndel.style.display = "none";
					}
				}
				else
				{
					var btnDown = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndown + "]", td);
					var btnimgpreview = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnimgpreview + "]", td);
					var btnuploaddiv = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnuploaddiv + "]", td);
					var btnupload2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnupload2 + "]", td);
					var btnscan2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnscan2 + "]", td);
					var exstatus = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.exstatus + "]", td);
										
					if (att.namedpath != null)
					{
						if (btnDown)
							btnDown.style.display = "";
						if (btnimgpreview)
							btnimgpreview.style.display = "";
					}
					else
					{
						if (btnDown)
							btnDown.style.display = "none";
						if (btnimgpreview)
							btnimgpreview.style.display = "none";
					}
					
					if (_readonly == false)
					{
						if (btnuploaddiv)
							btnuploaddiv.style.display = "";
						if (btnupload2)
							btnupload2.style.display = "";						
						if (btnscan2)
							btnscan2.style.display = "";
						if (exstatus)
						{
							if (att.fixitemmulti == true)
								exstatus.style.display = "none";
							else
								exstatus.style.display = "";
						}
					}
					else
					{
						if (btnuploaddiv)
							btnuploaddiv.style.display = "none";
						if (btnupload2)
							btnupload2.style.display = "none";
						if (btnscan2)
							btnscan2.style.display = "none";
						if (exstatus)
							exstatus.style.display = "none";
							
					}					
				}
				
				LEAP.attlist.__setwidth(btnframe2);
			}
			else
			{
				td.innerText = att[md];
			}		
		}
		
		if (att.realHide == true)
		{
			tr.style.display = "none";
			tr.setAttribute(LEAP.attlist.ctf.ishide, "1");
		}
		else
		{
			tr.setAttribute(LEAP.attlist.ctf.ishide, "0");
		}
		
		if (att.id)
		{
			tr.setAttribute(LEAP.attlist.ctf.sssid, att.id);
		}
		else
		{
			tr.setAttribute(LEAP.attlist.ctf.sssid, UUID.randomUUID().replaceall('-', ''));
		}
		
		return tr;
	}
	finally
	{
		temprow  = i = tmpcell = td = sn = _txt = ttd = md = color = _a = a = btnframe2 = type = btnupdate = 
		btndel = btnDown = btnimgpreview = btnuploaddiv = btnupload2 = btnscan2 = exstatus = null;
	}
}

LEAP.attlist._getPerfix = function(att, perfixExpress)
{
	try
	{
		var def = JSON.parse(perfixExpress);
		var express = def.express;
		var result = express;
		var ex = /\$(\w+|\d+)\:(\w+|\d+)\$/g;
		var matchs = express.match(ex);
		var flag = false;
		if (matchs)
		{
			for(var i=0; i<matchs.length; i++)
			{
				var flag = false;
				var str = matchs[i];
				var en = str.substring(1, str.indexOf(":"));
				var md = str.substring(str.indexOf(":") + 1, str.length-1);
				
				var mdValue = att[md];
				var enArr = def[en];
				if (mdValue != null && mdValue != "" && enArr && enArr.length>0)
				{
					for(var k=0; k<enArr.length; k++)
					{
						var e = enArr[k];
						if (e.key == mdValue)
						{
							flag = true;
							result = result.replace(str, e.value);
							break;
						}
					}
				}
			}	
		}
		
		if (flag == true)
			return result;
		else
			return null;
	}
	catch(ex)
	{
		LEAP.messagebox.alert(ex.stack, 3);
		return null;
	}
}

LEAP.attlist._bindItemDetail = function(element, att, _table, _readonly)
{
	try
	{
		var temprow = LEAP.getElement("tr[rt=" + LEAP.attlist.rt.temprow + "]", _table);		
		if (temprow == null)
			LEAP.messagebox.alert("检索附件插件模板失败！");
				
		var _itemRow;
		var _d;
		for(var i=0; i<_table.rows.length; i++)
		{
			var __d = _table.rows[i][LEAP.attlist.n];
			if (__d && __d.fixitemcode == att.fixitemcode)
			{
				_itemRow = _table.rows[i];
				_d = __d;
				
				att.fixitemcode = _d.fixitemcode;
				att.fixitemname = _d.fixitemname;
				att.fixitemmulti = _d.fixitemmulti;
				att.defaultcolor = _d.defaultcolor;
				att.uploadcolor = _d.uploadcolor;
				att.types = _d.types;
				att.typesdesc = _d.typesdesc;
				att.isFixItem = _d.isFixItem;	
				
				break;
			}
		}
		if (!_itemRow || !_d)
			return;
		
		var tr;
		if (_d.fixitemmulti == true)
		{//多项新增缩进行
			tr = _table.insertRow(_itemRow.rowIndex + 1);
			tr.setAttribute("ctf", LEAP.attlist.ctf.attrow);
			tr.setAttribute("rt", LEAP.attlist.rt.fixnormalrow);
			tr[LEAP.attlist.n] = att;
			
			for(var i=0; i<temprow.cells.length; i++)
			{
				var tmpcell = temprow.cells[i];			
				var td = tr.insertCell(-1);			
				td.className = tmpcell.className;
				
				var ttd = _table.rows[0].cells[i];
				var md = ttd.getAttribute("md");
							
				if (md == LEAP.attlist.col.sn)
				{	
				}
				else if (md == LEAP.attlist.col.name)
				{
					//附件名颜色
					var color = "#56ABFC";
					if (element.getAttribute("defaultcolor"))
						color = element.getAttribute("defaultcolor");
					if (att.namedpath != null && element.getAttribute("uploadcolor"))
						color = element.getAttribute("uploadcolor");
					
					var _a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  tmpcell);
					if (_a)
					{
						var a = _a.cloneNode();
							a.innerText = att.title;
							a.style.color = color;
						td.appendChild(a);
					}
					
					var __a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  _itemRow);
					if (__a)
						__a.style.color = color;
				}
				else if (md == LEAP.attlist.col.uploader)
				{
					var __uploader = "";
					if (att.ownername != null)
						__uploader = ((att.ownername != null)?att.ownername : "") + ((att.ownerorganname!=null)?'(' + att.ownerorganname + ')':"");
					else if (att.owner != null)
						__uploader = ((att.owner != null)?att.owner : "") + ((att.ownerorganname!=null)?'(' + att.ownerorganname + ')':"");
					
					td.innerText = __uploader;
				}
				else if (md == LEAP.attlist.col.uploadstep)
				{
					td.innerText = (att.stepaliasname != null)?att.stepaliasname : "";
				}
				else if (md == LEAP.attlist.col.uploadtime)
				{
					td.innerText = (att.uploadtime != null)?LEAP.formatdate(att.uploadtime.time, 1) : "";
				}
				else if (md == LEAP.attlist.col.size)
				{
					td.innerText = LEAP.attlist._getAttsize(att);
				}
				else if (md == LEAP.attlist.col.operation)
				{	
					td.innerHTML = tmpcell.innerHTML;
					var btnframe2 = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe2 + "]", td);
					
					var btndel = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndel + "]", td);
					var btnDown = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndown + "]", td);
					var btnimgpreview = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnimgpreview + "]", td);
					var btnuploaddiv = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnuploaddiv + "]", td);
					var btnupload2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnupload2 + "]", td);
					var btnscan2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnscan2 + "]", td);
					var exstatus = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.exstatus + "]", td);
					
					if (btnDown)
					{
						btnDown.style.display = "";
					}					
					if (btnimgpreview)
					{
						btnimgpreview.style.display = "none";
					}
					
					if (_readonly == false && (att.canDelete == null || att.canDelete == true) )
					{
						if (btndel)
							btndel.style.display = "";
					}
					else
					{
						if (btndel)
							btndel.style.display = "none";
					}					
					
					if (btnuploaddiv)
						btnuploaddiv.style.display = "none";
					if (btnupload2)
						btnupload2.style.display = "none";
					if (btnscan2)
						btnscan2.style.display = "none";
					if (exstatus)
						exstatus.style.display = "none";
					
					LEAP.attlist.__setwidth(btnframe2);
				}
				else
				{
					td.innerText = att[md];
				}
			}	
			
			var __btnframe2 = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe2 + "]", _itemRow);
			if (__btnframe2)
			{
				if (att.canEdit == false)
					__btnframe2.style.display = "none";
				else
					__btnframe2.style.display = "";
			}			
		}
		else
		{
			tr = _itemRow;
			tr[LEAP.attlist.n] = att;
			
			for(var i=0; i<temprow.cells.length; i++)
			{
				var tmpcell = temprow.cells[i];
				var ttd = _table.rows[0].cells[i];				
				var td = tr.cells[i];
				var md = ttd.getAttribute("md");
							
				if (md == LEAP.attlist.col.sn)
				{		
				}
				else if (md == LEAP.attlist.col.name)
				{
					//附件名颜色
					var color = "#56ABFC";
					if (element.getAttribute("defaultcolor"))
						color = element.getAttribute("defaultcolor");
					if (element.getAttribute("uploadcolor"))
						color = element.getAttribute("uploadcolor");
				
					var _a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  td);
					if (_a)
					{
						_a.style.color = color;
						
						if (att.atttype == 4)
							_a.innerText = att.fixitemname + "【" + att.title + "】";
					}
				}
				else if (md == LEAP.attlist.col.uploader)
				{
					var __uploader = "";
					if (att.ownername != null)
						__uploader = ((att.ownername != null)?att.ownername : "") + ((att.ownerorganname!=null)?'(' + att.ownerorganname + ')':"");
					else if (att.owner != null)
						__uploader = ((att.owner != null)?att.owner : "") + ((att.ownerorganname!=null)?'(' + att.ownerorganname + ')':"");
										
					td.innerText = __uploader;
				}
				else if (md == LEAP.attlist.col.uploadstep)
				{
					td.innerText = (att.stepaliasname != null)?att.stepaliasname : "";
				}
				else if (md == LEAP.attlist.col.uploadtime)
				{
					td.innerText = (att.uploadtime != null)?LEAP.formatdate(att.uploadtime.time, 1) : "";
				}
				else if (md == LEAP.attlist.col.size)
				{
					td.innerText = LEAP.attlist._getAttsize(att);
				}
				else if (md == LEAP.attlist.col.operation)
				{											
					var btnframe2 = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe2 + "]", td);
				
					var btndel = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndel + "]", td);
					var btnDown = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndown + "]", td);
					var btnimgpreview = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnimgpreview + "]", td);
					var btnuploaddiv = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnuploaddiv + "]", td);
					var btnupload2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnupload2 + "]", td);
					var btnscan2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnscan2 + "]", td);
					var exstatus = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.exstatus + "]", td);
										
					/*var isPic = false;
					var _ex = /\.[^\.]+/.exec(att.name);					
					if (_ex && (_ex[0] == '.png' || _ex[0] == '.jpg' || _ex[0] == '.jpeg' || _ex[0] == '.gif'))
						isPic = true;
					*/
					
					if (btnuploaddiv)
						btnuploaddiv.style.display = "none";
					if (btnupload2)
						btnupload2.style.display = "none";
					if (btnscan2)
						btnscan2.style.display = "none";
				
					if (exstatus)
						exstatus.style.display = "none";
						
					if (att.exstatus != null)
					{
						if (btnDown)
							btnDown.style.display = "none";
					}						
					else if (btnDown)
					{
						btnDown.style.display = "";
					}					
					
					if (btnimgpreview)
					{
						btnimgpreview.style.display = "none";
					}
					
					if (_readonly == false && (att.canDelete == null || att.canDelete == true) )
					{
						if (btndel)
							btndel.style.display = "";
					}
					else
					{
						if (btndel)
							btndel.style.display = "none";
					}
					
					LEAP.attlist.__setwidth(btnframe2);
				}
				else
				{
					td.innerText = att[md];
				}			
			}		
		}
		
		if (att.id)
		{
			tr.setAttribute(LEAP.attlist.ctf.sssid, att.id);
		}
		else
		{
			tr.setAttribute(LEAP.attlist.ctf.sssid, UUID.randomUUID().replaceall('-', ''));
		}
		
		return tr;
	}
	finally
	{
		temprow = _itemRow = _d = i = __d = tr = i = tmpcell = td = ttd = md = color = _a = 
		a = __a = btnframe2 = btndel = btnDown = btnimgpreview = btnscan2 = 
		exstatus = tr = i = tmpcell = ttd = td = md = btnframe2 = 
		btndel = btnDown = btnimgpreview = btnuploaddiv = btnupload2 = btnscan2 = exstatus = __btnframe2 = null;
	}	
}

LEAP.attlist._getAttsize = function(_att)
{
	if (_att.attsize == null)
		return "";
	
	if (_att.attsize >= 1048576)
		return Math.floor(_att.attsize/1048576) + "M";
	else if (_att.attsize >= 1024)
		return Math.floor(_att.attsize/1024) + "K";
	else if (_att.attsize >= 0)
		return _att.attsize + "B";	
}

/*LEAP.attlist._loadUploadFlash = function(src)
{
	try
	{
		if (src.getAttribute("_hf"))
			return;
		
		var row = LEAP._match(src, LEAP.attlist.ctf.attrow, 'ctf');
		if (!row)
			return;
		
		var _att = row[LEAP.attlist.n];
		if (!_att)
			return;
		
		var str = "<a pp='att' tct='attlist' ct='uploadbtn' maxselect=100 zip=2 class='wfcontrol_attlist_button2' ";
		if (_att.types)
			str += " types='" + _att.types + "'";
		if (_att.typesdesc)
			str += " typesdesc='" + _att.typesdesc + "'";
				
		var img = "LEAP/LWFP/StyleSheet/control/images/attList/04/upload04.png";
		if (src.getAttribute('flashimg'))
			img = src.getAttribute('flashimg');
		//console.log(getComputedStyle(src, "style").backgroundImage);
		//console.log(getStyle(src, "style").backgroundImage);		
		str += "showtext='上传' userpar='0' img='" + img + "' imgwidth=44 imgheight=26 style='width:40px;height:23px;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></a>";
		src.innerHTML = str;
		
	}
	finally
	{
		row = _att = str = img = null;
	}
}*/

LEAP.attlist._loadUploadFlash = function(src)
{
	try
	{
		if (src.getAttribute("_hf"))
			return;
		
		var row = LEAP._match(src, LEAP.attlist.ctf.attrow, 'ctf');
		if (!row)
			return;
		
		var _att = row[LEAP.attlist.n];
		if (!_att)
			return;
		
		var str = "<div pp='att' tct='attlist' ct='uploadbtn' maxselect=100 zip=2 class='wfcontrol_attlist_button2' ";		
		if (_att.types)
			str += " types='" + _att.types + "'";
		if (_att.typesdesc)
			str += " typesdesc='" + _att.typesdesc + "'";
				
		var img = "LEAP/LWFP/StyleSheet/control/images/attList/04/upload04.png";
		if (src.getAttribute('flashimg'))
			img = src.getAttribute('flashimg');

		str += "showtext='上传' userpar='0' img='" + img + "' imgwidth=44 imgheight=26 style='width:40px;height:23px;'><img style='display:none' src='data:image:png,base64' onerror='LEAP.uploadbtn.i(0);'></div>";
		src.innerHTML = str;	
		src.setAttribute("_hf", 1);
		
		LEAP.attlist.__clearFlashBackground(src);
		
		//LEAP.asyn(LEAP.attlist.__clearFlashBackground, this, 0, src);
	}
	finally
	{
		row = _att = str = img = null;
	}
}


LEAP.attlist._del = function(element, row, silence)
{
	try
	{
		if (silence != true)
		{
			if (window.confirm("确定删除吗？") == false) 
				return;
		}
		
		var _att = row[LEAP.attlist.n];
		var _rt = row.getAttribute('rt');
		if (_att.updateType != 0)
			_att.updateType = 2;
			
		if (_att.updateType == 2)
		{		
			var _deleted = element['deleted'];
			if (!_deleted)
				_deleted = [];
			
			_deleted.add(_att);
			
			element['deleted'] = _deleted;
		}
		
		if (_rt == LEAP.attlist.rt.fixrow)
		{
			var _d = {};
				_d.fixitemcode = _att.fixitemcode;
				_d.fixitemname = _att.fixitemname;
				_d.fixitemmulti = _att.fixitemmulti;
				_d.defaultcolor = _att.defaultcolor;
				_d.uploadcolor = _att.uploadcolor;
				_d.types = _att.types;
				_d.typesdesc = _att.typesdesc;
				_d.isFixItem = _att.isFixItem;
				_d.captureParams = _att.captureParams;
				
			row[LEAP.attlist.n] = _d;
			
			if (element['BeforeBindingData'])
				_d = element['BeforeBindingData'](element, _d);
			
			var _table = LEAP.getElement("table[ctf=" + LEAP.attlist.ctf.atttable + "]", element);
			var temprow = LEAP.getElement("tr[rt=" + LEAP.attlist.rt.temprow + "]", _table);
			for(var i=0; i<temprow.cells.length; i++)
			{
				var tmpcell = temprow.cells[i];
				var ttd = _table.rows[0].cells[i];				
				var td = row.cells[i];
				var md = ttd.getAttribute("md");
				
				if (md == LEAP.attlist.col.name)
				{
					var color = "#56ABFC";
					if (element.getAttribute("defaultcolor"))
						color = element.getAttribute("defaultcolor");
					if (_d.defaultcolor)
						color = _d.defaultcolor;
					
					var _a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  td);
					if (_a)
					{
						_a.style.color = color;		
						_a.innerText = _d.fixitemname;
					}
				}				
				else if (md == LEAP.attlist.col.operation)
				{
					var btnframe2 = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe2 + "]", td);
					
					var btndel = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndel + "]", td);
					var btnDown = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btndown + "]", td);
					var btnimgpreview = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnimgpreview + "]", td);
					var btnuploaddiv = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnuploaddiv + "]", td);
					var btnupload2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnupload2 + "]", td);
					var btnscan2 = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.btnscan2 + "]", td);
					var exstatus = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.exstatus + "]", td);
										
					if (btndel)
						btndel.style.display = "none";
					if (btnDown)
						btnDown.style.display = "none";
					if (btnimgpreview)
						btnimgpreview.style.display = "none";
										
					if (btnuploaddiv)
						btnuploaddiv.style.display = "";					
					if (btnupload2)
						btnupload2.style.display = "";
					if (btnscan2)
						btnscan2.style.display = "";
					
					if (exstatus)
					{
						if (_d.fixitemmulti == true)
						{
							exstatus.style.display = "none";
						}
						else
						{
							LEAP.select2.setValue(exstatus, null);
							exstatus.style.display = "";
						}
					}
					
					LEAP.attlist.__setwidth(btnframe2);					
				}
				else if (md == LEAP.attlist.col.sn)
				{}
				else
				{
					if (_d[md])
						td.innerText = _d[md];
					else					
						td.innerText = "";	
				}
			}
		}
		else
		{
			row.parentNode.deleteRow(row.rowIndex);
		}		
		
		//LEAP.attlist._setZWButtonDisplay(element);
		
		LEAP.attlist._handleListChange(element);
		LEAP.attlist._handleRowDataChange(element, {key:"delete", row:row, data:_att});
	}
	finally
	{
		_att = _rt = _deleted = _d = _table = temprow = i = tmpcell = ttd = td = md = 
		color = _a = btnframe2 = btndel = btnDown = btnimgpreview = btnuploaddiv = btnupload2 =
		btnscan2 = exstatus = null;										
	}
}

LEAP.attlist._update = function(row)
{
	try
	{
		var _formElement = null;
		var _txt = null;
		var _btn = null;
		if (LEAP.attlist.udpform == null)
		{
			LEAP.attlist.udpform = LEAP.form.create3({name:null, title:'修改文件名', width:500, height:150, formtype:3});
			
			var str = '<div style="height:100%; width:100%;">';
				str += '<input ut="filename" class="LC_input_conner" style="width:97%; margin:10px 2% 10px 1%;" lcv="2" mdtype="text" bt="text" ht="input">';
				str += '<input ut="submit" class="LC_button_conner LC_button_blue" style="float:right; margin:0px 30px 0px 0px;" type="button" value="确定" lcv="2" ht="input">'
				str += '</div>'
				
			LEAP.form.setContent(LEAP.attlist.udpform.form, str);
			
			_formElement = LEAP.getElement(LEAP.attlist.udpform.form);
			LEAP.attlist.udpform._txt = LEAP.getElement("input[ut=filename]", _formElement);
			_btn = LEAP.getElement("input[ut=submit]", _formElement);
			LEAP.addEvent(_btn, 'click', LEAP.attlist.__update);
		}		
		
		var att = row[LEAP.attlist.n];
		LEAP.attlist.udpform.FileName = att.title;
		LEAP.attlist.udpform._txt.value = att.title;
		LEAP.attlist.udpform._attRow = row;
		
		LEAP.form.show(LEAP.attlist.udpform.form);	
	}
	finally
	{
		_formElement = _txt = _btn = str = null;	
	}
}

LEAP.attlist.__update = function(arg)
{
	try
	{
		var _title = LEAP.attlist.udpform._txt.value.trim();
		if (_title == '')
		{
			alert('文件名不可为空！');
			return;
		}
		if ((_title.indexof('\\')>=0) || 
			(_title.indexof('/')>=0) ||
			(_title.indexof(':')>=0) ||
			(_title.indexof('*')>=0) ||
			(_title.indexof('?')>=0) ||
			(_title.indexof('"')>=0) ||
			(_title.indexof('<')>=0) ||
			(_title.indexof('>')>=0) ||
			(_title.indexof('|')>=0) )			
		{
			alert('文件名不可包含如下字符： \\ / : * ? " < > |');
			return;
		}
		if(_title.length>LEAP.attlist.filenamemaxlen){
			alert('文件名长度超出限制，请重新修改');
			return;
		}	
		var _row = LEAP.attlist.udpform._attRow;
		var _att = _row[LEAP.attlist.n];
		_att.title = _title;

		if (_att.updateType == null)
			_att.updateType = 1;
		
		_row[LEAP.attlist.n] = _att;
		
		
		if (_att.atttype == LEAP.attlist.symbol.SM && _att.title.endWith('.zip'))
			_title = _att.title.substring(0,_att.title.length-4);	
			
		var _ex = /\.[^\.]+/.exec(_att.name);
		if (_ex)
			_title = _title + _ex[0];
		
		var _a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  _row);
		if (_a)		//_a.innerText = _title;
		{	
			var _txt = _att.title + (/\.[^\.]+/.exec(_att.name));
			_a.title = _txt;
			if (_att.atttype <0)
			{
				_txt = '<font ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【正文】</font>' + _att.title + (/\.[^\.]+/.exec(_att.name));						
				if (_att.atttype == LEAP.attlist.symbol.PDFZW)
					_txt = '<font  ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【PDF正文】</font>' + _att.title + (/\.[^\.]+/.exec(_att.name));
				else if (_att.atttype == LEAP.attlist.symbol.OFDZW)
					_txt = '<font  ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【OFD正文】</font>' + _att.title + (/\.[^\.]+/.exec(_att.name));
			}
			
			_a.innerHTML = _txt;
		}
		
		LEAP.form.hide(LEAP.attlist.udpform.form);
		
		LEAP.attlist._handleListChange(_row);
		LEAP.attlist._handleRowDataChange(_row, {key:"update", row:_row, data:_att});
		
	}
	finally
	{
		_title = _row = _att = _ex = _a = null; 
	}	
}


LEAP.attlist.setPageReadOnly = function(instance, moduleElement, readonly)
{
	try
	{
		if (readonly == null)
			readonly = true;
			
		var elements = LEAP.getElements("div[ct=" + LEAP.attlist.d + "][instance=" + instance + "]", moduleElement);
		if (elements != null)
		{
			for(var i=0; i<elements.length; i++)
				LEAP.attlist.setReadOnly(elements[i], readonly, true);
		}
	}
	finally
	{
		elements = i = null;	
	}
}


			
LEAP.attlist.setReadOnly = function(_element, readonly, reload)
{
	try
	{
		var element = LEAP._match(_element, LEAP.attlist.d);
		if(null == element) return;
		
		if (readonly == true)
			element.setAttribute('readonly', readonly);
		else
			element.removeAttribute('readonly');

		if (reload == true)
			LEAP.attlist._i(element, true);
	}
	finally
	{
		element = null;
	}
}

LEAP.attlist.onSelectVCComplete = function(_element, olddata, data, src)
{
	try
	{	
		var element = LEAP._match(_element, LEAP.attlist.d);
		if (element == null)
			return;
	
		if (data)
		{
			if (data.codeid == "")
			{
				
			}
			else
			{
				var title = data.codevalue;
				LEAP.attlist.onUploadComplete_inner(element, {title:title, exstatus:data.codeid}, null, 4, null, src);
			}
		}
	}
	finally
	{
		element = title = null;
	}
}

LEAP.attlist._scan = function(element, src)
{
	try
	{		
		var captureParams = null;
		var scanParams = element.getAttribute("scanParams");
		if (scanParams) 
			scanParams = JSON.parse(scanParams);
		
		var ctf = src.getAttribute("ctf");
		if (ctf == LEAP.attlist.ctf.btnscan2)
		{//行内扫描
			
			var row = LEAP._match(src, LEAP.attlist.ctf.attrow, 'ctf');
			var att = row[LEAP.attlist.n];
			captureParams = att.captureParams;						
		}
		
		//LEAP.attlist.__registScanEvent();
		
		if (captureParams == null || captureParams.pagestyle == 2)
		{
			var element = LEAP._match(src, LEAP.attlist.d);
					
			var quality = (scanParams && scanParams.quality)?scanParams.quality:100;
			var maxwidth = (scanParams && scanParams.maxwidth)?scanParams.maxwidth:0;
			var maxheight = (scanParams && scanParams.maxheight)?scanParams.maxheight:0;
			var uploadpath = (scanParams && scanParams.uploadpath)?scanParams.uploadpath:"default";
			//var title = ((scanParams && scanParams.title)?scanParams.title:"新扫描件") + ".zip";
			var title = ((scanParams && scanParams.title)?scanParams.title:"新扫描件") + ".pdf";
						
			var sid = 'JSESSIONID=' + leapclient.getsid();			
			
			var __url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid()+ '&path=' + uploadpath;
		
			var exCapParam = "";
			if (captureParams)
			{
				exCapParam += captureParams.zoom + "&";
				exCapParam += captureParams.pagewidth + "&";
				exCapParam += captureParams.pageheight + "&";
				exCapParam += captureParams.devno + "&";
				exCapParam += captureParams.pagestyle + "&";
				exCapParam += captureParams.toplabel + "&";
				exCapParam += captureParams.bottomlabel + "&";
				exCapParam += captureParams.topbtn + "&";
				exCapParam += captureParams.bottombtn + "&1";
			}
			else
			{
				exCapParam = "1&0&0&2&2&&&扫描&扫描下一张&1";
			}
		
			var def = {uploadurl	:__url,
			 		title		:	title,
			 		quality		:	quality,	//图片质量，默认100
			 		maxwidth	:	maxwidth,		//图片尺寸最大宽度，0不缩放
			 		maxheight	:	maxheight,		//图片尺寸最大高度，0不缩放		
			 		exCapParam	:	exCapParam,
			 		groupParams	:	"",		 		
			 		callback	:	LEAP.attlist.OnScanCompleted,
					callbackParam:	{scantype:"scan", scansrc:src},
					domain		:this};
		
			LEAP.Comb.scanner.scanupload(def);	
			
			
		}
		else
		{
			var uploadpath = (scanParams && scanParams.uploadpath)?scanParams.uploadpath:"default";
			var sid = 'JSESSIONID=' + leapclient.getsid();
			var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
			//if (captureParams.pagestyle == 2)
			//	url += "&unzip=1";
										
			var def = {uploadurl	:	url,
 					attname		:	captureParams.attname, 	//材料名称
 					zoom		:	null?1:captureParams.zoom, 			//缩小倍数 
					pagewidth	:	captureParams.pagewidth,		//取景宽度（像素） 
					pageheight	:	captureParams.pageheight,		//取景高度（像素）
					pagestyle	:	captureParams.pagestyle,			//拍摄样式（0整页1上下分栏2连续多页）
					toplabel	:	captureParams.toplabel,		//取景框上栏提示文本 
					bottomlabel	:	captureParams.bottomlabel,		//取景框下栏提示文本
					topbtn		:	captureParams.topbtn,		//第一步拍摄按钮名
					bottombtn	:	captureParams.bottombtn,		//第二步拍摄按钮名
					filetype	:	1,			//多页拍摄文件类型(0-zip； 1-pdf；整页和上下分栏时为jpeg)
 					callback	:	LEAP.attlist.OnScanCompleted,
					callbackParam:	{scantype:"scan", scansrc:src},
					domain		:this};
			
			LEAP.Comb.scanner.snapshoot(def);	
		}
						
		
		LEAP.showMask();
		LEAP.asyn(LEAP.hideMask, this, 5000);
	}
	finally
	{
		captureParams = scanParams = ctf = row = att = element = quality = maxwidth = maxheight = uploadpath = 
		title = sid = __url = exCapParam = def = 
		uploadpath = sid = url = def = null;
	}
}

LEAP.attlist._batchScan = function(element, src)
{
	try
	{		
		var element = LEAP._match(src, LEAP.attlist.d);
		
		var type = element.getAttribute("listtype");
		if (type == null || type != "1")
			return;
			
		var fixitemsdef = element['_fixitemsdef'];
		if (fixitemsdef == null || fixitemsdef.items == null)
			return;
			
			
		var exCapParam = "1";
		var groupParams = "";
		for(var i=0; i<fixitemsdef.items.length; i++)
		{
			if (groupParams != "")
				groupParams += "&";
			
			//groupParams += fixitemsdef.items[i].fixitemcode + "$" + fixitemsdef.items[i].fixitemname;
			groupParams += i + "$" + fixitemsdef.items[i].fixitemname;
			
			if (fixitemsdef.items[i].captureParams && fixitemsdef.items[i].captureParams.zoom)
				exCapParam = fixitemsdef.items[i].captureParams.zoom + "";
		}		
		//exCapParam += "&0&0&2&2&&&扫描&扫描下一张";
		exCapParam += "&0&0&2&2&&&扫描&扫描下一张&1";
			
		var scanParams = element.getAttribute("scanParams");
		if (scanParams) 
			scanParams = JSON.parse(scanParams);
							
		var quality = (scanParams && scanParams.quality)?scanParams.quality:100;
		var maxwidth = (scanParams && scanParams.maxwidth)?scanParams.maxwidth:0;
		var maxheight = (scanParams && scanParams.maxheight)?scanParams.maxheight:0;
		var uploadpath = (scanParams && scanParams.uploadpath)?scanParams.uploadpath:"default";
		var title = ((scanParams && scanParams.title)?scanParams.title:"新扫描件") + ".zip";
							
		var sid = 'JSESSIONID=' + leapclient.getsid();			
		var __url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
						
		var def = {uploadurl	:	__url,
			 		title		:	title,
			 		quality		:	quality,	//图片质量，默认100
			 		maxwidth	:	maxwidth,		//图片尺寸最大宽度，0不缩放
			 		maxheight	:	maxheight,		//图片尺寸最大高度，0不缩放		
			 		exCapParam	:	exCapParam,
			 		groupParams	:	groupParams,		 		
			 		callback	:	LEAP.attlist.OnScanCompleted,
					callbackParam:	{scantype:"batchscan", scansrc:src},
					domain		:	this};
		
		LEAP.Comb.scanner.scanupload(def);	
		
		LEAP.showMask();
		LEAP.asyn(LEAP.hideMask, this, 5000);
	}
	finally
	{
		element = type = fixitemsdef = exCapParam = groupParams = i = quality = maxwidth = maxheight = uploadpath = title = sid = __url = def = null;
	}
}

LEAP.attlist._ScanRead = function(row)
{
	try
	{	
		var att = row[LEAP.attlist.n];
		var element = LEAP._match(row, LEAP.attlist.d);
		
		var scanParams = element.getAttribute("scanParams");
		if (scanParams) 
			scanParams = JSON.parse(scanParams);
			
		var captureParams = att.captureParams;
		
		var quality = (scanParams && scanParams.quality)?scanParams.quality:100;
		var maxwidth = (scanParams && scanParams.maxwidth)?scanParams.maxwidth:0;
		var maxheight = (scanParams && scanParams.maxheight)?scanParams.maxheight:0;
		var uploadpath = (scanParams && scanParams.uploadpath)?scanParams.uploadpath:"default";						
		var sid = 'JSESSIONID=' + leapclient.getsid();
		var readonly = (att.canEdit==true)?0:1;
					
		var title = ((scanParams && scanParams.title)?scanParams.title:"新扫描件");
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&readscan=1&old_namedpath=' + att.namedpath + '&old_name=' + att.name+ '&old_uuid=' + att.uuid + '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
					
		var exCapParam = "";
		if (captureParams)
		{
			exCapParam += captureParams.zoom + "&";
			exCapParam += captureParams.pagewidth + "&";
			exCapParam += captureParams.pageheight + "&";
			exCapParam += captureParams.devno + "&";
			exCapParam += captureParams.pagestyle + "&";
			exCapParam += captureParams.toplabel + "&";
			exCapParam += captureParams.bottomlabel + "&";
			exCapParam += captureParams.topbtn + "&";
			exCapParam += captureParams.bottombtn;
		}
		else
		{
			exCapParam = "1&0&0&2&2&&&扫描&扫描下一张";
		}
					
		var downloadUrl = LEAP.attlist._getPath(att, element);
		if (downloadUrl.endWith('.zip'))
		{
			downloadUrl = downloadUrl.substring(0, downloadUrl.length-4);
			downloadUrl += '/';
			title = title.endWith('.zip')?att.title:att.title+'.zip';				
		}
		else
		{
			title = title.endWith('.pdf')?att.title:att.title+'.pdf';
			exCapParam = exCapParam + "&1"
			
			var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&readscan=1&old_namedpath=' + att.namedpath + '&old_name=' + att.name+ '&old_uuid=' + att.uuid + '&sid=' + leapclient.getsid() + LEAP.wfrouter.getLid() + '&path=' + uploadpath;
		}
		
		var def = {	uploadurl	:	uploadurl,
			 		downloadUrl	:	downloadUrl,
			 		filecount	:	att.filecount,	
			 		title		:	title.replaceall(" ","").replaceall("/",""),
			 		readonly	:	readonly,	
			 		quality		:	quality,
			 		maxwidth	:	maxwidth,
			 		maxheight	:	maxheight,
			 		exCapParam	:	exCapParam,
			 		callback	:	LEAP.attlist.OnScanCompleted,
					callbackParam:	{scantype:"scanread", scanreadrow:row},
					domain		:this};
					
		LEAP.Comb.scanner.scanread(def);
				
		LEAP.showMask();
		LEAP.asyn(LEAP.hideMask, this, 5000);
		
	}
	finally
	{
		att = element = scanParams = captureParams = quality = maxwidth = maxheight = uploadpath = 
		sid = readonly = title = uploadurl = exCapParam = downloadUrl = uploadurl = def = null;
	}
}

LEAP.attlist.OnScanCompleted = function(arg)
{
	try
	{
		if (arg == null || arg.value != 1)
			return;
			
		var type = arg.param.scantype;
		
		if (arg.result != null && arg.result != '')
		{
			if (type == "scanread")
			{	
				var uri = JSON.parse(arg.result);
					uri.filecount = arg.count;
					
				var row = arg.param.scanreadrow;	
				var old = row[LEAP.attlist.n];
				
				uri.atttype = old.atttype;
				
				LEAP.attlist.onScanReadComplete(row, uri);
			}
			else if (type == "scan")
			{
				var src = arg.param.scansrc;
				var element = LEAP._match(src, LEAP.attlist.d);
				
				var uri = JSON.parse(arg.result);
					uri.filecount = arg.count;
				
				uri.title = "新扫描件";
				uri.showName = "新扫描件";
				uri.atttype = LEAP.attlist.symbol.SM;
				
				if ((!uri.name.endWith('.zip')) && (!uri.name.endWith('.pdf')))
					uri.atttype = LEAP.attlist.symbol.FJ;
					
				LEAP.attlist.onUploadComplete_inner(element, uri, null, uri.atttype, null, src);
			}
			else if (type == "batchscan")
			{
				var uri = JSON.parse(arg.result);
					uri.filecount = arg.count;
					
				//var fileGroup = JSON.parse(filegroup);
				var fileGroup = eval(arg.filegroup);
				
				var src = arg.param.scansrc;
				var element = LEAP._match(src, LEAP.attlist.d);
				
				LEAP.attlist.onBatchScanComplete(element, uri, fileGroup);					
			}
		}

	}
	finally
	{
		LEAP.hideMask();		
		type = uri = row = old = src = element = fileGroup = null;
	}
}

LEAP.attlist.onScanReadComplete = function(row, result)
{
	try
	{
		var _att = row[LEAP.attlist.n];
			//_att.title = result.title; 
			_att.name = result.name;
			_att.uuid = result.uuid;
			_att.namedpath = result.nameedPath;
			if (_att.updateType != 0)
				_att.updateType = 1;
				
			//_att.ownername = LEAP.getUserInfo().fullName;
			_att.filecount = result.filecount;
			_att.attsize = result.size;
			//_att.uploadtime = {time:Date.parse(new Date())};
		row[LEAP.attlist.n] = _att;
	}
	finally
	{
		_att = null;
	}
}

LEAP.attlist.onBatchScanComplete = function(element, uri, fileGroup)
{
	try
	{
		var fixitemsdef = element['_fixitemsdef'];
		
		for(var i=0; i<fileGroup.length; i++)
		{
			var group = fileGroup[i];
			if (group.count > 0)
			{
				var _uri = LEAP.clone(uri);
				//_uri.name = group.uuid + ".zip";
				_uri.name = group.uuid + ".pdf";
				_uri.size = group.size;
				_uri.filecount = group.count;
				
				_uri.atttype = LEAP.attlist.symbol.SM;
				//_uri.path = uri.path.replace(uri.name, _uri.name);				
				_uri.updateType = 0;
				_uri.title = "新扫描件";
				_uri.showName = "新扫描件";
				
				var code = fixitemsdef.items[group.code].fixitemcode;
				
				var row = null;
				
				var rows = LEAP.getElements('tr[rt=' + LEAP.attlist.rt.fixrow + ']', element);
				for(var k=0; k<rows.length; k++)
				{
					var _row = rows[k];
					var _data = _row[LEAP.attlist.n];
					
					//if (_data.fixitemcode == group.code)
					if (_data.fixitemcode == code)
					{
						if (_data.namedpath != null || _data.exstatus != null)
						{
							if (_data.updateType != 0)
								_uri.updateType = 1;
						}
						
						row = _row;
						
						break;
					}
				}
				
				LEAP.attlist.onUploadComplete_inner(element, _uri, null, _uri.atttype, null, row);			
			}		
		}		
	}
	finally
	{
		i = group = _uri = row = rows = k = _row = _data = null;
	}
}

LEAP.attlist.onBatchScanComplete____ = function(element, uri, fileGroup)
{
	try
	{
		for(var i=0; i<fileGroup.length; i++)
		{
			var group = fileGroup[i];
			if (group.count > 0)
			{
				var _uri = LEAP.clone(uri);				
				//_uri.name = group.uuid + ".zip";
				_uri.name = group.uuid + ".pdf";
				_uri.size = group.size;
				_uri.filecount = group.count;
				
				_uri.atttype = LEAP.attlist.symbol.SM;
				//_uri.path = uri.path.replace(uri.name, _uri.name);
				_uri.nameedPath = uri.nameedPath + '/' + uri.name.substring(0, uri.name.length - 4);
				_uri.updateType = 0;
				_uri.title = "新扫描件";
				_uri.showName = "新扫描件";
				
				
				var row = null;
				
				var rows = LEAP.getElements('tr[rt=' + LEAP.attlist.rt.fixrow + ']', element);
				for(var k=0; k<rows.length; k++)
				{
					var _row = rows[k];
					var _data = _row[LEAP.attlist.n];
					
					if (_data.fixitemcode == group.code)
					{
						if (_data.namedpath != null || _data.exstatus != null)
						{
							if (_data.updateType != 0)
								_uri.updateType = 1;
						}
						
						row = _row;
						
						break;
					}
				}
				
				LEAP.attlist.onUploadComplete_inner(element, _uri, null, _uri.atttype, null, row);			
			}		
		}		
	}
	finally
	{
		i = group = _uri = row = rows = k = _row = _data = null;
	}
}

LEAP.attlist.onUploadComplete = function(e, data, err, par, operationSN, upLoadElement)
{
	var arr = null;
	if (data instanceof Array)
			arr = data;
		else
			arr = [data];		
	
	if (par == LEAP.attlist.symbol.zw && arr.length == 1)
	{
		var result = arr[0];
		if(result.title.length > LEAP.attlist.filenamemaxlen){
			alert("文件名称【"+result.title+"】长度超过最长限制，请修改后重新上传");
			return;
		}
		var _att={};
			_att.atttype = par;
			_att.fileid = result.fileid;
			_att.title = result.title; 
			_att.name = result.name;
			_att.viewname = result.viewname;
			_att.uuid = result.uuid;
			_att.namedpath = result.nameedPath;
			_att.updateType = 0;
			_att.owner = LEAP.getUserInfo().userflag;
			_att.ownername = LEAP.getUserInfo().fullName;
			_att.filecount = result.filecount;
			_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
			_att.canDelete = true;
			_att.canEdit = true;
			_att.exstatus = result.exstatus;
			_att.attsize = result.size;
			_att.ownerorganname = LEAP.getUserInfo().orgCNName;
			_att.stepaliasname = (e['_currentStep']!=null)?e['_currentStep'].stepaliasname:"";
			
			if (par == -9 && upLoadElement.getAttribute("tabcode"))
				_att.tabcode = upLoadElement.getAttribute("tabcode");
			
				
		if (_att.atttype == LEAP.attlist.symbol.zw)
		{
			var n = _att.name.toLowerCase();
			if (n.endWith('pdf'))
				_att.atttype = LEAP.attlist.symbol.PDFZW;
			if (n.endWith('ofd'))
				_att.atttype = LEAP.attlist.symbol.OFDZW;
			else if (n.endWith('wps'))
				_att.atttype = LEAP.attlist.symbol.wps;
			else if (n.endWith('ceb') || n.endWith('cebx'))
				_att.atttype = LEAP.attlist.symbol.ceb;			
		}
				
		LEAP.attlist.__replaceOrInsert2(e, _att);
	}
	else
	{
		LEAP.attlist.onUploadComplete_inner(e, arr, err, par, operationSN, upLoadElement);
	}
}

LEAP.attlist.__replaceOrInsert2 = function(element, att)
{
	var flag = false;
	var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", element);
	if (rows != null)
	{
		for(var i=0; i<rows.length; i++)
		{
			var row = rows[i];
			var _d = row[LEAP.attlist.n];		
			if (_d && (_d.atttype == att.atttype || (parseInt(_d.atttype)+parseInt(att.atttype)==-17)) && (!_d.tabcode || (_d.tabcode==att.tabcode)) )
			{
				var module = LWFP.innerApi.getmodule(element);
				var singleZW = false;
				if(module && module.WFSingleZW){
					singleZW = true;
				}				
				var WFReplaceSingleZW = true;
				if(module && module.WFReplaceSingleZW == false){
					WFReplaceSingleZW = false;
				}
				
				if(WFReplaceSingleZW)
				{
					if (window.confirm("已经存在同类型正文，是否要替代已有正文？"))
					{
						var oldtitle = _d.title;
						_d.fileid = att.fileid;
						_d.title = att.title;
						_d.name =	att.name;			
						_d.namedpath = att.namedpath;			
						_d.ownername = att.ownername;			
						_d.uploadtime = att.uploadtime;
						_d.canDelete = att.canDelete;
						_d.canEdit = att.canEdit;
			
						if (_d.updateType == 0)
							_d.updateType = 0;
						else
							_d.updateType = 1;
						
						if (element['BeforeBindingData'])
							_d = element['BeforeBindingData'](element, _d);
							
						row[LEAP.attlist.n] = _d;
						
						var _a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  row);
						var _h = _a.innerHTML.replace(oldtitle, _d.title);
						_a.innerHTML = _h;
						
						flag = true;
						
						var wordbtn = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnword + "]", element);
						if(wordbtn)
							wordbtn.removeAttribute("showtip");
					}
					else
					{
						if(singleZW == true)
						{
							var wordbtn = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnword + "]", element);
							if(wordbtn)
								wordbtn.setAttribute("showtip", "2");
							flag = true;
						}
							
					}
				}
				
				break;
			}
		}
	}
	
	if (flag == false)
	{
		var _row = LEAP.attlist.insert(element, att, null);
		
		LEAP.attlist._handleListChange(element);		
		LEAP.attlist._handleRowDataChange(element, {key:"insert", row:_row, data:att});
	}
	
}


LEAP.attlist.onUploadComplete_inner = function(e, data, err, par, operationSN, upLoadElement)
{
	try
	{
		var arr = null;
		if (data instanceof Array)
			arr = data;
		else
			arr = [data];		
		
		for(var i=0; i<arr.length; i++)
		{
			var result = arr[i];
			if(result.title.length > LEAP.attlist.filenamemaxlen){
				alert("文件名称【"+result.title+"】长度超过最长限制，请修改后重新上传");
				continue;
			}	
			var _att={};
				_att.id = UUID.randomUUID().replaceall('-', '');
				_att.atttype = par;
				_att.fileid = result.fileid;
				_att.title = result.title; 
				_att.name = result.name;
				_att.viewname = result.viewname;
				_att.uuid = result.uuid;
				_att.namedpath = result.nameedPath;
				_att.updateType = 0;
				_att.owner = LEAP.getUserInfo().userflag;
				_att.ownername = LEAP.getUserInfo().fullName;
				_att.filecount = result.filecount;
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
				_att.exstatus = result.exstatus;
				_att.attsize = result.size;
				_att.ownerorganname = LEAP.getUserInfo().orgCNName;
				_att.stepaliasname = (e['_currentStep']!=null)?e['_currentStep'].stepaliasname:"";
				
				if (e.getAttribute("_fixgroupid"))
					_att.fixgroupid = e.getAttribute("_fixgroupid") 
				
				if (_att.atttype == LEAP.attlist.symbol.zw)
				{
					var n = _att.name.toLowerCase();
					if (n.endWith('pdf'))
						_att.atttype = LEAP.attlist.symbol.PDFZW;
					if (n.endWith('ofd'))
						_att.atttype = LEAP.attlist.symbol.OFDZW;
					else if (n.endWith('wps'))
						_att.atttype = LEAP.attlist.symbol.wps;
					else if (n.endWith('ceb') || n.endWith('cebx'))
						_att.atttype = LEAP.attlist.symbol.ceb;			
				}
					
			var _row = LEAP.attlist.insert(e, _att, upLoadElement);

			LEAP.attlist._handleRowDataChange(e, {key:"insert", row:_row, data:_att});
		}
		
		LEAP.attlist._handleListChange(e);
	}
	finally
	{
		arr = i = result = _att = n = null; 
	}
}


//引用：leap.trans
LEAP.attlist._open = function(element, row, download, open, src, exParam)
{	
	try
	{
		//cjx 流程附件下载前回调自定义方法 WFBeforeLoad	          
		if(element && download){
	    	var module = LEAP.trans.__getmodule(element);
	    	if(module && module.WFBeforeLoad){
	    		module.WFBeforeLoad(row);
	    	}
	    }		
		var att = row[LEAP.attlist.n];
		if (!att || !att.namedpath)
			return;
			
		if (element.getAttribute("readonly") == "true")
			att.canEdit = false;
				
		var isPic = false;
		var _ex = /\.[^\.]+/.exec(att.name);					
		if (_ex && (_ex[0] == '.png' || _ex[0] == '.jpg' || _ex[0] == '.jpeg' || _ex[0] == '.gif'))
			isPic = true;
		var ifOffice = false;
		var ifPDF = false;
		var ifOFD = false;
		
		var wpsAddon = {ifwps:false, type:null};
		if (_ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.wps'))
			wpsAddon = {ifwps:true, type:"wps"};
		else if (_ex && (_ex[0] == '.xls' || _ex[0] == '.xlsx' || _ex[0] == '.et'))
			wpsAddon = {ifwps:true, type:"et"};
		else if (_ex && (_ex[0] == '.ppt' || _ex[0] == '.pptx' || _ex[0] == '.dps'))
			wpsAddon = {ifwps:true, type:"wpp"};
		
		if (_ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.et' || _ex[0] == '.xls' || _ex[0] == '.xlsx' ||  _ex[0] == '.ppt' || _ex[0] == '.pptx' || _ex[0] == '.dps') || _ex[0] == '.wps')
			ifOffice = true;
		if(_ex && _ex[0] == '.pdf')
			ifPDF = true;
		if(_ex && _ex[0] == '.ofd')
			ifOFD = true;
			
		if (LEAP.attlist.open_document_pdf_limit_size >0 && att.attsize>LEAP.attlist.open_document_pdf_limit_size && _ex && _ex[0] == '.pdf' )
			open = false;
		
		if (LEAP.attlist.open_document_doc_limit_size >0 && att.attsize>LEAP.attlist.open_document_doc_limit_size 
			&& _ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.wps') )
			open = false;
		
		if (LEAP.attlist.open_document_xls_limit_size >0 && att.attsize>LEAP.attlist.open_document_xls_limit_size 
			&& _ex && (_ex[0] == '.xls' || _ex[0] == '.xlsx' || _ex[0] == '.et') )
			open = false;	
		
		if (LEAP.attlist.open_document_ppt_limit_size >0 && att.attsize>LEAP.attlist.open_document_ppt_limit_size 
			&& _ex && (_ex[0] == '.ppt' || _ex[0] == '.pptx') )
			open = false;
		
		
		var b = false;
				
		if (isPic == true && download != true)
		{
			LEAP.attlist._preview(row);
			return;
		}
		else if (download != true && (att.atttype == LEAP.attlist.symbol.SM || att.atttype == LEAP.attlist.symbol.scan))
		{
			if (ifPDF == true && LEAP.isIE == true)
			{
				LEAP.attlist._ScanRead(row);
				return;
			}
		}
		else if (att.atttype < 0 && open == true) //(att.atttype == LEAP.attlist.symbol.zw)
		{
			var singlepdfzw = element.getAttribute("singlepdfzw");
			if ( singlepdfzw == true || singlepdfzw == "true" ||singlepdfzw=="1" )
			{
				var zw = LEAP.attlist._checkHasZW(element);
				if(zw[1] == true)
				{					
					att._hasPDFZW = true;
					att._singlepdfzw = true;
				}
			}
			
			if (  ( ( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == "wpsAddon")
						|| ( (LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == "wpsAddon")
					)
					&& wpsAddon.ifwps == true && LEAP.WPSAddon && LEAP.WPSAddon.AddonEnable[wpsAddon.type] == true)
			{
				LEAP.attlist._open_document_wpsAddon(element, row, att, wpsAddon.type, exParam);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用协议拉起
				LEAP.attlist._openOfd_urlProtocol(element, att);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用jsapi拉起
				LEAP.attlist._openOfd_JsAPI(element, att);
				return;
			}else if (ifPDF == true && ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "tgeqbreaderUrlProtocol")
						|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "tgeqbreaderUrlProtocol")) )
			{
				//天谷E签宝阅读器
				LEAP.attlist._openPDF_TgeqbProtocol(element, att);
				return;
			}
			else if (ifPDF == true && ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "browserPlugin")
						|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux  == "browserPlugin")) )
			{
				//不处理，走window.open
			}
			else
			{
				var b = false;
				if(ifOffice == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.word,false);
				if(ifPDF == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.pdf,false);
				if (ifOFD == true)
					b = true;
			
				if ( ( (LEAP.DocumentView.isWin == true) && 
							(LEAP.DocumentView.DocumentEditor_win == "wps" || LEAP.DocumentView.DocumentEditor_win == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_win == "JSPDF" || LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")	)
					||  ( (LEAP.DocumentView.isWin == false) && 
							(LEAP.DocumentView.DocumentEditor_linux == "wps" || LEAP.DocumentView.DocumentEditor_linux == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_linux == "JSPDF")	)
				){
					b = true;
				}
				
				if ( (( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == 'YozoEditor')
						|| ( (LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == 'YozoEditor') ) 
						&& _ex && (_ex[0] == '.doc' || _ex[0] == '.docx') )
				{
					b = true
				}
				
				if (b == true)
				{
					LWFP.windowOpen.open(1, LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/DocumentViewer/DocumentViewer.html", 
											LEAP.ctid(row),
											{att:att} );	
					return;
				}
			}
		}
		else if ( (ifOffice == true || ifPDF == true || ifOFD == true) && download == false && open == true)
		{
			if (  ( ( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == "wpsAddon")
						|| ((LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == "wpsAddon")
					)
					&& wpsAddon.ifwps == true && LEAP.WPSAddon && LEAP.WPSAddon.AddonEnable[wpsAddon.type] == true)
			{
				LEAP.attlist._open_document_wpsAddon(element, row, att, wpsAddon.type, exParam);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderUrlProtocol" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用协议拉起
				LEAP.attlist._openOfd_urlProtocol(element, att);
				return;
			}
			else if (ifOFD == true && LEAP.DocumentView.OfdDocumentEditor == "suwellreader" 
						&& ((LEAP.DocumentView.OfdOpenType_win == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == true)
							|| (LEAP.DocumentView.OfdOpenType_linux == "suwellreaderJsAPI" && LEAP.DocumentView.isWin == false)) )
			{//数科阅读器，并且用jsapi拉起
				LEAP.attlist._openOfd_JsAPI(element, att);
				return;
			}else if (ifPDF == true && ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "tgeqbreaderUrlProtocol")
						|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "tgeqbreaderUrlProtocol")) )
			{
				////天谷E签宝阅读器
				LEAP.attlist._openPDF_TgeqbProtocol(element, att);
				return;
			}
			else if (ifPDF == true && ((LEAP.DocumentView.isWin == true && LEAP.DocumentView.PdfDocumentEditor_win == "browserPlugin")
						|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.PdfDocumentEditor_linux == "browserPlugin")) )
			{
				//不处理，走window.open
			}
			else
			{				
				var b = false;
				if(ifOffice == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.word,false);
				if(ifPDF == true)
					b = LWFP.Activex.ActivexDetect(LWFP.Activex.ActivexType.pdf,false);
				if (ifOFD == true)
					b = true;
									
				if ( ( (LEAP.DocumentView.isWin == true) && 
							(LEAP.DocumentView.DocumentEditor_win == "wps" || LEAP.DocumentView.DocumentEditor_win == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_win == "JSPDF" || LEAP.DocumentView.PdfDocumentEditor_win == "IWebPdf2018")	)
					||  ( (LEAP.DocumentView.isWin == false) && 
							(LEAP.DocumentView.DocumentEditor_linux == "wps" || LEAP.DocumentView.DocumentEditor_linux == "IWebOffice" 
											|| LEAP.DocumentView.PdfDocumentEditor_linux == "JSPDF")	)
				){
					b = true;
				}
					
					
				if ( (( (LEAP.DocumentView.isWin == true) && LEAP.DocumentView.DocumentEditor_win == 'YozoEditor')
						|| ( (LEAP.DocumentView.isWin == false) && LEAP.DocumentView.DocumentEditor_linux == 'YozoEditor') ) 
					&& _ex && (_ex[0] == '.doc' || _ex[0] == '.docx' || _ex[0] == '.xls' || _ex[0] == '.xlsx' ||  _ex[0] == '.ppt' || _ex[0] == '.pptx') 
				){
					b = true
				}
				
				
				if (b == true)
				{
					LWFP.windowOpen.open(1, LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/DocumentViewer/DocumentViewer.html", 
									LEAP.ctid(row),
									{att:att} );
					
					return;
				}				
			}
		}
		
		
		//以上都不满足则交给LEAP下载打开
		att.nameedPath = att.namedpath;
		var p = null;
		if (att.entryid != null && att.id != null)
		{
			p = "sid=" + leapclient.getsid() + "&entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id;
			if (att.title != null && att.name!= null)
			{
				var t = att.title; 
				if (t.length > 20)
					t = t.substring(0, 20) + "...";
				p += "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
			}
			
			if (src)
			{
				if (src.getAttribute("watermark") == "0")
				{}
				else
				{
					p = p + "&watermark=1";
				}
			}
		}
		
		//LEAP.upload.download(att, true, false,  p);	
		LEAP.upload._download(att, open, p, LEAP.wfrouter.getRouter(element));
	
	}
	catch(e)
	{
	}
	finally
	{
		att = isPic = _ex = ifOffice = ifPDF = b = p = null;
	}	
}

LEAP.attlist.setWordParams = function(instance, moduleElement, param)
{//{wordButton: wordButton, templateValues:templateValues}
	try
	{	
		var elements = LEAP.getElements("div[ct=" + LEAP.attlist.d + "][instance=" + instance + "]", moduleElement);
		if (elements == null)
			return null;
		
		for(var i=0; i<elements.length; i++)
		{
			var ele = elements[i];
			ele[LEAP.attlist.sm.wordparam] = param; 
			
			//正文文件类型
			var _type = LEAP.attlist._getZWUploadTypes(ele);
			
			var wordbtn = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnword + "]", ele);
			if (wordbtn)
			{
				LEAP.uploadbtn.setUploadAttr(wordbtn, "types", _type[0]);
				LEAP.uploadbtn.setUploadAttr(wordbtn, "typesdesc", _type[1]);
				
				if (LEAP.fileupload && LEAP.fileupload.setAccept)
					LEAP.fileupload.setAccept(wordbtn, _type[0]);
			}
			
		}
		
	}
	finally
	{
		elements = i = ele = _type = wordbtn = null; 
	}
}

LEAP.attlist.WindowOpen_getParam = function(arg)
{
	try
	{
		var key = arg.key;
		var cache = LWFP.windowOpen.cache.getvalue(key);
		
		if (arg.paramName == "attachment")
		{
			return cache.param.att;
		}
		else if (arg.paramName == "wordparam")
		{
			var ctid = key;
			var row = LEAP.getElement("[ctid=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attlist.d);
			if(element){
				return element[LEAP.attlist.sm.wordparam];
			}
			return "";
		}
	}
	finally
	{
		key = cache = ctid = row = element = null;
	}
}

LEAP.attlist.WindowOpen_callback = function(arg)
{
	try
	{
		if (arg.pdfatt)
		{
			var ctid = arg.key;
			var row = LEAP.getElement("[ctid=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attlist.d);
			
			var singlepdfzw = element.getAttribute("singlepdfzw");
			if ( singlepdfzw == true || singlepdfzw=="1" )
			{
				var zw = LEAP.attlist._checkHasZW(element);
				if(zw[1] == true)
				{
					var row = LEAP.attlist._getRow(element,LEAP.attachment.symbol.PDFZW);
					LEAP.attlist._del(element, row, true);
				}
			}
						
			var _att={};
				_att.atttype = LEAP.attachment.symbol.PDFZW;
				_att.fileid = arg.pdfatt.fileid; 
				_att.title = arg.pdfatt.title; 
				_att.attsize = arg.pdfatt.attsize; 
				_att.name = encodeURIComponent(arg.pdfatt.name);									
				_att.namedpath = arg.pdfatt.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;					
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
				
			
			//var tr = LEAP.attlist.insert(element, _att, null);
			LEAP.attlist.__replaceOrInsert(element, _att);
			
		}
		else if (arg.ofdatt)
		{
			var ctid = arg.key;
			var row = LEAP.getElement("[ctid=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attlist.d);
			
			var singlepdfzw = element.getAttribute("singlepdfzw");
			if ( singlepdfzw == true || singlepdfzw=="1" )
			{
				var zw = LEAP.attlist._checkHasZW(element);
				if(zw[1] == true)
				{
					var row = LEAP.attlist._getRow(element,LEAP.attachment.symbol.OFDZW);
					LEAP.attlist._del(element, row, true);
				}
			}
						
			var _att={};
				_att.atttype = LEAP.attachment.symbol.OFDZW;
				_att.fileid = arg.ofdatt.fileid; 
				_att.title = arg.ofdatt.title; 
				_att.attsize = arg.ofdatt.attsize; 
				_att.name = encodeURIComponent(arg.ofdatt.name);									
				_att.namedpath = arg.ofdatt.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;					
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
			
			//var tr = LEAP.attlist.insert(element, _att, null);
			LEAP.attlist.__replaceOrInsert(element, _att);			
		}
		else if (arg.draftatt)
		{
			var ctid = arg.key;
			var row = LEAP.getElement("[ctid=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attlist.d);
			
			var zw = LEAP.attlist._checkHasZW(element);
			if(zw[0] == true)
			{
				var row = LEAP.attlist._getRow(element,LEAP.attachment.symbol.zw);
				LEAP.attlist._del(element, row, true);
			}
									
			var _att={};
				_att.atttype = LEAP.attachment.symbol.zw;
				_att.fileid = arg.draftatt.fileid;
				_att.attsize = arg.draftatt.attsize; 
				_att.title = arg.draftatt.title; 
				_att.name = arg.draftatt.name;									
				_att.namedpath = arg.draftatt.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;					
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
			LEAP.attlist.__replaceOrInsert(element, _att, ctid);
		}
		else if (arg.action == "onWordEditorSave" && arg.att)
		{//可能修改了文件名
			var ctid = arg.key;
			var row = LEAP.getElement("[ctid=" + ctid + "]");	
			
			if (row)
			{
				var _att = row[LEAP.attlist.n];
				
				if (_att.updateType == null)
					_att.updateType = 1;					
				_att.title = arg.att.title;
			
				row[LEAP.attlist.n] = _att;
				
				var _title = _att.title;					
				var _ex = /\.[^\.]+/.exec(_att.name);
				if (_ex)
					_title = _title + _ex[0];
				
				var _a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]",  row);
				if (_a)		//_a.innerText = _title;
				{	
					var _txt = _att.title + (/\.[^\.]+/.exec(_att.name));
					_a.title = _txt;
					if (_att.atttype <0)
					{
						_txt = '<font ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【正文】</font>' + _att.title + (/\.[^\.]+/.exec(_att.name));						
						if (_att.atttype == LEAP.attlist.symbol.PDFZW)
							_txt = '<font  ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【PDF正文】</font>' + _att.title + (/\.[^\.]+/.exec(_att.name));
						else if (_att.atttype == LEAP.attlist.symbol.OFDZW)
							_txt = '<font  ctf="' + LEAP.attlist.ctf.downhref + '" color=red>【OFD正文】</font>' + _att.title + (/\.[^\.]+/.exec(_att.name));
					}
					
					_a.innerHTML = _txt;
				}
			}
		}
		
	}
	finally
	{
		ctid = row = element = _att = null;
	}
}


LEAP.attlist._draft = function(element, attTemplate, exParams)
{
	var ctid = null;
	var row = LEAP.attlist._getRow(element,LEAP.attachment.symbol.zw);
	if (row)
	{
		ctid = LEAP.ctid(row);
		if (window.confirm("检测到已经存在正文文件，重新拟稿将会替换原有文件，是否重新拟稿？") == false)
			return;
	}
	
	var att = LWFP.innerApi.clone(attTemplate);	
	if ( ( (LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wpsAddon") 
			|| (LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wpsAddon")) && LEAP.WPSAddon && LEAP.WPSAddon.AddonEnable[LEAP.WPSAddon.docType.wps] == true)
	{
		var module = LWFP.innerApi.getmodule(element);
		var server = 	LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element));
		var url = att.draftTemplateUrl;
		
		var wordParam = element[LEAP.attlist.sm.wordparam];
		var ctid = LEAP.ctid(element);
		var srcid = element.getAttribute("mdid");
		element.setAttribute(LEAP.attlist.ctf.sssid, srcid);

		var param = {docType: LEAP.WPSAddon.docType.wps,
						openType: (LEAP.DocumentView.wpsAddon_openFileType == 1 ? 1 : 0),
 						docId: ctid, 						
					    isnew: true,
					    readOnly: false,
					    isDraft: true,
					    atttype:	LEAP.attlist.symbol.zw,
					    fileTitle: att.title,
					    fileName: 	url,
					    name:		att.name,					    					    
					    converAlert: "版式文件转换成功，请回到系统页面查看",
					    waterMark: server + LEAP.getWaterMark(),
					    savePath: server + "logic/WFOffice_updateDoc?a=1" + ((wordParam && wordParam.curstep && wordParam.curstep.hsid)	? ("&attcategory=" + wordParam.curstep.hsid) : ""),
					    uploadPath: server + "logic/WFOffice_updateDoc2?uploadpath=default"+ ((wordParam && wordParam.curstep && wordParam.curstep.hsid)	? ("&attcategory=" + wordParam.curstep.hsid) : ""),
					    exparam:	{ctid: ctid, srcid: srcid},
					    domain:		module,
					    notifyFn: 	LEAP.attlist._open_document_wpsAddon_callback
					  };
		
		if (exParams && exParams.qrcode)
			param.qrcode = exParams.qrcode;
		
		if (module.wpsAddonCustomConfig){
			var customConfig = module.wpsAddonCustomConfig();
			if(customConfig){
				if(customConfig.customJs && customConfig.customButtons){
					param.customJs = customConfig.customJs;
					param.customButtons = customConfig.customButtons;
				}
			}
		}		
			
		if (wordParam)
		{
			param.buttons = wordParam.wordButton;
			
			var bookmarks = wordParam.templateValues;
			if (wordParam.templateValueFn)
				bookmarks = wordParam.templateValueFn.call(module);
				
			var templates = null;  //套红模板
			var fileTemplates = null; //正文模板
				
			if (wordParam.businessNo)
			{
				var temps = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:wordParam.businessNo}});
				if (temps != null && temps.result != null)
				{
					templates = [];
					for(var i=0; i<temps.result.length; i++)
					{
						var temp = temps.result[i];
						var _temp = {templatename:	temp.templatename,
										mode:		temp.mode,
										url:		server + "LEAP/Download/" + temp.path + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid()};
						templates.add(_temp);
					}
				}
				
				var fileTemps = module.request2({name:'lbcp_getZWTemplateForBusinessNo', par:{businessNo:wordParam.businessNo} });
				if (fileTemps != null && fileTemps.result != null)
				{
					fileTemplates = [];
					for(var i=0; i<fileTemps.result.length; i++)
					{
						var temp = fileTemps.result[i];
						var _temp = {templatename:	temp.templatename,
										url:		server + "LEAP/Download/" + temp.path + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid()};
						fileTemplates.add(_temp);
					}
				}
			}
			
			var tp = {templates: templates,  //套红模板清单
						bookmarks: bookmarks //书签
					};
			
			param.template = tp;
			param.fileTemplates = fileTemplates;
		}
					
  		LEAP.WPSAddon.OpenDocument(param);
	}
	else
	{
		LWFP.windowOpen.open(1, LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/DocumentViewer/DocumentViewer.html", 
									LEAP.ctid(element),
									{att:att} );
	}	
}






LEAP.attlist._open_document_comb = function(element, row, att)
{
	try
	{	
		var uploadpath = element.getAttribute('uploadpath') ? element.getAttribute('uploadpath') : "default"; 
		var wfparam = {businessid:null, currentstepHSID:null, wordbuttons:"", templates:null };	
		var callbackParam = {rowCtid: LEAP.ctid(row)};
						
		var wordParam = element[LEAP.attlist.sm.wordparam];
		if (wordParam)
		{
			wfparam.wordbuttons = wordParam.wordButton;
			wfparam.businessid = (wordParam.exParam2)?wordParam.exParam2.businessid:null;
			wfparam.bookmarks = wordParam.templateValues;
					
			if (wordParam.businessNo)
			{
				var module = LWFP.innerApi.getmodule(element);
				//var templates = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:'0145edab564df552648f3d6db16f54a1'}});
				var templates = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:wordParam.businessNo}});
				if (templates)
					wfparam.templates = templates.result;	
			}		
		}
		
		LEAP.Comb.office.openDocument( {uploadpath:  'default',
											attachment:att, 
											wfparam: wfparam,
											callback: LEAP.attlist._open_document_comb_callback, 
											callbackParam: callbackParam,
											domain: this}	);
	}
	finally
	{
		uploadpath = wfparam = callbackParam = wordParam = null;
	}
}

LEAP.attlist._open_document_comb_callback = function(arg)
{
	try
	{
		if (arg && arg.value == 8)
		{//转pdf后返回
			if (arg.result)
			{
				var ctid = arg.callbackParam.rowCtid;
				var row = LEAP.getElement("[ctid=" + ctid + "]");	
				var element = LEAP._match(row, LEAP.attlist.d);
							
				var _att={};
					_att.id = UUID.randomUUID().replaceall('-', '');
					_att.atttype = LEAP.attachment.symbol.PDFZW;
					_att.fileid = arg.result.fileid; 
					_att.attsize = arg.result.attsize; 
					_att.title = arg.result.title; 
					_att.name = arg.result.name;									
					_att.namedpath = arg.result.namedpath;
					_att.updateType = 0;
					_att.ownername = LEAP.getUserInfo().fullName;					
					_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
					_att.canDelete = true;
					_att.canEdit = true;
				
				var tr = LEAP.attlist.insert(element, _att, null);
				
				LEAP.attlist._open(element, tr, false, true);
			}
		}	
	}
	finally
	{
		ctid = row = element = _att= tr = null;
	}
}

LEAP.attlist._open_document_wpsAddon = function(element, row, att, wpsDocType, exParam)
{
	try
	{
		var module = LWFP.innerApi.getmodule(element);
		var server = 	LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element));
		var url = LEAP.attlist._getPath(att, element);
		
		var saveAsNoneWatermark = false;
		if (module.saveAsNoneWatermark)
		{
			saveAsNoneWatermark = module.saveAsNoneWatermark(att); 
		}
		if (saveAsNoneWatermark == null)
			saveAsNoneWatermark = false;
		
		var p = "sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();		
		if (att.entryid != null && att.id != null)
		{
			p += "&entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id;
			if (att.title != null && att.name != null)
			{
				var t = att.title; 
				if (t.length > 50)
					t = t.substring(0, 50) + "...";
				p += "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
			}
		}
		
		if (url.indexOf('?') == -1)	
			url += "?" + p;
		else
			url += "&" + p;
		
		var wordParam = element[LEAP.attlist.sm.wordparam];
		var savepath = server + "logic/WFOffice_updateDoc?lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() + "&namedpath=" + encodeURIComponent(att.namedpath) + "&name=" + encodeURIComponent(att.name) + ((att.fileid==null) ? "" : "&fileid=" + att.fileid);
		if (att.id)
			savepath += "&attid=" + att.id;
		if (att.entryid)
			savepath += "&attentryid=" + att.entryid;	
		if (wordParam && wordParam.exParam2 && wordParam.exParam2.businessid)
			savepath += "&attbusinessid=" + wordParam.exParam2.businessid;
		if (wordParam && wordParam.curstep && wordParam.curstep.hsid)	
			savepath += "&attcategory=" + wordParam.curstep.hsid;
		
				
		var ctid = LEAP.ctid(row);
		var srcid = row.getAttribute(LEAP.attlist.ctf.sssid);
		if (srcid == null)
			srcid = element.getAttribute("mdid");
		var param = {docType: wpsDocType,
						openType: (LEAP.DocumentView.wpsAddon_openFileType == 0 ? 0 : 1),
 						docId: ((att.id) ? att.id : ctid),
					    isnew: false,
					    readOnly: !att.canEdit,
					    atttype:	att.atttype,
					    fileTitle: att.title,
					    fileName: 	url,
					    name:		att.name,					    					    
					    converAlert: "版式文件转换成功，请回到系统页面查看",
					    waterMark: server + LEAP.getWaterMark(),
					    saveAsNoneWatermark: saveAsNoneWatermark,
					    savePath: savepath, //server + "logic/WFOffice_updateDoc?namedpath=" + encodeURIComponent(att.namedpath) + "&name=" + att.name + ((att.fileid==null) ? "" : "&fileid=" + att.fileid),
					    uploadPath: server + "logic/WFOffice_updateDoc2?uploadpath=default",
					    exparam:	{ctid: ctid, srcid:srcid},
					    domain:		module,
					    notifyFn: 	LEAP.attlist._open_document_wpsAddon_callback
					  };
					  
		if (exParam && exParam.qrcode)
			param.qrcode = exParam.qrcode;

		if (module.wpsAddonCustomConfig){
			var customConfig = module.wpsAddonCustomConfig();
			if(customConfig){
				if(customConfig.customJs && customConfig.customButtons){
					param.customJs = customConfig.customJs;
					param.customButtons = customConfig.customButtons;
				}
			}
		}
		
		if(att.atttype == 0 && att.canEdit && element.getAttribute("att0buttons")){
			//支持附件转版式 设置按钮 插件属性 att0buttons 例如：ConvertPDF,ConvertOFD
			param.att0buttons = element.getAttribute("att0buttons");//附件转pdf 或者ofd
		}
		
		param.acceptRevisions = false;
		if (LEAP.attlist.attachment_acceptRevisions == true)
		{
			param.acceptRevisions = true;
		}
		
		if (wordParam)
		{
			param.buttons = wordParam.wordButton;
			
			var bookmarks = wordParam.templateValues;
			if (wordParam.templateValueFn)
				bookmarks = wordParam.templateValueFn.call(module);
				
			var templates = null;
			var fileTemplates = null; //正文模板	
			var historyfiles = null; //历史文件
			if (wordParam.businessNo)
			{
				var temps = module.request2({name:'lbcp_getTemplateForBusinessNo', par:{businessNo:wordParam.businessNo}});
				if (temps != null && temps.result != null)
				{
					templates = [];
					for(var i=0; i<temps.result.length; i++)
					{
						var temp = temps.result[i];
						var _temp = {templatename:	temp.templatename,
										mode:		temp.mode,
										url:		server + "LEAP/Download/" + temp.path + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() };
						templates.add(_temp);
					}
				}
				
				var fileTemps = module.request2({name:'lbcp_getZWTemplateForBusinessNo', par:{businessNo:wordParam.businessNo} });
				if (fileTemps != null && fileTemps.result != null)
				{
					fileTemplates = [];
					for(var i=0; i<fileTemps.result.length; i++)
					{
						var temp = fileTemps.result[i];
						var _temp = {templatename:	temp.templatename,
										url:		server + "LEAP/Download/" + temp.path + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid()	};
						fileTemplates.add(_temp);
					}
				}
			}
			//获取文件历史版本数据
			if(att.entryid && module.WFShowFileVersion && module.WFShowFileVersion == true){
				var historyfileTemps = module.request2({name:'WfGetAttachmentHistoryList', par:{entryid:att.entryid, archCategory:module.workflow.getData().archCategory}} );
				if (historyfileTemps != null && historyfileTemps.length>0)
				{
					historyfiles = [];
					for(var i=0; i<historyfileTemps.length; i++)
					{
						if(att.name == historyfileTemps[i].name){
							if(historyfileTemps[i].changes && historyfileTemps[i].changes.length>0){
								for (var m = 0; m < historyfileTemps[i].changes.length; m++) {
									historyfileTemps[i].changes[m].url = server + "LEAP/Download/" + historyfileTemps[i].changes[m].namedpath+"/"+ historyfileTemps[i].changes[m].name + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();
								}
								historyfiles = historyfileTemps[i].changes;
							}
							//historyfileTemps[i].url = server + "LEAP/Download/" + historyfileTemps[i].namedpath+"/"+ historyfileTemps[i].name + "?sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();
							//historyfileTemps[i].changes = null;
							//historyfiles.add(historyfileTemps[i]);
							break;
						}
					}
				}
			}
			
			var tp = {templates: templates,  //套红模板清单
						bookmarks: bookmarks //书签
					};
			
			param.template = tp;
			param.fileTemplates = fileTemplates;
			param.historyfiles = historyfiles;
		}
  					
  		LEAP.WPSAddon.OpenDocument(param);
	}
	finally
	{	
		module = server = 	url = p = t = wordParam = param = bookmarks = templates = temps = i=temp = _temp = tp = null;
	}	
}

LEAP.attlist._open_document_wpsAddon_callback = function(arg)
{
	try
	{
		var obj = arg;
		var atttype = null;
		if(obj.param){
			atttype = obj.param.atttype;
		}
		if (obj.action == "convertToPDF")
		{				
			var ctid = obj.param.exparam.srcid;
			var row = LEAP.getElement("[" + LEAP.attlist.ctf.sssid + "=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attlist.d);
			
			var _att={};
				_att.id = UUID.randomUUID().replaceall('-', '');
				if(atttype==0){
				_att.atttype = 0;
			}else{
				_att.atttype = LEAP.attachment.symbol.PDFZW;
			}
				//_att.atttype = LEAP.attachment.symbol.PDFZW;
			_att.fileid = obj.msg.fileid; 
			_att.attsize = obj.msg.attsize; 
			_att.title = obj.param.fileTitle; 
			_att.name =	obj.msg.name;					
			_att.namedpath = obj.msg.namedpath;
			_att.updateType = 0;
			_att.ownername = LEAP.getUserInfo().fullName;					
			_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
			_att.canDelete = true;
			_att.canEdit = true;
			
			LEAP.attlist.__replaceOrInsert(element, _att, null);
		}
		else if (obj.action == "convertToOFD")
		{
			var ctid = obj.param.exparam.srcid;
			var row = LEAP.getElement("[" + LEAP.attlist.ctf.sssid + "=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attlist.d);
			
			var _att={};
			if(atttype==0){
				_att.atttype = 0;
			}else{
				_att.atttype = LEAP.attachment.symbol.OFDZW;
			}
			//_att.atttype = LEAP.attachment.symbol.OFDZW //支持附件转版式文件
			_att.id = UUID.randomUUID().replaceall('-', '');
			_att.fileid = obj.msg.fileid; 
			_att.attsize = obj.msg.attsize; 
			_att.title = obj.param.fileTitle; 
			_att.name =	obj.msg.name;					
			_att.namedpath = obj.msg.namedpath;
			_att.updateType = 0;
			_att.ownername = LEAP.getUserInfo().fullName;					
			_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
			_att.canDelete = true;
			_att.canEdit = true;
			
			LEAP.attlist.__replaceOrInsert(element, _att, null);
		}
		else if (obj.action == "draft")
		{
			var ctid = obj.param.exparam.srcid;
			var row = LEAP.getElement("[" + LEAP.attlist.ctf.sssid + "=" + ctid + "]");	
			var element = LEAP._match(row, LEAP.attlist.d);
			
			var zw = LEAP.attlist._checkHasZW(element);
			if(zw[0] == true)
			{
				var row = LEAP.attlist._getRow(element,LEAP.attachment.symbol.zw);
				LEAP.attlist._del(element, row, true);
			}
									
			var _att={};
				_att.id = UUID.randomUUID().replaceall('-', '');
				_att.atttype = LEAP.attachment.symbol.zw;
				_att.fileid = obj.msg.fileid; 
				_att.attsize = obj.msg.attsize; 
				_att.title = (obj.param && obj.param.fileTitle) ? obj.param.fileTitle : "新建正文"; 
				_att.name = obj.msg.name;									
				_att.namedpath = obj.msg.namedpath;
				_att.updateType = 0;
				_att.ownername = LEAP.getUserInfo().fullName;					
				_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
				_att.canDelete = true;
				_att.canEdit = true;
			LEAP.attlist.__replaceOrInsert(element, _att, ctid);		
		}
		
		
	}
	catch(e)
	{}
	finally
	{
	}
}

LEAP.attlist.__replaceOrInsert = function(element, att, ctid)
{
	var flag = false;
	var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", element);
	if (rows != null)
	{
		var _ex1 = /\.[^\.]+/.exec(att.name.toLowerCase());
		for(var i=0; i<rows.length; i++)
		{
			var row = rows[i];
			var _d = row[LEAP.attlist.n];		
			//获取文件后缀	
			var _ex2 = /\.[^\.]+/.exec(_d.name.toLowerCase());		
			if (_d && _d.title == att.title && _d.atttype == att.atttype && _ex1[0]==_ex2[0])
			{
				_d.fileid = att.fileid;
				_d.title = att.title;
				_d.name =	att.name;			
				_d.namedpath = att.namedpath;			
				_d.ownername = att.ownername;			
				_d.uploadtime = att.uploadtime;
				_d.canDelete = att.canDelete;
				_d.canEdit = att.canEdit;
	
				if (_d.updateType == 0)
					_d.updateType = 0;
				else
					_d.updateType = 1;
					
				row[LEAP.attlist.n] = _d;	
				if (ctid != null)
					row.setAttribute("ctid", ctid);
							
				flag = true;
				break;
			}
		}
	}
	
	if (flag == false)
	{
		var _row = LEAP.attlist.insert(element, att, null);
		if (ctid != null)
			_row.setAttribute("ctid", ctid);
			
		LEAP.attlist._handleListChange(element);		
		LEAP.attlist._handleRowDataChange(element, {key:"insert", row:_row, data:att});
	}
	
	//if (ctid != null)
	//	element.removeAttribute("ctid");
	
}

LEAP.attlist._openOfd_JsAPI = function(element, att)
{
	var module = LWFP.innerApi.getmodule(element);
	var url = LEAP.upload.getPath(att.namedpath, att.name, att.uuid, null, null, null, null, att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
	if (url.indexOf('?') == -1)	
		url += "?lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() ;
	else
		url += "&lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
		
	if (att.entryid != null && att.id != null)
	{
		var p = "&entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id;
		if (att.title != null && att.name!= null)
		{
			var t = att.title; 
			if (t.length > 20)
				t = t.substring(0, 20) + "...";
			p += "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
		}
		url += p;
	}
	
	var saveurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'logic/WFOffice_updateDoc_ofd?' 
					+ 'namedpath=' + att.namedpath + '&name=' + att.name;
	if (att.fileid)
		saveurl += "&fileid=" + att.fileid;	
	if (att.id)
		saveurl += "&attid=" + att.id;
	if (att.entryid)
		saveurl += "&attentryid=" + att.entryid;
		
	if (element[LEAP.attlist.sm.wordparam] && element[LEAP.attlist.sm.wordparam].exParam2 && element[LEAP.attlist.sm.wordparam].exParam2.businessid)
		saveurl += "&attbusinessid=" + element[LEAP.attlist.sm.wordparam].exParam2.businessid;
	if (element[LEAP.attlist.sm.wordparam] && element[LEAP.attlist.sm.wordparam].curstep && element[LEAP.attlist.sm.wordparam].curstep.hsid)
		saveurl += "&attcategory=" + element[LEAP.attlist.sm.wordparam].curstep.hsid;
	
	
	var param = {open_url:url, save_url:saveurl, readOnly:!att.canEdit};
	if(module && module.WFSuwellAfterOpenTabNames &&  (module.WFSuwellAfterOpenTabNames instanceof Array)&& module.WFSuwellAfterOpenTabNames.length>0){
		param.openTabNames = module.WFSuwellAfterOpenTabNames;
	}else{
		if(LEAP.DocumentView.suwellAfterOpenTabNames && LEAP.DocumentView.suwellAfterOpenTabNames.length>0){//打开数科文档后默认打开的菜单栏目
			param.openTabNames = LEAP.DocumentView.suwellAfterOpenTabNames;
		}
	}		
	LEAP.OFD.OpenUrlFile(param);
	
}

/**
 * 天谷E签宝打开pdf
 * @param {} element
 * @param {} att
 */
LEAP.attlist._openPDF_TgeqbProtocol = function(element, att)
{
	var module = LWFP.innerApi.getmodule(element);
	var url = LEAP.upload.getPath(att.namedpath, att.name, att.uuid, null, null, null, null, att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
	if (url.indexOf('?') == -1)	
		url += "?lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();
	else
		url += "&lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid();	
		
	if (att.entryid != null && att.id != null)
	{
		var p = "&entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id;
		if (att.title != null && att.name!= null)
		{
			var t = att.title; 
			if (t.length > 20)
				t = t.substring(0, 20) + "...";
			p += "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
		}
		url += p;
	}
	
	var saveurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'logic/WFOffice_updateDoc_ofd?' 
					+ 'namedpath=' + att.namedpath + '&name=' + att.name;
	if (att.fileid)
		saveurl += "&fileid=" + att.fileid;	
	if (att.id)
		saveurl += "&attid=" + att.id;
	if (att.entryid)
		saveurl += "&attentryid=" + att.entryid;
		
	if (element[LEAP.attlist.sm.wordparam] && element[LEAP.attlist.sm.wordparam].exParam2 && element[LEAP.attlist.sm.wordparam].exParam2.businessid)
		saveurl += "&attbusinessid=" + element[LEAP.attlist.sm.wordparam].exParam2.businessid;
	if (element[LEAP.attlist.sm.wordparam] && element[LEAP.attlist.sm.wordparam].curstep && element[LEAP.attlist.sm.wordparam].curstep.hsid)
		saveurl += "&attcategory=" + element[LEAP.attlist.sm.wordparam].curstep.hsid;
		
	att.open_url = url;
	att.save_url = saveurl;
	att.readOnly = !att.canEdit;
	LWFP.windowOpen.open(1, LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/EQB/TgebqViewer.html", 
									LEAP.ctid(element),
									{att:att} );				
}



LEAP.attlist._openOfd_urlProtocol = function(element, att)
{
	var module = LWFP.innerApi.getmodule(element);
	var url = LEAP.upload.getPath(att.namedpath, att.name, att.uuid, null, null, null, null, att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
	if (url.indexOf('?') == -1)	
		url += "?lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() ;
	else
		url += "&lcors=1&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() ;	
		
	if (att.entryid != null && att.id != null)
	{
		var p = "&entryid=" + att.entryid + "&wflog=1&terminal=0&id=" + att.id;
		if (att.title != null && att.name!= null)
		{
			var t = att.title; 
			if (t.length > 20)
				t = t.substring(0, 20) + "...";
			p += "&remark=" + encodeURIComponent(encodeURIComponent(t + att.name.substring(att.name.lastIndexOf("."))));
		}
		url += p;
	}
	
	var saveurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + 'logic/WFOffice_updateDoc_ofd?' 
					+ 'namedpath=' + att.namedpath + '&name=' + att.name;
	if (att.fileid)
		saveurl += "&fileid=" + att.fileid;	
	if (att.id)
		saveurl += "&attid=" + att.id;
	if (att.entryid)
		saveurl += "&attentryid=" + att.entryid;
		
	if (element[LEAP.attlist.sm.wordparam] && element[LEAP.attlist.sm.wordparam].exParam2 && element[LEAP.attlist.sm.wordparam].exParam2.businessid)
		saveurl += "&attbusinessid=" + element[LEAP.attlist.sm.wordparam].exParam2.businessid;
	if (element[LEAP.attlist.sm.wordparam] && element[LEAP.attlist.sm.wordparam].curstep && element[LEAP.attlist.sm.wordparam].curstep.hsid)
		saveurl += "&attcategory=" + element[LEAP.attlist.sm.wordparam].curstep.hsid;
		
	var portocolUrl = "";
	if (att.canEdit == true)
	{
		portocolUrl = "suwellofd://" + url + "?saveurl=" + saveurl + "&comopisteinvisble=f_open";
	}
	else
	{
		portocolUrl = "suwellofd://" + url + "?saveurl=s?id=0&comopisteinvisble=f_save";
	}

	LEAP.attlist.frameRequest(portocolUrl);					
}


LEAP.attlist.frameRequest = function(requestUrl)
{
	try
	{
		var iframe = document.getElementById("____attlist_frameRequest___");
		if (!iframe)
		{		
			iframe = document.createElement('iframe');
			iframe.setAttribute("id", "____attlist_frameRequest___");
			iframe.style.position = "absolute";
			iframe.style.top = "0px";
			iframe.style.left = "0px";
			
			var f = true;
				
			if (f)
			{
				iframe.style.width = "1px";
				iframe.style.height = "1px";
				iframe.style.zIndex = -1;
			}
			
			document.body.appendChild(iframe);
		}
			    
	    iframe.src = requestUrl;	
	}
	finally
	{
		iframe = f = null;
	}
}


LEAP.attlist._getPath = function(_att, element)
{
	var module = LWFP.innerApi.getmodule(element);
	var url = null;
	if (_att.viewname != null)
		url = LEAP.upload.getPath(_att.namedpath, _att.name, _att.uuid, _att.viewname, _att.viewname, null, null, _att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
	else if (_att.name != null)
		url = LEAP.upload.getPath(_att.namedpath, _att.name, _att.uuid, null, null, null, null, _att.fileid, ((module && module.leapclient) ? module.leapclient.router:null));
	return url;
}

LEAP.attlist.validate = function(element, checkitems)
{
	try
	{		
		var flag = false;
		var msg = null;
		
		var type = element.getAttribute("listtype");
		if (type == 0)
		{
			var value = LEAP.attlist._getValue(element);
			if (value == null)
				flag = false;
			else
				flag = true;
		}
		else if (type == 1)
		{
			var value = LEAP.attlist._getValue(element);
						
			flag = true;
							
			var _def = element['_fixitemsdef'];
			if (_def != null && _def.items != null && _def.items.length>0)
			{	
				var _items = null;
				if (checkitems != null)
					_items = checkitems.trim().split(',');
				
				var h = new hashtable(); //必填项hash
				for(var k=0; k< _def.items.length; k++)
				{
					var tmp =  _def.items[k];						
					if (_items != null)	//如果api指定了检查项则用指定的检查项，否则使用固定项定义的检查项
					{
						if (_items.indexOf(tmp.code) >=0)
							h.add(tmp.code,  tmp.name);
					}
					else
					{
						if (tmp.nullable == false)
							h.add(tmp.code,  tmp.name);	
					}
				}
				
				if (h.count > 0)
				{	
					for(var _key in h.keys)
					{
						var code = h.getkey(_key);
						
						var _has = false;
						if (value != null)
						{
							for(var i=0; i<value.length; i++)
							{
								var att = value[i];
								if (att.fixitemcode == code && (att.namedpath != null || att.exstatus != null))
								{
									_has = true;
									break;
								}									
							}
						}
						
						if (_has == false)
						{	
							var _err = h.getvalue(code);				
							if (_err == null)
								_err = "必须上传附件！";
							else
								_err = '必须上传附件:' + _err + "！";
							
							//LEAP.messagebox.alert(_err, 2);
							msg = _err;
						
							flag = false;
							break;
						}
					}
				}
			}				
		}
		
		
		if (flag == false)
		{
			if (msg != null)
				return {msg:msg};
			else
				return null;
		}
		else
		{
			return true;
		}
	}
	finally
	{		
		flag = msg = type = value = value = _def = _items = h = k = tmp = _key = code = _has = i = att = _err = null;
	}	
}



LEAP.attlist._batchUpload = function(element)
{
	try
	{	
		var uploadpath = element.getAttribute('uploadpath') ? element.getAttribute('uploadpath') : "default"; 
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/Service/RPC/RPC.DO?type=3&rt=o&path=" + uploadpath + "&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid() ;	
		var filter = "";
		if (element.getAttribute("typesdesc") != null && element.getAttribute("types") != null)
			filter =  element.getAttribute("typesdesc") + "|" + element.getAttribute("types");
			
		var obj = {uploadurl: uploadurl,
										filter: filter,
										callback: LEAP.attlist.onBatchUploadComplete,
										callbackParam: {batchUploadElement:element},
										domain:	this,
										showMask: false}
		
		LEAP.Comb.upload.batchUpload(obj);	
		
	}
	finally
	{
		uploadpath = uploadurl = obj = null;
	}	
}

LEAP.attlist.onBatchUploadComplete = function(arg)
{
	try
	{
		if (arg == null || arg.value != 1)
			return;
			
		var result = JSON.parse("[" + arg.result + "]");
		
		var element = arg.param.batchUploadElement;		
		
		for(var i=0; i<result.length; i++)
			LEAP.attlist.onUploadComplete_inner(element, result[i], null, 0, null, null);		
			
		LEAP.messagebox.alert('上传成功，一共' + result.length + '个文件。');
	}
	finally
	{
		result = element = i = null;		
		LEAP.hideMask();
	}
}

LEAP.attlist._upload = function(element, src)
{
	try
	{					
		var uploadpath = element.getAttribute('uploadpath') ? element.getAttribute('uploadpath') : "default"; 
		var uploadurl = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/Service/RPC/RPC.DO?type=3&rt=o&path=" + uploadpath + "&sid=" + leapclient.getsid() + LEAP.wfrouter.getLid(); 	
		var filter = "";
		if (element.getAttribute("typesdesc") != null && element.getAttribute("types") != null)
			filter =  element.getAttribute("typesdesc") + "|" + element.getAttribute("types");
		var cmd = {uploadurl: uploadurl,
										filter: filter,
										callback:LEAP.attlist.OnUploadFileComplete,
										callbackParam:{uploadrow:src},
										domain:	this,
										showMask: false};
		LEAP.Comb.upload.singleUpload(cmd);
	}
	finally
	{
		uploadpath = uploadurl = cmd =  null;
	}
}

LEAP.attlist.OnUploadFileComplete = function(arg)
{
	try
	{
		if (arg == null || arg.value != 1)
		{
			return;
		}

		var result = JSON.parse(arg.result);		
		var src = arg.param.uploadrow;
		var e = LEAP._match(src, LEAP.attlist.d);
		
		LEAP.attlist.onUploadComplete_inner(e, result, null, LEAP.attlist.symbol.FJ, null, src);
		
	}
	finally
	{
		result = src = e = null;
	}
}

LEAP.attlist._DocView = function(element)
{
	try
	{			
		var _arr = LEAP.attlist._getValue(element);
		if (_arr == null)
		{
			LEAP.messagebox.alert('没有可预览文件！');
			return;
		}
		
		var _atts = [];
		for(var i=0; i< _arr.length; i++)
		{
			if (_arr[i].namedpath != null)
				_atts.add(_arr[i]);
		}
		
		if (_atts.length == 0)
		{
			LEAP.messagebox.alert('没有可预览文件！');
			return;			
		}
		
		LEAP.attlist.AttachmentView(_atts, false, element);
		
	}
	finally
	{
		_arr = _atts = i = null;
	}
}

/*
 * 预览附件文档
 atts:[{id:"唯一标识",
  		title:"显示标题",
		name:"文件名",
		namedpath:"命名空间",
		fixitemcode:"分组编号，相同分组的多个附件会显示在同一个目录下面"
		fixitemname:"分组名"		
		},...]
 cache:boolean本地是否缓存                    
 */
LEAP.attlist.AttachmentView = function(atts, cache, src)
{
	try
	{ 			
		var obj = {downloadUrl:	LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(src)) + "LEAP/Download/",
 					atts:		atts,
 					cache:		1 
 			};
 		LEAP.Comb.upload.previewDocument(obj); 		 		
 		
	}
	finally
	{
		obj = null;
	}
}

LEAP.attlist._batchDownload = function(element)
{
	try
	{			
		var module = LWFP.innerApi.getmodule(element);
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", element);
		if (rows == null)
			return null;
		
		var arr = [];
		var atts = LEAP.attlist.getCheckedAttachments(element);
		if (atts != null)
		{
			for(var i=0; i<atts.length; i++)
			{
				var _d = atts[i];
				
				if (_d && _d.namedpath != null)
				{			
					var url = LEAP.upload.getPath(_d.namedpath, _d.name, _d.uuid, _d.viewname, _d.title, null, null, _d.fileid, ((module.leapclient == null) ? null : module.leapclient.router));
					arr.add(url);
				}
			}
		}
		else
		{		
			for(var i=0; i<rows.length; i++)
			{	
				var _d = rows[i][LEAP.attlist.n];
				
				if (_d && _d.namedpath != null)
				{			
					var url = LEAP.upload.getPath(_d.namedpath, _d.name, _d.uuid, _d.viewname, _d.title, null, null, _d.fileid, ((module.leapclient == null) ? null : module.leapclient.router));
					arr.add(url);
				}
			}
		}
		
		if (arr.length == 0)
			return;
		
		LEAP.Comb.upload.download(arr);
	}
	finally
	{
		rows = arr = i = _d = url = null;
	}
}

LEAP.attlist._batchDownload2 = function(element)
{
	try
	{			
		var module = LWFP.innerApi.getmodule(element);
		var rows = LEAP.getElements("tr[ctf=" + LEAP.attlist.ctf.attrow + "]", element);
		if (rows == null)
			return null;

		var atts = LEAP.attlist.getCheckedAttachments(element);
		if (atts != null)
		{
			for(var i=0; i<atts.length; i++)
			{
				var _d = atts[i];
				
				if (_d && _d.namedpath != null)
				{			
					var url = LEAP.upload.getPath(_d.namedpath, _d.name, _d.uuid, _d.viewname, _d.title, null, null, _d.fileid, ((module.leapclient == null) ? null : module.leapclient.router));
					LEAP.attlist._batchDownload2_down(url, _d.title);
				}
			}
		}
		else
		{		
			for(var i=0; i<rows.length; i++)
			{	
				var _d = rows[i][LEAP.attlist.n];
				
				if (_d && _d.namedpath != null)
				{			
					var url = LEAP.upload.getPath(_d.namedpath, _d.name, _d.uuid, _d.viewname, _d.title, null, null, _d.fileid, ((module.leapclient == null) ? null : module.leapclient.router));
					LEAP.attlist._batchDownload2_down(url, _d.title);
				}
			}
		}
	}
	finally
	{
		rows = i = _d = url = null;
	}
}

LEAP.attlist._batchDownload2_down = function(url, name)
{
	var a = document.createElement("a"), //创建a标签
	e = document.createEvent("MouseEvents"); //创建鼠标事件对象
	e.initEvent("click", false, false); //初始化事件对象
	a.href = url; //设置下载地址
	a.download = name; //设置下载文件名
	a.dispatchEvent(e); //给指定的元素，执行事件click事件
	
	/*var iframe = document.createElement("iframe");
	iframe.src = url;
	document.body.appendChild(iframe);
	setTimeout(function(){iframe.remove();}, 5*60*1000);*/

}

LEAP.attlist._singleDownload = function(element, src)
{
	var module = LWFP.innerApi.getmodule(element);
	var row = LEAP._match(src, LEAP.attlist.ctf.attrow, 'ctf');
	if (row == null)
		return;
		
	var _d = row[LEAP.attlist.n];
	if (_d && _d.namedpath != null)
	{			
		var url = LEAP.upload.getPath(_d.namedpath, _d.name, _d.uuid, _d.viewname, _d.title, null, null, _d.fileid, ((module.leapclient == null) ? null : module.leapclient.router));
		LEAP.Comb.upload.download([url]);
	}
}

LEAP.attlist.move = function(element, row, type)
{
	try
	{
		var idx = row.rowIndex;					
		var table = LEAP.getElement("table[ctf=" + LEAP.attlist.ctf.atttable + "]", element);
				
		if (type == LEAP.attlist.ctf.btnMD && idx < table.rows.length-1 )
		{
			var rowU = table.rows[idx];
			var rowD = table.rows[idx + 1];
			
			rowU.parentNode.insertBefore(rowD, rowU);

			var tdU = LEAP.getElement("td[ctf=" + LEAP.attlist.ctf.cell_sn + "]", rowU);
			var tdD = LEAP.getElement("td[ctf=" + LEAP.attlist.ctf.cell_sn + "]", rowD);
			if (tdU != null && tdD != null)
			{
				var snU = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", tdU);
				if (snU == null)
					snU = tdU;
				var snD = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", tdD);
				if (snD == null)
					snD = tdD;
				
				var _s = snU.innerText;
				snU.innerText = snD.innerText;
				snD.innerText = _s;
			}
			
			rowU[LEAP.attlist.n].orderid = rowU.rowIndex;			
			if (rowU[LEAP.attlist.n].updateType != 0)
				rowU[LEAP.attlist.n].updateType = 1;
				
			rowD[LEAP.attlist.n].orderid = rowD.rowIndex;
			if (rowD[LEAP.attlist.n].updateType != 0)
			rowD[LEAP.attlist.n].updateType = 1;			
			
			LEAP.attlist._handleRowDataChange(element, {key:"update", row:rowU, data:rowU[LEAP.attlist.n]});
			LEAP.attlist._handleRowDataChange(element, {key:"update", row:rowU, data:rowD[LEAP.attlist.n]});
		}
		else if (type == LEAP.attlist.ctf.btnMU && idx >2)
		{
			var rowU = table.rows[idx - 1 ];
			var rowD = table.rows[idx];
			
			rowU.parentNode.insertBefore(rowD, rowU);
			var tdU = LEAP.getElement("td[ctf=" + LEAP.attlist.ctf.cell_sn + "]", rowU);
			var tdD = LEAP.getElement("td[ctf=" + LEAP.attlist.ctf.cell_sn + "]", rowD);
			if (tdU != null && tdD != null)
			{
				var snU = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", tdU);
				if (snU == null)
					snU = tdU;
				var snD = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", tdD);
				if (snD == null)
					snD = tdD;
				
				var _s = snU.innerText;
				snU.innerText = snD.innerText;
				snD.innerText = _s;
			}
						
			rowU[LEAP.attlist.n].orderid = rowU.rowIndex;
			if (rowU[LEAP.attlist.n].updateType != 0)
				rowU[LEAP.attlist.n].updateType = 1;
			
			rowD[LEAP.attlist.n].orderid = rowD.rowIndex;
			if (rowD[LEAP.attlist.n].updateType != 0)
				rowD[LEAP.attlist.n].updateType = 1;
				
			LEAP.attlist._handleRowDataChange(element, {key:"update", row:rowU, data:rowU[LEAP.attlist.n]});
			LEAP.attlist._handleRowDataChange(element, {key:"update", row:rowU, data:rowD[LEAP.attlist.n]});
		}
		else if (type == LEAP.attlist.ctf.btnMT && idx > 2)
		{
			var rowFirst = table.rows[2];
			var rowT = table.rows[idx];
			rowFirst.parentNode.insertBefore(rowT, rowFirst);

			for(var i=2; i<table.rows.length; i++)
			{
				var tmp = table.rows[i];
				var td = LEAP.getElement("td[ctf=" + LEAP.attlist.ctf.cell_sn + "]", tmp);
				var sn = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", td);
				if (sn == null)
					sn = td;
				sn.innerText = i-1;			
				
				tmp[LEAP.attlist.n].orderid = i;
				if (tmp[LEAP.attlist.n].updateType != 0)
					tmp[LEAP.attlist.n].updateType = 1;
					
				LEAP.attlist._handleRowDataChange(element, {key:"update", row:tmp, data:tmp[LEAP.attlist.n]});
			}
		}
		else if (type == LEAP.attlist.ctf.btnMB && idx < table.rows.length-1)
		{
			for(var i=idx; i<table.rows.length-1; i++)
			{
				var tmp1 = table.rows[i];
				var tmp2 = table.rows[i+1];
				tmp2.parentNode.insertBefore(tmp2, tmp1);
			}
						
			for(var i=2; i<table.rows.length; i++)
			{
				var tmp = table.rows[i];
				var td = LEAP.getElement("td[ctf=" + LEAP.attlist.ctf.cell_sn + "]", tmp);
				var sn = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", td);
				if (sn == null)
					sn = td;
				sn.innerText = i-1;
				
				tmp[LEAP.attlist.n].orderid = i;
				if (tmp[LEAP.attlist.n].updateType != 0)
					tmp[LEAP.attlist.n].updateType = 1;
					
				LEAP.attlist._handleRowDataChange(element, {key:"update", row:tmp, data:tmp[LEAP.attlist.n]});
			}
		}
		
		LEAP.attlist.__refreshSN(element);
		
		LEAP.attlist._handleListChange(element);
	}
	finally
	{
		idx = table = rowU = rowD = tdU = tdD = _s = rowFirst = rowT = i = tmp =  td =  tmp1 = tmp2 = sn = snD = snU = null;
	}
}

LEAP.attlist._hide = function(element)
{
	try
	{		
		var checks = LEAP.getElements("[ctf=" + LEAP.attlist.ctf.check + "]", element);
		if (checks == null)
			return;
					
		for(var i=0; i<checks.length; i++)
		{
			var chk = checks[i];
			var row = LEAP._match(checks[i], LEAP.attlist.ctf.attrow, 'ctf');
			if(row)
			{
				var att = row[LEAP.attlist.n];
				if (chk.checked == true)
				{
					if (att.disp == 0)
					{
						continue;
					}
					else
					{
						att.disp = 0;
						if (att.updateType == null)
							att.updateType = 1;
							
						row.setAttribute(LEAP.attlist.ctf.dispflag, "0");
						
						var a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]", row);
						if (a)
						{
							var hideColor = (element.getAttribute("hidecolor") == null) ? '#9f9d9d' :element.getAttribute("hidecolor");
							a.style.color = hideColor;
						}
					}
				}
				else
				{
					if (att.disp == null || att.disp == 1)
					{
						continue;
					}
					else
					{
						att.disp = 1;
						if (att.updateType == null)
							att.updateType = 1;
							
						row.removeAttribute(LEAP.attlist.ctf.dispflag);
						
						var a = LEAP.getElement("a[ctf=" + LEAP.attlist.ctf.downhref + "]", row);
						if (a)
						{
							var color = "#56ABFC";
							if (element.getAttribute("defaultcolor"))
								color = element.getAttribute("defaultcolor");
							if (att.defaultcolor)
								color = att.defaultcolor;
							if (att.namedpath != null && element.getAttribute("uploadcolor"))
								color = element.getAttribute("uploadcolor");
							
							a.style.color = color;
						}
						
					}
				}
			}		
		}
		
	}
	finally
	{
		checks = i = chk =  row = a = null;
	}
}


LEAP.attlist._checkAll = function(element, src)
{
	try
	{
		var checks = LEAP.getElements("[ctf=" + LEAP.attlist.ctf.check + "]", element);
		if (checks == null)
			return;
		
		for(var i=0; i<checks.length; i++)
		{
			checks[i].checked = src.checked;
		}
	}
	finally
	{
		checks = i = null;
	}
}

LEAP.attlist.getCheckedAttachments = function(element)
{
	try
	{
		var arr = [];
		var checks = LEAP.getElements("[ctf=" + LEAP.attlist.ctf.check + "]", element);
		if (checks == null)
			return;
		
		for(var i=0; i<checks.length; i++)
		{
			if (checks[i].checked == true)
			{
				var row = LEAP._match(checks[i], LEAP.attlist.ctf.attrow, 'ctf');
				if(row)
				{
					arr.add(row[LEAP.attlist.n]);
				}
			}
		}
		
		if (arr.length == 0)
			return null;
		else
			return arr;
	}
	finally
	{
		arr = checks = i = row = null;
	}
}

LEAP.attlist.__refreshSN = function(element)
{
	var rows = LEAP.getElements("[ctf=" + LEAP.attlist.ctf.attrow + "][" + LEAP.attlist.ctf.ishide + "=0]", element);
	if (rows != null)
	{
		for(var i=0; i<rows.length; i++)
		{
			var idx = i;
			var row = rows[idx];
			var td = LEAP.getElement("td[ctf=" + LEAP.attlist.ctf.cell_sn + "]", row);
			if (td != null)
			{
				var sn = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", td);
				if (sn == null)
					sn = td;
				
				sn.innerText = idx + 1;	
			}
		}		
	}	
}

LEAP.attlist.__onSort = function(arg)
{
	try
	{	
		var element = LEAP._match(arg.arg2.srcBlock, LEAP.attlist.d);
		var rows = LEAP.getElements("[rt=normalrow]", element);
		for(var i=0; i<rows.length; i++)
		{
			var row = rows[i];
			
			row[LEAP.attlist.n].orderid = row.rowIndex;			
			if (row[LEAP.attlist.n].updateType != 0)
				row[LEAP.attlist.n].updateType = 1;
				
			var snCell = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.cell_sn + "]", row);
			if (snCell != null)
			{
				var sn = LEAP.getElement("[ctf=" + LEAP.attlist.ctf.sn + "]", snCell);
				if (sn == null)
					sn = snCell;
				sn.innerText = i+1;			
			}
			
			LEAP.attlist._handleRowDataChange(element, {key:"update", row:row, data:row[LEAP.attlist.n]});
		}	
		
		LEAP.attlist._handleListChange(element);
		
		LEAP.attlist.__refreshSN(element);
	}
	finally
	{
		element = rows = i = row = snCell = sn = null;
	}
}

LEAP.attlist._handleListChange = function(src)
{
	try
	{
		var element = LEAP._match(src, LEAP.attlist.d);
		if (element != null)
		{	
			ElementEventManager.handleEvent(element, "onListChange");
		}
	}
	finally
	{
		element = null;
	}
}
LEAP.attlist._handleRowDataChange = function(src, param)
{
	try
	{
		var element = LEAP._match(src, LEAP.attlist.d);
		if (element != null)
		{	
			ElementEventManager.handleEvent(element, "onRowDataChange", param);
		}
	}
	finally
	{
		element = null;
	}
}

LEAP.attlist._setZWButtonDisplay = function(element)
{
	LEAP.asyn(LEAP.attlist.__setZWButtonDisplay, this, 100, element);
}
/*LEAP.attlist.__setZWButtonDisplay = function(element)
{
	try
	{
		var btnframe = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnframe + "]", element);
		if (btnframe  == null)
			return;
			
		var wordbtn = LEAP.getElement("div[ctf=" + LEAP.attlist.ctf.btnword + "]", element);
		if (wordbtn)
		{
			var readonly = element.getAttribute("readonly");		
			
			if (readonly == "true")
			{
				wordbtn.style.display = "none";				
			}
			else
			{			
				var _type = LEAP.attlist._getZWUploadTypes(element);
				if (_type[0])
				{								
					wordbtn.style.display = "block";
					
					if (wordbtn.getAttribute("ct") == LEAP.uploadbtn.d)
						wordbtn.innerHTML = wordbtn.innerHTML;
									
					LEAP.uploadbtn.setUploadAttr(wordbtn, "types", _type[0] + "");
					LEAP.uploadbtn.setUploadAttr(wordbtn, "typesdesc", _type[1] + "");
					
					if (LEAP.fileupload && LEAP.fileupload.setAccept)
						LEAP.fileupload.setAccept(wordbtn, _type[0]);
					
				}
				else
				{
					wordbtn.style.display = "none";
				}
			}
		}		
	}
	finally
	{
		btnframe = wordbtn = readonly = _type = null;
	}	
}*/

LEAP.attlist._checkHasZW = function(element)
{
	try
	{
		var rst = [false, false, false];
		var arr = LEAP.attlist._getValue(element);
		if(arr)
		{
			for(var i=0; i<arr.length; i++)
			{
				if (arr[i].atttype == LEAP.attlist.symbol.zw)
					rst[0] = true;
				else if (arr[i].atttype == LEAP.attlist.symbol.PDFZW)
					rst[1] = true;
				else if (arr[i].atttype == LEAP.attlist.symbol.ceb)
					rst[2] = true;
				else if (arr[i].atttype == LEAP.attlist.symbol.OFDZW)
					rst[3] = true;
			}
		}
	
		return rst;
	}
	finally
	{
		rst = arr = i = null;
	}
}

LEAP.attlist._getZWUploadTypes = function(element)
{
	try
	{
		var wordparam = element[LEAP.attlist.sm.wordparam];
		
		if (wordparam == null)
			return "";
		
		var _type = wordparam.ZWType;
		
		var _cv = LWFP.innerApi.Decimal2checkValue(_type, 5);
		var _ftype = "";
		var _ftypedesc = "";
		if (_cv.indexof('00001') >=0)	
		{
			_ftype += ',doc,docx';
			_ftypedesc += "|*.doc|*.docx";
		}
		if (_cv.indexof('00010') >=0)
		{
			_ftype += ',wps';
			_ftypedesc += "|*.wps";
		}
		if (_cv.indexof('00100,') >=0)
		{
			_ftype += ',pdf';
			_ftypedesc += "|*.pdf";
		}	
		if (_cv.indexof('01000') >=0)	
		{
			_ftype += ',ceb,cebx';
			_ftypedesc += "|*.ceb|*.cebx";
		}
		if (_cv.indexof('10000') >=0)	
		{
			_ftype += ',ofd';
			_ftypedesc += "|*.ofd";
		}
		
		if (!_type)
		{
			_ftype = ',doc,docx';
			_ftypedesc = "|*.doc|*.docx";
		}
			
		_ftype = _ftype.substring(1);
		_ftypedesc = _ftypedesc.substring(1);
				
		return [_ftype,_ftypedesc];
	}
	finally
	{
		wordparam = _type = _cv = _ftype = _ftypedesc = null;
	}
}

/*LEAP.attlist._getZWUploadTypes = function(element)
{
	try
	{	
		var zw = LEAP.attlist._checkHasZW(element);
		var wordparam = element[LEAP.attlist.sm.wordparam];
		
		if (wordparam == null)
			return "";
		
		var _type = wordparam.ZWType;
		
		var _cv = LWFP.innerApi.Decimal2checkValue(_type, 4);
		var _ftype = "";
		var _ftypedesc = "";
		if (_cv.indexof('0001') >=0 && zw[0] == false)	
		{
			_ftype += ',doc,docx';
			_ftypedesc += "|*.doc|*.docx";
		}
		if (_cv.indexof('0010') >=0 && zw[0] == false)
		{
			_ftype += ',wps';
			_ftypedesc += "|*.wps";
		}
		if (_cv.indexof('0100,') >=0 && zw[1] == false)
		{
			_ftype += ',pdf';
			_ftypedesc += "|*.pdf";
		}	
		if (_cv.indexof('1000') >=0 && zw[2] == false)	
		{
			_ftype += ',ceb,cebx';
			_ftypedesc += "|*.ceb|*.cebx";
		}
		
		if (!_type)
		{
			_ftype = ',doc,docx';
			_ftypedesc = "|*.doc|*.docx";
		}
			
		_ftype = _ftype.substring(1);
		_ftypedesc = _ftypedesc.substring(1);
				
		return [_ftype,_ftypedesc];
	}
	finally
	{
		zw = wordparam = _type = _cv = _ftype = _ftypedesc = null;
	}
}*/


/**
LEAP.attachment._getUploadTypes = function(element)
{
	var _hasZW = LEAP.attachment._hasZW(element);
	var _hasPDFZW = LEAP.attachment._hasPDFZW(element);
	var _hasCEB = LEAP.attachment._hasCEB(element);
	var _type = element["zhengwenType"];
	var _cv = LWFP.innerApi.Decimal2checkValue(_type, 4);
	var _ftype = "";
	var _ftypedesc = "";
	if (_cv.indexof('0001') >=0 && _hasZW == false)	
	{
		_ftype += ',doc,docx';
		_ftypedesc += "|*.doc|*.docx";
	}
	if (_cv.indexof('0010') >=0 && _hasZW == false)
	{
		_ftype += ',wps';
		_ftypedesc += "|*.wps";
	}
	if (_cv.indexof('0100,') >=0 && _hasPDFZW == false)
	{
		_ftype += ',pdf';
		_ftypedesc += "|*.pdf";
	}	
	if (_cv.indexof('1000') >=0 && _hasCEB == false)	
	{
		_ftype += ',ceb,cebx';
		_ftypedesc += "|*.ceb|*.cebx";
	}
	
	if (!_type)
	{
		_ftype = ',doc,docx';
		_ftypedesc = "|*.doc|*.docx";
	}
		
	_ftype = _ftype.substring(1);
	_ftypedesc = _ftypedesc.substring(1);
			
	return [_ftype,_ftypedesc];
}
 */


LEAP.attlist.init();


/**
 * @class LEAP.TreeSelector control
 * @type user control
 * @example 
 
  
 
 
 标签：
 _title: 选择窗口标题
 readonly:是否只读  0否1是
 _params: 选择参数,格式如下：
		 	[
				{
				 	tabTitle:标签页标题	
				 	type:0实体机构 1虚拟机构 2自定义树 3一维复选框 
				 	searchParam:搜索参数
				 				{
				 					//以下为虚拟机构专用搜索参数
				 					topOrgan:顶点机构范围限制，0无限制，1限制顶点机构范围但结果不包括顶点机构本身  2限制为顶点机构范围且结构包括顶点机构本身, 默认0
								 	rootRanges:根范围，根名称逗号分隔
									categoryRanges:类型范围，名称逗号分隔	 		
									underAreaRange:区域ID范围限制
									equalAreaRange:等于某区域ID
									syscodeRange:  syscode范围
									includeSyscodeRange: 结果是否包含指定syscode机构,0不包含 1包含，默认0
									nodetype: 叶子节点类型，10 机构  11用户  15机构用户混合
									
									//以下为实体机构专用搜索参数
									topOrgan:顶点机构范围限制，0无限制 1限制, 默认1
									organRanges:机构ID范围，多机构之间以分号分隔, 
									includeOrganRange: 结果是否包含指定范围机构本身,0不包含 1包含，默认0
									rolenameRanges:角色名称范围，多角色名间以分号分隔,
									excludeRolenameRanges:排除角色范围，多角色名间以逗号分隔,
									excludeUserTypes:排除用户类型，多类型名间以逗号分隔,
									excludeOrgans:排除机构范围, 多机构id间以逗号分隔,
									nodetype: 叶子节点类型，0机构、1岗位、2用户、3机构人混选， 默认0			
								}
								
					data:树数据，如果未指定searchParam参数或者type=2或3时， 则需指定自行构造树数据	 		
					operationParam: 操作参数
								{
									lazy:是否延迟加载, boolean, 默认true
									treeStyle 机构树样式（0完全展开、1部分展开）, 默认1
									treeLevels 机构树默认展开层数，默认为3
									treeSingleCheck 1单选0多选, 默认1
									autoCheckChilds 多选时是否自动选中子节点，默认true
									autoCheckTipChilds 多选时是否自动选中叶子节点的子节点，默认false
									allowMutiLevelCheck 多选时是否允许跨级选择，默认true
								}
				 	}
			 ]
  
*/

LEAP.TreeSelector = {};
LEAP.TreeSelector.d = 'TreeSelector';
LEAP.TreeSelector.ctf = {};
LEAP.TreeSelector.symbol ={};

LEAP.TreeSelector.init = function()
{
	if (document != null && document.body != null)
		LEAP.TreeSelector._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.TreeSelector._init);	
		
	ElementEventManager.addManagedEventType(LEAP.TreeSelector.d, 'valueChange');
	ElementEventManager.addManagedEventType(LEAP.TreeSelector.d, 'tabSelectChange');
}
LEAP.TreeSelector._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.TreeSelector.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.TreeSelector._init);
}

LEAP.TreeSelector.uiProcess = function(arg)
{
	try
	{
		if (!arg.e || !arg.e.srcElement)
			return;
		
		var src = arg.e.srcElement;
		var element = LEAP._match(src, LEAP.TreeSelector.d);
		if(element == null)
			return;
		
		if (element.getAttribute("readonly") != null && element.getAttribute("readonly") == '1')
			return;
			
		LEAP.TreeSelector._show(element);
	}
	finally
	{
		src = element = null;
	}
}

LEAP.TreeSelector._show = function(_element)
{
	try
	{
		var element = LEAP._match(_element, LEAP.TreeSelector.d);
		if (!element)
			return;
			
		var params = LEAP.TreeSelector.__getParams(element);
		var value = LEAP.TreeSelector.getValue(element);
		var title = element.getAttribute("_title")==null?"选择":element.getAttribute("_title");
		
		var formDef = {name:"LWFP.GroupSelectPage", title:title, width:900, height:535, formtype:3}
		
		var domain = LEAP.TreeSelector.__getmodule(element);
		
		var _form = LEAP.TreeSelector._showSelectForm(domain, params, value, formDef, LEAP.TreeSelector.__selectCallback, {caller:element}, null, LEAP.TreeSelector.__tabSelectChangeCallback, element["__searchFn"], element["__searchParam"]);
		
		/*var _form = domain.loadForm3({name:"LWFP.GroupSelectPage", title:title, width:900, height:535, formtype:3});	
		if (_form)
		{
			_form.module.init(params, value);
			_form.module.regEvent('onSubmit', LEAP.TreeSelector.__selectCallback, this, {caller:element});
		}*/
		
	}
	finally
	{
		element = params = value = title = domain = _form = null;
	}
}

LEAP.TreeSelector.showSelectForm = function(domain, searchParams, value, formDef, callbackFn, callbackParam, selectChangedCallback, searchFn, searchParam)
{
	LEAP.TreeSelector._showSelectForm(domain, searchParams, value, formDef, callbackFn, callbackParam, selectChangedCallback, null, searchFn, searchParam)
}

LEAP.TreeSelector._showSelectForm = function(domain, searchParams, value, formDef, callbackFn, callbackParam, selectChangedCallback, tabSelectChangeCallback, searchFn, searchParam)
{
	try
	{
		var _def = formDef;
		if (!_def)
			_def = {};
			
		if (!_def.name)
			_def.name = "LWFP.GroupSelectPage";
		if (!_def.title)
			_def.title = "选择";
		if (!_def.width)
			_def.width = 900;
		if (!_def.height)
			_def.height = 535;
		if (!_def.formtype)
			_def.formtype = 3;
					
		if (domain.______treeSelector_form)
		{
			domain.______treeSelector_form.dispose();
			domain.______treeSelector_form = null;
		}
		
		var _form = domain.loadForm3(_def);	
		if (_form)
		{
			domain.______treeSelector_form = _form.module;
			
			_form.module.init(searchParams, value, searchFn, searchParam);
			_form.module.regEvent('onSubmit', callbackFn, domain, callbackParam);
			
			if (selectChangedCallback)
			{
				_form.module.regEvent('onSelectChanged', selectChangedCallback, domain, callbackParam);
			}
			if (tabSelectChangeCallback)
			{
				_form.module.regEvent('onTabSelectChange', tabSelectChangeCallback, domain, callbackParam);
			}
		}
		
		LEAP.form.show(_form.form, _def.formtype);
		
		return _form;
	}
	finally
	{
		_def = _form = null;
	}
}

LEAP.TreeSelector.setSearchFunction = function(element, fn, param)
{
	element["__searchFn"] = fn;
	element["__searchParam"] = param;
}

//"[{'tabTitle':'虚拟多选','type':1,'searchParam':{'topOrgan':0,'rootRanges':'','categoryRanges':'','underAreaRange':'','equalAreaRange':'','syscodeRange':'','includeSyscodeRange':1,'nodetype':11},'data':null,'operationParam':{'lazy':true,'treeStyle':1,'treeLevels':3,'treeSingleCheck':0,'autoCheckChilds':true,'allowMutiLevelCheck':true}},{'tabTitle':'虚拟单选','type':1,'searchParam':{'topOrgan':0,'rootRanges':'','categoryRanges':'','underAreaRange':'','equalAreaRange':'','syscodeRange':'','includeSyscodeRange':1,'nodetype':11},'data':null,'operationParam':{'lazy':true,'treeStyle':1,'treeLevels':3,'treeSingleCheck':1}},{'tabTitle':'实体多选','type':0,'searchParam':{'topOrgan':0,'organRanges':null,'includeOrganRange':1,'rolenameRanges':null,'nodetype':2},'data':null,'operationParam':{'lazy':true,'treeStyle':1,'treeLevels':3,'treeSingleCheck':0,'autoCheckChilds':true,'allowMutiLevelCheck':true}},{'tabTitle':'实体单选','type':0,'searchParam':{'topOrgan':0,'organRanges':null,'includeOrganRange':1,'rolenameRanges':null,'nodetype':2},'data':null,'operationParam':{'lazy':true,'treeStyle':1,'treeLevels':3,'treeSingleCheck':1}}]"
//"[{'tabTitle':'虚拟单选','type':1,'searchParam':{'topOrgan':0,'rootRanges':'','categoryRanges':'','underAreaRange':'','equalAreaRange':'','syscodeRange':'','includeSyscodeRange':1,'nodetype':11},'data':null,'operationParam':{'lazy':true,'treeStyle':1,'treeLevels':3,'treeSingleCheck':1}}]"
LEAP.TreeSelector.setParams = function(_element, params)
{
	try
	{
		var element = LEAP._match(_element, LEAP.TreeSelector.d);
		if (!element)
			return;
			
		var str = ""
		if (params != null)			
			str = JSON.stringify(params);
		
		if (str == "")
			element.removeAttribute("_params");
		else
			element.setAttribute("_params", str);
	}
	finally
	{
		element = str = null;
	}
}

LEAP.TreeSelector.__getParams = function(element)
{
	try
	{	 
		var params = null; 
		var pstr = element.getAttribute("_params");
		if (pstr != null)
			params = eval(pstr);
			
		if (params == null)
		{
			params = [];
			params.add({});
		}
		
		for(var i=0; i<params.length; i++)
		{
			var par = params[i];
			if (par == null)
				par = {};
			
			par.type = (par.type == null) ? 1 : par.type;
			par.tabTitle = (par.tabTitle == null) ? "默认标签" : par.tabTitle;
			par.operationParam = (par.operationParam == null) ? {} : par.operationParam;
			par.operationParam.lazy = (par.operationParam.lazy == null)? true : par.operationParam.lazy;		
			par.operationParam.treeStyle = (par.operationParam.treeStyle == null)? 1 : par.operationParam.treeStyle;
			par.operationParam.treeLevels = (par.operationParam.treeLevels == null)? 3 : par.operationParam.treeLevels;
			par.operationParam.treeSingleCheck = (par.operationParam.treeSingleCheck == null)? 1 : par.operationParam.treeSingleCheck;
			par.operationParam.autoCheckChilds = (par.operationParam.autoCheckChilds == null)? true : par.operationParam.autoCheckChilds;			
			par.operationParam.autoCheckTipChilds = (par.operationParam.autoCheckTipChilds == null)? false : par.operationParam.autoCheckTipChilds;
			par.operationParam.allowMutiLevelCheck = (par.operationParam.allowMutiLevelCheck == null)? true : par.operationParam.allowMutiLevelCheck;
			
			if (par.type == 0)
			{
				par.searchParam = (par.searchParam == null) ? {} : par.searchParam;
				par.searchParam.topOrgan = (par.searchParam.topOrgan == null) ? 1: par.searchParam.topOrgan;			
				par.searchParam.organRanges = (par.searchParam.organRanges == null) ? "": par.searchParam.organRanges;
				par.searchParam.includeOrganRange = (par.searchParam.includeOrganRange == null) ? 0: par.searchParam.includeOrganRange;
				par.searchParam.rolenameRanges = (par.searchParam.rolenameRanges == null) ? "": par.searchParam.rolenameRanges;
				par.searchParam.excludeRolenameRanges = (par.searchParam.excludeRolenameRanges == null) ? "": par.searchParam.excludeRolenameRanges;
				par.searchParam.excludeUserTypes = (par.searchParam.excludeUserTypes == null) ? "": par.searchParam.excludeUserTypes;
				par.searchParam.excludeOrgans = (par.searchParam.excludeOrgans == null) ? "": par.searchParam.excludeOrgans;	

				par.searchParam.nodetype = (par.searchParam.nodetype == null) ? 0: par.searchParam.nodetype;		
			}
			else if (par.type == 1)
			{
				par.searchParam = (par.searchParam == null) ? {} : par.searchParam;
				
				par.searchParam.topOrgan = (par.searchParam.topOrgan==null) ? 0 : par.searchParam.topOrgan;			
				par.searchParam.rootRanges = (par.searchParam.rootRanges=="") ? "" : par.searchParam.rootRanges;
				par.searchParam.categoryRanges = (par.searchParam.categoryRanges==null) ? "" : par.searchParam.categoryRanges;
				par.searchParam.underAreaRange = (par.searchParam.underAreaRange==null) ? "" : par.searchParam.underAreaRange;
				par.searchParam.equalAreaRange = (par.searchParam.equalAreaRange==null) ? "" : par.searchParam.equalAreaRange;
				par.searchParam.syscodeRange = (par.searchParam.syscodeRange==null) ? "" : par.searchParam.syscodeRange;
				par.searchParam.includeSyscodeRange = (par.searchParam.includeSyscodeRange==null) ? 0 : par.searchParam.includeSyscodeRange;
				par.searchParam.nodetype = (par.searchParam.nodetype==null) ? 10 : par.searchParam.nodetype;		
			}
		}
		
		return params;
	}
	finally
	{
		params = pstr = i = par = null;
	}
}

LEAP.TreeSelector.__selectCallback = function(arg, arg2)
{
	arg2.caller['_value'] = arg.selectedNodes;
	ElementEventManager.handleEvent(arg2.caller, "valueChange", {value:arg.selectedNodes})	
}

LEAP.TreeSelector.__tabSelectChangeCallback = function(arg, arg2)
{
	ElementEventManager.handleEvent(arg2.caller, "tabSelectChange", {index:arg.arg2.index, param:arg.arg2.param});
}

LEAP.TreeSelector.setValue = function(_element, value)
{
	try
	{
		var element = LEAP._match(_element, LEAP.TreeSelector.d);
		if (element != null)
		{
			element['_value'] = value;
		}
	}
	finally
	{
		element = null;
	}
}

LEAP.TreeSelector.getValue = function(_element)
{
	try
	{
		var element = LEAP._match(_element, LEAP.TreeSelector.d);
		if (element != null)
			return element['_value'];
		else
			return null;		
	}
	finally
	{
		element = null;
	}
}

LEAP.TreeSelector.setReadOnly = function(_element, _bool)
{
	try
	{
		var element = LEAP._check(_element, LEAP.TreeSelector.d);
		if (null == element)return;
		if (_bool == true)
			element.setAttribute("readonly", '1');
		else if (_bool == false)
			element.setAttribute("readonly", '0');
	}
	finally
	{
		element = null;
	}	
}

LEAP.TreeSelector.__getmodule = function(element)
{
	if (element == null)
		return null;
		
	if (element.getAttribute("instance") != null)
	{
		return PageObjectModel.getModule(element.getAttribute("instance"));			
	}
	
	return null;	
}


LEAP.TreeSelector.init();








/**
 * @class LEAP.TreeSelectBanner control
 * @type user control
 * @example 
 
  
 
 
 标签：
 paramStr: 选择参数,格式如下：
		 	[
				{
				 	tabTitle:标签页标题	
				 	type:0实体机构 1虚拟机构 2自定义树 3一维复选框 4树数据层状呈现
				 	searchParam:搜索参数
				 				{
				 					//以下为虚拟机构专用搜索参数
				 					topOrgan:顶点机构范围限制，0无限制，1限制顶点机构范围但结果不包括顶点机构本身  2限制为顶点机构范围且结构包括顶点机构本身, 默认0
								 	rootRanges:根范围，根名称逗号分隔
									categoryRanges:类型范围，名称逗号分隔	 		
									underAreaRange:区域ID范围限制
									equalAreaRange:等于某区域ID
									syscodeRange:  syscode范围
									includeSyscodeRange: 结果是否包含指定syscode机构,0不包含 1包含，默认0
									nodetype: 叶子节点类型，10 机构  11用户  15机构用户混合
									
									//以下为实体机构专用搜索参数
									topOrgan:顶点机构范围限制，0无限制 1限制, 默认1
									organRanges:机构ID范围，多机构之间以分号分隔, 
									includeOrganRange: 结果是否包含指定范围机构本身,0不包含 1包含，默认0
									rolenameRanges:角色名称范围，多角色名间以分号分隔,
									excludeRolenameRanges:排除角色范围，多角色名间以逗号分隔,
									excludeUserTypes:排除用户类型，多类型名间以逗号分隔,
									excludeOrgans:排除机构范围, 多机构id间以逗号分隔,
									nodetype: 叶子节点类型，0机构、1岗位、2用户、3机构人混选， 默认0	
									
									_searchFn:自定义搜索函数
									_searchFnDomain:自定义搜索函数作用域
								}
								
					data:树数据，如果未指定searchParam参数或者type=2或3时， 则需指定自行构造数据	 		
					operationParam: 操作参数
								{
									lazy:是否延迟加载, boolean, 默认true
									treeStyle 机构树样式（0完全展开、1部分展开）, 默认1
									treeLevels 机构树默认展开层数，默认为3
									treeSingleCheck 1单选0多选, 默认1
									autoCheckChilds 多选时是否自动选中子节点，默认true
									autoCheckTipChilds 多选时是否自动选中叶子节点的子节点，默认false
									excludeSelfChild 多选时不选中当前用户自己
									allowMutiLevelCheck 多选时是否允许跨级选择，默认true
								}
				 	}
			 ]
  
  
  全局配置：LEAP.TreeSelectBanner.filtDuplicate=false 不过滤多岗位重复用户，默认true
*/

LEAP.TreeSelectBanner = {};
LEAP.TreeSelectBanner.d = 'TreeSelectBanner';
LEAP.TreeSelectBanner.pd = 'TreeSelectBannerPop';
LEAP.TreeSelectBanner.ps = 'TreeSelectBannerPopSearch';
LEAP.TreeSelectBanner.ctf = {};
LEAP.TreeSelectBanner.symbol = {paramStr:"paramStr", paramObj:"paramObj", selectedItems:"selectedItems",
								TSB_group:"tsb_group",
									TSB_tabctrl: "TSB_tabctrl",
									TSB_tree: "TSB_tree",
									TSB_fre_Check: "TSB_fre_Check", //常用联系人复选框
									TSB_fre_Clear: "TSB_fre_Clear", //常用联系人清除
									TSB_fre_Container: "TSB_fre_Container",//常用联系人容器
									TSB_itemctrl: "TSB_itemctrl",
									ValueChangeFn:"ValueChangeFn",
									
									TSBCTF: "TSBCTF",
									layer:	"layer",
									layer_level: "layer_level",
									layer_chk_tip: "layer_chk_tip",
									layer_chk_org: "layer_chk_org"
								}; 

LEAP.TreeSelectBanner.init = function()
{
	if (document != null && document.body != null)
		LEAP.TreeSelectBanner._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.TreeSelectBanner._init);	
		
	ElementEventManager.addManagedEventType(LEAP.TreeSelectBanner.d, 'valueChange');
	ElementEventManager.addManagedEventType(LEAP.TreeSelectBanner.d, 'tabSelectChange');
}
LEAP.TreeSelectBanner._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.TreeSelectBanner.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.TreeSelectBanner._init);
}

LEAP.TreeSelectBanner.uiProcess = function(arg)
{
	try
	{
		if (!arg.e || !arg.e.srcElement)
			return;		
		var src = arg.e.srcElement;
		
		var popSearch = LEAP._match(src, LEAP.TreeSelectBanner.ps, "cct");
		if (LEAP.TreeSelectBanner.popSearchResultContiner != null && popSearch == null)
			LEAP.TreeSelectBanner.popSearchResultContiner.style.display = "none";
		
		var pop = LEAP._match(src, LEAP.TreeSelectBanner.pd, "cct", 99999);
		
		if (LEAP.TreeSelectBanner.popContainer != null && popSearch == null &&
				(!pop || src.getAttribute("ctf") == "popclose") )
		{
			LEAP.TreeSelectBanner.popContainer.style.display = "none";			
		}
				
		
		var element = LEAP._match(src, LEAP.TreeSelectBanner.d);
		if(element == null)
			return;
		
		if (element.getAttribute("_readonly") != null || element.getAttribute("_readonly") == '1')
			return;		
		
	}
	finally
	{
		src = popSearch = pop = element = null;
	}
}

LEAP.TreeSelectBanner.setGroup = function(element, groupName)
{
	try
	{
		var _element = LEAP._match(element, LEAP.TreeSelectBanner.d);
		if (_element == null)
			return null;
			
		_element.setAttribute(LEAP.TreeSelectBanner.symbol.TSB_group, groupName);
			
		LEAP.TreeSelectBanner.___registIitemCtrl(_element);		
	}
	finally
	{
		_element = null;
	}
}

LEAP.TreeSelectBanner.getValue = function(element)
{
	try
	{
		var _element = LEAP._match(element, LEAP.TreeSelectBanner.d);
		if (_element == null)
			return null;
			
		var nodes = _element[LEAP.TreeSelectBanner.symbol.selectedItems];
		if (nodes && nodes.length == 0)
			return null;
		
		var _nodes = LWFP.innerApi.clone(nodes);
		return _nodes;
	}
	finally
	{
		_element = nodes = _nodes = null;
	}
}

LEAP.TreeSelectBanner.setValue = function(element, value, reBindSelectedItem, reSyncTree)
{
	try
	{
		var _element = LEAP._match(element, LEAP.TreeSelectBanner.d);
		if (_element == null)
			return;
			
		var _value = LWFP.innerApi.clone(value);
		//_element[LEAP.TreeSelectBanner.symbol.selectedItems] = _value;
		LEAP.TreeSelectBanner.__cacheValue(_element, _value, false);
				
		if (reBindSelectedItem == null || reBindSelectedItem == true)
			LEAP.TreeSelectBanner.__bindSlectedList(_element);
		
		if (reSyncTree == null || reSyncTree == true)
			LEAP.TreeSelectBanner._syncChecked(_element);
	}
	finally
	{
		_element = _value = null;
	}
}

LEAP.TreeSelectBanner.__cacheValue = function(element, value, handleValueChangeEvent)
{
	try
	{
		var pv = element[LEAP.TreeSelectBanner.symbol.selectedItems];
		element[LEAP.TreeSelectBanner.symbol.selectedItems] = value;
		if (true == handleValueChangeEvent)
		{
			ElementEventManager.handleEvent(element, "valueChange", 
											{element:element, 
												pv:LWFP.innerApi.clone(pv), 
												lv:LWFP.innerApi.clone(value)
											} 
										);
			
			if (element[LEAP.TreeSelectBanner.symbol.ValueChangeFn])
			{
				try
				{
					var domain = PageObjectModel.getModule(element.getAttribute("instance"));	
					if (domain != null)
					{
						element[LEAP.TreeSelectBanner.symbol.ValueChangeFn].apply(domain, [{element:element, 
																							pv:LWFP.innerApi.clone(pv), 
																							lv:LWFP.innerApi.clone(value)	}] );
					}
				}
				catch(e)
				{}				
			}
		}
	}
	finally
	{
		pv = domain = null;
	}
}

LEAP.TreeSelectBanner.setParams = function(element, params, clearSelectedItem)
{
	try
	{
		if (params == null)
		{
			element.removeAttribute(LEAP.TreeSelectBanner.symbol.paramStr);
			element[LEAP.TreeSelectBanner.symbol.paramObj] = null;
		}
		else
		{
			if (typeof(params) == "string")
			{
				if (params.isEmpty() == true)
				{
					element.removeAttribute(LEAP.TreeSelectBanner.symbol.paramStr);
					element[LEAP.TreeSelectBanner.symbol.paramObj] = null;
				}
				else
				{
					element.setAttribute(LEAP.TreeSelectBanner.symbol.paramStr, params);
					element[LEAP.TreeSelectBanner.symbol.paramObj] = null;
				}
			}
			else if (typeof(params) == "object")
			{
				element[LEAP.TreeSelectBanner.symbol.paramObj] = params;				
			}	
		}
		
		LEAP.TreeSelectBanner._i(element);
		
		//清除插件值和已选列表
		//element[LEAP.TreeSelectBanner.symbol.selectedItems] = null;	
		LEAP.TreeSelectBanner.__cacheValue(element, null, false);
		
		
		if (clearSelectedItem != false)
		{
			var itemCtrl = LEAP.TreeSelectBanner.__getItemCtrl(element);
			if (itemCtrl != null)
				LEAP.item.clearItem(itemCtrl);
		}
			
		
	}
	finally
	{
		itemCtrl = null;
	}
}

LEAP.TreeSelectBanner.getParams = function(element)
{
	return element[LEAP.TreeSelectBanner.symbol.paramObj];
}

LEAP.TreeSelectBanner.__getParams = function(element)
{
	try
	{
		var params = element[LEAP.TreeSelectBanner.symbol.paramObj];
		if (params == null)
		{
			var pstr = element.getAttribute(LEAP.TreeSelectBanner.symbol.paramStr);
			if (pstr != null)
				params = JSON.parse(pstr);
		}
			
		if (params == null)
			return null;
		
		for(var i=0; i<params.length; i++)
		{
			var par = params[i];
			if (par == null)
				par = {};
			
			par.type = (par.type == null) ? 1 : par.type;
			par.tabTitle = (par.tabTitle == null) ? "默认标签" : par.tabTitle;
			par.operationParam = (par.operationParam == null) ? {} : par.operationParam;
			par.operationParam.lazy = (par.operationParam.lazy == null)? true : par.operationParam.lazy;		
			par.operationParam.treeStyle = (par.operationParam.treeStyle == null)? 1 : par.operationParam.treeStyle;
			par.operationParam.treeLevels = (par.operationParam.treeLevels == null)? 3 : par.operationParam.treeLevels;
			par.operationParam.treeSingleCheck = (par.operationParam.treeSingleCheck == null)? 1 : par.operationParam.treeSingleCheck;
			par.operationParam.autoCheckChilds = (par.operationParam.autoCheckChilds == null)? true : par.operationParam.autoCheckChilds;
			par.operationParam.allowMutiLevelCheck = (par.operationParam.allowMutiLevelCheck == null)? true : par.operationParam.allowMutiLevelCheck;
			
			if (par.type == 0)
			{
				par.searchParam = (par.searchParam == null) ? {} : par.searchParam;
				par.searchParam.topOrgan = (par.searchParam.topOrgan == null) ? 1: par.searchParam.topOrgan;			
				par.searchParam.organRanges = (par.searchParam.organRanges == null) ? "": par.searchParam.organRanges;
				par.searchParam.includeOrganRange = (par.searchParam.includeOrganRange == null) ? 0: par.searchParam.includeOrganRange;
				par.searchParam.rolenameRanges = (par.searchParam.rolenameRanges == null) ? "": par.searchParam.rolenameRanges;
				par.searchParam.excludeRolenameRanges = (par.searchParam.excludeRolenameRanges == null) ? "": par.searchParam.excludeRolenameRanges;
				par.searchParam.excludeUserTypes = (par.searchParam.excludeUserTypes == null) ? "": par.searchParam.excludeUserTypes;
				par.searchParam.excludeOrgans = (par.searchParam.excludeOrgans == null) ? "": par.searchParam.excludeOrgans;	
				par.searchParam.nodetype = (par.searchParam.nodetype == null) ? 0: par.searchParam.nodetype;		
			}
			else if (par.type == 1)
			{
				par.searchParam = (par.searchParam == null) ? {} : par.searchParam;
				
				par.searchParam.topOrgan = (par.searchParam.topOrgan==null) ? 0 : par.searchParam.topOrgan;			
				par.searchParam.rootRanges = (par.searchParam.rootRanges=="") ? "" : par.searchParam.rootRanges;
				par.searchParam.categoryRanges = (par.searchParam.categoryRanges==null) ? "" : par.searchParam.categoryRanges;
				par.searchParam.underAreaRange = (par.searchParam.underAreaRange==null) ? "" : par.searchParam.underAreaRange;
				par.searchParam.equalAreaRange = (par.searchParam.equalAreaRange==null) ? "" : par.searchParam.equalAreaRange;
				par.searchParam.syscodeRange = (par.searchParam.syscodeRange==null) ? "" : par.searchParam.syscodeRange;
				par.searchParam.includeSyscodeRange = (par.searchParam.includeSyscodeRange==null) ? 0 : par.searchParam.includeSyscodeRange;
				par.searchParam.nodetype = (par.searchParam.nodetype==null) ? 10 : par.searchParam.nodetype;		
			}
		}
		
		element[LEAP.TreeSelectBanner.symbol.paramObj] = params;
		
		return params;
	}
	finally
	{
		params = pstr = i = par = null;
	}
}

LEAP.TreeSelectBanner.__getTabCtrl = function(element)
{
	return LEAP.getElement("div[tsb=" + LEAP.TreeSelectBanner.symbol.TSB_tabctrl + "][ct=tab]", element);
}

LEAP.TreeSelectBanner.__getItemCtrl = function(element)
{
	try
	{
		var itemCtrl = null;
		var module = PageObjectModel.getModule(element.getAttribute("instance"));		
		var group = element.getAttribute(LEAP.TreeSelectBanner.symbol.TSB_group);
		if (group != null)
			itemCtrl = LEAP.getElement("[ct=item][tsb=TSB_itemctrl][tsb_group=" + group + "]", module.moduleElement);
			
		return itemCtrl;
	}
	finally
	{
		itemCtrl = module = group = null;
	}	
}

LEAP.TreeSelectBanner.__getBannerCTrl = function(srcElement)
{
	try
	{
		var element = null;
		var module = PageObjectModel.getModule(srcElement.getAttribute("instance"));		
		var group = srcElement.getAttribute(LEAP.TreeSelectBanner.symbol.TSB_group);
		if (group != null)
			element = LEAP.getElement("[ct=" + LEAP.TreeSelectBanner.d + "][tsb_group=" + group + "]", module.moduleElement);
		
		return element;
	}
	finally
	{
		element = module = group = null;
	}
}

LEAP.TreeSelectBanner._initBannerTabUI = function(element)
{
	try
	{
		if (element == null)
			return;
		
		var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
		if (tabCtrl == null)
			return;			
		var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
		
		var lables = LEAP.tab.getTabLables(tabCtrl);
		if (lables && lables.length > 1)
		{
			for(var i=lables.length-1; i>-1; i--)
				LEAP.tab.removeItem(tabCtrl, i);
		}

		if (tabCtrl.getAttribute("autohidetitle") == "1" && (_treeParams == null || (_treeParams != null && _treeParams.length == 1)))
		{
			LEAP.getElement("div.LC_tab2_box", tabCtrl).style.display = "none";
			LEAP.getElement("div.LC_tab2_Contentbox", tabCtrl).style.top = "0px";
		}
//		else
//		{
//			LEAP.getElement("div.LC_tab2_box", tabCtrl).style.display = "block";
//			LEAP.getElement("div.LC_tab2_Contentbox", tabCtrl).style.top = "31px";
//		}
				
		if (_treeParams != null && _treeParams.length >0)
		{
			for(var i=0; i<_treeParams.length; i++)
			{
				var param = _treeParams[i];
				var _tab = null;
				if (i == 0)
				{
					_tab = LEAP.tab.getItem(tabCtrl, i);
					_tab.tabli.innerText = param.tabTitle;
					_tab.tabli['hasinit'] = false;
				}
				else
				{
					_tab = LEAP.tab.addItem(tabCtrl, param.tabTitle);
				}
				
				if (param.type == 4)
				{//层状
				}
				else if (param.type == 3)
				{
					var _html = "";					
					if (param.isFrequentcontact == true)
						_html = "<A tsb='" + LEAP.TreeSelectBanner.symbol.TSB_fre_Clear + "' style='float:right; margin-right:20px;' href='javascript:void(0)'>清除常用联系人记录</A>";
					_html += "<div tsb='" + LEAP.TreeSelectBanner.symbol.TSB_fre_Container + "' style='margin-left:20px; width:90%; float:left;'>" +
								 "<div tsb='" + LEAP.TreeSelectBanner.symbol.TSB_fre_Check + "' class='LC_checkbox_wrap' ct='checkbox2' bt='text'  mdtype='check'  radio='" + ((param.operationParam.treeSingleCheck==1)?"1":"0") + "'></div>" + 
								"</div>";
										
					_tab.tabcontent.innerHTML = _html;
					
					var checkBoxList = LEAP.getElement("div[ct=checkbox2]", _tab.tabcontent);					
					LEAP.addEvent(checkBoxList, 'valueChange', LEAP.TreeSelectBanner._onCheckListValueChange);
					var btnFreclear = LEAP.getElement("a[tsb=" + LEAP.TreeSelectBanner.symbol.TSB_fre_Clear + "]", _tab.tabcontent);
					if (btnFreclear != null)
						LEAP.addEvent(btnFreclear, 'click', LEAP.TreeSelectBanner._onFrequentcontactClear);
				}
				else
				{
					_tab.tabcontent.innerHTML = "<ul ct='tree' class='tree LC_tree' tsb='" + LEAP.TreeSelectBanner.symbol.TSB_tree + "'></ul>";	
				
					var tree = LEAP.getElement("ul[ct=tree]", _tab.tabcontent);				
					LEAP.addEvent(tree, 'itemInit',  LEAP.TreeSelectBanner._onTreeItemInit);
					LEAP.addEvent(tree, 'checkedChanged',  LEAP.TreeSelectBanner._onTreeCheckedChanged);
					LEAP.addEvent(tree, 'itemClick',  LEAP.TreeSelectBanner._onTreeItemClick);
				}
			}
			
			if (!tabCtrl.__hasRegistTabChange__)
			{
				LEAP.addEvent(tabCtrl, 'selectedIndexChange', LEAP.TreeSelectBanner._onTabSeletedChange);	
				tabCtrl.__hasRegistTabChange__ = true;
			}
			LEAP.tab.setSelectedIndex(tabCtrl, 0);
		}
	}
	finally
	{
		tabCtrl = _treeParams = lables = i = param = _tab = checkBoxList = tree = _html = btnFreclear = null;
	}
}

LEAP.TreeSelectBanner._onTabSeletedChange = function(arg)
{
	try
	{
		var element = LEAP._match(arg.caller, LEAP.TreeSelectBanner.d);
		var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
		
		var idx = arg.arg2.index;
		var _tab = LEAP.tab.getItem(tabCtrl, idx);
		
		var _treeParams = LEAP.TreeSelectBanner.__getParams(element);					
		var param = _treeParams[idx];	
		
		
		ElementEventManager.handleEvent(element, "tabSelectChange", 
											{element:element, 
												index:idx, 
												param:param
											} 
										);
										
		if (_tab.tabli['hasinit'] == true)
			return;			
				
		if (param.data != null)
		{				
			if (param.type == 4)
			{//层状
				LEAP.TreeSelectBanner._layer_init(element, _tab, param);
			}
			else if (param.type == 3)
			{
				var checkBoxList = LEAP.getElement("div[ct=checkbox2]", _tab.tabcontent);	
				for(var i=0; i< param.data.length; i++)
				{
					var __n = param.data[i]; 
					if (param.operationParam.underSyscode && !__n.syscode.startWith(param.operationParam.underSyscode))
						continue;
					
					var __s = __n.remark;
					var __idx = __s.lastIndexOf(".");
					if (__idx >0)
						__s = __s.substring(__idx + 1) + '（' + __s.substring(0, __idx)  + '）'; 

					var itm = LEAP.checkbox2.addItem(checkBoxList, __s, __n.ID, false, __n);
					itm.parentElement.style.width = "99%";
					itm.style.width = "99%";
					itm.style.paddingTop = "2px";
				}					
			}
			else
			{
				var tree = LEAP.getElement("ul[ct=tree]", _tab.tabcontent);						
				var itms = LEAP.TreeSelectBanner.__getInitItemDefine(param.operationParam.rootNodeId, param.operationParam.rootNodeSyscode, param);
				if (itms != null && itms.length>0)
				{
					LEAP.tree.addItems(tree, null, itms);			
					
					if (itms.length == 1)
					{
						LEAP.tree.expandNode(LEAP.getElement("[ctf=tree_item]", tree));
					}
				}
			}
		}
		else
		{
			if (param.type == 0 || param.type == 1 || param.type == 2)
			{
				param.data = LEAP.TreeSelectBanner.__search(param, null);
				if (param.data)
				{
					var tree = LEAP.getElement("ul[ct=tree]", _tab.tabcontent);						
					var itms = LEAP.TreeSelectBanner.__getInitItemDefine(param.operationParam.rootNodeId, param.operationParam.rootNodeSyscode, param);
					if (itms != null && itms.length>0)
						LEAP.tree.addItems(tree, null, itms);
				}
			}
			else if (param.type == 4)
			{
				param.data = LEAP.TreeSelectBanner.__search(param, null);
				if (param.data)
				{
					LEAP.TreeSelectBanner._layer_init(element, _tab, param);
				}
			}
		}
		
		_tab.tabli['hasinit'] = true;		
		
	}
	finally
	{
		LEAP.TreeSelectBanner._syncChecked(element);
		
		element = tabCtrl = idx = _tab = _treeParams = param = checkBoxList = i= __n = __s = __idx = itm = tree = itms = 
		tree = itms = null;
	}
}

//获取树初始节点
LEAP.TreeSelectBanner.__getInitItemDefine = function(_nodeid, _nodeSyscode, param)
{
	try
	{
		var ___nodes = param.data.nodes;
		
		var _level = ___nodes[0].level;
		
		var _arr = [];
		if (_nodeid != null)
		{	//有可能当前级的节点没有到客户端，因此需要遍历验证
			for(var i = 0; i<___nodes.length; i++)
			{
				if ( ___nodes[i].ID == _nodeid)
				{
					_arr.add(_nodeid);
					break;
				}
			}
			
			if (_arr.length == 0)
			{//节点没有到客户端时，根据syscode查找匹配项，可能同级多根，所以需要全遍历
				var _level = -1;
				for(var i = 0; i<___nodes.length; i++)
				{
					var _tmp = ___nodes[i];
					if ( (_level == -1 || _level == _tmp.level)  && _tmp.syscode.startWith(_nodeSyscode))
					{
						_level = _tmp.level;
						_arr.add(_tmp.ID);
					}
				}
			}
		}
		else
		{	
			for(var i=0; i<___nodes.length; i++)
			{
				if (___nodes[i].level == _level)
					_arr.add(___nodes[i].ID);
			}
		}
					
		var items = new Array();
		for(var k=0; k<_arr.length; k++)
		{
			for(var i=0; i<___nodes.length; i++)
			{
				if (___nodes[i].ID == _arr[k])
				{		
					var itm = LEAP.TreeSelectBanner.__constructItemDef(___nodes[i], ___nodes[i].haschild, param);
					items.push(itm)
					
					if (param.data.style == 0 || _arr.length == 1)
						items = LEAP.TreeSelectBanner.__getChildItemDefine(_arr[k], items, false, param);
											
					break;
				}			
			}
		}
		
		return items;
	}
	finally
	{
		___nodes = _level = _arr = i = items = k= itm = null;
	}	
}


//取树子节点
LEAP.TreeSelectBanner.__getChildItemDefine = function(parentid, itemDefs, expandall, param)
{
	try
	{
		var childNodes =  LEAP.TreeSelectBanner.__getChildNode(parentid, param.data.nodes);
		if (childNodes == null)
			return itemDefs;

		for(var i=0; i<childNodes.length; i++)
		{
			var cNodes = LEAP.TreeSelectBanner.__getChildNode(childNodes[i].ID, param.data.nodes);
			var itm = null;				
			if (cNodes != null && (childNodes.length == 1 || param.data.style == 0 || expandall == true))
			{
				itm = LEAP.TreeSelectBanner.__constructItemDef(childNodes[i], false, param);
				itemDefs.push(itm);
				itemDefs = LEAP.TreeSelectBanner.__getChildItemDefine(childNodes[i].ID, itemDefs, expandall, param);
			}
			else //不完全展开的情况下遇到分支时停止展开
			{
				itm = LEAP.TreeSelectBanner.__constructItemDef(childNodes[i], childNodes[i].haschild, param);
				itemDefs.push(itm);
			}
		}
		
		return itemDefs;
	}
	finally
	{
		childNodes = i = cNodes = itm = null;
	}
}

LEAP.TreeSelectBanner.__constructItemDef = function(orgTreeNode, hasChild, param)
{
	try
	{
		var itm = new Object();
			itm.value = orgTreeNode.ID;
			itm.value2 = orgTreeNode.parentID;
			itm.value3 = orgTreeNode.syscode;
			itm.value4 = orgTreeNode.haschild;
			itm.value5 = orgTreeNode.isTip;
			itm.hasChild = hasChild;
			//ctrlimgs
			
			itm.showCheck = orgTreeNode.isTip;
			
			if (param.operationParam.treeSingleCheck == 0 && param.operationParam.autoCheckChilds == true)
			{
				itm.showCheck = true;
			}
			
			if (param.searchParam.nodetype == 15 || param.searchParam.nodetype == 3)
			{
				itm.value5 = true;
				itm.showCheck = true;
			}
			
							
			itm.syscode = orgTreeNode.syscode;				
			itm.text = orgTreeNode.remark;
			
		if (orgTreeNode.nodeType == 0)				
			itm.icon = 'LEAP/LWFP/images/wfrunning/Org.gif';
		else if (orgTreeNode.nodeType == 1)
			itm.icon = 'LEAP/LWFP/images/wfrunning/Role.gif';
		else if (orgTreeNode.nodeType == 2)	
			itm.icon = 'LEAP/LWFP/images/wfrunning/user.gif';
		else if (orgTreeNode.nodeType == 10)
			itm.icon = 'LEAP/LWFP/images/wfrunning/Org.gif';
		else if (orgTreeNode.nodeType == 11)			
			itm.icon = 'LEAP/LWFP/images/wfrunning/user.gif';
		
		return itm;
	}
	finally
	{
		itm = null;
	}
}

LEAP.TreeSelectBanner.__getChildNode = function(parentId, nodes)
{
	try
	{
		var nodesData = nodes;			
		var nodes = new Array();
		var hash = new hashtable();
		for(var i=0; i<nodesData.length; i++)
		{
			var _curnode = nodesData[i];
			if (_curnode.parentID == parentId)
			{				
				if (_curnode.nodeType == 2) //如果是用户，则查重并缓存索引
				{
					if (hash.contains(_curnode.orgObject.id) == true )
					{//重复的采用主岗位
						//if ( _curnode.orgObject.ismaster != null && _curnode.orgObject.ismaster ==1)	
						if ( _curnode.isMaster != null && _curnode.isMaster ==1)	
						{
							hash.remove(_curnode.orgObject.id);
							hash.add(_curnode.orgObject.id, _curnode.ID);
						}
					}
					else
					{
						hash.add(_curnode.orgObject.id, _curnode.ID);
					}
				}
				nodes.push(_curnode);
			}				
		}
					
		//根据索引过滤重复用户
		if (hash.count>0 && hash.count < nodes.length) 
		{
			var _nodes = new Array();
			for(var k=0; k<nodes.length; k++)
			{
				if (nodes[k].nodeType == 2)
				{	
					if (nodes[k].ID == hash.getvalue(nodes[k].orgObject.id) )
						_nodes.push(nodes[k]);
				}
				else
				{
					_nodes.push(nodes[k]);
				}
			}
				
			nodes = _nodes;	
		}
		
		if (nodes.length == 0)
			return null;
			
		return nodes;
		
	}
	finally
	{
		nodesData = nodes = hash = i = _curnode = _nodes = k = null;
	}
}

LEAP.TreeSelectBanner.__search = function(param, exParam)
{
	try
	{
		if (param.searchParam._searchFn)
		{
			return param.searchParam._searchFn.apply(param.searchParam._searchFnDomain, [{treeParam:param, lazyParam:exParam}]);
		}
		else
		{
			if (param.type == 0 || param.type == 4)
			{				
				var p = {organIds:  param.searchParam.organRanges,
						 roleNames:	param.searchParam.rolenameRanges,
						 excludeRoleNames:param.searchParam.excludeRolenameRanges,
						 excludeUserTypes:param.searchParam.excludeUserTypes,
						 excludeOrgans:param.searchParam.excludeOrgans,
						 includeOrganRange: (param.searchParam.includeOrganRange==1) ? true:false, 
						 organType:	param.searchParam.nodetype,						 
						 organLevels:	param.operationParam.treeLevels, 
						 style:	param.operationParam.treeStyle,	
						 singleCheck: param.operationParam.treeSingleCheck,						 
						 maxLevel	:null, 
						 topOrganRange:	(param.searchParam.topOrgan==0 ? false:true),						 						 
						 lazy: param.operationParam.lazy,
						 lazyId: param.operationParam.lazyId,
						 lazysyscode:	param.operationParam.lazySyscode,
						 lazyOut: param.operationParam.lazyOut?param.operationParam.lazyOut:false};
				
				if (exParam && exParam.lazy != null)
					p.lazy = exParam.lazy;
				if (exParam && exParam.lazyId != null)
					p.lazyId = exParam.lazyId;
				if (exParam && exParam.lazySyscode != null)
					p.lazysyscode = exParam.lazySyscode;
				if (exParam && exParam.lazyOut != null)
					p.lazyOut = exParam.lazyOut;					
					
				var rst = LEAP.routerRequest('WFConstructOrganTree', {param:p});
				
				return rst;
			}
			else if (param.type == 1)
			{			
				var p = {rootRanges: param.searchParam.rootRanges,
							 		categoryRanges: param.searchParam.categoryRanges,
							 		topOrgan: param.searchParam.topOrgan,	 		
							 		underAreaRange: param.searchParam.underAreaRange,	
							 		equalAreaRange: param.searchParam.equalAreaRange,	
							 		syscodeRange:  param.searchParam.syscodeRange,	
							 		includeSyscodeRange: param.searchParam.includeSyscodeRange,	
									nodetype: param.searchParam.nodetype,	
							 							 		
							 		treeStyle: param.operationParam.treeStyle,	
							 		treeLevels: param.operationParam.treeLevels,	
							 		treeSingleCheck: param.operationParam.treeSingleCheck,
							 		
							 		lazy: param.operationParam.lazy,
							 		lazyId: param.operationParam.lazyId,
							 		lazyOut: param.operationParam.lazyOut
							 	};
							 	
				if (exParam && exParam.lazy != null)
					p.lazy = exParam.lazy;
				if (exParam && exParam.lazyId != null)
					p.lazyId = exParam.lazyId;
				if (exParam && exParam.lazyOut != null)
					p.lazyOut = exParam.lazyOut;
					
				var rst = LEAP.routerRequest('WFConstructVirtualOrganTree', {param:p} );
				
				return rst;
			}
		}
		
		return null;
	}
	finally
	{
		p = rst = null;
	}
}

LEAP.TreeSelectBanner._onTreeItemInit = function(data)
{
	try
	{
		if (data == null || data.arg2 == null 
			|| data.arg2.value == null || data.arg2.item == null) 
			return;
			
		var element = LEAP._match(data.caller, LEAP.TreeSelectBanner.d);
		var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
		var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
		
		var lazyOut = false;
		if ( data._expandall != null &&  data._expandall == true)
			lazyOut = true;
			
		var parentItem = data.arg2.item;
		var parentId = data.arg2.value;
		var parentSyscode = data.arg2.value3;
		
		var idx = LEAP.tab.getSelectedIndex(tabCtrl);
		var tab = LEAP.tab.getItem(tabCtrl, idx);			
		var tree = LEAP.getElement("ul[ct=tree]", tab.tabcontent);
		var param = _treeParams[idx];
		
		if (param.operationParam.lazy == true)
		{
			var lazyChilds = LEAP.TreeSelectBanner.__search(param, {lazy:true,
						 		lazyId:parentId,
						 		lazySyscode:parentSyscode,
						 		lazyOut:lazyOut,
						 		___tabTitle:param.tabTitle,
						 		___authversion:param.___authversion
						 		});
			
			/*if (lazyChilds != null && lazyChilds.nodes != null)
			{				
				var _s = false;
				var _e = false;
				var _stmp = [];
				var _etmp = [];
				for(var i=0; i<param.data.nodes.length; i++)
				{
					var __node = param.data.nodes[i];
					if (__node.syscode.startsWith(parentSyscode))
					{
						if (_s == false)
							_stmp.push(__node);
							
						_s = true;												
						continue;
					}					
					else if (_s == true && _e == false)
					{
						_s = false;
						_e = true;
					}
										
					if (_s == false && _e == false)
						_stmp.push(__node);
					if (_e == true)
						_etmp.push(__node);
				}
				
				param.data.nodes = [];
				for(var i=0; i<_stmp.length; i++)
					param.data.nodes.push(_stmp[i]);
				for(var i=0; i<lazyChilds.nodes.length; i++)
					param.data.nodes.push(lazyChilds.nodes[i]);
				for(var i=0; i<_etmp.length; i++)
					param.data.nodes.push(_etmp[i]);
			}*/
						 		
			if (lazyChilds != null && lazyChilds.nodes != null)
			{
				var _s = false;
				var _e = false;
				var _stmp = [];
				var _etmp = [];
				for(var i=0; i<param.data.nodes.length; i++)
				{
					var __node = param.data.nodes[i];
					if (__node.syscode.startsWith(parentSyscode))
					{
						if (_s == false)
							_stmp.push(__node);
							
						_s = true;												
						continue;
					}					
					else if (_s == true && _e == false)
					{
						_s = false;
						_e = true;
					}
										
					if (_s == false && _e == false)
						_stmp.push(__node);
					if (_e == true)
						_etmp.push(__node);
				}
				
				var hash = new hashtable();
				param.data.nodes = [];
				for(var i=0; i<_stmp.length; i++)
				{
					if (!hash.contains(_stmp[i].ID))
					{
						param.data.nodes.push(_stmp[i]);
						hash.add(_stmp[i].ID, _stmp[i].ID);
					}
				}
				for(var i=0; i<lazyChilds.nodes.length; i++)
				{
					if (!hash.contains(lazyChilds.nodes[i].ID))
					{
						param.data.nodes.push(lazyChilds.nodes[i]);
						hash.add(lazyChilds.nodes[i].ID, lazyChilds.nodes[i].ID);
					}
				}
				for(var i=0; i<_etmp.length; i++)
				{
					if (!hash.contains(_etmp[i].ID))
					{
						param.data.nodes.push(_etmp[i]);
						hash.add(_etmp[i].ID, _etmp[i].ID);
					}
				}
			}
		}
				
		var itms = [];
		itms = LEAP.TreeSelectBanner.__getChildItemDefine(parentId, itms, data._expandall, param);
		LEAP.tree.addItems(tree, parentItem, itms);
		
		LEAP.TreeSelectBanner._syncChecked(element);
	}
	finally
	{
		element = tabCtrl = _treeParams = lazyOut = parentItem = parentId = 
		parentSyscode = idx = tab = tree = param = lazyChilds = _s = 
		_e = _stmp = _etmp = i = __node = itms = null;
	}
}

LEAP.TreeSelectBanner._onTreeItemClick = function(data)
{
	try
	{
		var item = data.arg2.item;
				
		if (data.arg2.value5 == "true")
		{//itm.value5 = orgTreeNode.isTip;
			var checked = LEAP.tree.isChecked(data.caller, item);
			LEAP.tree.setItemChecked(data.caller, item, !checked, true);
		}
		
		if (data.arg2.value4 == "true")
		{
			LEAP.tree.expandNode(item);
		}		
		
	}
	finally
	{
		item = checked;
	}
}

LEAP.TreeSelectBanner._onTreeCheckedChanged = function(data)
{
	try
	{
		var element = LEAP._match(data.caller, LEAP.TreeSelectBanner.d);
		var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
		var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
		
		var idx = LEAP.tab.getSelectedIndex(tabCtrl);
		var tab = LEAP.tab.getItem(tabCtrl, idx);			
		var tree = LEAP.getElement("ul[ct=tree]", tab.tabcontent);
		var param = _treeParams[idx];
		
		var curItem = data.arg2.item;
		var curNodeValue = LEAP.tree.getValue(curItem);
		var checked = data.arg2.checked;
		
		if ( param.operationParam.treeSingleCheck == 1) //如果单选
		{
			if (true == checked)
			{
				var checkedItems = LEAP.tree.getCheckedItems(tree);		
				if (checkedItems != null && checkedItems.length>0)
				{
					for(var i=0; i<checkedItems.length; i++)
					{
						var tempNodeValue = LEAP.tree.getValue(checkedItems[i]);
						if (curNodeValue != tempNodeValue)
							LEAP.tree.setItemChecked(tree, checkedItems[i], false); 
						
						tempNodeValue = null;
					}					
				}
				
				//维护选中清单
				var node = LEAP.TreeSelectBanner.__findNode(param.data.nodes, curNodeValue);
				LEAP.TreeSelectBanner.__selectedList_add(element, [node], true);
			}
			else
			{
				LEAP.TreeSelectBanner.__selectedList_remove(element, [curNodeValue]);
			}
		}
		else //多选
		{	
			if (param.searchParam.nodetype == 15 || param.searchParam.nodetype == 3)
			{
				if (true == checked)
				{
					var node = LEAP.TreeSelectBanner.__findNode(param.data.nodes, curNodeValue);
					LEAP.TreeSelectBanner.__selectedList_add(element, [node], false);
				}
				else
				{
					LEAP.TreeSelectBanner.__selectedList_remove(element, [curNodeValue]);
				}		
			}
			else
			{
				var ___flag = false;
				if (true == checked)
				{
					if (data.arg2.value4 == "true")
					{
						___flag = true;
						
						if (param.operationParam.autoCheckChilds == true)
						{
							LEAP.tree.removeChilds(tree, curItem);		
							var __arg = {caller:data.caller, arg2:data.arg2, _expandall:true};
							LEAP.TreeSelectBanner._onTreeItemInit(__arg);		
							
							if (data.arg2.value5 == "true") 
							{//当前为叶子节点则默认不自动选中儿子，除非autoCheckTipChilds == true
								if (param.operationParam.autoCheckTipChilds == true)
								{
									LEAP.tree.setItemChildChecked(tree, curItem, true);
								}
								else
								{
									LEAP.tree.setItemChecked(tree, curItem, true);
								}
							}
							else
							{
								LEAP.tree.setItemChildChecked(tree, curItem, true);
							}
						}
						else
						{
							var c = LEAP.tree.getChild(curItem);
							if (c == null)
							{
								var __arg = {caller:data.caller, arg2:data.arg2, _expandall:false};
								LEAP.TreeSelectBanner._onTreeItemInit(__arg);
							}
								
							LEAP.tree.setItemChecked(tree, curItem, true); 
						}
					}
					
					if (param.operationParam.allowMutiLevelCheck == false)
					{
						LEAP.TreeSelectBanner.__removeOtherLevelChecked(element, tree, data.arg2.item);
					}
				}
				else
				{
					if (param.operationParam.autoCheckChilds == true)
					{	
						//取消儿子
						LEAP.tree.setItemChildChecked(tree, curItem, false);
						//取消自己				
						LEAP.tree.setItemChecked(tree, curItem, false);								
						LEAP.TreeSelectBanner.__selectedList_remove(element, [LEAP.tree.getValue(curItem)]);
						//取消父亲
						var tmpitem = LEAP.tree.getParent(curItem);
						while (tmpitem)
						{
							var __value = LEAP.tree.getValue2(tmpitem, tree);
							if (__value.value == false) //父级是叶子节点的略过
							{
								LEAP.tree.setItemChecked(tree, tmpitem, false);								
								LEAP.TreeSelectBanner.__selectedList_remove(element, [__value.value]);
							}
							
							tmpitem = LEAP.tree.getParent(tmpitem);
						}

					}
					else
					{
						LEAP.tree.setItemChecked(tree, curItem, false);
					}
						
				}								
				
				//维护选中清单
				if (param.operationParam.autoCheckChilds == true)
				{	
					if (true == checked)
					{
						var _vs = LEAP.TreeSelectBanner.__getAllCheckedChildsValues(tree, curItem, true);						
						var _v = [];
						for(var i=0; i<_vs.length; i++)
						{
							var node = LEAP.TreeSelectBanner.__findNode(param.data.nodes, _vs[i].value);
							if (node.isTip == true)
							{	
								if (param.operationParam.excludeSelfChild == true && ___flag == true && node.nodeType == 2 && LEAP.getUserInfo().userid == node.userId)								
								{//不选自己
									var _itm = LEAP.tree.getItemByValue(tree, _vs[i].value);
									LEAP.tree.setItemChecked(tree, _itm, false, false);
									continue;
								}
								
								_v.push(node);
							}
						}
						
						LEAP.TreeSelectBanner.__selectedList_add(element, _v, false);
					}
					else
					{
						var _vs = LEAP.tree.getAllChildValues(tree, curItem, true);
						var _v = [];
							_v.add(curNodeValue);
							
						for(var i=0; i<_vs.length; i++)						
						{
							if (_vs[i].value5 == 'true')
								_v.add( _vs[i].value );
						}

						LEAP.TreeSelectBanner.__selectedList_remove(element, _v);
					}					
				}
				else
				{
					if (true == checked)
					{
						var node = LEAP.TreeSelectBanner.__findNode(param.data.nodes, curNodeValue);
						LEAP.TreeSelectBanner.__selectedList_add(element, [node], false);
					}
					else
					{
						LEAP.TreeSelectBanner.__selectedList_remove(element, [curNodeValue]);
					}				
				}
			}			
		}
		
		LEAP.TreeSelectBanner.__bindSlectedList(element);
	}
	finally
	{		
		element = tabCtrl = _treeParams = idx = tab = tree = param = curItem = curNodeValue = 
		checked = checkedItems = i = tempNodeValue = node = node = c = tmpitem = _vs = _v = node = 
		_vs = _v = i = node = __arg = null;
	}
}

LEAP.TreeSelectBanner.__removeOtherLevelChecked = function(element, tree, item)
{
	try
	{
		var vs = [];
		var childs = LEAP.tree.getAllChildValues(tree, item, false);
		if (childs != null)
		{
			for(var i=0; i<childs.length; i++)
			{
				vs.push(childs[i].value);
				LEAP.tree.setItemChecked(tree, childs[i].item, false);
			}
		}
		
		var itm = item;
		while (itm != null)
		{
			itm = LEAP.tree.getParent(itm);
			var value = LEAP.tree.getValue(itm);
			LEAP.tree.setItemChecked(tree, itm, false);
			
			vs.push(value);
		}
		
		if (vs.length > 0)
			LEAP.TreeSelectBanner.__selectedList_remove(element, vs);
	}
	finally
	{
		vs = childs = i = itm = value = null;
	}
}

LEAP.TreeSelectBanner.__getAllCheckedChildsValues = function(tree, item, inludeCurrentItem)
{
	try
	{
		var arr1 = LEAP.tree.getCheckedValues(tree);
		var arr2 = LEAP.tree.getAllChildValues(tree, item, inludeCurrentItem);
		
		if (arr1 == null || arr2 == null)
			return null;
		
		var hash = new hashtable();
		for(var i=0; i<arr1.length; i++)
			hash.add(arr1[i], arr1[i]);
			
		var rst = [];
		for(var i=0; i<arr2.length; i++)
		{
			if (hash.contains(arr2[i].value))
				rst.add(arr2[i]);
		}
		
		return rst;
	}
	finally
	{
		arr1 = arr2 = hash = i = rst = i = null;
	}		
}	
	
LEAP.TreeSelectBanner.__findNode = function(nodes, id)
{
	if (nodes == null || nodes.length == 0)
		return null;
	
	for(var i=0; i<nodes.length; i++)
	{
		if (nodes[i].ID == id)
			return nodes[i];
	}		
	
	i = null;
	
	return null;
}

LEAP.TreeSelectBanner._onFrequentcontactClear = function(arg)
{
	try
	{
		var rst = LEAP.routerRequest('clearFrequentContact', {delegate: null} );
		if (true == rst)
		{
			var tab_content = LEAP._match(arg.caller, 'tab_content', 'ctf');
			var checkBoxList = LEAP.getElement("div[ct=checkbox2]", tab_content);		
			
			LEAP.checkbox2.clearItems(checkBoxList);
		}
	}
	finally
	{
		rst = tab_content = checkBoxList = null;
	}
}

LEAP.TreeSelectBanner._onCheckListValueChange = function(arg)
{
	try
	{	
		var element = LEAP._match(arg.caller, LEAP.TreeSelectBanner.d);
		var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
		var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
		
		var idx = LEAP.tab.getSelectedIndex(tabCtrl);
		var tab = LEAP.tab.getItem(tabCtrl, idx);	
		var param = _treeParams[idx];
		
		var checkBoxList =  LEAP.getElement("div[ct=checkbox2]", tab.tabcontent);	
		
		var _new = arg.arg2.newvalue;
		var _old = arg.arg2.oldvalue;
		var _rst = _new;
		
		var arr_remove = [];		
		if (_old != null)
		{
			var _arr_old = _old.split(",");
			var _arr_new = null;
			if (_new != null)
				_arr_new = _new.split(",");
				
			for(var i=0; i<_arr_old.length; i++)
			{
				var _tmp = _arr_old[i];
				if (_tmp == "")
					continue;
					
				var _flag = true;
				if (_arr_new != null)
				{
					for(var k=0; k<_arr_new.length; k++)
					{
						if (_tmp == _arr_new[k])
						{
							_flag = false;
							break;
						}
					}					
				}
				
				if (_flag == true)
				{
					arr_remove.add(_tmp);
				}				
			}			
		}
	
		
		LEAP.TreeSelectBanner.__selectedList_remove(element, arr_remove);
		
		if (_rst != null)
		{
			var arr = LEAP.checkbox2.getCheckedItemElements2(checkBoxList);
			var _arr = [];
			for(var i=0; i<arr.length; i++)
			{
				var node = arr[i]["_data"];
				var _node = LWFP.innerApi.clone(node);
				var __idx = node.remark.lastIndexOf(".");
				if (__idx >= 0)
				{
					_node.remark = _node.remark.substring(__idx + 1);
				}
				
				_arr.add(_node);				
			}
			
			LEAP.TreeSelectBanner.__selectedList_add(element, _arr, param.operationParam.treeSingleCheck == 1?true:false);
		}
		
		LEAP.TreeSelectBanner.__bindSlectedList(element);
	}
	finally
	{
		element = tabCtrl = _treeParams = idx = tab = param = checkBoxList =  _new = 
		_old = _rst = _arr = arr = _arr = i = node = _node = __idx = null;
	}
}



LEAP.TreeSelectBanner._layer_init = function(element, tab, param)
{
	try
	{
		tab.tabcontent.innerHTML = "";
		
		var nodes = LEAP.TreeSelectBanner._layer_getIntiNodes(param.operationParam.rootNodeSyscode, param);
		if (nodes == null)
			return;
		
		var layer = LEAP.TreeSelectBanner._layer_appendLayer(tab, 0, param);
		
		//LEAP.TreeSelectBanner._layer_bindLayer(layer, nodes, param);
		LEAP.asyn(LEAP.TreeSelectBanner._layer_bindLayer, this, 10, layer, nodes, param);
		
		LEAP.asyn(LEAP.TreeSelectBanner._layer_syncChecked, this, 100, element, tab.tabcontent);
	}
	finally
	{
		nodes = null;
	}
}

LEAP.TreeSelectBanner._layer_getIntiNodes = function(rootSyscode, param)
{
	try
	{
		var arr = [];
		var ___nodes = param.data.nodes;
		var _rootSyscode = ___nodes[0].syscode;
		
		if (rootSyscode != null)
		{//有可能当前级的节点没有到客户端，根据syscode查找匹配项，可能同级多根，所以需要全遍历
			var _rootNodeSyscode_ = null;			
			for(var i = 0; i<___nodes.length; i++)
			{
				var _tmp = ___nodes[i];
				if (_tmp.syscode == rootSyscode)
				{
					_rootNodeSyscode_ = rootSyscode;
					break;
				}
			}
			
			if (_rootNodeSyscode_ == null)
			{
				for(var i = 0; i<___nodes.length; i++)
				{
					var _tmp = ___nodes[i];
					if (_tmp.syscode.startWith(rootSyscode))
					{
						_rootNodeSyscode_ = _tmp.syscode.substring(0, _tmp.syscode.length - 3);
						break;
					}
				}
			}
			
			_rootSyscode = _rootNodeSyscode_;
		}
		
		if (_rootSyscode != null)
		{	
			var len = _rootSyscode.length + 3;
			if (_rootSyscode.indexOf(".") < 0)
				len = len + 1;
				
			for(var i=0; i<___nodes.length; i++)
			{
				var _tmp = ___nodes[i];
				if (_tmp.syscode.length == len && _tmp.syscode.startWith(_rootSyscode) )
				{
					arr.add(_tmp);
				}
			}
		}		
		
		if (arr.length == 0)
			return null;
		
		return arr;
	}
	finally
	{
		arr = ___nodes = _rootSyscode = _rootNodeSyscode_ = i = _tmp = null;
	}	
}

LEAP.TreeSelectBanner._layer_checkboxTemplate = '<div class="LC_checkbox LC_circle" style="display:inline-block;" ctf="checkbox2_item" moduletype="1">' +
													//'<span ctf="otherbox" class="TreeSelectBanner_layer_chk_blank">s</span>' +
													'<input type="checkbox" ctf="checkbox2_input">' +
													'<span ctf="checkbox2_span"></span>' +
													'<label ctf="checkbox2_label">模板</label>' +
												'</div>';
LEAP.TreeSelectBanner._layer_appendLayer = function(tab, level, param)
{	
	try
	{
		var layer = LEAP.getElement("[" + LEAP.TreeSelectBanner.symbol.layer_level + "=" + level + "]", tab.tabcontent);
		if (layer == null)
		{	
			layer = document.createElement("div");
			layer.className = "TreeSelectBanner_layer";
			layer.setAttribute(LEAP.TreeSelectBanner.symbol.TSBCTF, LEAP.TreeSelectBanner.symbol.layer);
			layer.setAttribute(LEAP.TreeSelectBanner.symbol.layer_level, level);
			
			var chk_tip = document.createElement("div");
				chk_tip.setAttribute(LEAP.TreeSelectBanner.symbol.TSBCTF, LEAP.TreeSelectBanner.symbol.layer_chk_tip);
				chk_tip.setAttribute("ct", LEAP.checkbox2.d);
				chk_tip.setAttribute("radio", param.data.singleCheck);
				chk_tip.className = "LC_checkbox_wrap";		
				chk_tip.style.margin = "5px 10px 5px 10px";
			
			var chk_org = document.createElement("div");
				chk_org.setAttribute(LEAP.TreeSelectBanner.symbol.TSBCTF, LEAP.TreeSelectBanner.symbol.layer_chk_org);
				chk_org.setAttribute("ct", LEAP.checkbox2.d);
				chk_org.setAttribute("radio", 1);
				chk_org.className = "LC_checkbox_wrap";
				chk_org.style.margin = "5px 10px 5px 10px";
				chk_org.innerHTML = LEAP.TreeSelectBanner._layer_checkboxTemplate;
			
			layer.appendChild(chk_org);
			layer.appendChild(chk_tip);
			
			tab.tabcontent.appendChild(layer);
			
			LEAP.addEvent(chk_tip, 'clickItem', LEAP.TreeSelectBanner._layer_chkItemClick);
			LEAP.addEvent(chk_org, 'clickItem', LEAP.TreeSelectBanner._layer_chkItemClick);
		}
		
		return layer;	
	}
	finally
	{
		layer = chk_tip = chk_org = null;
	}
}

LEAP.TreeSelectBanner._layer_bindLayer = function(layer, nodes, param)
{
	try
	{
		var chk_tip = LEAP.getElement("[" + LEAP.TreeSelectBanner.symbol.TSBCTF + "=" + LEAP.TreeSelectBanner.symbol.layer_chk_tip +"]", layer);
		var chk_org = LEAP.getElement("[" + LEAP.TreeSelectBanner.symbol.TSBCTF + "=" + LEAP.TreeSelectBanner.symbol.layer_chk_org +"]", layer);
		chk_tip.style.display = "block";
		chk_org.style.display = "block";
		
		LEAP.checkbox2.clearItems(chk_tip);
		LEAP.checkbox2.clearItems(chk_org);
		
		var hasTip = false;
		var hasOrg = false;	
		if (nodes != null)
		{		
			layer.style.display = "block";
		
			//var N = Math.floor(layer.clientWidth / 120);
			//var W = Math.floor(layer.clientWidth / N);
			var N = 3;
			var W = Math.floor( (chk_tip.clientWidth - 10) / N) - 30;
			
			
			for(var i=0; i<nodes.length; i++)
			{
				var node = nodes[i];
				
				if (node.haschild == false && node.isTip == true)
				{
					var itm = LEAP.checkbox2.addItem(chk_tip, node.remark, node.ID, false, node);
					itm.className = "LC_checkbox TreeSelectBanner_layer_check";
					
					itm.style.width = W + "px";
					var label = LEAP.getElement("label", itm);
						label.style.width = W + "px";
						
					hasTip = true;
				}
				else if (node.haschild == true)
				{				
					var itm = LEAP.checkbox2.addItem(chk_org, node.remark, node.ID, false, node);
						itm.className = "LC_checkbox TreeSelectBanner_layer_radio_item TreeSelectBanner_layer_check";
					
					itm.style.width = W + "px";
					var label = LEAP.getElement("label", itm);
						label.style.width = W + "px";
					
					hasOrg = true;
				}				
			}
		}
		
		chk_tip.style.display = ((hasTip == false)?"none":"block");
		chk_org.style.display = ((hasOrg == false)?"none":"block");
	}
	finally
	{
		chk_tip = chk_org = N = W = flag = i = node = itm = null;	
	}
}

LEAP.TreeSelectBanner._layer_chkItemClick = function(arg)
{
	try
	{
		var node = arg.arg2.data;
		
		if (node.haschild == true)
		{//非叶子节点
			var item = arg.arg2.item;
			var layer =  LEAP._match(item, LEAP.TreeSelectBanner.symbol.layer, LEAP.TreeSelectBanner.symbol.TSBCTF);
			
			LEAP.TreeSelectBanner._layer_expand(layer, node, false);
		}
		else if (node.isTip == true)
		{//叶子节点
			var element = LEAP._match(arg.caller, LEAP.TreeSelectBanner.d);
			var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
			var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
			
			var idx = LEAP.tab.getSelectedIndex(tabCtrl);
			var tab = LEAP.tab.getItem(tabCtrl, idx);
			var param = _treeParams[idx];
			var checked = arg.arg2.checked;
			
			if ( param.operationParam.treeSingleCheck == 1) //如果单选
			{
				var node = arg.arg2.data;
				if (true == checked)
				{
					LEAP.TreeSelectBanner.__selectedList_add(element, [node], true);
				}
				else
				{
					LEAP.TreeSelectBanner.__selectedList_remove(element, [node.ID]);
				}			
			}
			else //多选
			{
				var node = arg.arg2.data;
				if (true == checked)
				{
					LEAP.TreeSelectBanner.__selectedList_add(element, [node], false);
				}
				else
				{
					LEAP.TreeSelectBanner.__selectedList_remove(element, [node.ID]);
				}
			
			
			}
			
			LEAP.TreeSelectBanner.__bindSlectedList(element);		
		}
	}
	finally
	{
		node = item = layer =  element = tabCtrl = _treeParams = idx = tab = param = checked = null;
		
	}
	
}

LEAP.TreeSelectBanner._layer_expand = function(parentLayer, parentNode, expandall)
{
	try
	{			
		var element = LEAP._match(parentLayer, LEAP.TreeSelectBanner.d);
		var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
		var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
		var idx = LEAP.tab.getSelectedIndex(tabCtrl);
		var tab = LEAP.tab.getItem(tabCtrl, idx);			
		var param = _treeParams[idx];
		
		var lazyOut = ((expandall == true)?true:false);		
		var parentId = parentNode.ID;
		var parentSyscode = parentNode.syscode;
		
		//获取懒加载数据
		if (param.operationParam.lazy == true)
		{
			var lazyChilds = LEAP.TreeSelectBanner.__search(param, {lazy:true,
						 		lazyId:parentId,
						 		lazySyscode:parentSyscode,
						 		lazyOut:lazyOut,
						 		___tabTitle:param.tabTitle,
						 		___authversion:param.___authversion
						 		});
						 		
			if (lazyChilds != null && lazyChilds.nodes != null)
			{
				var _s = false;
				var _e = false;
				var _stmp = [];
				var _etmp = [];
				for(var i=0; i<param.data.nodes.length; i++)
				{
					var __node = param.data.nodes[i];
					if (__node.syscode.startsWith(parentSyscode))
					{
						if (_s == false)
							_stmp.push(__node);
							
						_s = true;												
						continue;
					}					
					else if (_s == true && _e == false)
					{
						_s = false;
						_e = true;
					}
										
					if (_s == false && _e == false)
						_stmp.push(__node);
					if (_e == true)
						_etmp.push(__node);
				}
				
				var hash = new hashtable();
				param.data.nodes = [];
				for(var i=0; i<_stmp.length; i++)
				{
					if (!hash.contains(_stmp[i].ID))
					{
						param.data.nodes.push(_stmp[i]);
						hash.add(_stmp[i].ID, _stmp[i].ID);
					}
				}
				for(var i=0; i<lazyChilds.nodes.length; i++)
				{
					if (!hash.contains(lazyChilds.nodes[i].ID))
					{
						param.data.nodes.push(lazyChilds.nodes[i]);
						hash.add(lazyChilds.nodes[i].ID, lazyChilds.nodes[i].ID);
					}
				}
				for(var i=0; i<_etmp.length; i++)
				{
					if (!hash.contains(_etmp[i].ID))
					{
						param.data.nodes.push(_etmp[i]);
						hash.add(_etmp[i].ID, _etmp[i].ID);
					}
				}
			}
		}
		
		//下级节点
		var childNodes = LEAP.TreeSelectBanner.__getChildNode(parentId, param.data.nodes);
		var parentLevel = parseInt(parentLayer.getAttribute(LEAP.TreeSelectBanner.symbol.layer_level));
		var childLevel =  parentLevel + 1;
		
		var layer = LEAP.TreeSelectBanner._layer_appendLayer(tab, childLevel, param);
		for(var i=childLevel; i<10; i++)
		{
			var _layer = LEAP.getElement("[" + LEAP.TreeSelectBanner.symbol.layer_level + "=" + i + "]", tab.tabcontent);
			if (_layer)
			{
				_layer.style.display = "none";
			}
		}
		
		LEAP.TreeSelectBanner._layer_bindLayer(layer, childNodes, param);
		
		LEAP.TreeSelectBanner._layer_syncChecked(element, tab.tabcontent);
	}
	finally
	{		
		element = tabCtrl = _treeParams = idx = tab = param = lazyOut = parentId = parentSyscode = lazyChilds = _s = _e = 
		_stmp = _etmp = i = hash = i = childNodes = parentLevel = childLevel = layer = null;
	}	
}

LEAP.TreeSelectBanner._layer_syncChecked = function(element, tab)
{
	try
	{
		var chk_tips = LEAP.getElements("[" + LEAP.TreeSelectBanner.symbol.TSBCTF + "=" + LEAP.TreeSelectBanner.symbol.layer_chk_tip +"]", tab);
		if (chk_tips)
		{
			var nodes = element[LEAP.TreeSelectBanner.symbol.selectedItems];
			for(var i=0; i<chk_tips.length; i++)
			{
				var chk = chk_tips[i];
				LEAP.checkbox2.checkedAll(chk, false);
				
				if (nodes != null)
				{
					for(var k=0; k<nodes.length; k++)
					{
						var node = nodes[k];
						LEAP.checkbox2.setItemChecked(chk, node.ID, true, false);
					}
				}
			}
		}
		
	}
	finally
	{
		
	}
}








LEAP.TreeSelectBanner.__selectedList_add = function(element, nodes, clearFirst)
{
	try
	{
		var items = LWFP.innerApi.clone(element[LEAP.TreeSelectBanner.symbol.selectedItems]);
		if (items == null)
			items = [];
		
		if (clearFirst == true)
			items = [];
		
		for(var i=0; i<nodes.length; i++)
		{
			var node = nodes[i];
			
			var flag = true;
			for(var k=0; k<items.length; k++)
			{
				if (items[k].ID == node.ID)
				{
					flag = false;
					break;
				}
			}
			
			if (flag ==  true)
				items.add(node);

		}
		
		//element[LEAP.TreeSelectBanner.symbol.selectedItems] = items; //缓存清单
		LEAP.TreeSelectBanner.__cacheValue(element, items, true);
	}
	finally
	{
		items = i = node = flag = k = null;
	}
}

LEAP.TreeSelectBanner.__selectedList_remove = function(element, nodeIDs)
{
	try
	{
		var items = LWFP.innerApi.clone(element[LEAP.TreeSelectBanner.symbol.selectedItems]);
		if (items != null && items.length>0)
		{
			for(var k=0; k<nodeIDs.length; k++)
			{
				var ID = nodeIDs[k];				
				for(var i=items.length-1; i>-1; i--)
				{
					var _ID = items[i].ID;
					if (_ID == ID)
					{
						items.removeindex(i);
						break;
					}
				}
			}
		}
		
		//element[LEAP.TreeSelectBanner.symbol.selectedItems] = items; //缓存清单
		LEAP.TreeSelectBanner.__cacheValue(element, items, true);
	}
	finally
	{
		items = k = ID = i =_ID = null;
	}
}

LEAP.TreeSelectBanner.__bindSlectedList = function(element)
{
	try
	{
		var itemCtrl = LEAP.TreeSelectBanner.__getItemCtrl(element);
		
		if (itemCtrl != null)
		{
			LEAP.item.clearItem(itemCtrl);			
			var nodes = element[LEAP.TreeSelectBanner.symbol.selectedItems];
			var rst = nodes;
			if (nodes != null && nodes.length >0)
			{
				var arr = [];
				var hash = new hashtable();
				for(var i=nodes.length-1; i>-1; i--)
				{				
					var node = nodes[i];
					if (node.nodeType == 2 )
					{
						if (node.userId == null && node.orgObject && node.orgObject.id)
							node.userId = node.orgObject.id;
						
						if (hash.contains(node.userId) &&  (false != LEAP.TreeSelectBanner.filtDuplicate))
							continue;
						hash.add(node.userId, node);
					}

					arr.unshift(node);
				}
				
				rst = arr;
			}			
			
			//不排序，因为可能需要按勾选顺序			
			LEAP.item.setValue(itemCtrl, rst, "remark", true);	
			element[LEAP.TreeSelectBanner.symbol.selectedItems] = rst;
		}
	}
	finally
	{
		itemCtrl = nodes = null;
	}
}

LEAP.TreeSelectBanner._OnRemoveSelecteItem = function(arg)
{
	try
	{
		var element = LEAP.TreeSelectBanner.__getBannerCTrl(arg.caller);
		if (element)
		{
			var items = LWFP.innerApi.clone(element[LEAP.TreeSelectBanner.symbol.selectedItems]);
			
			var flag = false;
			if (items != null)
			{
				for(var i = items.length-1; i>-1; i--)
				{
					var item = items[i];
					if (item.ID == arg.arg2.data.ID)
					{
						items.removeindex(i);
						flag = true;
						break;
					}
				}
			}		
			
			if (flag == true)
			{
				//element[LEAP.TreeSelectBanner.symbol.selectedItems] = items;
				LEAP.TreeSelectBanner.__cacheValue(element, items, true);
				LEAP.TreeSelectBanner._syncChecked(element);		
			}
		}
	}
	finally
	{
		element = items = flag = i = item = null;
	}	
}
	
LEAP.TreeSelectBanner._syncChecked = function(element)
{
	try
	{
		var tabCtrl = LEAP.TreeSelectBanner.__getTabCtrl(element);
		var _treeParams = LEAP.TreeSelectBanner.__getParams(element);		
		var items = element[LEAP.TreeSelectBanner.symbol.selectedItems];
		var v = [];
		if (items != null)
		{
			for(var i=0; i<items.length; i++)
				v.add(items[i].ID);
		}
		
		var idx = LEAP.tab.getSelectedIndex(tabCtrl);
		var tab = LEAP.tab.getItem(tabCtrl, idx);			
		
		var param = _treeParams[idx];	
		if (param != null)
		{
			if (param.type == 4)
			{
				LEAP.TreeSelectBanner._layer_syncChecked(element, tab.tabcontent);
			}
			else if (param.type == 3)
			{
				var chkbox = LEAP.getElement("div[ct=checkbox2]", tab.tabcontent);			
				LEAP.checkbox2.setDisabled(chkbox, false);			
				LEAP.checkbox2.setValue(chkbox, LWFP.innerApi.Arr2String(v, ','));
			}
			else
			{			
				var tree = LEAP.getElement("ul[ct=tree]", tab.tabcontent);
				if (false == LEAP.TreeSelectBanner.filtDuplicate)
				{
					LEAP.tree.setCheckedItems(tree, v);	
				}
				else
				{
					var matchV = LEAP.TreeSelectBanner.__matchTreeValueByOrganNode(tree, items);
					LEAP.tree.setCheckedItems(tree, matchV);	
				}
			}	
		}
	}
	finally
	{
		tabCtrl = _treeParams = items = v = i = idx = tab = param = chkbox = tree = null;
	}
}

LEAP.TreeSelectBanner.__matchTreeValueByOrganNode = function(tree, nodes)
{
	var rst = [];
	var values = LEAP.tree.getAllChildValues(tree)
	if (values != null && nodes != null)
	{
		for(var i=0; i<values.length; i++)
		{
			var val = values[i].value ;
			for(var k=0; k<nodes.length; k++)
			{
				var node = nodes[k];
				if (node.ID == val)
				{
					rst.add(val);
					break;
				}
				else if (node.nodeType == 2 && node.orgObject && node.orgObject.id && val.indexOf(node.orgObject.id) > -1)
				{
					rst.add(val);
					break;
				}
			}			
		}
	}
	
	return rst;	
}

LEAP.TreeSelectBanner.i = function(wait, src)
{
	try
	{
		if (!src)
		{
			if (!event)
				return;
			src = event.srcElement;
		}
		if (!src)
			return;
		
		var module = null;
		var instance = src.parentElement.getAttribute("instance");
		if (instance)
			module = PageObjectModel.getModule(instance);
		
		if (!instance || !module)//(LEAPBrowser.isIE && (!instance || !module))
		{
			if (!wait || wait==0)
				wait = 100;
			var fn = function()
			{
				LEAP.TreeSelectBanner.i(wait, src);
				src = null;
			};
			setTimeout(fn, wait);
			return;
		}
	
		LEAP.TreeSelectBanner._i(src.parentElement);
		src.parentElement.removeChild(src);
		src = null;
	}
	finally
	{
		module = instance = null;
	}
}

LEAP.TreeSelectBanner._i = function(element)
{
	try
	{	
		LEAP.TreeSelectBanner.___registIitemCtrl(element);
		/*var itemCtrl = LEAP.TreeSelectBanner.__getItemCtrl(element);
		if (itemCtrl != null)
			LEAP.addEvent(itemCtrl, 'removeItem', LEAP.TreeSelectBanner._OnRemoveSelecteItem);		*/	
		
		LEAP.TreeSelectBanner._initBannerTabUI(element);	
	}
	finally
	{
		//itemCtrl = null;
	}
}

LEAP.TreeSelectBanner.___registIitemCtrl = function(element)
{
	try
	{			
		var itemCtrl = LEAP.TreeSelectBanner.__getItemCtrl(element);
		if (itemCtrl != null)
		{
			if (!itemCtrl.getAttribute("__hasRegistTreeSelectBanner"))
			{
				LEAP.addEvent(itemCtrl, 'removeItem', LEAP.TreeSelectBanner._OnRemoveSelecteItem);	
				itemCtrl.setAttribute("__hasRegistTreeSelectBanner", 1);
			}
		}
	}
	finally
	{
		itemCtrl = null;
	}	
}

LEAP.TreeSelectBanner.popContainerHTML = "<div ct='TreeSelectBanner' style='float:left; width:100%; height:100%;'>" +
											"<div class='LC_tab2 lg_p2_tb' ct='tab' tsb='TSB_tabctrl' onresize='LEAPLG.tb();' lctt='top'>" +
												"<div class='lg_p2_tb_top LC_tab2_box' onresize='LEAPLG.tb_layout(0);' style='border:none;'>" +
													"<ul>" +
														"<li class='hover' ctf='tab_label'></li>" +
													"</ul>" +
													"<div ctf='popclose' class='TreeSelectBanner_pop_closeButton'></div>" +
												"</div>" +
												"<div class='lg_p2_tb_bottom LC_tab2_Contentbox' style='top: 34px; border-top:1px solid #CCC; width:100%;'>" +                  
													"<div class='LC_tab2_item sel' ctf='tab_content'>" +
													"</div>" +
												"</div>" +
												"<img style='display: none;' onerror='LEAPLG.tb_img(0);' src='data:image:png,base64'>" +
											"</div>" +
											"<img style='display: none;' onerror='LEAP.TreeSelectBanner.i(20);' src='data:image:png,base64'>" +
										"</div>" +
										"<div ctf='div_search' style='height:40px;width:100%;float:left;'> " +										
											"<div class='divlayoutcon' style='width:96%; height:32px; margin:2px 2% 2px 2%; border-radius:5px; border:1px solid #ccc;'> " +
												"<div class='lc_layout_p_con'> " +
													"<div ccct='searchbtn' class='lc_layout_lr' style='width:50px; height:20px; line-height:19px;float:right; font-size:14px; color:#3293e5; padding:0px 0px 0px 0px; margin:6px 4px 4px 4px; text-align:center; border-radius:10px; border:1px solid #1e88e5; cursor:pointer;' >搜索</div> " +			
													"<div nnnnnnn=1 class=' lc_layout_lr_p' style='right: 57px; float:none; margin-left:2px;'> " +
														"<div pppppp=1 class='LC_input_placeholder LC_input_conner' style='border:none;display:block;'> " +
															"<input ccct='searchinput' ht='input' ctef='input3' type='text' lcv='2'/> " +
															"<label class='LC_input_placeholder_label' style='color:#999;'>输入关键字后回车</label> " +
														"</div> " +
													"</div> " +
												"</div> " +
											"</div> " +
										"</div>" +
										"<iframe ctf='iframebackground' src='javascript:false' style='left: 0px; top: 0px; width: 100%; height: 100%; border:none; visibility: inherit; position: absolute; z-index: -1; filter:alpha(opacity=0); ' sandbox='allow-same-origin allow-scripts allow-top-navigation allow-forms'></iframe>" ;

LEAP.TreeSelectBanner.popContainer = null;
LEAP.TreeSelectBanner.popup = function(module, par)
{//{param:参数, value:值, groupName:组名, width:高度, height:宽度, left:左边距, top:上边距}
	try
	{
		if (LEAP.TreeSelectBanner.popContainer == null)
		{
			var div = document.createElement('div');
			document.body.appendChild(div);
			div.setAttribute('cct', LEAP.TreeSelectBanner.pd);
			div.className = "TreeSelectBanner_pop_Container";
			
			div.innerHTML = LEAP.TreeSelectBanner.popContainerHTML;	
			LEAP.TreeSelectBanner.popContainer = div;			
		}
		
		var element = LEAP.getElement("div[ct=" + LEAP.TreeSelectBanner.d + "]", LEAP.TreeSelectBanner.popContainer);
		element.setAttribute("instance", module.instance);
		
		LEAP.TreeSelectBanner.setParams(element, par.param, false);
		LEAP.TreeSelectBanner.setGroup(element, par.groupName);		
		LEAP.TreeSelectBanner.setValue(element, par.value, false, true);
		element[LEAP.TreeSelectBanner.symbol.ValueChangeFn] =  (par.valueChangeFn != null)?par.valueChangeFn:null;
		
		if (par.width)
			LEAP.TreeSelectBanner.popContainer.style.width = par.width + "px";
		if (par.height)
			LEAP.TreeSelectBanner.popContainer.style.height = par.height + "px";
		if (par.top)
			LEAP.TreeSelectBanner.popContainer.style.top = par.top + "px";
		if (par.left)
			LEAP.TreeSelectBanner.popContainer.style.left = par.left + "px";
			
		LEAP.TreeSelectBanner.popContainer.style.display = "block";
		
		LEAP.TreeSelectBanner.___poplayout(par, 100);
	}
	finally
	{
		div = element = null;
	}	
}
LEAP.TreeSelectBanner.popupHide = function()
{
	if (LEAP.TreeSelectBanner.popContainer)
		LEAP.TreeSelectBanner.popContainer.style.display = "none";
}
LEAP.TreeSelectBanner.___poplayout = function(par, wait)
{
	if (wait)
	{
		LEAP.asyn(LEAP.TreeSelectBanner.___poplayout, this, wait, par);
		return;
	}
	
	try
	{
		var div_banner = LEAP.getElement("div[ct=" + LEAP.TreeSelectBanner.d + "]", LEAP.TreeSelectBanner.popContainer);
		var div_search = LEAP.getElement("div[ctf=div_search]", LEAP.TreeSelectBanner.popContainer);
		
		if (par.searchFn != null)
		{
			div_search.style.display = "";
			div_banner.style.height = (LEAP.TreeSelectBanner.popContainer.clientHeight - div_search.clientHeight - 2) + "px";
			
			var input_search = LEAP.getElement("input", div_search);
			var btn_search = LEAP.getElement("div[ccct=searchbtn]", div_search);
			//input_search['searchFn'] = searchFn;			
			//input_search['isCC'] = isCC;
			input_search['params'] = par;
			input_search.value = "";
			if (!div_search.getAttribute("___has_registEvent___"))
			{
				LEAP.addEvent(input_search, 'keyup',  LEAP.TreeSelectBanner.___popSearch);
				LEAP.addEvent(btn_search, 'click',  LEAP.TreeSelectBanner.___popSearch);
				
				div_search.setAttribute("___has_registEvent___", "1");
			}
		}
		else
		{
			div_search.style.display = "none";
			div_banner.style.height = "100%";
		}
		
		var iframe_background = LEAP.getElement("iframe[ctf=iframebackground]", LEAP.TreeSelectBanner.popContainer);	
		iframe_background.src = "javascript:void(0)";
		try
		{
			try
			{
				iframe_background.contentWindow.document.write('');
			}catch(e){}
			try
			{
				iframe_background.contentWindow.document.clear();
			}catch(e){}
			try
			{
				iframe_background.contentWindow.close();
			}
			catch(e){}
		}
		catch(e){}
			
	}
	finally
	{
		div_banner = div_search = input_search = null;
	}
}

LEAP.TreeSelectBanner.___popSearch = function(arg)
{	
	try
	{
		if ( (arg && arg.e && arg.e.type == "keyup" && arg.e.keyCode && arg.e.keyCode == 13)
			|| (arg && arg.e && arg.e.type == "click" && arg.caller.getAttribute('ccct') == "searchbtn")
			)
		{
			var input_search = LEAP.getElement("input[ccct=searchinput]", LEAP.TreeSelectBanner.popContainer);			
			if (input_search.value.trim() != "")
			{
				var element = LEAP.getElement("div[ct=" + LEAP.TreeSelectBanner.d + "]", LEAP.TreeSelectBanner.popContainer);				
				var instance = element.getAttribute("instance");
				var module = PageObjectModel.getModule(instance);
				
				var par = input_search["params"];
				var searchFn = par.searchFn;
				var isCC = par.isCC;
				var key = input_search.value.trim();
				
				var __par = {key: key, isCC:isCC};
					__par.topOrgan = ((par.param[0].searchParam.topOrgan == 0) ? false:true);
					__par.organRanges = par.param[0].searchParam.organRanges;
					__par.rolenameRanges = par.param[0].searchParam.rolenameRanges;
					__par.excludeRolenameRanges = par.param[0].searchParam.excludeRolenameRanges;
					__par.excludeUserTypes = par.param[0].searchParam.excludeUserTypes;
					__par.___exdata = par.param[0].___exdata;
									
				var nodes = searchFn.apply(module, [__par]);
				
				//搜索本地自定义分组数据
				nodes = LEAP.TreeSelectBanner.___popSearch_ex(key, nodes, par.param);				
			
				LEAP.TreeSelectBanner.___popSearch_showResult(input_search, nodes);
			}
		}
		
	}
	finally
	{
		element = input_search = instance = module = searchFn = nodes = null;
	}	
}

//搜索本地自定义分组数据
LEAP.TreeSelectBanner.___popSearch_ex = function(key, rst, params)
{
	//先看结果中有没有匹配项，如果有则不搜了
	if (rst != null)
	{
		return rst;		
	}
	
	var match = [];
	var like = [];
	for(var i=0; i<params.length; i++)
	{
		var par = params[i];
		if (par.type == 2 && par.data != null && par.data.nodes != null)
		{
			for(var k=0; k<par.data.nodes.length; k++)
			{
				var node = par.data.nodes[k];
				if (node.isTip == true)
				{
					if (node.remark)
					{
						if (node.remark == key)							
							match.add(node);
						else if (node.remark.indexOf(key) > -1)
							like.add(node);
					}						
				}
			}		
		}			
	}
	
	for(var i=0; i<like.length; i++)
		match.add(like[i]);
	
	if (match.length == 0)
		return null;
	else
		return match;
}

LEAP.TreeSelectBanner.popSearchResultContiner == null;
LEAP.TreeSelectBanner.___popSearch_showResult = function(input, nodes)
{
	try
	{
		if (LEAP.TreeSelectBanner.popSearchResultContiner == null)
		{
			var div = document.createElement('div');
			document.body.appendChild(div);
			div.setAttribute('cct', LEAP.TreeSelectBanner.ps);
			div.className = "TreeSelectBanner_pop_Search_Container";
			
			div.innerHTML = "<div ctf='chk_searchResult' bt='text' ct='checkbox' cmin='0' cmax='0' readonly='0' style='margin:5px 10px 10px 5px;'></div>";
			
			LEAP.TreeSelectBanner.popSearchResultContiner = div;
		}
		
		var checkBoxList = LEAP.getElement("div[ct=checkbox]", LEAP.TreeSelectBanner.popSearchResultContiner);	
		LEAP.addEvent(checkBoxList, 'clickItem', LEAP.TreeSelectBanner.___popSearch_onCheckValueChange);	
		
		var rect = input.getBoundingClientRect();
		LEAP.TreeSelectBanner.popSearchResultContiner.style.width = rect.width + "px";
		
		if (nodes == null)
		{
			checkBoxList.innerHTML = "未搜索到联系人";
		}
		else
		{
			checkBoxList.innerHTML = "";
			for(var i=0; i< nodes.length; i++)
			{
				var __n = nodes[i];
				var __s = __n.remark;
				var __idx = __s.lastIndexOf(".");
				if (__idx >0)
					__s = __s.substring(__idx + 1) + '（' + __s.substring(0, __idx)  + '）'; 
	
				var itm = LEAP.checkbox.addItem(checkBoxList, __s, __n.ID, false, __n);
				itm.parentElement.style.width = "99%";
			}
		}
				
		LEAP.TreeSelectBanner.popSearchResultContiner.style.display = "block";
		
		LEAP.TreeSelectBanner.___popSearch_layout(rect, 50);
	}
	finally
	{
		div = checkBoxList = rect = i = __n = __s = __idx = itm = null;
	}
}

LEAP.TreeSelectBanner.___popSearch_layout = function(rect, wait)
{	
	if (wait)
	{
		LEAP.asyn(LEAP.TreeSelectBanner.___popSearch_layout, this, wait, rect);
		return;
	}
	
	LEAP.TreeSelectBanner.popSearchResultContiner.style.left = 	(rect.left + 20) + "px";
	LEAP.TreeSelectBanner.popSearchResultContiner.style.top = (rect.top - LEAP.TreeSelectBanner.popSearchResultContiner.clientHeight - 15) + "px";
	LEAP.TreeSelectBanner.popSearchResultContiner.style.width = (LEAP.TreeSelectBanner.popSearchResultContiner.scrollWidth + 20) + "px";
	
}

LEAP.TreeSelectBanner.___popSearch_onCheckValueChange = function(arg)
{
	try
	{
		var element = LEAP.getElement("div[ct=" + LEAP.TreeSelectBanner.d + "]", LEAP.TreeSelectBanner.popContainer);
		var checkBoxList = LEAP.getElement("div[ct=checkbox]", LEAP.TreeSelectBanner.popSearchResultContiner);		
		
		if(arg!= null){
			
			if(arg.arg2 && arg.arg2.checked){
				var node = arg.arg2["data"];
				var _node = LWFP.innerApi.clone(node);
				var __idx = node.remark.lastIndexOf(".");
				if (__idx >= 0)
					_node.remark = _node.remark.substring(__idx + 1);
				
				var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
				
				LEAP.TreeSelectBanner.__selectedList_add(element, [_node], _treeParams[0].operationParam.treeSingleCheck == 1?true:false);
				if(_treeParams[0].operationParam.treeSingleCheck == 1){
					LEAP.TreeSelectBanner.popSearchResultContiner.style.display = "none";
					var div_search = LEAP.getElement("div[ctf=div_search]", LEAP.TreeSelectBanner.popContainer);
					var input_search = LEAP.getElement("input", div_search);
						input_search.value = "";
				}
				
			}else{
				var curNodeValue = arg.arg2.value;
				LEAP.TreeSelectBanner.__selectedList_remove(element, [curNodeValue]);
			}	
			LEAP.TreeSelectBanner.__bindSlectedList(element);			
			LEAP.TreeSelectBanner._syncChecked(element);
		}
		
//		var arr = LEAP.checkbox.getCheckedItemElements(checkBoxList);
//		if (arr != null)
//		{
//			var node = arr[0]["data"];
//			var _node = LWFP.innerApi.clone(node);
//			var __idx = node.remark.lastIndexOf(".");
//			if (__idx >= 0)
//				_node.remark = _node.remark.substring(__idx + 1);
//			
//			var _treeParams = LEAP.TreeSelectBanner.__getParams(element);
//			
//			LEAP.TreeSelectBanner.__selectedList_add(element, [_node], _treeParams[0].operationParam.treeSingleCheck == 1?true:false);
//			
//			LEAP.TreeSelectBanner.__bindSlectedList(element);			
//			LEAP.TreeSelectBanner._syncChecked(element);
//			
//			//LEAP.TreeSelectBanner.popSearchResultContiner.style.display = "none";
//			
//			var div_search = LEAP.getElement("div[ctf=div_search]", LEAP.TreeSelectBanner.popContainer);
//			var input_search = LEAP.getElement("input", div_search);
//			//input_search.value = "";
//		}
		
	}
	finally
	{	
		element = checkBoxList = arr = node = _node = __idx = _treeParams = div_search = input_search = null;
	}
}

LEAP.TreeSelectBanner.ConstructUserContractGroupTree = function(arg)
{
	try
	{
		var treeData = LEAP.routerRequest("WfConstructUserContractGroupTree");
		return treeData;
	}
	finally
	{
		treeData = null;
	}
}


LEAP.TreeSelectBanner.init();














/**
 * 发送
 * @class LEAP.trans control
 * @type user control
 * @example
流程发送模板：
<table transct="SendPanel" class="LC_form_tab LC_form_all" style="margin-top: 5px;">
	<colgroup>
		<col style="width: 110px;">
			<col>
				<col style="width: 110px;">
	</colgroup>
	<tbody>
		<tr>
			<td class="LC_form_tab_td" style="color: rgb(0, 0, 0);" rowspan="1" colspan="3">转送下一步</td>
		</tr>
		<tr>
			<td class="LC_form_tab_td" style="text-align: right; background-color: rgb(243, 243, 243);">下一步骤</td>
			<td class="LC_form_tab_td" rowspan="1" colspan="2">
			    <div ct="checkbox2" mdtype="radio" bt="text" radio="1" ccancel="1" transtct="1" transct="Nextact">
					<div class="LC_checkbox" style="display: inline-block;" ctf="checkbox2_item">
						<input type="checkbox" value="module" ctf="checkbox2_input">
						<span>
						</span>
						<label ctf="checkbox2_label">动作</label>
					</div>
				</div>
			</td>
		</tr>
		<tr ht="tr" transtct="1" transct="SendOwnerPanel">
			<td class="LC_form_tab_td" style="text-align: right; background-color: rgb(243, 243, 243);">发送给</td>
			<td class="LC_form_tab_td">
				<ul ct="item" class="LC_item" transtct="1" transct="SendOwner" ></ul>
			</td>
			<td class="LC_form_tab_td">
				<input class="LC_button_conner LC_button_blue" style="float: left;" type="button" ht="input" value="选择" transct="SelBtn" transtct="1">
			</td>
		</tr>
		<tr ht="tr" transtct="1" transct="CCOwnerPanel">
			<td class="LC_form_tab_td" style="text-align: right; background-color: rgb(243, 243, 243);">抄送给</td>
			<td class="LC_form_tab_td">
				<ul ct="item" class="LC_item" transtct="1" transct="CCOwner" ></ul>
			</td>
			<td class="LC_form_tab_td">
				<input class="LC_button_conner LC_button_blue" style="float: left;" type="button" ht="input" value="选择" transtct="1" transct="CCBtn" ct="organselector" _title="选择抄送人" _style="0" _single="0" _levels="1" _type="2">
			</td>
		</tr>
	</tbody>
</table>


流程按钮模板				
<input transct="btnmon" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="流程监控" lcv="2">
<input transct="btnpull" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="回收" lcv="2">
<input transct="btnpush" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="退回" lcv="2">
<div transct="divoption" transtct="1" ht="div" style="display:inline-block;">
	<input transct="btntmp" transtct="1" ht="input" style="display:none;" class="LC_button_conner LC_button_blue" type="button" value="全局操作模板" title="全局操作模板" lcv="2">						
</div>
<input transct="btnsave" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="暂存" lcv="2">
<input transct="btnsend" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="提交" lcv="2">
<input transct="btnread" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="已阅" lcv="2">
<input transct="btndel" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="删除" lcv="2">
<input transct="btnfav" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="关注" lcv="2">
<input transct="btnAddZW" transtct="1" ht="input" class="LC_button_conner LC_button_blue" type="button" value="上传正文" lcv="2" tabcode="">

标签:

	
*/

/**
 * transct=uibanner 边栏，用于加载LEAP模型或url, 属性配置：
 	cfg = {loadType: 	0 -永远加载 
 						1-流程未发起即加载（办结后不加载）
 						8-流程发起后才加载（办结后不加载）
 						9-流程发起后才加载（办结后也加载）
 			moduleName: "leap模型名，加载时传入workflow对象",
 			url:		"第三方url,将在iframe中加载，url会带instance和entryid"
 		}
 */

LEAP.trans = {};
LEAP.trans.d = 'transtct';
LEAP.trans.n = "transct"; 
LEAP.trans.transct = {Nextact:"Nextact",
					  SendPanel:"SendPanel",	
					  SendOwnerPanel:"SendOwnerPanel",
					  CCOwnerPanel:"CCOwnerPanel",
					  RemindPanel:"RemindPanel",
					  smallNoteDiv:"smallNoteDiv",
					  smallNoteText:"smallNoteText",
					  remindCheck:"remindCheck",					  
					  SendOwner:"SendOwner",
					  SendOwnerCheck:"SendOwnerCheck", 
					  CCOwner:"CCOwner",
					  SelBtn:"SelBtn",
					  CCBtn:"CCBtn",
					  btnsave:"btnsave",
					  btnsend:"btnsend",
					  btnread:"btnread",
					  btnhandround:"btnhandround",
					  btnmon:"btnmon",				  
					  btnmon2:"btnmon2",
					  btnmon3:"btnmon3",
					  btnmanager:"btnmanager",					  
					  btnpull:"btnpull",
					  btnpush:"btnpush",
					  btndel:"btndel",
					  btnfav:"btnfav",
					  divoption:"divoption",
					  divaheadaction:"divaheadaction",
					  btntmp:"btntmp",					  
					  btnoption:"btnoption",
					  btnAheadAction:"btnAheadAction",
					  btnSmallnote:"btnSmallnote",
					  btnAddZW:"btnAddZW",
					  btnDraft:"btnDraft",
					  btnFinish:"btnFinish",
					  
					  SplitOwnerPanel:"SplitOwnerPanel",
					  splitOwnerTemplete:"splitOwnerTemplete",
					  splitActName:"splitActName",
					  splitSendOwner:"splitSendOwner",
					  splitSendOwnerCheck:"splitSendOwnerCheck",
					  splitSelBtn:"splitSelBtn",
					  splitSelectAll:"splitSelectAll",
					  
					  btnMonView:"btnMonView",
					  btnMonView2:"btnMonView2",
					  uibanner:"uibanner"
					  };
					  
LEAP.trans.symbol = {opdata:"opdata", aheadActData:"aheadActData",canselectuser:"canselectuser"};

LEAP.trans.init = function()
{
	if (document != null && document.body != null)
		LEAP.trans._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.trans._init);	

}
LEAP.trans._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.trans.uiProcess, null, null, true, 0); 
	
	UIEventManager.removeEvent(window, 'load', LEAP.trans._init);
}
LEAP.trans.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		var element = LEAP._match(src, "1", LEAP.trans.d);
		if(null == element) 
			return;
			
		LWFP.debug();
		
		var ct = element.getAttribute(LEAP.trans.n);
				
		if (ct == LEAP.trans.transct.Nextact)
		{	
		}
		else if (ct == LEAP.trans.transct.CCBtn)
		{
			LEAP.trans.__selectUser_CC(element);
		}
		else if (ct == LEAP.trans.transct.SelBtn)
		{
			LEAP.trans.__selectUser(element);
		}
		else if (ct == LEAP.trans.transct.splitSelBtn)
		{
			LEAP.trans.__selectUser_split(element);
		}
		else if (ct == LEAP.trans.transct.splitSelectAll)
		{
			LEAP.trans.__selectAll_split(element);
		}
		else if (ct == LEAP.trans.transct.SendOwner){}
		else if (ct == LEAP.trans.transct.CCOwner){}
		else if (ct == LEAP.trans.transct.btnsave)
		{
			LEAP.trans.__save(element);
		}
		else if (ct == LEAP.trans.transct.btnsend)
		{			
			LEAP.trans.____send(element);
		}
		else if (ct == LEAP.trans.transct.btnread)
		{
			LEAP.trans.__read(element);
		}
		else if (ct == LEAP.trans.transct.btnhandround)
		{
			LEAP.trans.__btnhandround(element);
		}
		else if (ct == LEAP.trans.transct.btnmon)
		{
			LEAP.trans.__monz(element);
		}
		else if (ct == LEAP.trans.transct.btnmon2)
		{
			LEAP.trans.__monz(element);
		}
		else if (ct == LEAP.trans.transct.btnmon3)
		{
			//LEAP.trans.__mon3(element);
			LEAP.trans.__monz(element);
		}
		else if (ct == LEAP.trans.transct.btnmanager)
		{
			LEAP.trans.__monz(element);
			//LEAP.trans.__manager(element);
		}
		else if (ct == LEAP.trans.transct.btnMonView)
		{
			LEAP.trans.__monz_viewButton_click(element);
		}
		else if (ct == LEAP.trans.transct.btnMonView2)
		{
			LEAP.trans.__mon_loadmodule_viewButton_click(element);
		}
		else if (ct == LEAP.trans.transct.btnpull)
		{
			LEAP.trans.__pull(element);
		}
		else if (ct == LEAP.trans.transct.btnpush)
		{
			LEAP.trans.__push({caller:element});
		}
		else if (ct == LEAP.trans.transct.btndel)
		{
			LEAP.trans.__del(element);
		}
		else if (ct == LEAP.trans.transct.btnFinish)
		{
			LEAP.trans.__finish(element);	
		}
		else if (ct == LEAP.trans.transct.btnfav)
		{
			LEAP.trans.__fav(element);
		}
		else if (ct == LEAP.trans.transct.btnoption)
		{
			LEAP.trans.__option(element);
		}
		else if (ct == LEAP.trans.transct.btnAheadAction)
		{
			LEAP.trans.__ahead(element);
		}
		else if (ct == LEAP.trans.transct.btnSmallnote)
		{
			LEAP.trans.showSmallnoteTip(element, 0);
		}
		else if (ct == LEAP.trans.transct.btnAddZW)
		{
			LEAP.trans.__addZW(element);
		}
		else if (ct == LEAP.trans.transct.btnDraft)
		{
			LEAP.trans.__draft(element);		
		}
		
		
	}
	finally
	{
		src = element = ct = null;
	}
}

LEAP.trans.loadRunningData = function(domain)
{
	try
	{	
		LEAP.trans.__initBtn(domain);
		
		LEAP.trans.__initNextAction(domain);
		
		LEAP.trans.__intiAutoSubmitControls(domain);
		
		LEAP.trans.__loadUIBanner(domain);
	}
	finally
	{
	}
}

LEAP.trans.__intiAutoSubmitControls = function(domain)
{
	try
	{	
		var moduleElement = domain.moduleElement;
		
		if (moduleElement.getAttribute("_has_init_autosubmit") == "1")
			return;
		
		//LEAP.getElements()
		var ctrls = LEAP.getElements("[autoSubmit=1]", domain.moduleElement);
		if (ctrls)
		{
			for(var i=0; i<ctrls.length; i++)
			{
				var ctrl = ctrls[i];
				var ct = ctrl.getAttribute("ct");
				
				if (ct != null)
				{
					if (ct == LEAP.checkbox2.d || ct == LEAP.select2.d || ct == LEAP.date.d || ct == LEAP.item.d)
					{
						domain.addEvent(ctrl, 'valueChange', LEAP.trans.__autoSubmit);					
					}
				}
				else if (ctrl.tagName.toUpperCase() == "INPUT" || ctrl.tagName.toUpperCase() == "TEXTAREA")
				{
					LEAP.addEvent(ctrl, 'blur', LEAP.trans.__autoSubmit, null, domain, true);	
					//onblur
				}
				
			}	
		}
		
		moduleElement.setAttribute("_has_init_autosubmit", "1");
	}
	finally
	{
		moduleElement = ctrls = i = ctrl = ct = null;
	}
}

LEAP.trans.__autoSubmit = function(arg)
{
	try
	{
		var module = LEAP.trans.__getmodule(arg.caller);		
		if (module)
		{
			try
			{
				var workflow = module.workflow;		
				var data = workflow.___data;				
				if ( (data.currentStep != null && data.currentStep.readstep !=1) || data.entry == null )
				{
					module.skipValidate = true;
					module.innerWFModuleSubmit();
				}				
			}
			finally
			{			
				module.skipValidate = false;
			}
		}
	}
	finally
	{
		module = workflow = data = null;
	}
}

LEAP.trans.__initNextAction = function(domain, _actions)
{
	LWFP.debug();
	try
	{	
		var workflow = domain.workflow;
		var instance = domain.instance;
		var moduleElement = domain.moduleElement;
		
		if (workflow.getEntry() && workflow.getEntry().state ==1)
		{
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SendPanel, false, instance, moduleElement);
			return;
		}	
		LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SendPanel, true, instance, moduleElement);
							
		var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + instance + "]", moduleElement);		
		if (!chkbox)
			return;
			
		if (!chkbox.getAttribute("_has_regevent_"))
		{
			domain.addEvent(chkbox, 'valueChange', LEAP.trans.__onActionChange, this);	
			chkbox.setAttribute("_has_regevent_", "1");
		}
		
		var check_sendowner = LEAP.getElement("div[transct=" + LEAP.trans.transct.SendOwnerCheck + "][instance=" + instance + "]", moduleElement);
		if (check_sendowner && !check_sendowner.getAttribute("_has_regevent_"))
		{
			domain.addEvent(check_sendowner, 'valueChange', LEAP.trans.__onDirectUserCheckChange, this);	
			check_sendowner.setAttribute("_has_regevent_", "1");
		}
		
		var _lastValue = null;
		if ("0" == chkbox.getAttribute("refresh") || "2" == chkbox.getAttribute("refresh"))
		{	
			_lastValue = LEAP.checkbox2.getValue(chkbox);
		}
		
		if ("0" == chkbox.getAttribute("refresh") && _lastValue != null 
				&& workflow.getCurrentStep() != null &&  chkbox.getAttribute("lastCsid") != null 
				&& workflow.getCurrentStep().csid == chkbox.getAttribute("lastCsid") )
		{
			//禁止刷新动作，不重新getNextOwner
		}
		else if ("2" == chkbox.getAttribute("refresh") && _lastValue != null 
				&& workflow.getCurrentStep() != null &&  chkbox.getAttribute("lastCsid") != null 
				&& workflow.getCurrentStep().csid == chkbox.getAttribute("lastCsid") )
		{//不刷新动作，但重新getNextOwner
			var itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
			itm["___orgTree"] = null;
			itm["___h"] = null;
			LEAP.trans.__onActionChange({caller:chkbox});
		}
		else
		{
			if (workflow.getCurrentStep() != null)
			{
				chkbox.setAttribute("lastCsid", workflow.getCurrentStep().csid);
			}
						
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SplitOwnerPanel, false, instance, moduleElement);
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SendOwnerPanel, false, instance, moduleElement);
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.CCOwnerPanel, false, instance, moduleElement);
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.RemindPanel, false, instance, moduleElement);
		
			LEAP.checkbox2.clearItems(chkbox);
			chkbox.innerHTML = "";
		
			var data = workflow.___data;
			if (data.currentStep == null && workflow.getIsNew() == false)
			{
				chkbox.innerHTML = "当前无下一步骤";
			}
			else if (data.currentStep != null &&　data.currentStep.readstep == 1)
			{	
				chkbox.innerHTML = "当前办件是阅件，点击【已阅】按钮即可结束任务";
			}
			else
			{	
				var actions = data.nextActions;
				if (_actions != null)
					actions = _actions;
				
				if (actions == null)
				{
					return;
				}
						
				var defActionIndex = 0; //默认动作
				
				for(var i=0; i<actions.length; i++)
				{
					var act = actions[i];
					if (act.defaultact == 1)
					{
						defActionIndex = i;
					}
					
					var itm = LEAP.checkbox2.addItem(chkbox, act.aliasname, i+"", false, act);
					itm.style.display = "inline-block";
				}
	
				if (domain.autoAppointNextAction != false)
				{
					LEAP.checkbox2.setValue(chkbox, defActionIndex + "");	
					var p = {caller:chkbox};
		
					LEAP.trans.__onActionChange(p);
				}
			}		
		}
		
	}
	finally
	{
		workflow = instance = moduleElement = data = chkbox = check_sendowner = i = act = itm = p = null;
	}
}

LEAP.trans.__displayOwnerPanel = function(type, display, instance, moduleElement)
{
	try
	{
		var ele = LEAP.getElement("[transct=" + type + "][instance=" + instance + "]", moduleElement);
		
		if (ele)
		{
			if (display == true)
				ele.style.display = "";
			else
				ele.style.display = "none";
		}		
	}
	finally
	{
		ele = null;
	}
}

LEAP.trans.__initBtn = function(domain)
{
	LWFP.debug();
	try
	{
		var workflow = domain.workflow;
		var instance = domain.instance;
		var moduleElement = domain.moduleElement;
		
		var data = workflow.___data;
		
		//添加正文
		var btnAddZW = LEAP.getElement("[transct=" + LEAP.trans.transct.btnAddZW + "][instance=" + instance + "]", moduleElement);
		if (btnAddZW)
		{
			if ((data.entry == null) || (data.entry != null && data.currentStep != null && data.currentStep.readstep !=1) )
			{
				btnAddZW.style.display = "inline-block";			
			}
			else
			{
				btnAddZW.style.display = "none";
			}
		}
		
		//拟稿
		var btnDraft = LEAP.getElement("[transct=" + LEAP.trans.transct.btnDraft + "][instance=" + instance + "]", moduleElement);
		if (btnDraft)
		{
			if ((data.entry == null) || (data.entry != null && data.currentStep != null && data.currentStep.readstep !=1) )
			{
				btnDraft.style.display = "inline-block";			
			}
			else
			{
				btnDraft.style.display = "none";
			}
		}
		
		//暂存
		var btnsave = LEAP.getElement("[transct=" + LEAP.trans.transct.btnsave + "][instance=" + instance + "]", moduleElement);
		if (btnsave)
		{
			if ( ( (data.currentStep != null && data.currentStep.readstep !=1) || data.entry == null)				 
					&& data.module != null && data.module.modulename != null)
			{//&& (data.flow.savebtn != null && data.flow.savebtn != "")
				//btnsave.value = data.flow.savebtn;
				btnsave.style.display = "inline-block";			
			}
			else
			{
				btnsave.style.display = "none";
			}	
		}
		
		//已阅  发送
		var btnread = LEAP.getElement("[transct=" + LEAP.trans.transct.btnread + "][instance=" + instance + "]", moduleElement);
		if (btnread)
			btnread.style.display = "none";
			
		var btnsend = LEAP.getElement("[transct=" + LEAP.trans.transct.btnsend + "][instance=" + instance + "]", moduleElement);
		if (btnsend)
			btnsend.style.display = "none";
		
		var sendpanel = LEAP.getElement("[transct=" + LEAP.trans.transct.SendPanel + "][instance=" + instance + "]", moduleElement);
		
		if (data.currentStep != null &&　data.currentStep.readstep == 1)
		{
			if (btnread)
				btnread.style.display = "inline-block";			
		}
		else if ((data.currentStep != null || data.entry == null))// && data.nextActions != null)
		{
			if (btnsend)
			{	
				if (btnsend.getAttribute("displaytype") == "1" )
				{//尽量显示
					btnsend.style.display = "inline-block";	 
				}
				else
				{//尽量不显示，如动作全部都为前置时不显示
					var flag = false;			
					if (data.nextActions != null)
					{				
						for(var i=0; i<data.nextActions.length; i++)
						{
							if (data.nextActions[i].runahead == null || data.nextActions[i].runahead == 0)
							{
								flag = true;
								break;
							}
						}
					}
					
					if ( (data.nextActions && flag == true) || sendpanel || data.nextActions == null)
					{//1.确保不全部都是提前动作或有发送面板 2.一个动作都没有（可能都是待校验状态）
						btnsend.style.display = "inline-block";	
					}
				}
				
			}			
			
		}
		//传阅		
		var btnhandround = LEAP.getElement("[transct=" + LEAP.trans.transct.btnhandround + "][instance=" + instance + "]", moduleElement);
		if (btnhandround)
		{
			//if (data.entry == null || data.historySteps == null)
			if (data.canHandround == false)
				btnhandround.style.display = "none";
			else
				btnhandround.style.display = "inline-block";
		}		
		
		//历程
		var btnmon = LEAP.getElement("[transct=" + LEAP.trans.transct.btnmon + "][instance=" + instance + "]", moduleElement);
		if (btnmon)
		{
			if (data.flow.historybtn != null && data.flow.historybtn != "" && data.entry != null)
			{
				//btnmon.value = data.flow.historybtn;
				btnmon.style.display = "inline-block";			
			}
			else
			{
				btnmon.style.display = "none";
			}
		}
		var btnmon2 = LEAP.getElement("[transct=" + LEAP.trans.transct.btnmon2 + "][instance=" + instance + "]", moduleElement);
		if (btnmon2)
		{
			if (data.flow.historybtn != null && data.flow.historybtn != "" && data.entry != null)
			{
				//btnmon2.value = data.flow.historybtn;
				btnmon2.style.display = "inline-block";			
			}
			else
			{
				btnmon2.style.display = "none";
			}
		}
		var btnmon3 = LEAP.getElement("[transct=" + LEAP.trans.transct.btnmon3 + "][instance=" + instance + "]", moduleElement);
		if (btnmon3)
		{
			if (data.flow.historybtn != null && data.flow.historybtn != "" && data.entry != null)
			{
				//btnmon2.value = data.flow.historybtn;
				btnmon3.style.display = "inline-block";			
			}
			else
			{
				btnmon3.style.display = "none";
			}
		}
		//回收，回滚，维护
		var btnpull = LEAP.getElement("[transct=" + LEAP.trans.transct.btnpull + "][instance=" + instance + "]", moduleElement);
		var btnmanager = LEAP.getElement("[transct=" + LEAP.trans.transct.btnmanager + "][instance=" + instance + "]", moduleElement);
		
		if (btnpull) btnpull.style.display = "none";
		if (btnmanager)	btnmanager.style.display = "none";
		if (data.historySteps != null)
		{	
			//if ((data.canMonitor == true || data.pullbackSteps != null || data.rollbackSteps != null)  && btnmanager)
			if (btnmanager)
			{
				btnmanager.style.display = "inline-block";
			}
			//else
			//{
				if (btnpull)
				{
					if ( (data.currentStep==null || (data.currentStep != null && data.currentStep.readstep !=1))
						 && data.pullbackSteps != null)
					{	
						btnpull.style.display = "inline-block";			
					}
				}			
			//}
		}
				
		//退回
		var btnpush = LEAP.getElement("[transct=" + LEAP.trans.transct.btnpush + "][instance=" + instance + "]", moduleElement);
		if (btnpush)
		{
			if ( (data.currentStep==null || (data.currentStep != null && data.currentStep.readstep !=1))
				 && data.userToPushBack != null)
			{	
				btnpush.style.display = "inline-block";			
			}
			else
			{
				btnpush.style.display = "none";
			}
		}		
		//关注
		var btnfav = LEAP.getElement("[transct=" + LEAP.trans.transct.btnfav + "][instance=" + instance + "]", moduleElement);
		if (btnfav)
		{
			if (data.entry != null )//&& data.flow.favbtn != null && data.flow.favbtn != ""
			{	
				//btnfav.value = data.flow.favbtn;
				btnfav.style.display = "inline-block";			
			}
			else
			{
				btnfav.style.display = "none";
			}
		}		
		//删除
		var btndel = LEAP.getElement("[transct=" + LEAP.trans.transct.btndel + "][instance=" + instance + "]", moduleElement);
		if (btndel)
		{
			if (data.entry != null && data.historySteps == null && data.currentStep != null 
				)//&& data.flow.delbtn != null && data.flow.delbtn != ""
			{	
				//btndel.value = data.flow.delbtn;
				btndel.style.display = "inline-block";			
			}
			else
			{
				btndel.style.display = "none";
			}
		}
		//终结
		var btnFinish = LEAP.getElement("[transct=" + LEAP.trans.transct.btnFinish + "][instance=" + instance + "]", moduleElement);
		if (btnFinish)
		{
			if (data.entry && data.entry.state == 0 && data.canFinish == true)
			{
				btnFinish.style.display = "inline-block";	
			}
			else
			{
				btnFinish.style.display = "none";
			}
		}		
		
		//全局操作
		var divoption = LEAP.getElement("[transct=" + LEAP.trans.transct.divoption + "][instance=" + instance + "]", moduleElement);
		if (divoption)
		{
			if (data.flowOptions == null)
			{
				divoption.style.display = "none";
			}
			else
			{
				divoption.style.display = "inline-block";
				
				var btntmp = LEAP.getElement("[transct=" + LEAP.trans.transct.btntmp + "]", divoption);
				btntmp.style.display = "none";
				btntmp.removeAttribute("st");
				btntmp.removeAttribute("title");
				
				divoption.innerHTML = "";				
				divoption.appendChild(btntmp);
				
				for(var i=0; i<data.flowOptions.length; i++)
				{
					var op = data.flowOptions[i];
					var btn = btntmp.cloneNode();					
					btn.value = op.opname;
					btn.setAttribute(LEAP.trans.n, LEAP.trans.transct.btnoption);
					btn[LEAP.trans.symbol.opdata] = op;
					btn.style.display = "inline-block";
					
					divoption.appendChild(btn);
				}
			}			
		}		

		//提前动作
		var divaheadaction = LEAP.getElement("[transct=" + LEAP.trans.transct.divaheadaction + "][instance=" + instance + "]", moduleElement);
		if (divaheadaction)
		{
			var hasAheadAction = false;			
			var _btntmp = LEAP.getElement("[transct=" + LEAP.trans.transct.btntmp + "]", divaheadaction);
				_btntmp.style.display = "none";
				_btntmp.removeAttribute("st");
				_btntmp.removeAttribute("title");	
				
			var tmpHTML = _btntmp.innerHTML;
			if (tmpHTML == "")
				tmpHTML = _btntmp["tmpHTML"];

			_btntmp["tmpHTML"] = tmpHTML;
			
			divaheadaction.innerHTML = "";
			divaheadaction.appendChild(_btntmp);
	
			if (data.currentStep==null || (data.currentStep != null && data.currentStep.readstep !=1))
			{
				if (data.nextActions != null && data.nextActions.length>0)
				{			
					for(var i=0; i<data.nextActions.length; i++)
					{
						if (data.nextActions[i].runahead != null && data.nextActions[i].runahead == 1)
						{						
							hasAheadAction = true;
													
							var act = data.nextActions[i];
							var btn = _btntmp.cloneNode();		
							if (_btntmp.tagName.toUpperCase() == "INPUT")
							{
								btn.value = act.aliasname;
							}
							else
							{
								btn.innerHTML = tmpHTML.replace("{$actionAliasname$}", act.aliasname).replace("{$actionName$}", act.actionname).replace("{$actionDesc$}", act.actiondesc);
							}
							
							btn.setAttribute(LEAP.trans.n, LEAP.trans.transct.btnAheadAction);
							btn[LEAP.trans.symbol.aheadActData] = act;															
							btn.style.display = "inline-block";
							divaheadaction.appendChild(btn);
						}
					}
				}
			}
			
			if (hasAheadAction == false)
				divaheadaction.style.display = "none";
			else
				divaheadaction.style.display = "inline-block";
		}
				
		//小纸条
		var btnSmallnote = LEAP.getElement("[transct=" + LEAP.trans.transct.btnSmallnote + "][transtct=1][instance=" + instance + "]", moduleElement);
		if (data.currentStep != null && data.currentStep.smallnote != null)
		{	
			if (btnSmallnote)
			{
				btnSmallnote.style.display = "inline-block";	
				if (domain.__wf_refresh != true)
				{
					LEAP.trans.showSmallnoteTip(btnSmallnote, 1000);
				}
			}
		}
		else
		{
			if (btnSmallnote)
				btnSmallnote.style.display = "none";
		}
		
	}
	finally
	{
		workflow = instance = moduleElement = data = btnsave = btnread = btnsend = flag = i = btnmon = 
		btnmon2 = btnmon3 = btnpull = btnpush = btnfav = btndel = divoption = btntmp = op = btn = divaheadaction = 
		_btntmp = hasAheadAction = act = btn = btnSmallnote = null;
	}
}

LEAP.trans.showSmallnoteTip = function(element, time)
{
	try
	{
		if (time && time > 0)		
			LEAP.asyn(this.showSmallnoteTip, this, time, element);
		else
		{
			var module = LEAP.trans.__getmodule(element);
			var wfdata = module.workflow.___data;
			
			var rect = element.getBoundingClientRect();		
			var str = "<div style='text-align:left; width:250px; padding:10px 10px 20px 10px;'>" +
					"<div>以下是" + wfdata.currentStep.callername + "给您的小纸条：</div>" +
					"<div style='word-break:break-all;'>&emsp;&emsp;" + wfdata.currentStep.smallnote + "</div>" +
					"</div>"
			
			LEAP.smallTip.show(str, null, null, rect);			
		}
	}
	finally
	{
		module = wfdata = rect = str = null;
	}
}



LEAP.trans.__onActionChange = function(arg)
{
	try
	{	
		var element = arg.caller;
		
		var itm = LEAP.checkbox2.getCheckedItemElements2(element);
		itm = itm[0];
	
		var action = itm["_data"];		
		var module = LEAP.trans.__getmodule(element);				
		var instance = module.instance;		
		var moduleElement = module.moduleElement;				
		var workflow = module.workflow;	
		var data = workflow.___data;
		
		//处理消息提醒，小纸条
		LEAP.trans.__initRemindControl(data, action, module);
		
		//初始化用户选择step1
		LEAP.trans.__initNextOwner_step1(action, module);
								
		//查人	
		var orgTree = itm["___orgTree"];
		if (orgTree == null && itm["___h"] != "1" )   // && action.toFinish != true)
		{				
			if (workflow.getEntry() != null)
			{
		    	orgTree = LWFP.innerApi.getNextOwner(module, {param:new WFParameter().getParameter(workflow.___data)
																			.setCsid(workflow.___data.CSID)
																			.setNextActionName(action.actionname)
																			.setTopOrgan(false)
																			.setLazy(true)
																			.setLazyid(null)
																			.setLazysyscode(null)
																			.setLazyout(false)} );
			}
			
			if (orgTree != null)
				itm["___orgTree"] = orgTree;
			
			itm["___h"] = "1";
		}
		
		//初始化用户选择step2
		LEAP.trans.__initNextOwner_step2(action, orgTree, module);
						
		//处理抄送
		LEAP.trans.__initNextCCOwner(action, orgTree, module);
		
		//处理发散
		LEAP.trans.__initNextOwner_split(action, orgTree, module);
		
		//暂存
		var btnsave = LEAP.getElement("[transct=" + LEAP.trans.transct.btnsave + "][instance=" + instance + "]", moduleElement);
		if (btnsave)
		{
			if ( ( (data.currentStep != null && data.currentStep.readstep !=1) || data.entry == null)				 
					&& data.module != null && data.module.modulename != null
					//&& (data.flow.savebtn != null && data.flow.savebtn != "")
			   )
			{
				//btnsave.value = data.flow.savebtn;
				btnsave.style.display = "inline-block";			
			}
			else
			{
				btnsave.style.display = "none";
			}	
		}
	}
	catch(e)
	{		
		LEAP.messagebox.alert(e.message);
	}
	finally
	{
		if (module.onWFActionChange)
			module.onWFActionChange({action:action});
			
		element = itm = action = module = instance = moduleElement = workflow = data = orgTree = btnsave = null;
	}
}

LEAP.trans.__initNextOwner_step1 = function(action, module)
{
	try
	{
		var instance = module.instance;
		var moduleElement = module.moduleElement;	
		var workflow = module.workflow;
		
		var btn_select = LEAP.getElement("input[transct=" + LEAP.trans.transct.SelBtn + "][instance=" + instance + "]", moduleElement);
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + instance + "]", moduleElement);
		var check_sendowner = LEAP.getElement("div[transct=" + LEAP.trans.transct.SendOwnerCheck + "][instance=" + instance + "]", moduleElement);
		
		LEAP.trans.__showowner(textarea_sendowner, null);
		
		if (action.toFinish == true || action.toSplit == true)
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SendOwnerPanel, false, instance, moduleElement);
		else
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SendOwnerPanel, true, instance, moduleElement);
		
		if (btn_select)
			btn_select.style.display = "none";
			
		if (textarea_sendowner)
		{
			textarea_sendowner.setAttribute(LEAP.trans.symbol.canselectuser, "0");
			textarea_sendowner.setAttribute("actionname", action.actionname);
		}
		
		if (check_sendowner)
			check_sendowner.style.display = "none";
			
		if (workflow.getEntry() == null)
		{
			if (btn_select)
				btn_select.style.display = "inline-block";
			textarea_sendowner.setAttribute(LEAP.trans.symbol.canselectuser, "0");
		}
	}
	finally
	{
		instance = moduleElement = workflow = btn_select = textarea_sendowner = check_sendowner = null;
	}
}

LEAP.trans.__initNextOwner_step2 = function(action, orgTree, module)
{
	try
	{
		var instance = module.instance;		
		var moduleElement = module.moduleElement;	
		
		if (orgTree == null)
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SendOwnerPanel, false, instance, moduleElement);
		
		var owners = [];
		var allOwners = [];
		
		//分析		
		var btn_select = LEAP.getElement("input[transct=" + LEAP.trans.transct.SelBtn + "][instance=" + instance + "]", moduleElement);
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + instance + "]", moduleElement);
		var check_sendowner = LEAP.getElement("div[transct=" + LEAP.trans.transct.SendOwnerCheck + "][instance=" + instance + "]", moduleElement);
		
		var showOrgTree = LWFP.innerApi.checkNextOwner(orgTree, owners, allOwners);	
		if (showOrgTree == true)
		{
			if (btn_select)
				btn_select.style.display = "inline-block";
			if (textarea_sendowner)
			{
				textarea_sendowner.setAttribute(LEAP.trans.symbol.canselectuser, "1");	
				LEAP.item.setReadOnly(textarea_sendowner, false);
			}
		}
		else
		{
			if (btn_select)
				btn_select.style.display = "none";
			if (textarea_sendowner)
			{
				textarea_sendowner.setAttribute(LEAP.trans.symbol.canselectuser, "0");
				LEAP.item.setReadOnly(textarea_sendowner, true);
			}
		}
			
		//显示可选/默认用户
		if (action.trgStep.organselecttype == 1 && orgTree)
		{//直接在当前界面选人
			if (btn_select)
				btn_select.style.display = "none";
			if (textarea_sendowner)
				textarea_sendowner.style.display = "none";
				
			if (check_sendowner)
				check_sendowner.style.display = "inline-block";
				
			LEAP.trans.__showDirectUser(check_sendowner, orgTree.singleCheck, owners, allOwners);
		}
		else
		{
			if (check_sendowner)
				check_sendowner.style.display = "none";
				
			if (textarea_sendowner)
				textarea_sendowner.style.display = "inline-block";
		}
		
		if (textarea_sendowner)
		{
			LEAP.trans.__showowner(textarea_sendowner, owners);
			module.addEvent(textarea_sendowner, 'removeItem', LEAP.trans._OnNextOwnerCheckedChange, this);
		}
	}
	finally
	{
		instance = moduleElement = owners = allOwners = btn_select = textarea_sendowner = check_sendowner = showOrgTree = null;
	}
}

LEAP.trans.__initNextOwner_split = function(action, mainOrgTree, module)
{
	try
	{
		var instance = module.instance;
		var moduleElement = module.moduleElement;	
		var workflow = module.workflow;
				
		if (action.toSplit == true)
		{
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SplitOwnerPanel, true, instance, moduleElement);
		}	
		else
		{
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.SplitOwnerPanel, false, instance, moduleElement);
			return;
		}
		
		var splitOwnerPanel = LEAP.getElement("[transct=" + LEAP.trans.transct.SplitOwnerPanel + "][instance=" + instance + "]", moduleElement);
		if (!splitOwnerPanel)
			return;
		
		var splitOwnerTemplete = LEAP.getElement("[transct=" + LEAP.trans.transct.splitOwnerTemplete + "]", splitOwnerPanel);
		if	(!splitOwnerTemplete)
			return;
 
		var html = splitOwnerTemplete.innerHTML.replaceall(" transct=", ' instance="' + instance + '" transct=');
		
		var itemContainer = splitOwnerTemplete.parentNode; 
		itemContainer.innerHTML = "";
		itemContainer.appendChild(splitOwnerTemplete);
		splitOwnerTemplete.innerHTML = html;
		
		var acts = workflow.getData().nextSplitActions;
		if (acts == null)
			return;
			
		for(var i=0; i<acts.length; i++)
		{	
			var act = acts[i];
			if (act.srcstepid != action.trgstepid)
				continue;
			
			var item = splitOwnerTemplete.cloneNode();
			
			var orgTree = null;
			for(var k=0; k<mainOrgTree.splitTrees.length; k++)
			{
				var __tmp = mainOrgTree.splitTrees[k];
				if (__tmp && __tmp.nextActionId == act.actionid)
				{
					orgTree = __tmp;
					break;
				}	
			}
			if (orgTree == null)
				continue;
			
			item.innerHTML = html; //splitOwnerTemplete.innerHTML;
			item.style.display = "block";
			item.setAttribute("instance", instance);
			item.setAttribute("actionid", action.actionid);
			item.setAttribute("splitActionId", act.actionid);
			item["splitAction"] = act;
			
			splitOwnerTemplete.parentNode.appendChild(item);
			
			var splitActName = LEAP.getElement("[transct=" + LEAP.trans.transct.splitActName + "]", item);
			splitActName.innerText = act.actionname + "：";
						
			var owners = [];
			var allOwners = [];
			//分析		
			var btn_select = LEAP.getElement("input[transct=" + LEAP.trans.transct.splitSelBtn + "]", item);
			var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.splitSendOwner + "]", item);
			var check_sendowner = LEAP.getElement("div[transct=" + LEAP.trans.transct.splitSendOwnerCheck + "]", item);
			
			if (check_sendowner)
			{
				module.addEvent(check_sendowner, 'valueChange', LEAP.trans.__onDirectUserCheckChange_split, this);
				module.addEvent(textarea_sendowner, 'removeItem', LEAP.trans._OnNextOwnerCheckedChange, this);
			}
			
			var showOrgTree = LWFP.innerApi.checkNextOwner(orgTree, owners, allOwners);	
			if (showOrgTree == true)
			{
				if (btn_select)
					btn_select.style.display = "inline-block";
				if (textarea_sendowner)
				{
					textarea_sendowner.setAttribute(LEAP.trans.symbol.canselectuser, "1");	
					textarea_sendowner.setAttribute("actionname", act.actionname);
					LEAP.item.setReadOnly(textarea_sendowner, false);
				}
			}
			else
			{
				if (btn_select)
					btn_select.style.display = "none";
				if (textarea_sendowner)
				{
					textarea_sendowner.setAttribute(LEAP.trans.symbol.canselectuser, "0");
					textarea_sendowner.setAttribute("actionname", act.actionname);
					LEAP.item.setReadOnly(textarea_sendowner, true);
				}
			}
				
			//显示可选/默认用户
			if (act.trgStep.organselecttype == 1 && orgTree)
			{//直接在当前界面选人
				if (btn_select)
					btn_select.style.display = "none";
				if (textarea_sendowner)
					textarea_sendowner.style.display = "none";
					
				if (check_sendowner)
					check_sendowner.style.display = "inline-block";
					
				LEAP.trans.__showDirectUser(check_sendowner, orgTree.singleCheck, owners, allOwners, 
						item.getAttribute("allowSelectAll") == "1"?true:false);
			}
			else
			{
				if (check_sendowner)
					check_sendowner.style.display = "none";
					
				if (textarea_sendowner)
					textarea_sendowner.style.display = "inline-block";
			}
			
			if (textarea_sendowner)
				LEAP.trans.__showowner(textarea_sendowner, owners);		
		}	
		
	}
	finally
	{		
		instance = moduleElement = workflow = splitOwnerPanel = splitOwnerTemplete = html = itemContainer = 
		acts = i = act = item = orgTree = k = __tmp = splitActName = owners = allOwners = btn_select = 
		textarea_sendowner = check_sendowner = showOrgTree = null;
	}	
}

LEAP.trans.__onDirectUserCheckChange_split = function(arg)
{
	try
	{
		var check_sendowner = arg.caller;	
		
		var splitOwnerTemplete = LEAP._match(check_sendowner, LEAP.trans.transct.splitOwnerTemplete, LEAP.trans.n);		
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.splitSendOwner + "]", splitOwnerTemplete);
		
		var nodes = [];	
		var items = LEAP.checkbox2.getCheckedItemElements2(check_sendowner);
		if (items != null)
		{
			for(var i=0; i<items.length; i++)
			{
				nodes.add(items[i]["_data"]);
			}
		}
		
		if (nodes.length == 0)
			nodes = null;		
			
		LEAP.item.setValue(textarea_sendowner, nodes, "__title");
		var p = {caller:textarea_sendowner, _handleEvent_NextOwnerCheckedChange:arg._handleEvent_NextOwnerCheckedChange};
		LEAP.trans._OnNextOwnerCheckedChange(p);
	}
	finally
	{
		check_sendowner = splitOwnerTemplete = textarea_sendowner = nodes = items = i = p = null;
	}	
}

LEAP.trans.__initNextCCOwner = function(action, orgTree, module)
{			
	try
	{
		var instance = module.instance;		
		var moduleElement = module.moduleElement;	
		
		if (action.allowcc && action.allowcc == 1)
		{
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.CCOwnerPanel, true, instance, moduleElement);
		}
		else
		{
			LEAP.trans.__displayOwnerPanel(LEAP.trans.transct.CCOwnerPanel, false, instance, moduleElement);
			
			return;
		}

		var btn_ccSelect = LEAP.getElement("input[transct=" + LEAP.trans.transct.CCBtn + "][instance=" + instance + "]", moduleElement);
		var textarea_ccowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.CCOwner + "][instance=" + instance + "]", moduleElement);
		LEAP.trans.__showCCUser(textarea_ccowner, null);
		
		if (btn_ccSelect)
			btn_ccSelect.removeAttribute("ct");
		
		if (action.allowcc == 1 && action.ccchange != null && action.ccchange != 0)
		{	
			if (btn_ccSelect)
				btn_ccSelect.style.display = "inline-block";
			if (textarea_ccowner)
				LEAP.item.setReadOnly(textarea_ccowner, false);
		}
		else
		{
			if (btn_ccSelect)
				btn_ccSelect.style.display = "none";
			if (textarea_ccowner)
				LEAP.item.setReadOnly(textarea_ccowner, true);
		}
		
		var ownersCC = [];
		if (action.allowcc && action.allowcc == 1 && orgTree && orgTree.ccNodes != null && orgTree.ccNodes.length>0)
		{
			for(var i=0; i<orgTree.ccNodes.length; i++)
				ownersCC.add(orgTree.ccNodes[i]); //.orgObject);
			
			LEAP.trans.__showCCUser(textarea_ccowner, ownersCC);
			
			//LEAP.organSelector.setValue(btn_ccSelect, orgTree.ccNodes);
		}
	}
	finally
	{
		instance = moduleElement = btn_ccSelect = textarea_ccowner = ownersCC = i = null;
	}
}

LEAP.trans.__initRemindControl = function(data, action, module)
{
	try
	{			
		var instance = module.instance;		
		var moduleElement = module.moduleElement;	
		
		var RemindPanel = LEAP.getElement("[transct=" + LEAP.trans.transct.RemindPanel + "][transtct=1][instance=" + instance + "]", moduleElement);		
		var smallNoteDiv = LEAP.getElement("div[transct=" + LEAP.trans.transct.smallNoteDiv + "][transtct=1][instance=" + instance + "]", moduleElement);
		var smallNoteText = LEAP.getElement("textarea[transct=" + LEAP.trans.transct.smallNoteText + "][transtct=1][instance=" + instance + "]", moduleElement);
		var remindCheck = LEAP.getElement("div[transct=" + LEAP.trans.transct.remindCheck + "][transtct=1][instance=" + instance + "]", moduleElement);

		var _remindContent = "";
		
		//清空缓存
		if (smallNoteText)
			smallNoteText.value = "";
		if (remindCheck)
		{
			remindCheck.setAttribute("_remindContent", _remindContent);
			LEAP.checkbox2.setValue(remindCheck, null);
		}
		
		if (RemindPanel)
		{		
			if ( (data.flow.sendsmallnote != 1 && data.flow.remindtype <= 0) || action.toFinish == true || action.toJoin == true)
				RemindPanel.style.display = "none";
			else
				RemindPanel.style.display = "";
		}

		//
		if (data.flow.sendsmallnote == 1)
		{
			if (smallNoteDiv)
				smallNoteDiv.style.display = "block";
		}
		else
		{
			if (smallNoteDiv)
				smallNoteDiv.style.display = "none";
		}
		
		if (remindCheck)
		{
			if (data.flow.remindtype <= 0)
			{
				remindCheck.style.display = "none";
			}
			else
			{
				remindCheck.style.display = "block";
									
				var _val_type = LWFP.innerApi.Decimal2checkValue(data.flow.remindtype, 3);
				var _val_default = LWFP.innerApi.Decimal2checkValue(data.flow.reminddefaulttype, 3);
	
				var _items = LEAP.getElements("[ctf=checkbox2_input]", remindCheck);
				for(var i=0;i<_items.length;i++)
				{
					if( _val_type.indexOf(_items[i].getAttribute("value").Trim()) < 0)
						_items[i].parentElement.style.display = "none";
					else
						_items[i].parentElement.style.display = "inline-block";
				}
					
				LEAP.checkbox2.setValue(remindCheck, _val_default);
				
				if (data.flow.remindtemp == null || data.flow.remindtemp.isEmpty() == true)
				{			
					if (data.entry != null && data.entry.eventname != null)
						_remindContent = "系统提醒您:有标题为【" + data.entry.eventname + "】的事务等待您处理！";
					else if (data.entry != null && data.entry.eventcode != null)				
						_remindContent = "系统提醒您:有编号为【" + data.entry.eventcode + "】的事务等待您处理！";
					else
						_remindContent = "系统提醒您:有新的事务等待您处理！";
				}
				else
				{
					_remindContent = data.flow.remindtemp.replace("{@eventcode}", (data.entry && data.entry.eventcode)? data.entry.eventcode:"")
									.replace("{@eventname}", (data.entry && data.entry.eventname)? data.entry.eventname:"")
									.replace("{@businessname}", (data.entry && data.entry.businessname)? data.entry.businessname:"")
									
									.replace("{@callername}", (data.currentStep && data.currentStep.callername)? data.currentStep.callername:"")
									.replace("{@callerpositionname}", (data.currentStep && data.currentStep.callerpositionname)? data.currentStep.callerpositionname:"")
									.replace("{@callerorganname}", (data.currentStep && data.currentStep.callerorganname)? data.currentStep.callerorganname:"")
									
									.replace("{@ownername}", (data.currentStep && data.currentStep.ownername)? data.currentStep.ownername:"")
									.replace("{@ownerpositionname}", (data.currentStep && data.currentStep.ownerpositionname)? data.currentStep.ownerpositionname:"")
									.replace("{@ownerorganname}", (data.currentStep && data.currentStep.ownerorganname)? data.currentStep.ownerorganname:"");
					
					//{@eventcode}{@eventname}{@businessname}{@callername}{@callerpositionname}{@callerorganname}
				}
				
				remindCheck.setAttribute("_remindContent", _remindContent);					

			}
		}	
	}
	finally
	{
		instance = moduleElement = RemindPanel = smallNoteDiv = smallNoteText = remindCheck = _remindContent = _val_type = _val_default = _items = i = null;
	}
}

LEAP.trans.__showDirectUser = function(check_sendowner, singleCheck, owners, allOwners, showSelectAll)
{
	try
	{
		LEAP.checkbox2.clearItems(check_sendowner);
		LEAP.checkbox2.setValue(check_sendowner, null);
		check_sendowner['ownerlist'] = null;
		
		if (allOwners == null || allOwners.length == 0)
			return;
		
		if (singleCheck == 1)
		{
			check_sendowner.setAttribute("radio", "1");
		}
		else
		{
			if (showSelectAll == true)
			{
				var _splitOwnerTemplete = LEAP._match(check_sendowner, LEAP.trans.transct.splitOwnerTemplete, LEAP.trans.n);			
				var btn_select = LEAP.getElement("input[transct=" + LEAP.trans.transct.splitSelBtn + "]", _splitOwnerTemplete);			
				btn_select.style.display = "inline-block";		
				
				btn_select.setAttribute(LEAP.trans.n, LEAP.trans.transct.splitSelectAll);
				btn_select.setAttribute("_status", 0);
				btn_select.value = "全选";
			}
			
			check_sendowner.setAttribute("radio", "0");
		}
		
		var hash = new hashtable();
		var uhash = new hashtable();
		
		LEAP.trans.__filterDirectUser(hash, uhash, owners);
		LEAP.trans.__filterDirectUser(hash, uhash, allOwners);
		
		var checkids = "";
		if (owners != null && owners.length>0)
		{
			for(var i=0; i<owners.length; i++)
			{
				var node = owners[i];
				if (hash.contains(node.ID))
				{
					var __title = ""
					if (node.nodeType == 0 || node.nodeType == 1)
						node.__title = node.orgObject.cnname;			
					else if (node.nodeType == 2)
						node.__title = ((node.orgObject.fullname != null)?node.orgObject.fullname:node.orgObject.userflag);
						
					checkids += node.ID + ",";
					var item = LEAP.checkbox2.addItem(check_sendowner, node.__title, node.ID, false, node);
					item.style.minWidth = "55px";
					item.style.marginRight = "4px";		
					
					hash.remove(node.ID);
				}
			}
		}
		
		for(var i=0; i<allOwners.length; i++)
		{
			var node = allOwners[i];
			if (hash.contains(node.ID))
			{
				var __title = ""
				if (node.nodeType == 0 || node.nodeType == 1)
					node.__title = node.orgObject.cnname;			
				else if (node.nodeType == 2)
					node.__title = ((node.orgObject.fullname != null)?node.orgObject.fullname:node.orgObject.userflag);
	
				var item = LEAP.checkbox2.addItem(check_sendowner, node.__title, node.ID, false, node);
				item.style.minWidth = "55px";
				item.style.marginRight = "4px";
			}
		}
		
		LEAP.checkbox2.setValue(check_sendowner, checkids);
	}
	finally
	{
		hash = uhash = checkids = i = node = __title = item = _splitOwnerTemplete = btn_select = null; 
	}
}

LEAP.trans.__filterDirectUser = function(hash, uhash, nodes)
{
	try
	{
		if (nodes == null || nodes.length == 0)
			return;
		
		for(var i=0; i<nodes.length; i++)
		{
			var _node = nodes[i];
			if (_node.nodeType == 2)
			{
				if (uhash.contains(_node.userId))
				{
					var __nodeid = uhash.getvalue(_node.userId);
					if (_node.isMaster == 1)
					{
						uhash.add(_node.userId, _node.ID);
						
						hash.remove(__nodeid);
						hash.add(_node.ID, _node.ID);
					}
				}
				else
				{
					uhash.add(_node.userId, _node.ID);
					hash.add(_node.ID, _node.ID);
				}
			}
			else
			{
				hash.add(_node.ID, _node.ID);
			}
		}
	}
	finally
	{
		i = _node = __nodeid = null;
	}	
}

LEAP.trans.__onDirectUserCheckChange = function(arg)
{
	try
	{
		var check_sendowner = arg.caller;		
		
		var module = LEAP.trans.__getmodule(check_sendowner);
		var instance = module.instance;
		var moduleElement = module.moduleElement;
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + instance + "]", moduleElement);
		
		var nodes = [];	
		var items = LEAP.checkbox2.getCheckedItemElements2(check_sendowner);
		if (items != null)
		{
			for(var i=0; i<items.length; i++)
			{
				nodes.add(items[i]["_data"]);
			}
		}
		
		if (nodes.length == 0)
			nodes = null;
		
			
		LEAP.item.setValue(textarea_sendowner, nodes, "__title");	
		var p = {caller:textarea_sendowner, _handleEvent_NextOwnerCheckedChange:arg._handleEvent_NextOwnerCheckedChange};
		LEAP.trans._OnNextOwnerCheckedChange(p);
	}
	finally
	{
		check_sendowner = module = instance = moduleElement = textarea_sendowner = nodes = items = i = p = null;
	}	
}

LEAP.trans.__constructTreeParams = function(action, organTree, domain)
{
	try
	{		
		var realType = 0;
		if (domain.selectorStyleInTransForm == "layer")
		{
			realType = 4;
		}	
		
		if (organTree.authVersion == 2) 
		{//new auth		
			var params = []; 
			for(var i=0; i<organTree.treesByTab.length; i++)
			{
				var tempTree = 	organTree.treesByTab[i];				
				var par = {tabTitle: tempTree.tabName,
			 					type: 1,
			 					searchParam: {_searchFn: LEAP.trans._requestNextOwner, _searchFnDomain:this },	
								data: {nodes:tempTree.nodes},	 		
								operationParam: {lazy: tempTree.lazy,
												treeStyle: tempTree.style,
												treeLevels: tempTree.organlevels,
												treeSingleCheck: tempTree.singleCheck,
												autoCheckChilds: true,
												allowMutiLevelCheck: true,
												rootNodeId: null
											},
								___exdata: {action:action, service:"LWFP.innerApi.getNextOwner", instance:domain.instance },
								___authversion:2
								
							};
			
				params.add(par);
			}
			
			return params;
		}
		else if (organTree.authVersion == 3) 
		{//new auth						
			var params = []; 
			for(var i=0; i<organTree.treesByTab.length; i++)
			{
				var tempTree = 	organTree.treesByTab[i];	
				if (tempTree.tabType == 301)
				{//常用联系人)
					if (tempTree.frequentContacts != null)
					{							
						var par = {tabTitle: tempTree.tabName,	
			 						type: 3,
			 						isFrequentcontact:true,
			 						data: tempTree.frequentContacts,
			 						operationParam:{treeSingleCheck: tempTree.singleCheck}
							}
						
						params.add(par);	
					}
				}
				else
				{
					var par = {tabTitle: tempTree.tabName,
				 					type: realType,
				 					searchParam: {_searchFn: LEAP.trans._requestNextOwner, _searchFnDomain:this },	
									data: {nodes:tempTree.nodes},	 		
									operationParam: {lazy: tempTree.lazy,
													treeStyle: tempTree.style,
													treeLevels: tempTree.organlevels,
													treeSingleCheck: tempTree.singleCheck,
													autoCheckChilds: true,
													allowMutiLevelCheck: true,
													rootNodeId: null
												},
									___exdata: {action:action, service:"LWFP.innerApi.getNextOwner", instance:domain.instance },
									___authversion:2
									
								};
				
					params.add(par);
				}
			}
			
			return params;
		}
		else
		{
			var params = []; 
			var tabs = organTree.tabs;
			if (tabs == null)
			{
				tabs = [];
				tabs.add({tabname: "联系人",	tabtype: 90});
			}
			
			for(var i=0; i<tabs.length; i++)
			{//0常用联系人1本部门2本单位3所有组织用户90自定义99全部合法用户
				var tab = tabs[i];
				if (tab.tabtype == "0") //0常用联系人
				{
					if (organTree.frequentContacts != null)
					{
						var par = {tabTitle: tab.tabname,	
			 						type: 3,
			 						isFrequentcontact:true,
			 						data: organTree.frequentContacts,
			 						operationParam:{treeSingleCheck: organTree.singleCheck}
							}
						
						params.add(par);
					}
				}
				else if (tab.tabtype == "1" || tab.tabtype == "2") //1本部门2本单位
				{					
					var par = {tabTitle: tab.tabname,
			 					type: realType,
			 					searchParam: {_searchFn: LEAP.trans._requestNextOwner, _searchFnDomain:this },	
								data: {nodes:organTree.nodes},	 		
								operationParam: {lazy: organTree.lazy,
												treeStyle: organTree.style,
												treeLevels: organTree.organlevels,
												treeSingleCheck: organTree.singleCheck,
												autoCheckChilds: true,
												allowMutiLevelCheck: true,
												rootNodeId: (tab.tabtype == "1") ? organTree.currentOrganID : organTree.upperlayerOrganID, //TODO
												rootNodeSyscode:(tab.tabtype == "1") ? organTree.currentOrganSyscode : organTree.upperlayerOrganSyscode
											},
								___exdata: {action:action, service:"LWFP.innerApi.getNextOwner", instance:domain.instance }
							}
					
					params.add(par);
				}
				else if (tab.tabtype == "3") //3所有组织用户
				{		
					var par = {tabTitle: tab.tabname,
			 					type: realType,
			 					searchParam: {_searchFn: LEAP.trans._requestNextOwner, _searchFnDomain:this },
								data: null,	 		
								operationParam: {lazy: organTree.lazy,
												treeStyle: organTree.style,
												treeLevels: organTree.organlevels,
												treeSingleCheck: organTree.singleCheck,
												autoCheckChilds: true,
												allowMutiLevelCheck: true,
												rootNodeId: null
											},
								___exdata: {action:action, service:"WfGetAllOwner", instance:domain.instance }
							}
					
					params.add(par);
				}
				else if (tab.tabtype == "90")
				{
					var par = {tabTitle: tab.tabname,
			 					type: realType,
			 					searchParam: {_searchFn: LEAP.trans._requestNextOwner, _searchFnDomain:this },	
								data: (organTree.customNodes != null) ? {nodes:organTree.customNodes} : {nodes:organTree.nodes},	 		
								operationParam: {lazy: organTree.lazy,
												treeStyle: organTree.style,
												treeLevels: organTree.organlevels,
												treeSingleCheck: organTree.singleCheck,
												autoCheckChilds: true,
												allowMutiLevelCheck: true,
												rootNodeId: null
											},
								___exdata: {action:action, service:"LWFP.innerApi.getNextOwner", instance:domain.instance }
							}

					params.add(par);	
				}
				else if (tab.tabtype == "99")
				{
					var par = {tabTitle: tab.tabname,
			 					type: realType,
			 					searchParam: {_searchFn: LEAP.trans._requestNextOwner, _searchFnDomain:this },	 //TODO				
								data: {nodes:organTree.nodes},	 		
								operationParam: {lazy: organTree.lazy,
												treeStyle: organTree.style,
												treeLevels: organTree.organlevels,
												treeSingleCheck: organTree.singleCheck,
												autoCheckChilds: true,
												allowMutiLevelCheck: true,
												rootNodeId: null
											},
								___exdata: {action:action, service:"LWFP.innerApi.getNextOwner", instance:domain.instance }
							}
					
					params.add(par);
				}				
			}
			
			return params;
		} //end 老权限
	
	}
	finally
	{
		params =  i=tempTree = 	par = null;
	}	
}

LEAP.trans._requestNextOwner = function(arg)
{
	try
	{
		var module = LEAP.trans.__getmodule(arg.treeParam.___exdata.instance);
		var workflow = module.workflow;
		var WFData = workflow.getData();
				
		if (arg.treeParam.___exdata.service == "LWFP.innerApi.getNextOwner")
		{				
			var lazyChilds = LWFP.innerApi.getNextOwner(module, {param:new WFParameter().getParameter(WFData)
																	.setCsid(WFData.currentStep.csid)
																	.setNextActionName(arg.treeParam.___exdata.action.actionname)
																	.setTopOrgan(false)
																	.setLazy(true)
																	.setLazyid(arg.lazyParam.lazyId)
																	.setLazysyscode(arg.lazyParam.lazySyscode)
																	.setLazyout(arg.lazyParam.lazyOut)
												   } );
			if (lazyChilds != null)
			{
				if (arg.lazyParam && arg.lazyParam.___authversion && arg.lazyParam.___tabTitle)
				{
					for(var i=0; i<lazyChilds.treesByTab.length; i++)
					{
						if (lazyChilds.treesByTab[i].tabName == arg.lazyParam.___tabTitle)
						{
							return lazyChilds.treesByTab[i];
						}						
					}
					
					return null;
				}
				else if (arg.treeParam.___exdata.splitAction != null)
				{
					for(var i=0; i<lazyChilds.splitTrees.length; i++)
					{
						if (lazyChilds.splitTrees[i].nextActionId == arg.treeParam.___exdata.splitAction.actionid)
							return lazyChilds.splitTrees[i];
					}
				}
				else
				{													   
					return lazyChilds;
				}
			}
			
			return null;
		}
		else if (arg.treeParam.___exdata.service == "WfGetAllOwner")
		{
			var lazyChilds = module.request2({name:'WfGetAllOwner', par:{flowId: WFData.flow.flowid, 
														actionId: arg.treeParam.___exdata.action.actionid, 
														toporg: false, 
														lazy: true, 
														lazyId: arg.lazyParam.lazyId, 
														lazysyscode: arg.lazyParam.lazySyscode, 
														lazyOut: arg.lazyParam.lazyOut}});
														
			if (lazyChilds != null)
			{
				if (arg.treeParam.___exdata.splitAction != null)
				{
					for(var i=0; i<lazyChilds.splitTrees.length; i++)
					{
						if (lazyChilds.splitTrees[i].nextActionId == arg.treeParam.___exdata.splitAction.actionid)
							return lazyChilds.splitTrees[i];
					}
				}
			}
		
			return lazyChilds;				
		}
		else
		{
			LEAP.messagebox.alert('err_transform');
		}
		
		return null;
	}
	finally
	{
		module = workflow = WFData = lazyChilds = i= null;
	}		
}

LEAP.trans._searchOwner = function(arg)
{
	try
	{
		var module = LEAP.trans.__getmodule(arg.searchParam.instance);
		var workflow = module.workflow;
		var WFData = workflow.getData();
		
		var _searchData = null;
		if (arg.searchParam.isCC == true)
		{
			var range = {toporg:true, organRange:null, roleRange:null,excludeRolenameRanges:null,excludeUserTypes:null};
			if (module.WFGetCCUserRange != null)				
				range = module.WFGetCCUserRange({action:null, entry:workflow.getEntry()});			
			
			range.toporg = range.toporg == null ? true:range.toporg;
				
			_searchData = module.request2({name:'searchWFContact', par:{toporg:range.toporg, organIds:range.organRange, roleNames:range.roleRange, organType:2, 
										not_rolenames:range.excludeRolenameRanges?range.excludeRolenameRanges:null,not_usertypes:range.excludeUserTypes?range.excludeUserTypes:null,key: arg.key}});									
		}
		else
		{
			var actionid = arg.searchParam.action.actionid;
			_searchData = module.request2({name:'WfSearchNextOwner', par:{datasource:null, 
										actionId: actionid,
										entryId: WFData.entry.entryid,
										csid: WFData.CSID,
										key: arg.key}});
		}
		
		return _searchData;
	}
	finally
	{
		module = workflow = WFData = actionid = _searchData = null;
	}
}
	
LEAP.trans.__selectUser = function(element, autoDoactionName, selectActionName)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;
		var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + module.instance + "]", module.moduleElement);
		if (chkbox == null)
			return;
			
		if (workflow.getEntry() == null)
		{//流程未启动，先保存
			var __itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
				__itm = __itm[0];
			var _act =  LEAP.checkbox2.getItemData(__itm);
				
			var ret = module.innerWFModuleSubmit({mustRefreshPage:true});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			if (ret == true)
			{	
				LEAP.trans.__selectUser(element, null, _act.actionname);
			}
			
			return;
		}
		
		if (selectActionName)
		{
			var flag = LEAP.trans._send_changeAction(module, selectActionName);
			if (flag != true)
				return;
		}
		
		var itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
		itm = itm[0];
		var ___action = itm["_data"];		
		var ___orgTree = itm["___orgTree"];
		
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + module.instance + "]", module.moduleElement);
		var value = LEAP.item.getValue(textarea_sendowner);
		var param = LEAP.trans.__constructTreeParams(___action, ___orgTree, module);
		
		if (module.WFSelectOwner)
		{//项目自己选人
			module.WFSelectOwner({action:___action, 
									selectedOwners:value, 
									callbackFunc:LEAP.trans.__userSelectCallBack_, 
									callbackParam:{instance:module.instance, autoDoactionName:autoDoactionName}
								});
		}
		else
		{				
			LEAP.TreeSelector.showSelectForm(module, param, value, 
											{title:"选择下一环节执行人", width:900, height:535, formtype:3}, 
											LEAP.trans.__userSelectCallBack, 
											{autoDoactionName:autoDoactionName, instance:module.instance}, 
											null, 
											LEAP.trans._searchOwner, 
											{instance:module.instance, action:___action});
		}
	}
	finally
	{
		module = workflow = chkbox = __itm = _act =  ret = flag = itm = ___action = ___orgTree = textarea_sendowner = value = param = null;
	}
}

LEAP.trans.__selectUser_CC = function(element)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;
		var moduleElement = module.moduleElement;
		var textarea_ccowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.CCOwner + "][instance=" + module.instance + "]", moduleElement);
			
		var ownersCC = LEAP.item.getValue(textarea_ccowner);	
		
		var realType = 0;
		if (module.selectorStyleInTransForm == "layer")
		{
			realType = 4;
		}	
		
		var param = [{tabTitle: "抄送",	
					type: realType,
					searchParam: {
				 					topOrgan:1,	 		
									organRanges:null, 
									includeOrganRange:1,
									rolenameRanges:null,
									nodetype:2					
								},					
					data:null,	 		
					operationParam:{
										lazy:true,
										treeStyle:1,
										treeLevels:3,
										treeSingleCheck:0,
										autoCheckChilds:true,
										allowMutiLevelCheck:true
									}								
				}];
				
		if (module.WFGetCCUserRange != null)
		{
			var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + module.instance + "]", moduleElement);
			if (chkbox != null)
			{				
				var itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
				if (itm != null)
				{
					itm = itm[0];
					var _act =  LEAP.checkbox2.getItemData(itm);
					
					var range = module.WFGetCCUserRange({action:_act, entry:workflow.getEntry()});					
					if (range != null)
					{
						param[0].searchParam.organRanges = range.organRange;
						param[0].searchParam.rolenameRanges = range.roleRange;
						param[0].searchParam.toporg = range.toporg == null ? true:range.toporg;
						param[0].searchParam.excludeRolenameRanges = range.excludeRolenameRanges?range.excludeRolenameRanges:null;
			            param[0].searchParam.excludeUserTypes = range.excludeUserTypes?range.excludeUserTypes:null;
					}
				}				
			}			
		}
		
		LEAP.TreeSelector.showSelectForm(module, param, ownersCC, 
											{title:"选择抄送人", width:900, height:535, formtype:3}, 
											LEAP.trans.__userSelectCallBack_CC, 
											{instance: module.instance}, 
											null, 
											LEAP.trans._searchOwner, 
											{instance: module.instance, isCC:true});
	}
	finally
	{
		module = workflow = moduleElement = textarea_ccowner = ownersCC = param = chkbox = itm = _act = range = null;
	}
}

LEAP.trans.__userSelectCallBack_ = function(selectedOwner, param)
{
	LEAP.trans.__userSelectCallBack({selectedNodes:selectedOwner}, param);
}
LEAP.trans.__userSelectCallBack = function(selectedOwner, param)
{
	try
	{	
		var module = LEAP.trans.__getmodule(param.instance);
				
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + module.instance + "]", module.moduleElement);
		if (textarea_sendowner)
		{
			LEAP.trans.__showowner(textarea_sendowner, selectedOwner.selectedNodes);	
			var p = {caller:textarea_sendowner};
			LEAP.trans._OnNextOwnerCheckedChange(p);
		}
		
		if (param.autoDoactionName != null)
			LEAP.trans.__send(textarea_sendowner, false, param.autoDoactionName);
	}
	finally
	{
		module = textarea_sendowner = p = null;
	}
}

LEAP.trans.__userSelectCallBack_CC = function(arg, param)
{
	try
	{
		var module = LEAP.trans.__getmodule(param.instance);			
		var textarea_ccowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.CCOwner + "][instance=" + module.instance + "]", module.moduleElement);
		
		var arr = null;
		if (arg && arg.selectedNodes)
		{
			arr = [];
			for(var i=0; i<arg.selectedNodes.length; i++)
				arr.add(arg.selectedNodes[i]);
		}
		
		LEAP.trans.__showCCUser(textarea_ccowner, arr);	
	}
	finally
	{
		module = textarea_ccowner = arr = i = null;
	}	
}

LEAP.trans.__selectUser_split = function(element)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;
		var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + module.instance + "]", module.moduleElement);
		if (chkbox == null)
			return;
		
		var itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
			itm = itm[0];
		var mainAction =  LEAP.checkbox2.getItemData(itm);
		
		var _splitOwnerTemplete = LEAP._match(element, LEAP.trans.transct.splitOwnerTemplete, LEAP.trans.n);
		var splitAction = _splitOwnerTemplete["splitAction"];
		
		LEAP.trans.__selectUser_split_(module, mainAction, splitAction);
	}
	finally
	{
		module = workflow = chkbox = itm = mainAction = _splitOwnerTemplete = splitAction = null;
	}
}

LEAP.trans.__selectUser_split_ = function(module, mainAction, splitAction)
{
	try
	{	
		var workflow = module.workflow;
		//var flag = true;
		if (workflow.getEntry() == null)
		{//流程未启动，先保存
			var ret = module.innerWFModuleSubmit({mustRefreshPage:true});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			if (ret == true)
			{	
				LEAP.trans.__selectUser_split_(module, mainAction, splitAction);
			}
			
			return;
		}
		
		var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + module.instance + "]", module.moduleElement);
		if (chkbox == null)
			return;
			
		var itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
		itm = itm[0];
		var _mainAction = itm["_data"];
		if (_mainAction.actionname != mainAction.actionname)
		{
			var b = LEAP.trans._send_changeAction(module, mainAction.actionname);
			if (b != true)
				return;
		}
				 
		var splitOwnerTemplete = LEAP.getElement("[transct=" + LEAP.trans.transct.splitOwnerTemplete + "][splitActionId=" + splitAction.actionid + "]", module.moduleElement);
		if (!splitOwnerTemplete)
			return;
		
		var btn_select = LEAP.getElement("input[transct=" + LEAP.trans.transct.splitSelBtn + "]", splitOwnerTemplete);
		if (btn_select.style.display == "none")
		{
			LEAP.messagebox.alert("未能确定下一步骤可选执行人！");
			return;
		}
			
		itm = LEAP.checkbox2.getCheckedItemElements2(chkbox)[0];		
		var mainTree = itm["___orgTree"];
		var splitTree = null;
		if (mainTree.splitTrees)
		{
			for(var i=0; i<mainTree.splitTrees.length; i++)
			{
				var __tmpTree = mainTree.splitTrees[i];  
				if (__tmpTree && __tmpTree.nextActionId == splitAction.actionid)
				{
					splitTree = __tmpTree;
					break;
				}
			}
		}

		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.splitSendOwner + "]", splitOwnerTemplete);
		var value = LEAP.item.getValue(textarea_sendowner);
		var param = LEAP.trans.__constructTreeParams(mainAction, splitTree, module);
		
		for(var i=0; i<param.length; i++)
		{
			if (param[i].___exdata)
				param[i].___exdata.splitAction = splitAction;
		}

		if (module.WFSelectOwner)
		{//项目自己选人
			module.WFSelectOwner({action:splitAction, 
									selectedOwners:value, 
									callbackFunc:LEAP.trans.__selectUser_split_callback_, 
									callbackParam:{instance:module.instance, splitOwnerTemplete:splitOwnerTemplete}
								});
		}
		else
		{		
			LEAP.TreeSelector.showSelectForm(module, param, value, 
											{title:"选择下一环节执行人", width:900, height:535, formtype:3}, 
											LEAP.trans.__selectUser_split_callback, 
											{instance:module.instance, splitOwnerTemplete:splitOwnerTemplete}, 
											null, 
											LEAP.trans._searchOwner, 
											{instance:module.instance, action:mainAction});
		}
	}
	finally
	{	
		workflow = ret = chkbox = itm = _mainAction = b = splitOwnerTemplete = btn_select = mainTree = splitTree = i = 
		__tmpTree = value =  param = null;
	}
}

LEAP.trans.__selectUser_split_callback_ = function(selectedOwner, param)
{
	LEAP.trans.__selectUser_split_callback({selectedNodes:selectedOwner}, param);
}

LEAP.trans.__selectUser_split_callback = function(selectedOwner, param)
{
	try
	{
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.splitSendOwner + "]", param.splitOwnerTemplete);
		if (textarea_sendowner)
		{
			LEAP.trans.__showowner(textarea_sendowner, selectedOwner.selectedNodes);	
			var p = {caller:textarea_sendowner};
			LEAP.trans._OnNextOwnerCheckedChange(p);
		}
	}
	finally
	{
		textarea_sendowner = p = null;
	}
}

LEAP.trans.__selectAll_split = function(element)
{
	try
	{
		var btn_select = element;		
		var splitOwnerTemplete = LEAP._match(btn_select, LEAP.trans.transct.splitOwnerTemplete, LEAP.trans.n);	
		var check_sendowner = LEAP.getElement("div[transct=" + LEAP.trans.transct.splitSendOwnerCheck + "]", splitOwnerTemplete);
		
		var status = btn_select.getAttribute("_status");
		if (status == "0")
		{
			LEAP.checkbox2.checkedAll(check_sendowner, true);			
			btn_select.setAttribute("_status", "1");
			btn_select.value = "全部取消";			
		}
		else
		{
			LEAP.checkbox2.checkedAll(check_sendowner, false);
			btn_select.setAttribute("_status", "0");
			btn_select.value = "全选";		
		}
		var p = {caller:check_sendowner};
		LEAP.trans.__onDirectUserCheckChange_split(p);	
		
	}
	finally
	{
		btn_select = splitOwnerTemplete = check_sendowner = status = p = null;
	}
}

/*LEAP.trans.__organSelectorCallBack = function(arg)
{
	try
	{
		var module = this.__getmodule(arg.caller);	
		var textarea_ccowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.CCOwner + "][instance=" + module.instance + "]", module.moduleElement);
		
		LEAP.trans.__showCCUser(textarea_ccowner, arg.value);	
	}
	finally
	{
		module = textarea_ccowner = null;
	}	
}*/

LEAP.trans.__save = function(element, silence)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		
		if (element.getAttribute('skipValidate') != null && element.getAttribute('skipValidate')=="1")
			module.skipValidate = true;
		
		var b = module.innerWFModuleSubmit({mustRefreshPage:true});
		if (module[LWFP.ENUM.form_closed_after_submit] == true)
			return;
		//if (b == true && (!(silence == true)))
		//	LEAP.messagebox.alert('保存成功！');
			
		return b;
	}
	finally
	{
		module.skipValidate = false;
		module = null;
	}
}

LEAP.trans._send_changeAction = function(domain, actionname, forceRefresh)
{
	try
	{
		var instance = domain.instance;
		var moduleElement = domain.moduleElement;
		var workflow = domain.workflow;
		var wfdata = workflow.___data;
		
					
		var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + instance + "]", moduleElement);
		if (chkbox == null)
			return;
		
		var items = LEAP.checkbox2.getItems(chkbox);
		if (items == null)
			return;
			
		for(var i=0; i<items.length; i++)
		{
			var item = items[i];
			var action = LEAP.checkbox2.getItemData(item);
			if (action.actionname == actionname)
			{
				var value = LEAP.checkbox2.getItemValue(item);
				
				LEAP.checkbox2.setValue(chkbox, value);
				var p = {caller:chkbox};
				
				if (true == forceRefresh)
				{
					LEAP.trans.__onActionChange(p);
				}
				else if ("0" == chkbox.getAttribute("refresh"))
				{
					//禁止刷新动作，不重新getNextOwner
				}
				else if ("2" == chkbox.getAttribute("refresh"))
				{//不刷新动作，但重新getNextOwner
					item["___orgTree"] = null;
					LEAP.trans.__onActionChange({caller:chkbox});
				}
				else
				{					
					LEAP.trans.__onActionChange(p);
				}
				
				return true;
			}
		}
	}
	finally
	{
		instance = moduleElement = workflow = wfdata = chkbox = items = i = item = action = value = p = null;
	}
}

LEAP.trans.__ahead = function(element)
{
	try
	{		
		var action = element[LEAP.trans.symbol.aheadActData];		
		LEAP.trans.___send(element, false, action.actionname);				
	}
	finally
	{
		action = null;
	}	
}

LEAP.trans.__send_form = function(element, save, action)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;
		var wfdata = workflow.getData();
		
		var flag = true;
		if (save != null)
			flag = save;
			
		if (module && module.WFForceSave)
		{
			if (module.WFForceSave(action) == true )
				flag = true;
		}
		
		if (wfdata.entry == null)
			flag = true;
		
		if (flag == true)
		{//保存表单
			var ret = module.innerWFModuleSubmit({autoRefreshTransControl:true, silence:true});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			if (ret != true)
				return;
		}
		
		if (module.WFBeforeShowTransForm)
		{
			if (module.WFBeforeShowTransForm(action) != true)
				return;
		}		
		
		if (module.WFGetTransForm)
		{
			if (module.__TransForm != null)
			{
				module.__TransForm.module.dispose();
				module.__TransForm = null;
			}		
		}

		var x = null;
		var y = null;
		var h = (document.body.clientHeight-80) ;
		var w = Math.round( (document.body.clientHeight-80) / 0.8 ) ;
				
		if (document._isNewWfWindow && LEAPBrowser.isChrome && document.body.style.zoom)
		{
			h = Math.round( (document.body.clientHeight-80) / Number(document.body.style.zoom) );
			w = Math.round( (document.body.clientHeight-80) / ( 0.8 * Number(document.body.style.zoom)) );			
		}
		
		if (window.WorkflowTransformRect != null)
		{
			x = window.WorkflowTransformRect.x;
			y = window.WorkflowTransformRect.y;
			w = window.WorkflowTransformRect.w;
			h = window.WorkflowTransformRect.h;			
		}
				
		if (module.__TransForm == null)
		{			
			var transFormDef = null; 
			if (module.WFGetTransForm)
				transFormDef = module.WFGetTransForm(action);
			if (transFormDef == null)
			{				
				transFormDef = {name:"LBPMRTM.transform", title:"转下一步", 
								formtype:3, 
								x:x, 
								y:y, 
								width: w,  //1000,
								height: h //(document.body.clientHeight-60)?(document.body.clientHeight-60):730;
								};
			}
			
			
			module.__TransForm = module.loadForm3(transFormDef);
			LEAP.form.hide(module.__TransForm.form);
		}
		
		if (module.__TransForm != null)
		{
			var showAheadAction = (element.getAttribute("showAheadAction") == "0") ? false:true;
			var showOtherAction = (element.getAttribute("showOtherAction") == "0") ? false:true;
			
			module.__TransForm.module.___hided___ = false; 
			var b = module.__TransForm.module.__init(module.workflow, action, {showAheadAction:showAheadAction, showOtherAction:showOtherAction});
			if (module.__TransForm && module.__TransForm.module)
			{
				if (b == true)
				{
					if (module.__TransForm.module.___hided___ != true) //也许自动发送动作就提前hide了，这里就不在show
					{
						LEAP.form.show(module.__TransForm.form);
					}
				}
				else 
				{
					module.__TransForm.module.hideForm();
				}
			}
		}		
	}
	finally
	{
		module = workflow = wfdata = flag = ret = transFormDef = b = null;
	}
}

/**
 * 发送（供原生动作按钮click调用）
 */
LEAP.trans.____send = function(element)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;
		var wfdata = workflow.___data;	
				
		if (element.getAttribute("popup") == "1")
		{
			var pop = LEAP.popupMenu.getPop();
			LEAP.popupMenu.removeAll(pop);
			LEAP.popupMenu.setWidth(pop, "auto");
			
			for(var i=0; i<wfdata.nextActions.length; i++)
			{
				var act = wfdata.nextActions[i]; 
				LEAP.popupMenu.addItem(pop, act.actionid, act.aliasname, {action:act, element:element});				
			}
			
			ElementEventManager.removeEvent(pop, 'OnClick', null);
			LEAP.addEvent(pop,'OnClick', LEAP.trans.____send_popup, null, this, true);
			
			LEAP.popupMenu.show(pop);
		}
		else
		{
			LEAP.trans.___send(element);
		}
	}
	finally
	{
		module = workflow = wfdata = i = act = pop = null;
	}
}

LEAP.trans.____send_popup = function(arg)
{
	LEAP.popupMenu.__uncover();
	LEAP.popupMenu.hidden();
					
	LEAP.trans.___send(arg.arg2.data.element, true, arg.arg2.data.action.actionname);
}

/**
 * 供提前动作调用
 * @param {} element
 * @param {} save
 * @param {} autoDoactionName
 */
LEAP.trans.___send = function(element, save, autoDoactionName)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		
		if (module.WFBeforeOpenTransForm)
		{
			var _act = null;		
			if (autoDoactionName != null)
			{
				var workflow = module.workflow;
				var wfdata = workflow.___data;			
				_act = LWFP.innerApi.getActionByName(wfdata.nextActions, autoDoactionName);
			}	
				
			if (module.WFBeforeOpenTransForm(_act) != true)
				return;
		}		
	
		LEAP.trans.__send(element, save, autoDoactionName);
	}
	finally
	{
		module = _act = workflow = wfdata = null;
	}
}


/**
 * 
 * @param {} domain 
 * @param {} saveModule 是否要保存表单
 * @param {} actionName 动做名称
 */
LEAP.trans.doAction = function(domain, saveModule, actionName)
{
	LEAP.trans.__send(domain.instance, saveModule, actionName)
}

/**
 * 发送（供api调用）
 */
LEAP.trans.__send = function(element, save, autoDoactionName)
{
	try
	{
		//LEAP.showMask();
		
		var module = LEAP.trans.__getmodule(element);
		var instance = module.instance;
		var moduleElement = module.moduleElement;
		var workflow = module.workflow;
		var wfdata = workflow.___data;
		
		var sendpanel = LEAP.getElement("[transct=" + LEAP.trans.transct.SendPanel + "][instance=" + instance + "]", moduleElement);		
		if (!sendpanel)
		{		
			var ____action = null;
			if (autoDoactionName != null)
				____action = LWFP.innerApi.getActionByName(wfdata.nextActions, autoDoactionName)

			LEAP.trans.__send_form(element, save, ____action);
			return;
		}
		
		var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + instance + "]", moduleElement);
		if (chkbox == null)
		{
			LEAP.messagebox.alert("未能确定下一步骤！");			
			return;
		}

		var itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
		if (itm == null)
		{
			LEAP.messagebox.alert("请选择下一步骤！");	
			return;
		}
		
		itm = itm[0];
		var _act =  LEAP.checkbox2.getItemData(itm);		
		if (autoDoactionName != null && autoDoactionName != _act.actionname)
		{
			LEAP.trans._send_changeAction(module, autoDoactionName, true);
			itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
			itm = itm[0];
			_act =  LEAP.checkbox2.getItemData(itm);
		}
		
		if (_act.toSplit == true)
		{
			LEAP.trans.__send_split(module, _act);
			return;
		}
		
		var btn_select = LEAP.getElement("input[transct=" + LEAP.trans.transct.SelBtn + "][instance=" + instance + "]", moduleElement);
		var btn_ccSelect = LEAP.getElement("input[transct=" + LEAP.trans.transct.CCBtn + "][instance=" + instance + "]", moduleElement);	
		var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + instance + "]", moduleElement);
		var textarea_ccowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.CCOwner + "][instance=" + instance + "]", moduleElement);
		
		var smallNoteText = LEAP.getElement("textarea[transct=" + LEAP.trans.transct.smallNoteText + "][transtct=1][instance=" + instance + "]", moduleElement);
		var remindCheck = LEAP.getElement("div[transct=" + LEAP.trans.transct.remindCheck + "][transtct=1][instance=" + instance + "]", moduleElement);
		
		var owners = LEAP.item.getValue(textarea_sendowner);	
		var ownersCC = LEAP.item.getValue(textarea_ccowner);	
		var smallNote = (smallNoteText == null)?null:smallNoteText.value.trim();
		var remind = null;
		if (remindCheck)
		{
			var __v = LEAP.checkbox2.getValue(remindCheck);
			if (__v)
				remind = {remindType:LWFP.innerApi.checkValue2Decimal(__v), remindContent:remindCheck.getAttribute("_remindContent") }; 
		}
		
		var flag = false;
		if (module && module.WFForceSave)
		{
			if (module.WFForceSave(_act) == true )
				flag = true;
		}
		
		if ((save != false && _act.runahead != 1) || wfdata.entry == null || flag == true)
		{			
			var ret = module.innerWFModuleSubmit({autoRefreshTransControl:true, silence:true});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			if (ret != true)
				return;
				
			if (autoDoactionName != null)
			{
				LEAP.trans._send_changeAction(module, autoDoactionName);
			}
			else
			{
				if (owners == null && ownersCC == null)
				{
					LEAP.trans._send_changeAction(module, _act.actionname);
					
					var owners = LEAP.item.getValue(textarea_sendowner);	
					var ownersCC = LEAP.item.getValue(textarea_ccowner);
				}
			}
		
			workflow = module.workflow;
			
			if (smallNote)
				smallNoteText.value = smallNote;
		}
				
		//LEAP.showMask();
		
		if (module.WFBeforeSend)
		{
			if (module.WFBeforeSend(_act) != true)
					return;
		}		
		
		//整理用户
		var arrOwner1 = new Array();
		var arrOwner2 = new Array();
		var arrOwner3 = new Array();			
		if (owners != null && owners.length >0)
		{
			for(var i=0; i<owners.length; i++)
			{
				if (owners[i].nodeType == 2 || owners[i].nodeType == 11)
					arrOwner1.add(owners[i].orgObject);
				else if (owners[i].nodeType == 1)
					arrOwner2.add(owners[i].orgObject);
				else if (owners[i].nodeType == 0 || owners[i].nodeType == 10)
					arrOwner3.add(owners[i].orgObject);
			}
		}
		
		var canselectuser = textarea_sendowner.getAttribute(LEAP.trans.symbol.canselectuser);
				
		if (arrOwner1.length == 0 && arrOwner2.length == 0 && arrOwner3.length == 0 
			&& _act.toFinish == false 
			&& _act.toJoin == false 
			&& (_act.toSplit==null || _act.toSplit == false)
			&& ( (_act.allowolnycc == null || _act.allowolnycc==0) 
					 || ( (_act.allowolnycc != null && _act.allowolnycc == 1) && ownersCC==null)				   
				   )
			)				
		{
			if ((module.WFSelectOwner == null) && (canselectuser == null || canselectuser == "0")) //(btn_select.style.display.toLowerCase() == "none")
			{
				alert("无法获取后续环节可执行人,请检查流程权限配置!");
			}
			else
			{					
				//alert("请选择后续环节执行人！");
				LEAP.trans.__selectUser(element, _act.actionname, null);
			}
			
			return;
		}
		
		//抄送用户
		if (ownersCC != null && ownersCC.length>0)
		{
			for(var i=0; i<ownersCC.length; i++)
			{
				ownersCC[i].orgObject.exflagA = 1;
				arrOwner1.add(ownersCC[i].orgObject);
			}
		}
		
		if (arrOwner1.length == 0)
			arrOwner1 = null;
		if (arrOwner2.length == 0)
			arrOwner2 = null;
		if (arrOwner3.length == 0)
			arrOwner3 = null;
			
		var b_result = module.request2({name:'WfDoAction',
										par:{param: new WFParameter().getParameter(workflow.___data)
														.setNextActionName(_act.actionname)
														.setCsid(workflow.___data.CSID)
														.setNextOwner1(arrOwner1)
														.setNextOwner2(arrOwner2)
														.setNextOwner3(arrOwner3)
														.setSmallNote(smallNote)
														.setRemind(remind)														
													},
													urlpar:{service_subcategory:_act.actionid}
												});

		if (b_result && b_result == true)
		{
			//var msg = (_act.confirmmsg==null || _act.confirmmsg.isEmpty()==true)? "操作成功！":_act.confirmmsg ;
			//LEAP.messagebox.alert(msg);
			
			if (_act.trgStep && _act.trgStep.steptype == 5 )
			{//挂起关闭运行界面
				module.hideForm();
			}
			else
			{//刷新界面				
				module._WF_ModuleProcess_refreshPage(0, null, {key:"doaction", actionName:_act.actionname});
			}
		}
		else
		{
			var err = leapclient.getLastWarring();
			if(err != null)
				LEAP.messagebox.alert(err);
			else
				LEAP.messagebox.alert("操作失败！");
		}
	}
	catch(e)
	{		
		LEAP.messagebox.alert(e.message);
	}
	finally
	{	
		LEAP.hideMask();
		
		module = instance = moduleElement = workflow = wfdata = sendpanel = ____action = chkbox = itm = null; 
		_act =  btn_select = btn_ccSelect = textarea_sendowner = textarea_ccowner = smallNoteText = null;
		remindCheck = owners = ownersCC = smallNote = remind = __v = ret = owners = ownersCC = arrOwner1 = null;
		arrOwner2 = arrOwner3 = i=canselectuser = b_result = msg = err = null;
	}	
}

LEAP.trans.__send_split = function(module, mainAct, save)
{
	try
	{	
		var instance = module.instance;
		var moduleElement = module.moduleElement;
		var workflow = module.workflow;
		var wfdata = workflow.___data;
		
		if (workflow.getEntry() == null)
		{//流程未启动，先保存
			var ret = module.innerWFModuleSubmit({mustRefreshPage:true});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			if (ret == true)
			{	
				var b = LEAP.trans._send_changeAction(module, mainAct.actionname);
				if (b != true)
					return;
				
				LEAP.trans.__send_split(module, mainAct, false);
			}
			
			return;
		}
		
		var chkbox = LEAP.getElement("div[transct=" + LEAP.trans.transct.Nextact + "][instance=" + instance + "]", moduleElement);
		var itm = LEAP.checkbox2.getCheckedItemElements2(chkbox);
			itm = itm[0];
		var mainAction =  LEAP.checkbox2.getItemData(itm);
		
		var splitOwnerPanel = LEAP.getElement("[transct=" + LEAP.trans.transct.SplitOwnerPanel + "]", moduleElement);
		var smallNoteText = LEAP.getElement("textarea[transct=" + LEAP.trans.transct.smallNoteText + "]", moduleElement);
		var remindCheck = LEAP.getElement("div[transct=" + LEAP.trans.transct.remindCheck + "][transtct=1]", moduleElement);
		var smallNote = (smallNoteText == null)?null:smallNoteText.value.trim();
		var remind = null;
		if (remindCheck)
		{
			var __v = LEAP.checkbox2.getValue(remindCheck);
			if (__v)
				remind = {remindType:LWFP.innerApi.checkValue2Decimal(__v), remindContent:remindCheck.getAttribute("_remindContent") }; 
		}	
		
		var splitOwners = LEAP.trans.__send_split_getowner(module, splitOwnerPanel, mainAction);
		
		if (save != false && mainAct.runahead != 1)
		{			
			var ret = module.innerWFModuleSubmit({autoRefreshTransControl:true});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			if (ret != true)
				return;
				
			LEAP.trans._send_changeAction(module, mainAct.actionname);
			
			splitOwners = LEAP.trans.__send_split_getowner(module, splitOwnerPanel, mainAction);
		}
		
		if (module.WFBeforeSend)
		{
			if (module.WFBeforeSend(mainAct) != true)
				return;
		}
		
		if (splitOwners.error)
		{
			LEAP.messagebox.alert(splitOwners.error, 3);
			return;
		}
		else if (splitOwners.splitOwners == null || splitOwners.splitOwners.length == 0)
		{
			LEAP.messagebox.alert("请选择后续环节执行人！", 3);
			return;
		}
				
		var b_result = module.request2({name:'WfDoAction',
										par:{param: new WFParameter().getParameter(wfdata)
														.setNextActionName(mainAction.actionname)
														.setCsid(wfdata.CSID)
														.setNextSplitOwners(splitOwners.splitOwners)
														.setSmallNote(smallNote)
														.setRemind(remind)},
													urlpar:{service_subcategory:mainAction.actionid}													
												});

		if (b_result && b_result == true)
		{
			var msg = (mainAction.confirmmsg==null || mainAction.confirmmsg.isEmpty()==true)? "操作成功！":mainAction.confirmmsg ;
			
			LEAP.messagebox.alert(msg);
			
			if (mainAction.trgStep && mainAction.trgStep.steptype == 5 )
			{//挂起关闭运行界面
				module.hideForm();
			}
			else
			{//刷新界面				
				module._WF_ModuleProcess_refreshPage(0, null, {key:"doaction", actionName:mainAction.actionname});
			}
		}
		else
		{
			var err = leapclient.getLastWarring();
			if(err != null)
				LEAP.messagebox.alert(err);
			else
				LEAP.messagebox.alert("操作失败！");
		}
	}
	catch(e)
	{		
		LEAP.messagebox.alert(e.message);
	}	
	finally
	{
		LEAP.hideMask();
		
		instance = moduleElement = workflow = wfdata = ret = b = chkbox = itm = 
		mainAction = splitOwnerPanel = smallNoteText = remindCheck = smallNote = 
		remind = __v = splitOwners = ret = b_result = msg = err = null;
	}
}

LEAP.trans.__send_split_getowner = function(module, splitOwnerPanel, mainAction)
{
	try
	{
		var workflow = module.workflow;
		var wfdata = workflow.___data;
		
		var splitOwners = [];
		var acts = wfdata.nextSplitActions;
		var err = null;
		for (var i=0; i<acts.length; i++)
		{
			var act = acts[i];
			if (mainAction.trgstepid != act.srcstepid)
				continue;
			
			var splitOwnerTemplete = LEAP.getElement("[transct=" + LEAP.trans.transct.splitOwnerTemplete + "][splitActionId=" + act.actionid +"]", splitOwnerPanel);
			if (splitOwnerTemplete != null)
			{
				var textarea_sendowner = LEAP.getElement("ul[transct=" + LEAP.trans.transct.splitSendOwner + "]", splitOwnerTemplete);						
				var owners = LEAP.item.getValue(textarea_sendowner);
	
				if (owners == null)
				{
					if (act.__SkipNextownerValidate != true)
					{
						var canselectuser = textarea_sendowner.getAttribute(LEAP.trans.symbol.canselectuser);
						if (canselectuser == null || canselectuser == "0")
						{}
						else
						{						
							err = "请选择【" + act.aliasname + "】后续环节执行人!";
							break;
						}			
					}
					
				}
				else
				{
					var _owners = [];
					for(var k=0; k<owners.length; k++)
						_owners.add(owners[k].orgObject);
					
					splitOwners.add({splitActionId:act.actionid, owner:_owners});
				}
			}
			else
			{//无人分支可能会在发送时指定人，因此允许通过
				splitOwners.add({splitActionId:act.actionid});
			}
		}
	
		return {splitOwners:splitOwners, error:err};
	}
	finally
	{
		workflow = wfdata = splitOwners = acts = err = i = act = splitOwnerTemplete = textarea_sendowner = 
		owners = canselectuser = _owners = k = null;
	}
}


LEAP.trans.__read = function(element)
{
	try
	{	
		var module = LEAP.trans.__getmodule(element);
		
		if (module.pageMode != 'view' && module.workflow.getCurrentStep())
		{
			module.pageMode = "insert";
			if (module.workflow.getCurrentStep().recid != null)
				module.pageMode = "modify";
				
			module.___LWFPDynaParameter.setPageModule(module.pageMode);
			
			//var b = LEAP.trans.__save(element, true);			
			if (element.getAttribute('skipValidate') != null && element.getAttribute('skipValidate')=="1")
				module.skipValidate = true;
			
			var b = module.innerWFModuleSubmit({preventRefresh:true});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			
			if (b != true)
				return;
		}
		
		var workflow = module.workflow;
		
		var b_result = module.request2({name:'WfHasRead', par:{csid:workflow.___data.currentStep.csid}});

		if (b_result != null && b_result == true)
		{
			
			var p = {key:"doaction", actionName:"已阅"};
			
			module._WF_ModuleProcess_refreshPage(0, null, p);
		}
		else
		{
			var err = leapclient.getLastWarring();
			if(err != null)
				LEAP.messagebox.alert("操作失败:" + err);
			else
				LEAP.messagebox.alert("操作失败！");
			
			err = null;
		}
	}
	finally
	{
		module = workflow = b_result = err = null;
	}
}

LEAP.trans.__btnhandround = function(element)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;
		var params = [];
		
		if ( !(element.getAttribute("rangetype") && element.getAttribute("rangetype") == "0") )
		{
			var fre = LWFP.innerApi.getFrequentContacts();
			if (fre != null)
			{
				params.add({tabTitle: "常用联系人", type: 3, data:LWFP.frequentContacts, 	operationParam:{treeSingleCheck: 0}} );
			}
		}
		
		var par2 = {tabTitle: "联系人",	type: 0,
	 					searchParam: {
					 					topOrgan:1,	 		
										organRanges:null, 
										includeOrganRange:1,
										rolenameRanges:null,
										nodetype:2					
									},					
						data:null,	 		
						operationParam:{
											lazy:true,
											treeStyle:1,
											treeLevels:3,
											treeSingleCheck:0
										}
					};
		if (module.WFGetCCUserRange != null)
		{					
			var range = module.WFGetCCUserRange({action:null, entry:workflow.getEntry()});					
			if (range != null)
			{
				par2.searchParam.organRanges = range.organRange;
				par2.searchParam.rolenameRanges = range.roleRange;
				par2.searchParam.excludeRolenameRanges = range.excludeRolenameRanges;
				par2.searchParam.excludeUserTypes = range.excludeUserTypes;
				par2.searchParam.excludeOrgans = range.excludeOrgans;
				par2.searchParam.toporg = ((range.toporg == false) ? 0 : 1);						
			}
		}
		params.add(par2);
		
		LEAP.TreeSelector.showSelectForm(module, 
								params, 
								null, 
								{title:"选择抄送人", width:900, height:535, formtype:3}, 
								LEAP.trans.___btnhandround, 
								{element:element}, null, LEAP.trans.__btnhandround_popSearchFunction, {param:par2.searchParam, source:element}
							);
	
	}
	finally
	{
		module = workflow = params = fre = range = null;
	}
}

LEAP.trans.__btnhandround_popSearchFunction = function(arg)
{
	var module = LEAP.trans.__getmodule(arg.searchParam.source);
	var rst = this.request2({name:'searchWFContact', par:{toporg: ((arg.searchParam.param.topOrgan == 0)?false:true), 
															organIds:arg.searchParam.param.organRanges, 
															roleNames:arg.searchParam.param.rolenameRanges, 
															organType:2, 
															not_rolenames:arg.searchParam.param.excludeRolenameRanges?arg.searchParam.param.excludeRolenameRanges:"",
															not_usertypes:arg.searchParam.param.excludeUserTypes?arg.searchParam.param.excludeUserTypes:"",
															key: arg.key}});

						
	return rst;
}

LEAP.trans.___btnhandround = function(arg, exparam)
{
	try
	{
		if (arg && arg.selectedNodes)
		{
			var arr = [];
			for(var i=0; i<arg.selectedNodes.length; i++)
			{
				arr.add({javaClass:"com.longrise.LEAP.Base.Objects.EntityBean", userid:arg.selectedNodes[i].userId, positionid:arg.selectedNodes[i].orgObject.appointposition.id});
				//arr.add(arg.selectedNodes[i].orgObject);
			}
			
			var module = LEAP.trans.__getmodule(exparam.element);
			
			var ret = module.request2({name:"WfHandRound",	par:{ds:null, entryId:this.workflow.getEntry().entryid, nextOwner:arr}});
			if (ret == null || ret<0)
			{
				LEAP.messagebox.alert("操作失败");
			}
			else if (ret > 0)
			{
				LEAP.messagebox.alert("操作成功");
				/*if (module)
					module._WF_ModuleProcess_refreshPage(0, null, {key:"handround"});	*/			
			}
		}
	}
	finally
	{
		arr = i = ret = module = null;
	}
}

LEAP.trans.__push = function(arg)
{
	try
	{	
		if (arg.caller)
		{
			var module = LEAP.trans.__getmodule(arg.caller);
			var workflow = module.workflow;
			var WF_Data = workflow.___data;
			
			var ret = module.innerWFModuleSubmit({autoRefreshTransControl:false});
			if (module[LWFP.ENUM.form_closed_after_submit] == true)
				return;
			if (ret != true)
			{
				return;
			}
			
			var pushbackConfirm = module.pushbackConfirm;
			var confirmStr = arg.caller.getAttribute("confirm");
			if (confirmStr)
				pushbackConfirm = JSON.parse(confirmStr);
						
			if (!pushbackConfirm)
			{			
				if (module.___confirmform == null)
				{
					module.___confirmform = module.loadForm3({name:"LWFP.TransConfirm", title:"确认信息", width:540, height:250, formtype:3});
					LEAP.form.hide(module.___confirmform.form);
				}
				
				if (module.___confirmform != null)
				{
					module.___confirmform.module.unRegEvent('onSubmit', LEAP.trans.__push);
					module.___confirmform.module.regEvent('onSubmit', LEAP.trans.__push, this);
					module.___confirmform.module.init(WF_Data, {instance: module.instance});
					
					LEAP.form.show(module.___confirmform.form);
					module.___confirmform.module.focus();
					
					return
				}
			}
			else
			{				
				if (!window.confirm(pushbackConfirm.confirmMessage))
				{
					return;
				}
			}
		}
		
		
		
		var _module = null;
		if (arg.caller)
			_module = LEAP.trans.__getmodule(arg.caller);
		else
			_module = LEAP.trans.__getmodule(arg.extendParam.instance);
		
		var _workflow = _module.workflow;
		var _WF_Data = _workflow.___data;
			
		var b_result = _module.request2({name:'WfPushBack', par:{ds:null, entryID:_WF_Data.entry.entryid, 
																csid:_WF_Data.currentStep.csid, 
																pushtype:null, 
																smallNote:arg.smallNote, 
																remind:arg.remind, 
																delegate:_WF_Data.delegate}} );
		
		if (b_result != null && b_result == true)
		{
			_module._WF_ModuleProcess_refreshPage();
			
			if (_module.___confirmform && _module.___confirmform.form)
				LEAP.form.hide(_module.___confirmform.form);
		}
		else
		{	
			var err = leapclient.getLastWarring();
			if(err != null)
				alert(err);
			else
				alert("事务回退失败！");
			
			err = null;
		}			
	}
	finally
	{	
		module = workflow = WF_Data = ret = b_result = err = _module = null;
	}
}
			
LEAP.trans.__del = function(element)
{
	try
	{
		if (window.confirm("确定删除该事务?"))
		{
			var module = LEAP.trans.__getmodule(element);
			var workflow = module.workflow;
			var WF_Data = workflow.___data;
		
			var ret = module.request2({name:'WfDeleteEntry', par:{realDelete:false, vaildCheck:false, entryid:WF_Data.entry.entryid}} );
			if (ret != true)
			{
				var err = leapclient.getLastWarring();
				if(err != null)
					alert(err);
			}
			else
			{			
				module._WF_ModuleProcess_callback({key:"delete"});
				
				/*if (workflow.getExtendParam() != null && workflow.getExtendParam().callBackFunc != null)
				{
					var p = {key:"delete", extendParam:workflow.getExtendParam().extendParam};
					LEAP.asyn(workflow.getExtendParam().callBackFunc, module.parentPageModule, 50, p);
				}
				else 
				{
					if (module.parentPageModule && module.parentPageModule.innerRefreshPage)
						LEAP.asyn(module.parentPageModule.innerRefreshPage, module.parentPageModule, 50);
				}*/
				
				if (LWFP.Config.openFlowInWorkarea == 1)
					LEAP.modulebar.closeModuleBar(WF_Data.entry.entryid, true);
				else
					LEAP.form.hide(module.form);				
			}			
		}
	}
	finally
	{
		module = workflow = WF_Data = ret = null;
	}
}

LEAP.trans.__finish_form = null;
LEAP.trans.__finish = function(element)
{
	try
	{		
		var _formElement = null;
		var _btn = null;
		if (LEAP.trans.__finish_form == null)
		{
			LEAP.trans.__finish_form = LEAP.form.create3({name:null, title:'请输入终止流程原因', width:500, height:165, formtype:3});
			
			var str = '<div style="height:100%; width:100%;">';
				str += '<textarea ut="txtarea" class="LC_form_textarea" style="width:97%; margin:10px 2% 10px 1%;" rows=3 maxlen="100" mdtype="text" bt="text" ht="input"></textarea>';
				str += '<input ut="submit" class="LC_button_conner LC_button_blue" style="float:right; margin:0px 30px 0px 0px;" type="button" value="确定" lcv="2" ht="input">'
				str += '</div>'
				
			LEAP.form.setContent(LEAP.trans.__finish_form.form, str);
			
			_formElement = LEAP.getElement(LEAP.trans.__finish_form.form);
			LEAP.trans.__finish_form._txt = LEAP.getElement("textarea[ut=txtarea]", _formElement);
			_btn = LEAP.getElement("input[ut=submit]", _formElement);
			LEAP.addEvent(_btn, 'click', LEAP.trans.__finish_step2);
		}
		
		LEAP.trans.__finish_form.__moduleInstance = element.getAttribute("instance");
		
		LEAP.form.show(LEAP.trans.__finish_form.form);	
	}
	finally
	{
		//,,,
	}
}
LEAP.trans.__finish_step2 = function(arg)
{
	try
	{			
		var finishDesc = LEAP.trans.__finish_form._txt.value.trim();		
		if (finishDesc == "")
		{
			alert("请输入终止流程原因");
			return;
		}
		
		if (window.confirm("该操作不可逆转，是否确定执行？") == false) 
		{
			return;
		}
		
		var instance = LEAP.trans.__finish_form.__moduleInstance;
		var module = PageObjectModel.getModule(instance);
		var workflow = module.workflow;
		var WF_Data = workflow.___data;
		
		LEAP.form.hide(LEAP.trans.__finish_form.form);	
		
		var b_result = module.request2({name:'WfFinishEntry', par:{datasource:WF_Data.datasource, entryid:WF_Data.entry.entryid, finishDesc:finishDesc}}	);

		if (b_result != null && b_result)
		{
			alert("操作成功！");
			
			if (module.refreshPage)
			{
				module.refreshPage(false, false, 1, null, null);
			}							
			else if (module && module._WF_ModuleProcess_refreshPage)
			{
				module._WF_ModuleProcess_refreshPage();
			}
		}
		else
		{
			var err = leapclient.getLastWarring();
			if(err != null)
				alert("操作失败:" + err);
			else
				alert("操作失败！");
			
			err = null;
		}
	}
	finally
	{
		b_result = null;
	}
	
}


LEAP.trans.__fav = function(element)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;
		var WF_Data = workflow.___data;

		var pop = LEAP.popupMenu.getPop();

		module.removeEvent(pop, 'OnClick', LEAP.trans.__fav__);
		
		LEAP.popupMenu.removeAll(pop);
		LEAP.popupMenu.setWidth(pop, "auto");
		
		if (WF_Data.favoriteGroups != null && WF_Data.favoriteGroups.length > 0)
		{
			if (WF_Data.favoriteGroups != null)
			{
				for(var i=0; i<WF_Data.favoriteGroups.length; i++)
				{
					var group = WF_Data.favoriteGroups[i];	
					if (group.inuse == true)
						LEAP.popupMenu.addItem(pop, group.id, '从【' + group.groupname + '】中移除', {instance: module.instance, group:group});
					else
						LEAP.popupMenu.addItem(pop, group.id, '添加关注至【' + group.groupname + '】', {instance: module.instance, group:group});
				}
			}
		}
		else
		{
			LEAP.popupMenu.addItem(pop, null, '添加关注至【默认收藏夹】', {instance: module.instance, group:{id:null, groupname:"默认收藏夹"}});
		}
		
		LEAP.popupMenu.addItem(pop, null, '新建收藏夹', {instance:module.instance});
		
		module.addEvent(pop,'OnClick', LEAP.trans.__fav__, null, module, true);
		LEAP.popupMenu.show(pop, element);		
	}
	finally
	{
		module = workflow = WF_Data = pop = i = group = null;
	}
}

LEAP.trans.__fav__ = function(arg)
{
	try
	{
		LEAP.popupMenu.__uncover();
		LEAP.popupMenu.hidden();
		//LEAP.popupMenu.getPop().style.display = "none";
		
		var groupId = null;
		var groupName = null;
		var instance = null;
		
		if (arg.arg == "inputGroupNameCallback")
		{
			groupName = LEAP.trans.groupNameInputForm._txt.value.trim();
			instance = LEAP.trans.groupNameInputForm.__last_instance; 
			if (groupName == '')
			{
				alert('请输入收藏夹名称');
				return;
			}
			else
			{
				LEAP.form.hide(LEAP.trans.groupNameInputForm.form);
			}
		}
		else
		{
			if (arg.arg2.data != null)
			{
				instance = arg.arg2.data.instance;		
				if (arg.arg2.data.group != null)
				{
					groupId = arg.arg2.data.group.id;
					groupName = arg.arg2.data.group.groupname;						
				}
				else
				{
					//groupName = prompt("请输入收藏夹名称", "");
					LEAP.popupMenu.hidden();
					LEAP.trans.__fav_input_groupName(instance);
					return;
				}
			}
		}
		
		if (groupName == null)
			return;
			
		var module = PageObjectModel.getModule(instance);
		var WF_Data = module.workflow.___data;		
		
		if (arg && arg.arg2 && arg.arg2.data && arg.arg2.data.group.inuse == true )
		{
			var rst = module.request2({name:"WfDeleteInterestByGroup", par:{datasource:"", groupId:groupId, entryid:WF_Data.entry.entryid}});
			if (rst == true)
			{
				for(var i=0; i<WF_Data.favoriteGroups.length; i++)
				{
					if (WF_Data.favoriteGroups[i].id == groupId)
						WF_Data.favoriteGroups[i].inuse = false;
				}
				
				LEAP.messagebox.alert("操作成功");		
				
				if(module.WfInterestCallBack){
					module.WfInterestCallBack("cancle");
				}
			}
			else
			{
				var err = leapclient.getLastWarring();
				if(err != null)
					LEAP.messagebox.alert(err);				
				else
					LEAP.messagebox.alert('移除失败！');	
				err = null;
			}
		}
		else
		{
			var createtime = LEAP.formatdate(WF_Data.entry.createtime.time,0);
			var __groupId = module.request2({name:"WfCreateInterest", par:{datasourcename:null,entryid:WF_Data.entry.entryid, groupid:groupId, groupname:groupName,createtime:createtime,isarch:WF_Data.entry.isarch}});
			if (__groupId != null)
			{
				if (__groupId != groupId)
				{
					if (WF_Data.favoriteGroups == null)
						WF_Data.favoriteGroups = [];
						
					WF_Data.favoriteGroups.add({id:__groupId, groupname:groupName, inuse:true});
				}
				else
				{
					for(var i=0; i<WF_Data.favoriteGroups.length; i++)
					{
						if (WF_Data.favoriteGroups[i].id == groupId)
							WF_Data.favoriteGroups[i].inuse = true;
					}
				}
				
				LEAP.messagebox.alert('已成功添加关注至：【' + groupName + '】');
				if(module.WfInterestCallBack){
					module.WfInterestCallBack("insert");
				}
			}
			else
			{
				var err = leapclient.getLastWarring();
				if(err != null)
					LEAP.messagebox.alert(err);	
				else
					LEAP.messagebox.alert("添加失败！");
				err = null;
			}
		}
	}
	finally
	{
		groupId = groupName = instance = module = WF_Data = __groupId = null;
	}
}

LEAP.trans.__fav_input_groupName = function(instance)
{ 
	try
	{	
		if (LEAP.trans.groupNameInputForm == null)
		{
			LEAP.trans.groupNameInputForm =	LEAP.form.create3({   //新窗体样式
																		name : null,
																		title : '新建收藏夹',
																		width : 500,
																		height : 200,
																		formtype : 3
																	});
			//LEAP.trans.groupNameInputForm = LEAP.form.create(null, '', 500, 160, null, null);
			LEAP.form.setContent(this.groupNameInputForm.form, "<div style='padding:10px'><label class='lgiatext' style='width:200px;text-align:left;'>请输入收藏夹名称：</label><input ut='filename' class='LC_input_conner' ht='input' bt='text' check='maxlen:100' style='border:1px solid #666; width:95%; margin-left:20px;marginright:1px;'/><br><br><input class='LC_button_conner LC_button_blue' type='button' value='确定' ut='submit' ht='input' style='float:right;'/></div>");
	
			var _formElement = null;
			var _btn = null;
			
			_formElement = LEAP.getElement(this.groupNameInputForm.form);
			_btn = LEAP.getElement("input[ut=submit]", _formElement);
			
			LEAP.trans.groupNameInputForm._txt = LEAP.getElement("input[ut=filename]", _formElement);			
			LEAP.addEvent(_btn, 'click', LEAP.trans.__fav__, "inputGroupNameCallback");
		}
		
		LEAP.trans.groupNameInputForm.__last_instance = instance;
		LEAP.trans.groupNameInputForm._txt.value = "";			
		LEAP.form.show(LEAP.trans.groupNameInputForm.form);
	}
	finally
	{
		_formElement = _btn = null;
	}
}

/*LEAP.trans.__manager = function(element)
{
	try
	{		
		var module = LEAP.trans.__getmodule(element);

		var form = null;
		var rect = null;
		var ele = null;
		if (module.form)
			ele = LEAP.getElement("div" + module.form);
		else
			ele = module.moduleElement;
			
		rect = ele.getBoundingClientRect();
		
		if (module.__managForm != null)
		{
			module.__managForm.module.dispose();
			module.__managForm = null;
		}		
				
		if (module.__managForm == null)
		{	
			module.__managForm = module.loadForm3({name:"LBPMRTM.DM.mon", title:"流程监控维护", 
													x:rect.left, y:rect.top, width:rect.width, height:rect.height, formtype:3});
			if (module.__managForm && module.__managForm.module)
			{
				module.__managForm.module.initPage(module.workflow.getData(), "manager");			
			}
		}
	}
	finally
	{
		module = form = rect = ele = null;
	}
}*/


/*
LEAP.trans.__mon = function(element)
{
	try
	{	
		var module = LEAP.trans.__getmodule(element);
		var wfdata = module.workflow.___data;
		
		var form = null;
		var rect = null;
		var ele = null;
		if (module.form)
			ele = LEAP.getElement("div" + module.form);
		else
			ele = module.moduleElement;
			
		rect = ele.getBoundingClientRect();
			
		form = module.loadForm3({name:"LBPMRTM.hisForm2", title:"流程历程", 
						x:rect.left, y:rect.top, width:rect.width, height:rect.height, formtype:3});
		
		if (form && form.module)
		{
			form.module._wfmoduleversion = 3;
			form.module.initPage(wfdata, null, null);	
			return form;
		}
	}
	finally
	{
		module = wfdata = form = ele = rect = null;
	}
}

LEAP.trans.__mon2 = function(element)
{
	try
	{	
		var module = LEAP.trans.__getmodule(element);
		var wfdata = module.workflow.___data;
		
		var form = null;
		var rect = null;
		var ele = null;
		if (module.form)
			ele = LEAP.getElement("div" + module.form);
		else
			ele = module.moduleElement;
			
		rect = ele.getBoundingClientRect();
			
		form = module.loadForm3({name:"LBPMRTM.hisForm", title:"流程历程", 
						x:rect.left, y:rect.top, width:rect.width, height:rect.height, formtype:3});
		
		if (form && form.module)
		{
			form.module._wfmoduleversion = 3;
			form.module.initPage(wfdata, null, null);	
			return form;
		}	
	}
	finally
	{
		module = wfdata = form = ele = rect = null;
	}
}

LEAP.trans.__mon3 = function(element)
{
	try
	{	
		var module = LEAP.trans.__getmodule(element);
		var wfdata = module.workflow.___data;
		
		var form = null;
		var rect = null;
		var ele = null;
		if (module.form)
			ele = LEAP.getElement("div" + module.form);
		else
			ele = module.moduleElement;
			
		rect = ele.getBoundingClientRect();
			
		form = module.loadForm3({name:"LBPMRTM.hisForm3", title:"流程历程", 
						x:rect.left, y:rect.top, width:rect.width, height:rect.height, formtype:3});
		
		if (form && form.module)
		{
			var customgroups = element['customgroups'];
			if (customgroups == null)
				customgroups = module.historyCustomgroups;
			form.module._wfmoduleversion = 3;
			form.module.initPage(wfdata, customgroups);	
			return form;
		}	
	}
	finally
	{
		module = wfdata = form = ele = rect = customgroups = null;
	}
}
*/

LEAP.trans.__monz = function(element)
{
	try
	{	
		var viewModuleName = ""
		var ct = element.getAttribute(LEAP.trans.n);
		if (ct == LEAP.trans.transct.btnmon)
			viewModuleName = "LBPMRTM.hisForm2";
		else if (ct == LEAP.trans.transct.btnmon2)
			viewModuleName = "LBPMRTM.hisForm";
		else if (ct == LEAP.trans.transct.btnmon3)
			viewModuleName = "LBPMRTM.hisForm3";
		else if (ct == LEAP.trans.transct.btnmanager)
			viewModuleName = "LBPMRTM.DM.mon";
			
		LEAP.trans.__monz_createForm(element, viewModuleName, false);
	}
	finally
	{
		viewModuleName = ct = null;
	}
}

LEAP.trans.__monz_viewButton_click = function(button)
{
	try
	{
		var module = LEAP.trans.__getmodule(button);
		module.hideForm();
			
		LEAP.trans.__monz_createForm(button['transElement'], button.getAttribute("view_moduleName"), true);	
	}
	finally
	{
		module = null;
	}
}

LEAP.trans.__monz_createForm = function(element, viewModuleName, flag)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var wfdata = module.workflow.___data;
		
		var form = null;
		var rect = null;
		var ele = null;
		if (module.form)
			ele = LEAP.getElement("div" + module.form);
		else
			ele = module.moduleElement;			
		rect = ele.getBoundingClientRect();
		
		var views = null;
		if (element.getAttribute("view"))
		{
			views = JSON.parse(element.getAttribute('view'));

			var A = new String(gcook());	
			var B = "_wf_mon_view_=";
			var C = A.indexOf(B);
			if (C != -1)
			{
				var D = A.substring(C + B.length);
				if (D.indexOf(";") > -1)
				{
					D = D.substring(0, D.indexOf(";"));
				}
			}
			
			if (flag == false)
			{
				if ((D != null) && (D != "") && (element.getAttribute('view').indexOf(D)>-1) )
					viewModuleName = D;
			}
		}
		
		var title = "流程历程";
		if (element && element.tagName.toUpperCase()=="INPUT" && element.value)
			title = element.value;
		
		form = module.loadForm3({name:viewModuleName, title:title, autodispose:true,
						x:rect.left, y:rect.top, width:rect.width, height:rect.height, formtype:3});
		
		if (form && form.module)
		{
			if (LWFP.Config.openFlowInWorkarea == 1)
				LEAP.form.maxSize(form.form);
						
			if (LEAP.form.hideOperResize)
				LEAP.form.hideOperResize(form.form);
			
			var param = {};
			//LBPMRTM.hisForm3参数
			var customgroups = element['customgroups'];
			if (customgroups == null)
				customgroups = module.historyCustomgroups;
			param.customgroups = customgroups;
			
			form.module._wfmoduleversion = 3;
			form.module.initPage(wfdata, param);
			
			if (views != null)
			{
				var con = document.createElement('div');
					con.className = "wfhistoryform3_view_container";
					con.setAttribute("instance", form.module.instance);
				for(var i=0; i<views.length; i++)
				{
					var v = views[i];
					var input = document.createElement('input');
						input.setAttribute("instance", form.module.instance);
						input.setAttribute(LEAP.trans.n, LEAP.trans.transct.btnMonView);
						input.setAttribute(LEAP.trans.d, "1");
						input.setAttribute("view_moduleName", v.module);
						input.type = "button";
						input.value = v.name;
						input.setAttribute("ht", "input");
					if (v.module == viewModuleName)
						input.className = "LC_button_conner wfhistoryform3_view_button_check";
					else
						input.className = "LC_button_conner wfhistoryform3_view_button";
						
						
						input['transElement'] = element;
						
					con.appendChild(input);
				}
				
				form.module.moduleElement.appendChild(con);
			}
			
			if (views != null)
			{
				var T = new Date();
				T.setTime(T.getTime() + 30 * 24 * 3600000);
				scook("_wf_mon_view_=" + viewModuleName + ";expires=" + T.toGMTString() );
			}

			return form;
		}
	}
	finally
	{
		module = wfdata = form = rect = ele = views = param = customgroups = con = i = v = input = null;
	}	
}


LEAP.trans.__mon_loadmodule_getView = function(wfdata, defaultView, views, flag)
{
	var rst = new String(defaultView);
	if (views != null)
	{
		var A = new String(gcook());	
		var B = "_wf_mon_view_=";
		var C = A.indexOf(B);
		if (C != -1)
		{
			var D = A.substring(C + B.length);
			if (D.indexOf(";") > -1)
			{
				D = D.substring(0, D.indexOf(";"));
			}
		}
		
		if (flag == false)
		{
			if ( D != null && D != "")
			{
				for(var i=0; i<views.length; i++)
				{
					if (views[i].module == D)
					{
						rst = D;
						break;
					}
				}
			}
		}
	}
	
	return rst;
}
LEAP.trans.__mon_loadmodule_afterLoad = function(domain, wfdata, currentViewModuleName, views, param)
{
	try
	{
		if (views != null)
		{
			var con = document.createElement('div');
				con.className = "wfhistoryform3_view_container";
				con.setAttribute("instance", domain.instance);
			for(var i=0; i<views.length; i++)
			{
				var v = views[i];
				var input = document.createElement('input');
					input.setAttribute("instance", domain.instance);
					input.setAttribute(LEAP.trans.n, LEAP.trans.transct.btnMonView2);
					input.setAttribute(LEAP.trans.d, "1");
					input.setAttribute("view_moduleName", v.module);
					input.type = "button";
					input.value = v.name;
					input.setAttribute("ht", "input");
				if (v.module == currentViewModuleName)
					input.className = "LC_button_conner wfhistoryform3_view_button_check";
				else
					input.className = "LC_button_conner wfhistoryform3_view_button";
					
				input['param'] = param;
				
				con.appendChild(input);
			}
			
			domain.moduleElement.appendChild(con);
		}
		
		if (views != null)
		{
			var T = new Date();
			T.setTime(T.getTime() + 30 * 24 * 3600000);
			scook("_wf_mon_view_=" + currentViewModuleName + ";expires=" + T.toGMTString() );
		}	
	}
	finally
	{
		con = i = v = input = T = null;
	}
}
LEAP.trans.__mon_loadmodule_viewButton_click = function(button)
{
	try
	{
		var module = LEAP.trans.__getmodule(button);
		var parentPageModule = module.parentPageModule;
		var wfdata = parentPageModule.workflow.___data;
		
		var viewModuleName = button.getAttribute('view_moduleName');
		var container = module.moduleElement.parentElement;		
		var param = button['param'];		
		
		LWFP.API.ModuleProcess.__loadMonitorView(parentPageModule, wfdata, param.tabinfo, param.label, param.container, viewModuleName, 1)
		
	}
	finally
	{
		module = parentPageModule = wfdata = viewModuleName = container = param = null;
	}	
}


LEAP.trans.__addZW_hide = function(arg, flag)
{
	if (flag == null)
	{
		LEAP.asyn(LEAP.trans.__addZW_hide, this, 100, arg, "done");
		
	}
	else
	{
		if (arg && arg.arg && arg.arg.domain)
		{
			if (arg.arg.domain.__docAddForm != null)
			{
				arg.arg.domain.__docAddForm.module.dispose();
				arg.arg.domain.__docAddForm.module = null;
				arg.arg.domain.__docAddForm = null;
			}
		}
	}
}

LEAP.trans.__addZW_onUploadComplete = function(element,data)
{
	var module = LEAP.trans.__getmodule(element);
	var tabcode = module.__zwTabCode;
	
	if (element.getAttribute('tabcode'))
		tabcode = element.getAttribute('tabcode');
		
	if (module == null)
		return;
		
	if (tabcode == null)
		return;			
	
	var obj = null;
	if (data instanceof Array)
		obj = data[0];
	else
		obj = data;
			
	var _att={};
		_att.fileid = obj.fileid;
		_att.title = obj.title; 
		_att.name = obj.name;
		_att.viewname = obj.viewname;
		_att.attsize = obj.size;
		_att.uuid = obj.uuid;
		_att.namedpath = obj.nameedPath;
		_att.updateType = 0;
		_att.ownername = LEAP.getUserInfo().fullName;
		_att.filecount = obj.filecount;
		_att.uploadtime = {time:LEAP.getUserInfo().getTimeTicket()};
		_att.canDelete = true;
		_att.canEdit = true;
		_att.exstatus = obj.exstatus;
		_att.atttype = LWFP.innerApi.getFileType(obj.name.toLowerCase());
		_att.tabcode = tabcode;			
		
			
	var tab = LWFP.API.ModuleProcess.api.getUITabinfo(tabcode, module);
	if(tab != null)
	{
		var _docView = tab.documentView;					
		LEAP.DocumentView.valueChange(_docView, _att, _att.atttype);
		
		LWFP.API.ModuleProcess.api.setActiveTabUI(tabcode, module);		
		//LEAP.DocumentView.loadDocument(_docView, true, tab.tabInfo.name);
	}
	else
	{
		var elements = LEAP.getElements("div[ct=" + LEAP.attlist.d + "][instance=" + module.instance + "]", module.moduleElement);
		if (elements != null)
		{
			for(var i=0; i<elements.length; i++)
			{
				var ele = elements[i];			
				if (elements.length==1 || ele.getAttribute("attachmentRange") == "1")
				{
					LEAP.attlist.insert(ele, _att);
					break;
				}
			}
		}
	}
}

LEAP.trans.__addZW = function(arg)
{
	try
	{
		var element = LEAP._match(arg, "1", LEAP.trans.d);
		LEAP.trans.__addZW_element = element;
		if ( element )
		{			
			var module  = LEAP.trans.__getmodule(element);
			var wfdata = module.workflow.___data;
			var n = wfdata.flow.atttype;
			if (n==0)
				n=1;
				
			this.filter2 = LWFP.innerApi.getFileFilter2(n);
			var config = {src:arg,types:this.filter2.type,uploadpath: LWFP.Global.uploadPath.getAttachmentUploadPath(),mulit:'0',callback:LEAP.trans.__addZW_onUploadComplete,domain:module} ;
			LEAP.fileupload.openUpload(config);	
		}
	}
	finally
	{
		 module = wfdata = null;
	}
}


/**
 * 拟稿（外部调用），支持公文二维码
 * @param {} domain
 * @param {} params： {qrcode:公文二维码url, filetilte:文件标题}
 * 示例：
 * 		LEAP.trans.draft(this, {qrcode:"http://192.168.0.65:8081/lbcp/LEAP/Download/default/2021/6/1/e823cd6b2f7f4b4486b25970cc08116a.png?sid="	+ leapclient.getsid() + ((LEAP.geturlpars().getvalue('lid') != null) ? "&lid=" + LEAP.geturlpars().getvalue('lid') : "")});
 */
LEAP.trans.draft = function(domain, params)
{
	try
	{
		var attCtrl = null;
		var attCtrls = LEAP.getElements("[ct=" + LEAP.attlist.d + "]", domain.moduleElement);
		if (attCtrls)
		{
			if (attCtrls.length == 1)
			{
				attCtrl = attCtrls[0];
			}
			else
			{
				for(var i=0; i<attCtrls.length; i++)
				{
					if (attCtrls[i].getAttribute("attachmentRange") == "1")
					{
						attCtrl = attCtrls[i];
						break;
					}
				}
			}
		}
		
		if (attCtrl)
		{
			var row = LEAP.attlist._getRow(attCtrl, LEAP.attachment.symbol.zw);
			if (row != null)
			{
				LEAP.attlist._open(attCtrl, row, false, true, null, params);
			}
			else
			{
				LEAP.trans.__draft_step2(domain.moduleElement, params);
			}
		}			

	}
	finally
	{
		module = tab = tabcode = _docView = attCtrl = attCtrls = i = row = null;
	}
}

LEAP.trans.__draft = function(element, params)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		
		var tab = null;
		if (element.getAttribute('tabcode'))
		{
			var tabcode = element.getAttribute('tabcode');
			tab = LWFP.API.ModuleProcess.api.getUITabinfo(tabcode, module);
		}
		
		if (tab != null && tab.tabInfo.type == 2)
		{
			var _docView = tab.documentView;	
			
			if (_docView[LEAP.DocumentView.n] != null && _docView[LEAP.DocumentView.n].attachment != null)
			{
				LWFP.API.ModuleProcess.api.setActiveTabUI(tabcode, module);
			}
			else
			{			
				LEAP.trans.__draft_step2(element, params);
			}			
		}
		else
		{
			var attCtrl = null;
			var attCtrls = LEAP.getElements("[ct=" + LEAP.attlist.d + "]", module.moduleElement);
			if (attCtrls)
			{
				if (attCtrls.length == 1)
				{
					attCtrl = attCtrls[0];
				}
				else
				{
					for(var i=0; i<attCtrls.length; i++)
					{
						if (attCtrls[i].getAttribute("attachmentRange") == "1")
						{
							attCtrl = attCtrls[i];
							break;
						}					
					}
				}
			}
			
			if (attCtrl)
			{
				var row = LEAP.attlist._getRow(attCtrl, LEAP.attachment.symbol.zw);
				if (row != null)
				{
					LEAP.attlist._open(attCtrl, row, false, true, element);
				}
				else
				{
					LEAP.trans.__draft_step2(element, params);
				}
			}			
		}
	}
	finally
	{
		module = tab = tabcode = _docView = attCtrl = attCtrls = i = row = null;
	}
}


LEAP.trans.__draft_step2 = function(element, params)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;

		var use_wpsaddon = false;
		if ( (LEAP.DocumentView.isWin == true && LEAP.DocumentView.DocumentEditor_win == "wpsAddon")
			|| ( LEAP.DocumentView.isWin == false && LEAP.DocumentView.DocumentEditor_linux == "wpsAddon") )
					
		{
			use_wpsaddon = true;
		}
		
		if ( use_wpsaddon == false)
		{
			var templates = module.request2({name:'lbcp_getZWTemplateForBusinessNo', par:{businessNo: workflow.getData().businessNo} });			
			if (templates != null)
			{		
				templates = templates.result;
				if (LEAP.trans.WordtemplateForm == null)
				{
					LEAP.trans.WordtemplateForm = LEAP.form.create3({name:null, title:'选择正文模板', width:700, height:450, formtype:3});
					var str = '<select ut="templates" size=5 style="width:100%; height:350px; font-size:20px; border:none; border-bottom:1px solid #ccc; padding:5px;"></select>';
						str += '<br/>';
						str += '<button ut="btn_confirm" type="button" class="LC_button_blue LC_button_conner" style="float:right; margin:10px 30px; font-size:14px; padding:5px 20px;">确&nbsp;&nbsp;定</button>';
						str += '<button ut="btn_cancel" type="button" class="LC_button_blue LC_button_conner" style="float:right; margin:10px 10px; font-size:14px; padding:5px 20px;">取&nbsp;&nbsp;消</button>';
						
					LEAP.form.setContent(LEAP.trans.WordtemplateForm.form, str);
					
					var _fe = LEAP.getElement(LEAP.trans.WordtemplateForm.form);
					
					var btn_confirm = LEAP.getElement("[ut=btn_confirm]", _fe);
					var btn_cancel = LEAP.getElement("[ut=btn_cancel]", _fe);
					
					LEAP.addEvent(btn_confirm, 'click', LEAP.trans.__draft_step3, params);
					LEAP.addEvent(btn_cancel, 'click', LEAP.trans.__draft_step3, params);	
				}
			
				var _formElement = LEAP.getElement(LEAP.trans.WordtemplateForm.form);
				var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
				if (icon)
				{
					icon.style.display = "none";		
				}
				var select = LEAP.getElement("[ut=templates]", _formElement);
				select.innerHTML = "";   
				
				templates.unshift({templatename:"空白模板"});
				for(var i=0; i<templates.length; i++)
				{
					var tmp = templates[i];
					var myOption = document.createElement("option"); //动态创建option标签
						myOption.style.margin = "4px 5px";
			            myOption.value = tmp.templatename;
			            myOption.text = tmp.templatename;
			            myOption["data"] = tmp;
			            
					select.add(myOption);
				}
	
				LEAP.trans.WordtemplateForm.ele = element;
				LEAP.form.show(LEAP.trans.WordtemplateForm.form);
			}
			else
			{
				LEAP.trans.__draft_step4(element, null, params);			
			}
		}
		else
		{//不选模板
			LEAP.trans.__draft_step4(element, null, params);
		}
	}
	finally
	{
		module = workflow = templates = str = _fe = btn_confirm = btn_cancel = _formElement = icon = select = i = tmp = myOption = null;
	}
}

LEAP.trans.__draft_step3 = function(arg, params)
{
	try
	{		
		var element = LEAP.trans.WordtemplateForm.ele;
		
		var btn = arg.e.srcElement;
		if (btn.getAttribute("ut") == "btn_cancel")
		{
			LEAP.form.hide(LEAP.trans.WordtemplateForm.form);	
		}
		else
		{
			var _formElement = LEAP.getElement(LEAP.trans.WordtemplateForm.form);
			var select = LEAP.getElement("[ut=templates]", _formElement);

		    var index = select.selectedIndex;
		    if (index == -1) 
		    { //添加未选中数据时的异常处理
		        alert("请选择正文模板！");
		        return;
		    }		    
		    
		    var selectedTemplate = select.options[index]["data"];		    
		    if (selectedTemplate.templatename == null)
		    	selectedTemplate = null;
    		
			LEAP.trans.__draft_step4(element, selectedTemplate, params);
		}
	}
	finally
	{
		element = btn = _formElement = select = index = selectedTemplate = null;
	}
}

LEAP.trans.__draft_step4 = function(element, template, params)
{
	var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/activex/blank.doc";
	if (template != null && template.path)
		url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/Download/" + template.path;
		
	var module = LEAP.trans.__getmodule(element);		
	var _att = {draftTemplateUrl:url, atttype:-9, name:"blank.doc", title:((template && template.templatename) ? template.templatename : "新建正文")  };
	if (params && params.filetitle)
		_att.title = params.filetitle;
	
	var tab = null;
	if (element.getAttribute('tabcode'))
	{
		var tabcode = element.getAttribute('tabcode');
		tab = LWFP.API.ModuleProcess.api.getUITabinfo(tabcode, module);
	}
	
	try
	{
		if (tab != null && tab.tabInfo.type == 2)
		{
			var _docView = tab.documentView;
			
			LEAP.DocumentView.valueChange(_docView, _att, _att.atttype);
			LWFP.API.ModuleProcess.api.setActiveTabUI(tabcode, module);
			
		}
		else
		{			
			var attCtrl = null;
			var attCtrls = LEAP.getElements("[ct=" + LEAP.attlist.d + "]", module.moduleElement);
			if (attCtrls)
			{
				if (attCtrls.length == 1)
				{
					attCtrl = attCtrls[0];
				}
				else
				{
					for(var i=0; i<attCtrls.length; i++)
					{
						if (attCtrls[i].getAttribute("attachmentRange") == "1")
						{
							attCtrl = attCtrls[i];
							break;
						}					
					}
				}
			}
			
			if (attCtrl)
			{
				LEAP.attlist._draft(attCtrl, _att, params);
			}			
		}
	}
	finally
	{
		if (LEAP.trans.WordtemplateForm)
		{
			LEAP.form.hide(LEAP.trans.WordtemplateForm.form);
		}
	}
}




/*
LEAP.trans.__draft = function(element)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var workflow = module.workflow;

		var templates = module.request2({name:'lbcp_getZWTemplateForBusinessNo', par:{businessNo: workflow.getData().businessNo} });			
		if (templates != null)
		{		
			templates = templates.result;
			if (LEAP.trans.WordtemplateForm == null)
			{
				LEAP.trans.WordtemplateForm = LEAP.form.create3({name:null, title:'选择正文模板', width:700, height:450, formtype:3});
				var str = '<select ut="templates" size=5 style="width:100%; height:350px; font-size:20px; border:none; border-bottom:1px solid #ccc; padding:5px;"></select>';
					str += '<br/>';
					str += '<button ut="btn_confirm" type="button" class="LC_button_blue LC_button_conner" style="float:right; margin:10px 30px; font-size:14px; padding:5px 20px;">确&nbsp;&nbsp;定</button>';
					str += '<button ut="btn_cancel" type="button" class="LC_button_blue LC_button_conner" style="float:right; margin:10px 10px; font-size:14px; padding:5px 20px;">取&nbsp;&nbsp;消</button>';
					
				LEAP.form.setContent(LEAP.trans.WordtemplateForm.form, str);
				
				var _fe = LEAP.getElement(LEAP.trans.WordtemplateForm.form);
				
				var btn_confirm = LEAP.getElement("[ut=btn_confirm]", _fe);
				var btn_cancel = LEAP.getElement("[ut=btn_cancel]", _fe);
				
				LEAP.addEvent(btn_confirm, 'click', LEAP.trans.__draft_step2);
				LEAP.addEvent(btn_cancel, 'click', LEAP.trans.__draft_step2);	
			}
		
			var _formElement = LEAP.getElement(LEAP.trans.WordtemplateForm.form);
			var icon = LEAP.getElement("[ctf=form_btns]", _formElement);
			if (icon)
			{
				icon.style.display = "none";		
			}
			var select = LEAP.getElement("[ut=templates]", _formElement);
			select.innerHTML = "";   
			
			templates.unshift({templatename:"空白模板"});
			for(var i=0; i<templates.length; i++)
			{
				var tmp = templates[i];
				var myOption = document.createElement("option"); //动态创建option标签
					myOption.style.margin = "4px 5px";
		            myOption.value = tmp.templatename;
		            myOption.text = tmp.templatename;
		            myOption["data"] = tmp;
		            
				select.add(myOption);
			}

			LEAP.trans.WordtemplateForm.ele = element;
			LEAP.form.show(LEAP.trans.WordtemplateForm.form);
		}
		else
		{
			LEAP.trans.__draft_step3(element, null);			
		}
	}
	finally
	{
	}
}

LEAP.trans.__draft_step2 = function(arg)
{
	try
	{		
		var element = LEAP.trans.WordtemplateForm.ele;
		
		var btn = arg.e.srcElement;
		if (btn.getAttribute("ut") == "btn_cancel")
		{
			LEAP.form.hide(LEAP.trans.WordtemplateForm.form);	
		}
		else
		{
			var _formElement = LEAP.getElement(LEAP.trans.WordtemplateForm.form);
			var select = LEAP.getElement("[ut=templates]", _formElement);

		    var index = select.selectedIndex;
		    if (index == -1) 
		    { //添加未选中数据时的异常处理
		        alert("请选择正文模板！");
		        return;
		    }		    
		    
		    var selectedTemplate = select.options[index]["data"];		    
		    if (selectedTemplate.templatename == null)
		    	selectedTemplate = null;
    		
			LEAP.trans.__draft_step3(element, selectedTemplate);
		}
	}
	finally
	{
		
	}
}

LEAP.trans.__draft_step3 = function(element, template)
{
	var url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/LWFP/HTML/activex/blank.doc";
	if (template != null && template.path)
		url = LEAP.wfrouter.getServerURL(LEAP.wfrouter.getRouter(element)) + "LEAP/Download/" + template.path;
		
	var module = LEAP.trans.__getmodule(element);		
	var _att = {draftTemplateUrl:url, atttype:-9, name:"blank.doc", title:((template && template.templatename) ? template.templatename : "新建正文")  };
	
	var tab = null;
	if (element.getAttribute('tabcode'))
	{
		var tabcode = element.getAttribute('tabcode');
		tab = LWFP.API.ModuleProcess.api.getUITabinfo(tabcode, module);
	}
	
	try
	{
		if (tab != null && tab.tabInfo.type == 2)
		{
			var _docView = tab.documentView;	
			
			if (_docView[LEAP.DocumentView.n] != null)
			{
				if (window.confirm("检测到已经存在正文文件，重新拟稿将会替换原有文件，是否继续？") == false) 
					return;
			}
			
			LEAP.DocumentView.valueChange(_docView, _att, _att.atttype);
			LWFP.API.ModuleProcess.api.setActiveTabUI(tabcode, module);
			
		}
		else
		{			
			var attCtrl = null;
			var attCtrls = LEAP.getElements("[ct=" + LEAP.attlist.d + "]", module.moduleElement);
			if (attCtrls)
			{
				if (attCtrls.length == 1)
				{
					attCtrl = attCtrls[0];
				}
				else
				{
					for(var i=0; i<attCtrls.length; i++)
					{
						if (attCtrls[i].getAttribute("attachmentRange") == "1")
						{
							attCtrl = attCtrls[i];
							break;
						}					
					}
				}
			}
			
			if (attCtrl)
			{
				LEAP.attlist._draft(attCtrl, _att);
			}			
		}
	}
	finally
	{
		if (LEAP.trans.WordtemplateForm)
		{
			LEAP.form.hide(LEAP.trans.WordtemplateForm.form);
		}
	}
}
*/

/*LEAP.trans.__addZW = function(arg)
{
	try
	{
		var element = LEAP._match(arg, "1", LEAP.trans.d);
		if ( element )
		{			
			var module = LEAP.trans.__getmodule(element);
			var wfdata = module.workflow.___data;
			var tabcode = module.__zwTabCode;
			
			if (element.getAttribute('tabcode'))
				tabcode = element.getAttribute('tabcode');
			
			if (module.__docAddForm != null)
			{
				module.__docAddForm.module.dispose();
				module.__docAddForm.module = null;
				module.__docAddForm = null;
			}		
			
			if (module.__docAddForm == null)
			{
				module.__docAddForm = module.loadForm("LWFP.DocAddForm", '添加正文', 500, 300);;
				
				LEAP.form.hide(module.__docAddForm.form);
				module.__docAddForm.module.regEvent('onSubmit', LEAP.trans.__addZW, this);
				
				LEAP.addEvent(module.__docAddForm.form, 'formHided', LEAP.trans.__addZW_hide, {domain:module}, this, true);
			}
			
			if (module.__docAddForm != null)
			{	
				module.__docAddForm.module.init(wfdata.flow.atttype, tabcode, {instance:module.instance});
				LEAP.form.show(module.__docAddForm.form);
				module.__docAddForm.module.focus();
			}			
		}
		else if (arg.__type)
		{
			var instance = arg.extendParam.instance;
			var module = LEAP.trans.__getmodule(instance);
			if (module == null)
				return;
			
			var tabcode = module.__zwTabCode;
			if (arg.__data && arg.__data.tabcode)
				tabcode = arg.__data.tabcode;
				
			if (tabcode == null)
				return;			
			
			var tab = LWFP.API.ModuleProcess.api.getUITabinfo(tabcode, module);
			if(tab == null)
				return;

			LWFP.API.ModuleProcess.api.setActiveTabUI(tabcode, module);
			var _docView = tab.documentView;
			
			if (arg.__type == 1) 
			{//上传的				
				LEAP.DocumentView.valueChange(_docView, arg.__data, arg.__data.atttype);
				LEAP.DocumentView.loadDocument(_docView, true, tab.tabInfo.name);
			}
			else if (arg.__type == 2)
			{//空word				
				LEAP.DocumentView.valueChange(_docView, null, -9);
				LEAP.DocumentView.loadDocument(_docView, true, tab.tabInfo.name);
			}
			else if (arg.__type == 3)
			{//空wpss
				LEAP.DocumentView.valueChange(_docView, null, -8);
				LEAP.DocumentView.loadDocument(_docView, true, tab.tabInfo.name);
			}
			else if (arg.__type == 4)
			{//空扫描
				LEAP.DocumentView.valueChange(_docView, null, -3);
				LEAP.DocumentView.loadDocument(_docView, true, tab.tabInfo.name);		
			}
		}
	}
	finally
	{
		element = module = wfdata = instance = tabcode = tab = _docView = null;
	}
}*/

LEAP.trans.__option = function(element)
{
	try
	{
		var module = LEAP.trans.__getmodule(element);
		var wfdata = module.workflow.___data;
		
		var flowOption = element[LEAP.trans.symbol.opdata];			
		if (flowOption.moduleName != null)
		{
			if (module.__flowOptionForm != null && module.__flowOptionForm.module != null)
			{
				if (module.__flowOptionForm.module.dispose)
					module.__flowOptionForm.module.dispose();
				module.__flowOptionForm.module = null;
			}
			module.__flowOptionForm = null;
			
			var mode = "insert";
			module.__flowOptionForm = module.loadForm3({path:flowOption.moduleName, title:flowOption.opname, pageMode:mode, width:700, height:500,
												moduleLoadArg:{workflow: new LWFPWorkFlow().Create(wfdata)}});

			module.__flowOptionForm.module.WFMode = true;
			module.__flowOptionForm.module.___LWFPDynaParameter = new WFRecParams().setType(4).setFlowOptionId(flowOption.foid).setEntryId(wfdata.entry.entryid).setPageModule(mode);;
			module.__flowOptionForm.module.innerWFInsertSubmit = LWFP.API.ModuleProcess.moduleSubmit;
			module.__flowOptionForm.module.innerWFModifySubmit = LWFP.API.ModuleProcess.moduleSubmit;
			module.__flowOptionForm.module.regEvent('onSubmit', LEAP.trans.___option, module);
			
			
		}
		else
		{
			LEAP.trans.___option.call(module, {entryid:wfdata.entry.entryid, flowOption:flowOption});
		}
	}
	finally
	{
		module = wfdata = flowOption = mode = null;
	}
}
		
LEAP.trans.___option = function(arg0)
{
	try
	{
		if (arg0 == null)
		{
			var rst = this.__flowOptionForm.module.___LWFPSubmitResult;
			if (rst && rst.wfresult && rst.wfresult == true)
			{								
				LEAP.messagebox.alert('操作成功！');				
				this._WF_ModuleProcess_refreshPage();
			}
			else
			{
				LEAP.messagebox.alert('保存失败！');
			}	
		}
		else
		{
			var b_result = this.request2({name:'WfDoFlowOption', par:{param: new WFParameter().getParameter(this.workflow.___data)
														.setOptionName(arg0.flowOption.opname)}} );			
			if (b_result != null && b_result)
			{
				LEAP.messagebox.alert('操作成功！');
				this._WF_ModuleProcess_refreshPage();
			}
			else
			{	
				LEAP.messagebox.alert('操作失败！');
			}
		}
	}
	finally
	{
		b_result = rst = null;
	}
}

LEAP.trans.__pull = function(element)
{
	try
	{	
		var module = LEAP.trans.__getmodule(element);
		var wfdata = module.workflow.___data;
		
		var form = module.loadForm3({name:"LWFP.PullbackForm", title:"请选择要回收的任务", width:600, height:400, formtype:3});
		if (form && form.module)
		{
			form.module.init(wfdata);			
		}
	}
	finally
	{
		module = wfdata = form = null;
	}
}

LEAP.trans.__showowner = function(textarea, owners)
{
	try
	{		
		if (!textarea)
			return;
		
		if (owners != null && owners.length > 0)
		{
			for(var i=0; i<owners.length; i++)
			{
				var node = owners[i];
					node.__title = node.remark;
				/*if (node.nodeType == 0 || node.nodeType == 1)
					node.__title = node.orgObject.cnname;			
				else if (node.nodeType == 2)
					node.__title = ((node.orgObject.fullname != null)?node.orgObject.fullname:node.orgObject.userflag);*/
			}
		}
		
		LEAP.item.setValue(textarea, owners, "__title");
	}
	finally
	{
		i = node = null;
	}
}

LEAP.trans.__showCCUser = function(textarea, usersNodes)
{
	try
	{		
		if (!textarea)
			return;
		
		if (usersNodes != null && usersNodes.length>0)
		{			
			for(var i=0; i<usersNodes.length; i++)
				usersNodes[i].__title = usersNodes[i].remark; //((users[i].fullname != null)?users[i].fullname:ownusersers[i].userflag);
		}
			
		LEAP.item.setValue(textarea, usersNodes, "__title");
	}
	finally
	{
		i = null;
	}
}

LEAP.trans.__getmodule = function(element)
{
	if (element == null)
		return null;
		
	if (typeof(element) == "string")
	{
		return PageObjectModel.getModule(element);
	}
	else if (element.getAttribute("instance") != null)
	{
		return PageObjectModel.getModule(element.getAttribute("instance"));			
	}
	
	return null;	
}

LEAP.trans._OnNextOwnerCheckedChange = function(arg)
{
	try
	{

		var item = arg.caller;
		
		if (arg._handleEvent_NextOwnerCheckedChange != false)
		{
			var module = LEAP.trans.__getmodule(item);
			if (module && module.OnWfNextOwnerCheckedChange)
			{
				var ret = LEAP.trans.getNextOwners(module);
				if (ret != null)
					module.OnWfNextOwnerCheckedChange(ret);
			}
		}
		
		//恢复全选按钮
		if (item['_data'] == null && item.getAttribute(LEAP.trans.n) == LEAP.trans.transct.splitSendOwner)
		{
			var splitOwnerTemplete = LEAP._match(item, LEAP.trans.transct.splitOwnerTemplete, LEAP.trans.n);	
			if (splitOwnerTemplete.getAttribute("allowSelectAll") == "1")
			{
				var btn_select = LEAP.getElement("[transct=" + LEAP.trans.transct.splitSelectAll + "]", splitOwnerTemplete);	
				if (btn_select)
				{
					btn_select.setAttribute("_status", "0");
					btn_select.value = "全选";		
				}
			}
		}
	}
	finally
	{
		item = module = ret = splitOwnerTemplete = btn_select = null;
	}
}


LEAP.trans.__loadUIBanner = function(domain)
{
	LEAP.asyn(LEAP.trans.__loadUIBanner_1, this, 0, domain);
}

LEAP.trans.__loadUIBanner_1 = function(domain)
{
	try
	{
		var banners = LEAP.getElements("[" + LEAP.trans.n + "=" + LEAP.trans.transct.uibanner + "]", domain.moduleElement);
		if (banners)
		{
			for(var i=0; i<banners.length; i++)
			{
				var banner = banners[i];
				LEAP.asyn(LEAP.trans.__loadUIBanner_2, this, 10, domain, banner);
			}
		}
	}
	finally
	{
		banners = i = banner = null;
	}
}

LEAP.trans.__loadUIBanner_2 = function(domain, banner)
{
	if (banner.getAttribute("hasLoad") != null) //已加载，不重新加载
		return;
		
	var workflow = domain.workflow;
	var instance = domain.instance;
	var moduleElement = domain.moduleElement;
	
	var cfg = banner.getAttribute("cfg");
		cfg = JSON.parse(cfg);
	
	var flag = true;  //判断是否符合加载条件
	if (workflow.getData().entry == null)
	{
		if (cfg.loadType == 8 || cfg.loadType == 9)
			flag = false;
	}
	else
	{
		if (workflow.getData().entry.state == 1 && (cfg.loadType == 1 || cfg.loadType == 8))
			flag = false;
	}
	
	if (flag == false)
	{
		return;
	}
	else
	{
		if (cfg.moduleName != null)
		{
			if(cfg.moduleName == "LBPMRTM.hisForm2" || cfg.moduleName == "LBPMRTM.hisForm3")
			{
				var hisModule = domain.loadModule2({name:cfg.moduleName, parent:banner});
				
				hisModule._wfmoduleversion = 3;
				hisModule.initPage(workflow.getData());			
			}
			else
				domain.loadModule(cfg.moduleName, banner, null, {workflow:workflow});
		}
		else if (cfg.url != null)
		{
			var par = "instance=" + instance;
			if (workflow.getData().entry)
				par += "&entryid=" + workflow.getData().entry.entryid;
			
			var url = cfg.url;
			    url += ((url.indexOf("?")>0) ? "&":"?") + par;
			
			var frame = document.createElement("iframe");		
				frame.style.cssText = "width: 100%; height: 100%; border:none; z-index: -1;";				
				frame.src= cfg.url;
			
			banner.appendChild(frame);
		}
		
		banner.setAttribute("hasLoad", 1);
	}	
	
}



LEAP.trans.displaySendPanel = function(domain, display)
{
	try
	{
		var ele = LEAP.getElement("[transct=" + LEAP.trans.transct.SendPanel + "][instance=" + domain.instance + "]", domain.moduleElement);		
		if (ele)
		{
			if (display == false)
				ele.style.display = "none";
			else if (display == true)
				ele.style.display = "";
		}		
	}
	finally
	{
		ele = null;
	}
}

LEAP.trans.hideAllButtons = function(domain)
{
	try
	{
		var instance = domain.instance;
		var moduleElement = domain.moduleElement;
	
		//暂存
		var btnsave = LEAP.getElement("input[transct=" + LEAP.trans.transct.btnsave + "][instance=" + instance + "]", moduleElement);
		//已阅  发送
		var btnread = LEAP.getElement("input[transct=" + LEAP.trans.transct.btnread + "][instance=" + instance + "]", moduleElement);
		var btnsend = LEAP.getElement("input[transct=" + LEAP.trans.transct.btnsend + "][instance=" + instance + "]", moduleElement);
		//监控
		var btnmon = LEAP.getElement("input[transct=" + LEAP.trans.transct.btnmon + "][instance=" + instance + "]", moduleElement);
		var btnpull = LEAP.getElement("input[transct=" + LEAP.trans.transct.btnpull + "][instance=" + instance + "]", moduleElement);
		//退回
		var btnpush = LEAP.getElement("input[transct=" + LEAP.trans.transct.btnpush + "][instance=" + instance + "]", moduleElement);
		//关注
		var btnfav = LEAP.getElement("input[transct=" + LEAP.trans.transct.btnfav + "][instance=" + instance + "]", moduleElement);
		//删除
		var btndel = LEAP.getElement("input[transct=" + LEAP.trans.transct.btndel + "][instance=" + instance + "]", moduleElement);
		//全局操作
		var divoption = LEAP.getElement("div[transct=" + LEAP.trans.transct.divoption + "][instance=" + instance + "]", moduleElement);
		//提前动作
		var divaheadaction = LEAP.getElement("div[transct=" + LEAP.trans.transct.divaheadaction + "][instance=" + instance + "]", moduleElement);
				
		if (btnsave)
			btnsave.style.display = "none";
		if (btnread)
			btnread.style.display = "none";
		if (btnsend)
			btnsend.style.display = "none";
		if (btnmon)
			btnmon.style.display = "none";
		if (btnpull)
			btnpull.style.display = "none";
		if (btnpush)
			btnpush.style.display = "none";
		if (btnfav)
			btnfav.style.display = "none";
		if (btndel)
			btndel.style.display = "none";
		if (divoption)
			divoption.style.display = "none";
		if (divaheadaction)
			divaheadaction.style.display = "none";
	}
	finally
	{
		instance = moduleElement = btnsave = btnread = btnsend = btnmon = btnpull = btnpush = btnfav = btndel = divoption = null; 
	}
}

LEAP.trans.ChangeNextActions = function(domain, actionNames)
{
	try
	{
		var data = domain.workflow.___data;
		if (data.currentStep == null || (data.currentStep != null &&　data.currentStep.readstep == 1))
			return;
		
		var stepid = data.currentStep.stepid;
		
		var names = actionNames.split(',');	
		var arr = [];
		for(var i=0; i<names.length; i++)
		{
			var name = names[i];
			
			for(var k=0; k<data.flow.actions.length; k++)
			{
				var act = data.flow.actions[k];
				if (act.srcstepid == stepid && act.actionname == name)
				{
					act = LWFP.innerApi.setActionTrgStep(act, data.flow.steps);
					arr.add(act);
					break;
				}
			}
		}
		
		if (arr.length == 0)
			return;
		else
			LEAP.trans.__initNextAction(domain, arr);	
	}
	finally
	{
		data = stepid = names = arr = i = name = k = act = null;
	}
}

LEAP.trans.setSkipNextownerValidateActions = function(domain, actionNames)
{
	try
	{
		var data = domain.workflow.___data;
		if (data == null)
			return;
		
		if (data.flow.actions == null)
			return;
		
		var names = actionNames.split(',');	
		for(var i=0; i<names.length; i++)
		{
			var name = names[i];			
			for(var k=0; k<data.flow.actions.length; k++)
			{
				var act = data.flow.actions[k];
				if (act.actionname == name)
				{
					act.__SkipNextownerValidate = true;
					break;
				}
			}
		}
	}
	finally
	{
		data = names = arr = i = name = find = k = act = null;
	}
}

LEAP.trans.getNextOwners = function(domain)
{
	try
	{
		var module = domain
		if (module && module.OnWfNextOwnerCheckedChange)
		{
			var instance = module.instance;		
			var moduleElement = module.moduleElement;	
		
			var sendOwnerPanel = LEAP.getElement("[transct=" + LEAP.trans.transct.SendOwnerPanel + "][instance=" + instance + "]", moduleElement);
			var SplitOwnerPanel = LEAP.getElement("[transct=" + LEAP.trans.transct.SplitOwnerPanel + "][instance=" + instance + "]", moduleElement);
			if (sendOwnerPanel && sendOwnerPanel.style.display != "none")
			{
				var _item = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + instance + "]", sendOwnerPanel);
				if (_item)
				{
					var ret = [{actionname:_item.getAttribute("actionname"), owners:LEAP.item.getValue(_item)}];	
					
					return ret;
				}
			}
			else if (SplitOwnerPanel && SplitOwnerPanel.style.display != "none")
			{
				var _items = LEAP.getElements("ul[transct=" + LEAP.trans.transct.splitSendOwner + "][instance=" + instance + "]", SplitOwnerPanel);
				if (_items != null)
				{
					var ret = [];
					for(var i=0; i<_items.length; i++)
					{
						if (_items[i].getAttribute("actionname") != null)
						{						
							ret.add( {actionname:_items[i].getAttribute("actionname"), owners:LEAP.item.getValue(_items[i])} );
						}
					}
					
					return ret;
				}				
			}
		}
		
		return null;
	}
	finally
	{
		module = instance = moduleElement = sendOwnerPanel = SplitOwnerPanel = _item = ret = _items = ret = i = null;
	}
}

LEAP.trans.setNextOwners = function(domain, actionName, owners)
{
	try
	{
		var item = LEAP.getElement("ul[transct=" + LEAP.trans.transct.SendOwner + "][instance=" + domain.instance + "][actionname=" + actionName + "]", domain.moduleElement);
		var check2 = null;
		if (item)
		{		
			var sendOwnerPanel = LEAP._match(item, LEAP.trans.transct.SendOwnerPanel, LEAP.trans.n);
			check2 = LEAP.getElement("[transct=" + LEAP.trans.transct.SendOwnerCheck + "][instance=" + domain.instance + "]", sendOwnerPanel);
		}
			
		if (!item)
		{
			item = LEAP.getElement("ul[transct=" + LEAP.trans.transct.splitSendOwner + "][instance=" + domain.instance + "][actionname=" + actionName + "]", domain.moduleElement);
		
			var splitOwnerTemplete = LEAP._match(item, LEAP.trans.transct.splitOwnerTemplete, LEAP.trans.n);		
			check2 = LEAP.getElement("[transct=" + LEAP.trans.transct.splitSendOwnerCheck + "][instance=" + domain.instance + "]", splitOwnerTemplete);	
		}
		
		if (item != null && check2 != null)
		{
			if (check2.style.display != "none")
			{
				var ids = "";
				if (owners != null)
				{
					for(var i=0; i<owners.length; i++)
						ids = ids + owners[i].ID + ",";
				}
				
				LEAP.checkbox2.setValue(check2, ids);
				
				var p = {caller:check2, _handleEvent_NextOwnerCheckedChange:false};
				if (check2.getAttribute(LEAP.trans.n) == LEAP.trans.transct.splitSendOwnerCheck)
					LEAP.trans.__onDirectUserCheckChange_split(p);
				else
					LEAP.trans.__onDirectUserCheckChange(p);				
			}
			else
			{
				LEAP.item.setValue(item, owners, "__title", p);
			}
		}
	}
	finally
	{
		item = check2 = sendOwnerPanel = splitOwnerTemplete = ids = i = null;
	}	
}

LEAP.trans.send = function(domain, actionname)
{
	try
	{
		LEAP.trans._send_changeAction(domain, actionname);		
		LEAP.trans.__send(domain.instance, true, actionname);
	}
	finally
	{
	}
}


LEAP.trans.init();





LEAP.wfupload = {};
LEAP.wfupload.showMask = true;

/**
 * 固定文件上传 
 * demo:
 * uploadurl = leapconfig.server + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + '&path=default';
 * LEAP.wfuplaod.upload(uploadurl, "C:\\0.jpg" , this, this.onFileUploaded);
 * this.onFileUploaded = function(value, result)
	{
		if(value==1) this.setPhoto(result); else if (value == 3) alert('网络中断');
	}
 */
LEAP.wfupload.upload = function(uploadurl, filename, domain, callback, showMask)
{	
	try
	{
		LEAP.Comb.upload.upload({uploadurl: uploadurl,
									filename: filename,
									callback: LEAP.wfupload.OnUploadComplete,
									callbackParam: {domain:domain, callback:callback},
									domain:	this,
									showMask: showMask});
		
		if(showMask == true)
		{
			LEAP.showMask();
			LEAP.asyn(LEAP.hideMask, this, 5000);
		}
	}
	finally
	{

	}
}

LEAP.wfupload.OnUploadComplete = function(arg)
{
	try
	{
		if (arg.param.domain && arg.param.callback)
			arg.param.callback.call(arg.param.domain, arg.value, arg.result);
	}
	finally
	{
		LEAP.hideMask();
	}
}

LEAP.wfupload.singleUpload = function(domain, url, filter, callback, showMask)
{
	try
	{	
		LEAP.Comb.upload.singleUpload({uploadurl: url,
										filter: filter,
										callback: LEAP.wfupload.OnUploadComplete,
										callbackParam: {domain:domain, callback:callback},
										domain:	this,
										showMask: showMask});
		
		if(showMask == true)
		{
			LEAP.showMask();
			LEAP.asyn(LEAP.hideMask, this, 5000);
		}		
	}
	finally
	{
	}
}

/**
 * 多文件批量上传
 * demo:
 	var uploadurl = leapconfig.server + 'LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=' + leapclient.getsid() + '&path=default';
 	var filter = "所有文件|*.*|图片(*.jpg)|*.jpg;*.gif|文档(*.txt;*doc)|*.txt;*.doc";
 	
   	LEAP.wfupload.batchUpload(this, uploadurl, filter, this.onBatchUploadCallback, true);

   	this.onBatchUploadCallback = function(value, _result)
    {
		if (value != 1)
			return;
			
		var result = JSON.parse("[" + _result + "]");		
		LEAP.messagebox.alert('上传成功，一共' + result.length + '个文件。');
	} 
 * 
 */
LEAP.wfupload.batchUpload = function(domain, url, filter, callback, showMask)
{
	try
	{		
		LEAP.Comb.upload.batchUpload({uploadurl: url,
										filter: filter,
										callback: LEAP.wfupload.OnUploadComplete,
										callbackParam:	{domain:domain, callback:callback},
										domain:	this,
										showMask: showMask});	

		if(showMask == true)
		{
			LEAP.showMask();
			LEAP.asyn(LEAP.hideMask, this, 5000);
		}		
	}
	finally
	{

	}	
}


/**
 * 多文件批量下载
 * @param {} urlArray 文件url地址数组
 */
LEAP.wfupload.batchDownload = function(urlArray)
{
	try
	{
		LEAP.Comb.upload.download(urlArray);
	}
	finally
	{
	}
}

LEAP.wfuplaod = LEAP.wfupload;







LEAP.dragdrop = {};
LEAP.dragdrop.d = "dragdrop"
LEAP.dragdrop.ddt = "ddt";
LEAP.dragdrop.ddid = "ddid";
LEAP.dragdrop.symbol = {dragdropBlock:"dragdropBlock", dragdropDirection:"dragdropDirection"};

LEAP.dragdrop.init = function()
{
	if (LEAPBrowser.isIE == true && LEAPBrowser.IEVersion <= 9)
		return;
		
	if (document != null && document.body != null)
		LEAP.dragdrop._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.dragdrop._init);	
		
	ElementEventManager.addManagedEventType("dragdrop", 'onSort');
}

LEAP.dragdrop._init = function()
{		
	LEAP.addEvent(document.body, 'mousedown', LEAP.dragdrop.uiProcess, null, null, true);	
	LEAP.addEvent(document.body, 'mousemove', LEAP.dragdrop.uiProcess, null, null, true);	
	LEAP.addEvent(document.body, 'mouseover', LEAP.dragdrop.uiProcess, null, null, true);
	LEAP.addEvent(document.body, 'mouseup', LEAP.dragdrop.uiProcess, null, null, true);
	//LEAP.addEvent(document.body, 'mouseout', LEAP.dragdrop.uiProcess, null, null, true);
			
	UIEventManager.removeEvent(window, 'load', LEAP.dragdrop._init);
}

LEAP.dragdrop.Dragging = false;
LEAP.dragdrop.DraggingFrame = null;
LEAP.dragdrop.trgFrame = null;
LEAP.dragdrop.R = {X:0, Y:0};

LEAP.dragdrop.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		var type = arg.e.type;
		
		if (type == "mousedown")
		{
			LEAP.dragdrop.beginDrag(arg.e);		
		}
		else if (type == "mouseup")
		{
			LEAP.dragdrop.drop(arg.e);
		}
		else if (type == "mouseover")
		{//拖到目标块上时，建一个空div			
			LEAP.dragdrop.beforeDrop(arg.e);
		}
		else if (type == "mousemove")
		{//处理拖动效果
			LEAP.dragdrop.dragging(arg.e);
			
			LEAP.dragdrop.beforeDrop(arg.e);
		}		
	}
	finally
	{
		src = type = null;
	}	
}


LEAP.dragdrop.beginDrag = function(event)
{
	try
	{
		var block = LEAP._match(event.srcElement, LEAP.dragdrop.symbol.dragdropBlock, LEAP.dragdrop.ddt, 5);
		if (block == null)
		{
			LEAP.dragdrop.stopDrag();
			return;
		}
		
		var con = LEAP._match(event.srcElement, LEAP.dragdrop.d, "ct", 5);
		if (con == null)
			return;
		
		var direction = con.getAttribute(LEAP.dragdrop.symbol.dragdropDirection)==null ? 0 : con.getAttribute(LEAP.dragdrop.symbol.dragdropDirection);
		
		//标记块
		var uid = UUID.cID();
		var arr = LEAP.getElements("[" + LEAP.dragdrop.ddt + "=" + LEAP.dragdrop.symbol.dragdropBlock + "]", block.parentElement);
		for(var i=0; i<arr.length; i++)
		{
			arr[i].setAttribute("uid", uid);
		}
			 	
		var rect = block.getBoundingClientRect();		
		LEAP.dragdrop.DraggingFrame = {direction: direction};
		//创建活动框
		for(var i=0; i<4; i++)
		{
			var T = document.createElement("div");
			T.style.position = "absolute";		
			T.style.zIndex = 100000;
			T.style.borderWidth = "1px";
			T.style.borderColor = "#1FAAE5";
			T.style.borderStyle = "solid";			
			document.body.appendChild(T);
			
			LEAP.dragdrop.DraggingFrame["F" + i] = T;
		}
			
		//计算位置偏移
		LEAP.dragdrop.DraggingFrame.R = {w:rect.width, h:rect.height, 
											t:event.pageY-rect.top, 
											r:rect.right - event.pageX,
											b:rect.bottom - event.pageY,
											l:event.pageX - rect.left
										};
										
		LEAP.dragdrop.DraggingFrame.__data = block; //记录要拖动的块		
		LEAP.dragdrop.Dragging = true
		
		LEAP.dragdrop.__move(event);
	}
	finally
	{
		block = uid = arr = rect = i = T = null;
	}
}

LEAP.dragdrop.__move = function(event)
{//随鼠标移动活动框
	if (LEAP.dragdrop.DraggingFrame != null)
	{
		LEAP.dragdrop.DraggingFrame.F0.style.width = LEAP.dragdrop.DraggingFrame.R.w + "px";
		LEAP.dragdrop.DraggingFrame.F0.style.height = "0px";
		LEAP.dragdrop.DraggingFrame.F0.style.left = (event.pageX - LEAP.dragdrop.DraggingFrame.R.l) + "px";
		LEAP.dragdrop.DraggingFrame.F0.style.top = (event.pageY - LEAP.dragdrop.DraggingFrame.R.t) + "px";
		
		LEAP.dragdrop.DraggingFrame.F1.style.width = "0px";
		LEAP.dragdrop.DraggingFrame.F1.style.height = LEAP.dragdrop.DraggingFrame.R.h + "px";
		LEAP.dragdrop.DraggingFrame.F1.style.left = (event.pageX + LEAP.dragdrop.DraggingFrame.R.r) + "px";
		LEAP.dragdrop.DraggingFrame.F1.style.top = (event.pageY - LEAP.dragdrop.DraggingFrame.R.t) + "px";
		
		LEAP.dragdrop.DraggingFrame.F2.style.width = LEAP.dragdrop.DraggingFrame.R.w + "px";
		LEAP.dragdrop.DraggingFrame.F2.style.height = "0px";
		LEAP.dragdrop.DraggingFrame.F2.style.left = (event.pageX - LEAP.dragdrop.DraggingFrame.R.l) + "px";
		LEAP.dragdrop.DraggingFrame.F2.style.top = (event.pageY + LEAP.dragdrop.DraggingFrame.R.b) + "px";
		
		LEAP.dragdrop.DraggingFrame.F3.style.width = "0px";
		LEAP.dragdrop.DraggingFrame.F3.style.height = LEAP.dragdrop.DraggingFrame.R.h + "px";
		LEAP.dragdrop.DraggingFrame.F3.style.left = (event.pageX - LEAP.dragdrop.DraggingFrame.R.l) + "px";
		LEAP.dragdrop.DraggingFrame.F3.style.top = (event.pageY - LEAP.dragdrop.DraggingFrame.R.t) + "px";
	}
	
	event.preventDefault();
}

LEAP.dragdrop.dragging = function(event)
{
	if (LEAP.dragdrop.Dragging == true)
	{
		LEAP.asyn(LEAP.dragdrop.__move, this, 0, event);
	}
}


LEAP.dragdrop.beforeDrop = function(event)
{
	try
	{
		if (LEAP.dragdrop.Dragging == false)
			return;
			
		var trgBlock = LEAP._match(event.srcElement, LEAP.dragdrop.symbol.dragdropBlock, LEAP.dragdrop.ddt, 5);
		if (trgBlock == null || trgBlock == LEAP.dragdrop.DraggingFrame.__data)
			return;
			
		if (trgBlock.getAttribute("uid") != LEAP.dragdrop.DraggingFrame.__data.getAttribute("uid"))
			return;
		
		var rect = trgBlock.getBoundingClientRect();		
		var direction = LEAP.dragdrop.DraggingFrame.direction;
				
		if (LEAP.dragdrop.trgFrame == null)
		{
			LEAP.dragdrop.trgFrame = document.createElement("div");
			LEAP.dragdrop.trgFrame.style.position = "absolute";
			LEAP.dragdrop.trgFrame.style.zIndex = 100000;
			LEAP.dragdrop.trgFrame.style.borderWidth = "2px";
			LEAP.dragdrop.trgFrame.style.borderColor = "#1FAAE5";
			LEAP.dragdrop.trgFrame.style.borderStyle = "dashed";
		}
				
		var direct = "before";
		if (direction == 1) //横向排版
		{			
			if (event.pageX < (rect.left + rect.width/2) )
			{
				direct = "before";				
				LEAP.dragdrop.trgFrame.style.left = (rect.left - 5) + "px";
				LEAP.dragdrop.trgFrame.style.top = rect.top + "px";
				LEAP.dragdrop.trgFrame.style.width = "0px";
				LEAP.dragdrop.trgFrame.style.height = rect.height + "px";
			}			
			else
			{
				direct = "after";				
				LEAP.dragdrop.trgFrame.style.left = (rect.right + 5) + "px";
				LEAP.dragdrop.trgFrame.style.top = rect.top + "px";
				LEAP.dragdrop.trgFrame.style.width = "0px";
				LEAP.dragdrop.trgFrame.style.height = rect.height + "px";
			}
		}
		else 
		{ //纵向排版
			if (event.pageY < (rect.top + rect.height/2))
			{
				direct = "before";	
				LEAP.dragdrop.trgFrame.style.left = rect.left + "px";
				LEAP.dragdrop.trgFrame.style.top = (rect.top - 3) + "px";
				LEAP.dragdrop.trgFrame.style.width = rect.width + "px";
				LEAP.dragdrop.trgFrame.style.height = "0px";
			}
			else
			{
				direct = "after";	
				LEAP.dragdrop.trgFrame.style.left = rect.left + "px";
				LEAP.dragdrop.trgFrame.style.top = (rect.bottom + 3) + "px";
				LEAP.dragdrop.trgFrame.style.width = rect.width + "px";
				LEAP.dragdrop.trgFrame.style.height = "0px";
			}
		}
		
		LEAP.dragdrop.trgFrame.setAttribute("direct", direct);
		
		document.body.appendChild(LEAP.dragdrop.trgFrame);
		LEAP.dragdrop.trgFrame["__data"] = trgBlock;
	}
	finally
	{
		trgBlock = rect = direction = direct = null;
	}
}

LEAP.dragdrop.drop = function(event)
{
	try
	{	
		if (LEAP.dragdrop.Dragging == false)
			return;
		
		if (LEAP.dragdrop.DraggingFrame != null && LEAP.dragdrop.DraggingFrame.__data != null 
			&& LEAP.dragdrop.trgFrame != null && LEAP.dragdrop.trgFrame["__data"] != null)
		{
			var src = LEAP.dragdrop.DraggingFrame.__data;
			var trg = LEAP.dragdrop.trgFrame["__data"];
			var direct = LEAP.dragdrop.trgFrame.getAttribute("direct"); 
			if (direct == "before")
			{//在目标前插入
				trg.parentElement.insertBefore(src, trg); 
			}
			else
			{//在目标后插入
				if (trg.parentElement.lastChild == trg)
				{//目标是最后一个				
					trg.parentElement.appendChild(src);
				}
				else if (trg.nextSibling != src)
				{	
					trg.parentElement.insertBefore(src, trg.nextSibling);
				}
			}
			
			var con = LEAP._match(src, LEAP.dragdrop.d, "ct", 5);
			
			ElementEventManager.handleEvent(con, "onSort", {srcBlock: src,
																		targetBlock: trg} );		
		}
		
	}
	finally
	{
		src = trg = con = null;
		LEAP.dragdrop.stopDrag();
	}
}

LEAP.dragdrop.stopDrag = function()
{
	try
	{
		LEAP.dragdrop.Dragging = false;
		LEAP.dragdrop.Block = null;	
		
		if (LEAP.dragdrop.DraggingFrame != null)
		{
			for(var i=0; i<4; i++)
			{
				document.body.removeChild(LEAP.dragdrop.DraggingFrame["F" + i]);			
				LEAP.dragdrop.DraggingFrame["F" + i] = null;
			}
			
			LEAP.dragdrop.DraggingFrame = null;
		}
		
		if (LEAP.dragdrop.trgFrame != null)
		{
			document.body.removeChild(LEAP.dragdrop.trgFrame);		
			LEAP.dragdrop.trgFrame = null;
		}
	}
	finally
	{
		i = null;
	}
}






LEAP.dragdrop.init();






LEAP.at = {};
LEAP.at.d = 'at';
LEAP.at.symbol = {last_selection:"last_selection", atobject_view_field:"atobject_view_field", atobject_id_field:"atobject_id_field", atHash:"atHash"};

LEAP.at.init = function()
{
	if (document != null && document.body != null)
		LEAP.at._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.at._init);	
		
	ElementEventManager.addManagedEventType(LEAP.at.d, 'onStartSelect');
}

LEAP.at._init = function()
{		
	LEAP.addEvent(document.body, 'keyup', LEAP.at.uiProcess, null, null, true);	
	LEAP.addEvent(document.body, 'mouseup', LEAP.at.uiProcess, null, null, true);	
	
	UIEventManager.removeEvent(window, 'load', LEAP.at._init);
}

LEAP.at.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		var ctf = src.getAttribute('ctf');
		if (ctf == null) 
			return;
		
		if (ctf != "at_textarea")
			return;
			
		var element = LEAP._match(src, LEAP.at.d);
		if(element == null)
			return;
		
		LEAP.at.keyup(element, arg);
		
	}
	finally
	{
		src = ctf = element = null;
	}	
	
}

LEAP.at.inputAtObject = function(element, arrObj)
{
	try
	{
		var viewField = element.getAttribute(LEAP.at.symbol.atobject_view_field);
		var idField = element.getAttribute(LEAP.at.symbol.atobject_id_field);
		
		var hash = element[LEAP.at.symbol.atHash]
		if (hash == null)
			hash = new hashtable();
		for(var i=0; i<arrObj.length; i++)
		{
			var obj = arrObj[i];
			var id = obj[idField];
			hash.add(id, arrObj[i]);
		}
		element[LEAP.at.symbol.atHash] = hash;
		
		var textarea = LEAP.getElement("textarea[ctf=at_textarea]", element);	
		var sec = textarea[LEAP.at.symbol.last_selection];
		
		var str = "";
		for(var i=0; i<arrObj.length; i++)
	  	{
	  		var obj = arrObj[i];
	  		str += "@" + obj[viewField] + " ";
	  	}
		
		//将textarea分成三块，@之前的area1、@+联系人+' '的area2、光标之后的area3
	  	var area1 = sec.lastString.substr(0, sec.atLocation);
	 	var area2 = str;
	 	var area3 = sec.lastString.substr(sec.cursorPosition, sec.lastString.length - sec.cursorPosition);
	  	//var area3 = sec.lastString.substr(sec.cursorPosition, LEAP.at.getLength(sec.lastString) - sec.cursorPosition);
	
		textarea.value = area1 + area2 + area3;
	
	  	//定位光标
		var position = area1.length + area2.length;
		LEAP.at.__cursorHandle(textarea, position);		
	}
	finally
	{
		viewField = idField = hash = i = obj = id = textarea = sec = str = area1 = area2 = area3 = position = null;
	}
}

LEAP.at.getAtList = function(element)
{
	try
	{
		var hash = element[LEAP.at.symbol.atHash];
		if (hash != null)
		{
			var arr = [];
			for(var key in hash.keys)
			{
				arr.add(hash.getvalue(key));
			}
			
			return arr;
		}
		
		return null;
	}
	finally
	{
		hash = arr = key = null;
	}
}

LEAP.at._delete = function(element, keyCode)
{
	try
	{
		var textarea = LEAP.getElement("textarea[ctf=at_textarea]", element);	
		var hash = element[LEAP.at.symbol.atHash];
		if (hash == null || hash.length == 0)
			return;
			
		var sec = textarea[LEAP.at.symbol.last_selection];
		var beforeCursorString = sec.beforeCursorString;
		var viewField = element.getAttribute(LEAP.at.symbol.atobject_view_field);
		
		for(var key in hash.keys)
		{
			var obj = hash.getvalue(key);
			var str = "@" + obj[viewField];
			
			if (keyCode == 8)
			{
				if (beforeCursorString.endWith(str))
				{			
					var area1 = beforeCursorString.substr(0, beforeCursorString.length -  str.length);
					//var area3 = sec.lastString.substr(sec.cursorPosition, LEAP.at.getLength(sec.lastString) - sec.cursorPosition);
					var area3 = sec.lastString.substr(sec.cursorPosition, sec.lastString.length - sec.cursorPosition);
					
					textarea.value = area1 + area3;
					
					//定位光标
					var position = area1.length;
					LEAP.at.__cursorHandle(textarea, position);
					
					hash.remove(key);
					element[LEAP.at.symbol.atHash] = hash;
					
					break;
				}
			}
			else if (keyCode == 46)
			{
				if (sec.preString == null)
					break;
				
				var area3 = sec.preString.substring(sec.cursorPosition);
				if (area3.startWith(str))
				{
					area3 = area3.substring(str.length + 1);
					textarea.value = beforeCursorString + area3;
					
					//定位光标
					var position = beforeCursorString.length;
					LEAP.at.__cursorHandle(textarea, position);
					
					hash.remove(key);
					element[LEAP.at.symbol.atHash] = hash;
					
					break;
				}
			}
		}
	}
	finally
	{
		textarea = hash = sec = beforeCursorString = viewField = key = obj = str = area1 = area3 = position = null;
	}
}

LEAP.at._mouseup = function(element)
{
	try
	{
		var viewField = element.getAttribute(LEAP.at.symbol.atobject_view_field);
		var textarea = LEAP.getElement("textarea[ctf=at_textarea]", element);
		var hash = element[LEAP.at.symbol.atHash];
		if (hash == null || hash.length == 0)
			return;
		
		var sec = textarea[LEAP.at.symbol.last_selection];
		
		var lastString = sec.lastString;
		var beforeCursorString = sec.beforeCursorString;
		var cursorPosition = sec.cursorPosition;
		
		var atLocation = beforeCursorString.lastIndexOf('@');
		
		if (atLocation >= 0)
		{
			var atAfterStr = sec.lastString.substring(atLocation, sec.lastString.length);
			for(var key in hash.keys)
			{
				var obj = hash.getvalue(key);
				var str = "@" + obj[viewField] + " ";
				if ( ((cursorPosition - atLocation) < str.length) && atAfterStr.startWith(str))
				{
					var position = atLocation + str.length;
					LEAP.at.__cursorHandle(textarea, position);
					
					break;
				}
			}
		}	
	}
	finally
	{
		viewField = textarea = hash = sec = lastString = beforeCursorString = atLocation = atAfterStr = key = obj = str = position = null;
	}
}

LEAP.at.keyup = function(element, arg)
{
	try
	{
		var textarea = LEAP.getElement("textarea[ctf=at_textarea]", element);
		
		var preString = null;
		if (textarea[LEAP.at.symbol.last_selection] != null)
			preString = textarea[LEAP.at.symbol.last_selection].lastString;
		
		var lastString = textarea.value;
	 	var cursorPosition = LEAP.at.__posCursor(textarea); //光标当前位置  
	  	var beforeCursorString = lastString.substr(0, cursorPosition); //光标之前的字符串  
	 	var atLocation = beforeCursorString.lastIndexOf('@'); //记录@在光表前出现的最近的位置
	 	
	 	textarea[LEAP.at.symbol.last_selection] = {preString:preString, lastString:lastString, cursorPosition:cursorPosition, beforeCursorString:beforeCursorString, atLocation:atLocation};
		
	 	if (arg.type == "keyup")
	 	{
		 	var keyCode = arg.e.keyCode;
			if (keyCode == 50 && beforeCursorString.endWith("@"))
			{
				ElementEventManager.handleEvent(element, "onStartSelect", {aaa:9});
			}
			else if (keyCode == 8 || keyCode == 46)
			{
				LEAP.at._delete(element, keyCode);
			}
	 	
			//test
			//var a = document.getElementById("wwww").value;	
			//document.getElementById("wwww").value = a + "||" + arg.e.keyCode + ":" + arg.e.char;
	 	}
	 	else (arg.type == "mouseup")
	 	{
	 		LEAP.at._mouseup(element);
	 	} 	
	}
	finally
	{
		textarea = lastString = cursorPosition = beforeCursorString = atLocation = keyCode;
	}
}


// 统计光标之前的字符串
LEAP.at.__posCursor = function(obj) 
{
	try
	{
		var isIE = !(!document.all);
	  	var end = 0;
	  	if (isIE) 
	  	{
	    	var sTextRange = document.selection.createRange();
	    	if (sTextRange.parentElement() == obj) 
	    	{
	      		var oTextRange = document.body.createTextRange();
	      		oTextRange.moveToElementText(obj);
	      		for (end = 0; oTextRange.compareEndPoints('StartToEnd', sTextRange) < 0; end++) 
	      		{
					oTextRange.moveStart('character', 1);
	  			}
	  			
	  			for (var i = 0; i <= end; i++) 
	  			{
	    			if (obj.value.charAt(i) == '\n') 
	    			{
	          			end++;
	        		}
	      		}
	    	}
	  	} 
	  	else 
	  	{
	    	end = obj.selectionEnd;
	  	}
	  	
	  	return end;
	}
	finally
	{
		isIE = end = sTextRange = oTextRange = i = null;
	}
}

// 统计字符串总长度中文字符为2，英文字符及数字为1
LEAP.at.__getLength = function(obj) 
{
  	var realLength = 0
  	var len = obj.length;
  	var charCode = -1;
  	for (var i = 0; i < len; i++) 
  	{
    	charCode = obj.charCodeAt(i);
    	if (charCode >= 0 && charCode <= 128)
    	{
      		realLength += 1
    	}
    	else
    	{
      		realLength += 2
    	}
  	}
  	
  	return realLength;
}

//定位光标位置
LEAP.at.__cursorHandle = function(obj, pos) 
{
	if (navigator.appName == "Microsoft Internet Explorer") 
	{
    	var range = obj.createTextRange();
    	range.move("character", pos);
    	range.select();
  	}
  	else
  	{
    	obj.setSelectionRange(pos, pos);
    	obj.focus();
  	}
  	
}



LEAP.at.init();




/**
 * 磁贴
 * @type 
 */

LEAP.tile = {};
LEAP.tile.d = 'tile';
LEAP.tile.n = 'attdata';
LEAP.tile.enable = false; //默认不启动
LEAP.tile.IsSucking = 0; //吸附状态  0无任务1吸附2引用
LEAP.tile.HandlerUI = null;
LEAP.tile.MarkUI = null;
LEAP.tile.PointerUI = null;
LEAP.tile.MainUI = null;
LEAP.tile.ctfs = {tile_handleUI:"tile_handleUI", tile_label:"tile_label", tile_sucker:"tile_sucker", tile_tag:"tile_tag", 
					tile_MarkUI:"tile_MarkUI", tile_check_all:"tile_check_all",
					tile_PointerUI:"tile_PointerUI",
					tile_list_clear:"tile_list_clear", tile_list_comfirm:"tile_list_comfirm",		
					tmpAttData:"tmpAttData", tmpAttPlugin:"tmpAttPlugin",
					attArrayDatas:"attArrayDatas"
					};
					
LEAP.tile.mainHtml = '<div class="divlayoutcon wfcontorl_tile_MainUI" style="width: 100%; height: 100%;" >' +
						'<div class="lc_layout_p_con">' +
							'<div class=" lc_layout_bt_p sel" style="bottom: 80px; overflow-y:auto;">' +
								'<div class="table_border table LC_table" ct="table" ut="list" showcheck="1" rowheight="40" autosize="1" >' +
									'<div class="lgresultpanel_table" style="bottom: 0px;" onscroll="LEAPLG.table_scrl();" onresize="LEAPLG.table_scrl();">' +
										'<table border="0" cellspacing="0">' +
											'<thead ctf="table_thead">' +
												'<tr ctf="table_thead_tr">' +
													'<th style="width: 73px;" ctf="table_header" bt="table_sn" md="id" sncol="1"><input ctf="tile_check_all" class="LC_form-input" type="checkbox"><span>&nbsp</span>&nbsp;&nbsp;全选</th>' +
													'<th style="width: 90%;" ctf="table_header" bt="text"  md="title">名称</th>' +
													'<th style="width: 80px;" ctf="table_header" tpo="删除:删除">操作</th>' +
												'</tr>' +
											'</thead>' +
											'<tbody ctf="table_tbody">' +
											'</tbody>' +
										'</table>' +
									'</div>	' +
								'</div>' +
							'</div>' +
							'<div class="lc_layout_bt_p" style="top: auto; height: 80px; border-top:1px solid #ccc;">' +								
								'<span style="color:#FF0000; float:left; width:99%; font-size:14px; padding:2px 20px;">请勾选需要引用的附件，点击【引用至...】按钮，将鼠标移至目标区域，然后点击鼠标左键。</span><br>' + 
								'<input class="LC_button_conner LC_button_blue" type="button" ctf="tile_list_comfirm" value="引用至..." style="float:right; margin:10px 30px 0px 20px">	' +
								'<input class="LC_button_conner LC_button_blue" type="button" ctf="tile_list_clear" value="清空" style="border:1px solid #808080;background-color:#808080; float:right; margin-top:10px;">' +
							'</div>	' +
						'</div>' +
					'</div>';


LEAP.tile.init = function()
{	
	if (document != null && document.body != null)
		LEAP.tile._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.tile._init);
		
	//ElementEventManager.addManagedEventType(LEAP.tile.d, 'onListChange');
}
LEAP.tile._init = function()
{	
	setTimeout(LEAP.tile._init_, 1000, 10);
}

LEAP.tile._init_ = function(times)
{
	if (LEAP.tile.enable == false)
	{
		if (times > 0)
		{
			setTimeout(LEAP.tile._init_, 1000, times - 1);
		}
		
		return;
	}
	
	LEAP.tile.i();
	
	LEAP.addEvent(document.body, 'mouseover', LEAP.tile.uiProcess,  null, null, true);
	LEAP.addEvent(document.body, 'mousemove', LEAP.tile.uiProcess,  null, null, true);
	LEAP.addEvent(document.body, 'click', LEAP.tile.uiProcess, null, null, true);
	LEAP.addEvent(document.body, 'contextmenu', LEAP.tile.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.tile._init);
}


	
LEAP.tile.i = function()
{		
	if (LEAP.tile.HandlerUI == null)
	{
		LEAP.tile.HandlerUI = document.createElement("div");
		LEAP.tile.HandlerUI.className = "wfcontorl_tile";
		LEAP.tile.HandlerUI.setAttribute("ctf", LEAP.tile.ctfs.tile_handleUI );
		
		var handler = document.createElement("div");
			handler.className = "wfcontorl_tile_handler";
						
		var label = document.createElement("div");
			label.className = "wfcontorl_tile_lable";
			label.setAttribute("ctf", LEAP.tile.ctfs.tile_label);
			label.title = "打开附件磁贴界面";
			
		var sucker = document.createElement("div");
			sucker.className = "wfcontorl_tile_sucker";
			sucker.setAttribute("ctf", LEAP.tile.ctfs.tile_sucker);
			sucker.title = "点击吸管后，将鼠标移动到附件列表上方吸取附件";
			
		var tag = document.createElement("span");
			tag.className = "wfcontorl_tile_tag";
			tag.setAttribute("ctf", LEAP.tile.ctfs.tile_tag);
			tag.textContent = "0";
		
		
		handler.appendChild(label);
		handler.appendChild(tag);
		handler.appendChild(sucker);
		
		LEAP.tile.HandlerUI.appendChild(handler);
		
		document.body.appendChild(LEAP.tile.HandlerUI);
	}
	
	if (LEAP.tile.MarkUI == null)
	{
		LEAP.tile.MarkUI = document.createElement("div");
		LEAP.tile.MarkUI.className = "wfcontorl_tile_markui";
		LEAP.tile.MarkUI.setAttribute("ctf", LEAP.tile.ctfs.tile_MarkUI);		
		
		document.body.appendChild(LEAP.tile.MarkUI);
	}
	
	if (LEAP.tile.PointerUI == null)
	{
		LEAP.tile.PointerUI = document.createElement("div");
		LEAP.tile.PointerUI.className = "wfcontorl_tile_PointerUI";
		LEAP.tile.PointerUI.setAttribute("ctf", LEAP.tile.ctfs.PointerUI);		
		
		document.body.appendChild(LEAP.tile.PointerUI);
	}
	
	if (LEAP.tile.MainUI == null)
	{		
		LEAP.tile.MainUI = LEAP.form.create3({name:null, title:'附件磁贴', width:750, height:500, formtype:3});
		LEAP.form.setContent(LEAP.tile.MainUI.form, LEAP.tile.mainHtml);
		
		
		var _formElement = LEAP.getElement(LEAP.tile.MainUI.form);
		var _list = LEAP.getElement("[ut=list]", _formElement);
		LEAP.tile.MainUI.list = _list;
		LEAP.addEvent(LEAP.tile.MainUI.list, 'rowOperationClick', LEAP.tile.__list_delete);
		
		
		LEAP.form.hide(LEAP.tile.MainUI.form);
	}
	
	
}

LEAP.tile.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		var etype = arg.type;
		
		if (etype == "click")
		{
			var ctf = src.getAttribute("ctf");
			if (ctf == LEAP.tile.ctfs.tile_sucker)
			{
				LEAP.tile.PointerUI.className = "wfcontorl_tile_PointerUI";
				LEAP.tile.IsSucking = 1;
				return;
			}
			else if (ctf == LEAP.tile.ctfs.tile_MarkUI)
			{
				LEAP.tile.__suck_Complete();
				return;
			}
			else if (ctf == LEAP.tile.ctfs.tile_label || ctf == LEAP.tile.ctfs.tile_label)
			{
				LEAP.tile.__list_show();	
			}
			else if (ctf == LEAP.tile.ctfs.tile_list_clear)
			{
				LEAP.tile.__list_clear();		
			}
			else if (ctf == LEAP.tile.ctfs.tile_list_comfirm)
			{
				LEAP.tile.__list_comfirm();
				return;
			}
			else if (ctf == LEAP.tile.ctfs.tile_check_all)
			{
				LEAP.tile.__list_check_all(arg);
			}
			
			LEAP.tile.IsSucking = 0;
			LEAP.tile.MarkUI.style.display = "none";
			LEAP.tile.PointerUI.style.display = "none";
		}
		else if (etype == "mouseover")
		{
			LEAP.tile.__suck(src);
		}
		else if (etype == "mousemove")
		{
			LEAP.tile.__suck_ing(arg);
		}
		else if (etype == "contextmenu")
		{
			if (LEAP.tile.IsSucking != 0)
			{
				arg.e.preventDefault();
				
				LEAP.tile.IsSucking = 0;
				LEAP.tile.MarkUI.style.display = "none";
				LEAP.tile.PointerUI.style.display = "none";
			}
		}
	}
	catch(E)
	{
		LEAP.tile.IsSucking = 0;
		LEAP.tile.MarkUI.style.display = "none";
		LEAP.tile.PointerUI.style.display = "none";
	}
	finally
	{
		
	}
}

LEAP.tile.__suck = function(src)
{	
	if (LEAP.tile.IsSucking == 0)
		return;
	
	try
	{
		var ctf = src.getAttribute("ctf");
		if (ctf == LEAP.tile.ctfs.tile_MarkUI)
		{
			return;
		}
				
		if (LEAP.tile.IsSucking == 1)
		{
			var data = null;		
			//LEAP.attlist插件
			var attRow = LEAP._match(src, "attrow", "ctf", 4);
			if (attRow)
			{
				var data = attRow[LEAP.attlist.n];
				if (data.namedpath != null)
				{
					var rect = attRow.getBoundingClientRect();
					
					LEAP.tile.MarkUI.style.width = rect.width + "px";
					LEAP.tile.MarkUI.style.height = rect.height + "px";
					LEAP.tile.MarkUI.style.left = rect.left + "px";
					LEAP.tile.MarkUI.style.top = rect.top + "px";
					LEAP.tile.MarkUI.style.display = "block";
					
					data = LWFP.innerApi.clone(data);
					data.atttype = 0;
					
					LEAP.tile.MarkUI[LEAP.tile.ctfs.tmpAttData] = data;
				}				
			}
		}
		else if (LEAP.tile.IsSucking == 2)
		{
			var attPlugin = LEAP._match(src, "attlist", "ct", 8);
			if (attPlugin)
			{
				if (attPlugin.getAttribute("listtype") != "1") //排除固定项附件
				{
					var rect = attPlugin.getBoundingClientRect();
					
					LEAP.tile.MarkUI.style.width = rect.width + "px";
					LEAP.tile.MarkUI.style.height = rect.height + "px";
					LEAP.tile.MarkUI.style.left = rect.left + "px";
					LEAP.tile.MarkUI.style.top = rect.top + "px";
					LEAP.tile.MarkUI.style.display = "block";
					
					LEAP.tile.MarkUI[LEAP.tile.ctfs.tmpAttPlugin] = attPlugin;
				}
			}
			
		}		
		
	}
	catch(e)
	{	
		LEAP.tile.IsSucking = 0;
		LEAP.tile.MarkUI.style.display = "none";
		LEAP.tile.PointerUI.style.display = "none";
	}
}

LEAP.tile.__lasttime = 0;
LEAP.tile.__suck_ing = function(arg)
{
	if (LEAP.tile.IsSucking == 0)
		return;
	
	//维持鼠标样式
	LEAP.tile.PointerUI.style.left = (arg.e.pageX + 5) + "px";
	LEAP.tile.PointerUI.style.top = (arg.e.pageY - 24) + "px";
	LEAP.tile.PointerUI.style.display = "block";
}

LEAP.tile.__suck_Complete = function()
{	
	if (LEAP.tile.IsSucking == 1)
	{
		var data = LEAP.tile.MarkUI[LEAP.tile.ctfs.tmpAttData];
		if (!data)
		{
			return;
		}
				
		//
		var flag = true;
		var rows = LEAP.table.getRows(LEAP.tile.MainUI.list);
		if (rows)
		{
			for(var i=0; i<rows.length; i++)
			{
				var d = rows[i]["data"];
				if (d.namedpath == data.namedpath && d.name == data.name)
				{
					flag = false;
					break;
				}
			}
		}
		
		if (flag == true)
		{
			LEAP.table.addRow(LEAP.tile.MainUI.list, data);
		}
		
		var counter = 0;
		rows = LEAP.table.getRows(LEAP.tile.MainUI.list);
		if (rows)
		{
			counter = rows.length;
		}
		
		var tag = LEAP.getElement("[ctf=" + LEAP.tile.ctfs.tile_tag + "]", LEAP.tile.HandlerUI);
		tag.textContent = counter;
	}
	else if (LEAP.tile.IsSucking == 2)
	{
		var rows = LEAP.table.getCheckedRows(LEAP.tile.MainUI.list);
		var arr = [];
		for(var i=0; i<rows.length; i++)
		{
			var _data = rows[i]["data"];
				_data.attype = 0;
			arr.add( _data );
		}
		
		var plugin = LEAP.tile.MarkUI[LEAP.tile.ctfs.tmpAttPlugin];
		var ct = plugin.getAttribute("ct");
		var router = LEAP.wfrouter.getRouter(plugin );		
		var uploadpath = "default";
		if (ct == LEAP.attlist.d)
		{		
			if (plugin.getAttribute("uploadpath") != null)
			{
				uploadpath = plugin.getAttribute("uploadpath");
			}
		}
		
		var rst = LEAP.request2({router:router, name:'WFCopyAttachment', par:{srcAttachments:arr, uploadPath:uploadpath}});

		if (rst != null && rst.status == 1)
		{
			if (ct == LEAP.attlist.d)
			{
				for(var i=0; i<rst.data.length; i++)
				{
					var tmp = rst.data[i];
						tmp.size = tmp.attsize;
						tmp.nameedPath = tmp.namedpath;				
					
					LEAP.attlist.onUploadComplete_inner(plugin, tmp, null, tmp.atttype);
				}
			}			
		}
		else
		{
			alert("引用失败。" + rst.err);
		}
		
		LEAP.tile.IsSucking = 0;
		LEAP.tile.MarkUI.style.display = "none";
		LEAP.tile.PointerUI.style.display = "none";
		
	}
}

LEAP.tile.__list_delete = function(arg)
{
	LEAP.table.removeRow(LEAP.tile.MainUI.list, arg.arg2.index);
	
	var counter = 0;
	var rows = LEAP.table.getRows(LEAP.tile.MainUI.list);
	if (rows)
	{
		counter = rows.length;
	}
	
	var tag = LEAP.getElement("[ctf=" + LEAP.tile.ctfs.tile_tag + "]", LEAP.tile.HandlerUI);
	tag.textContent = counter;
}


LEAP.tile.__list_show = function()
{
	LEAP.form.show(LEAP.tile.MainUI.form);
}

LEAP.tile.__list_check_all = function(arg)
{
	if (arg.e.srcElement.checked==true)
	{
		LEAP.table.setCheckedRow(LEAP.tile.MainUI.list, null, "checked");			
	}
	else
	{
		LEAP.table.setCheckedRow(LEAP.tile.MainUI.list, null, "");
	}
}

LEAP.tile.__list_clear = function()
{
	LEAP.table.clearRow(LEAP.tile.MainUI.list);
	
	var tag = LEAP.getElement("[ctf=" + LEAP.tile.ctfs.tile_tag + "]", LEAP.tile.HandlerUI);
	tag.textContent = "0";
}

LEAP.tile.__list_comfirm = function()
{
	var rows = LEAP.table.getCheckedRows(LEAP.tile.MainUI.list);
	if (rows == null)
	{
		alert("请勾选需要引用的附件。");
		return;
	}
	
	LEAP.form.hide(LEAP.tile.MainUI.form);
	
	LEAP.tile.PointerUI.className = "wfcontorl_tile_PointerUI2";
	LEAP.tile.IsSucking = 2;

}




LEAP.tile.init();


LEAP.wfrouter = {};
LEAP.wfrouter.router = null;
LEAP.wfrouter.init = function()
{
	if (document != null && document.body != null)
		LEAP.wfrouter._init();
	else 
		UIEventManager.addEvent(window, 'load', LEAP.wfrouter._init);	
}
LEAP.wfrouter._init = function()
{		
	LEAP.addEvent(document.body, 'click', LEAP.wfrouter.uiProcess, null, null, true);	
	UIEventManager.removeEvent(window, 'load', LEAP.wfrouter._init);
}
LEAP.wfrouter.uiProcess = function(arg)
{
	try
	{
		var src = arg.e.srcElement;
		if (null == src)
			return;
		
		LEAP.wfrouter.getRouter(src);
		
		//console.log("router:" + LEAP.wfrouter.router);
		
	}
	catch(e){}
	finally
	{
	}
}

LEAP.wfrouter.getRouter = function(src)
{
	var instance = LEAP.wfrouter.getModuleInstance(src);
	if (instance == null)
	{
		LEAP.wfrouter.router = null;
	}
	else
	{
		var module = PageObjectModel.getModule(instance);
		if (module != null && module.leapclient != null && module.leapclient.router != null)
		{
			LEAP.wfrouter.router = module.leapclient.router;
		}
		else
		{
			LEAP.wfrouter.router = null;
		}
	}
	
	return LEAP.wfrouter.router;
}

LEAP.wfrouter.getServerURL = function(router)
{
	var serverUrl = null; 
	if(router != null && leapclient && leapclient.getServerURL)
	{
		serverUrl = leapclient.getServerURL(router);
	}
	
	if(!serverUrl && LEAP.wfrouter.router && leapclient && leapclient.getServerURL)
	{
		serverUrl = leapclient.getServerURL(LEAP.wfrouter.router);
	}
	
	if(!serverUrl)
	{
		serverUrl = leapconfig.server ;
	}
	
	return serverUrl;
}



LEAP.wfrouter.getModuleInstance = function(src)
{
	try
	{
		var p = src;
		while(true)
		{
			if (p ==  null){
				return null;
			}
			
			if (p.tagName == "BODY"){
                return null;
			}
		
			if (p.getAttribute("instance")){
				return p.getAttribute("instance");
			}
			
			p = p.parentNode;
		}
		
		return null;	
	}
	catch(e){
	}
	finally
	{
		p = null;
	}
}

		
LEAP.wfrouter.getSid = function()
{
	var sid = (window.createRouterClient != null) ? "LSID=":"JSESSIONID=";
	sid = sid + leapclient.getsid();
}

LEAP.wfrouter.getLid = function()
{
	var lid = LEAP.geturlpars().getvalue('lid');
	if (lid != null)
		return "&lid=" + lid;
	else
		return "";
}

LEAP.wfrouter.init();


LEAP.routerRequest = function(_methodName, _JSONObject)
{
	//console.log("==" + _methodName);
	return LEAP.request2({router:LEAP.wfrouter.router, name:_methodName, par: _JSONObject });
}

LEAP.routerRequest2 = function(def)
{
	//console.log("1==" + def.name);
	
	var leapclient = null;
	if (window.createRouterClient && LEAP.wfrouter.router != null)
	{
		leapclient = window.createRouterClient(router);
	}
	
	if (leapclient == null)
		leapclient = window.leapclient;
	
	return LEAP.request2(def,leapclient);
	
}







/**
 * 
 * @param {} arg
 	 {	
 	 	domain:				操作域	
 	 	url: 				地址，如：ws://localhost:8099 	 	
 	 	connectionTimeout:	连接超时(默认10)
 	 	callbackfn: 		回调方法(arg)
 	 }
 	 
 */
var _WSClient_ = function(param)
{
	this.url = param.url;
	//this.callbackFn = param.callbackFn;
	//this.domain = param.domain;
	
	this.connectionTimeout = (param.connectionTimeOut == null) ? 10 : param.connectionTimeOut ;
	
	this.wsc = null;
	
	this.send = function(txt, times, callbackFn, domain)
	{
		if (this.wsc.readyState == 1)
		{
			this.wsc.___callbackFn = callbackFn;
			this.wsc.___domain	= domain;
			this.wsc.send(txt);			
			
			if (this.wsc.___callbackFn)
				this.wsc.___callbackFn.apply(this.wsc.___domain, [{code:102, remark:"send"}])
		}
		else
		{
			if (times == null)
				times = 1;
				
			if (times < this.connectionTimeout)
			{
				times++;
				
				LEAP.asyn(this.send, this, 1, txt, times);
			}			
		}
	}
	
	this.close = function()
	{
		this.wsc.close();
	}
		
	this._onopen = function(evt)
	{		
		console.log("comb connected");
		
		if (this.___callbackFn)
			this.___callbackFn.apply(this.___domain, [{code:100, remark:"open"}]);
	}
	
	this._onmessage = function(evt)
	{	
		try
		{
			if (this.___callbackFn)
			{//如果有回调函数则使用回调函数
				this.___callbackFn.apply(this.___domain, [{code:101, remark:"message", txt:evt.data}]);
			}
			else
			{//否则尝试使用缓存回调
				LEAP.Comb.cache.callback(evt.data);
			}
		}
		catch(e)
		{
			if (e && e.message)
				console.log(e.message);
		}
	}
	
	this._onclose = function(evt)
	{
		if (this.___callbackFn)
			this.___callbackFn.apply(this.___domain, [{code:-101, remark:"close"}]);
	}
	
	this._onerror = function(evt)
	{
		if (this.___callbackFn)
			this.___callbackFn.apply(this.___domain, [{code:-102, remark:"error"}]);
	}
	
	this._open = function()
	{
		try
		{
			if ("WebSocket" in window)
			{
				this.wsc = new WebSocket(this.url);
				
				//this.wsc.___callbackFn = this.callbackFn;
				//this.wsc.___domain	= this.domain;
				
				this.wsc.onopen = this._onopen;				
				this.wsc.onmessage = this._onmessage;				  
				this.wsc.onclose = this._onclose;
				this.wsc.onerror = this._onerror;
	
			}
			else
			{
				alert("当前浏览器不支持 WebSocket!");
			}
		}
		catch(e){}
	}	
	this._open();
}





LEAP.Comb = {};
LEAP.Comb.WebSocketUrl = null;
LEAP.Comb.WebSocket = false;
LEAP.Comb.isDebug = false;
LEAP.Comb.ssid = (window.createRouterClient != null) ? "LSID=":"JSESSIONID=";
LEAP.Comb._init = function(debugPort)
{
	var port = LEAP.Comb._getCombPort();
	if (debugPort != null)
		port = debugPort;
		
	if (port != null)
	{
		if (leapconfig.server.startsWith("https"))		
			LEAP.Comb.WebSocketUrl = "wss://localhost:" + port;
		else
			LEAP.Comb.WebSocketUrl = "ws://localhost:" + port;
		
		LEAP.Comb._wsocket = new _WSClient_( {	url:			LEAP.Comb.WebSocketUrl,						        			 	
						         	 	 		connectionTimeout:	100
						         	 	 	});	
		
		LEAP.Comb.WebSocket = true;
	}
	else
	{
		LEAP.Comb.WebSocketUrl = null;
		LEAP.Comb.WebSocket = false;
	}
	
	LEAP.asyn(LEAP.Comb._update, LEAP.Comb, 500);
}
LEAP.Comb.hasUpdate = false;
LEAP.Comb._update = function()
{
	try
	{
		if (LEAP.Comb.hasUpdate == true)
			return;
		
		if (window.AutoUpdateActivex == 0)
			return;
			
		var v = ""; //"LStart.exe|1.0.4.0," ;
			v+= "LComb.exe|1.0.3.9," ;			
			v+= "LCAPTUDP.exe|1.0.3.9," ;
			v+= "LDSM.exe|1.0.3.6," ;
			v+= "LUPL.exe|1.0.3.6," ;
			v+= "LDocViewer.exe|1.0.3.5," ;
			v+= "LCAPT.ocx|1.0.3.4," ;
			v+= "LDoc.exe|1.0.3.5,";
			v+= "LNET.ocx|1.0.0.17";
			

		if (LEAP.Comb.WebSocket == false)
		{
			var a = "";
			try
			{
				a = LWFP.Activex.getCaptureActivex()._getVersion();
			}
			catch(e){}	
			
			if (a == "")
			{
				//插件没加载
			}
			else
			{
				/*if (a < "1.0.2.0")
				{
					LWFP.Activex.LCAPT = null;
					
					var _form = LEAP.form.create3({name:null, title:'提示', width:600, height:300, formtype:3});				
					if (_form != null)
					{
						var str = '<div style="height:100%; width:100%; text-align:center;">';
							str += '<div style="margin:20px 0px 50px 0px; font-size:18px; color:#FF0000;">系统插件已更新，请点击下面的链接下载最新的插件安装程序并安装 :</div>';
							str += '<a style="color:#0000FF; font-size:30px;" href="' + leapconfig.server + 'LEAP/LWFP/HTML/activex/ActivexSetup.exe">点击此处下载</a>';
							str += '</div>'
					
						LEAP.form.setContent(_form.form, str);
						LEAP.form.show(_form.form);
					}
				}
				else
				{
					LWFP.Activex.LCAPT._update(leapconfig.server + 'LEAP/LWFP/HTML/activex/', v);	
				}*/
				
				LWFP.Activex.LCAPT._update(leapconfig.server + 'LEAP/LWFP/HTML/activex/', v);	
			}			
		}
		else
		{
			try
			{
				LEAP.Comb._wsocket = new _WSClient_( {	url:LEAP.Comb.WebSocketUrl,	connectionTimeout:10 });
			}
			catch(e){}
			
			LEAP.asyn(function(){
									LEAP.Comb.sendCommand({cmd	:"update",
																url :leapconfig.server + 'LEAP/LWFP/HTML/activex/',
																files :v
															});
								 },  this, 1000);  
								
			
		}
		
		LEAP.Comb.hasUpdate = true;
	}
	finally
	{
		
	}
}

LEAP.Comb._getCombPort = function()
{
	var cookStr = new String(gcook());
	var _port = null ;
	if(cookStr != null && cookStr.indexOf('_cp=')>-1)
	{
		var _index = cookStr.indexOf('_cp=') ;
		var subStr = cookStr.substring(_index + 4);
		if(subStr.indexOf(";") > -1)
		{
			subStr = subStr.substring(0, subStr.indexOf(";"));
		}
		if(subStr)
		{
			_port = subStr ;
		}
	}
	window.__cp = _port ;
	return _port;
}

LEAP.Comb._wsocket = null;
LEAP.Comb.sendCommand = function(cmd, callbackFn, callbackDomain)
{	
	/*if (LEAP.Comb.hasUpdate == false && LEAP.Comb.isDebug == false)
	{
		LEAP.asyn(LEAP.Comb._update, LEAP.Comb, 50);
	}*/
		
	if (LEAP.Comb._wsocket == null || LEAP.Comb._wsocket.wsc == null || LEAP.Comb._wsocket.wsc.readyState != 1)
	{
		LEAP.Comb._wsocket = new _WSClient_( {	url:			LEAP.Comb.WebSocketUrl,						        			 	
						         	 	 		connectionTimeout:	100
						         	 	 	});		
	}
	
	LEAP.Comb._wsocket.send( JSON.stringify(cmd), null, callbackFn, callbackDomain);
}

LEAP.Comb._init();


LEAP.Comb.cache = {};
LEAP.Comb.cache._hash = new hashtable();
LEAP.Comb.cache.hashParam = function(cmdkey, def)
{
	LEAP.Comb.cache._hash.add(cmdkey, def);
}
LEAP.Comb.cache.getParam = function(cmdkey)
{
	return LEAP.Comb.cache._hash.getvalue(cmdkey);
}
LEAP.Comb.cache.removeParam = function(cmdkey)
{
	LEAP.Comb.cache._hash.remove(cmdkey);	
}
LEAP.Comb.cache.callback = function(resultTxt)
{
	try
	{		
		if (String.isEmpty(resultTxt))
			return;
		
		var obj = JSON.parse(resultTxt);
		if (obj.cmdkey)
		{
			var cache = LEAP.Comb.cache.getParam(obj.cmdkey);
			if (cache == null)
				return;
			
			
			if (cache.callback)
			{//回调通用回调函数
				cache.callback.apply(cache.domain, [{value:obj.value, result:obj.result, businessParam:cache.businessParam}]);
			}
			
			if (obj.value == 9)
			{//结果状态为9时表示exe关闭了，清除对应缓存
				LEAP.Comb.cache.removeParam(obj.cmdkey);
			}
		}
	}
	catch(e)
	{
		if (e && e.message)
			console.log(e.message);
		else
			console.log("exception: LEAP.Comb.cache.callback");
	}
	finally
	{
		obj = cache = null;
	}
}



LEAP.Comb.upload = {};
LEAP.Comb.upload.__tempPar = {};
/**
 * 上传本地指定文件
	def:{
			uploadurl:	上传路径，如：leapconfig.server + "LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=" + leapclient.getsid() + "&path=default&_proc_=0"
			filename: 	本地文件路径，如：d:\\a.text	
			callback: 	回调方法。 function(arg:{value:上传状态1正常2未知异常3网络故障, result:结果数据, param:回调参数})
			callbackParam: 回调参数
			domain:		回调方法作用域
			showMask: 	是否显示
 		}
 */
LEAP.Comb.upload.upload = function(def)
{
	try
	{		
		LEAP.Comb.upload.__tempPar.__domain = def.domain;
		LEAP.Comb.upload.__tempPar.__callback = def.callback;
		LEAP.Comb.upload.__tempPar.__callbackParam = def.callbackParam;

		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			if (LWFP.Activex.LCAPT.attachEvent)
			{
				LWFP.Activex.LCAPT.detachEvent("OnUploadFileComplete", LEAP.Comb.upload.__OnUploadComplete);
				LWFP.Activex.LCAPT.attachEvent("OnUploadFileComplete", LEAP.Comb.upload.__OnUploadComplete);
			}
			else
			{
				var handler = LEAP.getElement("script[ppppuploadeedsefpppp=1]");
				if (!handler)
				{
					handler = document.createElement("script");
					handler.setAttribute("for", LWFP.Activex.LCAPT.id);
					handler.setAttribute("ppppuploadeedsefpppp", 1);
					handler.event = "OnUploadFileComplete(value, result)";  
					handler.appendChild(document.createTextNode("LEAP.Comb.upload.__OnUploadComplete(value, result);"));			
					document.body.appendChild(handler);	
				}
			}
						
			if (def.uploadurl.indexOf("/WFUploadPdf") >0)
				LWFP.Activex.LCAPT._uploadfile(leapclient.getsid(), def.uploadurl, def.filename);
			else			
				LWFP.Activex.LCAPT._uploadfile(LEAP.Comb.ssid + leapclient.getsid(), def.uploadurl, def.filename);
		}
		else
		{
			LEAP.Comb.sendCommand({cmd:"uploadfile",
									session:LEAP.Comb.ssid + leapclient.getsid(),
									url:def.uploadurl,
									filename:def.filename},  LEAP.Comb.upload.__OnUploadComplete_, this);
		}
		
		if(def.showMask == true)
		{
			LEAP.showMask();
			LEAP.asyn(LEAP.hideMask, this, 5000);
		}
	}
	finally
	{
		handler = null;
	}
}

/**
 * 选择单个文件上传
 * def:{
			uploadurl:	上传路径，如：leapconfig.server + "LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=" + leapclient.getsid() + "&path=default&_proc_=0"
			filter: 	文件过滤器，如：所有文件|*.*|图片(*.jpg)|*.jpg;*.gif|文档(*.txt;*doc)|*.txt;*.doc
			callback: 	回调方法。 function(arg:{value:上传状态1正常2未知异常3网络故障, result:结果数据, param:回调参数})
			domain:		回调方法作用域
			showMask: 	是否显示
 		}
 */
LEAP.Comb.upload.singleUpload = function(def)
{
	try
	{	
		LEAP.Comb.upload.__tempPar.__domain = def.domain;
		LEAP.Comb.upload.__tempPar.__callback = def.callback;
		LEAP.Comb.upload.__tempPar.__callbackParam = def.callbackParam;
				
		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
					return;
			
			if (LWFP.Activex.LCAPT.attachEvent)
			{
				LWFP.Activex.LCAPT.detachEvent("OnUploadFileComplete", LEAP.Comb.upload.__OnUploadComplete);
				LWFP.Activex.LCAPT.attachEvent("OnUploadFileComplete", LEAP.Comb.upload.__OnUploadComplete);
			}
			else
			{
				handler = LEAP.getElement("script[ppppuploadeedsefpppp=1]");
				if (!handler)
				{
					handler = document.createElement("script");
					handler.setAttribute("for", LWFP.Activex.LCAPT.id);
					handler.setAttribute("ppppuploadeedsefpppp", 1);
					handler.event = "OnUploadFileComplete(value, result)";  
					handler.appendChild(document.createTextNode("LEAP.Comb.upload.__OnUploadComplete(value, result);"));			
					document.body.appendChild(handler);	
				}
			}
			
			LWFP.Activex.LCAPT._uploadfile2(LEAP.Comb.ssid + leapclient.getsid(), def.uploadurl, def.filter);
		}
		else
		{
			LEAP.Comb.sendCommand({cmd:"uploadfile2",
									session:LEAP.Comb.ssid + leapclient.getsid(),
									url:def.uploadurl,
									filter:(def.filter==null?"":def.filter)	},  LEAP.Comb.upload.__OnUploadComplete_, this);			
		}
		
		if(def.showMask == true)
		{
			LEAP.showMask();
			LEAP.asyn(LEAP.hideMask, this, 5000);
		}
	}
	finally
	{
		handler = null;
	}
}

/**
 * 选择多文件上传
 * def:{
			uploadurl:	上传路径，如：leapconfig.server + "LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=" + leapclient.getsid() + "&path=default&_proc_=0"
			filter: 	文件过滤器，如：所有文件|*.*|图片(*.jpg)|*.jpg;*.gif|文档(*.txt;*doc)|*.txt;*.doc
			callback: 	回调方法。 function(arg:{value:上传状态1正常2未知异常3网络故障, result:结果数据, param:回调参数})
			domain:		回调方法作用域
			showMask: 	是否显示
 		}
 */
LEAP.Comb.upload.batchUpload = function(def)
{
	try
	{	
		LEAP.Comb.upload.__tempPar.__domain = def.domain;
		LEAP.Comb.upload.__tempPar.__callback = def.callback;
		LEAP.Comb.upload.__tempPar.__callbackParam = def.callbackParam;
				
		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
					return;
			
			if (LWFP.Activex.LCAPT.attachEvent)
			{
				LWFP.Activex.LCAPT.detachEvent("OnUploadFileComplete", LEAP.Comb.upload.__OnUploadComplete);
				LWFP.Activex.LCAPT.attachEvent("OnUploadFileComplete", LEAP.Comb.upload.__OnUploadComplete);
			}
			else
			{
				var handler = LEAP.getElement("script[ppppuploadeedsefpppp=1]");
				if (!handler)
				{
					handler = document.createElement("script");
					handler.setAttribute("for", LWFP.Activex.LCAPT.id);
					handler.setAttribute("ppppuploadeedsefpppp", 1);
					handler.event = "OnUploadFileComplete(value, result)";  
					handler.appendChild(document.createTextNode("LEAP.Comb.upload.__OnUploadComplete(value, result);"));			
					document.body.appendChild(handler);	
				}
			}
			
			LWFP.Activex.LCAPT._uploadfile3(LEAP.Comb.ssid + leapclient.getsid(), def.uploadurl, def.filter);
		}
		else
		{
			LEAP.Comb.sendCommand({cmd:"uploadfile3",
									session: LEAP.Comb.ssid + leapclient.getsid(),
									url:def.uploadurl,
									filter:(def.filter==null?"":def.filter)	},  LEAP.Comb.upload.__OnUploadComplete_, this);			
		}
		
		if(def.showMask == true)
		{
			LEAP.showMask();
			LEAP.asyn(LEAP.hideMask, this, 5000);
		}		
	}
	finally
	{
		handler = null;
	}	
}

/**
 * 下载
 	urlArray 下载url数组 	
 */
LEAP.Comb.upload.download = function(urlArray)
{
	try
	{			
		if (urlArray == null || urlArray.length< 1 )
			return null;
		
		var urls = "";
		for(var i=0; i<urlArray.length; i++)
		{	
			var url = urlArray[i];
			//if (url.indexOf("?")>0)
			//	url = url.substr(0, url.indexOf("?"));
				
			if (urls != "")
				urls = urls + ";";
			
			urls = urls + url;
		}
		
		if (urls == "")
			return;
		
		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			
			LWFP.Activex.LCAPT._download(LEAP.Comb.ssid + leapclient.getsid(), urls);
		}
		else
		{
			LEAP.Comb.sendCommand({cmd:"download",
									sessionid: LEAP.Comb.ssid + leapclient.getsid(),
									urls: urls },  null, null);        
		}
	}
	finally
	{
		urls = i = url = null;
	}
}

LEAP.Comb.upload.downloadOpen = function(url)
{
	try
	{			
		if (url == "")
			return;
			
		if (url.indexOf("?")>0)
			url = url.substr(0, url.indexOf("?"));
		
		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			
			LWFP.Activex.LCAPT._downloadopen(LEAP.Comb.ssid + leapclient.getsid(), url);
		}
		else
		{
			LEAP.Comb.sendCommand({cmd:"downloadopen",
									sessionid: LEAP.Comb.ssid + leapclient.getsid(),
									urls: url },  null, null);        
		}
	}
	finally
	{
	
	}
}


/**
 * 预览文档
 	 def:{downloadUrl:下载命令url, 如：leapconfig.server + "LEAP/Download/"
 			atts:附件数组，[{id:"唯一标识",
					  		title:"显示标题",
							name:"文件名",
							namedpath:"命名空间",
							fixitemcode:"分组编号，相同分组的多个附件会显示在同一个目录下面"
							fixitemname:"分组名"		
							},...]
 			cache: 本地是否缓存（1缓存0不缓存） 
 			}
 */
LEAP.Comb.upload.previewDocument = function(def)
{
	try
	{		
		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			
			var str = JSON.stringify({atts:def.atts});
			
			LWFP.Activex.LCAPT._PreviewDocument(def.downloadUrl, str, LEAP.Comb.ssid + leapclient.getsid(), def.cache);
		}
		else
		{
			var str = JSON.stringify({atts:def.atts});
			LEAP.Comb.sendCommand({cmd:"PreviewDocument",
									sessionid: LEAP.Comb.ssid + leapclient.getsid(),
									serverurl: def.downloadUrl,
									atts:	str,	
									cache: def.cache },  null, null);
									
		}
	}
	finally
	{
		str = null;
	}

}

LEAP.Comb.upload.__OnUploadComplete = function(value, result)
{
	try
	{
		if (LEAP.Comb.upload.__tempPar.__domain && LEAP.Comb.upload.__tempPar.__callback)
		{			
			LEAP.Comb.upload.__tempPar.__callback.call(LEAP.Comb.upload.__tempPar.__domain, 
														{value:value, 
															result:result, 
															param:LEAP.Comb.upload.__tempPar.__callbackParam}	);
		}
	}
	finally
	{
		LEAP.Comb.upload.__tempPar.__domain = null;
		LEAP.Comb.upload.__tempPar.__callback = null;
		LEAP.Comb.upload.__tempPar.__callbackParam = null;

		LEAP.hideMask();
	}
}
LEAP.Comb.upload.__OnUploadComplete_ = function(arg)
{
	try
	{
		if (arg.code == 101)
		{
			var obj = JSON.parse(arg.txt);
			
			var rst = JSON.stringify(obj.result);
			if (obj != null && obj.result != null && obj.result instanceof Array)
				rst = rst.substring(1, rst.length -1);
			
			LEAP.Comb.upload.__OnUploadComplete(obj.value, rst);			
		}
	}
	finally
	{
		obj = null;
	}	
}


LEAP.Comb.printer = {};
LEAP.Comb.printer.__tempPar = {};
/**
 * 打印html
 	def:{
 			title	:打印界面标题
 			width	:
 			height	:
 			html 	:html文本,
 			jscode	: js方法，打印后执行， 声明必须如下：
 						var _printCallbackFunc = function(par){}
 						方法返回值须为字符串
 			jsparam	: js方法参数, 须为字符串
 			callback: 	回调方法。 function(arg:{result:js方法返回结果, param:js方法参数})
			domain:		回调方法作用域 	
 		}
 
 */
LEAP.Comb.printer.printHTML = function(def)
{	
	try
	{
		LEAP.Comb.printer.__tempPar.__domain = def.domain;
		LEAP.Comb.printer.__tempPar.__callback = def.callback;

		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			if (LWFP.Activex.LCAPT.attachEvent)
			{
				LWFP.Activex.LCAPT.detachEvent("OnHtmlPrint", LEAP.Comb.printer._onHtmlPrintCallback);
				LWFP.Activex.LCAPT.attachEvent("OnHtmlPrint", LEAP.Comb.printer._onHtmlPrintCallback);
			}
			else
			{
				var handler = LEAP.getElement("script[pp324fr32543g34fpppp=1]");
				if (!handler)
				{
					handler = document.createElement("script");
					handler.setAttribute("for", LWFP.Activex.LCAPT.id);
					handler.setAttribute("pp324fr32543g34fpppp", 1);
					handler.event = "OnHtmlPrint(result, param)";  
					handler.appendChild(document.createTextNode("LEAP.Comb.printer._onHtmlPrintCallback(result, param);"));			
					document.body.appendChild(handler);	
				}
			}			
		
			LWFP.Activex.LCAPT._printhtml(def.title, def.html + '$$::$$' + def.jscode + '$$::$$' + def.jsparam, def.width, def.height);			
		}
		else
		{
			LEAP.Comb.sendCommand( {cmd		:"printhtml",
									title	:def.title,
									pagewidth	:def.width, 
									pageheight	:def.height,
									html		:def.html + '$$::$$' + def.jscode + '$$::$$' + def.jsparam},  
									LEAP.Comb.printer._onHtmlPrintCallback_, this);
		}
	}
	finally
	{
		handler = null;
	}
}

LEAP.Comb.printer._onHtmlPrintCallback = function(result, param)
{
	try
	{
		if (LEAP.Comb.printer.__tempPar.__domain && LEAP.Comb.printer.__tempPar.__callback)
		{
			LEAP.Comb.printer.__tempPar.__callback.call(LEAP.Comb.printer.__tempPar.__domain, {param:param,	result:result}	);
		}
	}
	finally
	{
		LEAP.Comb.printer.__tempPar.__domain = null;
		LEAP.Comb.printer.__tempPar.__callback = null;
	}
}
LEAP.Comb.printer._onHtmlPrintCallback_ = function(arg)
{
	try
	{
		if (arg.code == 101)
		{
			var obj = json_parse(arg.txt);
			if (obj != null)
			{
				LEAP.Comb.printer._onHtmlPrintCallback(obj.result, 	obj.param);		
			}
		}
	}
	finally
	{
		obj = null;
	}	
}


LEAP.Comb.scanner = {};
LEAP.Comb.scanner.__tempPar = {};
/**
 * 拍照
 	def{
 			uploadurl	:上传路径，如：leapconfig.server + "LEAP/Service/RPC/RPC.DO?type=3&rt=o&sid=" + leapclient.getsid() + "&path=default";
 			attname		:材料名称
 			zoom		:缩小倍数 
			pagewidth	:取景宽度（像素） 
			pageheight	:取景高度（像素）
			pagestyle	:拍摄样式（0整页1上下分栏2连续多页）
			toplabel	:取景框上栏提示文本 
			bottomlabel	:取景框下栏提示文本
			topbtn		:第一步拍摄按钮名
			bottombtn	:第二步拍摄按钮名
			filetype	:多页拍摄文件类型(0-zip； 1-pdf（推荐）；整页和上下分栏时为jpeg)
 			
 			callback: 	回调方法。 function(arg:{value:上传状态1正常2未知异常3网络故障, result:结果数据, count:照片数量,  param:回调参数})
			callbackParam: 回调参数
			domain:		回调方法作用域
 	}
 	
 */
LEAP.Comb.scanner.snapshoot = function(def)
{
	try
	{		
		LEAP.Comb.scanner.__tempPar.__domain = def.domain;
		LEAP.Comb.scanner.__tempPar.__callback = def.callback;
		LEAP.Comb.scanner.__tempPar.__callbackParam = def.callbackParam;

		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
				
			if (LWFP.Activex.LCAPT.attachEvent)
			{
				LWFP.Activex.LCAPT.detachEvent("OnScanCompleted", LEAP.Comb.scanner._OnScanCompleted);
				LWFP.Activex.LCAPT.attachEvent("OnScanCompleted", LEAP.Comb.scanner._OnScanCompleted);
			}
			else
			{
				var handler = LEAP.getElement("script[fdsafdsafdsafds323fdsaf=1]");
				if (!handler)
				{
					handler = document.createElement("script");
					handler.setAttribute("for", LWFP.Activex.LCAPT.id);
					handler.setAttribute("fdsafdsafdsafds323fdsaf", 1);
					handler.event = "OnScanCompleted(value, result, filecount, filegroup)";  
					handler.appendChild(document.createTextNode("LEAP.Comb.scanner._OnScanCompleted(value, result, filecount, filegroup);"));			
					document.body.appendChild(handler);	
				}
			}

			LWFP.Activex.LCAPT.sessionid = LEAP.Comb.ssid + leapclient.getsid();
			LWFP.Activex.LCAPT.uploadurl = def.uploadurl;	
			LWFP.Activex.LCAPT._snapshoot(def.attname, 
											def.zoom == null?1:def.zoom, 
											def.pagewidth, 
											def.pageheight, 
											def.devno == null?1:def.devno, 
											def.pagestyle, 
											def.toplabel, 
											def.bottomlabel, 
											def.topbtn, 
											def.bottombtn==''?"$null$ " + (def.filetype==null?1:def.filetype) :def.bottombtn + " " + (def.filetype==null?1:def.filetype)
										);	

		}
		else
		{
			LEAP.Comb.sendCommand({cmd:"snapshoot",
									session	:LEAP.Comb.ssid + leapclient.getsid(),
									uploadurl		:def.uploadurl,
									attname			:def.attname,
									zoom			:def.zoom == null?1:def.zoom, 
        							pagewidth		:def.pagewidth, 
        							pageheight		:def.pageheight,
       								deviceno		:def.devno == null?1:def.devno, 
        							pagestyle		:def.pagestyle,
						        	toplabel		:def.toplabel, 
							        bottomlabel		:def.bottomlabel, 
						            topbutton		:def.topbtn, 
						            bottombutton	:def.bottombtn,
									filetype		: def.filetype==null? 1:def.filetype
								},  LEAP.Comb.scanner._OnScanCompleted_ , this);
		
		}
	}
	finally
	{
		handler = null;
	}
	
}

/**
 * 扫描
 * def{
 		uploadurl	:上传路径，如：leapconfig.server + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&sid=' + leapclient.getsid() + '&path=default'
 		title		:文件名，如：新扫描件.pdf
 		quality		:图片质量，100则不压缩
 		maxwidth	:图片尺寸最大宽度，0不缩放
 		maxheight	:图片尺寸最大高度，0不缩放		
 		exCapParam	:拍照参数，格式："缩小倍数&取景宽度&取景高度&设备号&拍摄样式&上栏名称&下栏名称&扫描&扫描下一张&文件类型"，如："1&0&0&2&2&&&扫描&扫描下一张&1";
 		groupParams	:图片分组名称，格式："分组代码1$分组名称1&分组代码2$分组名称2..."
 		
 		callback: 	回调方法。 function(arg:{value:上传状态1正常2未知异常3网络故障, result:结果数据, count:照片数量,  param:回调参数})
		callbackParam: 回调参数
		domain:		回调方法作用域
 	}
 
 */
LEAP.Comb.scanner.scanupload = function(def)
{
	try
	{		
		LEAP.Comb.scanner.__tempPar.__domain = def.domain;
		LEAP.Comb.scanner.__tempPar.__callback = def.callback;
		LEAP.Comb.scanner.__tempPar.__callbackParam = def.callbackParam;

		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			
			if (LWFP.Activex.LCAPT.attachEvent)
			{
				LWFP.Activex.LCAPT.detachEvent("OnScanCompleted", LEAP.Comb.scanner._OnScanCompleted);
				LWFP.Activex.LCAPT.attachEvent("OnScanCompleted", LEAP.Comb.scanner._OnScanCompleted);
			}
			else
			{
				var handler = LEAP.getElement("script[fdsafdsafdsafds323fdsaf=1]");
				if (!handler)
				{
					handler = document.createElement("script");
					handler.setAttribute("for", LWFP.Activex.LCAPT.id);
					handler.setAttribute("fdsafdsafdsafds323fdsaf", 1);
					handler.event = "OnScanCompleted(value, result, filecount, filegroup)";  
					handler.appendChild(document.createTextNode("LEAP.Comb.scanner._OnScanCompleted(value, result, filecount, filegroup);"));			
					document.body.appendChild(handler);	
				}
			}

			LWFP.Activex.LCAPT.sessionid = LEAP.Comb.ssid + leapclient.getsid();
			LWFP.Activex.LCAPT.uploadurl = def.uploadurl;			
			
			LWFP.Activex.LCAPT._scanupload2(def.quality, def.maxwidth, def.maxheight, def.title, def.uploadurl, def.exCapParam, def.groupParams);

		}
		else
		{
			LEAP.Comb.sendCommand({cmd			:"scanupload",
									session		:LEAP.Comb.ssid + leapclient.getsid(),
									uploadurl	:def.uploadurl,
									title		:def.title,
									level		:def.quality,
									width		:def.maxwidth,
									height		:def.maxheight,
									exparam		:def.exCapParam,
									groupparam	:def.groupParams									
								},  LEAP.Comb.scanner._OnScanCompleted_ , this);
		
		}
	}
	finally
	{
		handler = null;
	}

}

/**
 * 扫描编辑
 * def{
 		uploadurl	:上传路径，如：leapconfig.server + 'LEAP/Service/RPC/RPC.DO?type=3&unzip=1&rt=o&sid=' + leapclient.getsid() + '&path=default'
 		downloadUrl	:文件下载路径 		
 		filecount	:图片张数 		
 		readonly
 		title		:文件名，如：新扫描件.pdf
 		readonly	:是否只读，1是0否 		
 		quality		:图片质量，100则不压缩
 		maxwidth	:图片尺寸最大宽度，0不缩放
 		maxheight	:图片尺寸最大高度，0不缩放
 		exCapParam	:拍照参数，格式："缩小倍数&取景宽度&取景高度&设备号&拍摄样式&上栏名称&下栏名称&扫描&扫描下一张&文件类型"，如："1&0&0&2&2&&&扫描&扫描下一张&1";
 		callback: 	回调方法。 function(arg:{value:上传状态1正常2未知异常3网络故障, result:结果数据, count:照片数量,  param:回调参数})
		callbackParam: 回调参数
		domain:		回调方法作用域
 	}
 	
 */
LEAP.Comb.scanner.scanread = function(def)
{
	try
	{		
		LEAP.Comb.scanner.__tempPar.__domain = def.domain;
		LEAP.Comb.scanner.__tempPar.__callback = def.callback;
		LEAP.Comb.scanner.__tempPar.__callbackParam = def.callbackParam;

		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			
			if (LWFP.Activex.LCAPT.attachEvent)
			{
				LWFP.Activex.LCAPT.detachEvent("OnScanCompleted", LEAP.Comb.scanner._OnScanCompleted);
				LWFP.Activex.LCAPT.attachEvent("OnScanCompleted", LEAP.Comb.scanner._OnScanCompleted);
			}
			else
			{
				var handler = LEAP.getElement("script[fdsafdsafdsafds323fdsaf=1]");
				if (!handler)
				{
					handler = document.createElement("script");
					handler.setAttribute("for", LWFP.Activex.LCAPT.id);
					handler.setAttribute("fdsafdsafdsafds323fdsaf", 1);
					handler.event = "OnScanCompleted(value, result, filecount, filegroup)";  
					handler.appendChild(document.createTextNode("LEAP.Comb.scanner._OnScanCompleted(value, result, filecount, filegroup);"));			
					document.body.appendChild(handler);	
				}
			}

			LWFP.Activex.LCAPT.sessionid = LEAP.Comb.ssid + leapclient.getsid();
			LWFP.Activex.LCAPT.uploadurl = def.uploadurl;
			
			LWFP.Activex.LCAPT._scanread(def.quality, 
											def.maxwidth, 
											def.maxheight, 
											def.title.replaceall(" ",""), 
											def.readonly, 
											def.downloadUrl, 
											def.filecount, 
											def.uploadurl, 
											def.exCapParam);
		}
		else
		{
			LEAP.Comb.sendCommand({cmd			:"scanread",
									session		:LEAP.Comb.ssid + leapclient.getsid(),
									uploadurl	:def.uploadurl,
									title		:def.title.replaceall(" ",""), 
									level		:def.quality,
									readonly	:def.readonly,
									downloadurl	:def.downloadUrl,									
									width		:def.maxwidth,
									height		:def.maxheight,
									filecount	:def.filecount,									
									exparam		:def.exCapParam},  LEAP.Comb.scanner._OnScanCompleted_ , this);			
		}
	}
	finally
	{
		handler = null;
	}
	
}



LEAP.Comb.scanner._OnScanCompleted = function(value, result, count, filegroup)
{
	try
	{
		if (LEAP.Comb.scanner.__tempPar.__domain && LEAP.Comb.scanner.__tempPar.__callback)
		{
			LEAP.Comb.scanner.__tempPar.__callback.call(LEAP.Comb.scanner.__tempPar.__domain, 
															{value:value, 
																result:result, 
																count:count,
																filegroup:filegroup,
																param:LEAP.Comb.scanner.__tempPar.__callbackParam}	
													);
		}
	}
	finally
	{
		LEAP.Comb.scanner.__tempPar.__domain = null;
		LEAP.Comb.scanner.__tempPar.__callback = null;
		LEAP.Comb.scanner.__tempPar.__callbackParam = null;

		LEAP.hideMask();
	}
}

LEAP.Comb.scanner._OnScanCompleted_ = function(arg)
{
	try
	{
		if (arg.code == 101)
		{
			var obj = JSON.parse(arg.txt);			
			LEAP.Comb.scanner._OnScanCompleted(obj.value, JSON.stringify(obj.result), obj.count, obj.filegroup == null?null:JSON.stringify(obj.filegroup))
		}
	}
	finally
	{
		obj = null;
	}	
}






LEAP.Comb.office = {};
LEAP.Comb.office.iweboffice2015_Copyright = "金格科技iWebOffice2015智能文档中间件[演示版];V5.0S0xGAAEAAAAAAAAAEAAAAJ8BAACgAQAALAAAAON0a0XnoWy9199/PgGOF5bHSHgWwCmPIDXFpCaYPy/n+eYY4mp949JSoYm9Pis/EmcDDFIkrB02cRs3pkdz6jswKxa86guGnGbXcA2/k4LrrcLgpKk4up1JHNRnXFGpkI8rwMA1o+ZAsmdwGj6DFjGVDmUPUIEdJMqgXzNDxCls0MviLhzXoebbnt5R0/vPdqMk4zUJM4HtLm/bHmsLjaaKhBUnmcdTDXgjtJ8KpfLGROhfLXJlMOPUWwqm0JnaPYDDKLefel/CHfpzPQJnPm4xJlTwhrhN7oR32+IlHd8R8yCNFONvZKxKIGU710Ig0G4YKfd4eLmOz/RKZQmi42ANnT98pU3/GYu7shHI9uQU/MycJl39dILs6GQf+Mfm6q94VbXst1DWitZSIY7PogH3PWOJfG02TLovVpCvejFdijVylVWKl2cy2UN0oYzxpG1tsm+dMb0GMezZsBsncdNWS+yQC5WjBsvrtBpZfWS2I0ReW51flxKjkLXz5SwQhtyC2Sm3vz+KQfl0Um0Uv/OVS4lGtyw8QYBLYtzqCHIZbMNTJikFNTQxAWm5+J4yKA==";
/*LEAP.Comb.office.start = function(fileexts, times)
{
	try
	{		
		if (LEAP.Comb.WebSocket == false)
		{
			if (LWFP.Activex.getCaptureActivex() == null)
				return;
			
			LWFP.Activex.LCAPT._startoffice(fileexts, times);
		}
		else
		{
			LEAP.Comb.sendCommand({cmd:"startoffice",
									fileexts: fileexts,
									times: times },  null, null);        
		}
	}
	finally
	{

	}
}*/

/**
 * 打开文档
 * @param {} def{
					attachment:	附件对象,
					wfparam:	流程扩展参数（必须对象，属性可选）,
					callback: 	回调方法。 function(arg:{value:结果状态（9-exe关闭,8-exe转pdf）, result:结果数据,  param:回调参数})
					callbackParam: 回调参数
					domain:		回调方法作用域
  				}
 */
LEAP.Comb.office.openDocument = function(def)
{
	try
	{
		if (LEAP.Comb.WebSocket == false)
		{
			alert('native bridge未启动'); //是否以插件方式打开？
		}
		else
		{	
			var att = def.attachment;
			var wfparam = def.wfparam;
			var PDFOption = {buttons:"btnsave;btnsaveas;btnprint", commandbar:"MenuBar:0", commandButton:"File:1:0;File:2:0;File:3:0"};
			var OFICOption = {copyright:LEAP.Comb.office.iweboffice2015_Copyright, lock:LEAP.DocumentView.WordEditor.getUserConfig().lock};
					
			var readonly = false;
			if (att.canEdit == false)
				readonly = true			
			var wordbtns = "saveAs,print,showMark,hideMark,";
			if (readonly == false)
				wordbtns += "submit,";		
			if (att.atttype < 0) //正文才使用正文按钮
			{
				if (wfparam && wfparam.wordbuttons != "")
					wordbtns = wfparam.wordbuttons;
			}
			OFICOption.wordbuttons = wordbtns;
			OFICOption.bookmarks = wfparam.bookmarks;			
			OFICOption.templates = wfparam.templates;
			
			var remark = att.title; 
			if (remark.length > 50)
				remark = remark.substring(0, 50) + "...";
			remark = remark + att.name.substring(att.name.lastIndexOf("."));
			remark = encodeURIComponent(encodeURIComponent(remark));
				
			var downloadurl = LEAP.wfrouter.getServerURL(((def.domain && def.domain.leapclient) ? def.domain.leapclient.router:null)) + "LEAP/Download/" + att.namedpath + '/' + att.name + '?sid=' + leapclient.getsid() + '&wflog=1&terminal=0&id=' + att.id + '&remark=' + remark;
			var pdfSaveurl = LEAP.wfrouter.getServerURL(((def.domain && def.domain.leapclient) ? def.domain.leapclient.router:null)) + 'logic/JGSavePdf?namedpath=' + encodeURIComponent(att.namedpath) + '&physicfilename=' + att.name;
			var OFICSaveurl = LEAP.wfrouter.getServerURL(((def.domain && def.domain.leapclient) ? def.domain.leapclient.router:null)) + 'logic/WFOffice_save2?option=SAVEFILE&' + 'namedpath=' + encodeURIComponent(att.namedpath) + '&name=' + att.name;
			var OFICSaveToPdfUrl = LEAP.wfrouter.getServerURL(((def.domain && def.domain.leapclient) ? def.domain.leapclient.router:null)) + "logic/WFUploadPdf?uploadpath=" + encodeURIComponent(def.uploadpath) + "&viewname=" + encodeURIComponent(encodeURIComponent(att.title + '.pdf'));
						
			if (att.id)
			{
				pdfSaveurl += '&attid=' + att.id;
				OFICSaveurl += '&attid=' + att.id;
			}
			if 	(att.entryid)
			{
				pdfSaveurl += '&attentryid=' + att.entryid;
				OFICSaveurl += '&attentryid=' + att.entryid;
			}
			if (wfparam.businessid)	
			{
				pdfSaveurl += '&attbusinessid=' + wfparam.businessid;	
				OFICSaveurl += '&attbusinessid=' + wfparam.businessid;
			}
			if (wfparam.currentstepHSID)	
			{
				pdfSaveurl += '&attcategory=' + wfparam.currentstepHSID;	
				OFICSaveurl += '&attcategory=' + wfparam.currentstepHSID;	
			}
						
			PDFOption.saveurl = pdfSaveurl;
			OFICOption.saveurl = OFICSaveurl; 
			OFICOption.saveToPdfUrl = OFICSaveToPdfUrl;
						
			var cmdkey = def.cmdkey;
			if (!cmdkey)
				cmdkey = UUID.randomUUID().replaceall('-', '');
						
			LEAP.Comb.sendCommand({cmd:"openDocument",
									cmdkey:cmdkey,
									sessionid: 	LEAP.Comb.ssid + leapclient.getsid(),
									username:	LEAP.getUserInfo().userflag,
									downloadurl:	downloadurl,
									downloadSvr: LEAP.wfrouter.getServerURL(((def.domain && def.domain.leapclient) ? def.domain.leapclient.router:null)) + "LEAP/Download/",
									attachment:	att, 
									PDFOption:	PDFOption,
									OFICOption: OFICOption
						}, null, null);
						
			LEAP.Comb.cache.hashParam(cmdkey, { callback:LEAP.Comb.office._callback,
												domain:this,								
												businessParam:{callback:def.callback, callbackParam:def.callbackParam, domain:def.domain}
												} );
		}
	}
	finally
	{
		att = wfparam = PDFOption = OFICOption = readonly = wordbtns = downloadurl = saveurl = cmdkey = null;
	}
}

/**
 * @param {} arg :{value:结果状态, result:结果数据, businessParam:业务回调参数{domain,callback,callbackParam} }
 */
LEAP.Comb.office._callback = function(arg)
{
	try
	{
		if (!arg.businessParam || !arg.businessParam.callback)
			return;
		
		arg.businessParam.callback.apply(arg.businessParam.domain, 	[{value:arg.value, 
																		result:arg.result, 
																		callbackParam:arg.businessParam.callbackParam}]  );				
	}
	catch(e)
	{
		if (e && e.message)
			console.log(e.message);
		else
			console.log("exception: LEAP.Comb.office._callback" );
	}


}








/**
 * 组织用户选择器
 * @class organSelector control
 * @type user control
 * @example
HTML定义:
<DIV class=button_frame style="FLOAT: left">
	<A class=button href="javascript:void(0)">
		<P>
		</ P>
		<SPAN class="" ut="controlName" ct="organselector" ctf="lwfpaction" _type="2" _levels="3" _single="1" _style="1" _title="标题">organselector</SPAN>				
	</A>
</DIV>

JS定义:

获取: 
	根据自定义标签获取:var selector = this.getUT('controlName');
	

方法：
	1、设置选择范围
		LEAP.organSelector.setRange(element：organSelector插件, organid：机构ID，多机构之间以分号分隔, rolename：角色名，多角色名间以分号分隔, toporg:范围是否限制为toporg )
		示例：LEAP.organSelector.setRange(this.getUT('controlName'), "研发部ID;市场部ID", "项目经理;工程师");
		
	2、获取选择结果清单
		LEAP.organSelector.getValue = function(element: organSelector插件)
		示例：LEAP.organSelector.getValue( this.getUT('controlName') );
		
	3、显示查看器（支持多标签页）
		LEAP.organSelector.show = function(element:插件element, datas:数据)
			datas参数说明：标签页数据清单数组，如 [标签1数据, 标签2数据...]
		 	标签页数据说明:
							{	tabName 	:标签名称, 
				 				isDefault	:是否默认（true|false）, 如果为true则该标签页的树显示插件定义的组织机构树，否则显示用户自行定义的树数据 
				 				data 		:树数据, 如果isDefault=true则无效
				 				fn			:获取数据方法,data=null时生效
				 				fndomain	:获取数据方法作用域 
	 							singlecheck :是否单选（true|false）默认false,
	 							onlytipcheck:是否只能选叶子节点,即出不出复选框（true|false）默认false 
	 							onlytipcheck2:是否只能选中叶子节点，即能否选到已选列表，仅(singlecheck=false && autoCheckChild=true)时有效
	 							style		:树样式（0完全展开、1部分展开）,默认1
	 							pvalue		:树数据的值属性名, 
	 							ptext		:树数据的显示属性名, 
	 							psyscode	:树数据的syscode属性名, 
	 							psysorder	:树数据的排序属性名,
	 							phaschild	:树数据的是否有子节点属性名,
	 							pistip      :树数据的是否叶子节点属性名,		 
	 							icon		:默认图标,
	 							autoCheckChild:是否自动选择子节点,默认true	 							
	 							}
	 							
	 	示例：
	 		var ret = this.request("studio_getStudioAllResource",{ParentID:"studioindex"})
			var nodes = LEAP.convertResult(ret);			
			var datas = [{tabName:'标签名称', isDefault:true},
						 {tabName:'标签名称2', data:nodes, singlecheck:false, pvalue:'id', ptext:'text', psyscode:'syscode', phaschild:'haschild'}];		
			LEAP.organSelector.show(this.getUT("controlName"), datas);
			

	4、设置只读属性
		LEAP.organSelector.setReadOnly = function(element:organSelector插件, _bool:boolean 是否只读)
		
	5、注册扩展按钮
		LEAP.organSelector.registExtendButton(element:organSelector插件, [{name:'按钮名1', title:'标题1', width:宽度1, icon:图标1}, {name:'按钮名2', title:'标题2', width:宽度2, icon:图标2}]  );	
		
事件:
	1、值变更事件
		事件注册:
			this.addEvent(element,'valueChange',valueChange); 	
		事件体：
			function valueChange(e)
			{
				alert(e.arg2.value); //e.arg2.value为新选择的组织机构清单
			}
	2、扩展按钮点击事件
		事件注册:
			this.addEvent(element, 'onExtendButtonClick', exBtnClick);
		事件体：
			function exBtnClick(arg)
			{
				alert(arg.arg2.name); //alert 按钮名称
			}

标签:
	ctf：如果插件用于为工作流选择下环节执行用户，则须设为 ctf="lwfpaction"
	_actionName 动作名，标识为某个动作选择下环节执行用户，需要ctf="lwfpaction"标签，
				如果设置了ctf="lwfpaction"，但是未设置_actionName,则对所有没有对应用户选择器的动作有效
	_type：用户类型（0机构、1岗位、2用户、3机构人混选）,默认0 
	_levels：组织机构树层数，默认为3 
	_single：是否单选（0多选、1单选）,默认1 
	_style: 组织机构树样式（0完全展开、1部分展开）,默认1
	_maxlevel: 组织机构树搜索深度，顶级为0，如果不设置该属性则没有限制
	_toporg: 范围是否限制为顶点机构(true,false),默认true
	_title: 选择器窗口标题
	_lazy: 是否延迟加载子节点
	_includeOrganRange 是否包括范围机构节点（混选和机构类型有效） boolean 默认true
	_excludenonorg 是否排除非机构节点 boolean 默认false
	_autoCheckChilds 多选时是否自动选中子节点，默认true
	_mutiLevelCheck 多选时是否允许跨级选择，默认true
	_singleUnderToporg2
	_allowSearch 是否允许搜索用户, 默认false
 */


LEAP.organSelector = {};
LEAP.organSelector.d = 'organselector';
LEAP.organSelector.Form = null;
LEAP.organSelector.FormWidth = window.screen.deviceXDPI*21/2.54 + 30;
LEAP.organSelector.FormHeight = 500;
LEAP.organSelector.init = function()
{
	if (document != null && document.body != null)
		LEAP.organSelector._init();
	else UIEventManager.addEvent(window, 'load', LEAP.organSelector._init);
	ElementEventManager.addManagedEventType(LEAP.organSelector.d, 'valueChange');
	ElementEventManager.addManagedEventType(LEAP.organSelector.d, 'onExtendButtonClick');
	
}

LEAP.organSelector._init = function()
{	
	LEAP.addEvent(document.body, 'click', LEAP.organSelector.uiProcess, null, null, true);
	UIEventManager.removeEvent(window, 'load', LEAP.organSelector._init);		
}

LEAP.organSelector.uiProcess = function(arg)
{
	var src = null;
	var element = null;	
	var type = null;

	try
	{
		src = arg.e.srcElement;
		if(null == src) return;
		type = arg.e.type;
		if(null == type) return;
		element = LEAP._match(src, LEAP.organSelector.d);
		if(null == element) return;
		
		if (element.getAttribute("_readonly") != null && element.getAttribute("_readonly") == 'true')
			return;
		if (element.getAttribute("readonly") != null && element.getAttribute("readonly") == '1')
			return;
		
		if (element.getAttribute("vritualPlumbGroup"))
		{
			LEAP.organSelector.showVirtualPlumbOrganTree(element, element.getAttribute("vritualPlumbGroup"));	
			return;
		}
			
		var par = LEAP.organSelector.getAttribute(element);
		
		if (LEAP.organSelector.Form != null)
		{
			if (LEAP.organSelector.Form.module != null)
			{
				if (LEAP.organSelector.Form.module.unRegEvent)
				{
					LEAP.organSelector.Form.module.unRegEvent('onSubmit', null);
					LEAP.organSelector.Form.module.unRegEvent('onExbuttonClick', null);					
				}
				if (LEAP.organSelector.Form.module.dispose)
					LEAP.organSelector.Form.module.dispose();
				LEAP.organSelector.Form.module = null;
			}
			LEAP.organSelector.Form = null;	
		}

		//LEAP.organSelector.Form = LEAP.form.create("LWFP.OrganSelectPage", par.title, LEAP.organSelector.FormWidth, LEAP.organSelector.FormHeight);
		var module = PageObjectModel.getModule(element.getAttribute("instance"));
		LEAP.organSelector.Form = LEAP.form.create3({name:"LWFP.OrganSelectPage", title:par.title, width:LEAP.organSelector.FormWidth, height:LEAP.organSelector.FormHeight, formtype:module._formtype});
		if (LEAP.organSelector.Form != null)
		{
			var v = LEAP.organSelector._getValue(element, true);
			if (v == "") v = null;
			var v2 = LEAP.organSelector._getValue2(element);
			if (v2 == "") v2 = null;			
			//if (LEAP.organSelector.Form.module.init(_type, _levels, _single, _style, _maxlevel, _range, _includeOrganRange,  _excludenonorg,null, v, v2, _lazy, element) == true)			
			var exBtns = null;
			if (element.getAttribute('_extendButtons'))
				exBtns = element.getAttribute('_extendButtons');
			
			if (LEAP.organSelector.Form.module.init2([{tabIdx:0, tabName:'组织人员', isDefault:true, data:par}], v, v2, exBtns, element) == true)
			{		
				if (element.getAttribute("returnWithParent"))
					LEAP.organSelector.Form.module.returnWithParent = true;
					
				LEAP.organSelector.Form.module.regEvent('onSubmit', LEAP.organSelector.callback, this);
				LEAP.organSelector.Form.module.regEvent('onExbuttonClick', LEAP.organSelector.__ExbuttonClick, this);
			}
		}
	}
	finally
	{
		par = src = element = type = v = v2 = exBtns = module = null;		
	}
}

LEAP.organSelector.getAttribute = function(element)
{
	var _type = 0;
	var _levels = 3;
	var _single = 1;
	var _style = 1;
	var _maxlevel = null;
	var _range = null;
	var _toporg = true;
	var _title = "选择组织机构人员";
	var _lazy = true;
	var _includeOrganRange = true;
	var _excludenonorg = false
	var _autoCheckChilds = true;
	var _mutiLevelCheck = true;
	var _singleUnderToporg2 = false;
	var _allowSearch = false;
	
	try
	{
		if (element.getAttribute("_type") != null)
			_type = element.getAttribute("_type");
		if (element.getAttribute("_levels") != null)
			_levels = element.getAttribute("_levels");
		if (element.getAttribute("_single") != null)
			_single = element.getAttribute("_single");
		if (element.getAttribute("_style") != null)
			_style = element.getAttribute("_style");
		if (element.getAttribute("_maxlevel") != null)
			_maxlevel = element.getAttribute("_maxlevel");
		if (element.getAttribute("_title") != null)
			_title = element.getAttribute("_title");
		if (element['_range'] != null)
			_range = element['_range'];
		if (element.getAttribute("_toporg") != null)
			_toporg = element.getAttribute("_toporg");
		if (element.getAttribute("_lazy") != null)
		{
			_lazy = element.getAttribute("_lazy");		
			if (_lazy.toLowerCase() == "false")
				_lazy = false;
		}
		if (element.getAttribute("_includeOrganRange") != null)
		{
			_includeOrganRange = element.getAttribute("_includeOrganRange");		
			if (_includeOrganRange.toLowerCase() == "false")
				_includeOrganRange = false;
		}
		if (element.getAttribute("_excludenonorg") != null)
		{
			_excludenonorg = element.getAttribute("_excludenonorg");		
			if (_excludenonorg.toLowerCase() == "true")
				_excludenonorg = true;
		}
		
		if (element.getAttribute("_autoCheckChilds") != null)
		{
			_autoCheckChilds = element.getAttribute("_autoCheckChilds");		
			if (_autoCheckChilds.toLowerCase() == "false")
				_autoCheckChilds = false;
			else
				_autoCheckChilds = true;
		}
		
		if (element.getAttribute("_mutiLevelCheck") != null)
		{
			_mutiLevelCheck = element.getAttribute("_mutiLevelCheck");		
			if (_mutiLevelCheck.toLowerCase() == "false")
				_mutiLevelCheck = false;
			else
				_mutiLevelCheck = true;
		}
		
		if (element.getAttribute("_singleUnderToporg2") != null)
		{
			_singleUnderToporg2 = element.getAttribute("_singleUnderToporg2");		
			if (_singleUnderToporg2.toLowerCase() == "true")
				_singleUnderToporg2 = true;
			else
				_singleUnderToporg2 = false;
		}
		if (element.getAttribute("_allowSearch") != null)
		{
			if (element.getAttribute("_allowSearch").toLowerCase() == "true")
				_allowSearch = true;
		}
			
		if (_range == null)
			_range = {organid:null,rolename:null,toporg:_toporg};
		_range.toporg = _toporg;
		
		return {type:_type, levels:_levels, single:_single,
					style:_style, maxlevel:_maxlevel, range:_range, toporg:_toporg,
					title:_title, lazy:_lazy, includeOrganRange:_includeOrganRange,
					excludenonorg:_excludenonorg, autoCheckChilds:_autoCheckChilds,
					mutiLevelCheck:_mutiLevelCheck,singleUnderToporg2:_singleUnderToporg2,
					allowSearch:_allowSearch};
	}
	finally
	{
		_type = _levels = _single = _style = _maxlevel = _range = _toporg = _title = _lazy = _includeOrganRange = _excludenonorg = _mutiLevelCheck = _autoCheckChilds = null;	
	}	
}

/**
 * 
 * @param {} element
 * @param {} datas [{tabName:标签名称, 
 * 					isDefault:是否默认, 
 * 					data:数据, 
 * 					singlecheck:是否单选（true|false）默认false, 
 * 					pvalue:值属性名, 
 * 					ptext:显示属性名, 
 * 					psyscode:syscode属性名, 
 * 					psysorder:排序属性名, 
 * 					phaschild:是否有子节点属性名, 
 * 					icon:默认图标}...]
 */
LEAP.organSelector.show = function(element, datas)
{
	try
	{
		if (datas == null || datas.length ==0)
		{
			datas = [{tabIdx:0, tabName:'组织人员', isDefault:true}];
		}
			
		element = LEAP._check(element, LEAP.organSelector.d);
		if (null == element) return;
						
		var par = LEAP.organSelector.getAttribute(element);
		
		if (LEAP.organSelector.Form != null)
		{		
			if (LEAP.organSelector.Form.module != null)
			{
				if (LEAP.organSelector.Form.module.unRegEvent)
				{
					LEAP.organSelector.Form.module.unRegEvent('onSubmit', null);
					LEAP.organSelector.Form.module.unRegEvent('onExbuttonClick', null);	
				}
				if (LEAP.organSelector.Form.module.dispose)
					LEAP.organSelector.Form.module.dispose();
				LEAP.organSelector.Form.module = null;
			}
			LEAP.organSelector.Form = null;
		}
		
		//LEAP.organSelector.Form = PageObjectModel.getObjectByInstance(element.getAttribute("instance")).loadForm("LWFP.OrganSelectPage", par.title, LEAP.organSelector.FormWidth, LEAP.organSelector.FormHeight);
		var module = PageObjectModel.getModule(element.getAttribute("instance"));
		LEAP.organSelector.Form = module.loadForm3({name:"LWFP.OrganSelectPage", title:par.title, width:LEAP.organSelector.FormWidth, height:LEAP.organSelector.FormHeight, formtype:module._formtype});

		if (LEAP.organSelector.Form != null)
		{
			var v = LEAP.organSelector._getValue(element, true);
			if (v == "") v = null;
			var v2 = LEAP.organSelector._getValue2(element);
			if (v2 == "") v2 = null;
			
			var _datas = new Array();
			for(var i=0; i<datas.length; i++)
			{
				var d = datas[i];
				if (d.isDefault == true)
					d.data = par;
				
				d.singlecheck = (d.singlecheck != null && d.singlecheck == true)? true : false; //是否单选，默认false
				d.onlytipcheck = (d.onlytipcheck != null && d.onlytipcheck == true)? true : false; //是否只能选叶子，默认false
				d.style = (d.style != null)? d.style : 1;
				_datas.add(d);
			}
			
			var exBtns = null;
			if (element.getAttribute('_extendButtons'))
				exBtns = element.getAttribute('_extendButtons');
			
			//if (LEAP.organSelector.Form.module.init2([{tabIdx:0, tabName:'组织人员', isDefault:true, data:par}], v, v2, element) == true)
			if (LEAP.organSelector.Form.module.init2(_datas, v, v2, exBtns, element) == true)
			{
				if (element.getAttribute("returnWithParent"))
					LEAP.organSelector.Form.module.returnWithParent = true;
				LEAP.organSelector.Form.module.regEvent('onSubmit', LEAP.organSelector.callback, this);
				LEAP.organSelector.Form.module.regEvent('onExbuttonClick', LEAP.organSelector.__ExbuttonClick, this);
			}
		}
	}
	finally
	{
		par = module = v = v2 = _datas = i = d = exBtns = null;
	}	
}

LEAP.organSelector.showVirtualPlumbOrganTree = function(element, groupName)
{
	try
	{
		var data = LEAP.request("WfGetVirtualPlumbOrganTree", {name:groupName});
			data = {tabName 		:"职能机构",		//"标签名称",
	 				isDefault		:false,			//false是否默认（true|false）, 如果为true则该标签页的树显示插件定义的组织机构树，否则显示用户自行定义的树数据 
	 				singlecheck 	:true,			//是否单选（true|false）默认false,
					onlytipcheck	:true,			//是否只能选叶子节点（true|false）默认false 
					style			:1,				//树样式（0完全展开、1部分展开）,默认1
					autoCheckChild	:false,			//是否自动选择子节点,默认true
					data 			:data, 			//树数据, 如果isDefault=true则无效
					pvalue			:"id",			//树数据的值属性名, 
					ptext			:"virtualname",		//树数据的显示属性名, 
					psyscode		:"syscode",		//树数据的syscode属性名, 
					psysorder		:"orderid",		//树数据的排序属性名,
					phaschild		:"haschild",	//树数据的是否有子节点属性名,
					pistip      	:"istip"		//树数据的是否叶子节点属性名,
	 			};
	 	
	 	if (element.getAttribute("vritualPlumbGroup_singlecheck") && element.getAttribute("vritualPlumbGroup_singlecheck")=="false")
	 		data.singlecheck = false;
	 	if (element.getAttribute("vritualPlumbGroup_tabname"))
	 		data.tabName = element.getAttribute("vritualPlumbGroup_tabname");
		
		LEAP.organSelector.show(element, [data]);
	}
	finally
	{
		data = null;
	}
}

LEAP.organSelector.setRange = function(element, organid, rolename, toporg)
{
	try
	{
		element = LEAP._check(element, LEAP.organSelector.d);
		if (null == element)return;		
		element['_range'] = {organid:organid,rolename:rolename};
		if (toporg != null)
			element.setAttribute("_toporg", toporg);
	}
	finally
	{
		element = null;
	}
}

LEAP.organSelector.setReadOnly = function(element, _bool)
{
	try
	{
		element = LEAP._check(element, LEAP.organSelector.d);
		if (null == element)return;
		if (_bool == true)
			element.setAttribute("_readonly", 'true');
		else if (_bool == false)
			element.setAttribute("_readonly", 'false');
	}
	finally
	{
		element = null;
	}	
}

LEAP.organSelector.setType = function(element, type)
{
	try
	{
		element = LEAP._check(element, LEAP.organSelector.d);
		if (null == element)return;
		element.setAttribute("_type", type);
	}
	finally
	{
		element = null;
	}
}

LEAP.organSelector.getValue = function(element)
{
	element = LEAP._check(element, LEAP.organSelector.d);
	if (null == element)return null;
	return element['_value'];
}

LEAP.organSelector.setValue = function(element, value)
{
	LEAP.organSelector._setValue(element, value);
}

LEAP.organSelector.callback = function(arg)
{	
	if (arg.selectedNodes != null && arg.selectedNodes.length>0)
	{
		arg.caller['_value'] = arg.selectedNodes;
			
		LEAP.organSelector._setValue(arg.caller, arg._selectedNodes);
	}
	else
	{
		arg.caller['_value'] = null;
		LEAP.organSelector._setValue(arg.caller, null);
	}
	
	ElementEventManager.handleEvent(arg.caller, "valueChange", {value:arg.selectedNodes})
	
	if (arg.caller.getAttribute('transtct')	!= null && LEAP.trans != null && LEAP.trans.__organSelectorCallBack != null)
		LEAP.trans.__organSelectorCallBack({caller:arg.caller, value:arg.selectedNodes});
}

LEAP.organSelector.hideForm = function()
{
	if (LEAP.organSelector.Form != null && LEAP.organSelector.Form.module != null && LEAP.organSelector.Form.module.hideForm)
		LEAP.organSelector.Form.module.hideForm();
}

LEAP.organSelector._getValue = function(element, tojson)
{
	try
	{
		element = LEAP._check(element, LEAP.organSelector.d);
		if (null == element)
			return null;
			
		var v = element['__value'];
		if (v == "")
		{
			return null;
		}
		else
		{
			if (tojson != null && tojson == true)
				return v;
			else
				return JSON.stringify(v);
		}
	}
	finally
	{
		v = null;
	}	
}

LEAP.organSelector._setValue = function(element, value)
{
	element = LEAP._check(element, LEAP.organSelector.d);
	if (null == element)
		return;
	
	if (value == null)
	{
		element['__value'] = "";
	}
	else
	{
		if (typeof(value) == "string")
			element['__value'] = JSON.parse(value);
		else
			element['__value'] = value;
	}
}

LEAP.organSelector._getValue2 = function(element)
{
	try
	{
		element = LEAP._check(element, LEAP.organSelector.d);
		if (null == element)
			return null;
			
		var v = element['__value2'];
		if (v == "")
			return null;
		else
			return v;
	}
	finally
	{
		v = null;
	}	
}

LEAP.organSelector.setValue2 = function(element, value)
{
	element = LEAP._check(element, LEAP.organSelector.d);
	if (null == element)
		return;

	if (value == null)
		element['__value2'] = "";
	else
		element['__value2'] = value;
}




LEAP.organSelector.clearValue = function(element)
{
	element = LEAP._check(element, LEAP.organSelector.d);
	if (null == element)
		return;
	
	element['__value'] = "";
	element['__value2'] = "";
}

LEAP.organSelector.getActionSelector = function(actionName, instance, element)
{	
	try
	{
		var selector = LEAP.getElement("[ct=organselector][ctf=lwfpaction][_actionName=" + actionName + "][instance=" + instance + "]", element);
		if (selector != null)
		{
			return selector;
		}
		else
		{
			var arr = LEAP.getElements("[ct=organselector][ctf=lwfpaction][instance=" + instance + "]", element);
			if (arr != null)
			{
				for(var i=0; i<arr.length; i++)
				{					
					if ( arr[i].getAttribute("_actionName") == null || arr[i].getAttribute("_actionName") == "")
						return arr[i];
				}
			}
		}
	}
	finally
	{
		selector = arr = i = null;
	}
	
}

LEAP.organSelector.registExtendButton = function(element, buttonNames)
{
	element = LEAP._check(element, LEAP.organSelector.d);
	if (null == element)
		return;
	
	element.setAttribute('_extendButtons', buttonNames);	
}
LEAP.organSelector.__ExbuttonClick = function(arg)
{
	ElementEventManager.handleEvent(arg.caller, "onExtendButtonClick", {name:arg.name});
}

LEAP.organSelector.init();









var MessengerClient = {};
MessengerClient.tag = {login:1, connect:2};
MessengerClient.server = null;
MessengerClient.callbackDomain = null;
MessengerClient.callbacks_MesssageArrived = [];
MessengerClient.callback_afterLogin = null;
MessengerClient.callback_onDisconnected = null;
MessengerClient.state = 0;
MessengerClient.state_reconnect = 0;


MessengerClient._channel = null;

MessengerClient.prepare = function(server, callbacks, domain)
{
	this.server = server;
	this.callback_afterLogin = callbacks.afterLogin;
	this.callback_onDisconnected = callbacks.onDisconnected;
	this.callbackDomain = domain;
	
	MessengerClient.callbacks_MesssageArrived = [];
	if (callbacks.onMessageArrived)
		MessengerClient.callbacks_MesssageArrived.push({domain:domain, fn:callbacks.onMessageArrived});
}

MessengerClient.registMesssageArrivedCallback = function(domain, fn)
{
	if (domain && fn)
		MessengerClient.callbacks_MesssageArrived.push({domain:domain, fn:fn});
}

MessengerClient.login = function(username, pwd, exBean)
{
	try
	{
		var url = this.server + "restservices/messenger/Messenger_sign_frombrowser/query?";
		url += this.___parUrlParam( [{k:"userflag", v:username}, {k:"password", v:pwd}, {k:"exdata", v:exBean}] );
		
		this.__request(url, MessengerClient.tag.login);
	}
	finally
	{
		url = null;
	}
}

MessengerClient.connect = function()
{
	try
	{
		MessengerClient.state_reconnect = 0;
		
		var url = this.server + "restservices/messenger/Messenger_connect/query?";
		url += this.___parUrlParam( [{k:"cname", v:this._channel.cname}, 
									{k:"token", v:this._channel.token}, 
									{k:"sid", v:this._channel.sid}] );
		
		this.__request(url, MessengerClient.tag.connect);
	}
	finally
	{
		url = null;
	}    
}

MessengerClient.disconnect = function()
{
	MessengerClient.state_reconnect = -1;
}


MessengerClient.___parUrlParam = function(pars)
{
	try
	{
		var str = "";
		for(var i=0; i<pars.length; i++)
		{
			var par = pars[i];
			if (str != "")
				str += "&";
			
			str += par.k + "=";		
			if (typeof(par.v) != "string")
				str += encodeURIComponent(JSON.stringify(par.v));
			else
				str += encodeURIComponent(par.v);
		}
		
		return str;
	}
	finally
	{
		str = i = par = null;
	}
}

MessengerClient.___asyn = function(method, domain, time)
{
	if (!method)
		return;

	if (time == null)
		time = 10;
	var args = null;
	if (arguments == null || arguments.length < 4)
	{
	}
	else
	{
		args = [];
		for(var i = 3;i < arguments.length;i++)
		{
			args[i - 3] = arguments[i];
		}
	}
	var fn = function()
	{
		try
		{
			if (method != null)
			{
				if (args != null)
					method.apply(domain, args);
				else method.apply(domain);
			}
		}
		finally
		{
			domain = args = arguments = method = null;
		}
	}

	setTimeout(fn, time);
	fn = null;
}

MessengerClient.__request = function(requestUrl, tag)
{
	try
	{
		var iframe = document.getElementById("____messenger_frame___");
		if (!iframe)
		{		
			iframe = document.createElement('iframe');
			iframe.setAttribute("id", "____messenger_frame___");
			iframe.setAttribute("__tag__", tag);
			iframe.style.position = "absolute";
			iframe.style.top = "0px";
			iframe.style.left = "0px";
			
			var f = true;
				
			if (f)
			{
				iframe.style.width = "1px";
				iframe.style.height = "1px";
				iframe.style.zIndex = -1;
			}
		}
		
	    document.body.appendChild(iframe);
	    
	    if(iframe.attachEvent)
		{  
			iframe.attachEvent('onload', MessengerClient._iframeload);  
		} 
		else
		{
			iframe.onload = MessengerClient._iframeload;
		}
		
	    MessengerClient.state = 0;
	    
	    iframe.src = requestUrl + "&_z=" + new Date().getTime();	
	}
	finally
	{
		iframe = f = null;
	}
}

MessengerClient._iframeload = function()
{
	try
	{
		var iframe = document.getElementById("____messenger_frame___");
		if(MessengerClient.state === 1) 
	    {   		    	
	    	var f = true;
	    	if (f)
	    	{
	    		MessengerClient.___asyn(MessengerClient.__requestCallback, MessengerClient, 200, iframe.getAttribute("__tag__"), iframe.contentWindow.name);
	    		//MessengerClient.__requestCallback.call(MessengerClient, iframe.getAttribute("__tag__"), iframe.contentWindow.name);
	    		    	
				iframe.contentWindow.document.write('');
	  			iframe.contentWindow.close();
				document.body.removeChild(iframe);
	    	}
		}
		else if(MessengerClient.state === 0) 
		{
	  		MessengerClient.state = 1;
	  		iframe.contentWindow.location = leapconfig.server + 'LEAP/Service/RPC/RPC.DO?type=997';
		}
	}
	catch(e)
	{
		console.log("messenger: network err, iframe err.");
				
		if (MessengerClient.callback_onDisconnected)
			MessengerClient.___asyn(MessengerClient.callback_onDisconnected, MessengerClient.callbackDomain, 1000);
	}
	finally
	{
		iframe = f = null;
	}
}

MessengerClient.__requestCallback = function(tag, result)
{
	try
	{
		if (result == "")
		{
			console.log("messenger: network err, result is null");
			
			if (MessengerClient.callback_onDisconnected)
				MessengerClient.___asyn(MessengerClient.callback_onDisconnected, MessengerClient.callbackDomain, 1000);	
				
			return;
		}
		
		try
		{
			if (tag == this.tag.login)
			{
				if (result)
				{
					var ret = JSON.parse(result);
					
					if (ret && ret.statu == 1)
					{
						this._channel = ret.data;
					}
					
					this.callback_afterLogin.call(this.callbackDomain, ret);
				}
				else
				{
					this.callback_afterLogin.call(this.callbackDomain, null);	
				}
			}
			else if (tag == this.tag.connect)
			{
				if (MessengerClient.state_reconnect != 0)
					return;
	
				var msg = JSON.parse(result);
		
				if (MessengerClient.callbacks_MesssageArrived && MessengerClient.callbacks_MesssageArrived.length>0)
				{
					for(var i=0; i<MessengerClient.callbacks_MesssageArrived.length; i++)
					{
						var c = MessengerClient.callbacks_MesssageArrived[i];
						
						try
						{
							c.fn.call(c.domain, msg);
						}
						catch(e)
						{
						}
					}
				}
				
				this.connect();
			}
		}
		catch(e)
		{
			console.log("messenger: message parse err");
			
			if (MessengerClient.callback_onDisconnected)
				MessengerClient.___asyn(MessengerClient.callback_onDisconnected, MessengerClient.callbackDomain, 1000);	
		}
	}
	finally
	{
		ret = msg = i = c = null;
	}
}



/**
/*var state = 0;
	
	document.body.appendChild(iframe);
    
    iframe.onload = function() 
    {
    	if(state === 1) 
	    {   		    	
	    	if (f)
	    	{
	    		MessengerClient.___asyn(MessengerClient.__requestCallback, MessengerClient, 200, iframe.getAttribute("__tag__"), iframe.contentWindow.name);
	    		    	
  				iframe.contentWindow.document.write('');
      			iframe.contentWindow.close();
    			document.body.removeChild(iframe);
	    	}
  		}
  		else if(state === 0) 
  		{
      		state = 1;
      		iframe.contentWindow.location = leapconfig.server + '/LEAP/__blank__.html';
  		}
    };*/

LWFP.pack = {}

/**
 * pdf打印 
 * @param {} domain 作用域
 * @param {} param 打印参数，格式说明如下：
 			{pages:页面清单数组，格式如下：
 							[{
							 	type:类型(1界面截图 2PDF模板 3 附件),  
							 	title:标题,  
							 	element:界面容器(type=1时须指定), 
							 	template:模板路径(type=2时须指定), 
							 	templateValues:模板值(type=2时须指定)（格式：[{type:书签类型0文本1图片,
							 											name:书签名称, 
							 											value:书签值文本，type=1时则为图片对象，格式如下：
							 														{path:路径, width:宽度, height:高度, pagenum:所在页码, x:x坐标-原点为左下角,y:Y坐标-原点为左下角}
							 											}, ...] 
							 									 ）, 
							 	attachments:附件清单数组(type=3时须指定)（格式:[{path:文件地址,showname:显示名},...])
							 }, ... ], 				 
 			 download:是否自动下载（true/false）, 
 			 callbackFn:回调函数, 
 			 uploadPath:上传通道名, 
 			 fileName:下载文件名
 			}
 			
 	示例：
 	var a = this.getUT("testform")
	var b = LEAP.getElement("div[tabcode=t10]",this.parentPageModule.moduleElement);
	
	var arr = [];
	var atts = LWFP.API.getAttachments2(this);
	for(var i=0; i<atts.length; i++)
		arr[i] = {path:"LEAP/Download/" + atts[i].namedpath + "/" + atts[i].name, showname:atts[i].title};
		
	LWFP.pack.Pack(this,{pages: [{type:1, title:"标题——主表单", element:a},
								 {type:1, title:"标题——副表单", element:b},
								 {type:3, title:"标题——相关附件", attachments:arr}
								 	],
							download:true,
							callbackFn:this.packcallback,
							uploadPath:"wfpackage",
							fileName:"文件名"}
						); 		
 */
LWFP.pack.Pack = function(domain, param)
{
	try
	{		
		LEAP.messagebox.alert("该操作需要的时间比较长，请耐心等候...");
		
		LWFP.pack.__loadJS();
		
		if (LWFP.pack.cache)
		{
			LEAP.messagebox.alert("正在进行流程打包，请耐心等候，不要重复操作...");
			
			return;
		}
		
		LWFP.pack.cache = { domain:domain,							 
							pages:param.pages,
							download:param.download,
							callbackFn:param.callbackFn,
							uploadPath:param.uploadPath,
							fileName:param.fileName
							};
		
		LWFP.pack._Pack();
	}
	catch(e)
	{
		LWFP.pack._convert_clear();
		LWFP.pack.cache = null
	}
}

LWFP.pack._Pack = function()
{
	try
	{	
		var completed = true;
		for(var i=0; i<LWFP.pack.cache.pages.length; i++)
		{
			var page = LWFP.pack.cache.pages[i];
			if (page.type == 1 && page.imageB64 == null)
			{
				completed = false;
				LWFP.pack._convert(page.element);
				break;
			}
		}
		
		if (completed == true)
		{
			for(var i=0; i<LWFP.pack.cache.pages.length; i++)
			{
				var page = LWFP.pack.cache.pages[i];
				if (page.type == 1)
				{
					page.element = null;
				}
			}
			
			
			var rst = LEAP.request("PDFPrint", {pages:LWFP.pack.cache.pages, uploadPath:LWFP.pack.cache.uploadPath, showName:LWFP.pack.cache.fileName});
				
			if (rst == null)
			{
				LEAP.messagebox.alert("操作失败！");
			}
			else
			{
				if (LWFP.pack.cache.download == true)
					LEAP.upload._download({nameedPath:rst.nameedpath, name:rst.name, showName:rst.showname, title:rst.title});
				
				if (LWFP.pack.cache.callbackFn)
					LWFP.pack.cache.callbackFn.apply(LWFP.pack.cache.domain, [{uri:rst}]);
			}
			
			LWFP.pack._convert_clear();
			LWFP.pack.cache = null;
		}
	}
	catch(e)
	{
		LEAP.messagebox.alert("操作失败！");
		LWFP.pack._convert_clear();
		LWFP.pack.cache = null;
	}
	finally
	{
		completed = i = page = rst = null;
	}
}

LWFP.pack.callback = function(canvas)
{
	try
	{
		for(var i=0; i<LWFP.pack.cache.pages.length; i++)
		{
			var page = LWFP.pack.cache.pages[i];
			if (page.type == 1 && page.imageB64 == null)
			{
				page.imageB64 = canvas.toDataURL("image/png");
				break;
			}
		}
		
		LWFP.pack._convert_clear();
		
		LWFP.pack._Pack();
	}
	catch(e)
	{
		LEAP.messagebox.alert("操作失败！");
		LWFP.pack._convert_clear();
		LWFP.pack.cache = null;
	}
	finally
	{
		i = page = null;
	}
}

LWFP.pack._convert = function(element)
{
	try
	{
		var div = document.getElementById("_____pack_tmp_____");
		if (!div)
		{
			div = document.createElement("div");
			div.setAttribute("id", "_____pack_tmp_____");
			div.style.position = "absolute";
			div.style.zIndex = 998;
			div.style.top = "80px";
			div.style.left = "0px";
			div.style.display = "none";
			
			div.setAttribute("__wfpack", 1);
		
			document.body.appendChild(div);
		}
				
		div.innerHTML = element.innerHTML;
		
		LWFP.pack.promise = html2canvas(div, {allowTaint:true, taintTest:false, onrendered:LWFP.pack.callback});
	}
	finally
	{
		div = null;
	}
}

LWFP.pack._convert_clear = function()
{
	try
	{
		var div = document.getElementById("_____pack_tmp_____");
		if (div)
			document.body.removeChild(div);
	}
	finally
	{
		div = null;
	}
}


LWFP.pack.__hasLoadJS = false;
LWFP.pack.__loadJS = function()
{
	try
	{
		if (LWFP.pack.__hasLoadJS == false)
		{
			leapclient.loadjs("LEAP/LWFP/Utils/html2canvas/es6-promise.js");
			leapclient.loadjs("LEAP/LWFP/Utils/html2canvas/html2canvas.js");
			
			leapclient.loadcss("LEAP/LWFP/Utils/html2canvas/html2canvas.css");
			
			LWFP.pack.__hasLoadJS = true;
		}
	}
	finally
	{	
	}
}





LWFP.windowOpen = {};
LWFP.windowOpen.cache = new hashtable();
LWFP.windowOpen.callback = function(arg)
{
	try
	{
		var key = arg.key;
		var cache = LWFP.windowOpen.cache.getvalue(key);
		if (cache)
		{
			var type = cache.type;
			if (type == 1) 
			{//attlist
				LEAP.attlist.WindowOpen_callback(arg);			
			}
			else if (type == 99)
			{
				try
				{
					if (cache.callbackFn)
					{
						cache.callbackFn(arg);
					}
				}
				finally
				{}
			}
			
			if (arg.clearCache == true)
				LWFP.windowOpen.cache.remove(key);
		}
	}
	finally
	{
		key = cache = type = null;
	}
}
LWFP.windowOpen.getParam = function(arg) //arg:[key,paramName]
{
	try
	{
		var key = arg.key;
		var cache = LWFP.windowOpen.cache.getvalue(key);
		if (cache)
		{
			var type = cache.type;
			if (type == 1) 
			{//attlist
				
				var obj = LEAP.attlist.WindowOpen_getParam(arg);
				if (obj != null)				
					return JSON.stringify(obj);		
				else
					return null;
			}
			else if (type == 99)
			{
				if (cache.getParamFn)
				{
					var obj = cache.getParamFn(arg, cache.param);					
					if (obj != null)				
						return JSON.stringify(obj);		
					else
						return null;
				}
			}
		}
		
		return null;
	}
	finally
	{
		key = cache = type = obj = null;
	}
}
/**
 * 内部调用，需指定type
 * @param {} type
 * @param {} url
 * @param {} key
 * @param {} par
 */
LWFP.windowOpen.open = function(type, url, key, par)
{		
	var name = (LEAP.Environment == "AK") ? "_blank" : key;
		name = key;
	
	var _url = url;
	if (_url.indexOf('?') == -1)
		_url = _url + "?key=" + key;
	else
		_url = _url + "&key=" + key;
	
	window.open(_url, name);
	
	LWFP.windowOpen.cache.add(key, {type:type, param:par});	
}
/**
 * 外部调用
 * @param arg:
  {
	url:
	key:
	par:参数
	callbackFn(arg：弹出页面传递的参数):回调函数
	getParamFn(arg1：弹出页面传递的参数, arg2：传入的参数par)：参数获取函数
 }  
 */
LWFP.windowOpen.Open = function(arg)
{
	var name = (LEAP.Environment == "AK") ? "_blank" : arg.key;
		name = arg.key;
		
	var _url = arg.url;
	if (_url.indexOf('?') == -1)
		_url = _url + "?key=" + arg.key;
	else
		_url = _url + "&key=" + arg.key;
	
	window.open(_url, name);
	
	LWFP.windowOpen.cache.add(arg.key, {type:99, param:arg.par, callbackFn:arg.callbackFn, getParamFn:arg.getParamFn});
}

window.LWFPWindowOpenGetparamFn = LWFP.windowOpen.getParam;
window.LWFPWindowOpenCallbackFn = LWFP.windowOpen.callback;



LWFP.Utils = {}
LWFP.Utils.getTravel = function(t1, t2)
{	
	try
	{
		var _t1 = t1.time;
		var _t2 = LEAP.getServerTimeTicket();
		if (t2)
			_t2 = t2.time;

		var N = 1000;
		var T = _t2 - _t1;
		
		var D = Math.floor(T/(24*60*60*N));
			T = T - D*24*60*60*N;
		var H = Math.floor(T/(60*60*N));
			T = T - H*60*60*N;
		var M = Math.floor(T/(60*N));
			T = T - M*60*N;
		var S = Math.floor(T/(N));
		
		return ((D==0)?"":D+"天") + ((H==0)?"":H+"小时") + ((M==0)?"":M+"分") + ((S==0)?"":S+"秒");			
	}
	finally
	{
		_t1 = _t2 = N = T = D = H = M = S = null;
	}
}
	



/**
 * 使用新窗口打开流程
 * @param {} domain
 * @param {} params 参数，格式如下：
		  			{
		  				isNew:是否发起新流程，boolean, 必须
		  				
		  				businessNo:事项编号，isNew==false时必须
		  				
		  				entryId:实例ID
			  			csid:当前步骤ID
			  			delegate:代理
			  			archCategory:归档分类
			  			
			  			extendParam:扩展参数
			  			callBackFunc:回调函数		
		  			}
  * @param {} url 项目自定义url，要求LEAP相对路径，如：LEAP/appName/window.html
 */
LWFP.innerApi.CreateWFWindow = function(domain, params, url)
{
	try
	{
		var handle = UUID.cID();
		
		params.__mainInstance = domain.instance;
		params.__parentWindowSuperDelegate = domain.superDelegate;
		
		if (!params.otherRouter && domain.router)
		{
			params.otherRouter = domain.router;			
		}
		
		LWFP.WFWindowManager.__registParam(handle, params);
		
		var _url = url;
		if (_url == null)
		{
			if (window._hasTMod == true)
			{
				_url = "LEAP/Trust/" + window._leap_systemarea + "/" + window._leap_systemname + "/trustmodule.html";
			}
			else
			{
				_url = "LEAP/LWFP/JavaScript/WFRunning/WFWindow/WFWindow.html";
			}
		}
			
		_url = leapconfig.server + _url;
		
		var _window = window.open(_url + "?fn=WFWindowInit&handle=" + handle,  params.csid!=null ? params.csid:params.entryId);

	}
	finally
	{
		handle = _window = null;
	}
}

//window.open打开流程注入
LEAP.WFWindowInit = function()
{
	this.handle = null;
	this.param = null;
	this.container = null;
	
	this.loadWorkflow = function()
	{
		try
		{			
			window.onunload = this.__onbeforeunload;
			window.onbeforeunload = this.__onbeforeunload;
			
			var URLPars = LEAP.geturlpars();
			this.handle = URLPars.getvalue("handle");
			window.__handle = this.handle;
			
			this.___callback_common(this.handle, {key:"clearReady"});
			
			this.param = window.opener.LWFP.WFWindowManager.getWindowParam(this.handle);	
			if (this.param == null)
				return;
			
			this.superDelegate = this.param.__parentWindowSuperDelegate;
			document._isNewWfWindow = true;
			
			this.container = null;			
			if (window.flowWindowLoadform == 1)
			{
				this.container = null;
			}
			else
			{
				this.container = document.createElement("div");//LEAP.getElement("[ctf=wf_form_container]", document.body);	
				this.container.style.width = "100%";
				this.container.style.height = "100%";
				document.body.appendChild(this.container);
			}
			
			var form = null;
			if (this.param.isNew == true)
			{
				var par = {businessNo:this.param.businessNo, 
							delegate:this.param.delegate,
							otherRouter:this.param.otherRouter,
							extendParam:this.param.extendParam,
							container:this.container,
							maxsize:true,
							callBackFunc:this._____onOptionCallBack,
							closeCallbackFunc:this._____closeCallbackFunc};
				
				form = LWFP.API.StartFlow(par, this);
			}
			else
			{
				var par = {entryId:this.param.entryId, 
							csid:this.param.csid,
							delegate:this.param.delegate,
							isarch:this.param.isarch,
							otherRouter:this.param.otherRouter,
							entryCreatetime:this.param.entryCreatetime,
							archCategory:this.param.archCategory,
							extendParam:this.param.extendParam,
							container:this.container,					
							maxsize:true,
							callBackFunc:this._____onOptionCallBack,
							closeCallbackFunc:this._____closeCallbackFunc};
				
				form = LWFP.API.OpenFlow(par, this);				
			}
			
			if (window.flowWindowLoadform == 1)
			{
				LEAP.form.hideOperResize(form.form);
				this.addEvent(form.form, "formHided", this._wfFormHide);
			}

		}
		finally
		{
			URLPars = par = null;
		}
	}

	
	this._wfFormHide = function()
	{
		window.close();
	}
	
	this._____closeCallbackFunc = function()
	{
		this.___callback_common(window.__handle, {key:"windowclose"});
		
		window.close();
	}
	
	this._____onOptionCallBack = function(arg)
	{
		this.___callback_common(window.__handle, arg);
	}
	
	this.__onbeforeunload = function(event)
	{
		if (window.opener)
		{
			if (window.opener.closed == false)
			{	
				if (event.type == "beforeunload")
					window.opener.LWFP.WFWindowManager.callback(window.__handle, {key:"beforeunload"});
				else if (event.type == "unload")
					window.opener.LWFP.WFWindowManager.callback(window.__handle, {key:"unload"});
			}
		}
	}
	
	this.___callback_common = function(handle, arg)
	{
		if (window.opener)
		{
			if (window.opener.closed == false)
			{				
				window.opener.LWFP.WFWindowManager.callback(handle, arg);						
			}
		}
	}
		
	this.loadWorkflow();	
}



LWFP.WFWindowManager = new Object();
LWFP.WFWindowManager.windowParameters = null;
LWFP.WFWindowManager.readyToClear = new hashtable();
LWFP.WFWindowManager.__registParam = function(handle, param)
{
	if (LWFP.WFWindowManager.windowParameters == null)
		LWFP.WFWindowManager.windowParameters = new hashtable();
	LWFP.WFWindowManager.windowParameters.add(handle, param);
}

LWFP.WFWindowManager.getWindowParam = function(handle)
{
	try
	{
		var param = LWFP.WFWindowManager.windowParameters.getvalue(handle);		
		return param;
	}
	finally
	{
		param = null;
	}
}

LWFP.WFWindowManager.callback = function(handle, args)
{
	if (handle == null) 
		return;
	
	if (LWFP.WFWindowManager.windowParameters == null)
		return;
	
	try
	{		
		if (args && args.key == "clearReady")
		{
			for(k in LWFP.WFWindowManager.readyToClear.keys)
			{
				var _k = LWFP.WFWindowManager.readyToClear.getkey(k);
				LWFP.WFWindowManager.readyToClear.remove(_k);
				
				if (_k != handle)
					LWFP.WFWindowManager.windowParameters.remove(_k);			
			}
			
			return;
		}
		else
		{		
			var params = LWFP.WFWindowManager.windowParameters.getvalue(handle);
			if (params == null)
				return;
				
			if (args && args.key == "windowclose")
			{
				LWFP.WFWindowManager.windowParameters.remove(handle);
				LWFP.WFWindowManager.readyToClear.remove(handle);
				
				return;
			}
			else if (args && (args.key == "beforeunload" || args && args.key == "unload") )
			{
				LWFP.WFWindowManager.readyToClear.remove(handle);
				LWFP.WFWindowManager.readyToClear.add(handle);			
				return;
			}			
					
			if (params.callBackFunc != null && params.__mainInstance != null)
			{
				var domain = PageObjectModel.getModule(params.__mainInstance);
				if (domain)
				{			
					if (args != null)
					{
						if (params.callBackFunc.length > 0)				
							params.callBackFunc.apply(domain, [args]);
						else
							params.callBackFunc.apply(domain);
					}
					else
					{
						params.callBackFunc.apply(domain);
					}
				}
			}
		}
	}
	catch(e)
	{
	}
	finally
	{
		k = _k = params = domain = null;
	}
}






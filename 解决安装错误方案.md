# pnpm install 错误解决方案

## 问题分析

`pnpm i` 命令在执行 `libraries/qrcode` 包的 `prepublishOnly` 脚本时失败，错误原因：

### 核心错误
```
[!] (plugin dts) RollupError: Failed to compile. Check the logs above.
ELIFECYCLE Command failed with exit code 1.
```

这是 **TypeScript 类型错误**，不是依赖安装问题。主要错误：

1. **RenderType 类型不匹配**
   - `Type '"canvas"' is not assignable to type 'RenderType'`
   - `Type '"svg"' is not assignable to type 'RenderType'`

2. **DotStyle 类型不匹配**
   - 多处 `dotStyle` 字符串字面量无法赋值给 `DotStyle` 类型

## 快速解决方案

### 方案 1：跳过 prepublishOnly 脚本（推荐）

这样可以跳过构建步骤，只安装依赖：

```bash
pnpm install --ignore-scripts
```

或在 `.npmrc` 中添加：
```ini
ignore-scripts=true
```

**优点**：
- 快速完成依赖安装
- 不影响开发环境使用
- 可以正常开发和测试

**缺点**：
- 某些包的 postinstall 脚本不会执行（如 husky、puppeteer）
- 需要的话可以单独运行这些脚本

### 方案 2：禁用 qrcode 包的 prepublishOnly

编辑 `libraries/qrcode/package.json`，临时注释或删除 prepublishOnly 脚本：

```json
{
  "scripts": {
    // "prepublishOnly": "npm run build && npm run test"
  }
}
```

然后重新运行：
```bash
pnpm install
```

### 方案 3：修复 TypeScript 类型错误（完整方案）

需要修复 `libraries/qrcode/src/types/index.ts` 中的类型定义。

主要需要修改：

1. **修改 RenderType 类型定义**，使其接受字符串字面量
2. **修改 DotStyle 类型定义**，使其接受更多样式值
3. **修改 ErrorCorrectionLevel 类型定义**

这需要详细分析代码并修改类型系统，比较耗时。

## 推荐操作流程

### 步骤 1：使用 ignore-scripts 完成安装

```bash
# 清理之前的安装（如果有）
pnpm store prune

# 使用 ignore-scripts 安装
pnpm install --ignore-scripts
```

### 步骤 2：手动运行必要的脚本

如果需要某些 postinstall 脚本，可以手动运行：

```bash
# 安装 husky git hooks
cd libraries/word && npx husky install
cd ../..

# 或者只在需要时运行
pnpm rebuild
```

### 步骤 3：单独处理 qrcode 包

如果需要构建 qrcode 包：

```bash
cd libraries/qrcode

# 修复 TypeScript 错误后再构建
npm run build
```

## 更新 .npmrc 配置

将以下内容添加到 `.npmrc`：

```ini
# 跳过所有脚本（可选，根据需要启用）
# ignore-scripts=true

# 或者只跳过特定包的脚本
# @ldesign/qrcode:ignore-scripts=true
```

## 更新 package.json 命令

建议添加新的安装命令：

```json
{
  "scripts": {
    "install:fast": "node scripts/fast-install.js",
    "install:no-scripts": "pnpm install --ignore-scripts",
    "install:clean": "pnpm store prune && pnpm install --ignore-scripts",
    "postinstall:manual": "cd libraries/word && npx husky install"
  }
}
```

## 长期解决方案

### 修复 qrcode 包的类型问题

需要修改 `libraries/qrcode/src/types/index.ts`：

1. 将 `RenderType` 改为 union type 或使用 `as const`
2. 将 `DotStyle` 改为更灵活的类型
3. 确保所有枚举类型正确定义

示例修改：

```typescript
// 从
export type RenderType = 'canvas' | 'svg' | 'webgl';

// 改为
export type RenderType = 'canvas' | 'svg' | 'webgl';
export const RenderTypes = ['canvas', 'svg', 'webgl'] as const;
```

## 快速命令参考

```bash
# 1. 推荐：跳过脚本安装
pnpm install --ignore-scripts

# 2. 如果需要运行特定脚本
pnpm rebuild

# 3. 只安装生产依赖（跳过脚本）
pnpm install --prod --ignore-scripts

# 4. 清理并重新安装
pnpm store prune && pnpm install --ignore-scripts
```

## 总结

当前错误是 **qrcode 包的 TypeScript 类型错误**，不是依赖安装或速度问题。

**最快的解决方案**：
```bash
pnpm install --ignore-scripts
```

这样可以成功安装所有依赖，只是跳过了有问题的构建脚本。对于开发环境来说，这完全足够了。

如果需要发布 qrcode 包或在生产环境使用，才需要修复 TypeScript 类型错误。
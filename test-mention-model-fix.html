<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mention Model 渲染测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #1677ff;
            padding-bottom: 8px;
        }
        .test-case {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-case h3 {
            margin-top: 0;
            color: #555;
        }
        .description {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .expected {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
        }
        .actual {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 40px;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #263238;
            color: #aed581;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
    <script type="module" src="/dist/webcomponent/webcomponent.esm.js"></script>
    <link rel="stylesheet" href="/dist/webcomponent/webcomponent.css">
</head>
<body>
    <h1>🔍 Mention 组件 Model 渲染测试</h1>
    
    <div class="test-case">
        <h3>测试用例 1: 分段模型初始化</h3>
        <div class="description">
            使用 model 属性传入分段数组，应该正确渲染为独立的标签和文本
        </div>
        <ldesign-mention
            id="test-model"
            triggers='["@", "#"]'
            trigger-configs='[
                {
                    "char": "@",
                    "tokenType": "primary",
                    "options": [
                        {"value": "1", "label": "Alice"},
                        {"value": "2", "label": "Bob"}
                    ]
                },
                {
                    "char": "#",
                    "tokenType": "warning",
                    "options": [
                        {"value": "t1", "label": "话题一"},
                        {"value": "t2", "label": "性能优化"}
                    ]
                }
            ]'
            model='[
                {"type": "text", "text": "欢迎 "},
                {"type": "mention", "trigger": "@", "label": "Alice", "value": "1"},
                {"type": "text", "text": " 参与 "},
                {"type": "mention", "trigger": "#", "label": "话题一", "value": "t1"},
                {"type": "text", "text": " 讨论"}
            ]'
        ></ldesign-mention>
        <div class="expected">
            <strong>期望渲染结果：</strong><br>
            - "欢迎 " (纯文本)<br>
            - @Alice (蓝色标签带×)<br>
            - " 参与 " (纯文本)<br>
            - #话题一 (黄色标签带×)<br>
            - " 讨论" (纯文本)
        </div>
        <div class="log" id="log-model"></div>
    </div>

    <div class="test-case">
        <h3>测试用例 2: 复杂分段模型</h3>
        <div class="description">
            包含多个标签和文本段的复杂情况
        </div>
        <ldesign-mention
            id="test-complex"
            triggers='["@", "#"]'
            trigger-configs='[
                {
                    "char": "@",
                    "tokenType": "primary",
                    "options": [
                        {"value": "1", "label": "Alice"},
                        {"value": "2", "label": "Bob"},
                        {"value": "3", "label": "Charlie"}
                    ]
                },
                {
                    "char": "#",
                    "tokenType": "info",
                    "options": [
                        {"value": "t1", "label": "前端开发"},
                        {"value": "t2", "label": "性能优化"}
                    ]
                }
            ]'
            model='[
                {"type": "text", "text": "请 "},
                {"type": "mention", "trigger": "@", "label": "Alice", "value": "1"},
                {"type": "text", "text": " 和 "},
                {"type": "mention", "trigger": "@", "label": "Bob", "value": "2"},
                {"type": "text", "text": " 关注 "},
                {"type": "mention", "trigger": "#", "label": "性能优化", "value": "t2"},
                {"type": "text", "text": " 相关内容"}
            ]'
        ></ldesign-mention>
        <div class="expected">
            <strong>期望渲染结果：</strong><br>
            每个 @用户 和 #话题 应该是独立的标签，中间的文本应该是普通文本
        </div>
        <div class="log" id="log-complex"></div>
    </div>

    <div class="test-case">
        <h3>测试用例 3: 标签移除事件</h3>
        <div class="description">
            点击标签的 × 应该只移除该标签，不影响其他内容
        </div>
        <ldesign-mention
            id="test-remove"
            triggers='["@", "#"]'
            trigger-configs='[
                {
                    "char": "@",
                    "tokenType": "primary",
                    "closable": true,
                    "options": [{"value": "1", "label": "Alice"}]
                },
                {
                    "char": "#",
                    "tokenType": "warning",
                    "closable": true,
                    "options": [{"value": "t1", "label": "话题一"}]
                }
            ]'
            model='[
                {"type": "text", "text": "欢迎 "},
                {"type": "mention", "trigger": "@", "label": "Alice", "value": "1"},
                {"type": "text", "text": " 参与 "},
                {"type": "mention", "trigger": "#", "label": "话题一", "value": "t1"},
                {"type": "text", "text": " 讨论"}
            ]'
        ></ldesign-mention>
        <div class="expected">
            <strong>测试方式：</strong><br>
            1. 点击 @Alice 标签的 × → 应该只移除 @Alice<br>
            2. 点击 #话题一 标签的 × → 应该只移除 #话题一<br>
            3. 剩余文本应该保持不变
        </div>
        <div class="log" id="log-remove">等待移除事件...</div>
    </div>

    <script>
        // 分析DOM结构的辅助函数
        function analyzeDom(elementId, logId) {
            const el = document.getElementById(elementId);
            const log = document.getElementById(logId);
            
            if (!el || !log) return;
            
            // 等待组件渲染
            setTimeout(() => {
                const editable = el.querySelector('.ldesign-mention__editable');
                if (!editable) {
                    log.innerHTML = '⚠️ 找不到 editable 元素';
                    return;
                }
                
                let analysis = '<strong>DOM 结构分析：</strong>\n';
                const children = editable.childNodes;
                
                children.forEach((child, index) => {
                    if (child.nodeType === 3) { // 文本节点
                        const text = child.textContent.replace(/\n/g, '\\n').replace(/ /g, '·');
                        analysis += `[${index}] 文本节点: "${text}"\n`;
                    } else if (child.nodeType === 1) { // 元素节点
                        const elem = child;
                        if (elem.classList.contains('ldesign-mention__token')) {
                            const trigger = elem.getAttribute('data-trigger');
                            const label = elem.getAttribute('data-label');
                            const value = elem.getAttribute('data-value');
                            const closable = elem.getAttribute('data-closable');
                            analysis += `[${index}] 标签节点: ${trigger}${label} (value=${value}, closable=${closable})\n`;
                            
                            // 检查是否有意外的子文本
                            const innerText = elem.innerText;
                            if (innerText !== `${trigger}${label}×` && innerText !== `${trigger}${label}`) {
                                analysis += `  ⚠️ 标签内文本异常: "${innerText}"\n`;
                            }
                        } else {
                            analysis += `[${index}] 其他元素: ${elem.tagName} (class="${elem.className}")\n`;
                        }
                    }
                });
                
                // 检查整体文本
                const fullText = editable.innerText;
                analysis += `\n<strong>完整文本内容：</strong>\n"${fullText}"`;
                
                log.innerHTML = `<pre>${analysis}</pre>`;
            }, 100);
        }
        
        // 分析所有测试用例
        analyzeDom('test-model', 'log-model');
        analyzeDom('test-complex', 'log-complex');
        
        // 监听移除事件
        const removeEl = document.getElementById('test-remove');
        if (removeEl) {
            removeEl.addEventListener('ldesignRemove', (e) => {
                const log = document.getElementById('log-remove');
                const detail = e.detail;
                log.innerHTML += `\n<strong>移除事件：</strong> trigger=${detail.trigger}, label=${detail.label}, value=${detail.value}`;
                
                // 重新分析DOM
                setTimeout(() => {
                    analyzeDom('test-remove', 'log-remove');
                }, 100);
            });
            
            // 初始分析
            analyzeDom('test-remove', 'log-remove');
        }
        
        // 监听所有组件的值变化
        document.querySelectorAll('ldesign-mention').forEach(el => {
            el.addEventListener('ldesignValueChange', (e) => {
                console.log(`[${el.id}] 值变化:`, e.detail);
            });
        });
    </script>
</body>
</html>
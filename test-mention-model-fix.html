<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mention Model æ¸²æŸ“æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #1677ff;
            padding-bottom: 8px;
        }
        .test-case {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-case h3 {
            margin-top: 0;
            color: #555;
        }
        .description {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .expected {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
        }
        .actual {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 40px;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #263238;
            color: #aed581;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
    <script type="module" src="/dist/webcomponent/webcomponent.esm.js"></script>
    <link rel="stylesheet" href="/dist/webcomponent/webcomponent.css">
</head>
<body>
    <h1>ğŸ” Mention ç»„ä»¶ Model æ¸²æŸ“æµ‹è¯•</h1>
    
    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹ 1: åˆ†æ®µæ¨¡å‹åˆå§‹åŒ–</h3>
        <div class="description">
            ä½¿ç”¨ model å±æ€§ä¼ å…¥åˆ†æ®µæ•°ç»„ï¼Œåº”è¯¥æ­£ç¡®æ¸²æŸ“ä¸ºç‹¬ç«‹çš„æ ‡ç­¾å’Œæ–‡æœ¬
        </div>
        <ldesign-mention
            id="test-model"
            triggers='["@", "#"]'
            trigger-configs='[
                {
                    "char": "@",
                    "tokenType": "primary",
                    "options": [
                        {"value": "1", "label": "Alice"},
                        {"value": "2", "label": "Bob"}
                    ]
                },
                {
                    "char": "#",
                    "tokenType": "warning",
                    "options": [
                        {"value": "t1", "label": "è¯é¢˜ä¸€"},
                        {"value": "t2", "label": "æ€§èƒ½ä¼˜åŒ–"}
                    ]
                }
            ]'
            model='[
                {"type": "text", "text": "æ¬¢è¿ "},
                {"type": "mention", "trigger": "@", "label": "Alice", "value": "1"},
                {"type": "text", "text": " å‚ä¸ "},
                {"type": "mention", "trigger": "#", "label": "è¯é¢˜ä¸€", "value": "t1"},
                {"type": "text", "text": " è®¨è®º"}
            ]'
        ></ldesign-mention>
        <div class="expected">
            <strong>æœŸæœ›æ¸²æŸ“ç»“æœï¼š</strong><br>
            - "æ¬¢è¿ " (çº¯æ–‡æœ¬)<br>
            - @Alice (è“è‰²æ ‡ç­¾å¸¦Ã—)<br>
            - " å‚ä¸ " (çº¯æ–‡æœ¬)<br>
            - #è¯é¢˜ä¸€ (é»„è‰²æ ‡ç­¾å¸¦Ã—)<br>
            - " è®¨è®º" (çº¯æ–‡æœ¬)
        </div>
        <div class="log" id="log-model"></div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹ 2: å¤æ‚åˆ†æ®µæ¨¡å‹</h3>
        <div class="description">
            åŒ…å«å¤šä¸ªæ ‡ç­¾å’Œæ–‡æœ¬æ®µçš„å¤æ‚æƒ…å†µ
        </div>
        <ldesign-mention
            id="test-complex"
            triggers='["@", "#"]'
            trigger-configs='[
                {
                    "char": "@",
                    "tokenType": "primary",
                    "options": [
                        {"value": "1", "label": "Alice"},
                        {"value": "2", "label": "Bob"},
                        {"value": "3", "label": "Charlie"}
                    ]
                },
                {
                    "char": "#",
                    "tokenType": "info",
                    "options": [
                        {"value": "t1", "label": "å‰ç«¯å¼€å‘"},
                        {"value": "t2", "label": "æ€§èƒ½ä¼˜åŒ–"}
                    ]
                }
            ]'
            model='[
                {"type": "text", "text": "è¯· "},
                {"type": "mention", "trigger": "@", "label": "Alice", "value": "1"},
                {"type": "text", "text": " å’Œ "},
                {"type": "mention", "trigger": "@", "label": "Bob", "value": "2"},
                {"type": "text", "text": " å…³æ³¨ "},
                {"type": "mention", "trigger": "#", "label": "æ€§èƒ½ä¼˜åŒ–", "value": "t2"},
                {"type": "text", "text": " ç›¸å…³å†…å®¹"}
            ]'
        ></ldesign-mention>
        <div class="expected">
            <strong>æœŸæœ›æ¸²æŸ“ç»“æœï¼š</strong><br>
            æ¯ä¸ª @ç”¨æˆ· å’Œ #è¯é¢˜ åº”è¯¥æ˜¯ç‹¬ç«‹çš„æ ‡ç­¾ï¼Œä¸­é—´çš„æ–‡æœ¬åº”è¯¥æ˜¯æ™®é€šæ–‡æœ¬
        </div>
        <div class="log" id="log-complex"></div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹ 3: æ ‡ç­¾ç§»é™¤äº‹ä»¶</h3>
        <div class="description">
            ç‚¹å‡»æ ‡ç­¾çš„ Ã— åº”è¯¥åªç§»é™¤è¯¥æ ‡ç­¾ï¼Œä¸å½±å“å…¶ä»–å†…å®¹
        </div>
        <ldesign-mention
            id="test-remove"
            triggers='["@", "#"]'
            trigger-configs='[
                {
                    "char": "@",
                    "tokenType": "primary",
                    "closable": true,
                    "options": [{"value": "1", "label": "Alice"}]
                },
                {
                    "char": "#",
                    "tokenType": "warning",
                    "closable": true,
                    "options": [{"value": "t1", "label": "è¯é¢˜ä¸€"}]
                }
            ]'
            model='[
                {"type": "text", "text": "æ¬¢è¿ "},
                {"type": "mention", "trigger": "@", "label": "Alice", "value": "1"},
                {"type": "text", "text": " å‚ä¸ "},
                {"type": "mention", "trigger": "#", "label": "è¯é¢˜ä¸€", "value": "t1"},
                {"type": "text", "text": " è®¨è®º"}
            ]'
        ></ldesign-mention>
        <div class="expected">
            <strong>æµ‹è¯•æ–¹å¼ï¼š</strong><br>
            1. ç‚¹å‡» @Alice æ ‡ç­¾çš„ Ã— â†’ åº”è¯¥åªç§»é™¤ @Alice<br>
            2. ç‚¹å‡» #è¯é¢˜ä¸€ æ ‡ç­¾çš„ Ã— â†’ åº”è¯¥åªç§»é™¤ #è¯é¢˜ä¸€<br>
            3. å‰©ä½™æ–‡æœ¬åº”è¯¥ä¿æŒä¸å˜
        </div>
        <div class="log" id="log-remove">ç­‰å¾…ç§»é™¤äº‹ä»¶...</div>
    </div>

    <script>
        // åˆ†æDOMç»“æ„çš„è¾…åŠ©å‡½æ•°
        function analyzeDom(elementId, logId) {
            const el = document.getElementById(elementId);
            const log = document.getElementById(logId);
            
            if (!el || !log) return;
            
            // ç­‰å¾…ç»„ä»¶æ¸²æŸ“
            setTimeout(() => {
                const editable = el.querySelector('.ldesign-mention__editable');
                if (!editable) {
                    log.innerHTML = 'âš ï¸ æ‰¾ä¸åˆ° editable å…ƒç´ ';
                    return;
                }
                
                let analysis = '<strong>DOM ç»“æ„åˆ†æï¼š</strong>\n';
                const children = editable.childNodes;
                
                children.forEach((child, index) => {
                    if (child.nodeType === 3) { // æ–‡æœ¬èŠ‚ç‚¹
                        const text = child.textContent.replace(/\n/g, '\\n').replace(/ /g, 'Â·');
                        analysis += `[${index}] æ–‡æœ¬èŠ‚ç‚¹: "${text}"\n`;
                    } else if (child.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
                        const elem = child;
                        if (elem.classList.contains('ldesign-mention__token')) {
                            const trigger = elem.getAttribute('data-trigger');
                            const label = elem.getAttribute('data-label');
                            const value = elem.getAttribute('data-value');
                            const closable = elem.getAttribute('data-closable');
                            analysis += `[${index}] æ ‡ç­¾èŠ‚ç‚¹: ${trigger}${label} (value=${value}, closable=${closable})\n`;
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰æ„å¤–çš„å­æ–‡æœ¬
                            const innerText = elem.innerText;
                            if (innerText !== `${trigger}${label}Ã—` && innerText !== `${trigger}${label}`) {
                                analysis += `  âš ï¸ æ ‡ç­¾å†…æ–‡æœ¬å¼‚å¸¸: "${innerText}"\n`;
                            }
                        } else {
                            analysis += `[${index}] å…¶ä»–å…ƒç´ : ${elem.tagName} (class="${elem.className}")\n`;
                        }
                    }
                });
                
                // æ£€æŸ¥æ•´ä½“æ–‡æœ¬
                const fullText = editable.innerText;
                analysis += `\n<strong>å®Œæ•´æ–‡æœ¬å†…å®¹ï¼š</strong>\n"${fullText}"`;
                
                log.innerHTML = `<pre>${analysis}</pre>`;
            }, 100);
        }
        
        // åˆ†ææ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
        analyzeDom('test-model', 'log-model');
        analyzeDom('test-complex', 'log-complex');
        
        // ç›‘å¬ç§»é™¤äº‹ä»¶
        const removeEl = document.getElementById('test-remove');
        if (removeEl) {
            removeEl.addEventListener('ldesignRemove', (e) => {
                const log = document.getElementById('log-remove');
                const detail = e.detail;
                log.innerHTML += `\n<strong>ç§»é™¤äº‹ä»¶ï¼š</strong> trigger=${detail.trigger}, label=${detail.label}, value=${detail.value}`;
                
                // é‡æ–°åˆ†æDOM
                setTimeout(() => {
                    analyzeDom('test-remove', 'log-remove');
                }, 100);
            });
            
            // åˆå§‹åˆ†æ
            analyzeDom('test-remove', 'log-remove');
        }
        
        // ç›‘å¬æ‰€æœ‰ç»„ä»¶çš„å€¼å˜åŒ–
        document.querySelectorAll('ldesign-mention').forEach(el => {
            el.addEventListener('ldesignValueChange', (e) => {
                console.log(`[${el.id}] å€¼å˜åŒ–:`, e.detail);
            });
        });
    </script>
</body>
</html>
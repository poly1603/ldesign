# Shared-State æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ - æ‰§è¡Œæ€»ç»“

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

å½“å‰é¡¹ç›®ä¸­å­˜åœ¨ **åŠŸèƒ½é‡å¤** çš„é—®é¢˜ï¼š

1. âœ… `packages/engine` å·²æœ‰å®Œæ•´çš„çŠ¶æ€ç®¡ç†ï¼ˆ`StateManager`ï¼‰å’Œäº‹ä»¶ç³»ç»Ÿï¼ˆ`EventManager`ï¼‰
2. âœ… `packages/shared-state` æä¾›äº†ç‹¬ç«‹çš„ `GlobalStateBus` ç”¨äºè·¨åŒ…æ•°æ®å…±äº«
3. âŒ ä¸¤è€…åŠŸèƒ½é«˜åº¦é‡å ï¼Œå¯¼è‡´ï¼š
   - ç»´æŠ¤ä¸¤å¥—çŠ¶æ€ç®¡ç†ç³»ç»Ÿ
   - äº‹ä»¶è¢«è§¦å‘ä¸¤æ¬¡ï¼ˆengine.events + GlobalStateBusï¼‰
   - å¢åŠ åŒ…æ•°é‡å’Œä¾èµ–å¤æ‚åº¦
   - ä»£ç é‡å¤çº¦ 1000 è¡Œ

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### æ–¹æ¡ˆ C: ä½¿ç”¨ Engine æ’ä»¶æ›¿ä»£ Shared-State é€‚é…å™¨

**æ ¸å¿ƒæ€è·¯**:
- ğŸ—‘ï¸ åˆ é™¤ `packages/shared-state` åŒ…
- âœ… åˆ›å»ºæ¡¥æ¥æ’ä»¶ï¼ˆ`i18n-bridge`ã€`color-bridge`ã€`size-bridge`ï¼‰
- âœ… ä½¿ç”¨ `engine.state` å’Œ `engine.events` ç»Ÿä¸€ç®¡ç†çŠ¶æ€
- âœ… ä¿æŒå„åŠŸèƒ½åŒ…ï¼ˆi18nã€colorã€sizeï¼‰çš„å®Œå…¨ç‹¬ç«‹æ€§

## ğŸ“Š å¯¹æ¯”åˆ†æ

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | Engine | Shared-State | ç»“è®º |
|------|--------|--------------|------|
| çŠ¶æ€å­˜å‚¨ | âœ… Map | âœ… LRU Cache | Engine éœ€æ·»åŠ  LRU æ”¯æŒ |
| çŠ¶æ€ç›‘å¬ | âœ… watch | âœ… subscribe | åŠŸèƒ½ç›¸åŒ |
| äº‹ä»¶ç³»ç»Ÿ | âœ… æ”¯æŒé€šé…ç¬¦ | âŒ æ— é€šé…ç¬¦ | Engine æ›´å¼ºå¤§ |
| æ·±åº¦æ¯”è¾ƒ | âœ… å†…ç½® | âŒ æ—  | Engine æ›´ä¼˜ |
| æ€§èƒ½ç›‘æ§ | âŒ æ—  | âœ… å†…ç½® | Shared-State æ›´ä¼˜ |
| æ‰¹é‡æ›´æ–° | âœ… batch | âœ… batchUpdate | åŠŸèƒ½ç›¸åŒ |

### ä»£ç é‡å¯¹æ¯”

| é¡¹ç›® | å½“å‰ | ä¼˜åŒ–å | å‡å°‘ |
|------|------|--------|------|
| åº”ç”¨å…¥å£ | 80 è¡Œ | 40 è¡Œ | -50% |
| åŒ…æ•°é‡ | 2 ä¸ª | 1 ä¸ª | -50% |
| æ€»ä»£ç é‡ | ~1000 è¡Œ | ~450 è¡Œ | -55% |

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|------|--------|------|
| äº‹ä»¶è§¦å‘æ¬¡æ•° | 2 æ¬¡ | 1 æ¬¡ | -50% |
| çŠ¶æ€è¯»å†™ | O(1) | O(1) | ç›¸åŒ |
| å†…å­˜ç®¡ç† | LRU è‡ªåŠ¨æ·˜æ±° | Map æ— é™åˆ¶ | éœ€æ”¹è¿› |

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å½“å‰æ¶æ„ï¼ˆæœ‰é—®é¢˜ï¼‰

```
App
â”œâ”€â”€ Engine (çŠ¶æ€ + äº‹ä»¶)
â”‚   â”œâ”€â”€ StateManager
â”‚   â””â”€â”€ EventManager
â””â”€â”€ Shared-State (é‡å¤çš„çŠ¶æ€ + äº‹ä»¶)
    â”œâ”€â”€ GlobalStateBus
    â”œâ”€â”€ I18nAdapter
    â”œâ”€â”€ ColorAdapter
    â””â”€â”€ SizeAdapter
```

### ä¼˜åŒ–åæ¶æ„ï¼ˆæ¨èï¼‰

```
App
â””â”€â”€ Engine (ç»Ÿä¸€çš„çŠ¶æ€ + äº‹ä»¶)
    â”œâ”€â”€ StateManager
    â”œâ”€â”€ EventManager
    â””â”€â”€ Plugins
        â”œâ”€â”€ i18n-bridge (æ¡¥æ¥æ’ä»¶)
        â”œâ”€â”€ color-bridge (æ¡¥æ¥æ’ä»¶)
        â””â”€â”€ size-bridge (æ¡¥æ¥æ’ä»¶)
```

## ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿

### 1. æ¶ˆé™¤åŠŸèƒ½é‡å¤
- âœ… åªæœ‰ä¸€å¥—çŠ¶æ€ç®¡ç†ç³»ç»Ÿ
- âœ… äº‹ä»¶åªè§¦å‘ä¸€æ¬¡
- âœ… å‡å°‘ 55% ä»£ç é‡

### 2. ä¿æŒåŒ…ç‹¬ç«‹æ€§
- âœ… i18nã€colorã€size åŒ…ä¿æŒå®Œå…¨ç‹¬ç«‹
- âœ… ä¸éœ€è¦ä¾èµ– engine
- âœ… å¯ä»¥å•ç‹¬ä½¿ç”¨

### 3. ç»Ÿä¸€æ¶æ„
- âœ… æ‰€æœ‰çŠ¶æ€é€šè¿‡ `engine.state` ç®¡ç†
- âœ… æ‰€æœ‰äº‹ä»¶é€šè¿‡ `engine.events` è§¦å‘
- âœ… ä½¿ç”¨æ’ä»¶ç³»ç»Ÿï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†æ›´å¥½

### 4. æ›´å¥½çš„å¼€å‘ä½“éªŒ
- âœ… æ›´æ¸…æ™°çš„ APIï¼ˆ`useEngineState` vs `useGlobalState`ï¼‰
- âœ… æ›´å¥½çš„ç±»å‹å®‰å…¨
- âœ… æ›´å°‘çš„ä¾èµ–

## ğŸ“ å®æ–½æ­¥éª¤

### ç¬¬ 1 æ­¥: åˆ›å»ºæ¡¥æ¥æ’ä»¶ï¼ˆ1 å¤©ï¼‰
- [ ] åˆ›å»º `packages/engine/packages/plugins/i18n-bridge`
- [ ] åˆ›å»º `packages/engine/packages/plugins/color-bridge`
- [ ] åˆ›å»º `packages/engine/packages/plugins/size-bridge`
- [ ] å®ç°æ’ä»¶é€»è¾‘ï¼ˆå‚è€ƒ `I18nAdapter`ï¼‰

### ç¬¬ 2 æ­¥: æ·»åŠ  Vue Composablesï¼ˆ0.5 å¤©ï¼‰
- [ ] åœ¨ `@ldesign/engine-vue3` ä¸­æ·»åŠ  `useEngineState`
- [ ] åœ¨ `@ldesign/engine-vue3` ä¸­æ·»åŠ  `useEngineEvent`
- [ ] æ·»åŠ ç±»å‹å®šä¹‰

### ç¬¬ 3 æ­¥: è¿ç§»åº”ç”¨ä»£ç ï¼ˆ0.5 å¤©ï¼‰
- [ ] æ›´æ–° `apps/app-vue/src/main.ts`
- [ ] æ›´æ–° `apps/app-vue/src/components/SharedStateDemo.vue`
- [ ] æµ‹è¯•åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### ç¬¬ 4 æ­¥: åˆ é™¤ Shared-Stateï¼ˆ0.5 å¤©ï¼‰
- [ ] åˆ é™¤ `packages/shared-state`
- [ ] æ›´æ–° `package.json` ä¾èµ–
- [ ] è¿è¡Œ `pnpm install`

### ç¬¬ 5 æ­¥: æ–‡æ¡£æ›´æ–°ï¼ˆ0.5 å¤©ï¼‰
- [ ] æ›´æ–°æ¶æ„æ–‡æ¡£
- [ ] æ›´æ–°ä½¿ç”¨æŒ‡å—
- [ ] æ·»åŠ è¿ç§»æŒ‡å—

**æ€»è®¡**: 2-3 å¤©

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä»£ç ç¤ºä¾‹

#### ä¹‹å‰: ä½¿ç”¨ Shared-State
```typescript
// main.ts
const stateBus = GlobalStateBus.getInstance()
const i18nAdapter = new I18nAdapter(stateBus)
i18nAdapter.connect(i18nService)

// Component.vue
const locale = useGlobalState(STATE_KEYS.I18N_LOCALE)
```

#### ä¹‹å: ä½¿ç”¨ Engine
```typescript
// main.ts
const engine = createVueEngine({
  plugins: [
    createI18nEnginePlugin({ locale: 'zh-CN' }),
    createI18nBridgePlugin(), // è‡ªåŠ¨æ¡¥æ¥
  ]
})

// Component.vue
const locale = useEngineState<I18nLocaleState>('i18n.locale')
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯¦ç»†å¯¹æ¯”åˆ†æ](./shared-state-vs-engine-analysis.md)
- [è¿ç§»å¯¹æ¯”ç¤ºä¾‹](./migration-comparison.md)
- [I18n æ¡¥æ¥æ’ä»¶å®ç°](./implementation-example-i18n-bridge.ts)
- [Vue Composables å®ç°](./implementation-example-vue-composables.ts)

## âš ï¸ é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| è¿ç§»æˆæœ¬ | ä¸­ | åˆ†æ­¥è¿ç§»ï¼Œå…ˆè¿ç§»ä¸€ä¸ªç»„ä»¶éªŒè¯ |
| ç ´åæ€§å˜æ›´ | ä½ | åªå½±å“åº”ç”¨å±‚ï¼Œä¸å½±å“åŒ… |
| æ€§èƒ½ä¸‹é™ | ä½ | Engine æ€§èƒ½ç›¸å½“ï¼Œç”šè‡³æ›´ä¼˜ |
| å†…å­˜æ³„æ¼ | ä¸­ | æ·»åŠ  LRU ç¼“å­˜æ”¯æŒ |

## âœ… å†³ç­–å»ºè®®

**å¼ºçƒˆæ¨èé‡‡ç”¨æ–¹æ¡ˆ C**ï¼Œç†ç”±ï¼š

1. âœ… **æ¶æ„ç»Ÿä¸€**: æ¶ˆé™¤åŠŸèƒ½é‡å¤ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬
2. âœ… **ä¿æŒç‹¬ç«‹æ€§**: å„åŠŸèƒ½åŒ…ä»ç„¶å¯ä»¥ç‹¬ç«‹ä½¿ç”¨
3. âœ… **å‡å°‘ä»£ç é‡**: å‡€å‡å°‘ 550 è¡Œä»£ç 
4. âœ… **æ›´å¥½çš„æ‰©å±•æ€§**: åˆ©ç”¨ engine çš„æ’ä»¶ç³»ç»Ÿ
5. âœ… **è¿ç§»æˆæœ¬å¯æ§**: 2-3 å¤©å³å¯å®Œæˆ

**ä¸æ¨èçš„æ–¹æ¡ˆ**:
- âŒ æ–¹æ¡ˆ Aï¼ˆæ•´åˆåˆ° Engineï¼‰: ç ´ååŒ…ç‹¬ç«‹æ€§
- âŒ æ–¹æ¡ˆ Dï¼ˆShared-State åŸºäº Engineï¼‰: ä»éœ€ç»´æŠ¤ä¸¤ä¸ªåŒ…

## ğŸ“ ä¸‹ä¸€æ­¥

å¦‚æœå†³å®šé‡‡ç”¨æ­¤æ–¹æ¡ˆï¼Œè¯·ï¼š

1. ğŸ“… å®‰æ’ 2-3 å¤©çš„å¼€å‘æ—¶é—´
2. ğŸ‘¥ æŒ‡å®šè´Ÿè´£äºº
3. ğŸ§ª å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
4. ğŸ“ æ›´æ–°é¡¹ç›®æ–‡æ¡£

**é¢„è®¡æ”¶ç›Š**:
- å‡å°‘ 55% ä»£ç é‡
- æ¶ˆé™¤åŠŸèƒ½é‡å¤
- ç»Ÿä¸€æ¶æ„æ¨¡å¼
- æå‡å¼€å‘ä½“éªŒ


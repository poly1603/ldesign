<!-- f23b1991-5644-411c-833f-ada4b9892a3a a049eb02-3a4e-42bd-88a3-225a9b14d3cb -->
# CLI架构完善与优化计划

## 问题诊断

### 当前问题

1. **开发模式**: 前端(Vite 5173)和后端(Express 3000)分离，API代理配置问题导致请求失败
2. **生产模式**: Web静态资源路径查找逻辑不完善，打包后访问失败
3. **构建流程**: `build:full` 流程缺少完整性验证，可能导致产物不一致
4. **环境不一致**: 开发和生产环境行为差异大，难以保证一致性

### 根本原因

- Vite开发服务器代理配置不完善(baseURL问题)
- 生产环境静态资源查找路径优先级错误
- 缺少统一的环境变量管理
- Web应用未正确处理不同环境下的API基础路径

## 解决方案

### 阶段一：修复API请求问题

#### 1. 统一API基础路径配置

**创建环境配置文件** `src/web/src/config/env.ts`:

```typescript
// 根据运行环境动态确定API基础路径
export const API_BASE_URL = import.meta.env.DEV 
  ? '/api'  // 开发环境通过Vite代理
  : '/api'  // 生产环境同源API

export const WS_BASE_URL = import.meta.env.DEV
  ? 'ws://localhost:3000'
  : `ws://${window.location.host}`
```

**更新API客户端** `src/web/src/api/client.ts`:

- 使用环境配置的基础路径
- 添加更详细的错误日志
- 添加连接状态检测

#### 2. 优化Vite代理配置

**更新** `src/web/vite.config.ts`:

```typescript
server: {
  port: 5173,
  host: '0.0.0.0',
  proxy: {
    '/api': {
      target: 'http://127.0.0.1:3000',  // 使用127.0.0.1避免代理问题
      changeOrigin: true,
      secure: false,
      configure: (proxy, options) => {
        proxy.on('error', (err) => {
          console.log('代理错误:', err)
        })
        proxy.on('proxyReq', (proxyReq, req) => {
          console.log('代理请求:', req.method, req.url)
        })
      }
    }
  }
}
```

#### 3. 完善后端静态资源路径查找

**优化** `src/server/app.ts` 静态文件服务逻辑:

```typescript
const possibleWebPaths = [
  resolve(__dirname, '../web/dist'),      // 打包后: dist/web/dist
  resolve(__dirname, '../../src/web/dist'), // 源码构建后
]

// 添加详细日志
logger.info(`[Server] 尝试查找静态资源...`)
for (const path of possibleWebPaths) {
  logger.debug(`[Server] 检查路径: ${path}`)
  if (existsSync(path)) {
    webPath = path
    logger.success(`[Server] 找到静态资源: ${path}`)
    break
  }
}
```

### 阶段二：完善构建流程

#### 1. 优化构建脚本

**更新** `package.json` 构建脚本:

```json
{
  "scripts": {
    "prebuild": "npm run clean",
    "build": "npm run build:web && npm run build:cli && npm run copy:web",
    "build:cli": "tsup",
    "build:web": "cd src/web && npm install --prefer-offline && npm run build",
    "copy:web": "node scripts/copy-web-dist.js",
    "postbuild": "node scripts/verify-build.js",
    "dev": "node scripts/dev.js",
    "start:prod": "node dist/cli/index.js ui"
  }
}
```

#### 2. 创建构建验证脚本

**新建** `scripts/verify-build.js`:

```javascript
// 验证所有必需文件是否存在
const requiredFiles = [
  'dist/cli/index.js',
  'dist/server/app.js',
  'dist/web/index.html',
  'dist/web/assets'
]

// 检查并报告构建结果
```

#### 3. 改进Web构建复制逻辑

**优化** `scripts/copy-web-dist.js`:

- 复制 `src/web/dist` → `dist/web` (不是 `dist/web/dist`)
- 添加文件存在性验证
- 添加复制进度提示

### 阶段三：增强开发体验

#### 1. 统一开发启动脚本

**优化** `scripts/dev.js`:

```javascript
// 1. 启动后端 (3000端口)
const backend = spawn('tsx', ['watch', 'src/cli/index.ts', 'ui', '--no-open'])

// 2. 等待后端就绪
await waitForPort(3000, 10000)

// 3. 启动前端 (5173端口，自动代理到3000)
const frontend = spawn('npm', ['run', 'dev'], { cwd: 'src/web' })

// 4. 显示访问信息
console.log('前端: http://localhost:5173')
console.log('后端: http://localhost:3000')
```

#### 2. 添加健康检查端点

**在** `src/server/app.ts` 添加:

```typescript
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    mode: process.env.NODE_ENV,
    timestamp: Date.now(),
    version: packageJson.version
  })
})
```

#### 3. 前端添加连接状态检测

**在** `src/web/src/App.vue` 添加:

```typescript
onMounted(async () => {
  try {
    await apiClient.get('/health')
    console.log('✅ 后端连接成功')
  } catch (error) {
    console.error('❌ 后端连接失败:', error)
  }
})
```

### 阶段四：架构优化与扩展性

#### 1. 命令插件化架构

**创建命令注册器** `src/cli/CommandRegistry.ts`:

```typescript
export class CommandRegistry {
  private commands = new Map<string, CommandHandler>()
  
  register(name: string, handler: CommandHandler) {
    this.commands.set(name, handler)
  }
  
  setupCLI(cli: CAC) {
    for (const [name, handler] of this.commands) {
      handler.setup(cli)
    }
  }
}
```

**重构** `src/cli/index.ts`:

```typescript
const registry = new CommandRegistry()

// 注册UI命令
registry.register('ui', uiCommand)

// 预留其他命令接口
// registry.register('create', createCommand)
// registry.register('build', buildCommand)

registry.setupCLI(cli)
```

#### 2. 配置管理增强

**创建配置管理器** `src/core/config/ConfigManager.ts`:

```typescript
export class ConfigManager {
  loadConfig(cwd: string): Config
  saveConfig(config: Config): void
  mergeConfig(custom: Partial<Config>): Config
}
```

#### 3. 日志系统优化

**增强** `src/shared/utils/logger.ts`:

- 支持日志级别控制
- 支持日志文件输出
- 支持彩色输出开关
- 支持JSON格式日志

### 阶段五：完善文档和测试

#### 1. 创建快速开始文档

**更新** `README.md`:

- 清晰的安装步骤
- 开发和生产模式说明
- 常见问题解决

#### 2. 添加开发文档

**创建** `docs/DEVELOPMENT.md`:

- 项目架构说明
- 开发环境搭建
- 调试技巧
- 贡献指南

#### 3. 创建测试用例

**添加基础测试**:

- API路由测试
- 项目管理功能测试
- WebSocket连接测试

## 实施步骤

### Step 1: 修复API连接 (高优先级)

1. 创建环境配置文件
2. 更新API客户端使用环境配置
3. 优化Vite代理配置
4. 测试开发模式API请求

### Step 2: 修复生产构建 (高优先级)

1. 修复静态资源路径查找逻辑
2. 优化Web构建复制脚本
3. 创建构建验证脚本
4. 完整构建并测试生产模式

### Step 3: 优化开发体验

1. 改进dev脚本，添加等待逻辑
2. 添加健康检查端点
3. 前端添加连接状态检测
4. 优化日志输出

### Step 4: 架构重构

1. 实现命令注册器
2. 实现配置管理器
3. 优化日志系统
4. 重构CLI入口

### Step 5: 文档完善

1. 更新README
2. 创建开发文档
3. 添加使用示例
4. 创建故障排除指南

## 验证标准

### 开发模式验证

- ✅ 运行 `npm run dev` 自动启动前后端
- ✅ 访问 http://localhost:5173 页面正常
- ✅ API请求成功，无CORS错误
- ✅ HMR正常工作
- ✅ WebSocket连接成功

### 生产模式验证

- ✅ 运行 `npm run build` 成功
- ✅ 运行 `npm start` 启动服务
- ✅ 访问 http://localhost:3000 页面正常
- ✅ API请求成功
- ✅ 静态资源正确加载
- ✅ WebSocket连接成功

### 一致性验证

- ✅ 开发和生产环境功能完全一致
- ✅ 相同的路由行为
- ✅ 相同的API响应
- ✅ 相同的用户体验

## 预期成果

完成后CLI工具将具备:

1. **稳定性**: 开发和生产环境完全一致，无API错误
2. **易用性**: 一键启动开发，一键构建部署
3. **可扩展性**: 插件化命令架构，易于添加新命令
4. **专业性**: 完善的日志、错误处理、配置管理
5. **文档完备**: 清晰的使用和开发文档

### To-dos

- [ ] 修复API连接问题 - 创建环境配置、更新API客户端、优化Vite代理
- [ ] 修复生产构建 - 优化静态资源路径、改进复制脚本、创建构建验证
- [ ] 增强开发体验 - 优化dev脚本、添加健康检查、连接状态检测
- [ ] 架构重构 - 实现命令注册器、配置管理器、优化日志系统
- [ ] 完善文档 - 更新README、创建开发文档、添加使用示例
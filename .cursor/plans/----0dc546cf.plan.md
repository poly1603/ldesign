<!-- 0dc546cf-941f-40fd-a930-651bc5fe6407 9ee1db0a-9b76-49b3-9555-fac5485c4d3f -->
# 菜单优化与联动修复计划

## 问题分析

### 1. 联动问题

- ❌ 点击菜单不能创建/激活页签
- ❌ 切换页签不能选中菜单
- ❌ 父级菜单不能自动展开
- ❌ 刷新页面状态丢失

### 2. 样式问题

- ❌ 菜单样式简陋
- ❌ 缺少悬停效果
- ❌ 展开/收起没有动画
- ❌ 激活状态不明显

### 3. 功能问题

- ❌ MenuItem 组件可能未正确导出
- ❌ CSS 样式未正确应用
- ❌ 事件传递可能有问题

## 解决方案

### 阶段一：修复 Vue 组件渲染

#### 1. 确保 MenuItem.vue 正确导出

- 检查 `vue/components/index.ts` 导出
- 检查 `vue/index.ts` 导出链
- 重新构建确保文件生成

#### 2. 优化 Menu.vue 组件

- 使用 `<MenuItem>` 递归渲染
- 正确传递 props 和 events
- 支持默认展开和激活

### 阶段二：完善菜单样式

#### 1. 增强 base.css

```css
/* 添加过渡效果 */
.ldesign-menu-item__content {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 悬停效果 */
.ldesign-menu-item__content:hover {
  background: var(--color-bg-component-hover);
  transform: translateX(2px);
}

/* 激活状态 */
.ldesign-menu-item--active > .ldesign-menu-item__content {
  background: var(--color-primary-lighter);
  color: var(--color-primary-default);
  border-left: 3px solid var(--color-primary-default);
}
```

#### 2. 添加展开/收起动画

```css
.ldesign-menu-submenu {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  opacity: 0;
}

.ldesign-menu-item--expanded > .ldesign-menu-submenu {
  max-height: 1000px;
  opacity: 1;
}
```

#### 3. 箭头旋转动画

```css
.ldesign-menu-item__arrow {
  transition: transform 0.3s ease;
}

.ldesign-menu-item--expanded .ldesign-menu-item__arrow {
  transform: rotate(90deg);
}
```

### 阶段三：实现菜单与页签联动

#### 1. NavigationMenu.vue 增强

```vue
<script setup>
import { watch, nextTick } from 'vue'

// 监听当前路径，同步到菜单
watch(() => props.currentPath, async (newPath) => {
  if (!newPath || !menuRef.value) return
  
  await nextTick()
  
  // 1. 选中当前菜单项
  menuRef.value.selectItem(newPath)
  
  // 2. 展开所有父级菜单
  const parents = expandedKeys.value
  for (const key of parents) {
    menuRef.value.expand(key)
  }
}, { immediate: true, flush: 'post' })
</script>
```

#### 2. MainLayout.vue 传递 currentPath

```vue
<AppSidebar 
  :is-logged-in="isLoggedIn" 
  :t="t"
  :current-path="route.path"  <!-- 新增 -->
/>
```

#### 3. AppSidebar.vue 传递路径

```vue
<NavigationMenu 
  :items="menuItems" 
  :is-logged-in="isLoggedIn"
  :current-path="currentPath"  <!-- 传递给 NavigationMenu -->
/>
```

### 阶段四：优化交互体验

#### 1. 添加加载状态

```vue
<Transition name="fade">
  <div v-if="loading" class="menu-loading">
    加载中...
  </div>
</Transition>
```

#### 2. 添加空状态

```vue
<div v-if="!items.length" class="menu-empty">
  暂无菜单
</div>
```

#### 3. 添加折叠按钮

```vue
<button class="menu-collapse-btn" @click="toggleCollapsed">
  <span>{{ collapsed ? '展开' : '收起' }}</span>
</button>
```

### 阶段五：重新构建和测试

#### 1. 构建菜单包

```bash
cd packages/menu
pnpm run build
```

#### 2. 复制 CSS 文件

```bash
Copy-Item src/styles/* es/styles/ -Recurse
Copy-Item src/styles/* lib/styles/ -Recurse
```

#### 3. 重启应用测试联动

## 关键代码实现

### MenuItem.vue (优化版)

```vue
<template>
  <li class="ldesign-menu-item" :class="itemClasses">
    <div 
      class="ldesign-menu-item__content"
      :style="contentStyle"
      @click="handleClick"
    >
      <span v-if="showIcon" class="ldesign-menu-item__icon">
        {{ item.icon }}
      </span>
      <span v-if="showLabel" class="ldesign-menu-item__label">
        {{ item.label }}
      </span>
      <span v-if="hasChildren && showLabel" class="ldesign-menu-item__arrow">
        ▶
      </span>
    </div>
    
    <!-- 递归渲染子菜单 -->
    <Transition name="submenu-expand">
      <ul v-if="hasChildren && isExpanded" class="ldesign-menu-submenu">
        <MenuItem
          v-for="child in item.children"
          :key="child.id"
          :item="child"
          :level="level + 1"
          :active-key="activeKey"
          :expanded-keys="expandedKeys"
          @select="$emit('select', $event)"
          @expand="$emit('expand', $event)"
          @collapse="$emit('collapse', $event)"
        />
      </ul>
    </Transition>
  </li>
</template>
```

### NavigationMenu.vue (联动逻辑)

```vue
<script setup>
// 智能查找父级路径
const expandedKeys = computed(() => {
  if (!props.currentPath) return []
  
  const findParents = (items, targetPath, parents = []) => {
    for (const item of items) {
      if (item.path === targetPath) {
        return parents
      }
      if (item.children) {
        const found = findParents(
          item.children, 
          targetPath, 
          [...parents, item.path]
        )
        if (found) return found
      }
    }
    return []
  }
  
  return findParents(props.items, props.currentPath)
})
</script>
```

## 预期效果

### 联动效果

- ✅ 点击菜单 → 页签自动创建/激活
- ✅ 切换页签 → 菜单自动选中
- ✅ 父级菜单自动展开
- ✅ 状态持久化

### 视觉效果

- ✅ 流畅的展开/收起动画
- ✅ 明显的悬停反馈
- ✅ 清晰的激活状态
- ✅ 优雅的过渡效果

### 性能

- ✅ 动画 60fps
- ✅ 响应时间 < 100ms
- ✅ 无卡顿

## 测试场景

1. 点击 "功能演示" → 展开动画流畅
2. 点击 "加密演示" → 创建页签，菜单保持选中
3. 点击 "HTTP 演示" 页签 → 菜单自动选中
4. 刷新页面 → 菜单和页签状态恢复
5. 鼠标悬停菜单项 → 背景色平滑过渡

### To-dos

- [ ] 创建菜单包基础结构（package.json、tsconfig、目录）
- [ ] 定义核心类型系统（MenuItem、MenuConfig、Events）
- [ ] 实现 MenuManager 核心管理器
- [ ] 实现 LayoutEngine 布局引擎（横向/纵向/收起模式）
- [ ] 实现 PopupManager 弹出层管理（定位、堆叠、边界检测）
- [ ] 实现 AnimationController 动画控制器（WAAPI + CSS变量）
- [ ] 实现事件委托和键盘导航
- [ ] 实现虚拟滚动优化
- [ ] 实现工具函数（树形处理、定位计算、DOM操作）
- [ ] 实现样式系统（CSS变量、主题、动画）
- [ ] 实现 Vue3 组件封装
- [ ] 实现 Vue3 Composables
- [ ] 实现 React 组件封装
- [ ] 实现 React Hooks
- [ ] 创建使用示例（原生、Vue、React）
- [ ] 编写单元测试和集成测试（可选扩展，核心功能已完成）
- [ ] 编写文档（README、API文档、示例）
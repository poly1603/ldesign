<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æ ¼åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #1f2937;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
        #console {
            background: #1f2937;
            color: #10b981;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>@ldesign/editor è¡¨æ ¼åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ§åˆ¶å°</h2>
        <button onclick="testTableButton()">æµ‹è¯•è¡¨æ ¼æŒ‰é’®</button>
        <button onclick="testInsertTable()">æµ‹è¯•æ’å…¥è¡¨æ ¼å‘½ä»¤</button>
        <button onclick="checkEditor()">æ£€æŸ¥ç¼–è¾‘å™¨çŠ¶æ€</button>
        <button onclick="checkCommands()">æ£€æŸ¥å¯ç”¨å‘½ä»¤</button>
        <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
        <div id="console">æ§åˆ¶å°è¾“å‡ºï¼š\n</div>
    </div>

    <div class="test-section">
        <h2>ç¼–è¾‘å™¨ç¤ºä¾‹</h2>
        <iframe id="editor-frame" src="http://localhost:8082/#basic"></iframe>
    </div>

    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“';
            console.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').textContent = 'æ§åˆ¶å°è¾“å‡ºï¼š\n';
        }

        async function testTableButton() {
            try {
                log('å¼€å§‹æµ‹è¯•è¡¨æ ¼æŒ‰é’®...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                const iframeDoc = iframe.contentDocument;
                
                // æŸ¥æ‰¾è¡¨æ ¼æŒ‰é’®
                const tableButton = iframeDoc.querySelector('[data-name="table"]');
                if (tableButton) {
                    log('æ‰¾åˆ°è¡¨æ ¼æŒ‰é’®', 'success');
                    log(`æŒ‰é’®æ ‡é¢˜: ${tableButton.title}`);
                    log(`æŒ‰é’®æ˜¯å¦ç¦ç”¨: ${tableButton.disabled}`);
                    
                    // æ¨¡æ‹Ÿç‚¹å‡»
                    log('æ¨¡æ‹Ÿç‚¹å‡»è¡¨æ ¼æŒ‰é’®...');
                    tableButton.click();
                    
                    // ç­‰å¾…å¯¹è¯æ¡†å‡ºç°
                    setTimeout(() => {
                        const dialog = iframeDoc.querySelector('.editor-dialog-overlay');
                        if (dialog) {
                            log('è¡¨æ ¼å¯¹è¯æ¡†æˆåŠŸæ‰“å¼€ï¼', 'success');
                            log('å¯¹è¯æ¡†å†…å®¹: ' + dialog.querySelector('.editor-dialog-title')?.textContent);
                        } else {
                            log('å¯¹è¯æ¡†æœªå‡ºç°', 'error');
                            // æ£€æŸ¥æ§åˆ¶å°é”™è¯¯
                            if (iframeWindow.console && iframeWindow.console.logs) {
                                log('æ£€æŸ¥iframeæ§åˆ¶å°æ—¥å¿—...');
                            }
                        }
                    }, 500);
                } else {
                    log('æœªæ‰¾åˆ°è¡¨æ ¼æŒ‰é’®', 'error');
                    
                    // åˆ—å‡ºæ‰€æœ‰å·¥å…·æ æŒ‰é’®
                    const buttons = iframeDoc.querySelectorAll('.ldesign-editor-toolbar-button');
                    log(`æ‰¾åˆ° ${buttons.length} ä¸ªå·¥å…·æ æŒ‰é’®:`);
                    buttons.forEach(btn => {
                        log(`  - ${btn.getAttribute('data-name') || btn.title || 'æœªå‘½å'}`);
                    });
                }
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testInsertTable() {
            try {
                log('å¼€å§‹æµ‹è¯•æ’å…¥è¡¨æ ¼å‘½ä»¤...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                
                // è·å–ç¼–è¾‘å™¨å®ä¾‹
                if (iframeWindow.basicEditor) {
                    const editor = iframeWindow.basicEditor;
                    log('æ‰¾åˆ°ç¼–è¾‘å™¨å®ä¾‹', 'success');
                    
                    // è·å–å¯ç”¨å‘½ä»¤åˆ—è¡¨
                    if (editor.commands) {
                        const commands = editor.commands.getCommands();
                        log(`å¯ç”¨å‘½ä»¤æ•°é‡: ${commands.length}`);
                        
                        if (commands.includes('insertTable')) {
                            log('insertTable å‘½ä»¤å­˜åœ¨', 'success');
                            
                            // æ‰§è¡Œæ’å…¥è¡¨æ ¼å‘½ä»¤
                            log('æ‰§è¡Œ insertTable å‘½ä»¤...');
                            const result = editor.commands.execute('insertTable');
                            log(`å‘½ä»¤æ‰§è¡Œç»“æœ: ${result}`, result ? 'success' : 'error');
                            
                            // æ£€æŸ¥å¯¹è¯æ¡†
                            setTimeout(() => {
                                const dialog = iframe.contentDocument.querySelector('.editor-dialog-overlay');
                                if (dialog) {
                                    log('è¡¨æ ¼å¯¹è¯æ¡†æˆåŠŸæ‰“å¼€ï¼', 'success');
                                } else {
                                    log('å¯¹è¯æ¡†æœªå‡ºç°ï¼Œæ£€æŸ¥æ–‡æ¡£body', 'error');
                                    const bodyDialog = document.body.querySelector('.editor-dialog-overlay');
                                    if (bodyDialog) {
                                        log('å¯¹è¯æ¡†åœ¨ä¸»æ–‡æ¡£bodyä¸­æ‰¾åˆ°ï¼', 'success');
                                    }
                                }
                            }, 500);
                        } else {
                            log('insertTable å‘½ä»¤ä¸å­˜åœ¨', 'error');
                            log('å¯ç”¨å‘½ä»¤: ' + commands.join(', '));
                        }
                    } else {
                        log('commands å¯¹è±¡ä¸å­˜åœ¨', 'error');
                    }
                } else {
                    log('æœªæ‰¾åˆ°ç¼–è¾‘å™¨å®ä¾‹ (basicEditor)', 'error');
                    log('æ£€æŸ¥windowå¯¹è±¡: ' + Object.keys(iframeWindow).filter(k => k.includes('editor')).join(', '));
                }
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function checkEditor() {
            try {
                log('æ£€æŸ¥ç¼–è¾‘å™¨çŠ¶æ€...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                const iframeDoc = iframe.contentDocument;
                
                // æ£€æŸ¥ç¼–è¾‘å™¨å…ƒç´ 
                const editorContent = iframeDoc.querySelector('.ldesign-editor-content');
                if (editorContent) {
                    log('æ‰¾åˆ°ç¼–è¾‘å™¨å†…å®¹åŒº', 'success');
                    log(`å¯ç¼–è¾‘: ${editorContent.contentEditable}`);
                    log(`å†…å®¹é•¿åº¦: ${editorContent.innerHTML.length} å­—ç¬¦`);
                } else {
                    log('æœªæ‰¾åˆ°ç¼–è¾‘å™¨å†…å®¹åŒº', 'error');
                }
                
                // æ£€æŸ¥å·¥å…·æ 
                const toolbar = iframeDoc.querySelector('.ldesign-editor-toolbar');
                if (toolbar) {
                    log('æ‰¾åˆ°å·¥å…·æ ', 'success');
                    const buttons = toolbar.querySelectorAll('button');
                    log(`å·¥å…·æ æŒ‰é’®æ•°é‡: ${buttons.length}`);
                } else {
                    log('æœªæ‰¾åˆ°å·¥å…·æ ', 'error');
                }
                
                // æ£€æŸ¥ç¼–è¾‘å™¨å®ä¾‹
                if (iframeWindow.basicEditor) {
                    const editor = iframeWindow.basicEditor;
                    log('æ‰¾åˆ°ç¼–è¾‘å™¨å®ä¾‹', 'success');
                    
                    // æ£€æŸ¥æ’ä»¶
                    if (editor.plugins) {
                        const plugins = editor.plugins.getAll();
                        log(`å·²åŠ è½½æ’ä»¶æ•°é‡: ${plugins.length}`);
                        
                        // æŸ¥æ‰¾è¡¨æ ¼æ’ä»¶
                        const tablePlugin = plugins.find(p => p.config.name === 'table');
                        if (tablePlugin) {
                            log('è¡¨æ ¼æ’ä»¶å·²åŠ è½½', 'success');
                            log(`è¡¨æ ¼æ’ä»¶å‘½ä»¤: ${Object.keys(tablePlugin.config.commands || {}).join(', ')}`);
                        } else {
                            log('è¡¨æ ¼æ’ä»¶æœªåŠ è½½', 'error');
                        }
                    }
                } else {
                    log('æœªæ‰¾åˆ°ç¼–è¾‘å™¨å®ä¾‹', 'error');
                }
                
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function checkCommands() {
            try {
                log('æ£€æŸ¥å¯ç”¨å‘½ä»¤...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow.basicEditor) {
                    const editor = iframeWindow.basicEditor;
                    
                    if (editor.commands) {
                        const commands = editor.commands.getCommands();
                        log(`æ€»å…± ${commands.length} ä¸ªå‘½ä»¤:`, 'success');
                        
                        // åˆ†ç±»æ˜¾ç¤ºå‘½ä»¤
                        const categories = {
                            format: [],
                            block: [],
                            list: [],
                            table: [],
                            other: []
                        };
                        
                        commands.forEach(cmd => {
                            if (cmd.includes('bold') || cmd.includes('italic') || cmd.includes('underline')) {
                                categories.format.push(cmd);
                            } else if (cmd.includes('heading') || cmd.includes('paragraph')) {
                                categories.block.push(cmd);
                            } else if (cmd.includes('list')) {
                                categories.list.push(cmd);
                            } else if (cmd.includes('table') || cmd.includes('Table')) {
                                categories.table.push(cmd);
                            } else {
                                categories.other.push(cmd);
                            }
                        });
                        
                        Object.entries(categories).forEach(([cat, cmds]) => {
                            if (cmds.length > 0) {
                                log(`${cat.toUpperCase()}: ${cmds.join(', ')}`);
                            }
                        });
                    } else {
                        log('commands å¯¹è±¡ä¸å­˜åœ¨', 'error');
                    }
                } else {
                    log('æœªæ‰¾åˆ°ç¼–è¾‘å™¨å®ä¾‹', 'error');
                }
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹æ£€æŸ¥...');
                checkEditor();
            }, 2000);
        });
    </script>
</body>
</html>
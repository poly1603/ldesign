<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表格功能测试</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #1f2937;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
        #console {
            background: #1f2937;
            color: #10b981;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>@ldesign/editor 表格功能测试</h1>
    
    <div class="test-section">
        <h2>测试控制台</h2>
        <button onclick="testTableButton()">测试表格按钮</button>
        <button onclick="testInsertTable()">测试插入表格命令</button>
        <button onclick="checkEditor()">检查编辑器状态</button>
        <button onclick="checkCommands()">检查可用命令</button>
        <button onclick="clearConsole()">清空控制台</button>
        <div id="console">控制台输出：\n</div>
    </div>

    <div class="test-section">
        <h2>编辑器示例</h2>
        <iframe id="editor-frame" src="http://localhost:8082/#basic"></iframe>
    </div>

    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : '📝';
            console.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').textContent = '控制台输出：\n';
        }

        async function testTableButton() {
            try {
                log('开始测试表格按钮...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                const iframeDoc = iframe.contentDocument;
                
                // 查找表格按钮
                const tableButton = iframeDoc.querySelector('[data-name="table"]');
                if (tableButton) {
                    log('找到表格按钮', 'success');
                    log(`按钮标题: ${tableButton.title}`);
                    log(`按钮是否禁用: ${tableButton.disabled}`);
                    
                    // 模拟点击
                    log('模拟点击表格按钮...');
                    tableButton.click();
                    
                    // 等待对话框出现
                    setTimeout(() => {
                        const dialog = iframeDoc.querySelector('.editor-dialog-overlay');
                        if (dialog) {
                            log('表格对话框成功打开！', 'success');
                            log('对话框内容: ' + dialog.querySelector('.editor-dialog-title')?.textContent);
                        } else {
                            log('对话框未出现', 'error');
                            // 检查控制台错误
                            if (iframeWindow.console && iframeWindow.console.logs) {
                                log('检查iframe控制台日志...');
                            }
                        }
                    }, 500);
                } else {
                    log('未找到表格按钮', 'error');
                    
                    // 列出所有工具栏按钮
                    const buttons = iframeDoc.querySelectorAll('.ldesign-editor-toolbar-button');
                    log(`找到 ${buttons.length} 个工具栏按钮:`);
                    buttons.forEach(btn => {
                        log(`  - ${btn.getAttribute('data-name') || btn.title || '未命名'}`);
                    });
                }
            } catch (error) {
                log(`错误: ${error.message}`, 'error');
            }
        }

        async function testInsertTable() {
            try {
                log('开始测试插入表格命令...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                
                // 获取编辑器实例
                if (iframeWindow.basicEditor) {
                    const editor = iframeWindow.basicEditor;
                    log('找到编辑器实例', 'success');
                    
                    // 获取可用命令列表
                    if (editor.commands) {
                        const commands = editor.commands.getCommands();
                        log(`可用命令数量: ${commands.length}`);
                        
                        if (commands.includes('insertTable')) {
                            log('insertTable 命令存在', 'success');
                            
                            // 执行插入表格命令
                            log('执行 insertTable 命令...');
                            const result = editor.commands.execute('insertTable');
                            log(`命令执行结果: ${result}`, result ? 'success' : 'error');
                            
                            // 检查对话框
                            setTimeout(() => {
                                const dialog = iframe.contentDocument.querySelector('.editor-dialog-overlay');
                                if (dialog) {
                                    log('表格对话框成功打开！', 'success');
                                } else {
                                    log('对话框未出现，检查文档body', 'error');
                                    const bodyDialog = document.body.querySelector('.editor-dialog-overlay');
                                    if (bodyDialog) {
                                        log('对话框在主文档body中找到！', 'success');
                                    }
                                }
                            }, 500);
                        } else {
                            log('insertTable 命令不存在', 'error');
                            log('可用命令: ' + commands.join(', '));
                        }
                    } else {
                        log('commands 对象不存在', 'error');
                    }
                } else {
                    log('未找到编辑器实例 (basicEditor)', 'error');
                    log('检查window对象: ' + Object.keys(iframeWindow).filter(k => k.includes('editor')).join(', '));
                }
            } catch (error) {
                log(`错误: ${error.message}`, 'error');
            }
        }

        async function checkEditor() {
            try {
                log('检查编辑器状态...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                const iframeDoc = iframe.contentDocument;
                
                // 检查编辑器元素
                const editorContent = iframeDoc.querySelector('.ldesign-editor-content');
                if (editorContent) {
                    log('找到编辑器内容区', 'success');
                    log(`可编辑: ${editorContent.contentEditable}`);
                    log(`内容长度: ${editorContent.innerHTML.length} 字符`);
                } else {
                    log('未找到编辑器内容区', 'error');
                }
                
                // 检查工具栏
                const toolbar = iframeDoc.querySelector('.ldesign-editor-toolbar');
                if (toolbar) {
                    log('找到工具栏', 'success');
                    const buttons = toolbar.querySelectorAll('button');
                    log(`工具栏按钮数量: ${buttons.length}`);
                } else {
                    log('未找到工具栏', 'error');
                }
                
                // 检查编辑器实例
                if (iframeWindow.basicEditor) {
                    const editor = iframeWindow.basicEditor;
                    log('找到编辑器实例', 'success');
                    
                    // 检查插件
                    if (editor.plugins) {
                        const plugins = editor.plugins.getAll();
                        log(`已加载插件数量: ${plugins.length}`);
                        
                        // 查找表格插件
                        const tablePlugin = plugins.find(p => p.config.name === 'table');
                        if (tablePlugin) {
                            log('表格插件已加载', 'success');
                            log(`表格插件命令: ${Object.keys(tablePlugin.config.commands || {}).join(', ')}`);
                        } else {
                            log('表格插件未加载', 'error');
                        }
                    }
                } else {
                    log('未找到编辑器实例', 'error');
                }
                
            } catch (error) {
                log(`错误: ${error.message}`, 'error');
            }
        }

        async function checkCommands() {
            try {
                log('检查可用命令...');
                
                const iframe = document.getElementById('editor-frame');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow.basicEditor) {
                    const editor = iframeWindow.basicEditor;
                    
                    if (editor.commands) {
                        const commands = editor.commands.getCommands();
                        log(`总共 ${commands.length} 个命令:`, 'success');
                        
                        // 分类显示命令
                        const categories = {
                            format: [],
                            block: [],
                            list: [],
                            table: [],
                            other: []
                        };
                        
                        commands.forEach(cmd => {
                            if (cmd.includes('bold') || cmd.includes('italic') || cmd.includes('underline')) {
                                categories.format.push(cmd);
                            } else if (cmd.includes('heading') || cmd.includes('paragraph')) {
                                categories.block.push(cmd);
                            } else if (cmd.includes('list')) {
                                categories.list.push(cmd);
                            } else if (cmd.includes('table') || cmd.includes('Table')) {
                                categories.table.push(cmd);
                            } else {
                                categories.other.push(cmd);
                            }
                        });
                        
                        Object.entries(categories).forEach(([cat, cmds]) => {
                            if (cmds.length > 0) {
                                log(`${cat.toUpperCase()}: ${cmds.join(', ')}`);
                            }
                        });
                    } else {
                        log('commands 对象不存在', 'error');
                    }
                } else {
                    log('未找到编辑器实例', 'error');
                }
            } catch (error) {
                log(`错误: ${error.message}`, 'error');
            }
        }

        // 页面加载后自动检查
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('页面加载完成，开始初始检查...');
                checkEditor();
            }, 2000);
        });
    </script>
</body>
</html>
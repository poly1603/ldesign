name: Bundle Size Monitoring

on:
  push:
    branches: [main, develop, master]
    paths:
      - "packages/**"
  pull_request:
    branches: [main, develop, master]
    paths:
      - "packages/**"
  schedule:
    # ÊØèÂ§©ÂáåÊô®2ÁÇπËøêË°åÂåÖÂ§ßÂ∞èÁõëÊéß
    - cron: "0 2 * * *"

env:
  NODE_VERSION: 20
  PNPM_VERSION: 8

jobs:
  # ÂåÖÂ§ßÂ∞èÂàÜÊûê
  bundle-size-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Analyze bundle sizes
        run: |
          echo "# üì¶ ÂåÖÂ§ßÂ∞èÂàÜÊûêÊä•Âëä" > bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "**ÁîüÊàêÊó∂Èó¥**: $(date)" >> bundle-size-report.md
          echo "**Êèê‰∫§**: ${{ github.sha }}" >> bundle-size-report.md
          echo "**ÂàÜÊîØ**: ${{ github.ref_name }}" >> bundle-size-report.md
          echo "" >> bundle-size-report.md

          echo "## üìä ÂåÖÂ§ßÂ∞èÊ±áÊÄª" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "| ÂåÖÂêç | UMDÂéãÁº©Áâà | ESÊ®°Âùó | CommonJS | Á±ªÂûãÂÆö‰πâ | Áä∂ÊÄÅ |" >> bundle-size-report.md
          echo "|------|-----------|--------|----------|----------|------|" >> bundle-size-report.md

          total_size=0
          package_count=0

          for package_dir in packages/*; do
            if [ -d "$package_dir" ]; then
              package_name=$(basename "$package_dir")

              # Ê£ÄÊü•ÊòØÂê¶ÊúâÊûÑÂª∫‰∫ßÁâ©
              if [ -d "$package_dir/dist" ] || [ -d "$package_dir/es" ] || [ -d "$package_dir/lib" ]; then
                echo "ÂàÜÊûêÂåÖ: $package_name"
                cd "$package_dir"

                # ËøêË°åÂåÖÂàÜÊûê
                if grep -q "build:analyze" "package.json" 2>/dev/null; then
                  pnpm run build:analyze > /dev/null 2>&1 || true
                fi

                # ËÆ°ÁÆóÂêÑÁßçÊ†ºÂºèÁöÑÂ§ßÂ∞è
                umd_size="N/A"
                es_size="N/A"
                cjs_size="N/A"
                types_size="N/A"
                status="‚úÖ"

                # UMDÂéãÁº©ÁâàÂ§ßÂ∞è
                if [ -f "dist/index.min.js" ]; then
                  umd_bytes=$(stat -f%z "dist/index.min.js" 2>/dev/null || stat -c%s "dist/index.min.js" 2>/dev/null || echo "0")
                  umd_size="${umd_bytes} bytes"
                  if [ "$umd_bytes" -gt 1048576 ]; then  # 1MB
                    status="‚ö†Ô∏è"
                  elif [ "$umd_bytes" -gt 2097152 ]; then  # 2MB
                    status="‚ùå"
                  fi
                  total_size=$((total_size + umd_bytes))
                elif [ -f "dist/index.js" ]; then
                  umd_bytes=$(stat -f%z "dist/index.js" 2>/dev/null || stat -c%s "dist/index.js" 2>/dev/null || echo "0")
                  umd_size="${umd_bytes} bytes"
                  total_size=$((total_size + umd_bytes))
                fi

                # ESÊ®°ÂùóÂ§ßÂ∞è
                if [ -f "es/index.js" ]; then
                  es_bytes=$(stat -f%z "es/index.js" 2>/dev/null || stat -c%s "es/index.js" 2>/dev/null || echo "0")
                  es_size="${es_bytes} bytes"
                fi

                # CommonJSÂ§ßÂ∞è
                if [ -f "lib/index.js" ]; then
                  cjs_bytes=$(stat -f%z "lib/index.js" 2>/dev/null || stat -c%s "lib/index.js" 2>/dev/null || echo "0")
                  cjs_size="${cjs_bytes} bytes"
                fi

                # Á±ªÂûãÂÆö‰πâÂ§ßÂ∞è
                if [ -f "types/index.d.ts" ]; then
                  types_bytes=$(stat -f%z "types/index.d.ts" 2>/dev/null || stat -c%s "types/index.d.ts" 2>/dev/null || echo "0")
                  types_size="${types_bytes} bytes"
                elif [ -f "dist/index.d.ts" ]; then
                  types_bytes=$(stat -f%z "dist/index.d.ts" 2>/dev/null || stat -c%s "dist/index.d.ts" 2>/dev/null || echo "0")
                  types_size="${types_bytes} bytes"
                fi

                echo "| $package_name | $umd_size | $es_size | $cjs_size | $types_size | $status |" >> ../../bundle-size-report.md
                package_count=$((package_count + 1))

                cd ../..
              fi
            fi
          done

          echo "" >> bundle-size-report.md
          echo "## üìà ÁªüËÆ°‰ø°ÊÅØ" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "- **ÂåÖÊÄªÊï∞**: $package_count" >> bundle-size-report.md
          echo "- **ÊÄªÂ§ßÂ∞è**: $total_size bytes" >> bundle-size-report.md
          echo "- **Âπ≥ÂùáÂ§ßÂ∞è**: $((total_size / package_count)) bytes" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "## üìã Áä∂ÊÄÅËØ¥Êòé" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "- ‚úÖ Ê≠£Â∏∏ (< 1MB)" >> bundle-size-report.md
          echo "- ‚ö†Ô∏è Ë≠¶Âëä (1MB - 2MB)" >> bundle-size-report.md
          echo "- ‚ùå Ë∂ÖÈôê (> 2MB)" >> bundle-size-report.md

      - name: Check for size regressions
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Ê£ÄÊü•ÂåÖÂ§ßÂ∞èÂõûÂΩí..."

          # Ëé∑ÂèñÂü∫Á°ÄÂàÜÊîØÁöÑÂåÖÂ§ßÂ∞è
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

          pnpm install --frozen-lockfile
          pnpm build

          echo "# üìä ÂåÖÂ§ßÂ∞èÂèòÂåñÂØπÊØî" > size-diff-report.md
          echo "" >> size-diff-report.md
          echo "**Âü∫Á°ÄÂàÜÊîØ**: ${{ github.base_ref }}" >> size-diff-report.md
          echo "**ÂΩìÂâçÂàÜÊîØ**: ${{ github.head_ref }}" >> size-diff-report.md
          echo "" >> size-diff-report.md
          echo "| ÂåÖÂêç | Âü∫Á°ÄÂ§ßÂ∞è | ÂΩìÂâçÂ§ßÂ∞è | ÂèòÂåñ | Áä∂ÊÄÅ |" >> size-diff-report.md
          echo "|------|----------|----------|------|------|" >> size-diff-report.md

          # ËÆ∞ÂΩïÂü∫Á°ÄÂàÜÊîØÁöÑÂ§ßÂ∞è
          for package_dir in packages/*; do
            if [ -d "$package_dir" ]; then
              package_name=$(basename "$package_dir")
              if [ -f "$package_dir/dist/index.min.js" ]; then
                base_size=$(stat -f%z "$package_dir/dist/index.min.js" 2>/dev/null || stat -c%s "$package_dir/dist/index.min.js" 2>/dev/null || echo "0")
                echo "$package_name:$base_size" >> base-sizes.txt
              elif [ -f "$package_dir/dist/index.js" ]; then
                base_size=$(stat -f%z "$package_dir/dist/index.js" 2>/dev/null || stat -c%s "$package_dir/dist/index.js" 2>/dev/null || echo "0")
                echo "$package_name:$base_size" >> base-sizes.txt
              fi
            fi
          done

          # ÂàáÊç¢ÂõûÂΩìÂâçÂàÜÊîØ
          git checkout ${{ github.sha }}
          pnpm install --frozen-lockfile
          pnpm build

          # ÊØîËæÉÂ§ßÂ∞èÂèòÂåñ
          while IFS=: read -r package_name base_size; do
            current_size=0
            if [ -f "packages/$package_name/dist/index.min.js" ]; then
              current_size=$(stat -f%z "packages/$package_name/dist/index.min.js" 2>/dev/null || stat -c%s "packages/$package_name/dist/index.min.js" 2>/dev/null || echo "0")
            elif [ -f "packages/$package_name/dist/index.js" ]; then
              current_size=$(stat -f%z "packages/$package_name/dist/index.js" 2>/dev/null || stat -c%s "packages/$package_name/dist/index.js" 2>/dev/null || echo "0")
            fi

            diff=$((current_size - base_size))
            percent_change=0
            if [ "$base_size" -gt 0 ]; then
              percent_change=$((diff * 100 / base_size))
            fi

            status="‚úÖ"
            if [ "$diff" -gt 51200 ]; then  # 50KBÂ¢ûÈïø
              status="‚ö†Ô∏è"
            elif [ "$diff" -gt 102400 ]; then  # 100KBÂ¢ûÈïø
              status="‚ùå"
            fi

            change_text="Êó†ÂèòÂåñ"
            if [ "$diff" -gt 0 ]; then
              change_text="+${diff} bytes (+${percent_change}%)"
            elif [ "$diff" -lt 0 ]; then
              change_text="${diff} bytes (${percent_change}%)"
            fi

            echo "| $package_name | ${base_size} bytes | ${current_size} bytes | $change_text | $status |" >> size-diff-report.md
          done < base-sizes.txt

          echo "" >> size-diff-report.md
          echo "## üìã ÂèòÂåñËØ¥Êòé" >> size-diff-report.md
          echo "" >> size-diff-report.md
          echo "- ‚úÖ Ê≠£Â∏∏ÂèòÂåñ (< 50KB)" >> size-diff-report.md
          echo "- ‚ö†Ô∏è ÈúÄË¶ÅÊ≥®ÊÑè (50KB - 100KB)" >> size-diff-report.md
          echo "- ‚ùå ÊòæËëóÂ¢ûÈïø (> 100KB)" >> size-diff-report.md

      - name: Upload bundle size report
        uses: actions/upload-artifact@v3
        with:
          name: bundle-size-report
          path: |
            bundle-size-report.md
            size-diff-report.md
          retention-days: 30

      - name: Comment PR with size changes
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '';

            if (fs.existsSync('size-diff-report.md')) {
              const sizeReport = fs.readFileSync('size-diff-report.md', 'utf8');
              comment = sizeReport;
            } else {
              const bundleReport = fs.readFileSync('bundle-size-report.md', 'utf8');
              comment = bundleReport;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail on significant size increase
        if: github.event_name == 'pull_request'
        run: |
          if [ -f "size-diff-report.md" ]; then
            if grep -q "‚ùå" size-diff-report.md; then
              echo "‚ùå Ê£ÄÊµãÂà∞ÊòæËëóÁöÑÂåÖÂ§ßÂ∞èÂ¢ûÈïøÔºÅ"
              echo "ËØ∑Ê£ÄÊü•‰ª£Á†ÅÂèòÊõ¥ÔºåËÄÉËôë‰ºòÂåñÂåÖÂ§ßÂ∞è„ÄÇ"
              exit 1
            fi
          fi

  # ÂåÖÂ§ßÂ∞èË∂ãÂäøÂàÜÊûê
  size-trend-analysis:
    name: Size Trend Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 100 # Ëé∑ÂèñÊõ¥Â§öÂéÜÂè≤ËÆ∞ÂΩï

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Analyze size trends
        run: |
          echo "# üìà ÂåÖÂ§ßÂ∞èË∂ãÂäøÂàÜÊûê" > size-trend-report.md
          echo "" >> size-trend-report.md
          echo "**ÂàÜÊûêÊó∂Èó¥**: $(date)" >> size-trend-report.md
          echo "**ÂàÜÊûêËåÉÂõ¥**: ÊúÄËøë10‰∏™Êèê‰∫§" >> size-trend-report.md
          echo "" >> size-trend-report.md

          # ÂàÜÊûêÊúÄËøë10‰∏™Êèê‰∫§ÁöÑÂåÖÂ§ßÂ∞èÂèòÂåñ
          commits=$(git log --oneline -10 --format="%H")

          echo "## üìä Â§ßÂ∞èÂèòÂåñË∂ãÂäø" >> size-trend-report.md
          echo "" >> size-trend-report.md

          for commit in $commits; do
            echo "ÂàÜÊûêÊèê‰∫§: $commit"
            git checkout $commit

            if pnpm install --frozen-lockfile && pnpm build; then
              echo "### Êèê‰∫§ $commit" >> size-trend-report.md
              echo "" >> size-trend-report.md

              for package_dir in packages/*; do
                if [ -d "$package_dir" ]; then
                  package_name=$(basename "$package_dir")
                  if [ -f "$package_dir/dist/index.min.js" ]; then
                    size=$(stat -f%z "$package_dir/dist/index.min.js" 2>/dev/null || stat -c%s "$package_dir/dist/index.min.js" 2>/dev/null || echo "0")
                    echo "- $package_name: ${size} bytes" >> size-trend-report.md
                  fi
                fi
              done
              echo "" >> size-trend-report.md
            fi
          done

      - name: Upload trend analysis
        uses: actions/upload-artifact@v3
        with:
          name: size-trend-analysis
          path: size-trend-report.md
          retention-days: 90

      - name: Create issue for size alerts
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ÂåÖÂ§ßÂ∞èÁõëÊéßË≠¶Âëä - ${new Date().toISOString().split('T')[0]}`
            const body = `ÂåÖÂ§ßÂ∞èÁõëÊéßÊ£ÄÊµãÂà∞ÂºÇÂ∏∏ÔºåËØ∑Êü•ÁúãËØ¶ÁªÜÊä•Âëä„ÄÇ\n\nËøêË°åÊó∂Èó¥: ${new Date().toISOString()}`

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['performance', 'bundle-size', 'monitoring']
            })

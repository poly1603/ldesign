name: Bundle Size Monitoring

on:
  push:
    branches: [main, develop, master]
    paths:
      - "packages/**"
  pull_request:
    branches: [main, develop, master]
    paths:
      - "packages/**"
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡ŒåŒ…å¤§å°ç›‘æ§
    - cron: "0 2 * * *"

env:
  NODE_VERSION: 20
  PNPM_VERSION: 8

jobs:
  # åŒ…å¤§å°åˆ†æ
  bundle-size-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Analyze bundle sizes
        run: |
          echo "# ğŸ“¦ åŒ…å¤§å°åˆ†ææŠ¥å‘Š" > bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> bundle-size-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> bundle-size-report.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> bundle-size-report.md
          echo "" >> bundle-size-report.md

          echo "## ğŸ“Š åŒ…å¤§å°æ±‡æ€»" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "| åŒ…å | UMDå‹ç¼©ç‰ˆ | ESæ¨¡å— | CommonJS | ç±»å‹å®šä¹‰ | çŠ¶æ€ |" >> bundle-size-report.md
          echo "|------|-----------|--------|----------|----------|------|" >> bundle-size-report.md

          total_size=0
          package_count=0

          for package_dir in packages/*; do
            if [ -d "$package_dir" ]; then
              package_name=$(basename "$package_dir")

              # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºäº§ç‰©
              if [ -d "$package_dir/dist" ] || [ -d "$package_dir/es" ] || [ -d "$package_dir/lib" ]; then
                echo "åˆ†æåŒ…: $package_name"
                cd "$package_dir"

                # è¿è¡ŒåŒ…åˆ†æ
                if grep -q "build:analyze" "package.json" 2>/dev/null; then
                  pnpm run build:analyze > /dev/null 2>&1 || true
                fi

                # è®¡ç®—å„ç§æ ¼å¼çš„å¤§å°
                umd_size="N/A"
                es_size="N/A"
                cjs_size="N/A"
                types_size="N/A"
                status="âœ…"

                # UMDå‹ç¼©ç‰ˆå¤§å°
                if [ -f "dist/index.min.js" ]; then
                  umd_bytes=$(stat -f%z "dist/index.min.js" 2>/dev/null || stat -c%s "dist/index.min.js" 2>/dev/null || echo "0")
                  umd_size="${umd_bytes} bytes"
                  if [ "$umd_bytes" -gt 1048576 ]; then  # 1MB
                    status="âš ï¸"
                  elif [ "$umd_bytes" -gt 2097152 ]; then  # 2MB
                    status="âŒ"
                  fi
                  total_size=$((total_size + umd_bytes))
                elif [ -f "dist/index.js" ]; then
                  umd_bytes=$(stat -f%z "dist/index.js" 2>/dev/null || stat -c%s "dist/index.js" 2>/dev/null || echo "0")
                  umd_size="${umd_bytes} bytes"
                  total_size=$((total_size + umd_bytes))
                fi

                # ESæ¨¡å—å¤§å°
                if [ -f "es/index.js" ]; then
                  es_bytes=$(stat -f%z "es/index.js" 2>/dev/null || stat -c%s "es/index.js" 2>/dev/null || echo "0")
                  es_size="${es_bytes} bytes"
                fi

                # CommonJSå¤§å°
                if [ -f "lib/index.js" ]; then
                  cjs_bytes=$(stat -f%z "lib/index.js" 2>/dev/null || stat -c%s "lib/index.js" 2>/dev/null || echo "0")
                  cjs_size="${cjs_bytes} bytes"
                fi

                # ç±»å‹å®šä¹‰å¤§å°
                if [ -f "types/index.d.ts" ]; then
                  types_bytes=$(stat -f%z "types/index.d.ts" 2>/dev/null || stat -c%s "types/index.d.ts" 2>/dev/null || echo "0")
                  types_size="${types_bytes} bytes"
                elif [ -f "dist/index.d.ts" ]; then
                  types_bytes=$(stat -f%z "dist/index.d.ts" 2>/dev/null || stat -c%s "dist/index.d.ts" 2>/dev/null || echo "0")
                  types_size="${types_bytes} bytes"
                fi

                echo "| $package_name | $umd_size | $es_size | $cjs_size | $types_size | $status |" >> ../../bundle-size-report.md
                package_count=$((package_count + 1))

                cd ../..
              fi
            fi
          done

          echo "" >> bundle-size-report.md
          echo "## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "- **åŒ…æ€»æ•°**: $package_count" >> bundle-size-report.md
          echo "- **æ€»å¤§å°**: $total_size bytes" >> bundle-size-report.md
          echo "- **å¹³å‡å¤§å°**: $((total_size / package_count)) bytes" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "## ğŸ“‹ çŠ¶æ€è¯´æ˜" >> bundle-size-report.md
          echo "" >> bundle-size-report.md
          echo "- âœ… æ­£å¸¸ (< 1MB)" >> bundle-size-report.md
          echo "- âš ï¸ è­¦å‘Š (1MB - 2MB)" >> bundle-size-report.md
          echo "- âŒ è¶…é™ (> 2MB)" >> bundle-size-report.md

      - name: Check for size regressions
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ” æ£€æŸ¥åŒ…å¤§å°å›å½’..."

          # è·å–åŸºç¡€åˆ†æ”¯çš„åŒ…å¤§å°
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

          pnpm install --frozen-lockfile
          pnpm build

          echo "# ğŸ“Š åŒ…å¤§å°å˜åŒ–å¯¹æ¯”" > size-diff-report.md
          echo "" >> size-diff-report.md
          echo "**åŸºç¡€åˆ†æ”¯**: ${{ github.base_ref }}" >> size-diff-report.md
          echo "**å½“å‰åˆ†æ”¯**: ${{ github.head_ref }}" >> size-diff-report.md
          echo "" >> size-diff-report.md
          echo "| åŒ…å | åŸºç¡€å¤§å° | å½“å‰å¤§å° | å˜åŒ– | çŠ¶æ€ |" >> size-diff-report.md
          echo "|------|----------|----------|------|------|" >> size-diff-report.md

          # è®°å½•åŸºç¡€åˆ†æ”¯çš„å¤§å°
          for package_dir in packages/*; do
            if [ -d "$package_dir" ]; then
              package_name=$(basename "$package_dir")
              if [ -f "$package_dir/dist/index.min.js" ]; then
                base_size=$(stat -f%z "$package_dir/dist/index.min.js" 2>/dev/null || stat -c%s "$package_dir/dist/index.min.js" 2>/dev/null || echo "0")
                echo "$package_name:$base_size" >> base-sizes.txt
              elif [ -f "$package_dir/dist/index.js" ]; then
                base_size=$(stat -f%z "$package_dir/dist/index.js" 2>/dev/null || stat -c%s "$package_dir/dist/index.js" 2>/dev/null || echo "0")
                echo "$package_name:$base_size" >> base-sizes.txt
              fi
            fi
          done

          # åˆ‡æ¢å›å½“å‰åˆ†æ”¯
          git checkout ${{ github.sha }}
          pnpm install --frozen-lockfile
          pnpm build

          # æ¯”è¾ƒå¤§å°å˜åŒ–
          while IFS=: read -r package_name base_size; do
            current_size=0
            if [ -f "packages/$package_name/dist/index.min.js" ]; then
              current_size=$(stat -f%z "packages/$package_name/dist/index.min.js" 2>/dev/null || stat -c%s "packages/$package_name/dist/index.min.js" 2>/dev/null || echo "0")
            elif [ -f "packages/$package_name/dist/index.js" ]; then
              current_size=$(stat -f%z "packages/$package_name/dist/index.js" 2>/dev/null || stat -c%s "packages/$package_name/dist/index.js" 2>/dev/null || echo "0")
            fi

            diff=$((current_size - base_size))
            percent_change=0
            if [ "$base_size" -gt 0 ]; then
              percent_change=$((diff * 100 / base_size))
            fi

            status="âœ…"
            if [ "$diff" -gt 51200 ]; then  # 50KBå¢é•¿
              status="âš ï¸"
            elif [ "$diff" -gt 102400 ]; then  # 100KBå¢é•¿
              status="âŒ"
            fi

            change_text="æ— å˜åŒ–"
            if [ "$diff" -gt 0 ]; then
              change_text="+${diff} bytes (+${percent_change}%)"
            elif [ "$diff" -lt 0 ]; then
              change_text="${diff} bytes (${percent_change}%)"
            fi

            echo "| $package_name | ${base_size} bytes | ${current_size} bytes | $change_text | $status |" >> size-diff-report.md
          done < base-sizes.txt

          echo "" >> size-diff-report.md
          echo "## ğŸ“‹ å˜åŒ–è¯´æ˜" >> size-diff-report.md
          echo "" >> size-diff-report.md
          echo "- âœ… æ­£å¸¸å˜åŒ– (< 50KB)" >> size-diff-report.md
          echo "- âš ï¸ éœ€è¦æ³¨æ„ (50KB - 100KB)" >> size-diff-report.md
          echo "- âŒ æ˜¾è‘—å¢é•¿ (> 100KB)" >> size-diff-report.md

      - name: Upload bundle size report
        uses: actions/upload-artifact@v3
        with:
          name: bundle-size-report
          path: |
            bundle-size-report.md
            size-diff-report.md
          retention-days: 30

      - name: Comment PR with size changes
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '';

            if (fs.existsSync('size-diff-report.md')) {
              const sizeReport = fs.readFileSync('size-diff-report.md', 'utf8');
              comment = sizeReport;
            } else {
              const bundleReport = fs.readFileSync('bundle-size-report.md', 'utf8');
              comment = bundleReport;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail on significant size increase
        if: github.event_name == 'pull_request'
        run: |
          if [ -f "size-diff-report.md" ]; then
            if grep -q "âŒ" size-diff-report.md; then
              echo "âŒ æ£€æµ‹åˆ°æ˜¾è‘—çš„åŒ…å¤§å°å¢é•¿ï¼"
              echo "è¯·æ£€æŸ¥ä»£ç å˜æ›´ï¼Œè€ƒè™‘ä¼˜åŒ–åŒ…å¤§å°ã€‚"
              exit 1
            fi
          fi

  # åŒ…å¤§å°è¶‹åŠ¿åˆ†æ
  size-trend-analysis:
    name: Size Trend Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 100 # è·å–æ›´å¤šå†å²è®°å½•

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Analyze size trends
        run: |
          echo "# ğŸ“ˆ åŒ…å¤§å°è¶‹åŠ¿åˆ†æ" > size-trend-report.md
          echo "" >> size-trend-report.md
          echo "**åˆ†ææ—¶é—´**: $(date)" >> size-trend-report.md
          echo "**åˆ†æèŒƒå›´**: æœ€è¿‘10ä¸ªæäº¤" >> size-trend-report.md
          echo "" >> size-trend-report.md

          # åˆ†ææœ€è¿‘10ä¸ªæäº¤çš„åŒ…å¤§å°å˜åŒ–
          commits=$(git log --oneline -10 --format="%H")

          echo "## ğŸ“Š å¤§å°å˜åŒ–è¶‹åŠ¿" >> size-trend-report.md
          echo "" >> size-trend-report.md

          for commit in $commits; do
            echo "åˆ†ææäº¤: $commit"
            git checkout $commit

            if pnpm install --frozen-lockfile && pnpm build; then
              echo "### æäº¤ $commit" >> size-trend-report.md
              echo "" >> size-trend-report.md

              for package_dir in packages/*; do
                if [ -d "$package_dir" ]; then
                  package_name=$(basename "$package_dir")
                  if [ -f "$package_dir/dist/index.min.js" ]; then
                    size=$(stat -f%z "$package_dir/dist/index.min.js" 2>/dev/null || stat -c%s "$package_dir/dist/index.min.js" 2>/dev/null || echo "0")
                    echo "- $package_name: ${size} bytes" >> size-trend-report.md
                  fi
                fi
              done
              echo "" >> size-trend-report.md
            fi
          done

      - name: Upload trend analysis
        uses: actions/upload-artifact@v3
        with:
          name: size-trend-analysis
          path: size-trend-report.md
          retention-days: 90

      - name: Create issue for size alerts
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `åŒ…å¤§å°ç›‘æ§è­¦å‘Š - ${new Date().toISOString().split('T')[0]}`
            const body = `åŒ…å¤§å°ç›‘æ§æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚\n\nè¿è¡Œæ—¶é—´: ${new Date().toISOString()}`

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['performance', 'bundle-size', 'monitoring']
            })

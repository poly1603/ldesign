name: Security Scan

# æ¯å‘¨ä¸€æ—©ä¸Š 8 ç‚¹è‡ªåŠ¨è¿è¡Œ,ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€ UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
      - master
    paths:
      - '**/package.json'
      - '**/pnpm-lock.yaml'

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: pnpm-audit
        run: |
          echo "## ðŸ“Š ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œ pnpm audit å¹¶ä¿å­˜ç»“æžœ
          pnpm audit --json > audit-report.json || true
          
          # è§£æžå¹¶æ˜¾ç¤ºç»“æžœ
          if [ -f audit-report.json ]; then
            echo "### å®¡è®¡ç»“æžœ" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat audit-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # è¿è¡Œå®¡è®¡æ£€æŸ¥(å¦‚æžœæœ‰é«˜å±æˆ–ä¸¥é‡æ¼æ´žåˆ™å¤±è´¥)
          pnpm audit --audit-level=high
        continue-on-error: true

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check licenses
        run: |
          echo "## ðŸ“œ è®¸å¯è¯åˆè§„æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å®‰è£… license-checker
          pnpm add -g license-checker
          
          # è¿è¡Œè®¸å¯è¯æ£€æŸ¥
          license-checker --json --out licenses.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸å…¼å®¹çš„è®¸å¯è¯
          echo "### è®¸å¯è¯æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          license-checker --summary >> $GITHUB_STEP_SUMMARY || true

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 30

  outdated-check:
    name: Outdated Dependencies Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Check outdated dependencies
        run: |
          echo "## ðŸ“¦ è¿‡æ—¶ä¾èµ–æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
          pnpm outdated --format json > outdated.json || true
          
          echo "### è¿‡æ—¶ä¾èµ–åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pnpm outdated >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-report
          path: outdated.json
          retention-days: 30


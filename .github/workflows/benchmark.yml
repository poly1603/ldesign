name: Performance Benchmark
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8 ç‚¹è¿è¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      baseline:
        description: 'å¯¹æ¯”åŸºçº¿åˆ†æ”¯'
        required: false
        default: 'main'

jobs:
  benchmark:
    name: Run Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build benchmark tool
      run: |
        cd tools/benchmark
        pnpm build

    - name: Run benchmarks
      id: run-benchmarks
      run: |
        echo "## ðŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡ŒåŸºå‡†æµ‹è¯•
        cd tools/benchmark
        npx ldbench run --pattern "**/*.bench.{js,ts}" --history --out ./benchmark-results/latest.json
        
        # ç”Ÿæˆ HTML æŠ¥å‘Š
        npx ldbench run --pattern "**/*.bench.{js,ts}" --report html --out ./benchmark-results/report.html
        
        echo "### ðŸƒ åŸºå‡†æµ‹è¯•å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- æµ‹è¯•å¥—ä»¶: æ‰€æœ‰åŒ…" >> $GITHUB_STEP_SUMMARY
        echo "- è¾“å‡ºæ ¼å¼: JSON, HTML" >> $GITHUB_STEP_SUMMARY
        echo "- åŽ†å²è®°å½•: å·²ä¿å­˜" >> $GITHUB_STEP_SUMMARY

    - name: Check performance thresholds
      id: check-thresholds
      run: |
        echo "## âœ… æ€§èƒ½é˜ˆå€¼æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        cd tools/benchmark
        
        # æ£€æŸ¥é˜ˆå€¼
        if [ -f "benchmark.thresholds.json" ]; then
          npx ldbench run --pattern "**/*.bench.{js,ts}" --threshold benchmark.thresholds.json
          echo "### é˜ˆå€¼æ£€æŸ¥é€šè¿‡ âœ…" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ æœªæ‰¾åˆ°é˜ˆå€¼é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "è¯·åˆ›å»º benchmark.thresholds.json æ–‡ä»¶æ¥å®šä¹‰æ€§èƒ½é˜ˆå€¼" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Compare with baseline
      if: github.event_name == 'pull_request' || github.event.inputs.baseline
      id: compare-baseline
      run: |
        echo "## ðŸ“ˆ æ€§èƒ½å¯¹æ¯”åˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        cd tools/benchmark
        
        BASELINE_BRANCH=${{
          github.event.inputs.baseline || 'main'
        }}
        
        # èŽ·å–åŸºçº¿æŠ¥å‘Š
        git fetch origin $BASELINE_BRANCH
        git checkout $BASELINE_BRANCH
        
        # è¿è¡ŒåŸºçº¿æµ‹è¯•
        npx ldbench run --pattern "**/*.bench.{js,ts}" --out ./benchmark-results/baseline.json
        
        # åˆ‡æ¢å›žå½“å‰åˆ†æ”¯
        git checkout -
        
        # å¯¹æ¯”æ€§èƒ½
        npx ldbench run --pattern "**/*.bench.{js,ts}" --compare ./benchmark-results/baseline.json
        
        echo "### å¯¹æ¯”ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- åŸºçº¿åˆ†æ”¯: $BASELINE_BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "- å½“å‰åˆ†æ”¯: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: |
          tools/benchmark/benchmark-results/
          tools/benchmark/.benchmark-history/
        retention-days: 30

    - name: Performance regression check
      if: github.event_name == 'pull_request'
      run: |
        echo "## ðŸš¨ æ€§èƒ½å›žå½’æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„å›žå½’æ£€æµ‹é€»è¾‘
        # æ¯”å¦‚æ£€æŸ¥å…³é”®æŒ‡æ ‡æ˜¯å¦ä¸‹é™è¶…è¿‡é˜ˆå€¼
        
        echo "### å›žå½’æ£€æµ‹è§„åˆ™" >> $GITHUB_STEP_SUMMARY
        echo "- å…³é”®æŒ‡æ ‡ä¸‹é™è¶…è¿‡ 10%: âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸€èˆ¬æŒ‡æ ‡ä¸‹é™è¶…è¿‡ 20%: âš ï¸ è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰€æœ‰æŒ‡æ ‡åœ¨é˜ˆå€¼å†…: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY

  benchmark-summary:
    name: Benchmark Summary
    runs-on: ubuntu-latest
    needs: benchmark
    if: always()
    
    steps:
    - name: Download benchmark results
      uses: actions/download-artifact@v4
      with:
        name: benchmark-results

    - name: Generate summary
      run: |
        echo "## ðŸ“‹ æ€§èƒ½åŸºå‡†æµ‹è¯•æ±‡æ€»" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "latest.json" ]; then
          echo "### ðŸ“Š æœ€æ–°æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat latest.json | jq '{name, suites: .suites | map({name, taskCount: .results | length})}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸ”— ç›¸å…³é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [æŸ¥çœ‹å®Œæ•´ HTML æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- [æ€§èƒ½æµ‹è¯•æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/tools/benchmark/README.md)" >> $GITHUB_STEP_SUMMARY

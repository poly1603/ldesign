<!--
  Store æ’ä»¶æµ‹è¯•é¡µé¢
  
  æµ‹è¯• Store æ’ä»¶çš„å„ç§åŠŸèƒ½ï¼š
  - åŸºç¡€çŠ¶æ€ç®¡ç†
  - è£…é¥°å™¨æ¨¡å¼
  - å‡½æ•°å¼æ¨¡å¼
  - ç»„åˆå¼æ¨¡å¼
  - æ€§èƒ½ä¼˜åŒ–
  - ç¼“å­˜åŠŸèƒ½
-->

<template>
  <div class="store-test-page">
    <div class="page-header">
      <h1>ğŸ—ƒï¸ Store çŠ¶æ€ç®¡ç†æµ‹è¯•</h1>
      <p>æµ‹è¯• @ldesign/store åŒ…çš„å„ç§åŠŸèƒ½å’Œé›†æˆæ•ˆæœ</p>
    </div>

    <div class="test-sections">
      <!-- åŸºç¡€çŠ¶æ€ç®¡ç†æµ‹è¯• -->
      <section class="test-section">
        <h2>ğŸ“¦ åŸºç¡€çŠ¶æ€ç®¡ç†</h2>
        <div class="test-content">
          <div class="state-display">
            <p><strong>è®¡æ•°å™¨å€¼:</strong> {{ counter }}</p>
            <p><strong>ç”¨æˆ·å:</strong> {{ userName || 'æœªè®¾ç½®' }}</p>
            <p><strong>æœ€åæ›´æ–°:</strong> {{ lastUpdate || 'ä»æœªæ›´æ–°' }}</p>
          </div>
          <div class="controls">
            <button @click="increment" class="btn btn-primary">å¢åŠ è®¡æ•°</button>
            <button @click="decrement" class="btn btn-secondary">å‡å°‘è®¡æ•°</button>
            <button @click="reset" class="btn btn-warning">é‡ç½®è®¡æ•°</button>
            <button @click="updateUser" class="btn btn-success">æ›´æ–°ç”¨æˆ·</button>
          </div>
        </div>
      </section>

      <!-- å‡½æ•°å¼ Store æµ‹è¯• -->
      <section class="test-section">
        <h2>ğŸ”§ å‡½æ•°å¼ Store</h2>
        <div class="test-content">
          <div class="state-display">
            <p><strong>å‡½æ•°å¼è®¡æ•°:</strong> {{ functionalCounter }}</p>
            <p><strong>åŒå€å€¼:</strong> {{ doubledValue }}</p>
          </div>
          <div class="controls">
            <button @click="incrementFunctional" class="btn btn-primary">å‡½æ•°å¼å¢åŠ </button>
            <button @click="decrementFunctional" class="btn btn-secondary">å‡½æ•°å¼å‡å°‘</button>
            <button @click="resetFunctional" class="btn btn-warning">å‡½æ•°å¼é‡ç½®</button>
          </div>
        </div>
      </section>

      <!-- ç»„åˆå¼ Store æµ‹è¯• -->
      <section class="test-section">
        <h2>ğŸ¯ ç»„åˆå¼ Store</h2>
        <div class="test-content">
          <div class="state-display">
            <p><strong>ç»„åˆå¼è®¡æ•°:</strong> {{ compositionCounter }}</p>
            <p><strong>æ˜¯å¦ä¸ºå¶æ•°:</strong> {{ isEven ? 'æ˜¯' : 'å¦' }}</p>
          </div>
          <div class="controls">
            <button @click="incrementComposition" class="btn btn-primary">ç»„åˆå¼å¢åŠ </button>
            <button @click="decrementComposition" class="btn btn-secondary">ç»„åˆå¼å‡å°‘</button>
            <button @click="resetComposition" class="btn btn-warning">ç»„åˆå¼é‡ç½®</button>
          </div>
        </div>
      </section>

      <!-- æ€§èƒ½æµ‹è¯• -->
      <section class="test-section">
        <h2>âš¡ æ€§èƒ½æµ‹è¯•</h2>
        <div class="test-content">
          <div class="state-display">
            <p><strong>æ‰¹é‡æ“ä½œæ¬¡æ•°:</strong> {{ batchOperations }}</p>
            <p><strong>å¹³å‡è€—æ—¶:</strong> {{ averageTime }}ms</p>
          </div>
          <div class="controls">
            <button @click="performBatchOperations" class="btn btn-primary">æ‰¹é‡æ“ä½œæµ‹è¯•</button>
            <button @click="clearPerformanceData" class="btn btn-warning">æ¸…é™¤æ€§èƒ½æ•°æ®</button>
          </div>
        </div>
      </section>

      <!-- æ’ä»¶çŠ¶æ€ä¿¡æ¯ -->
      <section class="test-section">
        <h2>ğŸ” æ’ä»¶çŠ¶æ€ä¿¡æ¯</h2>
        <div class="test-content">
          <div class="info-grid">
            <div class="info-item">
              <strong>æ’ä»¶çŠ¶æ€:</strong>
              <span :class="pluginStatus.class">{{ pluginStatus.text }}</span>
            </div>
            <div class="info-item">
              <strong>Pinia å®ä¾‹:</strong>
              <span :class="piniaStatus.class">{{ piniaStatus.text }}</span>
            </div>
            <div class="info-item">
              <strong>Store å·¥å‚:</strong>
              <span :class="factoryStatus.class">{{ factoryStatus.text }}</span>
            </div>
            <div class="info-item">
              <strong>æ€§èƒ½ä¼˜åŒ–å™¨:</strong>
              <span :class="optimizerStatus.class">{{ optimizerStatus.text }}</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, getCurrentInstance } from 'vue'
import { createStore, createFunctionalStore, createCompositionStore } from '@ldesign/store'

// å“åº”å¼æ•°æ®
const counter = ref(0)
const userName = ref('')
const lastUpdate = ref('')
const functionalCounter = ref(0)
const compositionCounter = ref(0)
const batchOperations = ref(0)
const averageTime = ref(0)

// è®¡ç®—å±æ€§
const doubledValue = computed(() => functionalCounter.value * 2)
const isEven = computed(() => compositionCounter.value % 2 === 0)

// è·å–å½“å‰ç»„ä»¶å®ä¾‹
const instance = getCurrentInstance()

// æ’ä»¶çŠ¶æ€æ£€æŸ¥
const pluginStatus = computed(() => {
  const app = instance?.appContext.app
  const globalProperties = app?.config.globalProperties
  const hasStorePlugin = globalProperties?.$store
  
  return hasStorePlugin
    ? { text: 'å·²å®‰è£…', class: 'status-success' }
    : { text: 'æœªå®‰è£…', class: 'status-error' }
})

const piniaStatus = computed(() => {
  const app = instance?.appContext.app
  const globalProperties = app?.config.globalProperties
  const hasPinia = globalProperties?.$store?.pinia
  
  return hasPinia
    ? { text: 'å·²åˆå§‹åŒ–', class: 'status-success' }
    : { text: 'æœªåˆå§‹åŒ–', class: 'status-error' }
})

const factoryStatus = computed(() => {
  const app = instance?.appContext.app
  const globalProperties = app?.config.globalProperties
  const hasFactory = globalProperties?.$store?.factory
  
  return hasFactory
    ? { text: 'å·²åˆ›å»º', class: 'status-success' }
    : { text: 'æœªåˆ›å»º', class: 'status-error' }
})

const optimizerStatus = computed(() => {
  const app = instance?.appContext.app
  const globalProperties = app?.config.globalProperties
  const hasOptimizer = globalProperties?.$store?.optimizer
  
  return hasOptimizer
    ? { text: 'å·²å¯ç”¨', class: 'status-success' }
    : { text: 'æœªå¯ç”¨', class: 'status-warning' }
})

// åˆ›å»ºæµ‹è¯•ç”¨çš„ stores
let basicStore: any
let functionalStore: any
let compositionStore: any

// åŸºç¡€æ“ä½œæ–¹æ³•
const increment = () => {
  counter.value++
  updateTimestamp()
}

const decrement = () => {
  counter.value--
  updateTimestamp()
}

const reset = () => {
  counter.value = 0
  updateTimestamp()
}

const updateUser = () => {
  userName.value = `ç”¨æˆ·${Math.floor(Math.random() * 1000)}`
  updateTimestamp()
}

const updateTimestamp = () => {
  lastUpdate.value = new Date().toLocaleTimeString()
}

// å‡½æ•°å¼ Store æ“ä½œ
const incrementFunctional = () => {
  if (functionalStore) {
    // é€šè¿‡ Pinia store è°ƒç”¨ action
    const store = functionalStore.getStore()
    store.increment()
    functionalCounter.value = store.count
  }
}

const decrementFunctional = () => {
  if (functionalStore) {
    const store = functionalStore.getStore()
    store.decrement()
    functionalCounter.value = store.count
  }
}

const resetFunctional = () => {
  if (functionalStore) {
    const store = functionalStore.getStore()
    store.reset()
    functionalCounter.value = store.count
  }
}

// ç»„åˆå¼ Store æ“ä½œ
const incrementComposition = () => {
  if (compositionStore) {
    // é€šè¿‡ Pinia store è°ƒç”¨æ–¹æ³•
    const store = compositionStore.getStore()
    store.increment()
    compositionCounter.value = store.count
  }
}

const decrementComposition = () => {
  if (compositionStore) {
    const store = compositionStore.getStore()
    store.decrement()
    compositionCounter.value = store.count
  }
}

const resetComposition = () => {
  if (compositionStore) {
    const store = compositionStore.getStore()
    store.reset()
    compositionCounter.value = store.count
  }
}

// æ€§èƒ½æµ‹è¯•
const performBatchOperations = async () => {
  const startTime = performance.now()
  const operations = 1000
  
  for (let i = 0; i < operations; i++) {
    counter.value++
    if (functionalStore) {
      const store = functionalStore.getStore()
      store.increment()
    }
    if (compositionStore) {
      const store = compositionStore.getStore()
      store.increment()
    }
  }
  
  const endTime = performance.now()
  const totalTime = endTime - startTime
  
  batchOperations.value += operations
  averageTime.value = Number((totalTime / operations).toFixed(3))
  
  // æ›´æ–°æ˜¾ç¤ºå€¼
  if (functionalStore) {
    const store = functionalStore.getStore()
    functionalCounter.value = store.count
  }
  if (compositionStore) {
    const store = compositionStore.getStore()
    compositionCounter.value = store.count
  }
  
  updateTimestamp()
}

const clearPerformanceData = () => {
  batchOperations.value = 0
  averageTime.value = 0
}

// ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–
onMounted(async () => {
  try {
    // åˆ›å»ºåŸºç¡€ Storeï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (typeof createStore === 'function') {
      console.log('Creating basic store...')
    }
    
    // åˆ›å»ºå‡½æ•°å¼ Store
    if (typeof createFunctionalStore === 'function') {
      const functionalStoreFactory = createFunctionalStore({
        id: 'functional-counter',
        state: () => ({ count: 0 }),
        actions: {
          increment() {
            this.count++
          },
          decrement() {
            this.count--
          },
          reset() {
            this.count = 0
          }
        }
      })
      functionalStore = functionalStoreFactory()
      // è·å–åˆå§‹å€¼
      const store = functionalStore.getStore()
      functionalCounter.value = store.count
      console.log('Functional store created:', functionalStore)
    }
    
    // åˆ›å»ºç»„åˆå¼ Store
    if (typeof createCompositionStore === 'function') {
      const compositionStoreFactory = createCompositionStore(
        { id: 'composition-counter' },
        () => {
          const count = ref(0)

          const increment = () => count.value++
          const decrement = () => count.value--
          const reset = () => count.value = 0

          return {
            count,
            increment,
            decrement,
            reset
          }
        }
      )
      compositionStore = compositionStoreFactory()
      // è·å–åˆå§‹å€¼
      const store = compositionStore.getStore()
      compositionCounter.value = store.count
      console.log('Composition store created:', compositionStore)
    }
    
    console.log('Store test page initialized successfully')
  } catch (error) {
    console.error('Failed to initialize store test page:', error)
  }
})
</script>

<style scoped lang="less">
.store-test-page {
  padding: 24px;
  max-width: 1200px;
  margin: 0 auto;
}

.page-header {
  text-align: center;
  margin-bottom: 32px;
  
  h1 {
    color: var(--ldesign-text-color-primary);
    margin-bottom: 8px;
  }
  
  p {
    color: var(--ldesign-text-color-secondary);
    font-size: 16px;
  }
}

.test-sections {
  display: grid;
  gap: 24px;
}

.test-section {
  background: var(--ldesign-bg-color-container);
  border: 1px solid var(--ldesign-border-color);
  border-radius: 8px;
  padding: 24px;
  
  h2 {
    color: var(--ldesign-text-color-primary);
    margin-bottom: 16px;
    font-size: 18px;
  }
}

.test-content {
  display: grid;
  gap: 16px;
}

.state-display {
  background: var(--ldesign-bg-color-component);
  border: 1px solid var(--ldesign-border-color);
  border-radius: 6px;
  padding: 16px;
  
  p {
    margin: 8px 0;
    color: var(--ldesign-text-color-primary);
    
    strong {
      color: var(--ldesign-brand-color);
    }
  }
}

.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
  
  &.btn-primary {
    background: var(--ldesign-brand-color);
    color: white;
    
    &:hover {
      background: var(--ldesign-brand-color-hover);
    }
  }
  
  &.btn-secondary {
    background: var(--ldesign-gray-color-6);
    color: white;
    
    &:hover {
      background: var(--ldesign-gray-color-7);
    }
  }
  
  &.btn-warning {
    background: var(--ldesign-warning-color);
    color: white;
    
    &:hover {
      background: var(--ldesign-warning-color-hover);
    }
  }
  
  &.btn-success {
    background: var(--ldesign-success-color);
    color: white;
    
    &:hover {
      background: var(--ldesign-success-color-hover);
    }
  }
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: var(--ldesign-bg-color-component);
  border: 1px solid var(--ldesign-border-color);
  border-radius: 6px;
  
  strong {
    color: var(--ldesign-text-color-primary);
  }
}

.status-success {
  color: var(--ldesign-success-color);
  font-weight: 500;
}

.status-warning {
  color: var(--ldesign-warning-color);
  font-weight: 500;
}

.status-error {
  color: var(--ldesign-error-color);
  font-weight: 500;
}
</style>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mention Component Debug Test</title>
  <style>
    body {
      padding: 40px;
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
    }
    h3 {
      color: #333;
      margin-top: 30px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 8px;
    }
    .test-container {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .test-item {
      margin-bottom: 15px;
    }
    .test-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }
    #console {
      margin-top: 20px;
      padding: 15px;
      background: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      border-radius: 4px;
    }
    .console-line {
      margin-bottom: 4px;
    }
    .console-error {
      color: #f00;
    }
    .console-warn {
      color: #ff0;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
  <script type="module" src="/dist/webcomponent/webcomponent.esm.js"></script>
  <link rel="stylesheet" href="/dist/webcomponent/webcomponent.css">
</head>
<body>
  <h1>Mention Component Debug - Initial Content Issue</h1>

  <div class="test-container">
    <h3>Test Case 1: With Initial Content</h3>
    <div class="test-item">
      <label>Type @ or # after the initial text to test trigger:</label>
      <ldesign-mention 
        id="mention-with-content"
        value="This is some initial content. Try typing @ here: "
        triggers="@,#"
        placeholder="Type @ to mention users">
      </ldesign-mention>
    </div>
    
    <button onclick="checkMentionState('mention-with-content')">Check Component State</button>
    <button onclick="clearConsole()">Clear Console</button>
  </div>

  <div class="test-container">
    <h3>Test Case 2: Empty Initial Content (Control)</h3>
    <div class="test-item">
      <label>This should work normally - type @ or #:</label>
      <ldesign-mention 
        id="mention-empty"
        triggers="@,#"
        placeholder="Type @ to mention users">
      </ldesign-mention>
    </div>
    
    <button onclick="checkMentionState('mention-empty')">Check Component State</button>
  </div>

  <div class="test-container">
    <h3>Test Case 3: With Structured Model</h3>
    <div class="test-item">
      <label>Initialized with model - try adding more mentions:</label>
      <ldesign-mention 
        id="mention-model"
        triggers="@,#">
      </ldesign-mention>
    </div>
    
    <button onclick="checkMentionState('mention-model')">Check Component State</button>
  </div>

  <h3>Debug Console</h3>
  <div id="console"></div>

  <script>
    // Debug console implementation
    const debugConsole = document.getElementById('console');
    
    function log(message, type = 'log') {
      const line = document.createElement('div');
      line.className = 'console-line';
      if (type === 'error') line.className += ' console-error';
      if (type === 'warn') line.className += ' console-warn';
      const timestamp = new Date().toLocaleTimeString();
      line.textContent = `[${timestamp}] ${message}`;
      debugConsole.appendChild(line);
      debugConsole.scrollTop = debugConsole.scrollHeight;
    }
    
    function clearConsole() {
      debugConsole.innerHTML = '';
      log('Console cleared');
    }
    
    // Override console methods to capture component logs
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
      ).join(' ');
      if (message.includes('[Mention]')) {
        log(message, 'log');
      }
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
      ).join(' ');
      log(message, 'error');
    };
    
    console.warn = function(...args) {
      originalWarn.apply(console, args);
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
      ).join(' ');
      log(message, 'warn');
    };
    
    // Initialize data after components load
    window.addEventListener('load', () => {
      log('Page loaded, initializing components...');
      
      // Set options for all mention components
      const options = [
        { value: 'alice', label: 'Alice', data: { email: 'alice@example.com' } },
        { value: 'bob', label: 'Bob', data: { email: 'bob@example.com' } },
        { value: 'charlie', label: 'Charlie', data: { email: 'charlie@example.com' } },
        { value: 'diana', label: 'Diana', data: { email: 'diana@example.com' } },
        { value: 'eve', label: 'Eve', data: { email: 'eve@example.com' } }
      ];
      
      const triggerConfigs = [
        {
          char: '@',
          tokenType: 'user',
          options: options
        },
        {
          char: '#',
          tokenType: 'topic',
          options: [
            { value: 'bug', label: 'Bug Report' },
            { value: 'feature', label: 'Feature Request' },
            { value: 'question', label: 'Question' },
            { value: 'discussion', label: 'Discussion' }
          ]
        }
      ];
      
      // Configure each mention component
      const mentionComponents = document.querySelectorAll('ldesign-mention');
      mentionComponents.forEach(mention => {
        mention.options = options;
        mention.triggerConfigs = triggerConfigs;
        
        // Add event listeners
        mention.addEventListener('ldesignSearch', (e) => {
          log(`Search event - trigger: "${e.detail.trigger}", query: "${e.detail.value}"`);
        });
        
        mention.addEventListener('ldesignSelect', (e) => {
          log(`Select event - trigger: "${e.detail.trigger}", selected: "${e.detail.value.label}"`);
        });
        
        mention.addEventListener('ldesignChange', (e) => {
          log(`Change event - value: "${e.detail}"`);
        });
        
        mention.addEventListener('ldesignValueChange', (e) => {
          log(`ValueChange event - text: "${e.detail.text}", mentions: ${JSON.stringify(e.detail.mentions)}`);
        });
      });
      
      // Special initialization for model-based component
      const modelMention = document.getElementById('mention-model');
      if (modelMention) {
        modelMention.model = [
          { type: 'text', text: 'Hello ' },
          { type: 'mention', trigger: '@', label: 'Alice', value: 'alice' },
          { type: 'text', text: ', please check ' },
          { type: 'mention', trigger: '#', label: 'Bug Report', value: 'bug' },
          { type: 'text', text: '. Continue typing here: ' }
        ];
        log('Initialized model-based mention with structured data');
      }
      
      log('All components initialized');
    });
    
    // Helper function to check component state
    function checkMentionState(id) {
      const mention = document.getElementById(id);
      if (mention) {
        log(`=== State of ${id} ===`);
        log(`Value: "${mention.value}"`);
        log(`Open: ${mention.open}`);
        log(`SearchText: "${mention.searchText}"`);
        log(`TriggerCtx: ${mention.triggerCtx ? 'Present' : 'None'}`);
        log(`CurrentTriggerChar: "${mention.currentTriggerChar}"`);
        
        // Check DOM state
        const editable = mention.shadowRoot?.querySelector('.ldesign-mention__editable');
        if (editable) {
          log(`Editable innerText: "${editable.innerText}"`);
          log(`Editable innerHTML: "${editable.innerHTML.substring(0, 100)}..."`);
          
          // Check selection state
          const sel = window.getSelection();
          if (sel && sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            log(`Selection collapsed: ${sel.isCollapsed}`);
            log(`Selection container: ${range.startContainer.nodeName}`);
            log(`Selection offset: ${range.startOffset}`);
          }
        }
        log(`===================`);
      }
    }
    
    // Initial log
    log('Debug console ready');
  </script>
</body>
</html>
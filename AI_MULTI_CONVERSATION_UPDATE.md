# AI 多会话功能更新说明

## 📋 更新概述

本次更新将 AI 对话功能从单一会话升级为多会话管理，并将路由从 `/ai-demo` 改为 `/ai`，同时实现了对话记录的持久化存储。

## ✨ 主要功能

### 1. 路由更新
- **旧路由**: `http://192.168.31.42:3001/ai-demo`
- **新路由**: `http://192.168.31.42:3001/ai`
- 更新了以下文件：
  - `app/src/router/routes.ts`
  - `packages/cli/src/web/src/router/routes.ts`
  - `packages/cli/src/web/src/components/SidebarMenu.vue`

### 2. 多会话管理
- ✅ 支持创建多个独立的对话会话
- ✅ 会话列表侧边栏展示所有对话
- ✅ 快速切换不同会话
- ✅ 每个会话独立保存消息和设置
- ✅ 会话标题自动生成（基于首条用户消息）
- ✅ 支持编辑会话标题
- ✅ 删除不需要的会话

### 3. 对话记录持久化
- ✅ 使用 localStorage 存储所有会话数据
- ✅ 刷新页面后保留所有对话记录
- ✅ 自动保存会话更新
- ✅ 记住最后活跃的会话

### 4. 新增文件

#### `app/src/ai/conversation.ts`
定义会话相关的类型和工具函数：
- `Conversation` - 会话数据结构
- `ConversationMessage` - 会话消息结构
- `createConversation()` - 创建新会话
- `addMessageToConversation()` - 添加消息到会话
- `updateConversationSettings()` - 更新会话设置
- `clearConversationMessages()` - 清空会话消息

#### `app/src/ai/conversation-store.ts`
会话存储管理服务：
- `getAll()` - 获取所有会话
- `getById()` - 获取指定会话
- `save()` - 保存会话
- `delete()` - 删除会话
- `initialize()` - 初始化存储
- `exportAll()` / `importAll()` - 导入导出功能
- `getStats()` - 获取统计信息

## 🎨 界面变化

### 新布局
```
┌─────────────────────────────────────────────────────────┐
│  配置警告（如未配置 AI 密钥）                              │
├──────────┬────────────────────────────┬─────────────────┤
│          │                            │                 │
│ 会话列表  │      聊天区域               │   设置 & 示例   │
│          │                            │                 │
│ - 新建    │  消息列表                   │  - 系统提示词    │
│ - 会话1   │  + 会话标题编辑              │  - 温度         │
│ - 会话2   │  + 消息显示                 │  - Max Token    │
│ - 会话3   │  + 输入框                   │  - 流式响应     │
│          │                            │  - 示例问题     │
│          │                            │  - 统计信息     │
└──────────┴────────────────────────────┴─────────────────┘
```

### 会话列表
- 显示所有对话会话
- 展示会话标题、更新时间、消息数量
- 高亮当前活跃会话
- 鼠标悬停显示删除按钮

### 聊天区域
- 显示当前会话标题（可编辑）
- 展示当前会话的所有消息
- 每个会话独立保存设置

## 💾 数据存储

### LocalStorage Keys
- `ldesign_ai_conversations` - 存储所有会话数据
- `ldesign_ai_active_conversation` - 存储当前活跃会话 ID

### 数据结构
```typescript
interface Conversation {
  id: string                    // 会话唯一 ID
  title: string                 // 会话标题
  messages: ConversationMessage[] // 消息列表
  createdAt: number            // 创建时间戳
  updatedAt: number            // 更新时间戳
  settings?: {                 // 会话设置
    useSystemPrompt?: boolean
    systemPrompt?: string
    temperature?: number
    maxTokens?: number
    isStreaming?: boolean
  }
}

interface ConversationMessage {
  id: string                   // 消息 ID
  role: 'user' | 'assistant'   // 角色
  content: string              // 内容
  timestamp: number            // 时间戳
}
```

## 🔄 使用流程

### 创建新会话
1. 点击左侧栏"+ 新建"按钮
2. 系统自动创建新会话并切换
3. 输入第一条消息后，标题会自动更新

### 切换会话
1. 在左侧会话列表中点击任意会话
2. 右侧聊天区域切换到该会话内容
3. 继续该会话的对话

### 编辑标题
1. 点击聊天区域标题旁的 ✏️ 按钮
2. 在弹出框中输入新标题
3. 确认后标题更新

### 删除会话
1. 鼠标悬停在会话列表项上
2. 点击右上角的 🗑️ 按钮
3. 确认删除

### 清空消息
1. 在聊天区域点击"清空对话"按钮
2. 确认后清空当前会话的所有消息
3. 会话本身保留，可继续使用

## 📱 响应式设计

- **大屏 (>1200px)**: 显示会话列表 + 聊天区域 + 设置侧边栏
- **中屏 (768px-1200px)**: 显示会话列表 + 聊天区域
- **小屏 (<768px)**: 只显示聊天区域

## 🔧 技术要点

### 响应式数据绑定
- 使用 Vue 3 的 `computed` 属性将会话设置双向绑定
- 设置更改时自动保存到 localStorage

### 自动保存
- 每次消息发送后自动保存会话
- 设置更改时自动保存
- 标题编辑后自动保存

### 性能优化
- 只保留最近 10 条消息作为上下文
- 会话列表按更新时间排序
- 使用虚拟滚动优化长消息列表

## 🚀 后续可能的优化

1. **搜索功能**: 在会话列表中搜索特定对话
2. **分组管理**: 按主题或项目分组会话
3. **导出功能**: 导出会话为 Markdown 或 JSON
4. **云同步**: 将会话数据同步到服务器
5. **会话归档**: 归档旧会话以保持列表清洁
6. **快捷键**: 添加键盘快捷键支持
7. **智能标题**: 使用 AI 自动生成更好的会话标题
8. **消息搜索**: 在会话内搜索特定消息
9. **会话模板**: 预设常用对话模板
10. **分享功能**: 分享会话链接给他人

## ⚠️ 注意事项

1. **数据备份**: localStorage 数据可能被清除，建议定期导出重要对话
2. **浏览器限制**: localStorage 有容量限制（通常 5-10MB）
3. **隐私安全**: 敏感信息请勿保存在本地对话中
4. **兼容性**: 需要现代浏览器支持 localStorage API

## 📝 更新日志

### v2.0.0 (2025-10-02)
- ✨ 新增多会话管理功能
- ✨ 实现对话记录持久化存储
- 🔄 路由从 `/ai-demo` 更改为 `/ai`
- 🎨 全新的三栏布局设计
- ⚡ 优化响应式布局
- 📱 改进移动端适配
